(function(){const v=document.createElement("link").relList;if(v&&v.supports&&v.supports("modulepreload"))return;for(const k of document.querySelectorAll('link[rel="modulepreload"]'))P(k);new MutationObserver(k=>{for(const j of k)if(j.type==="childList")for(const $ of j.addedNodes)$.tagName==="LINK"&&$.rel==="modulepreload"&&P($)}).observe(document,{childList:!0,subtree:!0});function I(k){const j={};return k.integrity&&(j.integrity=k.integrity),k.referrerPolicy&&(j.referrerPolicy=k.referrerPolicy),k.crossOrigin==="use-credentials"?j.credentials="include":k.crossOrigin==="anonymous"?j.credentials="omit":j.credentials="same-origin",j}function P(k){if(k.ep)return;k.ep=!0;const j=I(k);fetch(k.href,j)}})();/**
* @vue/shared v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**//*! #__NO_SIDE_EFFECTS__ */function dv(f){const v=Object.create(null);for(const I of f.split(","))v[I]=1;return I=>I in v}const Gr={},ch=[],ea=()=>{},wM=()=>!1,c_=f=>f.charCodeAt(0)===111&&f.charCodeAt(1)===110&&(f.charCodeAt(2)>122||f.charCodeAt(2)<97),fv=f=>f.startsWith("onUpdate:"),rs=Object.assign,pv=(f,v)=>{const I=f.indexOf(v);I>-1&&f.splice(I,1)},TM=Object.prototype.hasOwnProperty,Lr=(f,v)=>TM.call(f,v),Ui=Array.isArray,uh=f=>jf(f)==="[object Map]",u_=f=>jf(f)==="[object Set]",mb=f=>jf(f)==="[object Date]",sr=f=>typeof f=="function",Sn=f=>typeof f=="string",ta=f=>typeof f=="symbol",Xr=f=>f!==null&&typeof f=="object",Ew=f=>(Xr(f)||sr(f))&&sr(f.then)&&sr(f.catch),Mw=Object.prototype.toString,jf=f=>Mw.call(f),SM=f=>jf(f).slice(8,-1),Aw=f=>jf(f)==="[object Object]",mv=f=>Sn(f)&&f!=="NaN"&&f[0]!=="-"&&""+parseInt(f,10)===f,Sf=dv(",key,ref,ref_for,ref_key,onVnodeBeforeMount,onVnodeMounted,onVnodeBeforeUpdate,onVnodeUpdated,onVnodeBeforeUnmount,onVnodeUnmounted"),h_=f=>{const v=Object.create(null);return I=>v[I]||(v[I]=f(I))},EM=/-(\w)/g,no=h_(f=>f.replace(EM,(v,I)=>I?I.toUpperCase():"")),MM=/\B([A-Z])/g,$c=h_(f=>f.replace(MM,"-$1").toLowerCase()),d_=h_(f=>f.charAt(0).toUpperCase()+f.slice(1)),Cy=h_(f=>f?`on${d_(f)}`:""),zl=(f,v)=>!Object.is(f,v),Um=(f,...v)=>{for(let I=0;I<f.length;I++)f[I](...v)},Iw=(f,v,I,P=!1)=>{Object.defineProperty(f,v,{configurable:!0,enumerable:!1,writable:P,value:I})},Km=f=>{const v=parseFloat(f);return isNaN(v)?f:v};let _b;const f_=()=>_b||(_b=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{});function _v(f){if(Ui(f)){const v={};for(let I=0;I<f.length;I++){const P=f[I],k=Sn(P)?PM(P):_v(P);if(k)for(const j in k)v[j]=k[j]}return v}else if(Sn(f)||Xr(f))return f}const AM=/;(?![^(]*\))/g,IM=/:([^]+)/,CM=/\/\*[^]*?\*\//g;function PM(f){const v={};return f.replace(CM,"").split(AM).forEach(I=>{if(I){const P=I.split(IM);P.length>1&&(v[P[0].trim()]=P[1].trim())}}),v}function vh(f){let v="";if(Sn(f))v=f;else if(Ui(f))for(let I=0;I<f.length;I++){const P=vh(f[I]);P&&(v+=P+" ")}else if(Xr(f))for(const I in f)f[I]&&(v+=I+" ");return v.trim()}const RM="itemscope,allowfullscreen,formnovalidate,ismap,nomodule,novalidate,readonly",DM=dv(RM);function Cw(f){return!!f||f===""}function zM(f,v){if(f.length!==v.length)return!1;let I=!0;for(let P=0;I&&P<f.length;P++)I=p_(f[P],v[P]);return I}function p_(f,v){if(f===v)return!0;let I=mb(f),P=mb(v);if(I||P)return I&&P?f.getTime()===v.getTime():!1;if(I=ta(f),P=ta(v),I||P)return f===v;if(I=Ui(f),P=Ui(v),I||P)return I&&P?zM(f,v):!1;if(I=Xr(f),P=Xr(v),I||P){if(!I||!P)return!1;const k=Object.keys(f).length,j=Object.keys(v).length;if(k!==j)return!1;for(const $ in f){const s=f.hasOwnProperty($),Q=v.hasOwnProperty($);if(s&&!Q||!s&&Q||!p_(f[$],v[$]))return!1}}return String(f)===String(v)}function LM(f,v){return f.findIndex(I=>p_(I,v))}const Pw=f=>!!(f&&f.__v_isRef===!0),xr=f=>Sn(f)?f:f==null?"":Ui(f)||Xr(f)&&(f.toString===Mw||!sr(f.toString))?Pw(f)?xr(f.value):JSON.stringify(f,Rw,2):String(f),Rw=(f,v)=>Pw(v)?Rw(f,v.value):uh(v)?{[`Map(${v.size})`]:[...v.entries()].reduce((I,[P,k],j)=>(I[Py(P,j)+" =>"]=k,I),{})}:u_(v)?{[`Set(${v.size})`]:[...v.values()].map(I=>Py(I))}:ta(v)?Py(v):Xr(v)&&!Ui(v)&&!Aw(v)?String(v):v,Py=(f,v="")=>{var I;return ta(f)?`Symbol(${(I=f.description)!=null?I:v})`:f};/**
* @vue/reactivity v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/let _s;class Dw{constructor(v=!1){this.detached=v,this._active=!0,this.effects=[],this.cleanups=[],this._isPaused=!1,this.parent=_s,!v&&_s&&(this.index=(_s.scopes||(_s.scopes=[])).push(this)-1)}get active(){return this._active}pause(){if(this._active){this._isPaused=!0;let v,I;if(this.scopes)for(v=0,I=this.scopes.length;v<I;v++)this.scopes[v].pause();for(v=0,I=this.effects.length;v<I;v++)this.effects[v].pause()}}resume(){if(this._active&&this._isPaused){this._isPaused=!1;let v,I;if(this.scopes)for(v=0,I=this.scopes.length;v<I;v++)this.scopes[v].resume();for(v=0,I=this.effects.length;v<I;v++)this.effects[v].resume()}}run(v){if(this._active){const I=_s;try{return _s=this,v()}finally{_s=I}}}on(){_s=this}off(){_s=this.parent}stop(v){if(this._active){this._active=!1;let I,P;for(I=0,P=this.effects.length;I<P;I++)this.effects[I].stop();for(this.effects.length=0,I=0,P=this.cleanups.length;I<P;I++)this.cleanups[I]();if(this.cleanups.length=0,this.scopes){for(I=0,P=this.scopes.length;I<P;I++)this.scopes[I].stop(!0);this.scopes.length=0}if(!this.detached&&this.parent&&!v){const k=this.parent.scopes.pop();k&&k!==this&&(this.parent.scopes[this.index]=k,k.index=this.index)}this.parent=void 0}}}function zw(f){return new Dw(f)}function Lw(){return _s}function OM(f,v=!1){_s&&_s.cleanups.push(f)}let Zr;const Ry=new WeakSet;class Ow{constructor(v){this.fn=v,this.deps=void 0,this.depsTail=void 0,this.flags=5,this.next=void 0,this.cleanup=void 0,this.scheduler=void 0,_s&&_s.active&&_s.effects.push(this)}pause(){this.flags|=64}resume(){this.flags&64&&(this.flags&=-65,Ry.has(this)&&(Ry.delete(this),this.trigger()))}notify(){this.flags&2&&!(this.flags&32)||this.flags&8||Fw(this)}run(){if(!(this.flags&1))return this.fn();this.flags|=2,gb(this),Bw(this);const v=Zr,I=Po;Zr=this,Po=!0;try{return this.fn()}finally{Nw(this),Zr=v,Po=I,this.flags&=-3}}stop(){if(this.flags&1){for(let v=this.deps;v;v=v.nextDep)vv(v);this.deps=this.depsTail=void 0,gb(this),this.onStop&&this.onStop(),this.flags&=-2}}trigger(){this.flags&64?Ry.add(this):this.scheduler?this.scheduler():this.runIfDirty()}runIfDirty(){$y(this)&&this.run()}get dirty(){return $y(this)}}let kw=0,Ef,Mf;function Fw(f,v=!1){if(f.flags|=8,v){f.next=Mf,Mf=f;return}f.next=Ef,Ef=f}function gv(){kw++}function yv(){if(--kw>0)return;if(Mf){let v=Mf;for(Mf=void 0;v;){const I=v.next;v.next=void 0,v.flags&=-9,v=I}}let f;for(;Ef;){let v=Ef;for(Ef=void 0;v;){const I=v.next;if(v.next=void 0,v.flags&=-9,v.flags&1)try{v.trigger()}catch(P){f||(f=P)}v=I}}if(f)throw f}function Bw(f){for(let v=f.deps;v;v=v.nextDep)v.version=-1,v.prevActiveLink=v.dep.activeLink,v.dep.activeLink=v}function Nw(f){let v,I=f.depsTail,P=I;for(;P;){const k=P.prevDep;P.version===-1?(P===I&&(I=k),vv(P),kM(P)):v=P,P.dep.activeLink=P.prevActiveLink,P.prevActiveLink=void 0,P=k}f.deps=v,f.depsTail=I}function $y(f){for(let v=f.deps;v;v=v.nextDep)if(v.dep.version!==v.version||v.dep.computed&&(Vw(v.dep.computed)||v.dep.version!==v.version))return!0;return!!f._dirty}function Vw(f){if(f.flags&4&&!(f.flags&16)||(f.flags&=-17,f.globalVersion===zf))return;f.globalVersion=zf;const v=f.dep;if(f.flags|=2,v.version>0&&!f.isSSR&&f.deps&&!$y(f)){f.flags&=-3;return}const I=Zr,P=Po;Zr=f,Po=!0;try{Bw(f);const k=f.fn(f._value);(v.version===0||zl(k,f._value))&&(f._value=k,v.version++)}catch(k){throw v.version++,k}finally{Zr=I,Po=P,Nw(f),f.flags&=-3}}function vv(f,v=!1){const{dep:I,prevSub:P,nextSub:k}=f;if(P&&(P.nextSub=k,f.prevSub=void 0),k&&(k.prevSub=P,f.nextSub=void 0),I.subs===f&&(I.subs=P,!P&&I.computed)){I.computed.flags&=-5;for(let j=I.computed.deps;j;j=j.nextDep)vv(j,!0)}!v&&!--I.sc&&I.map&&I.map.delete(I.key)}function kM(f){const{prevDep:v,nextDep:I}=f;v&&(v.nextDep=I,f.prevDep=void 0),I&&(I.prevDep=v,f.nextDep=void 0)}let Po=!0;const Uw=[];function kl(){Uw.push(Po),Po=!1}function Fl(){const f=Uw.pop();Po=f===void 0?!0:f}function gb(f){const{cleanup:v}=f;if(f.cleanup=void 0,v){const I=Zr;Zr=void 0;try{v()}finally{Zr=I}}}let zf=0;class FM{constructor(v,I){this.sub=v,this.dep=I,this.version=I.version,this.nextDep=this.prevDep=this.nextSub=this.prevSub=this.prevActiveLink=void 0}}class xv{constructor(v){this.computed=v,this.version=0,this.activeLink=void 0,this.subs=void 0,this.map=void 0,this.key=void 0,this.sc=0}track(v){if(!Zr||!Po||Zr===this.computed)return;let I=this.activeLink;if(I===void 0||I.sub!==Zr)I=this.activeLink=new FM(Zr,this),Zr.deps?(I.prevDep=Zr.depsTail,Zr.depsTail.nextDep=I,Zr.depsTail=I):Zr.deps=Zr.depsTail=I,jw(I);else if(I.version===-1&&(I.version=this.version,I.nextDep)){const P=I.nextDep;P.prevDep=I.prevDep,I.prevDep&&(I.prevDep.nextDep=P),I.prevDep=Zr.depsTail,I.nextDep=void 0,Zr.depsTail.nextDep=I,Zr.depsTail=I,Zr.deps===I&&(Zr.deps=P)}return I}trigger(v){this.version++,zf++,this.notify(v)}notify(v){gv();try{for(let I=this.subs;I;I=I.prevSub)I.sub.notify()&&I.sub.dep.notify()}finally{yv()}}}function jw(f){if(f.dep.sc++,f.sub.flags&4){const v=f.dep.computed;if(v&&!f.dep.subs){v.flags|=20;for(let P=v.deps;P;P=P.nextDep)jw(P)}const I=f.dep.subs;I!==f&&(f.prevSub=I,I&&(I.nextSub=f)),f.dep.subs=f}}const Ym=new WeakMap,Nc=Symbol(""),Hy=Symbol(""),Lf=Symbol("");function es(f,v,I){if(Po&&Zr){let P=Ym.get(f);P||Ym.set(f,P=new Map);let k=P.get(I);k||(P.set(I,k=new xv),k.map=P,k.key=I),k.track()}}function Ea(f,v,I,P,k,j){const $=Ym.get(f);if(!$){zf++;return}const s=Q=>{Q&&Q.trigger()};if(gv(),v==="clear")$.forEach(s);else{const Q=Ui(f),de=Q&&mv(I);if(Q&&I==="length"){const ae=Number(P);$.forEach((Te,Ne)=>{(Ne==="length"||Ne===Lf||!ta(Ne)&&Ne>=ae)&&s(Te)})}else switch((I!==void 0||$.has(void 0))&&s($.get(I)),de&&s($.get(Lf)),v){case"add":Q?de&&s($.get("length")):(s($.get(Nc)),uh(f)&&s($.get(Hy)));break;case"delete":Q||(s($.get(Nc)),uh(f)&&s($.get(Hy)));break;case"set":uh(f)&&s($.get(Nc));break}}yv()}function BM(f,v){const I=Ym.get(f);return I&&I.get(v)}function sh(f){const v=Ir(f);return v===f?v:(es(v,"iterate",Lf),io(f)?v:v.map(ts))}function m_(f){return es(f=Ir(f),"iterate",Lf),f}const NM={__proto__:null,[Symbol.iterator](){return Dy(this,Symbol.iterator,ts)},concat(...f){return sh(this).concat(...f.map(v=>Ui(v)?sh(v):v))},entries(){return Dy(this,"entries",f=>(f[1]=ts(f[1]),f))},every(f,v){return wa(this,"every",f,v,void 0,arguments)},filter(f,v){return wa(this,"filter",f,v,I=>I.map(ts),arguments)},find(f,v){return wa(this,"find",f,v,ts,arguments)},findIndex(f,v){return wa(this,"findIndex",f,v,void 0,arguments)},findLast(f,v){return wa(this,"findLast",f,v,ts,arguments)},findLastIndex(f,v){return wa(this,"findLastIndex",f,v,void 0,arguments)},forEach(f,v){return wa(this,"forEach",f,v,void 0,arguments)},includes(...f){return zy(this,"includes",f)},indexOf(...f){return zy(this,"indexOf",f)},join(f){return sh(this).join(f)},lastIndexOf(...f){return zy(this,"lastIndexOf",f)},map(f,v){return wa(this,"map",f,v,void 0,arguments)},pop(){return vf(this,"pop")},push(...f){return vf(this,"push",f)},reduce(f,...v){return yb(this,"reduce",f,v)},reduceRight(f,...v){return yb(this,"reduceRight",f,v)},shift(){return vf(this,"shift")},some(f,v){return wa(this,"some",f,v,void 0,arguments)},splice(...f){return vf(this,"splice",f)},toReversed(){return sh(this).toReversed()},toSorted(f){return sh(this).toSorted(f)},toSpliced(...f){return sh(this).toSpliced(...f)},unshift(...f){return vf(this,"unshift",f)},values(){return Dy(this,"values",ts)}};function Dy(f,v,I){const P=m_(f),k=P[v]();return P!==f&&!io(f)&&(k._next=k.next,k.next=()=>{const j=k._next();return j.value&&(j.value=I(j.value)),j}),k}const VM=Array.prototype;function wa(f,v,I,P,k,j){const $=m_(f),s=$!==f&&!io(f),Q=$[v];if(Q!==VM[v]){const Te=Q.apply(f,j);return s?ts(Te):Te}let de=I;$!==f&&(s?de=function(Te,Ne){return I.call(this,ts(Te),Ne,f)}:I.length>2&&(de=function(Te,Ne){return I.call(this,Te,Ne,f)}));const ae=Q.call($,de,P);return s&&k?k(ae):ae}function yb(f,v,I,P){const k=m_(f);let j=I;return k!==f&&(io(f)?I.length>3&&(j=function($,s,Q){return I.call(this,$,s,Q,f)}):j=function($,s,Q){return I.call(this,$,ts(s),Q,f)}),k[v](j,...P)}function zy(f,v,I){const P=Ir(f);es(P,"iterate",Lf);const k=P[v](...I);return(k===-1||k===!1)&&Tv(I[0])?(I[0]=Ir(I[0]),P[v](...I)):k}function vf(f,v,I=[]){kl(),gv();const P=Ir(f)[v].apply(f,I);return yv(),Fl(),P}const UM=dv("__proto__,__v_isRef,__isVue"),Gw=new Set(Object.getOwnPropertyNames(Symbol).filter(f=>f!=="arguments"&&f!=="caller").map(f=>Symbol[f]).filter(ta));function jM(f){ta(f)||(f=String(f));const v=Ir(this);return es(v,"has",f),v.hasOwnProperty(f)}class qw{constructor(v=!1,I=!1){this._isReadonly=v,this._isShallow=I}get(v,I,P){if(I==="__v_skip")return v.__v_skip;const k=this._isReadonly,j=this._isShallow;if(I==="__v_isReactive")return!k;if(I==="__v_isReadonly")return k;if(I==="__v_isShallow")return j;if(I==="__v_raw")return P===(k?j?JM:Ww:j?Zw:Hw).get(v)||Object.getPrototypeOf(v)===Object.getPrototypeOf(P)?v:void 0;const $=Ui(v);if(!k){let Q;if($&&(Q=NM[I]))return Q;if(I==="hasOwnProperty")return jM}const s=Reflect.get(v,I,_n(v)?v:P);return(ta(I)?Gw.has(I):UM(I))||(k||es(v,"get",I),j)?s:_n(s)?$&&mv(I)?s:s.value:Xr(s)?k?Kw(s):Gf(s):s}}class $w extends qw{constructor(v=!1){super(!1,v)}set(v,I,P,k){let j=v[I];if(!this._isShallow){const Q=jc(j);if(!io(P)&&!jc(P)&&(j=Ir(j),P=Ir(P)),!Ui(v)&&_n(j)&&!_n(P))return Q?!1:(j.value=P,!0)}const $=Ui(v)&&mv(I)?Number(I)<v.length:Lr(v,I),s=Reflect.set(v,I,P,_n(v)?v:k);return v===Ir(k)&&($?zl(P,j)&&Ea(v,"set",I,P):Ea(v,"add",I,P)),s}deleteProperty(v,I){const P=Lr(v,I);v[I];const k=Reflect.deleteProperty(v,I);return k&&P&&Ea(v,"delete",I,void 0),k}has(v,I){const P=Reflect.has(v,I);return(!ta(I)||!Gw.has(I))&&es(v,"has",I),P}ownKeys(v){return es(v,"iterate",Ui(v)?"length":Nc),Reflect.ownKeys(v)}}class GM extends qw{constructor(v=!1){super(!0,v)}set(v,I){return!0}deleteProperty(v,I){return!0}}const qM=new $w,$M=new GM,HM=new $w(!0);const Zy=f=>f,Bm=f=>Reflect.getPrototypeOf(f);function ZM(f,v,I){return function(...P){const k=this.__v_raw,j=Ir(k),$=uh(j),s=f==="entries"||f===Symbol.iterator&&$,Q=f==="keys"&&$,de=k[f](...P),ae=I?Zy:v?Wy:ts;return!v&&es(j,"iterate",Q?Hy:Nc),{next(){const{value:Te,done:Ne}=de.next();return Ne?{value:Te,done:Ne}:{value:s?[ae(Te[0]),ae(Te[1])]:ae(Te),done:Ne}},[Symbol.iterator](){return this}}}}function Nm(f){return function(...v){return f==="delete"?!1:f==="clear"?void 0:this}}function WM(f,v){const I={get(k){const j=this.__v_raw,$=Ir(j),s=Ir(k);f||(zl(k,s)&&es($,"get",k),es($,"get",s));const{has:Q}=Bm($),de=v?Zy:f?Wy:ts;if(Q.call($,k))return de(j.get(k));if(Q.call($,s))return de(j.get(s));j!==$&&j.get(k)},get size(){const k=this.__v_raw;return!f&&es(Ir(k),"iterate",Nc),Reflect.get(k,"size",k)},has(k){const j=this.__v_raw,$=Ir(j),s=Ir(k);return f||(zl(k,s)&&es($,"has",k),es($,"has",s)),k===s?j.has(k):j.has(k)||j.has(s)},forEach(k,j){const $=this,s=$.__v_raw,Q=Ir(s),de=v?Zy:f?Wy:ts;return!f&&es(Q,"iterate",Nc),s.forEach((ae,Te)=>k.call(j,de(ae),de(Te),$))}};return rs(I,f?{add:Nm("add"),set:Nm("set"),delete:Nm("delete"),clear:Nm("clear")}:{add(k){!v&&!io(k)&&!jc(k)&&(k=Ir(k));const j=Ir(this);return Bm(j).has.call(j,k)||(j.add(k),Ea(j,"add",k,k)),this},set(k,j){!v&&!io(j)&&!jc(j)&&(j=Ir(j));const $=Ir(this),{has:s,get:Q}=Bm($);let de=s.call($,k);de||(k=Ir(k),de=s.call($,k));const ae=Q.call($,k);return $.set(k,j),de?zl(j,ae)&&Ea($,"set",k,j):Ea($,"add",k,j),this},delete(k){const j=Ir(this),{has:$,get:s}=Bm(j);let Q=$.call(j,k);Q||(k=Ir(k),Q=$.call(j,k)),s&&s.call(j,k);const de=j.delete(k);return Q&&Ea(j,"delete",k,void 0),de},clear(){const k=Ir(this),j=k.size!==0,$=k.clear();return j&&Ea(k,"clear",void 0,void 0),$}}),["keys","values","entries",Symbol.iterator].forEach(k=>{I[k]=ZM(k,f,v)}),I}function bv(f,v){const I=WM(f,v);return(P,k,j)=>k==="__v_isReactive"?!f:k==="__v_isReadonly"?f:k==="__v_raw"?P:Reflect.get(Lr(I,k)&&k in P?I:P,k,j)}const XM={get:bv(!1,!1)},KM={get:bv(!1,!0)},YM={get:bv(!0,!1)};const Hw=new WeakMap,Zw=new WeakMap,Ww=new WeakMap,JM=new WeakMap;function QM(f){switch(f){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function eA(f){return f.__v_skip||!Object.isExtensible(f)?0:QM(SM(f))}function Gf(f){return jc(f)?f:wv(f,!1,qM,XM,Hw)}function Xw(f){return wv(f,!1,HM,KM,Zw)}function Kw(f){return wv(f,!0,$M,YM,Ww)}function wv(f,v,I,P,k){if(!Xr(f)||f.__v_raw&&!(v&&f.__v_isReactive))return f;const j=k.get(f);if(j)return j;const $=eA(f);if($===0)return f;const s=new Proxy(f,$===2?P:I);return k.set(f,s),s}function Ll(f){return jc(f)?Ll(f.__v_raw):!!(f&&f.__v_isReactive)}function jc(f){return!!(f&&f.__v_isReadonly)}function io(f){return!!(f&&f.__v_isShallow)}function Tv(f){return f?!!f.__v_raw:!1}function Ir(f){const v=f&&f.__v_raw;return v?Ir(v):f}function Sv(f){return!Lr(f,"__v_skip")&&Object.isExtensible(f)&&Iw(f,"__v_skip",!0),f}const ts=f=>Xr(f)?Gf(f):f,Wy=f=>Xr(f)?Kw(f):f;function _n(f){return f?f.__v_isRef===!0:!1}function Oi(f){return Yw(f,!1)}function tA(f){return Yw(f,!0)}function Yw(f,v){return _n(f)?f:new iA(f,v)}class iA{constructor(v,I){this.dep=new xv,this.__v_isRef=!0,this.__v_isShallow=!1,this._rawValue=I?v:Ir(v),this._value=I?v:ts(v),this.__v_isShallow=I}get value(){return this.dep.track(),this._value}set value(v){const I=this._rawValue,P=this.__v_isShallow||io(v)||jc(v);v=P?v:Ir(v),zl(v,I)&&(this._rawValue=v,this._value=P?v:ts(v),this.dep.trigger())}}function Aa(f){return _n(f)?f.value:f}const rA={get:(f,v,I)=>v==="__v_raw"?f:Aa(Reflect.get(f,v,I)),set:(f,v,I,P)=>{const k=f[v];return _n(k)&&!_n(I)?(k.value=I,!0):Reflect.set(f,v,I,P)}};function Jw(f){return Ll(f)?f:new Proxy(f,rA)}function nA(f){const v=Ui(f)?new Array(f.length):{};for(const I in f)v[I]=oA(f,I);return v}class sA{constructor(v,I,P){this._object=v,this._key=I,this._defaultValue=P,this.__v_isRef=!0,this._value=void 0}get value(){const v=this._object[this._key];return this._value=v===void 0?this._defaultValue:v}set value(v){this._object[this._key]=v}get dep(){return BM(Ir(this._object),this._key)}}function oA(f,v,I){const P=f[v];return _n(P)?P:new sA(f,v,I)}class aA{constructor(v,I,P){this.fn=v,this.setter=I,this._value=void 0,this.dep=new xv(this),this.__v_isRef=!0,this.deps=void 0,this.depsTail=void 0,this.flags=16,this.globalVersion=zf-1,this.next=void 0,this.effect=this,this.__v_isReadonly=!I,this.isSSR=P}notify(){if(this.flags|=16,!(this.flags&8)&&Zr!==this)return Fw(this,!0),!0}get value(){const v=this.dep.track();return Vw(this),v&&(v.version=this.dep.version),this._value}set value(v){this.setter&&this.setter(v)}}function lA(f,v,I=!1){let P,k;return sr(f)?P=f:(P=f.get,k=f.set),new aA(P,k,I)}const Vm={},Jm=new WeakMap;let kc;function cA(f,v=!1,I=kc){if(I){let P=Jm.get(I);P||Jm.set(I,P=[]),P.push(f)}}function uA(f,v,I=Gr){const{immediate:P,deep:k,once:j,scheduler:$,augmentJob:s,call:Q}=I,de=pt=>k?pt:io(pt)||k===!1||k===0?Ma(pt,1):Ma(pt);let ae,Te,Ne,Re,Ze=!1,et=!1;if(_n(f)?(Te=()=>f.value,Ze=io(f)):Ll(f)?(Te=()=>de(f),Ze=!0):Ui(f)?(et=!0,Ze=f.some(pt=>Ll(pt)||io(pt)),Te=()=>f.map(pt=>{if(_n(pt))return pt.value;if(Ll(pt))return de(pt);if(sr(pt))return Q?Q(pt,2):pt()})):sr(f)?v?Te=Q?()=>Q(f,2):f:Te=()=>{if(Ne){kl();try{Ne()}finally{Fl()}}const pt=kc;kc=ae;try{return Q?Q(f,3,[Re]):f(Re)}finally{kc=pt}}:Te=ea,v&&k){const pt=Te,ui=k===!0?1/0:k;Te=()=>Ma(pt(),ui)}const ft=Lw(),vt=()=>{ae.stop(),ft&&ft.active&&pv(ft.effects,ae)};if(j&&v){const pt=v;v=(...ui)=>{pt(...ui),vt()}}let gt=et?new Array(f.length).fill(Vm):Vm;const Vt=pt=>{if(!(!(ae.flags&1)||!ae.dirty&&!pt))if(v){const ui=ae.run();if(k||Ze||(et?ui.some((zi,Pt)=>zl(zi,gt[Pt])):zl(ui,gt))){Ne&&Ne();const zi=kc;kc=ae;try{const Pt=[ui,gt===Vm?void 0:et&&gt[0]===Vm?[]:gt,Re];Q?Q(v,3,Pt):v(...Pt),gt=ui}finally{kc=zi}}}else ae.run()};return s&&s(Vt),ae=new Ow(Te),ae.scheduler=$?()=>$(Vt,!1):Vt,Re=pt=>cA(pt,!1,ae),Ne=ae.onStop=()=>{const pt=Jm.get(ae);if(pt){if(Q)Q(pt,4);else for(const ui of pt)ui();Jm.delete(ae)}},v?P?Vt(!0):gt=ae.run():$?$(Vt.bind(null,!0),!0):ae.run(),vt.pause=ae.pause.bind(ae),vt.resume=ae.resume.bind(ae),vt.stop=vt,vt}function Ma(f,v=1/0,I){if(v<=0||!Xr(f)||f.__v_skip||(I=I||new Set,I.has(f)))return f;if(I.add(f),v--,_n(f))Ma(f.value,v,I);else if(Ui(f))for(let P=0;P<f.length;P++)Ma(f[P],v,I);else if(u_(f)||uh(f))f.forEach(P=>{Ma(P,v,I)});else if(Aw(f)){for(const P in f)Ma(f[P],v,I);for(const P of Object.getOwnPropertySymbols(f))Object.prototype.propertyIsEnumerable.call(f,P)&&Ma(f[P],v,I)}return f}/**
* @vue/runtime-core v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/function qf(f,v,I,P){try{return P?f(...P):f()}catch(k){__(k,v,I)}}function ia(f,v,I,P){if(sr(f)){const k=qf(f,v,I,P);return k&&Ew(k)&&k.catch(j=>{__(j,v,I)}),k}if(Ui(f)){const k=[];for(let j=0;j<f.length;j++)k.push(ia(f[j],v,I,P));return k}}function __(f,v,I,P=!0){const k=v?v.vnode:null,{errorHandler:j,throwUnhandledErrorInProduction:$}=v&&v.appContext.config||Gr;if(v){let s=v.parent;const Q=v.proxy,de=`https://vuejs.org/error-reference/#runtime-${I}`;for(;s;){const ae=s.ec;if(ae){for(let Te=0;Te<ae.length;Te++)if(ae[Te](f,Q,de)===!1)return}s=s.parent}if(j){kl(),qf(j,null,10,[f,Q,de]),Fl();return}}hA(f,I,k,P,$)}function hA(f,v,I,P=!0,k=!1){if(k)throw f;console.error(f)}const gs=[];let Jo=-1;const hh=[];let Pl=null,ah=0;const Qw=Promise.resolve();let Qm=null;function $f(f){const v=Qm||Qw;return f?v.then(this?f.bind(this):f):v}function dA(f){let v=Jo+1,I=gs.length;for(;v<I;){const P=v+I>>>1,k=gs[P],j=Of(k);j<f||j===f&&k.flags&2?v=P+1:I=P}return v}function Ev(f){if(!(f.flags&1)){const v=Of(f),I=gs[gs.length-1];!I||!(f.flags&2)&&v>=Of(I)?gs.push(f):gs.splice(dA(v),0,f),f.flags|=1,e2()}}function e2(){Qm||(Qm=Qw.then(i2))}function fA(f){Ui(f)?hh.push(...f):Pl&&f.id===-1?Pl.splice(ah+1,0,f):f.flags&1||(hh.push(f),f.flags|=1),e2()}function vb(f,v,I=Jo+1){for(;I<gs.length;I++){const P=gs[I];if(P&&P.flags&2){if(f&&P.id!==f.uid)continue;gs.splice(I,1),I--,P.flags&4&&(P.flags&=-2),P(),P.flags&4||(P.flags&=-2)}}}function t2(f){if(hh.length){const v=[...new Set(hh)].sort((I,P)=>Of(I)-Of(P));if(hh.length=0,Pl){Pl.push(...v);return}for(Pl=v,ah=0;ah<Pl.length;ah++){const I=Pl[ah];I.flags&4&&(I.flags&=-2),I.flags&8||I(),I.flags&=-2}Pl=null,ah=0}}const Of=f=>f.id==null?f.flags&2?-1:1/0:f.id;function i2(f){try{for(Jo=0;Jo<gs.length;Jo++){const v=gs[Jo];v&&!(v.flags&8)&&(v.flags&4&&(v.flags&=-2),qf(v,v.i,v.i?15:14),v.flags&4||(v.flags&=-2))}}finally{for(;Jo<gs.length;Jo++){const v=gs[Jo];v&&(v.flags&=-2)}Jo=-1,gs.length=0,t2(),Qm=null,(gs.length||hh.length)&&i2()}}let Rs=null,r2=null;function e_(f){const v=Rs;return Rs=f,r2=f&&f.type.__scopeId||null,v}function Ia(f,v=Rs,I){if(!v||f._n)return f;const P=(...k)=>{P._d&&Cb(-1);const j=e_(v);let $;try{$=f(...k)}finally{e_(j),P._d&&Cb(1)}return $};return P._n=!0,P._c=!0,P._d=!0,P}function Dn(f,v){if(Rs===null)return f;const I=x_(Rs),P=f.dirs||(f.dirs=[]);for(let k=0;k<v.length;k++){let[j,$,s,Q=Gr]=v[k];j&&(sr(j)&&(j={mounted:j,updated:j}),j.deep&&Ma($),P.push({dir:j,instance:I,value:$,oldValue:void 0,arg:s,modifiers:Q}))}return f}function Lc(f,v,I,P){const k=f.dirs,j=v&&v.dirs;for(let $=0;$<k.length;$++){const s=k[$];j&&(s.oldValue=j[$].value);let Q=s.dir[P];Q&&(kl(),ia(Q,I,8,[f.el,s,f,v]),Fl())}}const pA=Symbol("_vte"),mA=f=>f.__isTeleport;function Mv(f,v){f.shapeFlag&6&&f.component?(f.transition=v,Mv(f.component.subTree,v)):f.shapeFlag&128?(f.ssContent.transition=v.clone(f.ssContent),f.ssFallback.transition=v.clone(f.ssFallback)):f.transition=v}/*! #__NO_SIDE_EFFECTS__ */function n2(f,v){return sr(f)?rs({name:f.name},v,{setup:f}):f}function s2(f){f.ids=[f.ids[0]+f.ids[2]+++"-",0,0]}function t_(f,v,I,P,k=!1){if(Ui(f)){f.forEach((Ze,et)=>t_(Ze,v&&(Ui(v)?v[et]:v),I,P,k));return}if(Af(P)&&!k){P.shapeFlag&512&&P.type.__asyncResolved&&P.component.subTree.component&&t_(f,v,I,P.component.subTree);return}const j=P.shapeFlag&4?x_(P.component):P.el,$=k?null:j,{i:s,r:Q}=f,de=v&&v.r,ae=s.refs===Gr?s.refs={}:s.refs,Te=s.setupState,Ne=Ir(Te),Re=Te===Gr?()=>!1:Ze=>Lr(Ne,Ze);if(de!=null&&de!==Q&&(Sn(de)?(ae[de]=null,Re(de)&&(Te[de]=null)):_n(de)&&(de.value=null)),sr(Q))qf(Q,s,12,[$,ae]);else{const Ze=Sn(Q),et=_n(Q);if(Ze||et){const ft=()=>{if(f.f){const vt=Ze?Re(Q)?Te[Q]:ae[Q]:Q.value;k?Ui(vt)&&pv(vt,j):Ui(vt)?vt.includes(j)||vt.push(j):Ze?(ae[Q]=[j],Re(Q)&&(Te[Q]=ae[Q])):(Q.value=[j],f.k&&(ae[f.k]=Q.value))}else Ze?(ae[Q]=$,Re(Q)&&(Te[Q]=$)):et&&(Q.value=$,f.k&&(ae[f.k]=$))};$?(ft.id=-1,Gs(ft,I)):ft()}}}f_().requestIdleCallback;f_().cancelIdleCallback;const Af=f=>!!f.type.__asyncLoader,o2=f=>f.type.__isKeepAlive;function _A(f,v){a2(f,"a",v)}function gA(f,v){a2(f,"da",v)}function a2(f,v,I=$n){const P=f.__wdc||(f.__wdc=()=>{let k=I;for(;k;){if(k.isDeactivated)return;k=k.parent}return f()});if(g_(v,P,I),I){let k=I.parent;for(;k&&k.parent;)o2(k.parent.vnode)&&yA(P,v,I,k),k=k.parent}}function yA(f,v,I,P){const k=g_(v,f,P,!0);l2(()=>{pv(P[v],k)},I)}function g_(f,v,I=$n,P=!1){if(I){const k=I[f]||(I[f]=[]),j=v.__weh||(v.__weh=(...$)=>{kl();const s=Hf(I),Q=ia(v,I,f,$);return s(),Fl(),Q});return P?k.unshift(j):k.push(j),j}}const Ca=f=>(v,I=$n)=>{(!Bf||f==="sp")&&g_(f,(...P)=>v(...P),I)},vA=Ca("bm"),xh=Ca("m"),xA=Ca("bu"),bA=Ca("u"),wA=Ca("bum"),l2=Ca("um"),TA=Ca("sp"),SA=Ca("rtg"),EA=Ca("rtc");function MA(f,v=$n){g_("ec",f,v)}const AA="components";function Ol(f,v){return CA(AA,f,!0,v)||f}const IA=Symbol.for("v-ndc");function CA(f,v,I=!0,P=!1){const k=Rs||$n;if(k){const j=k.type;{const s=yI(j,!1);if(s&&(s===v||s===no(v)||s===d_(no(v))))return j}const $=xb(k[f]||j[f],v)||xb(k.appContext[f],v);return!$&&P?j:$}}function xb(f,v){return f&&(f[v]||f[no(v)]||f[d_(no(v))])}function kf(f,v,I,P){let k;const j=I,$=Ui(f);if($||Sn(f)){const s=$&&Ll(f);let Q=!1;s&&(Q=!io(f),f=m_(f)),k=new Array(f.length);for(let de=0,ae=f.length;de<ae;de++)k[de]=v(Q?ts(f[de]):f[de],de,void 0,j)}else if(typeof f=="number"){k=new Array(f);for(let s=0;s<f;s++)k[s]=v(s+1,s,void 0,j)}else if(Xr(f))if(f[Symbol.iterator])k=Array.from(f,(s,Q)=>v(s,Q,void 0,j));else{const s=Object.keys(f);k=new Array(s.length);for(let Q=0,de=s.length;Q<de;Q++){const ae=s[Q];k[Q]=v(f[ae],ae,Q,j)}}else k=[];return k}const Xy=f=>f?C2(f)?x_(f):Xy(f.parent):null,If=rs(Object.create(null),{$:f=>f,$el:f=>f.vnode.el,$data:f=>f.data,$props:f=>f.props,$attrs:f=>f.attrs,$slots:f=>f.slots,$refs:f=>f.refs,$parent:f=>Xy(f.parent),$root:f=>Xy(f.root),$host:f=>f.ce,$emit:f=>f.emit,$options:f=>u2(f),$forceUpdate:f=>f.f||(f.f=()=>{Ev(f.update)}),$nextTick:f=>f.n||(f.n=$f.bind(f.proxy)),$watch:f=>YA.bind(f)}),Ly=(f,v)=>f!==Gr&&!f.__isScriptSetup&&Lr(f,v),PA={get({_:f},v){if(v==="__v_skip")return!0;const{ctx:I,setupState:P,data:k,props:j,accessCache:$,type:s,appContext:Q}=f;let de;if(v[0]!=="$"){const Re=$[v];if(Re!==void 0)switch(Re){case 1:return P[v];case 2:return k[v];case 4:return I[v];case 3:return j[v]}else{if(Ly(P,v))return $[v]=1,P[v];if(k!==Gr&&Lr(k,v))return $[v]=2,k[v];if((de=f.propsOptions[0])&&Lr(de,v))return $[v]=3,j[v];if(I!==Gr&&Lr(I,v))return $[v]=4,I[v];Ky&&($[v]=0)}}const ae=If[v];let Te,Ne;if(ae)return v==="$attrs"&&es(f.attrs,"get",""),ae(f);if((Te=s.__cssModules)&&(Te=Te[v]))return Te;if(I!==Gr&&Lr(I,v))return $[v]=4,I[v];if(Ne=Q.config.globalProperties,Lr(Ne,v))return Ne[v]},set({_:f},v,I){const{data:P,setupState:k,ctx:j}=f;return Ly(k,v)?(k[v]=I,!0):P!==Gr&&Lr(P,v)?(P[v]=I,!0):Lr(f.props,v)||v[0]==="$"&&v.slice(1)in f?!1:(j[v]=I,!0)},has({_:{data:f,setupState:v,accessCache:I,ctx:P,appContext:k,propsOptions:j}},$){let s;return!!I[$]||f!==Gr&&Lr(f,$)||Ly(v,$)||(s=j[0])&&Lr(s,$)||Lr(P,$)||Lr(If,$)||Lr(k.config.globalProperties,$)},defineProperty(f,v,I){return I.get!=null?f._.accessCache[v]=0:Lr(I,"value")&&this.set(f,v,I.value,null),Reflect.defineProperty(f,v,I)}};function bb(f){return Ui(f)?f.reduce((v,I)=>(v[I]=null,v),{}):f}let Ky=!0;function RA(f){const v=u2(f),I=f.proxy,P=f.ctx;Ky=!1,v.beforeCreate&&wb(v.beforeCreate,f,"bc");const{data:k,computed:j,methods:$,watch:s,provide:Q,inject:de,created:ae,beforeMount:Te,mounted:Ne,beforeUpdate:Re,updated:Ze,activated:et,deactivated:ft,beforeDestroy:vt,beforeUnmount:gt,destroyed:Vt,unmounted:pt,render:ui,renderTracked:zi,renderTriggered:Pt,errorCaptured:di,serverPrefetch:jt,expose:st,inheritAttrs:zt,components:ji,directives:Ci,filters:Fr}=v;if(de&&DA(de,P,null),$)for(const bi in $){const nr=$[bi];sr(nr)&&(P[bi]=nr.bind(I))}if(k){const bi=k.call(I,I);Xr(bi)&&(f.data=Gf(bi))}if(Ky=!0,j)for(const bi in j){const nr=j[bi],hi=sr(nr)?nr.bind(I,I):sr(nr.get)?nr.get.bind(I,I):ea,Ti=!sr(nr)&&sr(nr.set)?nr.set.bind(I):ea,Bt=Ps({get:hi,set:Ti});Object.defineProperty(P,bi,{enumerable:!0,configurable:!0,get:()=>Bt.value,set:gi=>Bt.value=gi})}if(s)for(const bi in s)c2(s[bi],P,I,bi);if(Q){const bi=sr(Q)?Q.call(I):Q;Reflect.ownKeys(bi).forEach(nr=>{jm(nr,bi[nr])})}ae&&wb(ae,f,"c");function Yi(bi,nr){Ui(nr)?nr.forEach(hi=>bi(hi.bind(I))):nr&&bi(nr.bind(I))}if(Yi(vA,Te),Yi(xh,Ne),Yi(xA,Re),Yi(bA,Ze),Yi(_A,et),Yi(gA,ft),Yi(MA,di),Yi(EA,zi),Yi(SA,Pt),Yi(wA,gt),Yi(l2,pt),Yi(TA,jt),Ui(st))if(st.length){const bi=f.exposed||(f.exposed={});st.forEach(nr=>{Object.defineProperty(bi,nr,{get:()=>I[nr],set:hi=>I[nr]=hi})})}else f.exposed||(f.exposed={});ui&&f.render===ea&&(f.render=ui),zt!=null&&(f.inheritAttrs=zt),ji&&(f.components=ji),Ci&&(f.directives=Ci),jt&&s2(f)}function DA(f,v,I=ea){Ui(f)&&(f=Yy(f));for(const P in f){const k=f[P];let j;Xr(k)?"default"in k?j=ro(k.from||P,k.default,!0):j=ro(k.from||P):j=ro(k),_n(j)?Object.defineProperty(v,P,{enumerable:!0,configurable:!0,get:()=>j.value,set:$=>j.value=$}):v[P]=j}}function wb(f,v,I){ia(Ui(f)?f.map(P=>P.bind(v.proxy)):f.bind(v.proxy),v,I)}function c2(f,v,I,P){let k=P.includes(".")?S2(I,P):()=>I[P];if(Sn(f)){const j=v[f];sr(j)&&dh(k,j)}else if(sr(f))dh(k,f.bind(I));else if(Xr(f))if(Ui(f))f.forEach(j=>c2(j,v,I,P));else{const j=sr(f.handler)?f.handler.bind(I):v[f.handler];sr(j)&&dh(k,j,f)}}function u2(f){const v=f.type,{mixins:I,extends:P}=v,{mixins:k,optionsCache:j,config:{optionMergeStrategies:$}}=f.appContext,s=j.get(v);let Q;return s?Q=s:!k.length&&!I&&!P?Q=v:(Q={},k.length&&k.forEach(de=>i_(Q,de,$,!0)),i_(Q,v,$)),Xr(v)&&j.set(v,Q),Q}function i_(f,v,I,P=!1){const{mixins:k,extends:j}=v;j&&i_(f,j,I,!0),k&&k.forEach($=>i_(f,$,I,!0));for(const $ in v)if(!(P&&$==="expose")){const s=zA[$]||I&&I[$];f[$]=s?s(f[$],v[$]):v[$]}return f}const zA={data:Tb,props:Sb,emits:Sb,methods:Tf,computed:Tf,beforeCreate:ms,created:ms,beforeMount:ms,mounted:ms,beforeUpdate:ms,updated:ms,beforeDestroy:ms,beforeUnmount:ms,destroyed:ms,unmounted:ms,activated:ms,deactivated:ms,errorCaptured:ms,serverPrefetch:ms,components:Tf,directives:Tf,watch:OA,provide:Tb,inject:LA};function Tb(f,v){return v?f?function(){return rs(sr(f)?f.call(this,this):f,sr(v)?v.call(this,this):v)}:v:f}function LA(f,v){return Tf(Yy(f),Yy(v))}function Yy(f){if(Ui(f)){const v={};for(let I=0;I<f.length;I++)v[f[I]]=f[I];return v}return f}function ms(f,v){return f?[...new Set([].concat(f,v))]:v}function Tf(f,v){return f?rs(Object.create(null),f,v):v}function Sb(f,v){return f?Ui(f)&&Ui(v)?[...new Set([...f,...v])]:rs(Object.create(null),bb(f),bb(v??{})):v}function OA(f,v){if(!f)return v;if(!v)return f;const I=rs(Object.create(null),f);for(const P in v)I[P]=ms(f[P],v[P]);return I}function h2(){return{app:null,config:{isNativeTag:wM,performance:!1,globalProperties:{},optionMergeStrategies:{},errorHandler:void 0,warnHandler:void 0,compilerOptions:{}},mixins:[],components:{},directives:{},provides:Object.create(null),optionsCache:new WeakMap,propsCache:new WeakMap,emitsCache:new WeakMap}}let kA=0;function FA(f,v){return function(P,k=null){sr(P)||(P=rs({},P)),k!=null&&!Xr(k)&&(k=null);const j=h2(),$=new WeakSet,s=[];let Q=!1;const de=j.app={_uid:kA++,_component:P,_props:k,_container:null,_context:j,_instance:null,version:xI,get config(){return j.config},set config(ae){},use(ae,...Te){return $.has(ae)||(ae&&sr(ae.install)?($.add(ae),ae.install(de,...Te)):sr(ae)&&($.add(ae),ae(de,...Te))),de},mixin(ae){return j.mixins.includes(ae)||j.mixins.push(ae),de},component(ae,Te){return Te?(j.components[ae]=Te,de):j.components[ae]},directive(ae,Te){return Te?(j.directives[ae]=Te,de):j.directives[ae]},mount(ae,Te,Ne){if(!Q){const Re=de._ceVNode||en(P,k);return Re.appContext=j,Ne===!0?Ne="svg":Ne===!1&&(Ne=void 0),f(Re,ae,Ne),Q=!0,de._container=ae,ae.__vue_app__=de,x_(Re.component)}},onUnmount(ae){s.push(ae)},unmount(){Q&&(ia(s,de._instance,16),f(null,de._container),delete de._container.__vue_app__)},provide(ae,Te){return j.provides[ae]=Te,de},runWithContext(ae){const Te=Vc;Vc=de;try{return ae()}finally{Vc=Te}}};return de}}let Vc=null;function jm(f,v){if($n){let I=$n.provides;const P=$n.parent&&$n.parent.provides;P===I&&(I=$n.provides=Object.create(P)),I[f]=v}}function ro(f,v,I=!1){const P=$n||Rs;if(P||Vc){const k=Vc?Vc._context.provides:P?P.parent==null?P.vnode.appContext&&P.vnode.appContext.provides:P.parent.provides:void 0;if(k&&f in k)return k[f];if(arguments.length>1)return I&&sr(v)?v.call(P&&P.proxy):v}}function BA(){return!!($n||Rs||Vc)}const d2={},f2=()=>Object.create(d2),p2=f=>Object.getPrototypeOf(f)===d2;function NA(f,v,I,P=!1){const k={},j=f2();f.propsDefaults=Object.create(null),m2(f,v,k,j);for(const $ in f.propsOptions[0])$ in k||(k[$]=void 0);I?f.props=P?k:Xw(k):f.type.props?f.props=k:f.props=j,f.attrs=j}function VA(f,v,I,P){const{props:k,attrs:j,vnode:{patchFlag:$}}=f,s=Ir(k),[Q]=f.propsOptions;let de=!1;if((P||$>0)&&!($&16)){if($&8){const ae=f.vnode.dynamicProps;for(let Te=0;Te<ae.length;Te++){let Ne=ae[Te];if(y_(f.emitsOptions,Ne))continue;const Re=v[Ne];if(Q)if(Lr(j,Ne))Re!==j[Ne]&&(j[Ne]=Re,de=!0);else{const Ze=no(Ne);k[Ze]=Jy(Q,s,Ze,Re,f,!1)}else Re!==j[Ne]&&(j[Ne]=Re,de=!0)}}}else{m2(f,v,k,j)&&(de=!0);let ae;for(const Te in s)(!v||!Lr(v,Te)&&((ae=$c(Te))===Te||!Lr(v,ae)))&&(Q?I&&(I[Te]!==void 0||I[ae]!==void 0)&&(k[Te]=Jy(Q,s,Te,void 0,f,!0)):delete k[Te]);if(j!==s)for(const Te in j)(!v||!Lr(v,Te))&&(delete j[Te],de=!0)}de&&Ea(f.attrs,"set","")}function m2(f,v,I,P){const[k,j]=f.propsOptions;let $=!1,s;if(v)for(let Q in v){if(Sf(Q))continue;const de=v[Q];let ae;k&&Lr(k,ae=no(Q))?!j||!j.includes(ae)?I[ae]=de:(s||(s={}))[ae]=de:y_(f.emitsOptions,Q)||(!(Q in P)||de!==P[Q])&&(P[Q]=de,$=!0)}if(j){const Q=Ir(I),de=s||Gr;for(let ae=0;ae<j.length;ae++){const Te=j[ae];I[Te]=Jy(k,Q,Te,de[Te],f,!Lr(de,Te))}}return $}function Jy(f,v,I,P,k,j){const $=f[I];if($!=null){const s=Lr($,"default");if(s&&P===void 0){const Q=$.default;if($.type!==Function&&!$.skipFactory&&sr(Q)){const{propsDefaults:de}=k;if(I in de)P=de[I];else{const ae=Hf(k);P=de[I]=Q.call(null,v),ae()}}else P=Q;k.ce&&k.ce._setProp(I,P)}$[0]&&(j&&!s?P=!1:$[1]&&(P===""||P===$c(I))&&(P=!0))}return P}const UA=new WeakMap;function _2(f,v,I=!1){const P=I?UA:v.propsCache,k=P.get(f);if(k)return k;const j=f.props,$={},s=[];let Q=!1;if(!sr(f)){const ae=Te=>{Q=!0;const[Ne,Re]=_2(Te,v,!0);rs($,Ne),Re&&s.push(...Re)};!I&&v.mixins.length&&v.mixins.forEach(ae),f.extends&&ae(f.extends),f.mixins&&f.mixins.forEach(ae)}if(!j&&!Q)return Xr(f)&&P.set(f,ch),ch;if(Ui(j))for(let ae=0;ae<j.length;ae++){const Te=no(j[ae]);Eb(Te)&&($[Te]=Gr)}else if(j)for(const ae in j){const Te=no(ae);if(Eb(Te)){const Ne=j[ae],Re=$[Te]=Ui(Ne)||sr(Ne)?{type:Ne}:rs({},Ne),Ze=Re.type;let et=!1,ft=!0;if(Ui(Ze))for(let vt=0;vt<Ze.length;++vt){const gt=Ze[vt],Vt=sr(gt)&&gt.name;if(Vt==="Boolean"){et=!0;break}else Vt==="String"&&(ft=!1)}else et=sr(Ze)&&Ze.name==="Boolean";Re[0]=et,Re[1]=ft,(et||Lr(Re,"default"))&&s.push(Te)}}const de=[$,s];return Xr(f)&&P.set(f,de),de}function Eb(f){return f[0]!=="$"&&!Sf(f)}const g2=f=>f[0]==="_"||f==="$stable",Av=f=>Ui(f)?f.map(Qo):[Qo(f)],jA=(f,v,I)=>{if(v._n)return v;const P=Ia((...k)=>Av(v(...k)),I);return P._c=!1,P},y2=(f,v,I)=>{const P=f._ctx;for(const k in f){if(g2(k))continue;const j=f[k];if(sr(j))v[k]=jA(k,j,P);else if(j!=null){const $=Av(j);v[k]=()=>$}}},v2=(f,v)=>{const I=Av(v);f.slots.default=()=>I},x2=(f,v,I)=>{for(const P in v)(I||P!=="_")&&(f[P]=v[P])},GA=(f,v,I)=>{const P=f.slots=f2();if(f.vnode.shapeFlag&32){const k=v._;k?(x2(P,v,I),I&&Iw(P,"_",k,!0)):y2(v,P)}else v&&v2(f,v)},qA=(f,v,I)=>{const{vnode:P,slots:k}=f;let j=!0,$=Gr;if(P.shapeFlag&32){const s=v._;s?I&&s===1?j=!1:x2(k,v,I):(j=!v.$stable,y2(v,k)),$=v}else v&&(v2(f,v),$={default:1});if(j)for(const s in k)!g2(s)&&$[s]==null&&delete k[s]},Gs=nI;function $A(f){return HA(f)}function HA(f,v){const I=f_();I.__VUE__=!0;const{insert:P,remove:k,patchProp:j,createElement:$,createText:s,createComment:Q,setText:de,setElementText:ae,parentNode:Te,nextSibling:Ne,setScopeId:Re=ea,insertStaticContent:Ze}=f,et=(ze,Be,we,bt=null,Tt=null,St=null,xt=void 0,Ut=null,Gt=!!Be.dynamicChildren)=>{if(ze===Be)return;ze&&!xf(ze,Be)&&(bt=mt(ze),gi(ze,Tt,St,!0),ze=null),Be.patchFlag===-2&&(Gt=!1,Be.dynamicChildren=null);const{type:Nt,ref:xi,shapeFlag:Jt}=Be;switch(Nt){case v_:ft(ze,Be,we,bt);break;case Gc:vt(ze,Be,we,bt);break;case Gm:ze==null&&gt(Be,we,bt,xt);break;case Is:ji(ze,Be,we,bt,Tt,St,xt,Ut,Gt);break;default:Jt&1?ui(ze,Be,we,bt,Tt,St,xt,Ut,Gt):Jt&6?Ci(ze,Be,we,bt,Tt,St,xt,Ut,Gt):(Jt&64||Jt&128)&&Nt.process(ze,Be,we,bt,Tt,St,xt,Ut,Gt,J)}xi!=null&&Tt&&t_(xi,ze&&ze.ref,St,Be||ze,!Be)},ft=(ze,Be,we,bt)=>{if(ze==null)P(Be.el=s(Be.children),we,bt);else{const Tt=Be.el=ze.el;Be.children!==ze.children&&de(Tt,Be.children)}},vt=(ze,Be,we,bt)=>{ze==null?P(Be.el=Q(Be.children||""),we,bt):Be.el=ze.el},gt=(ze,Be,we,bt)=>{[ze.el,ze.anchor]=Ze(ze.children,Be,we,bt,ze.el,ze.anchor)},Vt=({el:ze,anchor:Be},we,bt)=>{let Tt;for(;ze&&ze!==Be;)Tt=Ne(ze),P(ze,we,bt),ze=Tt;P(Be,we,bt)},pt=({el:ze,anchor:Be})=>{let we;for(;ze&&ze!==Be;)we=Ne(ze),k(ze),ze=we;k(Be)},ui=(ze,Be,we,bt,Tt,St,xt,Ut,Gt)=>{Be.type==="svg"?xt="svg":Be.type==="math"&&(xt="mathml"),ze==null?zi(Be,we,bt,Tt,St,xt,Ut,Gt):jt(ze,Be,Tt,St,xt,Ut,Gt)},zi=(ze,Be,we,bt,Tt,St,xt,Ut)=>{let Gt,Nt;const{props:xi,shapeFlag:Jt,transition:Dt,dirs:yi}=ze;if(Gt=ze.el=$(ze.type,St,xi&&xi.is,xi),Jt&8?ae(Gt,ze.children):Jt&16&&di(ze.children,Gt,null,bt,Tt,Oy(ze,St),xt,Ut),yi&&Lc(ze,null,bt,"created"),Pt(Gt,ze,ze.scopeId,xt,bt),xi){for(const gr in xi)gr!=="value"&&!Sf(gr)&&j(Gt,gr,null,xi[gr],St,bt);"value"in xi&&j(Gt,"value",null,xi.value,St),(Nt=xi.onVnodeBeforeMount)&&Ko(Nt,bt,ze)}yi&&Lc(ze,null,bt,"beforeMount");const Ji=ZA(Tt,Dt);Ji&&Dt.beforeEnter(Gt),P(Gt,Be,we),((Nt=xi&&xi.onVnodeMounted)||Ji||yi)&&Gs(()=>{Nt&&Ko(Nt,bt,ze),Ji&&Dt.enter(Gt),yi&&Lc(ze,null,bt,"mounted")},Tt)},Pt=(ze,Be,we,bt,Tt)=>{if(we&&Re(ze,we),bt)for(let St=0;St<bt.length;St++)Re(ze,bt[St]);if(Tt){let St=Tt.subTree;if(Be===St||M2(St.type)&&(St.ssContent===Be||St.ssFallback===Be)){const xt=Tt.vnode;Pt(ze,xt,xt.scopeId,xt.slotScopeIds,Tt.parent)}}},di=(ze,Be,we,bt,Tt,St,xt,Ut,Gt=0)=>{for(let Nt=Gt;Nt<ze.length;Nt++){const xi=ze[Nt]=Ut?Rl(ze[Nt]):Qo(ze[Nt]);et(null,xi,Be,we,bt,Tt,St,xt,Ut)}},jt=(ze,Be,we,bt,Tt,St,xt)=>{const Ut=Be.el=ze.el;let{patchFlag:Gt,dynamicChildren:Nt,dirs:xi}=Be;Gt|=ze.patchFlag&16;const Jt=ze.props||Gr,Dt=Be.props||Gr;let yi;if(we&&Oc(we,!1),(yi=Dt.onVnodeBeforeUpdate)&&Ko(yi,we,Be,ze),xi&&Lc(Be,ze,we,"beforeUpdate"),we&&Oc(we,!0),(Jt.innerHTML&&Dt.innerHTML==null||Jt.textContent&&Dt.textContent==null)&&ae(Ut,""),Nt?st(ze.dynamicChildren,Nt,Ut,we,bt,Oy(Be,Tt),St):xt||nr(ze,Be,Ut,null,we,bt,Oy(Be,Tt),St,!1),Gt>0){if(Gt&16)zt(Ut,Jt,Dt,we,Tt);else if(Gt&2&&Jt.class!==Dt.class&&j(Ut,"class",null,Dt.class,Tt),Gt&4&&j(Ut,"style",Jt.style,Dt.style,Tt),Gt&8){const Ji=Be.dynamicProps;for(let gr=0;gr<Ji.length;gr++){const Gi=Ji[gr],Kr=Jt[Gi],Vr=Dt[Gi];(Vr!==Kr||Gi==="value")&&j(Ut,Gi,Kr,Vr,Tt,we)}}Gt&1&&ze.children!==Be.children&&ae(Ut,Be.children)}else!xt&&Nt==null&&zt(Ut,Jt,Dt,we,Tt);((yi=Dt.onVnodeUpdated)||xi)&&Gs(()=>{yi&&Ko(yi,we,Be,ze),xi&&Lc(Be,ze,we,"updated")},bt)},st=(ze,Be,we,bt,Tt,St,xt)=>{for(let Ut=0;Ut<Be.length;Ut++){const Gt=ze[Ut],Nt=Be[Ut],xi=Gt.el&&(Gt.type===Is||!xf(Gt,Nt)||Gt.shapeFlag&70)?Te(Gt.el):we;et(Gt,Nt,xi,null,bt,Tt,St,xt,!0)}},zt=(ze,Be,we,bt,Tt)=>{if(Be!==we){if(Be!==Gr)for(const St in Be)!Sf(St)&&!(St in we)&&j(ze,St,Be[St],null,Tt,bt);for(const St in we){if(Sf(St))continue;const xt=we[St],Ut=Be[St];xt!==Ut&&St!=="value"&&j(ze,St,Ut,xt,Tt,bt)}"value"in we&&j(ze,"value",Be.value,we.value,Tt)}},ji=(ze,Be,we,bt,Tt,St,xt,Ut,Gt)=>{const Nt=Be.el=ze?ze.el:s(""),xi=Be.anchor=ze?ze.anchor:s("");let{patchFlag:Jt,dynamicChildren:Dt,slotScopeIds:yi}=Be;yi&&(Ut=Ut?Ut.concat(yi):yi),ze==null?(P(Nt,we,bt),P(xi,we,bt),di(Be.children||[],we,xi,Tt,St,xt,Ut,Gt)):Jt>0&&Jt&64&&Dt&&ze.dynamicChildren?(st(ze.dynamicChildren,Dt,we,Tt,St,xt,Ut),(Be.key!=null||Tt&&Be===Tt.subTree)&&b2(ze,Be,!0)):nr(ze,Be,we,xi,Tt,St,xt,Ut,Gt)},Ci=(ze,Be,we,bt,Tt,St,xt,Ut,Gt)=>{Be.slotScopeIds=Ut,ze==null?Be.shapeFlag&512?Tt.ctx.activate(Be,we,bt,xt,Gt):Fr(Be,we,bt,Tt,St,xt,Gt):oi(ze,Be,Gt)},Fr=(ze,Be,we,bt,Tt,St,xt)=>{const Ut=ze.component=fI(ze,bt,Tt);if(o2(ze)&&(Ut.ctx.renderer=J),pI(Ut,!1,xt),Ut.asyncDep){if(Tt&&Tt.registerDep(Ut,Yi,xt),!ze.el){const Gt=Ut.subTree=en(Gc);vt(null,Gt,Be,we)}}else Yi(Ut,ze,Be,we,Tt,St,xt)},oi=(ze,Be,we)=>{const bt=Be.component=ze.component;if(iI(ze,Be,we))if(bt.asyncDep&&!bt.asyncResolved){bi(bt,Be,we);return}else bt.next=Be,bt.update();else Be.el=ze.el,bt.vnode=Be},Yi=(ze,Be,we,bt,Tt,St,xt)=>{const Ut=()=>{if(ze.isMounted){let{next:Jt,bu:Dt,u:yi,parent:Ji,vnode:gr}=ze;{const Ln=w2(ze);if(Ln){Jt&&(Jt.el=gr.el,bi(ze,Jt,xt)),Ln.asyncDep.then(()=>{ze.isUnmounted||Ut()});return}}let Gi=Jt,Kr;Oc(ze,!1),Jt?(Jt.el=gr.el,bi(ze,Jt,xt)):Jt=gr,Dt&&Um(Dt),(Kr=Jt.props&&Jt.props.onVnodeBeforeUpdate)&&Ko(Kr,Ji,Jt,gr),Oc(ze,!0);const Vr=Ab(ze),zn=ze.subTree;ze.subTree=Vr,et(zn,Vr,Te(zn.el),mt(zn),ze,Tt,St),Jt.el=Vr.el,Gi===null&&rI(ze,Vr.el),yi&&Gs(yi,Tt),(Kr=Jt.props&&Jt.props.onVnodeUpdated)&&Gs(()=>Ko(Kr,Ji,Jt,gr),Tt)}else{let Jt;const{el:Dt,props:yi}=Be,{bm:Ji,m:gr,parent:Gi,root:Kr,type:Vr}=ze,zn=Af(Be);Oc(ze,!1),Ji&&Um(Ji),!zn&&(Jt=yi&&yi.onVnodeBeforeMount)&&Ko(Jt,Gi,Be),Oc(ze,!0);{Kr.ce&&Kr.ce._injectChildStyle(Vr);const Ln=ze.subTree=Ab(ze);et(null,Ln,we,bt,ze,Tt,St),Be.el=Ln.el}if(gr&&Gs(gr,Tt),!zn&&(Jt=yi&&yi.onVnodeMounted)){const Ln=Be;Gs(()=>Ko(Jt,Gi,Ln),Tt)}(Be.shapeFlag&256||Gi&&Af(Gi.vnode)&&Gi.vnode.shapeFlag&256)&&ze.a&&Gs(ze.a,Tt),ze.isMounted=!0,Be=we=bt=null}};ze.scope.on();const Gt=ze.effect=new Ow(Ut);ze.scope.off();const Nt=ze.update=Gt.run.bind(Gt),xi=ze.job=Gt.runIfDirty.bind(Gt);xi.i=ze,xi.id=ze.uid,Gt.scheduler=()=>Ev(xi),Oc(ze,!0),Nt()},bi=(ze,Be,we)=>{Be.component=ze;const bt=ze.vnode.props;ze.vnode=Be,ze.next=null,VA(ze,Be.props,bt,we),qA(ze,Be.children,we),kl(),vb(ze),Fl()},nr=(ze,Be,we,bt,Tt,St,xt,Ut,Gt=!1)=>{const Nt=ze&&ze.children,xi=ze?ze.shapeFlag:0,Jt=Be.children,{patchFlag:Dt,shapeFlag:yi}=Be;if(Dt>0){if(Dt&128){Ti(Nt,Jt,we,bt,Tt,St,xt,Ut,Gt);return}else if(Dt&256){hi(Nt,Jt,we,bt,Tt,St,xt,Ut,Gt);return}}yi&8?(xi&16&&fr(Nt,Tt,St),Jt!==Nt&&ae(we,Jt)):xi&16?yi&16?Ti(Nt,Jt,we,bt,Tt,St,xt,Ut,Gt):fr(Nt,Tt,St,!0):(xi&8&&ae(we,""),yi&16&&di(Jt,we,bt,Tt,St,xt,Ut,Gt))},hi=(ze,Be,we,bt,Tt,St,xt,Ut,Gt)=>{ze=ze||ch,Be=Be||ch;const Nt=ze.length,xi=Be.length,Jt=Math.min(Nt,xi);let Dt;for(Dt=0;Dt<Jt;Dt++){const yi=Be[Dt]=Gt?Rl(Be[Dt]):Qo(Be[Dt]);et(ze[Dt],yi,we,null,Tt,St,xt,Ut,Gt)}Nt>xi?fr(ze,Tt,St,!0,!1,Jt):di(Be,we,bt,Tt,St,xt,Ut,Gt,Jt)},Ti=(ze,Be,we,bt,Tt,St,xt,Ut,Gt)=>{let Nt=0;const xi=Be.length;let Jt=ze.length-1,Dt=xi-1;for(;Nt<=Jt&&Nt<=Dt;){const yi=ze[Nt],Ji=Be[Nt]=Gt?Rl(Be[Nt]):Qo(Be[Nt]);if(xf(yi,Ji))et(yi,Ji,we,null,Tt,St,xt,Ut,Gt);else break;Nt++}for(;Nt<=Jt&&Nt<=Dt;){const yi=ze[Jt],Ji=Be[Dt]=Gt?Rl(Be[Dt]):Qo(Be[Dt]);if(xf(yi,Ji))et(yi,Ji,we,null,Tt,St,xt,Ut,Gt);else break;Jt--,Dt--}if(Nt>Jt){if(Nt<=Dt){const yi=Dt+1,Ji=yi<xi?Be[yi].el:bt;for(;Nt<=Dt;)et(null,Be[Nt]=Gt?Rl(Be[Nt]):Qo(Be[Nt]),we,Ji,Tt,St,xt,Ut,Gt),Nt++}}else if(Nt>Dt)for(;Nt<=Jt;)gi(ze[Nt],Tt,St,!0),Nt++;else{const yi=Nt,Ji=Nt,gr=new Map;for(Nt=Ji;Nt<=Dt;Nt++){const Or=Be[Nt]=Gt?Rl(Be[Nt]):Qo(Be[Nt]);Or.key!=null&&gr.set(Or.key,Nt)}let Gi,Kr=0;const Vr=Dt-Ji+1;let zn=!1,Ln=0;const ns=new Array(Vr);for(Nt=0;Nt<Vr;Nt++)ns[Nt]=0;for(Nt=yi;Nt<=Jt;Nt++){const Or=ze[Nt];if(Kr>=Vr){gi(Or,Tt,St,!0);continue}let En;if(Or.key!=null)En=gr.get(Or.key);else for(Gi=Ji;Gi<=Dt;Gi++)if(ns[Gi-Ji]===0&&xf(Or,Be[Gi])){En=Gi;break}En===void 0?gi(Or,Tt,St,!0):(ns[En-Ji]=Nt+1,En>=Ln?Ln=En:zn=!0,et(Or,Be[En],we,null,Tt,St,xt,Ut,Gt),Kr++)}const Hs=zn?WA(ns):ch;for(Gi=Hs.length-1,Nt=Vr-1;Nt>=0;Nt--){const Or=Ji+Nt,En=Be[Or],br=Or+1<xi?Be[Or+1].el:bt;ns[Nt]===0?et(null,En,we,br,Tt,St,xt,Ut,Gt):zn&&(Gi<0||Nt!==Hs[Gi]?Bt(En,we,br,2):Gi--)}}},Bt=(ze,Be,we,bt,Tt=null)=>{const{el:St,type:xt,transition:Ut,children:Gt,shapeFlag:Nt}=ze;if(Nt&6){Bt(ze.component.subTree,Be,we,bt);return}if(Nt&128){ze.suspense.move(Be,we,bt);return}if(Nt&64){xt.move(ze,Be,we,J);return}if(xt===Is){P(St,Be,we);for(let Jt=0;Jt<Gt.length;Jt++)Bt(Gt[Jt],Be,we,bt);P(ze.anchor,Be,we);return}if(xt===Gm){Vt(ze,Be,we);return}if(bt!==2&&Nt&1&&Ut)if(bt===0)Ut.beforeEnter(St),P(St,Be,we),Gs(()=>Ut.enter(St),Tt);else{const{leave:Jt,delayLeave:Dt,afterLeave:yi}=Ut,Ji=()=>P(St,Be,we),gr=()=>{Jt(St,()=>{Ji(),yi&&yi()})};Dt?Dt(St,Ji,gr):gr()}else P(St,Be,we)},gi=(ze,Be,we,bt=!1,Tt=!1)=>{const{type:St,props:xt,ref:Ut,children:Gt,dynamicChildren:Nt,shapeFlag:xi,patchFlag:Jt,dirs:Dt,cacheIndex:yi}=ze;if(Jt===-2&&(Tt=!1),Ut!=null&&t_(Ut,null,we,ze,!0),yi!=null&&(Be.renderCache[yi]=void 0),xi&256){Be.ctx.deactivate(ze);return}const Ji=xi&1&&Dt,gr=!Af(ze);let Gi;if(gr&&(Gi=xt&&xt.onVnodeBeforeUnmount)&&Ko(Gi,Be,ze),xi&6)yn(ze.component,we,bt);else{if(xi&128){ze.suspense.unmount(we,bt);return}Ji&&Lc(ze,null,Be,"beforeUnmount"),xi&64?ze.type.remove(ze,Be,we,J,bt):Nt&&!Nt.hasOnce&&(St!==Is||Jt>0&&Jt&64)?fr(Nt,Be,we,!1,!0):(St===Is&&Jt&384||!Tt&&xi&16)&&fr(Gt,Be,we),bt&&Zt(ze)}(gr&&(Gi=xt&&xt.onVnodeUnmounted)||Ji)&&Gs(()=>{Gi&&Ko(Gi,Be,ze),Ji&&Lc(ze,null,Be,"unmounted")},we)},Zt=ze=>{const{type:Be,el:we,anchor:bt,transition:Tt}=ze;if(Be===Is){qr(we,bt);return}if(Be===Gm){pt(ze);return}const St=()=>{k(we),Tt&&!Tt.persisted&&Tt.afterLeave&&Tt.afterLeave()};if(ze.shapeFlag&1&&Tt&&!Tt.persisted){const{leave:xt,delayLeave:Ut}=Tt,Gt=()=>xt(we,St);Ut?Ut(ze.el,St,Gt):Gt()}else St()},qr=(ze,Be)=>{let we;for(;ze!==Be;)we=Ne(ze),k(ze),ze=we;k(Be)},yn=(ze,Be,we)=>{const{bum:bt,scope:Tt,job:St,subTree:xt,um:Ut,m:Gt,a:Nt}=ze;Mb(Gt),Mb(Nt),bt&&Um(bt),Tt.stop(),St&&(St.flags|=8,gi(xt,ze,Be,we)),Ut&&Gs(Ut,Be),Gs(()=>{ze.isUnmounted=!0},Be),Be&&Be.pendingBranch&&!Be.isUnmounted&&ze.asyncDep&&!ze.asyncResolved&&ze.suspenseId===Be.pendingId&&(Be.deps--,Be.deps===0&&Be.resolve())},fr=(ze,Be,we,bt=!1,Tt=!1,St=0)=>{for(let xt=St;xt<ze.length;xt++)gi(ze[xt],Be,we,bt,Tt)},mt=ze=>{if(ze.shapeFlag&6)return mt(ze.component.subTree);if(ze.shapeFlag&128)return ze.suspense.next();const Be=Ne(ze.anchor||ze.el),we=Be&&Be[pA];return we?Ne(we):Be};let Qt=!1;const Kt=(ze,Be,we)=>{ze==null?Be._vnode&&gi(Be._vnode,null,null,!0):et(Be._vnode||null,ze,Be,null,null,null,we),Be._vnode=ze,Qt||(Qt=!0,vb(),t2(),Qt=!1)},J={p:et,um:gi,m:Bt,r:Zt,mt:Fr,mc:di,pc:nr,pbc:st,n:mt,o:f};return{render:Kt,hydrate:void 0,createApp:FA(Kt)}}function Oy({type:f,props:v},I){return I==="svg"&&f==="foreignObject"||I==="mathml"&&f==="annotation-xml"&&v&&v.encoding&&v.encoding.includes("html")?void 0:I}function Oc({effect:f,job:v},I){I?(f.flags|=32,v.flags|=4):(f.flags&=-33,v.flags&=-5)}function ZA(f,v){return(!f||f&&!f.pendingBranch)&&v&&!v.persisted}function b2(f,v,I=!1){const P=f.children,k=v.children;if(Ui(P)&&Ui(k))for(let j=0;j<P.length;j++){const $=P[j];let s=k[j];s.shapeFlag&1&&!s.dynamicChildren&&((s.patchFlag<=0||s.patchFlag===32)&&(s=k[j]=Rl(k[j]),s.el=$.el),!I&&s.patchFlag!==-2&&b2($,s)),s.type===v_&&(s.el=$.el)}}function WA(f){const v=f.slice(),I=[0];let P,k,j,$,s;const Q=f.length;for(P=0;P<Q;P++){const de=f[P];if(de!==0){if(k=I[I.length-1],f[k]<de){v[P]=k,I.push(P);continue}for(j=0,$=I.length-1;j<$;)s=j+$>>1,f[I[s]]<de?j=s+1:$=s;de<f[I[j]]&&(j>0&&(v[P]=I[j-1]),I[j]=P)}}for(j=I.length,$=I[j-1];j-- >0;)I[j]=$,$=v[$];return I}function w2(f){const v=f.subTree.component;if(v)return v.asyncDep&&!v.asyncResolved?v:w2(v)}function Mb(f){if(f)for(let v=0;v<f.length;v++)f[v].flags|=8}const XA=Symbol.for("v-scx"),KA=()=>ro(XA);function dh(f,v,I){return T2(f,v,I)}function T2(f,v,I=Gr){const{immediate:P,deep:k,flush:j,once:$}=I,s=rs({},I),Q=v&&P||!v&&j!=="post";let de;if(Bf){if(j==="sync"){const Re=KA();de=Re.__watcherHandles||(Re.__watcherHandles=[])}else if(!Q){const Re=()=>{};return Re.stop=ea,Re.resume=ea,Re.pause=ea,Re}}const ae=$n;s.call=(Re,Ze,et)=>ia(Re,ae,Ze,et);let Te=!1;j==="post"?s.scheduler=Re=>{Gs(Re,ae&&ae.suspense)}:j!=="sync"&&(Te=!0,s.scheduler=(Re,Ze)=>{Ze?Re():Ev(Re)}),s.augmentJob=Re=>{v&&(Re.flags|=4),Te&&(Re.flags|=2,ae&&(Re.id=ae.uid,Re.i=ae))};const Ne=uA(f,v,s);return Bf&&(de?de.push(Ne):Q&&Ne()),Ne}function YA(f,v,I){const P=this.proxy,k=Sn(f)?f.includes(".")?S2(P,f):()=>P[f]:f.bind(P,P);let j;sr(v)?j=v:(j=v.handler,I=v);const $=Hf(this),s=T2(k,j.bind(P),I);return $(),s}function S2(f,v){const I=v.split(".");return()=>{let P=f;for(let k=0;k<I.length&&P;k++)P=P[I[k]];return P}}const JA=(f,v)=>v==="modelValue"||v==="model-value"?f.modelModifiers:f[`${v}Modifiers`]||f[`${no(v)}Modifiers`]||f[`${$c(v)}Modifiers`];function QA(f,v,...I){if(f.isUnmounted)return;const P=f.vnode.props||Gr;let k=I;const j=v.startsWith("update:"),$=j&&JA(P,v.slice(7));$&&($.trim&&(k=I.map(ae=>Sn(ae)?ae.trim():ae)),$.number&&(k=I.map(Km)));let s,Q=P[s=Cy(v)]||P[s=Cy(no(v))];!Q&&j&&(Q=P[s=Cy($c(v))]),Q&&ia(Q,f,6,k);const de=P[s+"Once"];if(de){if(!f.emitted)f.emitted={};else if(f.emitted[s])return;f.emitted[s]=!0,ia(de,f,6,k)}}function E2(f,v,I=!1){const P=v.emitsCache,k=P.get(f);if(k!==void 0)return k;const j=f.emits;let $={},s=!1;if(!sr(f)){const Q=de=>{const ae=E2(de,v,!0);ae&&(s=!0,rs($,ae))};!I&&v.mixins.length&&v.mixins.forEach(Q),f.extends&&Q(f.extends),f.mixins&&f.mixins.forEach(Q)}return!j&&!s?(Xr(f)&&P.set(f,null),null):(Ui(j)?j.forEach(Q=>$[Q]=null):rs($,j),Xr(f)&&P.set(f,$),$)}function y_(f,v){return!f||!c_(v)?!1:(v=v.slice(2).replace(/Once$/,""),Lr(f,v[0].toLowerCase()+v.slice(1))||Lr(f,$c(v))||Lr(f,v))}function Ab(f){const{type:v,vnode:I,proxy:P,withProxy:k,propsOptions:[j],slots:$,attrs:s,emit:Q,render:de,renderCache:ae,props:Te,data:Ne,setupState:Re,ctx:Ze,inheritAttrs:et}=f,ft=e_(f);let vt,gt;try{if(I.shapeFlag&4){const pt=k||P,ui=pt;vt=Qo(de.call(ui,pt,ae,Te,Re,Ne,Ze)),gt=s}else{const pt=v;vt=Qo(pt.length>1?pt(Te,{attrs:s,slots:$,emit:Q}):pt(Te,null)),gt=v.props?s:eI(s)}}catch(pt){Cf.length=0,__(pt,f,1),vt=en(Gc)}let Vt=vt;if(gt&&et!==!1){const pt=Object.keys(gt),{shapeFlag:ui}=Vt;pt.length&&ui&7&&(j&&pt.some(fv)&&(gt=tI(gt,j)),Vt=mh(Vt,gt,!1,!0))}return I.dirs&&(Vt=mh(Vt,null,!1,!0),Vt.dirs=Vt.dirs?Vt.dirs.concat(I.dirs):I.dirs),I.transition&&Mv(Vt,I.transition),vt=Vt,e_(ft),vt}const eI=f=>{let v;for(const I in f)(I==="class"||I==="style"||c_(I))&&((v||(v={}))[I]=f[I]);return v},tI=(f,v)=>{const I={};for(const P in f)(!fv(P)||!(P.slice(9)in v))&&(I[P]=f[P]);return I};function iI(f,v,I){const{props:P,children:k,component:j}=f,{props:$,children:s,patchFlag:Q}=v,de=j.emitsOptions;if(v.dirs||v.transition)return!0;if(I&&Q>=0){if(Q&1024)return!0;if(Q&16)return P?Ib(P,$,de):!!$;if(Q&8){const ae=v.dynamicProps;for(let Te=0;Te<ae.length;Te++){const Ne=ae[Te];if($[Ne]!==P[Ne]&&!y_(de,Ne))return!0}}}else return(k||s)&&(!s||!s.$stable)?!0:P===$?!1:P?$?Ib(P,$,de):!0:!!$;return!1}function Ib(f,v,I){const P=Object.keys(v);if(P.length!==Object.keys(f).length)return!0;for(let k=0;k<P.length;k++){const j=P[k];if(v[j]!==f[j]&&!y_(I,j))return!0}return!1}function rI({vnode:f,parent:v},I){for(;v;){const P=v.subTree;if(P.suspense&&P.suspense.activeBranch===f&&(P.el=f.el),P===f)(f=v.vnode).el=I,v=v.parent;else break}}const M2=f=>f.__isSuspense;function nI(f,v){v&&v.pendingBranch?Ui(f)?v.effects.push(...f):v.effects.push(f):fA(f)}const Is=Symbol.for("v-fgt"),v_=Symbol.for("v-txt"),Gc=Symbol.for("v-cmt"),Gm=Symbol.for("v-stc"),Cf=[];let qs=null;function ki(f=!1){Cf.push(qs=f?null:[])}function sI(){Cf.pop(),qs=Cf[Cf.length-1]||null}let Ff=1;function Cb(f,v=!1){Ff+=f,f<0&&qs&&v&&(qs.hasOnce=!0)}function A2(f){return f.dynamicChildren=Ff>0?qs||ch:null,sI(),Ff>0&&qs&&qs.push(f),f}function Vi(f,v,I,P,k,j){return A2(Pe(f,v,I,P,k,j,!0))}function oI(f,v,I,P,k){return A2(en(f,v,I,P,k,!0))}function r_(f){return f?f.__v_isVNode===!0:!1}function xf(f,v){return f.type===v.type&&f.key===v.key}const I2=({key:f})=>f??null,qm=({ref:f,ref_key:v,ref_for:I})=>(typeof f=="number"&&(f=""+f),f!=null?Sn(f)||_n(f)||sr(f)?{i:Rs,r:f,k:v,f:!!I}:f:null);function Pe(f,v=null,I=null,P=0,k=null,j=f===Is?0:1,$=!1,s=!1){const Q={__v_isVNode:!0,__v_skip:!0,type:f,props:v,key:v&&I2(v),ref:v&&qm(v),scopeId:r2,slotScopeIds:null,children:I,component:null,suspense:null,ssContent:null,ssFallback:null,dirs:null,transition:null,el:null,anchor:null,target:null,targetStart:null,targetAnchor:null,staticCount:0,shapeFlag:j,patchFlag:P,dynamicProps:k,dynamicChildren:null,appContext:null,ctx:Rs};return s?(Iv(Q,I),j&128&&f.normalize(Q)):I&&(Q.shapeFlag|=Sn(I)?8:16),Ff>0&&!$&&qs&&(Q.patchFlag>0||j&6)&&Q.patchFlag!==32&&qs.push(Q),Q}const en=aI;function aI(f,v=null,I=null,P=0,k=null,j=!1){if((!f||f===IA)&&(f=Gc),r_(f)){const s=mh(f,v,!0);return I&&Iv(s,I),Ff>0&&!j&&qs&&(s.shapeFlag&6?qs[qs.indexOf(f)]=s:qs.push(s)),s.patchFlag=-2,s}if(vI(f)&&(f=f.__vccOpts),v){v=lI(v);let{class:s,style:Q}=v;s&&!Sn(s)&&(v.class=vh(s)),Xr(Q)&&(Tv(Q)&&!Ui(Q)&&(Q=rs({},Q)),v.style=_v(Q))}const $=Sn(f)?1:M2(f)?128:mA(f)?64:Xr(f)?4:sr(f)?2:0;return Pe(f,v,I,P,k,$,j,!0)}function lI(f){return f?Tv(f)||p2(f)?rs({},f):f:null}function mh(f,v,I=!1,P=!1){const{props:k,ref:j,patchFlag:$,children:s,transition:Q}=f,de=v?uI(k||{},v):k,ae={__v_isVNode:!0,__v_skip:!0,type:f.type,props:de,key:de&&I2(de),ref:v&&v.ref?I&&j?Ui(j)?j.concat(qm(v)):[j,qm(v)]:qm(v):j,scopeId:f.scopeId,slotScopeIds:f.slotScopeIds,children:s,target:f.target,targetStart:f.targetStart,targetAnchor:f.targetAnchor,staticCount:f.staticCount,shapeFlag:f.shapeFlag,patchFlag:v&&f.type!==Is?$===-1?16:$|16:$,dynamicProps:f.dynamicProps,dynamicChildren:f.dynamicChildren,appContext:f.appContext,dirs:f.dirs,transition:Q,component:f.component,suspense:f.suspense,ssContent:f.ssContent&&mh(f.ssContent),ssFallback:f.ssFallback&&mh(f.ssFallback),el:f.el,anchor:f.anchor,ctx:f.ctx,ce:f.ce};return Q&&P&&Mv(ae,Q.clone(ae)),ae}function ra(f=" ",v=0){return en(v_,null,f,v)}function cI(f,v){const I=en(Gm,null,f);return I.staticCount=v,I}function Cs(f="",v=!1){return v?(ki(),oI(Gc,null,f)):en(Gc,null,f)}function Qo(f){return f==null||typeof f=="boolean"?en(Gc):Ui(f)?en(Is,null,f.slice()):r_(f)?Rl(f):en(v_,null,String(f))}function Rl(f){return f.el===null&&f.patchFlag!==-1||f.memo?f:mh(f)}function Iv(f,v){let I=0;const{shapeFlag:P}=f;if(v==null)v=null;else if(Ui(v))I=16;else if(typeof v=="object")if(P&65){const k=v.default;k&&(k._c&&(k._d=!1),Iv(f,k()),k._c&&(k._d=!0));return}else{I=32;const k=v._;!k&&!p2(v)?v._ctx=Rs:k===3&&Rs&&(Rs.slots._===1?v._=1:(v._=2,f.patchFlag|=1024))}else sr(v)?(v={default:v,_ctx:Rs},I=32):(v=String(v),P&64?(I=16,v=[ra(v)]):I=8);f.children=v,f.shapeFlag|=I}function uI(...f){const v={};for(let I=0;I<f.length;I++){const P=f[I];for(const k in P)if(k==="class")v.class!==P.class&&(v.class=vh([v.class,P.class]));else if(k==="style")v.style=_v([v.style,P.style]);else if(c_(k)){const j=v[k],$=P[k];$&&j!==$&&!(Ui(j)&&j.includes($))&&(v[k]=j?[].concat(j,$):$)}else k!==""&&(v[k]=P[k])}return v}function Ko(f,v,I,P=null){ia(f,v,7,[I,P])}const hI=h2();let dI=0;function fI(f,v,I){const P=f.type,k=(v?v.appContext:f.appContext)||hI,j={uid:dI++,vnode:f,type:P,parent:v,appContext:k,root:null,next:null,subTree:null,effect:null,update:null,job:null,scope:new Dw(!0),render:null,proxy:null,exposed:null,exposeProxy:null,withProxy:null,provides:v?v.provides:Object.create(k.provides),ids:v?v.ids:["",0,0],accessCache:null,renderCache:[],components:null,directives:null,propsOptions:_2(P,k),emitsOptions:E2(P,k),emit:null,emitted:null,propsDefaults:Gr,inheritAttrs:P.inheritAttrs,ctx:Gr,data:Gr,props:Gr,attrs:Gr,slots:Gr,refs:Gr,setupState:Gr,setupContext:null,suspense:I,suspenseId:I?I.pendingId:0,asyncDep:null,asyncResolved:!1,isMounted:!1,isUnmounted:!1,isDeactivated:!1,bc:null,c:null,bm:null,m:null,bu:null,u:null,um:null,bum:null,da:null,a:null,rtg:null,rtc:null,ec:null,sp:null};return j.ctx={_:j},j.root=v?v.root:j,j.emit=QA.bind(null,j),f.ce&&f.ce(j),j}let $n=null,n_,Qy;{const f=f_(),v=(I,P)=>{let k;return(k=f[I])||(k=f[I]=[]),k.push(P),j=>{k.length>1?k.forEach($=>$(j)):k[0](j)}};n_=v("__VUE_INSTANCE_SETTERS__",I=>$n=I),Qy=v("__VUE_SSR_SETTERS__",I=>Bf=I)}const Hf=f=>{const v=$n;return n_(f),f.scope.on(),()=>{f.scope.off(),n_(v)}},Pb=()=>{$n&&$n.scope.off(),n_(null)};function C2(f){return f.vnode.shapeFlag&4}let Bf=!1;function pI(f,v=!1,I=!1){v&&Qy(v);const{props:P,children:k}=f.vnode,j=C2(f);NA(f,P,j,v),GA(f,k,I);const $=j?mI(f,v):void 0;return v&&Qy(!1),$}function mI(f,v){const I=f.type;f.accessCache=Object.create(null),f.proxy=new Proxy(f.ctx,PA);const{setup:P}=I;if(P){kl();const k=f.setupContext=P.length>1?gI(f):null,j=Hf(f),$=qf(P,f,0,[f.props,k]),s=Ew($);if(Fl(),j(),(s||f.sp)&&!Af(f)&&s2(f),s){if($.then(Pb,Pb),v)return $.then(Q=>{Rb(f,Q)}).catch(Q=>{__(Q,f,0)});f.asyncDep=$}else Rb(f,$)}else P2(f)}function Rb(f,v,I){sr(v)?f.type.__ssrInlineRender?f.ssrRender=v:f.render=v:Xr(v)&&(f.setupState=Jw(v)),P2(f)}function P2(f,v,I){const P=f.type;f.render||(f.render=P.render||ea);{const k=Hf(f);kl();try{RA(f)}finally{Fl(),k()}}}const _I={get(f,v){return es(f,"get",""),f[v]}};function gI(f){const v=I=>{f.exposed=I||{}};return{attrs:new Proxy(f.attrs,_I),slots:f.slots,emit:f.emit,expose:v}}function x_(f){return f.exposed?f.exposeProxy||(f.exposeProxy=new Proxy(Jw(Sv(f.exposed)),{get(v,I){if(I in v)return v[I];if(I in If)return If[I](f)},has(v,I){return I in v||I in If}})):f.proxy}function yI(f,v=!0){return sr(f)?f.displayName||f.name:f.name||v&&f.__name}function vI(f){return sr(f)&&"__vccOpts"in f}const Ps=(f,v)=>lA(f,v,Bf);function R2(f,v,I){const P=arguments.length;return P===2?Xr(v)&&!Ui(v)?r_(v)?en(f,null,[v]):en(f,v):en(f,null,v):(P>3?I=Array.prototype.slice.call(arguments,2):P===3&&r_(I)&&(I=[I]),en(f,v,I))}const xI="3.5.13";/**
* @vue/runtime-dom v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/let ev;const Db=typeof window<"u"&&window.trustedTypes;if(Db)try{ev=Db.createPolicy("vue",{createHTML:f=>f})}catch{}const D2=ev?f=>ev.createHTML(f):f=>f,bI="http://www.w3.org/2000/svg",wI="http://www.w3.org/1998/Math/MathML",Sa=typeof document<"u"?document:null,zb=Sa&&Sa.createElement("template"),TI={insert:(f,v,I)=>{v.insertBefore(f,I||null)},remove:f=>{const v=f.parentNode;v&&v.removeChild(f)},createElement:(f,v,I,P)=>{const k=v==="svg"?Sa.createElementNS(bI,f):v==="mathml"?Sa.createElementNS(wI,f):I?Sa.createElement(f,{is:I}):Sa.createElement(f);return f==="select"&&P&&P.multiple!=null&&k.setAttribute("multiple",P.multiple),k},createText:f=>Sa.createTextNode(f),createComment:f=>Sa.createComment(f),setText:(f,v)=>{f.nodeValue=v},setElementText:(f,v)=>{f.textContent=v},parentNode:f=>f.parentNode,nextSibling:f=>f.nextSibling,querySelector:f=>Sa.querySelector(f),setScopeId(f,v){f.setAttribute(v,"")},insertStaticContent(f,v,I,P,k,j){const $=I?I.previousSibling:v.lastChild;if(k&&(k===j||k.nextSibling))for(;v.insertBefore(k.cloneNode(!0),I),!(k===j||!(k=k.nextSibling)););else{zb.innerHTML=D2(P==="svg"?`<svg>${f}</svg>`:P==="mathml"?`<math>${f}</math>`:f);const s=zb.content;if(P==="svg"||P==="mathml"){const Q=s.firstChild;for(;Q.firstChild;)s.appendChild(Q.firstChild);s.removeChild(Q)}v.insertBefore(s,I)}return[$?$.nextSibling:v.firstChild,I?I.previousSibling:v.lastChild]}},SI=Symbol("_vtc");function EI(f,v,I){const P=f[SI];P&&(v=(v?[v,...P]:[...P]).join(" ")),v==null?f.removeAttribute("class"):I?f.setAttribute("class",v):f.className=v}const Lb=Symbol("_vod"),MI=Symbol("_vsh"),AI=Symbol(""),II=/(^|;)\s*display\s*:/;function CI(f,v,I){const P=f.style,k=Sn(I);let j=!1;if(I&&!k){if(v)if(Sn(v))for(const $ of v.split(";")){const s=$.slice(0,$.indexOf(":")).trim();I[s]==null&&$m(P,s,"")}else for(const $ in v)I[$]==null&&$m(P,$,"");for(const $ in I)$==="display"&&(j=!0),$m(P,$,I[$])}else if(k){if(v!==I){const $=P[AI];$&&(I+=";"+$),P.cssText=I,j=II.test(I)}}else v&&f.removeAttribute("style");Lb in f&&(f[Lb]=j?P.display:"",f[MI]&&(P.display="none"))}const Ob=/\s*!important$/;function $m(f,v,I){if(Ui(I))I.forEach(P=>$m(f,v,P));else if(I==null&&(I=""),v.startsWith("--"))f.setProperty(v,I);else{const P=PI(f,v);Ob.test(I)?f.setProperty($c(P),I.replace(Ob,""),"important"):f[P]=I}}const kb=["Webkit","Moz","ms"],ky={};function PI(f,v){const I=ky[v];if(I)return I;let P=no(v);if(P!=="filter"&&P in f)return ky[v]=P;P=d_(P);for(let k=0;k<kb.length;k++){const j=kb[k]+P;if(j in f)return ky[v]=j}return v}const Fb="http://www.w3.org/1999/xlink";function Bb(f,v,I,P,k,j=DM(v)){P&&v.startsWith("xlink:")?I==null?f.removeAttributeNS(Fb,v.slice(6,v.length)):f.setAttributeNS(Fb,v,I):I==null||j&&!Cw(I)?f.removeAttribute(v):f.setAttribute(v,j?"":ta(I)?String(I):I)}function Nb(f,v,I,P,k){if(v==="innerHTML"||v==="textContent"){I!=null&&(f[v]=v==="innerHTML"?D2(I):I);return}const j=f.tagName;if(v==="value"&&j!=="PROGRESS"&&!j.includes("-")){const s=j==="OPTION"?f.getAttribute("value")||"":f.value,Q=I==null?f.type==="checkbox"?"on":"":String(I);(s!==Q||!("_value"in f))&&(f.value=Q),I==null&&f.removeAttribute(v),f._value=I;return}let $=!1;if(I===""||I==null){const s=typeof f[v];s==="boolean"?I=Cw(I):I==null&&s==="string"?(I="",$=!0):s==="number"&&(I=0,$=!0)}try{f[v]=I}catch{}$&&f.removeAttribute(k||v)}function Fc(f,v,I,P){f.addEventListener(v,I,P)}function RI(f,v,I,P){f.removeEventListener(v,I,P)}const Vb=Symbol("_vei");function DI(f,v,I,P,k=null){const j=f[Vb]||(f[Vb]={}),$=j[v];if(P&&$)$.value=P;else{const[s,Q]=zI(v);if(P){const de=j[v]=kI(P,k);Fc(f,s,de,Q)}else $&&(RI(f,s,$,Q),j[v]=void 0)}}const Ub=/(?:Once|Passive|Capture)$/;function zI(f){let v;if(Ub.test(f)){v={};let P;for(;P=f.match(Ub);)f=f.slice(0,f.length-P[0].length),v[P[0].toLowerCase()]=!0}return[f[2]===":"?f.slice(3):$c(f.slice(2)),v]}let Fy=0;const LI=Promise.resolve(),OI=()=>Fy||(LI.then(()=>Fy=0),Fy=Date.now());function kI(f,v){const I=P=>{if(!P._vts)P._vts=Date.now();else if(P._vts<=I.attached)return;ia(FI(P,I.value),v,5,[P])};return I.value=f,I.attached=OI(),I}function FI(f,v){if(Ui(v)){const I=f.stopImmediatePropagation;return f.stopImmediatePropagation=()=>{I.call(f),f._stopped=!0},v.map(P=>k=>!k._stopped&&P&&P(k))}else return v}const jb=f=>f.charCodeAt(0)===111&&f.charCodeAt(1)===110&&f.charCodeAt(2)>96&&f.charCodeAt(2)<123,BI=(f,v,I,P,k,j)=>{const $=k==="svg";v==="class"?EI(f,P,$):v==="style"?CI(f,I,P):c_(v)?fv(v)||DI(f,v,I,P,j):(v[0]==="."?(v=v.slice(1),!0):v[0]==="^"?(v=v.slice(1),!1):NI(f,v,P,$))?(Nb(f,v,P),!f.tagName.includes("-")&&(v==="value"||v==="checked"||v==="selected")&&Bb(f,v,P,$,j,v!=="value")):f._isVueCE&&(/[A-Z]/.test(v)||!Sn(P))?Nb(f,no(v),P,j,v):(v==="true-value"?f._trueValue=P:v==="false-value"&&(f._falseValue=P),Bb(f,v,P,$))};function NI(f,v,I,P){if(P)return!!(v==="innerHTML"||v==="textContent"||v in f&&jb(v)&&sr(I));if(v==="spellcheck"||v==="draggable"||v==="translate"||v==="form"||v==="list"&&f.tagName==="INPUT"||v==="type"&&f.tagName==="TEXTAREA")return!1;if(v==="width"||v==="height"){const k=f.tagName;if(k==="IMG"||k==="VIDEO"||k==="CANVAS"||k==="SOURCE")return!1}return jb(v)&&Sn(I)?!1:v in f}const s_=f=>{const v=f.props["onUpdate:modelValue"]||!1;return Ui(v)?I=>Um(v,I):v};function VI(f){f.target.composing=!0}function Gb(f){const v=f.target;v.composing&&(v.composing=!1,v.dispatchEvent(new Event("input")))}const fh=Symbol("_assign"),Bn={created(f,{modifiers:{lazy:v,trim:I,number:P}},k){f[fh]=s_(k);const j=P||k.props&&k.props.type==="number";Fc(f,v?"change":"input",$=>{if($.target.composing)return;let s=f.value;I&&(s=s.trim()),j&&(s=Km(s)),f[fh](s)}),I&&Fc(f,"change",()=>{f.value=f.value.trim()}),v||(Fc(f,"compositionstart",VI),Fc(f,"compositionend",Gb),Fc(f,"change",Gb))},mounted(f,{value:v}){f.value=v??""},beforeUpdate(f,{value:v,oldValue:I,modifiers:{lazy:P,trim:k,number:j}},$){if(f[fh]=s_($),f.composing)return;const s=(j||f.type==="number")&&!/^0\d/.test(f.value)?Km(f.value):f.value,Q=v??"";s!==Q&&(document.activeElement===f&&f.type!=="range"&&(P&&v===I||k&&f.value.trim()===Q)||(f.value=Q))}},UI={deep:!0,created(f,{value:v,modifiers:{number:I}},P){const k=u_(v);Fc(f,"change",()=>{const j=Array.prototype.filter.call(f.options,$=>$.selected).map($=>I?Km(o_($)):o_($));f[fh](f.multiple?k?new Set(j):j:j[0]),f._assigning=!0,$f(()=>{f._assigning=!1})}),f[fh]=s_(P)},mounted(f,{value:v}){qb(f,v)},beforeUpdate(f,v,I){f[fh]=s_(I)},updated(f,{value:v}){f._assigning||qb(f,v)}};function qb(f,v){const I=f.multiple,P=Ui(v);if(!(I&&!P&&!u_(v))){for(let k=0,j=f.options.length;k<j;k++){const $=f.options[k],s=o_($);if(I)if(P){const Q=typeof s;Q==="string"||Q==="number"?$.selected=v.some(de=>String(de)===String(s)):$.selected=LM(v,s)>-1}else $.selected=v.has(s);else if(p_(o_($),v)){f.selectedIndex!==k&&(f.selectedIndex=k);return}}!I&&f.selectedIndex!==-1&&(f.selectedIndex=-1)}}function o_(f){return"_value"in f?f._value:f.value}const jI=["ctrl","shift","alt","meta"],GI={stop:f=>f.stopPropagation(),prevent:f=>f.preventDefault(),self:f=>f.target!==f.currentTarget,ctrl:f=>!f.ctrlKey,shift:f=>!f.shiftKey,alt:f=>!f.altKey,meta:f=>!f.metaKey,left:f=>"button"in f&&f.button!==0,middle:f=>"button"in f&&f.button!==1,right:f=>"button"in f&&f.button!==2,exact:(f,v)=>jI.some(I=>f[`${I}Key`]&&!v.includes(I))},_h=(f,v)=>{const I=f._withMods||(f._withMods={}),P=v.join(".");return I[P]||(I[P]=(k,...j)=>{for(let $=0;$<v.length;$++){const s=GI[v[$]];if(s&&s(k,v))return}return f(k,...j)})},qI=rs({patchProp:BI},TI);let $b;function $I(){return $b||($b=$A(qI))}const HI=(...f)=>{const v=$I().createApp(...f),{mount:I}=v;return v.mount=P=>{const k=WI(P);if(!k)return;const j=v._component;!sr(j)&&!j.render&&!j.template&&(j.template=k.innerHTML),k.nodeType===1&&(k.textContent="");const $=I(k,!1,ZI(k));return k instanceof Element&&(k.removeAttribute("v-cloak"),k.setAttribute("data-v-app","")),$},v};function ZI(f){if(f instanceof SVGElement)return"svg";if(typeof MathMLElement=="function"&&f instanceof MathMLElement)return"mathml"}function WI(f){return Sn(f)?document.querySelector(f):f}/*!
 * pinia v3.0.2
 * (c) 2025 Eduardo San Martin Morote
 * @license MIT
 */let z2;const b_=f=>z2=f,L2=Symbol();function tv(f){return f&&typeof f=="object"&&Object.prototype.toString.call(f)==="[object Object]"&&typeof f.toJSON!="function"}var Pf;(function(f){f.direct="direct",f.patchObject="patch object",f.patchFunction="patch function"})(Pf||(Pf={}));function O2(){const f=zw(!0),v=f.run(()=>Oi({}));let I=[],P=[];const k=Sv({install(j){b_(k),k._a=j,j.provide(L2,k),j.config.globalProperties.$pinia=k,P.forEach($=>I.push($)),P=[]},use(j){return this._a?I.push(j):P.push(j),this},_p:I,_a:null,_e:f,_s:new Map,state:v});return k}const k2=()=>{};function Hb(f,v,I,P=k2){f.push(v);const k=()=>{const j=f.indexOf(v);j>-1&&(f.splice(j,1),P())};return!I&&Lw()&&OM(k),k}function oh(f,...v){f.slice().forEach(I=>{I(...v)})}const XI=f=>f(),Zb=Symbol(),By=Symbol();function iv(f,v){f instanceof Map&&v instanceof Map?v.forEach((I,P)=>f.set(P,I)):f instanceof Set&&v instanceof Set&&v.forEach(f.add,f);for(const I in v){if(!v.hasOwnProperty(I))continue;const P=v[I],k=f[I];tv(k)&&tv(P)&&f.hasOwnProperty(I)&&!_n(P)&&!Ll(P)?f[I]=iv(k,P):f[I]=P}return f}const KI=Symbol();function YI(f){return!tv(f)||!Object.prototype.hasOwnProperty.call(f,KI)}const{assign:Cl}=Object;function JI(f){return!!(_n(f)&&f.effect)}function QI(f,v,I,P){const{state:k,actions:j,getters:$}=v,s=I.state.value[f];let Q;function de(){s||(I.state.value[f]=k?k():{});const ae=nA(I.state.value[f]);return Cl(ae,j,Object.keys($||{}).reduce((Te,Ne)=>(Te[Ne]=Sv(Ps(()=>{b_(I);const Re=I._s.get(f);return $[Ne].call(Re,Re)})),Te),{}))}return Q=F2(f,de,v,I,P,!0),Q}function F2(f,v,I={},P,k,j){let $;const s=Cl({actions:{}},I),Q={deep:!0};let de,ae,Te=[],Ne=[],Re;const Ze=P.state.value[f];!j&&!Ze&&(P.state.value[f]={}),Oi({});let et;function ft(di){let jt;de=ae=!1,typeof di=="function"?(di(P.state.value[f]),jt={type:Pf.patchFunction,storeId:f,events:Re}):(iv(P.state.value[f],di),jt={type:Pf.patchObject,payload:di,storeId:f,events:Re});const st=et=Symbol();$f().then(()=>{et===st&&(de=!0)}),ae=!0,oh(Te,jt,P.state.value[f])}const vt=j?function(){const{state:jt}=I,st=jt?jt():{};this.$patch(zt=>{Cl(zt,st)})}:k2;function gt(){$.stop(),Te=[],Ne=[],P._s.delete(f)}const Vt=(di,jt="")=>{if(Zb in di)return di[By]=jt,di;const st=function(){b_(P);const zt=Array.from(arguments),ji=[],Ci=[];function Fr(bi){ji.push(bi)}function oi(bi){Ci.push(bi)}oh(Ne,{args:zt,name:st[By],store:ui,after:Fr,onError:oi});let Yi;try{Yi=di.apply(this&&this.$id===f?this:ui,zt)}catch(bi){throw oh(Ci,bi),bi}return Yi instanceof Promise?Yi.then(bi=>(oh(ji,bi),bi)).catch(bi=>(oh(Ci,bi),Promise.reject(bi))):(oh(ji,Yi),Yi)};return st[Zb]=!0,st[By]=jt,st},pt={_p:P,$id:f,$onAction:Hb.bind(null,Ne),$patch:ft,$reset:vt,$subscribe(di,jt={}){const st=Hb(Te,di,jt.detached,()=>zt()),zt=$.run(()=>dh(()=>P.state.value[f],ji=>{(jt.flush==="sync"?ae:de)&&di({storeId:f,type:Pf.direct,events:Re},ji)},Cl({},Q,jt)));return st},$dispose:gt},ui=Gf(pt);P._s.set(f,ui);const Pt=(P._a&&P._a.runWithContext||XI)(()=>P._e.run(()=>($=zw()).run(()=>v({action:Vt}))));for(const di in Pt){const jt=Pt[di];if(_n(jt)&&!JI(jt)||Ll(jt))j||(Ze&&YI(jt)&&(_n(jt)?jt.value=Ze[di]:iv(jt,Ze[di])),P.state.value[f][di]=jt);else if(typeof jt=="function"){const st=Vt(jt,di);Pt[di]=st,s.actions[di]=jt}}return Cl(ui,Pt),Cl(Ir(ui),Pt),Object.defineProperty(ui,"$state",{get:()=>P.state.value[f],set:di=>{ft(jt=>{Cl(jt,di)})}}),P._p.forEach(di=>{Cl(ui,$.run(()=>di({store:ui,app:P._a,pinia:P,options:s})))}),Ze&&j&&I.hydrate&&I.hydrate(ui.$state,Ze),de=!0,ae=!0,ui}/*! #__NO_SIDE_EFFECTS__ */function eC(f,v,I){let P;const k=typeof v=="function";P=k?I:v;function j($,s){const Q=BA();return $=$||(Q?ro(L2,null):null),$&&b_($),$=z2,$._s.has(f)||(k?F2(f,v,P,$):QI(f,P,$)),$._s.get(f)}return j.$id=f,j}function B2(f,v){return function(){return f.apply(v,arguments)}}const{toString:tC}=Object.prototype,{getPrototypeOf:Cv}=Object,w_=(f=>v=>{const I=tC.call(v);return f[I]||(f[I]=I.slice(8,-1).toLowerCase())})(Object.create(null)),Do=f=>(f=f.toLowerCase(),v=>w_(v)===f),T_=f=>v=>typeof v===f,{isArray:bh}=Array,Nf=T_("undefined");function iC(f){return f!==null&&!Nf(f)&&f.constructor!==null&&!Nf(f.constructor)&&$s(f.constructor.isBuffer)&&f.constructor.isBuffer(f)}const N2=Do("ArrayBuffer");function rC(f){let v;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?v=ArrayBuffer.isView(f):v=f&&f.buffer&&N2(f.buffer),v}const nC=T_("string"),$s=T_("function"),V2=T_("number"),S_=f=>f!==null&&typeof f=="object",sC=f=>f===!0||f===!1,Hm=f=>{if(w_(f)!=="object")return!1;const v=Cv(f);return(v===null||v===Object.prototype||Object.getPrototypeOf(v)===null)&&!(Symbol.toStringTag in f)&&!(Symbol.iterator in f)},oC=Do("Date"),aC=Do("File"),lC=Do("Blob"),cC=Do("FileList"),uC=f=>S_(f)&&$s(f.pipe),hC=f=>{let v;return f&&(typeof FormData=="function"&&f instanceof FormData||$s(f.append)&&((v=w_(f))==="formdata"||v==="object"&&$s(f.toString)&&f.toString()==="[object FormData]"))},dC=Do("URLSearchParams"),[fC,pC,mC,_C]=["ReadableStream","Request","Response","Headers"].map(Do),gC=f=>f.trim?f.trim():f.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function Zf(f,v,{allOwnKeys:I=!1}={}){if(f===null||typeof f>"u")return;let P,k;if(typeof f!="object"&&(f=[f]),bh(f))for(P=0,k=f.length;P<k;P++)v.call(null,f[P],P,f);else{const j=I?Object.getOwnPropertyNames(f):Object.keys(f),$=j.length;let s;for(P=0;P<$;P++)s=j[P],v.call(null,f[s],s,f)}}function U2(f,v){v=v.toLowerCase();const I=Object.keys(f);let P=I.length,k;for(;P-- >0;)if(k=I[P],v===k.toLowerCase())return k;return null}const Bc=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,j2=f=>!Nf(f)&&f!==Bc;function rv(){const{caseless:f}=j2(this)&&this||{},v={},I=(P,k)=>{const j=f&&U2(v,k)||k;Hm(v[j])&&Hm(P)?v[j]=rv(v[j],P):Hm(P)?v[j]=rv({},P):bh(P)?v[j]=P.slice():v[j]=P};for(let P=0,k=arguments.length;P<k;P++)arguments[P]&&Zf(arguments[P],I);return v}const yC=(f,v,I,{allOwnKeys:P}={})=>(Zf(v,(k,j)=>{I&&$s(k)?f[j]=B2(k,I):f[j]=k},{allOwnKeys:P}),f),vC=f=>(f.charCodeAt(0)===65279&&(f=f.slice(1)),f),xC=(f,v,I,P)=>{f.prototype=Object.create(v.prototype,P),f.prototype.constructor=f,Object.defineProperty(f,"super",{value:v.prototype}),I&&Object.assign(f.prototype,I)},bC=(f,v,I,P)=>{let k,j,$;const s={};if(v=v||{},f==null)return v;do{for(k=Object.getOwnPropertyNames(f),j=k.length;j-- >0;)$=k[j],(!P||P($,f,v))&&!s[$]&&(v[$]=f[$],s[$]=!0);f=I!==!1&&Cv(f)}while(f&&(!I||I(f,v))&&f!==Object.prototype);return v},wC=(f,v,I)=>{f=String(f),(I===void 0||I>f.length)&&(I=f.length),I-=v.length;const P=f.indexOf(v,I);return P!==-1&&P===I},TC=f=>{if(!f)return null;if(bh(f))return f;let v=f.length;if(!V2(v))return null;const I=new Array(v);for(;v-- >0;)I[v]=f[v];return I},SC=(f=>v=>f&&v instanceof f)(typeof Uint8Array<"u"&&Cv(Uint8Array)),EC=(f,v)=>{const P=(f&&f[Symbol.iterator]).call(f);let k;for(;(k=P.next())&&!k.done;){const j=k.value;v.call(f,j[0],j[1])}},MC=(f,v)=>{let I;const P=[];for(;(I=f.exec(v))!==null;)P.push(I);return P},AC=Do("HTMLFormElement"),IC=f=>f.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(I,P,k){return P.toUpperCase()+k}),Wb=(({hasOwnProperty:f})=>(v,I)=>f.call(v,I))(Object.prototype),CC=Do("RegExp"),G2=(f,v)=>{const I=Object.getOwnPropertyDescriptors(f),P={};Zf(I,(k,j)=>{let $;($=v(k,j,f))!==!1&&(P[j]=$||k)}),Object.defineProperties(f,P)},PC=f=>{G2(f,(v,I)=>{if($s(f)&&["arguments","caller","callee"].indexOf(I)!==-1)return!1;const P=f[I];if($s(P)){if(v.enumerable=!1,"writable"in v){v.writable=!1;return}v.set||(v.set=()=>{throw Error("Can not rewrite read-only method '"+I+"'")})}})},RC=(f,v)=>{const I={},P=k=>{k.forEach(j=>{I[j]=!0})};return bh(f)?P(f):P(String(f).split(v)),I},DC=()=>{},zC=(f,v)=>f!=null&&Number.isFinite(f=+f)?f:v;function LC(f){return!!(f&&$s(f.append)&&f[Symbol.toStringTag]==="FormData"&&f[Symbol.iterator])}const OC=f=>{const v=new Array(10),I=(P,k)=>{if(S_(P)){if(v.indexOf(P)>=0)return;if(!("toJSON"in P)){v[k]=P;const j=bh(P)?[]:{};return Zf(P,($,s)=>{const Q=I($,k+1);!Nf(Q)&&(j[s]=Q)}),v[k]=void 0,j}}return P};return I(f,0)},kC=Do("AsyncFunction"),FC=f=>f&&(S_(f)||$s(f))&&$s(f.then)&&$s(f.catch),q2=((f,v)=>f?setImmediate:v?((I,P)=>(Bc.addEventListener("message",({source:k,data:j})=>{k===Bc&&j===I&&P.length&&P.shift()()},!1),k=>{P.push(k),Bc.postMessage(I,"*")}))(`axios@${Math.random()}`,[]):I=>setTimeout(I))(typeof setImmediate=="function",$s(Bc.postMessage)),BC=typeof queueMicrotask<"u"?queueMicrotask.bind(Bc):typeof process<"u"&&process.nextTick||q2,dt={isArray:bh,isArrayBuffer:N2,isBuffer:iC,isFormData:hC,isArrayBufferView:rC,isString:nC,isNumber:V2,isBoolean:sC,isObject:S_,isPlainObject:Hm,isReadableStream:fC,isRequest:pC,isResponse:mC,isHeaders:_C,isUndefined:Nf,isDate:oC,isFile:aC,isBlob:lC,isRegExp:CC,isFunction:$s,isStream:uC,isURLSearchParams:dC,isTypedArray:SC,isFileList:cC,forEach:Zf,merge:rv,extend:yC,trim:gC,stripBOM:vC,inherits:xC,toFlatObject:bC,kindOf:w_,kindOfTest:Do,endsWith:wC,toArray:TC,forEachEntry:EC,matchAll:MC,isHTMLForm:AC,hasOwnProperty:Wb,hasOwnProp:Wb,reduceDescriptors:G2,freezeMethods:PC,toObjectSet:RC,toCamelCase:IC,noop:DC,toFiniteNumber:zC,findKey:U2,global:Bc,isContextDefined:j2,isSpecCompliantForm:LC,toJSONObject:OC,isAsyncFn:kC,isThenable:FC,setImmediate:q2,asap:BC};function or(f,v,I,P,k){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=f,this.name="AxiosError",v&&(this.code=v),I&&(this.config=I),P&&(this.request=P),k&&(this.response=k,this.status=k.status?k.status:null)}dt.inherits(or,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:dt.toJSONObject(this.config),code:this.code,status:this.status}}});const $2=or.prototype,H2={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(f=>{H2[f]={value:f}});Object.defineProperties(or,H2);Object.defineProperty($2,"isAxiosError",{value:!0});or.from=(f,v,I,P,k,j)=>{const $=Object.create($2);return dt.toFlatObject(f,$,function(Q){return Q!==Error.prototype},s=>s!=="isAxiosError"),or.call($,f.message,v,I,P,k),$.cause=f,$.name=f.name,j&&Object.assign($,j),$};const NC=null;function nv(f){return dt.isPlainObject(f)||dt.isArray(f)}function Z2(f){return dt.endsWith(f,"[]")?f.slice(0,-2):f}function Xb(f,v,I){return f?f.concat(v).map(function(k,j){return k=Z2(k),!I&&j?"["+k+"]":k}).join(I?".":""):v}function VC(f){return dt.isArray(f)&&!f.some(nv)}const UC=dt.toFlatObject(dt,{},null,function(v){return/^is[A-Z]/.test(v)});function E_(f,v,I){if(!dt.isObject(f))throw new TypeError("target must be an object");v=v||new FormData,I=dt.toFlatObject(I,{metaTokens:!0,dots:!1,indexes:!1},!1,function(et,ft){return!dt.isUndefined(ft[et])});const P=I.metaTokens,k=I.visitor||ae,j=I.dots,$=I.indexes,Q=(I.Blob||typeof Blob<"u"&&Blob)&&dt.isSpecCompliantForm(v);if(!dt.isFunction(k))throw new TypeError("visitor must be a function");function de(Ze){if(Ze===null)return"";if(dt.isDate(Ze))return Ze.toISOString();if(!Q&&dt.isBlob(Ze))throw new or("Blob is not supported. Use a Buffer instead.");return dt.isArrayBuffer(Ze)||dt.isTypedArray(Ze)?Q&&typeof Blob=="function"?new Blob([Ze]):Buffer.from(Ze):Ze}function ae(Ze,et,ft){let vt=Ze;if(Ze&&!ft&&typeof Ze=="object"){if(dt.endsWith(et,"{}"))et=P?et:et.slice(0,-2),Ze=JSON.stringify(Ze);else if(dt.isArray(Ze)&&VC(Ze)||(dt.isFileList(Ze)||dt.endsWith(et,"[]"))&&(vt=dt.toArray(Ze)))return et=Z2(et),vt.forEach(function(Vt,pt){!(dt.isUndefined(Vt)||Vt===null)&&v.append($===!0?Xb([et],pt,j):$===null?et:et+"[]",de(Vt))}),!1}return nv(Ze)?!0:(v.append(Xb(ft,et,j),de(Ze)),!1)}const Te=[],Ne=Object.assign(UC,{defaultVisitor:ae,convertValue:de,isVisitable:nv});function Re(Ze,et){if(!dt.isUndefined(Ze)){if(Te.indexOf(Ze)!==-1)throw Error("Circular reference detected in "+et.join("."));Te.push(Ze),dt.forEach(Ze,function(vt,gt){(!(dt.isUndefined(vt)||vt===null)&&k.call(v,vt,dt.isString(gt)?gt.trim():gt,et,Ne))===!0&&Re(vt,et?et.concat(gt):[gt])}),Te.pop()}}if(!dt.isObject(f))throw new TypeError("data must be an object");return Re(f),v}function Kb(f){const v={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(f).replace(/[!'()~]|%20|%00/g,function(P){return v[P]})}function Pv(f,v){this._pairs=[],f&&E_(f,this,v)}const W2=Pv.prototype;W2.append=function(v,I){this._pairs.push([v,I])};W2.toString=function(v){const I=v?function(P){return v.call(this,P,Kb)}:Kb;return this._pairs.map(function(k){return I(k[0])+"="+I(k[1])},"").join("&")};function jC(f){return encodeURIComponent(f).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function X2(f,v,I){if(!v)return f;const P=I&&I.encode||jC;dt.isFunction(I)&&(I={serialize:I});const k=I&&I.serialize;let j;if(k?j=k(v,I):j=dt.isURLSearchParams(v)?v.toString():new Pv(v,I).toString(P),j){const $=f.indexOf("#");$!==-1&&(f=f.slice(0,$)),f+=(f.indexOf("?")===-1?"?":"&")+j}return f}class Yb{constructor(){this.handlers=[]}use(v,I,P){return this.handlers.push({fulfilled:v,rejected:I,synchronous:P?P.synchronous:!1,runWhen:P?P.runWhen:null}),this.handlers.length-1}eject(v){this.handlers[v]&&(this.handlers[v]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(v){dt.forEach(this.handlers,function(P){P!==null&&v(P)})}}const K2={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},GC=typeof URLSearchParams<"u"?URLSearchParams:Pv,qC=typeof FormData<"u"?FormData:null,$C=typeof Blob<"u"?Blob:null,HC={isBrowser:!0,classes:{URLSearchParams:GC,FormData:qC,Blob:$C},protocols:["http","https","file","blob","url","data"]},Rv=typeof window<"u"&&typeof document<"u",sv=typeof navigator=="object"&&navigator||void 0,ZC=Rv&&(!sv||["ReactNative","NativeScript","NS"].indexOf(sv.product)<0),WC=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",XC=Rv&&window.location.href||"http://localhost",KC=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Rv,hasStandardBrowserEnv:ZC,hasStandardBrowserWebWorkerEnv:WC,navigator:sv,origin:XC},Symbol.toStringTag,{value:"Module"})),is={...KC,...HC};function YC(f,v){return E_(f,new is.classes.URLSearchParams,Object.assign({visitor:function(I,P,k,j){return is.isNode&&dt.isBuffer(I)?(this.append(P,I.toString("base64")),!1):j.defaultVisitor.apply(this,arguments)}},v))}function JC(f){return dt.matchAll(/\w+|\[(\w*)]/g,f).map(v=>v[0]==="[]"?"":v[1]||v[0])}function QC(f){const v={},I=Object.keys(f);let P;const k=I.length;let j;for(P=0;P<k;P++)j=I[P],v[j]=f[j];return v}function Y2(f){function v(I,P,k,j){let $=I[j++];if($==="__proto__")return!0;const s=Number.isFinite(+$),Q=j>=I.length;return $=!$&&dt.isArray(k)?k.length:$,Q?(dt.hasOwnProp(k,$)?k[$]=[k[$],P]:k[$]=P,!s):((!k[$]||!dt.isObject(k[$]))&&(k[$]=[]),v(I,P,k[$],j)&&dt.isArray(k[$])&&(k[$]=QC(k[$])),!s)}if(dt.isFormData(f)&&dt.isFunction(f.entries)){const I={};return dt.forEachEntry(f,(P,k)=>{v(JC(P),k,I,0)}),I}return null}function eP(f,v,I){if(dt.isString(f))try{return(v||JSON.parse)(f),dt.trim(f)}catch(P){if(P.name!=="SyntaxError")throw P}return(I||JSON.stringify)(f)}const Wf={transitional:K2,adapter:["xhr","http","fetch"],transformRequest:[function(v,I){const P=I.getContentType()||"",k=P.indexOf("application/json")>-1,j=dt.isObject(v);if(j&&dt.isHTMLForm(v)&&(v=new FormData(v)),dt.isFormData(v))return k?JSON.stringify(Y2(v)):v;if(dt.isArrayBuffer(v)||dt.isBuffer(v)||dt.isStream(v)||dt.isFile(v)||dt.isBlob(v)||dt.isReadableStream(v))return v;if(dt.isArrayBufferView(v))return v.buffer;if(dt.isURLSearchParams(v))return I.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),v.toString();let s;if(j){if(P.indexOf("application/x-www-form-urlencoded")>-1)return YC(v,this.formSerializer).toString();if((s=dt.isFileList(v))||P.indexOf("multipart/form-data")>-1){const Q=this.env&&this.env.FormData;return E_(s?{"files[]":v}:v,Q&&new Q,this.formSerializer)}}return j||k?(I.setContentType("application/json",!1),eP(v)):v}],transformResponse:[function(v){const I=this.transitional||Wf.transitional,P=I&&I.forcedJSONParsing,k=this.responseType==="json";if(dt.isResponse(v)||dt.isReadableStream(v))return v;if(v&&dt.isString(v)&&(P&&!this.responseType||k)){const $=!(I&&I.silentJSONParsing)&&k;try{return JSON.parse(v)}catch(s){if($)throw s.name==="SyntaxError"?or.from(s,or.ERR_BAD_RESPONSE,this,null,this.response):s}}return v}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:is.classes.FormData,Blob:is.classes.Blob},validateStatus:function(v){return v>=200&&v<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};dt.forEach(["delete","get","head","post","put","patch"],f=>{Wf.headers[f]={}});const tP=dt.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),iP=f=>{const v={};let I,P,k;return f&&f.split(`
`).forEach(function($){k=$.indexOf(":"),I=$.substring(0,k).trim().toLowerCase(),P=$.substring(k+1).trim(),!(!I||v[I]&&tP[I])&&(I==="set-cookie"?v[I]?v[I].push(P):v[I]=[P]:v[I]=v[I]?v[I]+", "+P:P)}),v},Jb=Symbol("internals");function bf(f){return f&&String(f).trim().toLowerCase()}function Zm(f){return f===!1||f==null?f:dt.isArray(f)?f.map(Zm):String(f)}function rP(f){const v=Object.create(null),I=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let P;for(;P=I.exec(f);)v[P[1]]=P[2];return v}const nP=f=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(f.trim());function Ny(f,v,I,P,k){if(dt.isFunction(P))return P.call(this,v,I);if(k&&(v=I),!!dt.isString(v)){if(dt.isString(P))return v.indexOf(P)!==-1;if(dt.isRegExp(P))return P.test(v)}}function sP(f){return f.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(v,I,P)=>I.toUpperCase()+P)}function oP(f,v){const I=dt.toCamelCase(" "+v);["get","set","has"].forEach(P=>{Object.defineProperty(f,P+I,{value:function(k,j,$){return this[P].call(this,v,k,j,$)},configurable:!0})})}let Ds=class{constructor(v){v&&this.set(v)}set(v,I,P){const k=this;function j(s,Q,de){const ae=bf(Q);if(!ae)throw new Error("header name must be a non-empty string");const Te=dt.findKey(k,ae);(!Te||k[Te]===void 0||de===!0||de===void 0&&k[Te]!==!1)&&(k[Te||Q]=Zm(s))}const $=(s,Q)=>dt.forEach(s,(de,ae)=>j(de,ae,Q));if(dt.isPlainObject(v)||v instanceof this.constructor)$(v,I);else if(dt.isString(v)&&(v=v.trim())&&!nP(v))$(iP(v),I);else if(dt.isHeaders(v))for(const[s,Q]of v.entries())j(Q,s,P);else v!=null&&j(I,v,P);return this}get(v,I){if(v=bf(v),v){const P=dt.findKey(this,v);if(P){const k=this[P];if(!I)return k;if(I===!0)return rP(k);if(dt.isFunction(I))return I.call(this,k,P);if(dt.isRegExp(I))return I.exec(k);throw new TypeError("parser must be boolean|regexp|function")}}}has(v,I){if(v=bf(v),v){const P=dt.findKey(this,v);return!!(P&&this[P]!==void 0&&(!I||Ny(this,this[P],P,I)))}return!1}delete(v,I){const P=this;let k=!1;function j($){if($=bf($),$){const s=dt.findKey(P,$);s&&(!I||Ny(P,P[s],s,I))&&(delete P[s],k=!0)}}return dt.isArray(v)?v.forEach(j):j(v),k}clear(v){const I=Object.keys(this);let P=I.length,k=!1;for(;P--;){const j=I[P];(!v||Ny(this,this[j],j,v,!0))&&(delete this[j],k=!0)}return k}normalize(v){const I=this,P={};return dt.forEach(this,(k,j)=>{const $=dt.findKey(P,j);if($){I[$]=Zm(k),delete I[j];return}const s=v?sP(j):String(j).trim();s!==j&&delete I[j],I[s]=Zm(k),P[s]=!0}),this}concat(...v){return this.constructor.concat(this,...v)}toJSON(v){const I=Object.create(null);return dt.forEach(this,(P,k)=>{P!=null&&P!==!1&&(I[k]=v&&dt.isArray(P)?P.join(", "):P)}),I}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([v,I])=>v+": "+I).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(v){return v instanceof this?v:new this(v)}static concat(v,...I){const P=new this(v);return I.forEach(k=>P.set(k)),P}static accessor(v){const P=(this[Jb]=this[Jb]={accessors:{}}).accessors,k=this.prototype;function j($){const s=bf($);P[s]||(oP(k,$),P[s]=!0)}return dt.isArray(v)?v.forEach(j):j(v),this}};Ds.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);dt.reduceDescriptors(Ds.prototype,({value:f},v)=>{let I=v[0].toUpperCase()+v.slice(1);return{get:()=>f,set(P){this[I]=P}}});dt.freezeMethods(Ds);function Vy(f,v){const I=this||Wf,P=v||I,k=Ds.from(P.headers);let j=P.data;return dt.forEach(f,function(s){j=s.call(I,j,k.normalize(),v?v.status:void 0)}),k.normalize(),j}function J2(f){return!!(f&&f.__CANCEL__)}function wh(f,v,I){or.call(this,f??"canceled",or.ERR_CANCELED,v,I),this.name="CanceledError"}dt.inherits(wh,or,{__CANCEL__:!0});function Q2(f,v,I){const P=I.config.validateStatus;!I.status||!P||P(I.status)?f(I):v(new or("Request failed with status code "+I.status,[or.ERR_BAD_REQUEST,or.ERR_BAD_RESPONSE][Math.floor(I.status/100)-4],I.config,I.request,I))}function aP(f){const v=/^([-+\w]{1,25})(:?\/\/|:)/.exec(f);return v&&v[1]||""}function lP(f,v){f=f||10;const I=new Array(f),P=new Array(f);let k=0,j=0,$;return v=v!==void 0?v:1e3,function(Q){const de=Date.now(),ae=P[j];$||($=de),I[k]=Q,P[k]=de;let Te=j,Ne=0;for(;Te!==k;)Ne+=I[Te++],Te=Te%f;if(k=(k+1)%f,k===j&&(j=(j+1)%f),de-$<v)return;const Re=ae&&de-ae;return Re?Math.round(Ne*1e3/Re):void 0}}function cP(f,v){let I=0,P=1e3/v,k,j;const $=(de,ae=Date.now())=>{I=ae,k=null,j&&(clearTimeout(j),j=null),f.apply(null,de)};return[(...de)=>{const ae=Date.now(),Te=ae-I;Te>=P?$(de,ae):(k=de,j||(j=setTimeout(()=>{j=null,$(k)},P-Te)))},()=>k&&$(k)]}const a_=(f,v,I=3)=>{let P=0;const k=lP(50,250);return cP(j=>{const $=j.loaded,s=j.lengthComputable?j.total:void 0,Q=$-P,de=k(Q),ae=$<=s;P=$;const Te={loaded:$,total:s,progress:s?$/s:void 0,bytes:Q,rate:de||void 0,estimated:de&&s&&ae?(s-$)/de:void 0,event:j,lengthComputable:s!=null,[v?"download":"upload"]:!0};f(Te)},I)},Qb=(f,v)=>{const I=f!=null;return[P=>v[0]({lengthComputable:I,total:f,loaded:P}),v[1]]},ew=f=>(...v)=>dt.asap(()=>f(...v)),uP=is.hasStandardBrowserEnv?((f,v)=>I=>(I=new URL(I,is.origin),f.protocol===I.protocol&&f.host===I.host&&(v||f.port===I.port)))(new URL(is.origin),is.navigator&&/(msie|trident)/i.test(is.navigator.userAgent)):()=>!0,hP=is.hasStandardBrowserEnv?{write(f,v,I,P,k,j){const $=[f+"="+encodeURIComponent(v)];dt.isNumber(I)&&$.push("expires="+new Date(I).toGMTString()),dt.isString(P)&&$.push("path="+P),dt.isString(k)&&$.push("domain="+k),j===!0&&$.push("secure"),document.cookie=$.join("; ")},read(f){const v=document.cookie.match(new RegExp("(^|;\\s*)("+f+")=([^;]*)"));return v?decodeURIComponent(v[3]):null},remove(f){this.write(f,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function dP(f){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(f)}function fP(f,v){return v?f.replace(/\/?\/$/,"")+"/"+v.replace(/^\/+/,""):f}function eT(f,v,I){let P=!dP(v);return f&&(P||I==!1)?fP(f,v):v}const tw=f=>f instanceof Ds?{...f}:f;function qc(f,v){v=v||{};const I={};function P(de,ae,Te,Ne){return dt.isPlainObject(de)&&dt.isPlainObject(ae)?dt.merge.call({caseless:Ne},de,ae):dt.isPlainObject(ae)?dt.merge({},ae):dt.isArray(ae)?ae.slice():ae}function k(de,ae,Te,Ne){if(dt.isUndefined(ae)){if(!dt.isUndefined(de))return P(void 0,de,Te,Ne)}else return P(de,ae,Te,Ne)}function j(de,ae){if(!dt.isUndefined(ae))return P(void 0,ae)}function $(de,ae){if(dt.isUndefined(ae)){if(!dt.isUndefined(de))return P(void 0,de)}else return P(void 0,ae)}function s(de,ae,Te){if(Te in v)return P(de,ae);if(Te in f)return P(void 0,de)}const Q={url:j,method:j,data:j,baseURL:$,transformRequest:$,transformResponse:$,paramsSerializer:$,timeout:$,timeoutMessage:$,withCredentials:$,withXSRFToken:$,adapter:$,responseType:$,xsrfCookieName:$,xsrfHeaderName:$,onUploadProgress:$,onDownloadProgress:$,decompress:$,maxContentLength:$,maxBodyLength:$,beforeRedirect:$,transport:$,httpAgent:$,httpsAgent:$,cancelToken:$,socketPath:$,responseEncoding:$,validateStatus:s,headers:(de,ae,Te)=>k(tw(de),tw(ae),Te,!0)};return dt.forEach(Object.keys(Object.assign({},f,v)),function(ae){const Te=Q[ae]||k,Ne=Te(f[ae],v[ae],ae);dt.isUndefined(Ne)&&Te!==s||(I[ae]=Ne)}),I}const tT=f=>{const v=qc({},f);let{data:I,withXSRFToken:P,xsrfHeaderName:k,xsrfCookieName:j,headers:$,auth:s}=v;v.headers=$=Ds.from($),v.url=X2(eT(v.baseURL,v.url,v.allowAbsoluteUrls),f.params,f.paramsSerializer),s&&$.set("Authorization","Basic "+btoa((s.username||"")+":"+(s.password?unescape(encodeURIComponent(s.password)):"")));let Q;if(dt.isFormData(I)){if(is.hasStandardBrowserEnv||is.hasStandardBrowserWebWorkerEnv)$.setContentType(void 0);else if((Q=$.getContentType())!==!1){const[de,...ae]=Q?Q.split(";").map(Te=>Te.trim()).filter(Boolean):[];$.setContentType([de||"multipart/form-data",...ae].join("; "))}}if(is.hasStandardBrowserEnv&&(P&&dt.isFunction(P)&&(P=P(v)),P||P!==!1&&uP(v.url))){const de=k&&j&&hP.read(j);de&&$.set(k,de)}return v},pP=typeof XMLHttpRequest<"u",mP=pP&&function(f){return new Promise(function(I,P){const k=tT(f);let j=k.data;const $=Ds.from(k.headers).normalize();let{responseType:s,onUploadProgress:Q,onDownloadProgress:de}=k,ae,Te,Ne,Re,Ze;function et(){Re&&Re(),Ze&&Ze(),k.cancelToken&&k.cancelToken.unsubscribe(ae),k.signal&&k.signal.removeEventListener("abort",ae)}let ft=new XMLHttpRequest;ft.open(k.method.toUpperCase(),k.url,!0),ft.timeout=k.timeout;function vt(){if(!ft)return;const Vt=Ds.from("getAllResponseHeaders"in ft&&ft.getAllResponseHeaders()),ui={data:!s||s==="text"||s==="json"?ft.responseText:ft.response,status:ft.status,statusText:ft.statusText,headers:Vt,config:f,request:ft};Q2(function(Pt){I(Pt),et()},function(Pt){P(Pt),et()},ui),ft=null}"onloadend"in ft?ft.onloadend=vt:ft.onreadystatechange=function(){!ft||ft.readyState!==4||ft.status===0&&!(ft.responseURL&&ft.responseURL.indexOf("file:")===0)||setTimeout(vt)},ft.onabort=function(){ft&&(P(new or("Request aborted",or.ECONNABORTED,f,ft)),ft=null)},ft.onerror=function(){P(new or("Network Error",or.ERR_NETWORK,f,ft)),ft=null},ft.ontimeout=function(){let pt=k.timeout?"timeout of "+k.timeout+"ms exceeded":"timeout exceeded";const ui=k.transitional||K2;k.timeoutErrorMessage&&(pt=k.timeoutErrorMessage),P(new or(pt,ui.clarifyTimeoutError?or.ETIMEDOUT:or.ECONNABORTED,f,ft)),ft=null},j===void 0&&$.setContentType(null),"setRequestHeader"in ft&&dt.forEach($.toJSON(),function(pt,ui){ft.setRequestHeader(ui,pt)}),dt.isUndefined(k.withCredentials)||(ft.withCredentials=!!k.withCredentials),s&&s!=="json"&&(ft.responseType=k.responseType),de&&([Ne,Ze]=a_(de,!0),ft.addEventListener("progress",Ne)),Q&&ft.upload&&([Te,Re]=a_(Q),ft.upload.addEventListener("progress",Te),ft.upload.addEventListener("loadend",Re)),(k.cancelToken||k.signal)&&(ae=Vt=>{ft&&(P(!Vt||Vt.type?new wh(null,f,ft):Vt),ft.abort(),ft=null)},k.cancelToken&&k.cancelToken.subscribe(ae),k.signal&&(k.signal.aborted?ae():k.signal.addEventListener("abort",ae)));const gt=aP(k.url);if(gt&&is.protocols.indexOf(gt)===-1){P(new or("Unsupported protocol "+gt+":",or.ERR_BAD_REQUEST,f));return}ft.send(j||null)})},_P=(f,v)=>{const{length:I}=f=f?f.filter(Boolean):[];if(v||I){let P=new AbortController,k;const j=function(de){if(!k){k=!0,s();const ae=de instanceof Error?de:this.reason;P.abort(ae instanceof or?ae:new wh(ae instanceof Error?ae.message:ae))}};let $=v&&setTimeout(()=>{$=null,j(new or(`timeout ${v} of ms exceeded`,or.ETIMEDOUT))},v);const s=()=>{f&&($&&clearTimeout($),$=null,f.forEach(de=>{de.unsubscribe?de.unsubscribe(j):de.removeEventListener("abort",j)}),f=null)};f.forEach(de=>de.addEventListener("abort",j));const{signal:Q}=P;return Q.unsubscribe=()=>dt.asap(s),Q}},gP=function*(f,v){let I=f.byteLength;if(I<v){yield f;return}let P=0,k;for(;P<I;)k=P+v,yield f.slice(P,k),P=k},yP=async function*(f,v){for await(const I of vP(f))yield*gP(I,v)},vP=async function*(f){if(f[Symbol.asyncIterator]){yield*f;return}const v=f.getReader();try{for(;;){const{done:I,value:P}=await v.read();if(I)break;yield P}}finally{await v.cancel()}},iw=(f,v,I,P)=>{const k=yP(f,v);let j=0,$,s=Q=>{$||($=!0,P&&P(Q))};return new ReadableStream({async pull(Q){try{const{done:de,value:ae}=await k.next();if(de){s(),Q.close();return}let Te=ae.byteLength;if(I){let Ne=j+=Te;I(Ne)}Q.enqueue(new Uint8Array(ae))}catch(de){throw s(de),de}},cancel(Q){return s(Q),k.return()}},{highWaterMark:2})},M_=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",iT=M_&&typeof ReadableStream=="function",xP=M_&&(typeof TextEncoder=="function"?(f=>v=>f.encode(v))(new TextEncoder):async f=>new Uint8Array(await new Response(f).arrayBuffer())),rT=(f,...v)=>{try{return!!f(...v)}catch{return!1}},bP=iT&&rT(()=>{let f=!1;const v=new Request(is.origin,{body:new ReadableStream,method:"POST",get duplex(){return f=!0,"half"}}).headers.has("Content-Type");return f&&!v}),rw=64*1024,ov=iT&&rT(()=>dt.isReadableStream(new Response("").body)),l_={stream:ov&&(f=>f.body)};M_&&(f=>{["text","arrayBuffer","blob","formData","stream"].forEach(v=>{!l_[v]&&(l_[v]=dt.isFunction(f[v])?I=>I[v]():(I,P)=>{throw new or(`Response type '${v}' is not supported`,or.ERR_NOT_SUPPORT,P)})})})(new Response);const wP=async f=>{if(f==null)return 0;if(dt.isBlob(f))return f.size;if(dt.isSpecCompliantForm(f))return(await new Request(is.origin,{method:"POST",body:f}).arrayBuffer()).byteLength;if(dt.isArrayBufferView(f)||dt.isArrayBuffer(f))return f.byteLength;if(dt.isURLSearchParams(f)&&(f=f+""),dt.isString(f))return(await xP(f)).byteLength},TP=async(f,v)=>{const I=dt.toFiniteNumber(f.getContentLength());return I??wP(v)},SP=M_&&(async f=>{let{url:v,method:I,data:P,signal:k,cancelToken:j,timeout:$,onDownloadProgress:s,onUploadProgress:Q,responseType:de,headers:ae,withCredentials:Te="same-origin",fetchOptions:Ne}=tT(f);de=de?(de+"").toLowerCase():"text";let Re=_P([k,j&&j.toAbortSignal()],$),Ze;const et=Re&&Re.unsubscribe&&(()=>{Re.unsubscribe()});let ft;try{if(Q&&bP&&I!=="get"&&I!=="head"&&(ft=await TP(ae,P))!==0){let ui=new Request(v,{method:"POST",body:P,duplex:"half"}),zi;if(dt.isFormData(P)&&(zi=ui.headers.get("content-type"))&&ae.setContentType(zi),ui.body){const[Pt,di]=Qb(ft,a_(ew(Q)));P=iw(ui.body,rw,Pt,di)}}dt.isString(Te)||(Te=Te?"include":"omit");const vt="credentials"in Request.prototype;Ze=new Request(v,{...Ne,signal:Re,method:I.toUpperCase(),headers:ae.normalize().toJSON(),body:P,duplex:"half",credentials:vt?Te:void 0});let gt=await fetch(Ze);const Vt=ov&&(de==="stream"||de==="response");if(ov&&(s||Vt&&et)){const ui={};["status","statusText","headers"].forEach(jt=>{ui[jt]=gt[jt]});const zi=dt.toFiniteNumber(gt.headers.get("content-length")),[Pt,di]=s&&Qb(zi,a_(ew(s),!0))||[];gt=new Response(iw(gt.body,rw,Pt,()=>{di&&di(),et&&et()}),ui)}de=de||"text";let pt=await l_[dt.findKey(l_,de)||"text"](gt,f);return!Vt&&et&&et(),await new Promise((ui,zi)=>{Q2(ui,zi,{data:pt,headers:Ds.from(gt.headers),status:gt.status,statusText:gt.statusText,config:f,request:Ze})})}catch(vt){throw et&&et(),vt&&vt.name==="TypeError"&&/fetch/i.test(vt.message)?Object.assign(new or("Network Error",or.ERR_NETWORK,f,Ze),{cause:vt.cause||vt}):or.from(vt,vt&&vt.code,f,Ze)}}),av={http:NC,xhr:mP,fetch:SP};dt.forEach(av,(f,v)=>{if(f){try{Object.defineProperty(f,"name",{value:v})}catch{}Object.defineProperty(f,"adapterName",{value:v})}});const nw=f=>`- ${f}`,EP=f=>dt.isFunction(f)||f===null||f===!1,nT={getAdapter:f=>{f=dt.isArray(f)?f:[f];const{length:v}=f;let I,P;const k={};for(let j=0;j<v;j++){I=f[j];let $;if(P=I,!EP(I)&&(P=av[($=String(I)).toLowerCase()],P===void 0))throw new or(`Unknown adapter '${$}'`);if(P)break;k[$||"#"+j]=P}if(!P){const j=Object.entries(k).map(([s,Q])=>`adapter ${s} `+(Q===!1?"is not supported by the environment":"is not available in the build"));let $=v?j.length>1?`since :
`+j.map(nw).join(`
`):" "+nw(j[0]):"as no adapter specified";throw new or("There is no suitable adapter to dispatch the request "+$,"ERR_NOT_SUPPORT")}return P},adapters:av};function Uy(f){if(f.cancelToken&&f.cancelToken.throwIfRequested(),f.signal&&f.signal.aborted)throw new wh(null,f)}function sw(f){return Uy(f),f.headers=Ds.from(f.headers),f.data=Vy.call(f,f.transformRequest),["post","put","patch"].indexOf(f.method)!==-1&&f.headers.setContentType("application/x-www-form-urlencoded",!1),nT.getAdapter(f.adapter||Wf.adapter)(f).then(function(P){return Uy(f),P.data=Vy.call(f,f.transformResponse,P),P.headers=Ds.from(P.headers),P},function(P){return J2(P)||(Uy(f),P&&P.response&&(P.response.data=Vy.call(f,f.transformResponse,P.response),P.response.headers=Ds.from(P.response.headers))),Promise.reject(P)})}const sT="1.8.4",A_={};["object","boolean","number","function","string","symbol"].forEach((f,v)=>{A_[f]=function(P){return typeof P===f||"a"+(v<1?"n ":" ")+f}});const ow={};A_.transitional=function(v,I,P){function k(j,$){return"[Axios v"+sT+"] Transitional option '"+j+"'"+$+(P?". "+P:"")}return(j,$,s)=>{if(v===!1)throw new or(k($," has been removed"+(I?" in "+I:"")),or.ERR_DEPRECATED);return I&&!ow[$]&&(ow[$]=!0,console.warn(k($," has been deprecated since v"+I+" and will be removed in the near future"))),v?v(j,$,s):!0}};A_.spelling=function(v){return(I,P)=>(console.warn(`${P} is likely a misspelling of ${v}`),!0)};function MP(f,v,I){if(typeof f!="object")throw new or("options must be an object",or.ERR_BAD_OPTION_VALUE);const P=Object.keys(f);let k=P.length;for(;k-- >0;){const j=P[k],$=v[j];if($){const s=f[j],Q=s===void 0||$(s,j,f);if(Q!==!0)throw new or("option "+j+" must be "+Q,or.ERR_BAD_OPTION_VALUE);continue}if(I!==!0)throw new or("Unknown option "+j,or.ERR_BAD_OPTION)}}const Wm={assertOptions:MP,validators:A_},Yo=Wm.validators;let Uc=class{constructor(v){this.defaults=v,this.interceptors={request:new Yb,response:new Yb}}async request(v,I){try{return await this._request(v,I)}catch(P){if(P instanceof Error){let k={};Error.captureStackTrace?Error.captureStackTrace(k):k=new Error;const j=k.stack?k.stack.replace(/^.+\n/,""):"";try{P.stack?j&&!String(P.stack).endsWith(j.replace(/^.+\n.+\n/,""))&&(P.stack+=`
`+j):P.stack=j}catch{}}throw P}}_request(v,I){typeof v=="string"?(I=I||{},I.url=v):I=v||{},I=qc(this.defaults,I);const{transitional:P,paramsSerializer:k,headers:j}=I;P!==void 0&&Wm.assertOptions(P,{silentJSONParsing:Yo.transitional(Yo.boolean),forcedJSONParsing:Yo.transitional(Yo.boolean),clarifyTimeoutError:Yo.transitional(Yo.boolean)},!1),k!=null&&(dt.isFunction(k)?I.paramsSerializer={serialize:k}:Wm.assertOptions(k,{encode:Yo.function,serialize:Yo.function},!0)),I.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?I.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:I.allowAbsoluteUrls=!0),Wm.assertOptions(I,{baseUrl:Yo.spelling("baseURL"),withXsrfToken:Yo.spelling("withXSRFToken")},!0),I.method=(I.method||this.defaults.method||"get").toLowerCase();let $=j&&dt.merge(j.common,j[I.method]);j&&dt.forEach(["delete","get","head","post","put","patch","common"],Ze=>{delete j[Ze]}),I.headers=Ds.concat($,j);const s=[];let Q=!0;this.interceptors.request.forEach(function(et){typeof et.runWhen=="function"&&et.runWhen(I)===!1||(Q=Q&&et.synchronous,s.unshift(et.fulfilled,et.rejected))});const de=[];this.interceptors.response.forEach(function(et){de.push(et.fulfilled,et.rejected)});let ae,Te=0,Ne;if(!Q){const Ze=[sw.bind(this),void 0];for(Ze.unshift.apply(Ze,s),Ze.push.apply(Ze,de),Ne=Ze.length,ae=Promise.resolve(I);Te<Ne;)ae=ae.then(Ze[Te++],Ze[Te++]);return ae}Ne=s.length;let Re=I;for(Te=0;Te<Ne;){const Ze=s[Te++],et=s[Te++];try{Re=Ze(Re)}catch(ft){et.call(this,ft);break}}try{ae=sw.call(this,Re)}catch(Ze){return Promise.reject(Ze)}for(Te=0,Ne=de.length;Te<Ne;)ae=ae.then(de[Te++],de[Te++]);return ae}getUri(v){v=qc(this.defaults,v);const I=eT(v.baseURL,v.url,v.allowAbsoluteUrls);return X2(I,v.params,v.paramsSerializer)}};dt.forEach(["delete","get","head","options"],function(v){Uc.prototype[v]=function(I,P){return this.request(qc(P||{},{method:v,url:I,data:(P||{}).data}))}});dt.forEach(["post","put","patch"],function(v){function I(P){return function(j,$,s){return this.request(qc(s||{},{method:v,headers:P?{"Content-Type":"multipart/form-data"}:{},url:j,data:$}))}}Uc.prototype[v]=I(),Uc.prototype[v+"Form"]=I(!0)});let AP=class oT{constructor(v){if(typeof v!="function")throw new TypeError("executor must be a function.");let I;this.promise=new Promise(function(j){I=j});const P=this;this.promise.then(k=>{if(!P._listeners)return;let j=P._listeners.length;for(;j-- >0;)P._listeners[j](k);P._listeners=null}),this.promise.then=k=>{let j;const $=new Promise(s=>{P.subscribe(s),j=s}).then(k);return $.cancel=function(){P.unsubscribe(j)},$},v(function(j,$,s){P.reason||(P.reason=new wh(j,$,s),I(P.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(v){if(this.reason){v(this.reason);return}this._listeners?this._listeners.push(v):this._listeners=[v]}unsubscribe(v){if(!this._listeners)return;const I=this._listeners.indexOf(v);I!==-1&&this._listeners.splice(I,1)}toAbortSignal(){const v=new AbortController,I=P=>{v.abort(P)};return this.subscribe(I),v.signal.unsubscribe=()=>this.unsubscribe(I),v.signal}static source(){let v;return{token:new oT(function(k){v=k}),cancel:v}}};function IP(f){return function(I){return f.apply(null,I)}}function CP(f){return dt.isObject(f)&&f.isAxiosError===!0}const lv={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(lv).forEach(([f,v])=>{lv[v]=f});function aT(f){const v=new Uc(f),I=B2(Uc.prototype.request,v);return dt.extend(I,Uc.prototype,v,{allOwnKeys:!0}),dt.extend(I,v,null,{allOwnKeys:!0}),I.create=function(k){return aT(qc(f,k))},I}const gn=aT(Wf);gn.Axios=Uc;gn.CanceledError=wh;gn.CancelToken=AP;gn.isCancel=J2;gn.VERSION=sT;gn.toFormData=E_;gn.AxiosError=or;gn.Cancel=gn.CanceledError;gn.all=function(v){return Promise.all(v)};gn.spread=IP;gn.isAxiosError=CP;gn.mergeConfig=qc;gn.AxiosHeaders=Ds;gn.formToJSON=f=>Y2(dt.isHTMLForm(f)?new FormData(f):f);gn.getAdapter=nT.getAdapter;gn.HttpStatusCode=lv;gn.default=gn;const{Axios:Iz,AxiosError:Cz,CanceledError:Pz,isCancel:Rz,CancelToken:Dz,VERSION:zz,all:Lz,Cancel:Oz,isAxiosError:kz,spread:Fz,toFormData:Bz,AxiosHeaders:Nz,HttpStatusCode:Vz,formToJSON:Uz,getAdapter:jz,mergeConfig:Gz}=gn,PP=O2(),Wr=gn.create({baseURL:"http://194.87.74.42:8082/api",headers:{"Content-type":"application/json"}});Wr.interceptors.request.use(f=>{const v=localStorage.getItem("token");return v&&(f.headers.Authorization=`Bearer ${v}`),f},f=>Promise.reject(f));Wr.interceptors.response.use(f=>f,f=>(f.response&&f.response.status===401&&(console.error(" . ..."),Xf(PP).logout(),window.location.href="/login"),Promise.reject(f)));const Xf=eC("auth",()=>{const f=Oi(null),v=Oi(!1),I=s=>{f.value=s,localStorage.setItem("username",s)},P=()=>{const s=localStorage.getItem("username"),Q=localStorage.getItem("token");if(s&&(f.value=s),Q)try{const de=JSON.parse(atob(Q.split(".")[1])),ae=de.sub||de.username;I(ae)}catch(de){console.error("   :",de)}},k=async()=>{const s=localStorage.getItem("token");if(!s||!f.value){v.value=!1;return}try{const Q=await Wr.get(`/role/${f.value}`,{headers:{Authorization:`Bearer ${s}`}});v.value=Q.data===!0}catch(Q){console.error("   :",Q),v.value=!1}},j=()=>{f.value=null,v.value=!1,localStorage.removeItem("token"),localStorage.removeItem("username")},$=Ps(()=>{const s=localStorage.getItem("token");if(!s)return!1;try{const Q=JSON.parse(atob(s.split(".")[1])),de=Date.now()/1e3;return Q.exp>de}catch{return!1}});return{username:f,isAdmin:v,setUsername:I,loadUsernameFromToken:P,fetchRole:k,logout:j,isAuthenticated:$}});/*!
  * vue-router v4.5.0
  * (c) 2024 Eduardo San Martin Morote
  * @license MIT
  */const lh=typeof document<"u";function lT(f){return typeof f=="object"||"displayName"in f||"props"in f||"__vccOpts"in f}function RP(f){return f.__esModule||f[Symbol.toStringTag]==="Module"||f.default&&lT(f.default)}const zr=Object.assign;function jy(f,v){const I={};for(const P in v){const k=v[P];I[P]=Ro(k)?k.map(f):f(k)}return I}const Rf=()=>{},Ro=Array.isArray,cT=/#/g,DP=/&/g,zP=/\//g,LP=/=/g,OP=/\?/g,uT=/\+/g,kP=/%5B/g,FP=/%5D/g,hT=/%5E/g,BP=/%60/g,dT=/%7B/g,NP=/%7C/g,fT=/%7D/g,VP=/%20/g;function Dv(f){return encodeURI(""+f).replace(NP,"|").replace(kP,"[").replace(FP,"]")}function UP(f){return Dv(f).replace(dT,"{").replace(fT,"}").replace(hT,"^")}function cv(f){return Dv(f).replace(uT,"%2B").replace(VP,"+").replace(cT,"%23").replace(DP,"%26").replace(BP,"`").replace(dT,"{").replace(fT,"}").replace(hT,"^")}function jP(f){return cv(f).replace(LP,"%3D")}function GP(f){return Dv(f).replace(cT,"%23").replace(OP,"%3F")}function qP(f){return f==null?"":GP(f).replace(zP,"%2F")}function Vf(f){try{return decodeURIComponent(""+f)}catch{}return""+f}const $P=/\/$/,HP=f=>f.replace($P,"");function Gy(f,v,I="/"){let P,k={},j="",$="";const s=v.indexOf("#");let Q=v.indexOf("?");return s<Q&&s>=0&&(Q=-1),Q>-1&&(P=v.slice(0,Q),j=v.slice(Q+1,s>-1?s:v.length),k=f(j)),s>-1&&(P=P||v.slice(0,s),$=v.slice(s,v.length)),P=KP(P??v,I),{fullPath:P+(j&&"?")+j+$,path:P,query:k,hash:Vf($)}}function ZP(f,v){const I=v.query?f(v.query):"";return v.path+(I&&"?")+I+(v.hash||"")}function aw(f,v){return!v||!f.toLowerCase().startsWith(v.toLowerCase())?f:f.slice(v.length)||"/"}function WP(f,v,I){const P=v.matched.length-1,k=I.matched.length-1;return P>-1&&P===k&&gh(v.matched[P],I.matched[k])&&pT(v.params,I.params)&&f(v.query)===f(I.query)&&v.hash===I.hash}function gh(f,v){return(f.aliasOf||f)===(v.aliasOf||v)}function pT(f,v){if(Object.keys(f).length!==Object.keys(v).length)return!1;for(const I in f)if(!XP(f[I],v[I]))return!1;return!0}function XP(f,v){return Ro(f)?lw(f,v):Ro(v)?lw(v,f):f===v}function lw(f,v){return Ro(v)?f.length===v.length&&f.every((I,P)=>I===v[P]):f.length===1&&f[0]===v}function KP(f,v){if(f.startsWith("/"))return f;if(!f)return v;const I=v.split("/"),P=f.split("/"),k=P[P.length-1];(k===".."||k===".")&&P.push("");let j=I.length-1,$,s;for($=0;$<P.length;$++)if(s=P[$],s!==".")if(s==="..")j>1&&j--;else break;return I.slice(0,j).join("/")+"/"+P.slice($).join("/")}const Il={path:"/",name:void 0,params:{},query:{},hash:"",fullPath:"/",matched:[],meta:{},redirectedFrom:void 0};var Uf;(function(f){f.pop="pop",f.push="push"})(Uf||(Uf={}));var Df;(function(f){f.back="back",f.forward="forward",f.unknown=""})(Df||(Df={}));function YP(f){if(!f)if(lh){const v=document.querySelector("base");f=v&&v.getAttribute("href")||"/",f=f.replace(/^\w+:\/\/[^\/]+/,"")}else f="/";return f[0]!=="/"&&f[0]!=="#"&&(f="/"+f),HP(f)}const JP=/^[^#]+#/;function QP(f,v){return f.replace(JP,"#")+v}function e3(f,v){const I=document.documentElement.getBoundingClientRect(),P=f.getBoundingClientRect();return{behavior:v.behavior,left:P.left-I.left-(v.left||0),top:P.top-I.top-(v.top||0)}}const I_=()=>({left:window.scrollX,top:window.scrollY});function t3(f){let v;if("el"in f){const I=f.el,P=typeof I=="string"&&I.startsWith("#"),k=typeof I=="string"?P?document.getElementById(I.slice(1)):document.querySelector(I):I;if(!k)return;v=e3(k,f)}else v=f;"scrollBehavior"in document.documentElement.style?window.scrollTo(v):window.scrollTo(v.left!=null?v.left:window.scrollX,v.top!=null?v.top:window.scrollY)}function cw(f,v){return(history.state?history.state.position-v:-1)+f}const uv=new Map;function i3(f,v){uv.set(f,v)}function r3(f){const v=uv.get(f);return uv.delete(f),v}let n3=()=>location.protocol+"//"+location.host;function mT(f,v){const{pathname:I,search:P,hash:k}=v,j=f.indexOf("#");if(j>-1){let s=k.includes(f.slice(j))?f.slice(j).length:1,Q=k.slice(s);return Q[0]!=="/"&&(Q="/"+Q),aw(Q,"")}return aw(I,f)+P+k}function s3(f,v,I,P){let k=[],j=[],$=null;const s=({state:Ne})=>{const Re=mT(f,location),Ze=I.value,et=v.value;let ft=0;if(Ne){if(I.value=Re,v.value=Ne,$&&$===Ze){$=null;return}ft=et?Ne.position-et.position:0}else P(Re);k.forEach(vt=>{vt(I.value,Ze,{delta:ft,type:Uf.pop,direction:ft?ft>0?Df.forward:Df.back:Df.unknown})})};function Q(){$=I.value}function de(Ne){k.push(Ne);const Re=()=>{const Ze=k.indexOf(Ne);Ze>-1&&k.splice(Ze,1)};return j.push(Re),Re}function ae(){const{history:Ne}=window;Ne.state&&Ne.replaceState(zr({},Ne.state,{scroll:I_()}),"")}function Te(){for(const Ne of j)Ne();j=[],window.removeEventListener("popstate",s),window.removeEventListener("beforeunload",ae)}return window.addEventListener("popstate",s),window.addEventListener("beforeunload",ae,{passive:!0}),{pauseListeners:Q,listen:de,destroy:Te}}function uw(f,v,I,P=!1,k=!1){return{back:f,current:v,forward:I,replaced:P,position:window.history.length,scroll:k?I_():null}}function o3(f){const{history:v,location:I}=window,P={value:mT(f,I)},k={value:v.state};k.value||j(P.value,{back:null,current:P.value,forward:null,position:v.length-1,replaced:!0,scroll:null},!0);function j(Q,de,ae){const Te=f.indexOf("#"),Ne=Te>-1?(I.host&&document.querySelector("base")?f:f.slice(Te))+Q:n3()+f+Q;try{v[ae?"replaceState":"pushState"](de,"",Ne),k.value=de}catch(Re){console.error(Re),I[ae?"replace":"assign"](Ne)}}function $(Q,de){const ae=zr({},v.state,uw(k.value.back,Q,k.value.forward,!0),de,{position:k.value.position});j(Q,ae,!0),P.value=Q}function s(Q,de){const ae=zr({},k.value,v.state,{forward:Q,scroll:I_()});j(ae.current,ae,!0);const Te=zr({},uw(P.value,Q,null),{position:ae.position+1},de);j(Q,Te,!1),P.value=Q}return{location:P,state:k,push:s,replace:$}}function a3(f){f=YP(f);const v=o3(f),I=s3(f,v.state,v.location,v.replace);function P(j,$=!0){$||I.pauseListeners(),history.go(j)}const k=zr({location:"",base:f,go:P,createHref:QP.bind(null,f)},v,I);return Object.defineProperty(k,"location",{enumerable:!0,get:()=>v.location.value}),Object.defineProperty(k,"state",{enumerable:!0,get:()=>v.state.value}),k}function l3(f){return typeof f=="string"||f&&typeof f=="object"}function _T(f){return typeof f=="string"||typeof f=="symbol"}const gT=Symbol("");var hw;(function(f){f[f.aborted=4]="aborted",f[f.cancelled=8]="cancelled",f[f.duplicated=16]="duplicated"})(hw||(hw={}));function yh(f,v){return zr(new Error,{type:f,[gT]:!0},v)}function Ta(f,v){return f instanceof Error&&gT in f&&(v==null||!!(f.type&v))}const dw="[^/]+?",c3={sensitive:!1,strict:!1,start:!0,end:!0},u3=/[.+*?^${}()[\]/\\]/g;function h3(f,v){const I=zr({},c3,v),P=[];let k=I.start?"^":"";const j=[];for(const de of f){const ae=de.length?[]:[90];I.strict&&!de.length&&(k+="/");for(let Te=0;Te<de.length;Te++){const Ne=de[Te];let Re=40+(I.sensitive?.25:0);if(Ne.type===0)Te||(k+="/"),k+=Ne.value.replace(u3,"\\$&"),Re+=40;else if(Ne.type===1){const{value:Ze,repeatable:et,optional:ft,regexp:vt}=Ne;j.push({name:Ze,repeatable:et,optional:ft});const gt=vt||dw;if(gt!==dw){Re+=10;try{new RegExp(`(${gt})`)}catch(pt){throw new Error(`Invalid custom RegExp for param "${Ze}" (${gt}): `+pt.message)}}let Vt=et?`((?:${gt})(?:/(?:${gt}))*)`:`(${gt})`;Te||(Vt=ft&&de.length<2?`(?:/${Vt})`:"/"+Vt),ft&&(Vt+="?"),k+=Vt,Re+=20,ft&&(Re+=-8),et&&(Re+=-20),gt===".*"&&(Re+=-50)}ae.push(Re)}P.push(ae)}if(I.strict&&I.end){const de=P.length-1;P[de][P[de].length-1]+=.7000000000000001}I.strict||(k+="/?"),I.end?k+="$":I.strict&&!k.endsWith("/")&&(k+="(?:/|$)");const $=new RegExp(k,I.sensitive?"":"i");function s(de){const ae=de.match($),Te={};if(!ae)return null;for(let Ne=1;Ne<ae.length;Ne++){const Re=ae[Ne]||"",Ze=j[Ne-1];Te[Ze.name]=Re&&Ze.repeatable?Re.split("/"):Re}return Te}function Q(de){let ae="",Te=!1;for(const Ne of f){(!Te||!ae.endsWith("/"))&&(ae+="/"),Te=!1;for(const Re of Ne)if(Re.type===0)ae+=Re.value;else if(Re.type===1){const{value:Ze,repeatable:et,optional:ft}=Re,vt=Ze in de?de[Ze]:"";if(Ro(vt)&&!et)throw new Error(`Provided param "${Ze}" is an array but it is not repeatable (* or + modifiers)`);const gt=Ro(vt)?vt.join("/"):vt;if(!gt)if(ft)Ne.length<2&&(ae.endsWith("/")?ae=ae.slice(0,-1):Te=!0);else throw new Error(`Missing required param "${Ze}"`);ae+=gt}}return ae||"/"}return{re:$,score:P,keys:j,parse:s,stringify:Q}}function d3(f,v){let I=0;for(;I<f.length&&I<v.length;){const P=v[I]-f[I];if(P)return P;I++}return f.length<v.length?f.length===1&&f[0]===80?-1:1:f.length>v.length?v.length===1&&v[0]===80?1:-1:0}function yT(f,v){let I=0;const P=f.score,k=v.score;for(;I<P.length&&I<k.length;){const j=d3(P[I],k[I]);if(j)return j;I++}if(Math.abs(k.length-P.length)===1){if(fw(P))return 1;if(fw(k))return-1}return k.length-P.length}function fw(f){const v=f[f.length-1];return f.length>0&&v[v.length-1]<0}const f3={type:0,value:""},p3=/[a-zA-Z0-9_]/;function m3(f){if(!f)return[[]];if(f==="/")return[[f3]];if(!f.startsWith("/"))throw new Error(`Invalid path "${f}"`);function v(Re){throw new Error(`ERR (${I})/"${de}": ${Re}`)}let I=0,P=I;const k=[];let j;function $(){j&&k.push(j),j=[]}let s=0,Q,de="",ae="";function Te(){de&&(I===0?j.push({type:0,value:de}):I===1||I===2||I===3?(j.length>1&&(Q==="*"||Q==="+")&&v(`A repeatable param (${de}) must be alone in its segment. eg: '/:ids+.`),j.push({type:1,value:de,regexp:ae,repeatable:Q==="*"||Q==="+",optional:Q==="*"||Q==="?"})):v("Invalid state to consume buffer"),de="")}function Ne(){de+=Q}for(;s<f.length;){if(Q=f[s++],Q==="\\"&&I!==2){P=I,I=4;continue}switch(I){case 0:Q==="/"?(de&&Te(),$()):Q===":"?(Te(),I=1):Ne();break;case 4:Ne(),I=P;break;case 1:Q==="("?I=2:p3.test(Q)?Ne():(Te(),I=0,Q!=="*"&&Q!=="?"&&Q!=="+"&&s--);break;case 2:Q===")"?ae[ae.length-1]=="\\"?ae=ae.slice(0,-1)+Q:I=3:ae+=Q;break;case 3:Te(),I=0,Q!=="*"&&Q!=="?"&&Q!=="+"&&s--,ae="";break;default:v("Unknown state");break}}return I===2&&v(`Unfinished custom RegExp for param "${de}"`),Te(),$(),k}function _3(f,v,I){const P=h3(m3(f.path),I),k=zr(P,{record:f,parent:v,children:[],alias:[]});return v&&!k.record.aliasOf==!v.record.aliasOf&&v.children.push(k),k}function g3(f,v){const I=[],P=new Map;v=gw({strict:!1,end:!0,sensitive:!1},v);function k(Te){return P.get(Te)}function j(Te,Ne,Re){const Ze=!Re,et=mw(Te);et.aliasOf=Re&&Re.record;const ft=gw(v,Te),vt=[et];if("alias"in Te){const pt=typeof Te.alias=="string"?[Te.alias]:Te.alias;for(const ui of pt)vt.push(mw(zr({},et,{components:Re?Re.record.components:et.components,path:ui,aliasOf:Re?Re.record:et})))}let gt,Vt;for(const pt of vt){const{path:ui}=pt;if(Ne&&ui[0]!=="/"){const zi=Ne.record.path,Pt=zi[zi.length-1]==="/"?"":"/";pt.path=Ne.record.path+(ui&&Pt+ui)}if(gt=_3(pt,Ne,ft),Re?Re.alias.push(gt):(Vt=Vt||gt,Vt!==gt&&Vt.alias.push(gt),Ze&&Te.name&&!_w(gt)&&$(Te.name)),vT(gt)&&Q(gt),et.children){const zi=et.children;for(let Pt=0;Pt<zi.length;Pt++)j(zi[Pt],gt,Re&&Re.children[Pt])}Re=Re||gt}return Vt?()=>{$(Vt)}:Rf}function $(Te){if(_T(Te)){const Ne=P.get(Te);Ne&&(P.delete(Te),I.splice(I.indexOf(Ne),1),Ne.children.forEach($),Ne.alias.forEach($))}else{const Ne=I.indexOf(Te);Ne>-1&&(I.splice(Ne,1),Te.record.name&&P.delete(Te.record.name),Te.children.forEach($),Te.alias.forEach($))}}function s(){return I}function Q(Te){const Ne=x3(Te,I);I.splice(Ne,0,Te),Te.record.name&&!_w(Te)&&P.set(Te.record.name,Te)}function de(Te,Ne){let Re,Ze={},et,ft;if("name"in Te&&Te.name){if(Re=P.get(Te.name),!Re)throw yh(1,{location:Te});ft=Re.record.name,Ze=zr(pw(Ne.params,Re.keys.filter(Vt=>!Vt.optional).concat(Re.parent?Re.parent.keys.filter(Vt=>Vt.optional):[]).map(Vt=>Vt.name)),Te.params&&pw(Te.params,Re.keys.map(Vt=>Vt.name))),et=Re.stringify(Ze)}else if(Te.path!=null)et=Te.path,Re=I.find(Vt=>Vt.re.test(et)),Re&&(Ze=Re.parse(et),ft=Re.record.name);else{if(Re=Ne.name?P.get(Ne.name):I.find(Vt=>Vt.re.test(Ne.path)),!Re)throw yh(1,{location:Te,currentLocation:Ne});ft=Re.record.name,Ze=zr({},Ne.params,Te.params),et=Re.stringify(Ze)}const vt=[];let gt=Re;for(;gt;)vt.unshift(gt.record),gt=gt.parent;return{name:ft,path:et,params:Ze,matched:vt,meta:v3(vt)}}f.forEach(Te=>j(Te));function ae(){I.length=0,P.clear()}return{addRoute:j,resolve:de,removeRoute:$,clearRoutes:ae,getRoutes:s,getRecordMatcher:k}}function pw(f,v){const I={};for(const P of v)P in f&&(I[P]=f[P]);return I}function mw(f){const v={path:f.path,redirect:f.redirect,name:f.name,meta:f.meta||{},aliasOf:f.aliasOf,beforeEnter:f.beforeEnter,props:y3(f),children:f.children||[],instances:{},leaveGuards:new Set,updateGuards:new Set,enterCallbacks:{},components:"components"in f?f.components||null:f.component&&{default:f.component}};return Object.defineProperty(v,"mods",{value:{}}),v}function y3(f){const v={},I=f.props||!1;if("component"in f)v.default=I;else for(const P in f.components)v[P]=typeof I=="object"?I[P]:I;return v}function _w(f){for(;f;){if(f.record.aliasOf)return!0;f=f.parent}return!1}function v3(f){return f.reduce((v,I)=>zr(v,I.meta),{})}function gw(f,v){const I={};for(const P in f)I[P]=P in v?v[P]:f[P];return I}function x3(f,v){let I=0,P=v.length;for(;I!==P;){const j=I+P>>1;yT(f,v[j])<0?P=j:I=j+1}const k=b3(f);return k&&(P=v.lastIndexOf(k,P-1)),P}function b3(f){let v=f;for(;v=v.parent;)if(vT(v)&&yT(f,v)===0)return v}function vT({record:f}){return!!(f.name||f.components&&Object.keys(f.components).length||f.redirect)}function w3(f){const v={};if(f===""||f==="?")return v;const P=(f[0]==="?"?f.slice(1):f).split("&");for(let k=0;k<P.length;++k){const j=P[k].replace(uT," "),$=j.indexOf("="),s=Vf($<0?j:j.slice(0,$)),Q=$<0?null:Vf(j.slice($+1));if(s in v){let de=v[s];Ro(de)||(de=v[s]=[de]),de.push(Q)}else v[s]=Q}return v}function yw(f){let v="";for(let I in f){const P=f[I];if(I=jP(I),P==null){P!==void 0&&(v+=(v.length?"&":"")+I);continue}(Ro(P)?P.map(j=>j&&cv(j)):[P&&cv(P)]).forEach(j=>{j!==void 0&&(v+=(v.length?"&":"")+I,j!=null&&(v+="="+j))})}return v}function T3(f){const v={};for(const I in f){const P=f[I];P!==void 0&&(v[I]=Ro(P)?P.map(k=>k==null?null:""+k):P==null?P:""+P)}return v}const S3=Symbol(""),vw=Symbol(""),C_=Symbol(""),zv=Symbol(""),hv=Symbol("");function wf(){let f=[];function v(P){return f.push(P),()=>{const k=f.indexOf(P);k>-1&&f.splice(k,1)}}function I(){f=[]}return{add:v,list:()=>f.slice(),reset:I}}function Dl(f,v,I,P,k,j=$=>$()){const $=P&&(P.enterCallbacks[k]=P.enterCallbacks[k]||[]);return()=>new Promise((s,Q)=>{const de=Ne=>{Ne===!1?Q(yh(4,{from:I,to:v})):Ne instanceof Error?Q(Ne):l3(Ne)?Q(yh(2,{from:v,to:Ne})):($&&P.enterCallbacks[k]===$&&typeof Ne=="function"&&$.push(Ne),s())},ae=j(()=>f.call(P&&P.instances[k],v,I,de));let Te=Promise.resolve(ae);f.length<3&&(Te=Te.then(de)),Te.catch(Ne=>Q(Ne))})}function qy(f,v,I,P,k=j=>j()){const j=[];for(const $ of f)for(const s in $.components){let Q=$.components[s];if(!(v!=="beforeRouteEnter"&&!$.instances[s]))if(lT(Q)){const ae=(Q.__vccOpts||Q)[v];ae&&j.push(Dl(ae,I,P,$,s,k))}else{let de=Q();j.push(()=>de.then(ae=>{if(!ae)throw new Error(`Couldn't resolve component "${s}" at "${$.path}"`);const Te=RP(ae)?ae.default:ae;$.mods[s]=ae,$.components[s]=Te;const Re=(Te.__vccOpts||Te)[v];return Re&&Dl(Re,I,P,$,s,k)()}))}}return j}function xw(f){const v=ro(C_),I=ro(zv),P=Ps(()=>{const Q=Aa(f.to);return v.resolve(Q)}),k=Ps(()=>{const{matched:Q}=P.value,{length:de}=Q,ae=Q[de-1],Te=I.matched;if(!ae||!Te.length)return-1;const Ne=Te.findIndex(gh.bind(null,ae));if(Ne>-1)return Ne;const Re=bw(Q[de-2]);return de>1&&bw(ae)===Re&&Te[Te.length-1].path!==Re?Te.findIndex(gh.bind(null,Q[de-2])):Ne}),j=Ps(()=>k.value>-1&&C3(I.params,P.value.params)),$=Ps(()=>k.value>-1&&k.value===I.matched.length-1&&pT(I.params,P.value.params));function s(Q={}){if(I3(Q)){const de=v[Aa(f.replace)?"replace":"push"](Aa(f.to)).catch(Rf);return f.viewTransition&&typeof document<"u"&&"startViewTransition"in document&&document.startViewTransition(()=>de),de}return Promise.resolve()}return{route:P,href:Ps(()=>P.value.href),isActive:j,isExactActive:$,navigate:s}}function E3(f){return f.length===1?f[0]:f}const M3=n2({name:"RouterLink",compatConfig:{MODE:3},props:{to:{type:[String,Object],required:!0},replace:Boolean,activeClass:String,exactActiveClass:String,custom:Boolean,ariaCurrentValue:{type:String,default:"page"}},useLink:xw,setup(f,{slots:v}){const I=Gf(xw(f)),{options:P}=ro(C_),k=Ps(()=>({[ww(f.activeClass,P.linkActiveClass,"router-link-active")]:I.isActive,[ww(f.exactActiveClass,P.linkExactActiveClass,"router-link-exact-active")]:I.isExactActive}));return()=>{const j=v.default&&E3(v.default(I));return f.custom?j:R2("a",{"aria-current":I.isExactActive?f.ariaCurrentValue:null,href:I.href,onClick:I.navigate,class:k.value},j)}}}),A3=M3;function I3(f){if(!(f.metaKey||f.altKey||f.ctrlKey||f.shiftKey)&&!f.defaultPrevented&&!(f.button!==void 0&&f.button!==0)){if(f.currentTarget&&f.currentTarget.getAttribute){const v=f.currentTarget.getAttribute("target");if(/\b_blank\b/i.test(v))return}return f.preventDefault&&f.preventDefault(),!0}}function C3(f,v){for(const I in v){const P=v[I],k=f[I];if(typeof P=="string"){if(P!==k)return!1}else if(!Ro(k)||k.length!==P.length||P.some((j,$)=>j!==k[$]))return!1}return!0}function bw(f){return f?f.aliasOf?f.aliasOf.path:f.path:""}const ww=(f,v,I)=>f??v??I,P3=n2({name:"RouterView",inheritAttrs:!1,props:{name:{type:String,default:"default"},route:Object},compatConfig:{MODE:3},setup(f,{attrs:v,slots:I}){const P=ro(hv),k=Ps(()=>f.route||P.value),j=ro(vw,0),$=Ps(()=>{let de=Aa(j);const{matched:ae}=k.value;let Te;for(;(Te=ae[de])&&!Te.components;)de++;return de}),s=Ps(()=>k.value.matched[$.value]);jm(vw,Ps(()=>$.value+1)),jm(S3,s),jm(hv,k);const Q=Oi();return dh(()=>[Q.value,s.value,f.name],([de,ae,Te],[Ne,Re,Ze])=>{ae&&(ae.instances[Te]=de,Re&&Re!==ae&&de&&de===Ne&&(ae.leaveGuards.size||(ae.leaveGuards=Re.leaveGuards),ae.updateGuards.size||(ae.updateGuards=Re.updateGuards))),de&&ae&&(!Re||!gh(ae,Re)||!Ne)&&(ae.enterCallbacks[Te]||[]).forEach(et=>et(de))},{flush:"post"}),()=>{const de=k.value,ae=f.name,Te=s.value,Ne=Te&&Te.components[ae];if(!Ne)return Tw(I.default,{Component:Ne,route:de});const Re=Te.props[ae],Ze=Re?Re===!0?de.params:typeof Re=="function"?Re(de):Re:null,ft=R2(Ne,zr({},Ze,v,{onVnodeUnmounted:vt=>{vt.component.isUnmounted&&(Te.instances[ae]=null)},ref:Q}));return Tw(I.default,{Component:ft,route:de})||ft}}});function Tw(f,v){if(!f)return null;const I=f(v);return I.length===1?I[0]:I}const R3=P3;function D3(f){const v=g3(f.routes,f),I=f.parseQuery||w3,P=f.stringifyQuery||yw,k=f.history,j=wf(),$=wf(),s=wf(),Q=tA(Il);let de=Il;lh&&f.scrollBehavior&&"scrollRestoration"in history&&(history.scrollRestoration="manual");const ae=jy.bind(null,mt=>""+mt),Te=jy.bind(null,qP),Ne=jy.bind(null,Vf);function Re(mt,Qt){let Kt,J;return _T(mt)?(Kt=v.getRecordMatcher(mt),J=Qt):J=mt,v.addRoute(J,Kt)}function Ze(mt){const Qt=v.getRecordMatcher(mt);Qt&&v.removeRoute(Qt)}function et(){return v.getRoutes().map(mt=>mt.record)}function ft(mt){return!!v.getRecordMatcher(mt)}function vt(mt,Qt){if(Qt=zr({},Qt||Q.value),typeof mt=="string"){const we=Gy(I,mt,Qt.path),bt=v.resolve({path:we.path},Qt),Tt=k.createHref(we.fullPath);return zr(we,bt,{params:Ne(bt.params),hash:Vf(we.hash),redirectedFrom:void 0,href:Tt})}let Kt;if(mt.path!=null)Kt=zr({},mt,{path:Gy(I,mt.path,Qt.path).path});else{const we=zr({},mt.params);for(const bt in we)we[bt]==null&&delete we[bt];Kt=zr({},mt,{params:Te(we)}),Qt.params=Te(Qt.params)}const J=v.resolve(Kt,Qt),pr=mt.hash||"";J.params=ae(Ne(J.params));const ze=ZP(P,zr({},mt,{hash:UP(pr),path:J.path})),Be=k.createHref(ze);return zr({fullPath:ze,hash:pr,query:P===yw?T3(mt.query):mt.query||{}},J,{redirectedFrom:void 0,href:Be})}function gt(mt){return typeof mt=="string"?Gy(I,mt,Q.value.path):zr({},mt)}function Vt(mt,Qt){if(de!==mt)return yh(8,{from:Qt,to:mt})}function pt(mt){return Pt(mt)}function ui(mt){return pt(zr(gt(mt),{replace:!0}))}function zi(mt){const Qt=mt.matched[mt.matched.length-1];if(Qt&&Qt.redirect){const{redirect:Kt}=Qt;let J=typeof Kt=="function"?Kt(mt):Kt;return typeof J=="string"&&(J=J.includes("?")||J.includes("#")?J=gt(J):{path:J},J.params={}),zr({query:mt.query,hash:mt.hash,params:J.path!=null?{}:mt.params},J)}}function Pt(mt,Qt){const Kt=de=vt(mt),J=Q.value,pr=mt.state,ze=mt.force,Be=mt.replace===!0,we=zi(Kt);if(we)return Pt(zr(gt(we),{state:typeof we=="object"?zr({},pr,we.state):pr,force:ze,replace:Be}),Qt||Kt);const bt=Kt;bt.redirectedFrom=Qt;let Tt;return!ze&&WP(P,J,Kt)&&(Tt=yh(16,{to:bt,from:J}),Bt(J,J,!0,!1)),(Tt?Promise.resolve(Tt):st(bt,J)).catch(St=>Ta(St)?Ta(St,2)?St:Ti(St):nr(St,bt,J)).then(St=>{if(St){if(Ta(St,2))return Pt(zr({replace:Be},gt(St.to),{state:typeof St.to=="object"?zr({},pr,St.to.state):pr,force:ze}),Qt||bt)}else St=ji(bt,J,!0,Be,pr);return zt(bt,J,St),St})}function di(mt,Qt){const Kt=Vt(mt,Qt);return Kt?Promise.reject(Kt):Promise.resolve()}function jt(mt){const Qt=qr.values().next().value;return Qt&&typeof Qt.runWithContext=="function"?Qt.runWithContext(mt):mt()}function st(mt,Qt){let Kt;const[J,pr,ze]=z3(mt,Qt);Kt=qy(J.reverse(),"beforeRouteLeave",mt,Qt);for(const we of J)we.leaveGuards.forEach(bt=>{Kt.push(Dl(bt,mt,Qt))});const Be=di.bind(null,mt,Qt);return Kt.push(Be),fr(Kt).then(()=>{Kt=[];for(const we of j.list())Kt.push(Dl(we,mt,Qt));return Kt.push(Be),fr(Kt)}).then(()=>{Kt=qy(pr,"beforeRouteUpdate",mt,Qt);for(const we of pr)we.updateGuards.forEach(bt=>{Kt.push(Dl(bt,mt,Qt))});return Kt.push(Be),fr(Kt)}).then(()=>{Kt=[];for(const we of ze)if(we.beforeEnter)if(Ro(we.beforeEnter))for(const bt of we.beforeEnter)Kt.push(Dl(bt,mt,Qt));else Kt.push(Dl(we.beforeEnter,mt,Qt));return Kt.push(Be),fr(Kt)}).then(()=>(mt.matched.forEach(we=>we.enterCallbacks={}),Kt=qy(ze,"beforeRouteEnter",mt,Qt,jt),Kt.push(Be),fr(Kt))).then(()=>{Kt=[];for(const we of $.list())Kt.push(Dl(we,mt,Qt));return Kt.push(Be),fr(Kt)}).catch(we=>Ta(we,8)?we:Promise.reject(we))}function zt(mt,Qt,Kt){s.list().forEach(J=>jt(()=>J(mt,Qt,Kt)))}function ji(mt,Qt,Kt,J,pr){const ze=Vt(mt,Qt);if(ze)return ze;const Be=Qt===Il,we=lh?history.state:{};Kt&&(J||Be?k.replace(mt.fullPath,zr({scroll:Be&&we&&we.scroll},pr)):k.push(mt.fullPath,pr)),Q.value=mt,Bt(mt,Qt,Kt,Be),Ti()}let Ci;function Fr(){Ci||(Ci=k.listen((mt,Qt,Kt)=>{if(!yn.listening)return;const J=vt(mt),pr=zi(J);if(pr){Pt(zr(pr,{replace:!0,force:!0}),J).catch(Rf);return}de=J;const ze=Q.value;lh&&i3(cw(ze.fullPath,Kt.delta),I_()),st(J,ze).catch(Be=>Ta(Be,12)?Be:Ta(Be,2)?(Pt(zr(gt(Be.to),{force:!0}),J).then(we=>{Ta(we,20)&&!Kt.delta&&Kt.type===Uf.pop&&k.go(-1,!1)}).catch(Rf),Promise.reject()):(Kt.delta&&k.go(-Kt.delta,!1),nr(Be,J,ze))).then(Be=>{Be=Be||ji(J,ze,!1),Be&&(Kt.delta&&!Ta(Be,8)?k.go(-Kt.delta,!1):Kt.type===Uf.pop&&Ta(Be,20)&&k.go(-1,!1)),zt(J,ze,Be)}).catch(Rf)}))}let oi=wf(),Yi=wf(),bi;function nr(mt,Qt,Kt){Ti(mt);const J=Yi.list();return J.length?J.forEach(pr=>pr(mt,Qt,Kt)):console.error(mt),Promise.reject(mt)}function hi(){return bi&&Q.value!==Il?Promise.resolve():new Promise((mt,Qt)=>{oi.add([mt,Qt])})}function Ti(mt){return bi||(bi=!mt,Fr(),oi.list().forEach(([Qt,Kt])=>mt?Kt(mt):Qt()),oi.reset()),mt}function Bt(mt,Qt,Kt,J){const{scrollBehavior:pr}=f;if(!lh||!pr)return Promise.resolve();const ze=!Kt&&r3(cw(mt.fullPath,0))||(J||!Kt)&&history.state&&history.state.scroll||null;return $f().then(()=>pr(mt,Qt,ze)).then(Be=>Be&&t3(Be)).catch(Be=>nr(Be,mt,Qt))}const gi=mt=>k.go(mt);let Zt;const qr=new Set,yn={currentRoute:Q,listening:!0,addRoute:Re,removeRoute:Ze,clearRoutes:v.clearRoutes,hasRoute:ft,getRoutes:et,resolve:vt,options:f,push:pt,replace:ui,go:gi,back:()=>gi(-1),forward:()=>gi(1),beforeEach:j.add,beforeResolve:$.add,afterEach:s.add,onError:Yi.add,isReady:hi,install(mt){const Qt=this;mt.component("RouterLink",A3),mt.component("RouterView",R3),mt.config.globalProperties.$router=Qt,Object.defineProperty(mt.config.globalProperties,"$route",{enumerable:!0,get:()=>Aa(Q)}),lh&&!Zt&&Q.value===Il&&(Zt=!0,pt(k.location).catch(pr=>{}));const Kt={};for(const pr in Il)Object.defineProperty(Kt,pr,{get:()=>Q.value[pr],enumerable:!0});mt.provide(C_,Qt),mt.provide(zv,Xw(Kt)),mt.provide(hv,Q);const J=mt.unmount;qr.add(mt),mt.unmount=function(){qr.delete(mt),qr.size<1&&(de=Il,Ci&&Ci(),Ci=null,Q.value=Il,Zt=!1,bi=!1),J()}}};function fr(mt){return mt.reduce((Qt,Kt)=>Qt.then(()=>jt(Kt)),Promise.resolve())}return yn}function z3(f,v){const I=[],P=[],k=[],j=Math.max(v.matched.length,f.matched.length);for(let $=0;$<j;$++){const s=v.matched[$];s&&(f.matched.find(de=>gh(de,s))?P.push(s):I.push(s));const Q=f.matched[$];Q&&(v.matched.find(de=>gh(de,Q))||k.push(Q))}return[I,P,k]}function Lv(){return ro(C_)}function L3(f){return ro(zv)}const na=(f,v)=>{const I=f.__vccOpts||f;for(const[P,k]of v)I[P]=k;return I},O3={class:"main-view"},k3={class:"search-section"},F3={class:"input-group"},B3={__name:"MainView",setup(f){const v=Oi(""),I=Oi(""),P=async()=>{if(v.value&&I.value)try{const k=localStorage.getItem("token"),j={params:{startLocation:v.value,endLocation:I.value}};k&&(j.headers={Authorization:`Bearer ${k}`});const $=await Wr.get("/route/search",j),s=Array.isArray($.data)?$.data[0]:$.data;s!=null&&s.id?(await ph.push({name:"RouteDetails",params:{routeId:s.id}}),v.value="",I.value=""):alert("  .")}catch(k){console.error(k),alert("   .  .")}else alert(",   .")};return(k,j)=>(ki(),Vi("div",O3,[j[4]||(j[4]=Pe("header",{class:"header"},[Pe("h1",{class:"title"},"RouteMate"),Pe("p",{class:"subtitle"},"     ")],-1)),Pe("section",k3,[j[3]||(j[3]=Pe("h2",null," ",-1)),Pe("div",F3,[Dn(Pe("input",{"onUpdate:modelValue":j[0]||(j[0]=$=>v.value=$),type:"text",placeholder:"  (  )",class:"input"},null,512),[[Bn,v.value]]),Dn(Pe("input",{"onUpdate:modelValue":j[1]||(j[1]=$=>I.value=$),type:"text",placeholder:"  (  )",class:"input"},null,512),[[Bn,I.value]]),Pe("button",{onClick:P,class:"btn-search"},j[2]||(j[2]=[ra("   "),Pe("span",{class:"icon"},"",-1)]))])]),j[5]||(j[5]=cI('<section class="features" data-v-de97f392><h2 data-v-de97f392> </h2><div class="features-grid" data-v-de97f392><div class="feature-card" data-v-de97f392><div class="feature-icon" data-v-de97f392></div><h3 data-v-de97f392> </h3><p data-v-de97f392>      </p></div><div class="feature-card" data-v-de97f392><div class="feature-icon" data-v-de97f392></div><h3 data-v-de97f392> </h3><p data-v-de97f392>        </p></div><div class="feature-card" data-v-de97f392><div class="feature-icon" data-v-de97f392></div><h3 data-v-de97f392></h3><p data-v-de97f392>       </p></div></div></section><section class="about" data-v-de97f392><h2 data-v-de97f392> </h2><p data-v-de97f392>RouteMate -     ,         .         .</p><p data-v-de97f392>      !</p></section><footer class="footer" data-v-de97f392><p data-v-de97f392> 2025 RouteMate.   .</p><div class="footer-links" data-v-de97f392><a href="#" data-v-de97f392> </a><a href="#" data-v-de97f392> </a><a href="#" data-v-de97f392></a></div></footer><div class="main-decoration" data-v-de97f392><div class="main-circle circle-1" data-v-de97f392></div><div class="main-circle circle-2" data-v-de97f392></div></div>',4))]))}},N3=na(B3,[["__scopeId","data-v-de97f392"]]);function V3(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}var Xm={exports:{}},U3=Xm.exports,Sw;function j3(){return Sw||(Sw=1,function(f,v){(function(I,P){f.exports=P()})(U3,function(){var I,P,k;function j(s,Q){if(!I)I=Q;else if(!P)P=Q;else{var de="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+I+")(sharedChunk); ("+P+")(sharedChunk); self.onerror = null;",ae={};I(ae),k=Q(ae),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(k.workerUrl=window.URL.createObjectURL(new Blob([de],{type:"text/javascript"})))}}j(["exports"],function(s){function Q(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var de,ae={},Te={};function Ne(){if(de)return Te;de=1,Object.defineProperty(Te,"__esModule",{value:!0}),Te.setMatrixArrayType=function(l){Te.ARRAY_TYPE=e=l},Te.toRadian=function(l){return l*o},Te.equals=function(l,a){return Math.abs(l-a)<=n*Math.max(1,Math.abs(l),Math.abs(a))},Te.RANDOM=Te.ARRAY_TYPE=Te.EPSILON=void 0;var n=1e-6;Te.EPSILON=n;var e=typeof Float32Array<"u"?Float32Array:Array;Te.ARRAY_TYPE=e;var i=Math.random;Te.RANDOM=i;var o=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var l=0,a=arguments.length;a--;)l+=arguments[a]*arguments[a];return Math.sqrt(l)}),Te}var Re,Ze={};function et(){if(Re)return Ze;function n(a){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(h){return typeof h}:function(h){return h&&typeof Symbol=="function"&&h.constructor===Symbol&&h!==Symbol.prototype?"symbol":typeof h},n(a)}Re=1,Object.defineProperty(Ze,"__esModule",{value:!0}),Ze.create=function(){var a=new e.ARRAY_TYPE(4);return e.ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0),a[0]=1,a[3]=1,a},Ze.clone=function(a){var h=new e.ARRAY_TYPE(4);return h[0]=a[0],h[1]=a[1],h[2]=a[2],h[3]=a[3],h},Ze.copy=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=h[3],a},Ze.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},Ze.fromValues=function(a,h,_,y){var w=new e.ARRAY_TYPE(4);return w[0]=a,w[1]=h,w[2]=_,w[3]=y,w},Ze.set=function(a,h,_,y,w){return a[0]=h,a[1]=_,a[2]=y,a[3]=w,a},Ze.transpose=function(a,h){if(a===h){var _=h[1];a[1]=h[2],a[2]=_}else a[0]=h[0],a[1]=h[2],a[2]=h[1],a[3]=h[3];return a},Ze.invert=function(a,h){var _=h[0],y=h[1],w=h[2],p=h[3],x=_*p-w*y;return x?(a[0]=p*(x=1/x),a[1]=-y*x,a[2]=-w*x,a[3]=_*x,a):null},Ze.adjoint=function(a,h){var _=h[0];return a[0]=h[3],a[1]=-h[1],a[2]=-h[2],a[3]=_,a},Ze.determinant=function(a){return a[0]*a[3]-a[2]*a[1]},Ze.multiply=o,Ze.rotate=function(a,h,_){var y=h[0],w=h[1],p=h[2],x=h[3],S=Math.sin(_),b=Math.cos(_);return a[0]=y*b+p*S,a[1]=w*b+x*S,a[2]=y*-S+p*b,a[3]=w*-S+x*b,a},Ze.scale=function(a,h,_){var y=h[1],w=h[2],p=h[3],x=_[0],S=_[1];return a[0]=h[0]*x,a[1]=y*x,a[2]=w*S,a[3]=p*S,a},Ze.fromRotation=function(a,h){var _=Math.sin(h),y=Math.cos(h);return a[0]=y,a[1]=_,a[2]=-_,a[3]=y,a},Ze.fromScaling=function(a,h){return a[0]=h[0],a[1]=0,a[2]=0,a[3]=h[1],a},Ze.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},Ze.frob=function(a){return Math.hypot(a[0],a[1],a[2],a[3])},Ze.LDU=function(a,h,_,y){return a[2]=y[2]/y[0],_[0]=y[0],_[1]=y[1],_[3]=y[3]-a[2]*_[1],[a,h,_]},Ze.add=function(a,h,_){return a[0]=h[0]+_[0],a[1]=h[1]+_[1],a[2]=h[2]+_[2],a[3]=h[3]+_[3],a},Ze.subtract=l,Ze.exactEquals=function(a,h){return a[0]===h[0]&&a[1]===h[1]&&a[2]===h[2]&&a[3]===h[3]},Ze.equals=function(a,h){var _=a[0],y=a[1],w=a[2],p=a[3],x=h[0],S=h[1],b=h[2],T=h[3];return Math.abs(_-x)<=e.EPSILON*Math.max(1,Math.abs(_),Math.abs(x))&&Math.abs(y-S)<=e.EPSILON*Math.max(1,Math.abs(y),Math.abs(S))&&Math.abs(w-b)<=e.EPSILON*Math.max(1,Math.abs(w),Math.abs(b))&&Math.abs(p-T)<=e.EPSILON*Math.max(1,Math.abs(p),Math.abs(T))},Ze.multiplyScalar=function(a,h,_){return a[0]=h[0]*_,a[1]=h[1]*_,a[2]=h[2]*_,a[3]=h[3]*_,a},Ze.multiplyScalarAndAdd=function(a,h,_,y){return a[0]=h[0]+_[0]*y,a[1]=h[1]+_[1]*y,a[2]=h[2]+_[2]*y,a[3]=h[3]+_[3]*y,a},Ze.sub=Ze.mul=void 0;var e=function(a,h){if(a&&a.__esModule)return a;if(a===null||n(a)!=="object"&&typeof a!="function")return{default:a};var _=i(void 0);if(_&&_.has(a))return _.get(a);var y={},w=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var p in a)if(p!=="default"&&Object.prototype.hasOwnProperty.call(a,p)){var x=w?Object.getOwnPropertyDescriptor(a,p):null;x&&(x.get||x.set)?Object.defineProperty(y,p,x):y[p]=a[p]}return y.default=a,_&&_.set(a,y),y}(Ne());function i(a){if(typeof WeakMap!="function")return null;var h=new WeakMap,_=new WeakMap;return(i=function(y){return y?_:h})(a)}function o(a,h,_){var y=h[0],w=h[1],p=h[2],x=h[3],S=_[0],b=_[1],T=_[2],M=_[3];return a[0]=y*S+p*b,a[1]=w*S+x*b,a[2]=y*T+p*M,a[3]=w*T+x*M,a}function l(a,h,_){return a[0]=h[0]-_[0],a[1]=h[1]-_[1],a[2]=h[2]-_[2],a[3]=h[3]-_[3],a}return Ze.mul=o,Ze.sub=l,Ze}var ft,vt={};function gt(){if(ft)return vt;function n(a){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(h){return typeof h}:function(h){return h&&typeof Symbol=="function"&&h.constructor===Symbol&&h!==Symbol.prototype?"symbol":typeof h},n(a)}ft=1,Object.defineProperty(vt,"__esModule",{value:!0}),vt.create=function(){var a=new e.ARRAY_TYPE(6);return e.ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0,a[4]=0,a[5]=0),a[0]=1,a[3]=1,a},vt.clone=function(a){var h=new e.ARRAY_TYPE(6);return h[0]=a[0],h[1]=a[1],h[2]=a[2],h[3]=a[3],h[4]=a[4],h[5]=a[5],h},vt.copy=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=h[3],a[4]=h[4],a[5]=h[5],a},vt.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},vt.fromValues=function(a,h,_,y,w,p){var x=new e.ARRAY_TYPE(6);return x[0]=a,x[1]=h,x[2]=_,x[3]=y,x[4]=w,x[5]=p,x},vt.set=function(a,h,_,y,w,p,x){return a[0]=h,a[1]=_,a[2]=y,a[3]=w,a[4]=p,a[5]=x,a},vt.invert=function(a,h){var _=h[0],y=h[1],w=h[2],p=h[3],x=h[4],S=h[5],b=_*p-y*w;return b?(a[0]=p*(b=1/b),a[1]=-y*b,a[2]=-w*b,a[3]=_*b,a[4]=(w*S-p*x)*b,a[5]=(y*x-_*S)*b,a):null},vt.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},vt.multiply=o,vt.rotate=function(a,h,_){var y=h[0],w=h[1],p=h[2],x=h[3],S=h[4],b=h[5],T=Math.sin(_),M=Math.cos(_);return a[0]=y*M+p*T,a[1]=w*M+x*T,a[2]=y*-T+p*M,a[3]=w*-T+x*M,a[4]=S,a[5]=b,a},vt.scale=function(a,h,_){var y=h[1],w=h[2],p=h[3],x=h[4],S=h[5],b=_[0],T=_[1];return a[0]=h[0]*b,a[1]=y*b,a[2]=w*T,a[3]=p*T,a[4]=x,a[5]=S,a},vt.translate=function(a,h,_){var y=h[0],w=h[1],p=h[2],x=h[3],S=h[4],b=h[5],T=_[0],M=_[1];return a[0]=y,a[1]=w,a[2]=p,a[3]=x,a[4]=y*T+p*M+S,a[5]=w*T+x*M+b,a},vt.fromRotation=function(a,h){var _=Math.sin(h),y=Math.cos(h);return a[0]=y,a[1]=_,a[2]=-_,a[3]=y,a[4]=0,a[5]=0,a},vt.fromScaling=function(a,h){return a[0]=h[0],a[1]=0,a[2]=0,a[3]=h[1],a[4]=0,a[5]=0,a},vt.fromTranslation=function(a,h){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=h[0],a[5]=h[1],a},vt.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"},vt.frob=function(a){return Math.hypot(a[0],a[1],a[2],a[3],a[4],a[5],1)},vt.add=function(a,h,_){return a[0]=h[0]+_[0],a[1]=h[1]+_[1],a[2]=h[2]+_[2],a[3]=h[3]+_[3],a[4]=h[4]+_[4],a[5]=h[5]+_[5],a},vt.subtract=l,vt.multiplyScalar=function(a,h,_){return a[0]=h[0]*_,a[1]=h[1]*_,a[2]=h[2]*_,a[3]=h[3]*_,a[4]=h[4]*_,a[5]=h[5]*_,a},vt.multiplyScalarAndAdd=function(a,h,_,y){return a[0]=h[0]+_[0]*y,a[1]=h[1]+_[1]*y,a[2]=h[2]+_[2]*y,a[3]=h[3]+_[3]*y,a[4]=h[4]+_[4]*y,a[5]=h[5]+_[5]*y,a},vt.exactEquals=function(a,h){return a[0]===h[0]&&a[1]===h[1]&&a[2]===h[2]&&a[3]===h[3]&&a[4]===h[4]&&a[5]===h[5]},vt.equals=function(a,h){var _=a[0],y=a[1],w=a[2],p=a[3],x=a[4],S=a[5],b=h[0],T=h[1],M=h[2],D=h[3],z=h[4],N=h[5];return Math.abs(_-b)<=e.EPSILON*Math.max(1,Math.abs(_),Math.abs(b))&&Math.abs(y-T)<=e.EPSILON*Math.max(1,Math.abs(y),Math.abs(T))&&Math.abs(w-M)<=e.EPSILON*Math.max(1,Math.abs(w),Math.abs(M))&&Math.abs(p-D)<=e.EPSILON*Math.max(1,Math.abs(p),Math.abs(D))&&Math.abs(x-z)<=e.EPSILON*Math.max(1,Math.abs(x),Math.abs(z))&&Math.abs(S-N)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(N))},vt.sub=vt.mul=void 0;var e=function(a,h){if(a&&a.__esModule)return a;if(a===null||n(a)!=="object"&&typeof a!="function")return{default:a};var _=i(void 0);if(_&&_.has(a))return _.get(a);var y={},w=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var p in a)if(p!=="default"&&Object.prototype.hasOwnProperty.call(a,p)){var x=w?Object.getOwnPropertyDescriptor(a,p):null;x&&(x.get||x.set)?Object.defineProperty(y,p,x):y[p]=a[p]}return y.default=a,_&&_.set(a,y),y}(Ne());function i(a){if(typeof WeakMap!="function")return null;var h=new WeakMap,_=new WeakMap;return(i=function(y){return y?_:h})(a)}function o(a,h,_){var y=h[0],w=h[1],p=h[2],x=h[3],S=h[4],b=h[5],T=_[0],M=_[1],D=_[2],z=_[3],N=_[4],B=_[5];return a[0]=y*T+p*M,a[1]=w*T+x*M,a[2]=y*D+p*z,a[3]=w*D+x*z,a[4]=y*N+p*B+S,a[5]=w*N+x*B+b,a}function l(a,h,_){return a[0]=h[0]-_[0],a[1]=h[1]-_[1],a[2]=h[2]-_[2],a[3]=h[3]-_[3],a[4]=h[4]-_[4],a[5]=h[5]-_[5],a}return vt.mul=o,vt.sub=l,vt}var Vt,pt={};function ui(){if(Vt)return pt;function n(a){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(h){return typeof h}:function(h){return h&&typeof Symbol=="function"&&h.constructor===Symbol&&h!==Symbol.prototype?"symbol":typeof h},n(a)}Vt=1,Object.defineProperty(pt,"__esModule",{value:!0}),pt.create=function(){var a=new e.ARRAY_TYPE(9);return e.ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0,a[3]=0,a[5]=0,a[6]=0,a[7]=0),a[0]=1,a[4]=1,a[8]=1,a},pt.fromMat4=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=h[4],a[4]=h[5],a[5]=h[6],a[6]=h[8],a[7]=h[9],a[8]=h[10],a},pt.clone=function(a){var h=new e.ARRAY_TYPE(9);return h[0]=a[0],h[1]=a[1],h[2]=a[2],h[3]=a[3],h[4]=a[4],h[5]=a[5],h[6]=a[6],h[7]=a[7],h[8]=a[8],h},pt.copy=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=h[3],a[4]=h[4],a[5]=h[5],a[6]=h[6],a[7]=h[7],a[8]=h[8],a},pt.fromValues=function(a,h,_,y,w,p,x,S,b){var T=new e.ARRAY_TYPE(9);return T[0]=a,T[1]=h,T[2]=_,T[3]=y,T[4]=w,T[5]=p,T[6]=x,T[7]=S,T[8]=b,T},pt.set=function(a,h,_,y,w,p,x,S,b,T){return a[0]=h,a[1]=_,a[2]=y,a[3]=w,a[4]=p,a[5]=x,a[6]=S,a[7]=b,a[8]=T,a},pt.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},pt.transpose=function(a,h){if(a===h){var _=h[1],y=h[2],w=h[5];a[1]=h[3],a[2]=h[6],a[3]=_,a[5]=h[7],a[6]=y,a[7]=w}else a[0]=h[0],a[1]=h[3],a[2]=h[6],a[3]=h[1],a[4]=h[4],a[5]=h[7],a[6]=h[2],a[7]=h[5],a[8]=h[8];return a},pt.invert=function(a,h){var _=h[0],y=h[1],w=h[2],p=h[3],x=h[4],S=h[5],b=h[6],T=h[7],M=h[8],D=M*x-S*T,z=-M*p+S*b,N=T*p-x*b,B=_*D+y*z+w*N;return B?(a[0]=D*(B=1/B),a[1]=(-M*y+w*T)*B,a[2]=(S*y-w*x)*B,a[3]=z*B,a[4]=(M*_-w*b)*B,a[5]=(-S*_+w*p)*B,a[6]=N*B,a[7]=(-T*_+y*b)*B,a[8]=(x*_-y*p)*B,a):null},pt.adjoint=function(a,h){var _=h[0],y=h[1],w=h[2],p=h[3],x=h[4],S=h[5],b=h[6],T=h[7],M=h[8];return a[0]=x*M-S*T,a[1]=w*T-y*M,a[2]=y*S-w*x,a[3]=S*b-p*M,a[4]=_*M-w*b,a[5]=w*p-_*S,a[6]=p*T-x*b,a[7]=y*b-_*T,a[8]=_*x-y*p,a},pt.determinant=function(a){var h=a[3],_=a[4],y=a[5],w=a[6],p=a[7],x=a[8];return a[0]*(x*_-y*p)+a[1]*(-x*h+y*w)+a[2]*(p*h-_*w)},pt.multiply=o,pt.translate=function(a,h,_){var y=h[0],w=h[1],p=h[2],x=h[3],S=h[4],b=h[5],T=h[6],M=h[7],D=h[8],z=_[0],N=_[1];return a[0]=y,a[1]=w,a[2]=p,a[3]=x,a[4]=S,a[5]=b,a[6]=z*y+N*x+T,a[7]=z*w+N*S+M,a[8]=z*p+N*b+D,a},pt.rotate=function(a,h,_){var y=h[0],w=h[1],p=h[2],x=h[3],S=h[4],b=h[5],T=h[6],M=h[7],D=h[8],z=Math.sin(_),N=Math.cos(_);return a[0]=N*y+z*x,a[1]=N*w+z*S,a[2]=N*p+z*b,a[3]=N*x-z*y,a[4]=N*S-z*w,a[5]=N*b-z*p,a[6]=T,a[7]=M,a[8]=D,a},pt.scale=function(a,h,_){var y=_[0],w=_[1];return a[0]=y*h[0],a[1]=y*h[1],a[2]=y*h[2],a[3]=w*h[3],a[4]=w*h[4],a[5]=w*h[5],a[6]=h[6],a[7]=h[7],a[8]=h[8],a},pt.fromTranslation=function(a,h){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=h[0],a[7]=h[1],a[8]=1,a},pt.fromRotation=function(a,h){var _=Math.sin(h),y=Math.cos(h);return a[0]=y,a[1]=_,a[2]=0,a[3]=-_,a[4]=y,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},pt.fromScaling=function(a,h){return a[0]=h[0],a[1]=0,a[2]=0,a[3]=0,a[4]=h[1],a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},pt.fromMat2d=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=0,a[3]=h[2],a[4]=h[3],a[5]=0,a[6]=h[4],a[7]=h[5],a[8]=1,a},pt.fromQuat=function(a,h){var _=h[0],y=h[1],w=h[2],p=h[3],x=_+_,S=y+y,b=w+w,T=_*x,M=y*x,D=y*S,z=w*x,N=w*S,B=w*b,F=p*x,U=p*S,q=p*b;return a[0]=1-D-B,a[3]=M-q,a[6]=z+U,a[1]=M+q,a[4]=1-T-B,a[7]=N-F,a[2]=z-U,a[5]=N+F,a[8]=1-T-D,a},pt.normalFromMat4=function(a,h){var _=h[0],y=h[1],w=h[2],p=h[3],x=h[4],S=h[5],b=h[6],T=h[7],M=h[8],D=h[9],z=h[10],N=h[11],B=h[12],F=h[13],U=h[14],q=h[15],Z=_*S-y*x,re=_*b-w*x,ee=_*T-p*x,te=y*b-w*S,pe=y*T-p*S,ne=w*T-p*b,me=M*F-D*B,be=M*U-z*B,ve=M*q-N*B,Me=D*U-z*F,Ee=D*q-N*F,Oe=z*q-N*U,Ce=Z*Oe-re*Ee+ee*Me+te*ve-pe*be+ne*me;return Ce?(a[0]=(S*Oe-b*Ee+T*Me)*(Ce=1/Ce),a[1]=(b*ve-x*Oe-T*be)*Ce,a[2]=(x*Ee-S*ve+T*me)*Ce,a[3]=(w*Ee-y*Oe-p*Me)*Ce,a[4]=(_*Oe-w*ve+p*be)*Ce,a[5]=(y*ve-_*Ee-p*me)*Ce,a[6]=(F*ne-U*pe+q*te)*Ce,a[7]=(U*ee-B*ne-q*re)*Ce,a[8]=(B*pe-F*ee+q*Z)*Ce,a):null},pt.projection=function(a,h,_){return a[0]=2/h,a[1]=0,a[2]=0,a[3]=0,a[4]=-2/_,a[5]=0,a[6]=-1,a[7]=1,a[8]=1,a},pt.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"},pt.frob=function(a){return Math.hypot(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},pt.add=function(a,h,_){return a[0]=h[0]+_[0],a[1]=h[1]+_[1],a[2]=h[2]+_[2],a[3]=h[3]+_[3],a[4]=h[4]+_[4],a[5]=h[5]+_[5],a[6]=h[6]+_[6],a[7]=h[7]+_[7],a[8]=h[8]+_[8],a},pt.subtract=l,pt.multiplyScalar=function(a,h,_){return a[0]=h[0]*_,a[1]=h[1]*_,a[2]=h[2]*_,a[3]=h[3]*_,a[4]=h[4]*_,a[5]=h[5]*_,a[6]=h[6]*_,a[7]=h[7]*_,a[8]=h[8]*_,a},pt.multiplyScalarAndAdd=function(a,h,_,y){return a[0]=h[0]+_[0]*y,a[1]=h[1]+_[1]*y,a[2]=h[2]+_[2]*y,a[3]=h[3]+_[3]*y,a[4]=h[4]+_[4]*y,a[5]=h[5]+_[5]*y,a[6]=h[6]+_[6]*y,a[7]=h[7]+_[7]*y,a[8]=h[8]+_[8]*y,a},pt.exactEquals=function(a,h){return a[0]===h[0]&&a[1]===h[1]&&a[2]===h[2]&&a[3]===h[3]&&a[4]===h[4]&&a[5]===h[5]&&a[6]===h[6]&&a[7]===h[7]&&a[8]===h[8]},pt.equals=function(a,h){var _=a[0],y=a[1],w=a[2],p=a[3],x=a[4],S=a[5],b=a[6],T=a[7],M=a[8],D=h[0],z=h[1],N=h[2],B=h[3],F=h[4],U=h[5],q=h[6],Z=h[7],re=h[8];return Math.abs(_-D)<=e.EPSILON*Math.max(1,Math.abs(_),Math.abs(D))&&Math.abs(y-z)<=e.EPSILON*Math.max(1,Math.abs(y),Math.abs(z))&&Math.abs(w-N)<=e.EPSILON*Math.max(1,Math.abs(w),Math.abs(N))&&Math.abs(p-B)<=e.EPSILON*Math.max(1,Math.abs(p),Math.abs(B))&&Math.abs(x-F)<=e.EPSILON*Math.max(1,Math.abs(x),Math.abs(F))&&Math.abs(S-U)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(U))&&Math.abs(b-q)<=e.EPSILON*Math.max(1,Math.abs(b),Math.abs(q))&&Math.abs(T-Z)<=e.EPSILON*Math.max(1,Math.abs(T),Math.abs(Z))&&Math.abs(M-re)<=e.EPSILON*Math.max(1,Math.abs(M),Math.abs(re))},pt.sub=pt.mul=void 0;var e=function(a,h){if(a&&a.__esModule)return a;if(a===null||n(a)!=="object"&&typeof a!="function")return{default:a};var _=i(void 0);if(_&&_.has(a))return _.get(a);var y={},w=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var p in a)if(p!=="default"&&Object.prototype.hasOwnProperty.call(a,p)){var x=w?Object.getOwnPropertyDescriptor(a,p):null;x&&(x.get||x.set)?Object.defineProperty(y,p,x):y[p]=a[p]}return y.default=a,_&&_.set(a,y),y}(Ne());function i(a){if(typeof WeakMap!="function")return null;var h=new WeakMap,_=new WeakMap;return(i=function(y){return y?_:h})(a)}function o(a,h,_){var y=h[0],w=h[1],p=h[2],x=h[3],S=h[4],b=h[5],T=h[6],M=h[7],D=h[8],z=_[0],N=_[1],B=_[2],F=_[3],U=_[4],q=_[5],Z=_[6],re=_[7],ee=_[8];return a[0]=z*y+N*x+B*T,a[1]=z*w+N*S+B*M,a[2]=z*p+N*b+B*D,a[3]=F*y+U*x+q*T,a[4]=F*w+U*S+q*M,a[5]=F*p+U*b+q*D,a[6]=Z*y+re*x+ee*T,a[7]=Z*w+re*S+ee*M,a[8]=Z*p+re*b+ee*D,a}function l(a,h,_){return a[0]=h[0]-_[0],a[1]=h[1]-_[1],a[2]=h[2]-_[2],a[3]=h[3]-_[3],a[4]=h[4]-_[4],a[5]=h[5]-_[5],a[6]=h[6]-_[6],a[7]=h[7]-_[7],a[8]=h[8]-_[8],a}return pt.mul=o,pt.sub=l,pt}var zi,Pt={};function di(){if(zi)return Pt;function n(p){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(x){return typeof x}:function(x){return x&&typeof Symbol=="function"&&x.constructor===Symbol&&x!==Symbol.prototype?"symbol":typeof x},n(p)}zi=1,Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.create=function(){var p=new e.ARRAY_TYPE(16);return e.ARRAY_TYPE!=Float32Array&&(p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[11]=0,p[12]=0,p[13]=0,p[14]=0),p[0]=1,p[5]=1,p[10]=1,p[15]=1,p},Pt.clone=function(p){var x=new e.ARRAY_TYPE(16);return x[0]=p[0],x[1]=p[1],x[2]=p[2],x[3]=p[3],x[4]=p[4],x[5]=p[5],x[6]=p[6],x[7]=p[7],x[8]=p[8],x[9]=p[9],x[10]=p[10],x[11]=p[11],x[12]=p[12],x[13]=p[13],x[14]=p[14],x[15]=p[15],x},Pt.copy=function(p,x){return p[0]=x[0],p[1]=x[1],p[2]=x[2],p[3]=x[3],p[4]=x[4],p[5]=x[5],p[6]=x[6],p[7]=x[7],p[8]=x[8],p[9]=x[9],p[10]=x[10],p[11]=x[11],p[12]=x[12],p[13]=x[13],p[14]=x[14],p[15]=x[15],p},Pt.fromValues=function(p,x,S,b,T,M,D,z,N,B,F,U,q,Z,re,ee){var te=new e.ARRAY_TYPE(16);return te[0]=p,te[1]=x,te[2]=S,te[3]=b,te[4]=T,te[5]=M,te[6]=D,te[7]=z,te[8]=N,te[9]=B,te[10]=F,te[11]=U,te[12]=q,te[13]=Z,te[14]=re,te[15]=ee,te},Pt.set=function(p,x,S,b,T,M,D,z,N,B,F,U,q,Z,re,ee,te){return p[0]=x,p[1]=S,p[2]=b,p[3]=T,p[4]=M,p[5]=D,p[6]=z,p[7]=N,p[8]=B,p[9]=F,p[10]=U,p[11]=q,p[12]=Z,p[13]=re,p[14]=ee,p[15]=te,p},Pt.identity=o,Pt.transpose=function(p,x){if(p===x){var S=x[1],b=x[2],T=x[3],M=x[6],D=x[7],z=x[11];p[1]=x[4],p[2]=x[8],p[3]=x[12],p[4]=S,p[6]=x[9],p[7]=x[13],p[8]=b,p[9]=M,p[11]=x[14],p[12]=T,p[13]=D,p[14]=z}else p[0]=x[0],p[1]=x[4],p[2]=x[8],p[3]=x[12],p[4]=x[1],p[5]=x[5],p[6]=x[9],p[7]=x[13],p[8]=x[2],p[9]=x[6],p[10]=x[10],p[11]=x[14],p[12]=x[3],p[13]=x[7],p[14]=x[11],p[15]=x[15];return p},Pt.invert=function(p,x){var S=x[0],b=x[1],T=x[2],M=x[3],D=x[4],z=x[5],N=x[6],B=x[7],F=x[8],U=x[9],q=x[10],Z=x[11],re=x[12],ee=x[13],te=x[14],pe=x[15],ne=S*z-b*D,me=S*N-T*D,be=S*B-M*D,ve=b*N-T*z,Me=b*B-M*z,Ee=T*B-M*N,Oe=F*ee-U*re,Ce=F*te-q*re,ke=F*pe-Z*re,rt=U*te-q*ee,tt=U*pe-Z*ee,Ct=q*pe-Z*te,ot=ne*Ct-me*tt+be*rt+ve*ke-Me*Ce+Ee*Oe;return ot?(p[0]=(z*Ct-N*tt+B*rt)*(ot=1/ot),p[1]=(T*tt-b*Ct-M*rt)*ot,p[2]=(ee*Ee-te*Me+pe*ve)*ot,p[3]=(q*Me-U*Ee-Z*ve)*ot,p[4]=(N*ke-D*Ct-B*Ce)*ot,p[5]=(S*Ct-T*ke+M*Ce)*ot,p[6]=(te*be-re*Ee-pe*me)*ot,p[7]=(F*Ee-q*be+Z*me)*ot,p[8]=(D*tt-z*ke+B*Oe)*ot,p[9]=(b*ke-S*tt-M*Oe)*ot,p[10]=(re*Me-ee*be+pe*ne)*ot,p[11]=(U*be-F*Me-Z*ne)*ot,p[12]=(z*Ce-D*rt-N*Oe)*ot,p[13]=(S*rt-b*Ce+T*Oe)*ot,p[14]=(ee*me-re*ve-te*ne)*ot,p[15]=(F*ve-U*me+q*ne)*ot,p):null},Pt.adjoint=function(p,x){var S=x[0],b=x[1],T=x[2],M=x[3],D=x[4],z=x[5],N=x[6],B=x[7],F=x[8],U=x[9],q=x[10],Z=x[11],re=x[12],ee=x[13],te=x[14],pe=x[15];return p[0]=z*(q*pe-Z*te)-U*(N*pe-B*te)+ee*(N*Z-B*q),p[1]=-(b*(q*pe-Z*te)-U*(T*pe-M*te)+ee*(T*Z-M*q)),p[2]=b*(N*pe-B*te)-z*(T*pe-M*te)+ee*(T*B-M*N),p[3]=-(b*(N*Z-B*q)-z*(T*Z-M*q)+U*(T*B-M*N)),p[4]=-(D*(q*pe-Z*te)-F*(N*pe-B*te)+re*(N*Z-B*q)),p[5]=S*(q*pe-Z*te)-F*(T*pe-M*te)+re*(T*Z-M*q),p[6]=-(S*(N*pe-B*te)-D*(T*pe-M*te)+re*(T*B-M*N)),p[7]=S*(N*Z-B*q)-D*(T*Z-M*q)+F*(T*B-M*N),p[8]=D*(U*pe-Z*ee)-F*(z*pe-B*ee)+re*(z*Z-B*U),p[9]=-(S*(U*pe-Z*ee)-F*(b*pe-M*ee)+re*(b*Z-M*U)),p[10]=S*(z*pe-B*ee)-D*(b*pe-M*ee)+re*(b*B-M*z),p[11]=-(S*(z*Z-B*U)-D*(b*Z-M*U)+F*(b*B-M*z)),p[12]=-(D*(U*te-q*ee)-F*(z*te-N*ee)+re*(z*q-N*U)),p[13]=S*(U*te-q*ee)-F*(b*te-T*ee)+re*(b*q-T*U),p[14]=-(S*(z*te-N*ee)-D*(b*te-T*ee)+re*(b*N-T*z)),p[15]=S*(z*q-N*U)-D*(b*q-T*U)+F*(b*N-T*z),p},Pt.determinant=function(p){var x=p[0],S=p[1],b=p[2],T=p[3],M=p[4],D=p[5],z=p[6],N=p[7],B=p[8],F=p[9],U=p[10],q=p[11],Z=p[12],re=p[13],ee=p[14],te=p[15];return(x*D-S*M)*(U*te-q*ee)-(x*z-b*M)*(F*te-q*re)+(x*N-T*M)*(F*ee-U*re)+(S*z-b*D)*(B*te-q*Z)-(S*N-T*D)*(B*ee-U*Z)+(b*N-T*z)*(B*re-F*Z)},Pt.multiply=l,Pt.translate=function(p,x,S){var b,T,M,D,z,N,B,F,U,q,Z,re,ee=S[0],te=S[1],pe=S[2];return x===p?(p[12]=x[0]*ee+x[4]*te+x[8]*pe+x[12],p[13]=x[1]*ee+x[5]*te+x[9]*pe+x[13],p[14]=x[2]*ee+x[6]*te+x[10]*pe+x[14],p[15]=x[3]*ee+x[7]*te+x[11]*pe+x[15]):(T=x[1],M=x[2],D=x[3],z=x[4],N=x[5],B=x[6],F=x[7],U=x[8],q=x[9],Z=x[10],re=x[11],p[0]=b=x[0],p[1]=T,p[2]=M,p[3]=D,p[4]=z,p[5]=N,p[6]=B,p[7]=F,p[8]=U,p[9]=q,p[10]=Z,p[11]=re,p[12]=b*ee+z*te+U*pe+x[12],p[13]=T*ee+N*te+q*pe+x[13],p[14]=M*ee+B*te+Z*pe+x[14],p[15]=D*ee+F*te+re*pe+x[15]),p},Pt.scale=function(p,x,S){var b=S[0],T=S[1],M=S[2];return p[0]=x[0]*b,p[1]=x[1]*b,p[2]=x[2]*b,p[3]=x[3]*b,p[4]=x[4]*T,p[5]=x[5]*T,p[6]=x[6]*T,p[7]=x[7]*T,p[8]=x[8]*M,p[9]=x[9]*M,p[10]=x[10]*M,p[11]=x[11]*M,p[12]=x[12],p[13]=x[13],p[14]=x[14],p[15]=x[15],p},Pt.rotate=function(p,x,S,b){var T,M,D,z,N,B,F,U,q,Z,re,ee,te,pe,ne,me,be,ve,Me,Ee,Oe,Ce,ke,rt,tt=b[0],Ct=b[1],ot=b[2],ut=Math.hypot(tt,Ct,ot);return ut<e.EPSILON?null:(tt*=ut=1/ut,Ct*=ut,ot*=ut,T=Math.sin(S),M=Math.cos(S),N=x[1],B=x[2],F=x[3],q=x[5],Z=x[6],re=x[7],te=x[9],pe=x[10],ne=x[11],me=tt*tt*(D=1-M)+M,Me=tt*Ct*D-ot*T,Ee=Ct*Ct*D+M,Oe=ot*Ct*D+tt*T,Ce=tt*ot*D+Ct*T,ke=Ct*ot*D-tt*T,rt=ot*ot*D+M,p[0]=(z=x[0])*me+(U=x[4])*(be=Ct*tt*D+ot*T)+(ee=x[8])*(ve=ot*tt*D-Ct*T),p[1]=N*me+q*be+te*ve,p[2]=B*me+Z*be+pe*ve,p[3]=F*me+re*be+ne*ve,p[4]=z*Me+U*Ee+ee*Oe,p[5]=N*Me+q*Ee+te*Oe,p[6]=B*Me+Z*Ee+pe*Oe,p[7]=F*Me+re*Ee+ne*Oe,p[8]=z*Ce+U*ke+ee*rt,p[9]=N*Ce+q*ke+te*rt,p[10]=B*Ce+Z*ke+pe*rt,p[11]=F*Ce+re*ke+ne*rt,x!==p&&(p[12]=x[12],p[13]=x[13],p[14]=x[14],p[15]=x[15]),p)},Pt.rotateX=function(p,x,S){var b=Math.sin(S),T=Math.cos(S),M=x[4],D=x[5],z=x[6],N=x[7],B=x[8],F=x[9],U=x[10],q=x[11];return x!==p&&(p[0]=x[0],p[1]=x[1],p[2]=x[2],p[3]=x[3],p[12]=x[12],p[13]=x[13],p[14]=x[14],p[15]=x[15]),p[4]=M*T+B*b,p[5]=D*T+F*b,p[6]=z*T+U*b,p[7]=N*T+q*b,p[8]=B*T-M*b,p[9]=F*T-D*b,p[10]=U*T-z*b,p[11]=q*T-N*b,p},Pt.rotateY=function(p,x,S){var b=Math.sin(S),T=Math.cos(S),M=x[0],D=x[1],z=x[2],N=x[3],B=x[8],F=x[9],U=x[10],q=x[11];return x!==p&&(p[4]=x[4],p[5]=x[5],p[6]=x[6],p[7]=x[7],p[12]=x[12],p[13]=x[13],p[14]=x[14],p[15]=x[15]),p[0]=M*T-B*b,p[1]=D*T-F*b,p[2]=z*T-U*b,p[3]=N*T-q*b,p[8]=M*b+B*T,p[9]=D*b+F*T,p[10]=z*b+U*T,p[11]=N*b+q*T,p},Pt.rotateZ=function(p,x,S){var b=Math.sin(S),T=Math.cos(S),M=x[0],D=x[1],z=x[2],N=x[3],B=x[4],F=x[5],U=x[6],q=x[7];return x!==p&&(p[8]=x[8],p[9]=x[9],p[10]=x[10],p[11]=x[11],p[12]=x[12],p[13]=x[13],p[14]=x[14],p[15]=x[15]),p[0]=M*T+B*b,p[1]=D*T+F*b,p[2]=z*T+U*b,p[3]=N*T+q*b,p[4]=B*T-M*b,p[5]=F*T-D*b,p[6]=U*T-z*b,p[7]=q*T-N*b,p},Pt.fromTranslation=function(p,x){return p[0]=1,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=1,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[10]=1,p[11]=0,p[12]=x[0],p[13]=x[1],p[14]=x[2],p[15]=1,p},Pt.fromScaling=function(p,x){return p[0]=x[0],p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=x[1],p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[10]=x[2],p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},Pt.fromRotation=function(p,x,S){var b,T,M,D=S[0],z=S[1],N=S[2],B=Math.hypot(D,z,N);return B<e.EPSILON?null:(D*=B=1/B,z*=B,N*=B,b=Math.sin(x),T=Math.cos(x),p[0]=D*D*(M=1-T)+T,p[1]=z*D*M+N*b,p[2]=N*D*M-z*b,p[3]=0,p[4]=D*z*M-N*b,p[5]=z*z*M+T,p[6]=N*z*M+D*b,p[7]=0,p[8]=D*N*M+z*b,p[9]=z*N*M-D*b,p[10]=N*N*M+T,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p)},Pt.fromXRotation=function(p,x){var S=Math.sin(x),b=Math.cos(x);return p[0]=1,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=b,p[6]=S,p[7]=0,p[8]=0,p[9]=-S,p[10]=b,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},Pt.fromYRotation=function(p,x){var S=Math.sin(x),b=Math.cos(x);return p[0]=b,p[1]=0,p[2]=-S,p[3]=0,p[4]=0,p[5]=1,p[6]=0,p[7]=0,p[8]=S,p[9]=0,p[10]=b,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},Pt.fromZRotation=function(p,x){var S=Math.sin(x),b=Math.cos(x);return p[0]=b,p[1]=S,p[2]=0,p[3]=0,p[4]=-S,p[5]=b,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[10]=1,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},Pt.fromRotationTranslation=a,Pt.fromQuat2=function(p,x){var S=new e.ARRAY_TYPE(3),b=-x[0],T=-x[1],M=-x[2],D=x[3],z=x[4],N=x[5],B=x[6],F=x[7],U=b*b+T*T+M*M+D*D;return U>0?(S[0]=2*(z*D+F*b+N*M-B*T)/U,S[1]=2*(N*D+F*T+B*b-z*M)/U,S[2]=2*(B*D+F*M+z*T-N*b)/U):(S[0]=2*(z*D+F*b+N*M-B*T),S[1]=2*(N*D+F*T+B*b-z*M),S[2]=2*(B*D+F*M+z*T-N*b)),a(p,x,S),p},Pt.getTranslation=function(p,x){return p[0]=x[12],p[1]=x[13],p[2]=x[14],p},Pt.getScaling=h,Pt.getRotation=function(p,x){var S=new e.ARRAY_TYPE(3);h(S,x);var b=1/S[0],T=1/S[1],M=1/S[2],D=x[0]*b,z=x[1]*T,N=x[2]*M,B=x[4]*b,F=x[5]*T,U=x[6]*M,q=x[8]*b,Z=x[9]*T,re=x[10]*M,ee=D+F+re,te=0;return ee>0?(te=2*Math.sqrt(ee+1),p[3]=.25*te,p[0]=(U-Z)/te,p[1]=(q-N)/te,p[2]=(z-B)/te):D>F&&D>re?(te=2*Math.sqrt(1+D-F-re),p[3]=(U-Z)/te,p[0]=.25*te,p[1]=(z+B)/te,p[2]=(q+N)/te):F>re?(te=2*Math.sqrt(1+F-D-re),p[3]=(q-N)/te,p[0]=(z+B)/te,p[1]=.25*te,p[2]=(U+Z)/te):(te=2*Math.sqrt(1+re-D-F),p[3]=(z-B)/te,p[0]=(q+N)/te,p[1]=(U+Z)/te,p[2]=.25*te),p},Pt.fromRotationTranslationScale=function(p,x,S,b){var T=x[0],M=x[1],D=x[2],z=x[3],N=T+T,B=M+M,F=D+D,U=T*N,q=T*B,Z=T*F,re=M*B,ee=M*F,te=D*F,pe=z*N,ne=z*B,me=z*F,be=b[0],ve=b[1],Me=b[2];return p[0]=(1-(re+te))*be,p[1]=(q+me)*be,p[2]=(Z-ne)*be,p[3]=0,p[4]=(q-me)*ve,p[5]=(1-(U+te))*ve,p[6]=(ee+pe)*ve,p[7]=0,p[8]=(Z+ne)*Me,p[9]=(ee-pe)*Me,p[10]=(1-(U+re))*Me,p[11]=0,p[12]=S[0],p[13]=S[1],p[14]=S[2],p[15]=1,p},Pt.fromRotationTranslationScaleOrigin=function(p,x,S,b,T){var M=x[0],D=x[1],z=x[2],N=x[3],B=M+M,F=D+D,U=z+z,q=M*B,Z=M*F,re=M*U,ee=D*F,te=D*U,pe=z*U,ne=N*B,me=N*F,be=N*U,ve=b[0],Me=b[1],Ee=b[2],Oe=T[0],Ce=T[1],ke=T[2],rt=(1-(ee+pe))*ve,tt=(Z+be)*ve,Ct=(re-me)*ve,ot=(Z-be)*Me,ut=(1-(q+pe))*Me,nt=(te+ne)*Me,Ht=(re+me)*Ee,Et=(te-ne)*Ee,Lt=(1-(q+ee))*Ee;return p[0]=rt,p[1]=tt,p[2]=Ct,p[3]=0,p[4]=ot,p[5]=ut,p[6]=nt,p[7]=0,p[8]=Ht,p[9]=Et,p[10]=Lt,p[11]=0,p[12]=S[0]+Oe-(rt*Oe+ot*Ce+Ht*ke),p[13]=S[1]+Ce-(tt*Oe+ut*Ce+Et*ke),p[14]=S[2]+ke-(Ct*Oe+nt*Ce+Lt*ke),p[15]=1,p},Pt.fromQuat=function(p,x){var S=x[0],b=x[1],T=x[2],M=x[3],D=S+S,z=b+b,N=T+T,B=S*D,F=b*D,U=b*z,q=T*D,Z=T*z,re=T*N,ee=M*D,te=M*z,pe=M*N;return p[0]=1-U-re,p[1]=F+pe,p[2]=q-te,p[3]=0,p[4]=F-pe,p[5]=1-B-re,p[6]=Z+ee,p[7]=0,p[8]=q+te,p[9]=Z-ee,p[10]=1-B-U,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},Pt.frustum=function(p,x,S,b,T,M,D){var z=1/(S-x),N=1/(T-b),B=1/(M-D);return p[0]=2*M*z,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=2*M*N,p[6]=0,p[7]=0,p[8]=(S+x)*z,p[9]=(T+b)*N,p[10]=(D+M)*B,p[11]=-1,p[12]=0,p[13]=0,p[14]=D*M*2*B,p[15]=0,p},Pt.perspectiveNO=_,Pt.perspectiveZO=function(p,x,S,b,T){var M,D=1/Math.tan(x/2);return p[0]=D/S,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=D,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[11]=-1,p[12]=0,p[13]=0,p[15]=0,T!=null&&T!==1/0?(p[10]=T*(M=1/(b-T)),p[14]=T*b*M):(p[10]=-1,p[14]=-b),p},Pt.perspectiveFromFieldOfView=function(p,x,S,b){var T=Math.tan(x.upDegrees*Math.PI/180),M=Math.tan(x.downDegrees*Math.PI/180),D=Math.tan(x.leftDegrees*Math.PI/180),z=Math.tan(x.rightDegrees*Math.PI/180),N=2/(D+z),B=2/(T+M);return p[0]=N,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=B,p[6]=0,p[7]=0,p[8]=-(D-z)*N*.5,p[9]=(T-M)*B*.5,p[10]=b/(S-b),p[11]=-1,p[12]=0,p[13]=0,p[14]=b*S/(S-b),p[15]=0,p},Pt.orthoNO=y,Pt.orthoZO=function(p,x,S,b,T,M,D){var z=1/(x-S),N=1/(b-T),B=1/(M-D);return p[0]=-2*z,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=-2*N,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[10]=B,p[11]=0,p[12]=(x+S)*z,p[13]=(T+b)*N,p[14]=M*B,p[15]=1,p},Pt.lookAt=function(p,x,S,b){var T,M,D,z,N,B,F,U,q,Z,re=x[0],ee=x[1],te=x[2],pe=b[0],ne=b[1],me=b[2],be=S[0],ve=S[1],Me=S[2];return Math.abs(re-be)<e.EPSILON&&Math.abs(ee-ve)<e.EPSILON&&Math.abs(te-Me)<e.EPSILON?o(p):(F=re-be,U=ee-ve,q=te-Me,T=ne*(q*=Z=1/Math.hypot(F,U,q))-me*(U*=Z),M=me*(F*=Z)-pe*q,D=pe*U-ne*F,(Z=Math.hypot(T,M,D))?(T*=Z=1/Z,M*=Z,D*=Z):(T=0,M=0,D=0),z=U*D-q*M,N=q*T-F*D,B=F*M-U*T,(Z=Math.hypot(z,N,B))?(z*=Z=1/Z,N*=Z,B*=Z):(z=0,N=0,B=0),p[0]=T,p[1]=z,p[2]=F,p[3]=0,p[4]=M,p[5]=N,p[6]=U,p[7]=0,p[8]=D,p[9]=B,p[10]=q,p[11]=0,p[12]=-(T*re+M*ee+D*te),p[13]=-(z*re+N*ee+B*te),p[14]=-(F*re+U*ee+q*te),p[15]=1,p)},Pt.targetTo=function(p,x,S,b){var T=x[0],M=x[1],D=x[2],z=b[0],N=b[1],B=b[2],F=T-S[0],U=M-S[1],q=D-S[2],Z=F*F+U*U+q*q;Z>0&&(F*=Z=1/Math.sqrt(Z),U*=Z,q*=Z);var re=N*q-B*U,ee=B*F-z*q,te=z*U-N*F;return(Z=re*re+ee*ee+te*te)>0&&(re*=Z=1/Math.sqrt(Z),ee*=Z,te*=Z),p[0]=re,p[1]=ee,p[2]=te,p[3]=0,p[4]=U*te-q*ee,p[5]=q*re-F*te,p[6]=F*ee-U*re,p[7]=0,p[8]=F,p[9]=U,p[10]=q,p[11]=0,p[12]=T,p[13]=M,p[14]=D,p[15]=1,p},Pt.str=function(p){return"mat4("+p[0]+", "+p[1]+", "+p[2]+", "+p[3]+", "+p[4]+", "+p[5]+", "+p[6]+", "+p[7]+", "+p[8]+", "+p[9]+", "+p[10]+", "+p[11]+", "+p[12]+", "+p[13]+", "+p[14]+", "+p[15]+")"},Pt.frob=function(p){return Math.hypot(p[0],p[1],p[2],p[3],p[4],p[5],p[6],p[7],p[8],p[9],p[10],p[11],p[12],p[13],p[14],p[15])},Pt.add=function(p,x,S){return p[0]=x[0]+S[0],p[1]=x[1]+S[1],p[2]=x[2]+S[2],p[3]=x[3]+S[3],p[4]=x[4]+S[4],p[5]=x[5]+S[5],p[6]=x[6]+S[6],p[7]=x[7]+S[7],p[8]=x[8]+S[8],p[9]=x[9]+S[9],p[10]=x[10]+S[10],p[11]=x[11]+S[11],p[12]=x[12]+S[12],p[13]=x[13]+S[13],p[14]=x[14]+S[14],p[15]=x[15]+S[15],p},Pt.subtract=w,Pt.multiplyScalar=function(p,x,S){return p[0]=x[0]*S,p[1]=x[1]*S,p[2]=x[2]*S,p[3]=x[3]*S,p[4]=x[4]*S,p[5]=x[5]*S,p[6]=x[6]*S,p[7]=x[7]*S,p[8]=x[8]*S,p[9]=x[9]*S,p[10]=x[10]*S,p[11]=x[11]*S,p[12]=x[12]*S,p[13]=x[13]*S,p[14]=x[14]*S,p[15]=x[15]*S,p},Pt.multiplyScalarAndAdd=function(p,x,S,b){return p[0]=x[0]+S[0]*b,p[1]=x[1]+S[1]*b,p[2]=x[2]+S[2]*b,p[3]=x[3]+S[3]*b,p[4]=x[4]+S[4]*b,p[5]=x[5]+S[5]*b,p[6]=x[6]+S[6]*b,p[7]=x[7]+S[7]*b,p[8]=x[8]+S[8]*b,p[9]=x[9]+S[9]*b,p[10]=x[10]+S[10]*b,p[11]=x[11]+S[11]*b,p[12]=x[12]+S[12]*b,p[13]=x[13]+S[13]*b,p[14]=x[14]+S[14]*b,p[15]=x[15]+S[15]*b,p},Pt.exactEquals=function(p,x){return p[0]===x[0]&&p[1]===x[1]&&p[2]===x[2]&&p[3]===x[3]&&p[4]===x[4]&&p[5]===x[5]&&p[6]===x[6]&&p[7]===x[7]&&p[8]===x[8]&&p[9]===x[9]&&p[10]===x[10]&&p[11]===x[11]&&p[12]===x[12]&&p[13]===x[13]&&p[14]===x[14]&&p[15]===x[15]},Pt.equals=function(p,x){var S=p[0],b=p[1],T=p[2],M=p[3],D=p[4],z=p[5],N=p[6],B=p[7],F=p[8],U=p[9],q=p[10],Z=p[11],re=p[12],ee=p[13],te=p[14],pe=p[15],ne=x[0],me=x[1],be=x[2],ve=x[3],Me=x[4],Ee=x[5],Oe=x[6],Ce=x[7],ke=x[8],rt=x[9],tt=x[10],Ct=x[11],ot=x[12],ut=x[13],nt=x[14],Ht=x[15];return Math.abs(S-ne)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(ne))&&Math.abs(b-me)<=e.EPSILON*Math.max(1,Math.abs(b),Math.abs(me))&&Math.abs(T-be)<=e.EPSILON*Math.max(1,Math.abs(T),Math.abs(be))&&Math.abs(M-ve)<=e.EPSILON*Math.max(1,Math.abs(M),Math.abs(ve))&&Math.abs(D-Me)<=e.EPSILON*Math.max(1,Math.abs(D),Math.abs(Me))&&Math.abs(z-Ee)<=e.EPSILON*Math.max(1,Math.abs(z),Math.abs(Ee))&&Math.abs(N-Oe)<=e.EPSILON*Math.max(1,Math.abs(N),Math.abs(Oe))&&Math.abs(B-Ce)<=e.EPSILON*Math.max(1,Math.abs(B),Math.abs(Ce))&&Math.abs(F-ke)<=e.EPSILON*Math.max(1,Math.abs(F),Math.abs(ke))&&Math.abs(U-rt)<=e.EPSILON*Math.max(1,Math.abs(U),Math.abs(rt))&&Math.abs(q-tt)<=e.EPSILON*Math.max(1,Math.abs(q),Math.abs(tt))&&Math.abs(Z-Ct)<=e.EPSILON*Math.max(1,Math.abs(Z),Math.abs(Ct))&&Math.abs(re-ot)<=e.EPSILON*Math.max(1,Math.abs(re),Math.abs(ot))&&Math.abs(ee-ut)<=e.EPSILON*Math.max(1,Math.abs(ee),Math.abs(ut))&&Math.abs(te-nt)<=e.EPSILON*Math.max(1,Math.abs(te),Math.abs(nt))&&Math.abs(pe-Ht)<=e.EPSILON*Math.max(1,Math.abs(pe),Math.abs(Ht))},Pt.sub=Pt.mul=Pt.ortho=Pt.perspective=void 0;var e=function(p,x){if(p&&p.__esModule)return p;if(p===null||n(p)!=="object"&&typeof p!="function")return{default:p};var S=i(void 0);if(S&&S.has(p))return S.get(p);var b={},T=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var M in p)if(M!=="default"&&Object.prototype.hasOwnProperty.call(p,M)){var D=T?Object.getOwnPropertyDescriptor(p,M):null;D&&(D.get||D.set)?Object.defineProperty(b,M,D):b[M]=p[M]}return b.default=p,S&&S.set(p,b),b}(Ne());function i(p){if(typeof WeakMap!="function")return null;var x=new WeakMap,S=new WeakMap;return(i=function(b){return b?S:x})(p)}function o(p){return p[0]=1,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=1,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[10]=1,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p}function l(p,x,S){var b=x[0],T=x[1],M=x[2],D=x[3],z=x[4],N=x[5],B=x[6],F=x[7],U=x[8],q=x[9],Z=x[10],re=x[11],ee=x[12],te=x[13],pe=x[14],ne=x[15],me=S[0],be=S[1],ve=S[2],Me=S[3];return p[0]=me*b+be*z+ve*U+Me*ee,p[1]=me*T+be*N+ve*q+Me*te,p[2]=me*M+be*B+ve*Z+Me*pe,p[3]=me*D+be*F+ve*re+Me*ne,p[4]=(me=S[4])*b+(be=S[5])*z+(ve=S[6])*U+(Me=S[7])*ee,p[5]=me*T+be*N+ve*q+Me*te,p[6]=me*M+be*B+ve*Z+Me*pe,p[7]=me*D+be*F+ve*re+Me*ne,p[8]=(me=S[8])*b+(be=S[9])*z+(ve=S[10])*U+(Me=S[11])*ee,p[9]=me*T+be*N+ve*q+Me*te,p[10]=me*M+be*B+ve*Z+Me*pe,p[11]=me*D+be*F+ve*re+Me*ne,p[12]=(me=S[12])*b+(be=S[13])*z+(ve=S[14])*U+(Me=S[15])*ee,p[13]=me*T+be*N+ve*q+Me*te,p[14]=me*M+be*B+ve*Z+Me*pe,p[15]=me*D+be*F+ve*re+Me*ne,p}function a(p,x,S){var b=x[0],T=x[1],M=x[2],D=x[3],z=b+b,N=T+T,B=M+M,F=b*z,U=b*N,q=b*B,Z=T*N,re=T*B,ee=M*B,te=D*z,pe=D*N,ne=D*B;return p[0]=1-(Z+ee),p[1]=U+ne,p[2]=q-pe,p[3]=0,p[4]=U-ne,p[5]=1-(F+ee),p[6]=re+te,p[7]=0,p[8]=q+pe,p[9]=re-te,p[10]=1-(F+Z),p[11]=0,p[12]=S[0],p[13]=S[1],p[14]=S[2],p[15]=1,p}function h(p,x){var S=x[4],b=x[5],T=x[6],M=x[8],D=x[9],z=x[10];return p[0]=Math.hypot(x[0],x[1],x[2]),p[1]=Math.hypot(S,b,T),p[2]=Math.hypot(M,D,z),p}function _(p,x,S,b,T){var M,D=1/Math.tan(x/2);return p[0]=D/S,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=D,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[11]=-1,p[12]=0,p[13]=0,p[15]=0,T!=null&&T!==1/0?(p[10]=(T+b)*(M=1/(b-T)),p[14]=2*T*b*M):(p[10]=-1,p[14]=-2*b),p}function y(p,x,S,b,T,M,D){var z=1/(x-S),N=1/(b-T),B=1/(M-D);return p[0]=-2*z,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=-2*N,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[10]=2*B,p[11]=0,p[12]=(x+S)*z,p[13]=(T+b)*N,p[14]=(D+M)*B,p[15]=1,p}function w(p,x,S){return p[0]=x[0]-S[0],p[1]=x[1]-S[1],p[2]=x[2]-S[2],p[3]=x[3]-S[3],p[4]=x[4]-S[4],p[5]=x[5]-S[5],p[6]=x[6]-S[6],p[7]=x[7]-S[7],p[8]=x[8]-S[8],p[9]=x[9]-S[9],p[10]=x[10]-S[10],p[11]=x[11]-S[11],p[12]=x[12]-S[12],p[13]=x[13]-S[13],p[14]=x[14]-S[14],p[15]=x[15]-S[15],p}return Pt.perspective=_,Pt.ortho=y,Pt.mul=l,Pt.sub=w,Pt}var jt,st={},zt={};function ji(){if(jt)return zt;function n(T){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(M){return typeof M}:function(M){return M&&typeof Symbol=="function"&&M.constructor===Symbol&&M!==Symbol.prototype?"symbol":typeof M},n(T)}jt=1,Object.defineProperty(zt,"__esModule",{value:!0}),zt.create=o,zt.clone=function(T){var M=new e.ARRAY_TYPE(3);return M[0]=T[0],M[1]=T[1],M[2]=T[2],M},zt.length=l,zt.fromValues=function(T,M,D){var z=new e.ARRAY_TYPE(3);return z[0]=T,z[1]=M,z[2]=D,z},zt.copy=function(T,M){return T[0]=M[0],T[1]=M[1],T[2]=M[2],T},zt.set=function(T,M,D,z){return T[0]=M,T[1]=D,T[2]=z,T},zt.add=function(T,M,D){return T[0]=M[0]+D[0],T[1]=M[1]+D[1],T[2]=M[2]+D[2],T},zt.subtract=a,zt.multiply=h,zt.divide=_,zt.ceil=function(T,M){return T[0]=Math.ceil(M[0]),T[1]=Math.ceil(M[1]),T[2]=Math.ceil(M[2]),T},zt.floor=function(T,M){return T[0]=Math.floor(M[0]),T[1]=Math.floor(M[1]),T[2]=Math.floor(M[2]),T},zt.min=function(T,M,D){return T[0]=Math.min(M[0],D[0]),T[1]=Math.min(M[1],D[1]),T[2]=Math.min(M[2],D[2]),T},zt.max=function(T,M,D){return T[0]=Math.max(M[0],D[0]),T[1]=Math.max(M[1],D[1]),T[2]=Math.max(M[2],D[2]),T},zt.round=function(T,M){return T[0]=Math.round(M[0]),T[1]=Math.round(M[1]),T[2]=Math.round(M[2]),T},zt.scale=function(T,M,D){return T[0]=M[0]*D,T[1]=M[1]*D,T[2]=M[2]*D,T},zt.scaleAndAdd=function(T,M,D,z){return T[0]=M[0]+D[0]*z,T[1]=M[1]+D[1]*z,T[2]=M[2]+D[2]*z,T},zt.distance=y,zt.squaredDistance=w,zt.squaredLength=p,zt.negate=function(T,M){return T[0]=-M[0],T[1]=-M[1],T[2]=-M[2],T},zt.inverse=function(T,M){return T[0]=1/M[0],T[1]=1/M[1],T[2]=1/M[2],T},zt.normalize=function(T,M){var D=M[0],z=M[1],N=M[2],B=D*D+z*z+N*N;return B>0&&(B=1/Math.sqrt(B)),T[0]=M[0]*B,T[1]=M[1]*B,T[2]=M[2]*B,T},zt.dot=x,zt.cross=function(T,M,D){var z=M[0],N=M[1],B=M[2],F=D[0],U=D[1],q=D[2];return T[0]=N*q-B*U,T[1]=B*F-z*q,T[2]=z*U-N*F,T},zt.lerp=function(T,M,D,z){var N=M[0],B=M[1],F=M[2];return T[0]=N+z*(D[0]-N),T[1]=B+z*(D[1]-B),T[2]=F+z*(D[2]-F),T},zt.hermite=function(T,M,D,z,N,B){var F=B*B,U=F*(2*B-3)+1,q=F*(B-2)+B,Z=F*(B-1),re=F*(3-2*B);return T[0]=M[0]*U+D[0]*q+z[0]*Z+N[0]*re,T[1]=M[1]*U+D[1]*q+z[1]*Z+N[1]*re,T[2]=M[2]*U+D[2]*q+z[2]*Z+N[2]*re,T},zt.bezier=function(T,M,D,z,N,B){var F=1-B,U=F*F,q=B*B,Z=U*F,re=3*B*U,ee=3*q*F,te=q*B;return T[0]=M[0]*Z+D[0]*re+z[0]*ee+N[0]*te,T[1]=M[1]*Z+D[1]*re+z[1]*ee+N[1]*te,T[2]=M[2]*Z+D[2]*re+z[2]*ee+N[2]*te,T},zt.random=function(T,M){M=M||1;var D=2*e.RANDOM()*Math.PI,z=2*e.RANDOM()-1,N=Math.sqrt(1-z*z)*M;return T[0]=Math.cos(D)*N,T[1]=Math.sin(D)*N,T[2]=z*M,T},zt.transformMat4=function(T,M,D){var z=M[0],N=M[1],B=M[2],F=D[3]*z+D[7]*N+D[11]*B+D[15];return T[0]=(D[0]*z+D[4]*N+D[8]*B+D[12])/(F=F||1),T[1]=(D[1]*z+D[5]*N+D[9]*B+D[13])/F,T[2]=(D[2]*z+D[6]*N+D[10]*B+D[14])/F,T},zt.transformMat3=function(T,M,D){var z=M[0],N=M[1],B=M[2];return T[0]=z*D[0]+N*D[3]+B*D[6],T[1]=z*D[1]+N*D[4]+B*D[7],T[2]=z*D[2]+N*D[5]+B*D[8],T},zt.transformQuat=function(T,M,D){var z=D[0],N=D[1],B=D[2],F=M[0],U=M[1],q=M[2],Z=N*q-B*U,re=B*F-z*q,ee=z*U-N*F,te=N*ee-B*re,pe=B*Z-z*ee,ne=z*re-N*Z,me=2*D[3];return re*=me,ee*=me,pe*=2,ne*=2,T[0]=F+(Z*=me)+(te*=2),T[1]=U+re+pe,T[2]=q+ee+ne,T},zt.rotateX=function(T,M,D,z){var N=[],B=[];return N[0]=M[0]-D[0],N[1]=M[1]-D[1],N[2]=M[2]-D[2],B[0]=N[0],B[1]=N[1]*Math.cos(z)-N[2]*Math.sin(z),B[2]=N[1]*Math.sin(z)+N[2]*Math.cos(z),T[0]=B[0]+D[0],T[1]=B[1]+D[1],T[2]=B[2]+D[2],T},zt.rotateY=function(T,M,D,z){var N=[],B=[];return N[0]=M[0]-D[0],N[1]=M[1]-D[1],N[2]=M[2]-D[2],B[0]=N[2]*Math.sin(z)+N[0]*Math.cos(z),B[1]=N[1],B[2]=N[2]*Math.cos(z)-N[0]*Math.sin(z),T[0]=B[0]+D[0],T[1]=B[1]+D[1],T[2]=B[2]+D[2],T},zt.rotateZ=function(T,M,D,z){var N=[],B=[];return N[0]=M[0]-D[0],N[1]=M[1]-D[1],N[2]=M[2]-D[2],B[0]=N[0]*Math.cos(z)-N[1]*Math.sin(z),B[1]=N[0]*Math.sin(z)+N[1]*Math.cos(z),B[2]=N[2],T[0]=B[0]+D[0],T[1]=B[1]+D[1],T[2]=B[2]+D[2],T},zt.angle=function(T,M){var D=T[0],z=T[1],N=T[2],B=M[0],F=M[1],U=M[2],q=Math.sqrt(D*D+z*z+N*N)*Math.sqrt(B*B+F*F+U*U),Z=q&&x(T,M)/q;return Math.acos(Math.min(Math.max(Z,-1),1))},zt.zero=function(T){return T[0]=0,T[1]=0,T[2]=0,T},zt.str=function(T){return"vec3("+T[0]+", "+T[1]+", "+T[2]+")"},zt.exactEquals=function(T,M){return T[0]===M[0]&&T[1]===M[1]&&T[2]===M[2]},zt.equals=function(T,M){var D=T[0],z=T[1],N=T[2],B=M[0],F=M[1],U=M[2];return Math.abs(D-B)<=e.EPSILON*Math.max(1,Math.abs(D),Math.abs(B))&&Math.abs(z-F)<=e.EPSILON*Math.max(1,Math.abs(z),Math.abs(F))&&Math.abs(N-U)<=e.EPSILON*Math.max(1,Math.abs(N),Math.abs(U))},zt.forEach=zt.sqrLen=zt.len=zt.sqrDist=zt.dist=zt.div=zt.mul=zt.sub=void 0;var e=function(T,M){if(T&&T.__esModule)return T;if(T===null||n(T)!=="object"&&typeof T!="function")return{default:T};var D=i(void 0);if(D&&D.has(T))return D.get(T);var z={},N=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var B in T)if(B!=="default"&&Object.prototype.hasOwnProperty.call(T,B)){var F=N?Object.getOwnPropertyDescriptor(T,B):null;F&&(F.get||F.set)?Object.defineProperty(z,B,F):z[B]=T[B]}return z.default=T,D&&D.set(T,z),z}(Ne());function i(T){if(typeof WeakMap!="function")return null;var M=new WeakMap,D=new WeakMap;return(i=function(z){return z?D:M})(T)}function o(){var T=new e.ARRAY_TYPE(3);return e.ARRAY_TYPE!=Float32Array&&(T[0]=0,T[1]=0,T[2]=0),T}function l(T){return Math.hypot(T[0],T[1],T[2])}function a(T,M,D){return T[0]=M[0]-D[0],T[1]=M[1]-D[1],T[2]=M[2]-D[2],T}function h(T,M,D){return T[0]=M[0]*D[0],T[1]=M[1]*D[1],T[2]=M[2]*D[2],T}function _(T,M,D){return T[0]=M[0]/D[0],T[1]=M[1]/D[1],T[2]=M[2]/D[2],T}function y(T,M){return Math.hypot(M[0]-T[0],M[1]-T[1],M[2]-T[2])}function w(T,M){var D=M[0]-T[0],z=M[1]-T[1],N=M[2]-T[2];return D*D+z*z+N*N}function p(T){var M=T[0],D=T[1],z=T[2];return M*M+D*D+z*z}function x(T,M){return T[0]*M[0]+T[1]*M[1]+T[2]*M[2]}zt.sub=a,zt.mul=h,zt.div=_,zt.dist=y,zt.sqrDist=w,zt.len=l,zt.sqrLen=p;var S,b=(S=o(),function(T,M,D,z,N,B){var F,U;for(M||(M=3),D||(D=0),U=z?Math.min(z*M+D,T.length):T.length,F=D;F<U;F+=M)S[0]=T[F],S[1]=T[F+1],S[2]=T[F+2],N(S,S,B),T[F]=S[0],T[F+1]=S[1],T[F+2]=S[2];return T});return zt.forEach=b,zt}var Ci,Fr,oi={};function Yi(){if(Ci)return oi;function n(b){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(T){return typeof T}:function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},n(b)}Ci=1,Object.defineProperty(oi,"__esModule",{value:!0}),oi.create=o,oi.clone=function(b){var T=new e.ARRAY_TYPE(4);return T[0]=b[0],T[1]=b[1],T[2]=b[2],T[3]=b[3],T},oi.fromValues=function(b,T,M,D){var z=new e.ARRAY_TYPE(4);return z[0]=b,z[1]=T,z[2]=M,z[3]=D,z},oi.copy=function(b,T){return b[0]=T[0],b[1]=T[1],b[2]=T[2],b[3]=T[3],b},oi.set=function(b,T,M,D,z){return b[0]=T,b[1]=M,b[2]=D,b[3]=z,b},oi.add=function(b,T,M){return b[0]=T[0]+M[0],b[1]=T[1]+M[1],b[2]=T[2]+M[2],b[3]=T[3]+M[3],b},oi.subtract=l,oi.multiply=a,oi.divide=h,oi.ceil=function(b,T){return b[0]=Math.ceil(T[0]),b[1]=Math.ceil(T[1]),b[2]=Math.ceil(T[2]),b[3]=Math.ceil(T[3]),b},oi.floor=function(b,T){return b[0]=Math.floor(T[0]),b[1]=Math.floor(T[1]),b[2]=Math.floor(T[2]),b[3]=Math.floor(T[3]),b},oi.min=function(b,T,M){return b[0]=Math.min(T[0],M[0]),b[1]=Math.min(T[1],M[1]),b[2]=Math.min(T[2],M[2]),b[3]=Math.min(T[3],M[3]),b},oi.max=function(b,T,M){return b[0]=Math.max(T[0],M[0]),b[1]=Math.max(T[1],M[1]),b[2]=Math.max(T[2],M[2]),b[3]=Math.max(T[3],M[3]),b},oi.round=function(b,T){return b[0]=Math.round(T[0]),b[1]=Math.round(T[1]),b[2]=Math.round(T[2]),b[3]=Math.round(T[3]),b},oi.scale=function(b,T,M){return b[0]=T[0]*M,b[1]=T[1]*M,b[2]=T[2]*M,b[3]=T[3]*M,b},oi.scaleAndAdd=function(b,T,M,D){return b[0]=T[0]+M[0]*D,b[1]=T[1]+M[1]*D,b[2]=T[2]+M[2]*D,b[3]=T[3]+M[3]*D,b},oi.distance=_,oi.squaredDistance=y,oi.length=w,oi.squaredLength=p,oi.negate=function(b,T){return b[0]=-T[0],b[1]=-T[1],b[2]=-T[2],b[3]=-T[3],b},oi.inverse=function(b,T){return b[0]=1/T[0],b[1]=1/T[1],b[2]=1/T[2],b[3]=1/T[3],b},oi.normalize=function(b,T){var M=T[0],D=T[1],z=T[2],N=T[3],B=M*M+D*D+z*z+N*N;return B>0&&(B=1/Math.sqrt(B)),b[0]=M*B,b[1]=D*B,b[2]=z*B,b[3]=N*B,b},oi.dot=function(b,T){return b[0]*T[0]+b[1]*T[1]+b[2]*T[2]+b[3]*T[3]},oi.cross=function(b,T,M,D){var z=M[0]*D[1]-M[1]*D[0],N=M[0]*D[2]-M[2]*D[0],B=M[0]*D[3]-M[3]*D[0],F=M[1]*D[2]-M[2]*D[1],U=M[1]*D[3]-M[3]*D[1],q=M[2]*D[3]-M[3]*D[2],Z=T[0],re=T[1],ee=T[2],te=T[3];return b[0]=re*q-ee*U+te*F,b[1]=-Z*q+ee*B-te*N,b[2]=Z*U-re*B+te*z,b[3]=-Z*F+re*N-ee*z,b},oi.lerp=function(b,T,M,D){var z=T[0],N=T[1],B=T[2],F=T[3];return b[0]=z+D*(M[0]-z),b[1]=N+D*(M[1]-N),b[2]=B+D*(M[2]-B),b[3]=F+D*(M[3]-F),b},oi.random=function(b,T){var M,D,z,N,B,F;T=T||1;do B=(M=2*e.RANDOM()-1)*M+(D=2*e.RANDOM()-1)*D;while(B>=1);do F=(z=2*e.RANDOM()-1)*z+(N=2*e.RANDOM()-1)*N;while(F>=1);var U=Math.sqrt((1-B)/F);return b[0]=T*M,b[1]=T*D,b[2]=T*z*U,b[3]=T*N*U,b},oi.transformMat4=function(b,T,M){var D=T[0],z=T[1],N=T[2],B=T[3];return b[0]=M[0]*D+M[4]*z+M[8]*N+M[12]*B,b[1]=M[1]*D+M[5]*z+M[9]*N+M[13]*B,b[2]=M[2]*D+M[6]*z+M[10]*N+M[14]*B,b[3]=M[3]*D+M[7]*z+M[11]*N+M[15]*B,b},oi.transformQuat=function(b,T,M){var D=T[0],z=T[1],N=T[2],B=M[0],F=M[1],U=M[2],q=M[3],Z=q*D+F*N-U*z,re=q*z+U*D-B*N,ee=q*N+B*z-F*D,te=-B*D-F*z-U*N;return b[0]=Z*q+te*-B+re*-U-ee*-F,b[1]=re*q+te*-F+ee*-B-Z*-U,b[2]=ee*q+te*-U+Z*-F-re*-B,b[3]=T[3],b},oi.zero=function(b){return b[0]=0,b[1]=0,b[2]=0,b[3]=0,b},oi.str=function(b){return"vec4("+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+")"},oi.exactEquals=function(b,T){return b[0]===T[0]&&b[1]===T[1]&&b[2]===T[2]&&b[3]===T[3]},oi.equals=function(b,T){var M=b[0],D=b[1],z=b[2],N=b[3],B=T[0],F=T[1],U=T[2],q=T[3];return Math.abs(M-B)<=e.EPSILON*Math.max(1,Math.abs(M),Math.abs(B))&&Math.abs(D-F)<=e.EPSILON*Math.max(1,Math.abs(D),Math.abs(F))&&Math.abs(z-U)<=e.EPSILON*Math.max(1,Math.abs(z),Math.abs(U))&&Math.abs(N-q)<=e.EPSILON*Math.max(1,Math.abs(N),Math.abs(q))},oi.forEach=oi.sqrLen=oi.len=oi.sqrDist=oi.dist=oi.div=oi.mul=oi.sub=void 0;var e=function(b,T){if(b&&b.__esModule)return b;if(b===null||n(b)!=="object"&&typeof b!="function")return{default:b};var M=i(void 0);if(M&&M.has(b))return M.get(b);var D={},z=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var N in b)if(N!=="default"&&Object.prototype.hasOwnProperty.call(b,N)){var B=z?Object.getOwnPropertyDescriptor(b,N):null;B&&(B.get||B.set)?Object.defineProperty(D,N,B):D[N]=b[N]}return D.default=b,M&&M.set(b,D),D}(Ne());function i(b){if(typeof WeakMap!="function")return null;var T=new WeakMap,M=new WeakMap;return(i=function(D){return D?M:T})(b)}function o(){var b=new e.ARRAY_TYPE(4);return e.ARRAY_TYPE!=Float32Array&&(b[0]=0,b[1]=0,b[2]=0,b[3]=0),b}function l(b,T,M){return b[0]=T[0]-M[0],b[1]=T[1]-M[1],b[2]=T[2]-M[2],b[3]=T[3]-M[3],b}function a(b,T,M){return b[0]=T[0]*M[0],b[1]=T[1]*M[1],b[2]=T[2]*M[2],b[3]=T[3]*M[3],b}function h(b,T,M){return b[0]=T[0]/M[0],b[1]=T[1]/M[1],b[2]=T[2]/M[2],b[3]=T[3]/M[3],b}function _(b,T){return Math.hypot(T[0]-b[0],T[1]-b[1],T[2]-b[2],T[3]-b[3])}function y(b,T){var M=T[0]-b[0],D=T[1]-b[1],z=T[2]-b[2],N=T[3]-b[3];return M*M+D*D+z*z+N*N}function w(b){return Math.hypot(b[0],b[1],b[2],b[3])}function p(b){var T=b[0],M=b[1],D=b[2],z=b[3];return T*T+M*M+D*D+z*z}oi.sub=l,oi.mul=a,oi.div=h,oi.dist=_,oi.sqrDist=y,oi.len=w,oi.sqrLen=p;var x,S=(x=o(),function(b,T,M,D,z,N){var B,F;for(T||(T=4),M||(M=0),F=D?Math.min(D*T+M,b.length):b.length,B=M;B<F;B+=T)x[0]=b[B],x[1]=b[B+1],x[2]=b[B+2],x[3]=b[B+3],z(x,x,N),b[B]=x[0],b[B+1]=x[1],b[B+2]=x[2],b[B+3]=x[3];return b});return oi.forEach=S,oi}function bi(){if(Fr)return st;function n(ne){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(me){return typeof me}:function(me){return me&&typeof Symbol=="function"&&me.constructor===Symbol&&me!==Symbol.prototype?"symbol":typeof me},n(ne)}Fr=1,Object.defineProperty(st,"__esModule",{value:!0}),st.create=_,st.identity=function(ne){return ne[0]=0,ne[1]=0,ne[2]=0,ne[3]=1,ne},st.setAxisAngle=y,st.getAxisAngle=function(ne,me){var be=2*Math.acos(me[3]),ve=Math.sin(be/2);return ve>e.EPSILON?(ne[0]=me[0]/ve,ne[1]=me[1]/ve,ne[2]=me[2]/ve):(ne[0]=1,ne[1]=0,ne[2]=0),be},st.getAngle=function(ne,me){var be=M(ne,me);return Math.acos(2*be*be-1)},st.multiply=w,st.rotateX=function(ne,me,be){be*=.5;var ve=me[0],Me=me[1],Ee=me[2],Oe=me[3],Ce=Math.sin(be),ke=Math.cos(be);return ne[0]=ve*ke+Oe*Ce,ne[1]=Me*ke+Ee*Ce,ne[2]=Ee*ke-Me*Ce,ne[3]=Oe*ke-ve*Ce,ne},st.rotateY=function(ne,me,be){be*=.5;var ve=me[0],Me=me[1],Ee=me[2],Oe=me[3],Ce=Math.sin(be),ke=Math.cos(be);return ne[0]=ve*ke-Ee*Ce,ne[1]=Me*ke+Oe*Ce,ne[2]=Ee*ke+ve*Ce,ne[3]=Oe*ke-Me*Ce,ne},st.rotateZ=function(ne,me,be){be*=.5;var ve=me[0],Me=me[1],Ee=me[2],Oe=me[3],Ce=Math.sin(be),ke=Math.cos(be);return ne[0]=ve*ke+Me*Ce,ne[1]=Me*ke-ve*Ce,ne[2]=Ee*ke+Oe*Ce,ne[3]=Oe*ke-Ee*Ce,ne},st.calculateW=function(ne,me){var be=me[0],ve=me[1],Me=me[2];return ne[0]=be,ne[1]=ve,ne[2]=Me,ne[3]=Math.sqrt(Math.abs(1-be*be-ve*ve-Me*Me)),ne},st.exp=p,st.ln=x,st.pow=function(ne,me,be){return x(ne,me),T(ne,ne,be),p(ne,ne),ne},st.slerp=S,st.random=function(ne){var me=e.RANDOM(),be=e.RANDOM(),ve=e.RANDOM(),Me=Math.sqrt(1-me),Ee=Math.sqrt(me);return ne[0]=Me*Math.sin(2*Math.PI*be),ne[1]=Me*Math.cos(2*Math.PI*be),ne[2]=Ee*Math.sin(2*Math.PI*ve),ne[3]=Ee*Math.cos(2*Math.PI*ve),ne},st.invert=function(ne,me){var be=me[0],ve=me[1],Me=me[2],Ee=me[3],Oe=be*be+ve*ve+Me*Me+Ee*Ee,Ce=Oe?1/Oe:0;return ne[0]=-be*Ce,ne[1]=-ve*Ce,ne[2]=-Me*Ce,ne[3]=Ee*Ce,ne},st.conjugate=function(ne,me){return ne[0]=-me[0],ne[1]=-me[1],ne[2]=-me[2],ne[3]=me[3],ne},st.fromMat3=b,st.fromEuler=function(ne,me,be,ve){var Me=.5*Math.PI/180;me*=Me,be*=Me,ve*=Me;var Ee=Math.sin(me),Oe=Math.cos(me),Ce=Math.sin(be),ke=Math.cos(be),rt=Math.sin(ve),tt=Math.cos(ve);return ne[0]=Ee*ke*tt-Oe*Ce*rt,ne[1]=Oe*Ce*tt+Ee*ke*rt,ne[2]=Oe*ke*rt-Ee*Ce*tt,ne[3]=Oe*ke*tt+Ee*Ce*rt,ne},st.str=function(ne){return"quat("+ne[0]+", "+ne[1]+", "+ne[2]+", "+ne[3]+")"},st.setAxes=st.sqlerp=st.rotationTo=st.equals=st.exactEquals=st.normalize=st.sqrLen=st.squaredLength=st.len=st.length=st.lerp=st.dot=st.scale=st.mul=st.add=st.set=st.copy=st.fromValues=st.clone=void 0;var e=h(Ne()),i=h(ui()),o=h(ji()),l=h(Yi());function a(ne){if(typeof WeakMap!="function")return null;var me=new WeakMap,be=new WeakMap;return(a=function(ve){return ve?be:me})(ne)}function h(ne,me){if(ne&&ne.__esModule)return ne;if(ne===null||n(ne)!=="object"&&typeof ne!="function")return{default:ne};var be=a(me);if(be&&be.has(ne))return be.get(ne);var ve={},Me=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ee in ne)if(Ee!=="default"&&Object.prototype.hasOwnProperty.call(ne,Ee)){var Oe=Me?Object.getOwnPropertyDescriptor(ne,Ee):null;Oe&&(Oe.get||Oe.set)?Object.defineProperty(ve,Ee,Oe):ve[Ee]=ne[Ee]}return ve.default=ne,be&&be.set(ne,ve),ve}function _(){var ne=new e.ARRAY_TYPE(4);return e.ARRAY_TYPE!=Float32Array&&(ne[0]=0,ne[1]=0,ne[2]=0),ne[3]=1,ne}function y(ne,me,be){be*=.5;var ve=Math.sin(be);return ne[0]=ve*me[0],ne[1]=ve*me[1],ne[2]=ve*me[2],ne[3]=Math.cos(be),ne}function w(ne,me,be){var ve=me[0],Me=me[1],Ee=me[2],Oe=me[3],Ce=be[0],ke=be[1],rt=be[2],tt=be[3];return ne[0]=ve*tt+Oe*Ce+Me*rt-Ee*ke,ne[1]=Me*tt+Oe*ke+Ee*Ce-ve*rt,ne[2]=Ee*tt+Oe*rt+ve*ke-Me*Ce,ne[3]=Oe*tt-ve*Ce-Me*ke-Ee*rt,ne}function p(ne,me){var be=me[0],ve=me[1],Me=me[2],Ee=me[3],Oe=Math.sqrt(be*be+ve*ve+Me*Me),Ce=Math.exp(Ee),ke=Oe>0?Ce*Math.sin(Oe)/Oe:0;return ne[0]=be*ke,ne[1]=ve*ke,ne[2]=Me*ke,ne[3]=Ce*Math.cos(Oe),ne}function x(ne,me){var be=me[0],ve=me[1],Me=me[2],Ee=me[3],Oe=Math.sqrt(be*be+ve*ve+Me*Me),Ce=Oe>0?Math.atan2(Oe,Ee)/Oe:0;return ne[0]=be*Ce,ne[1]=ve*Ce,ne[2]=Me*Ce,ne[3]=.5*Math.log(be*be+ve*ve+Me*Me+Ee*Ee),ne}function S(ne,me,be,ve){var Me,Ee,Oe,Ce,ke,rt=me[0],tt=me[1],Ct=me[2],ot=me[3],ut=be[0],nt=be[1],Ht=be[2],Et=be[3];return(Ee=rt*ut+tt*nt+Ct*Ht+ot*Et)<0&&(Ee=-Ee,ut=-ut,nt=-nt,Ht=-Ht,Et=-Et),1-Ee>e.EPSILON?(Me=Math.acos(Ee),Oe=Math.sin(Me),Ce=Math.sin((1-ve)*Me)/Oe,ke=Math.sin(ve*Me)/Oe):(Ce=1-ve,ke=ve),ne[0]=Ce*rt+ke*ut,ne[1]=Ce*tt+ke*nt,ne[2]=Ce*Ct+ke*Ht,ne[3]=Ce*ot+ke*Et,ne}function b(ne,me){var be,ve=me[0]+me[4]+me[8];if(ve>0)be=Math.sqrt(ve+1),ne[3]=.5*be,ne[0]=(me[5]-me[7])*(be=.5/be),ne[1]=(me[6]-me[2])*be,ne[2]=(me[1]-me[3])*be;else{var Me=0;me[4]>me[0]&&(Me=1),me[8]>me[3*Me+Me]&&(Me=2);var Ee=(Me+1)%3,Oe=(Me+2)%3;be=Math.sqrt(me[3*Me+Me]-me[3*Ee+Ee]-me[3*Oe+Oe]+1),ne[Me]=.5*be,ne[3]=(me[3*Ee+Oe]-me[3*Oe+Ee])*(be=.5/be),ne[Ee]=(me[3*Ee+Me]+me[3*Me+Ee])*be,ne[Oe]=(me[3*Oe+Me]+me[3*Me+Oe])*be}return ne}st.clone=l.clone,st.fromValues=l.fromValues,st.copy=l.copy,st.set=l.set,st.add=l.add,st.mul=w;var T=l.scale;st.scale=T;var M=l.dot;st.dot=M,st.lerp=l.lerp;var D=l.length;st.length=D,st.len=D;var z=l.squaredLength;st.squaredLength=z,st.sqrLen=z;var N=l.normalize;st.normalize=N,st.exactEquals=l.exactEquals,st.equals=l.equals;var B,F,U,q=(B=o.create(),F=o.fromValues(1,0,0),U=o.fromValues(0,1,0),function(ne,me,be){var ve=o.dot(me,be);return ve<-.999999?(o.cross(B,F,me),o.len(B)<1e-6&&o.cross(B,U,me),o.normalize(B,B),y(ne,B,Math.PI),ne):ve>.999999?(ne[0]=0,ne[1]=0,ne[2]=0,ne[3]=1,ne):(o.cross(B,me,be),ne[0]=B[0],ne[1]=B[1],ne[2]=B[2],ne[3]=1+ve,N(ne,ne))});st.rotationTo=q;var Z,re,ee=(Z=_(),re=_(),function(ne,me,be,ve,Me,Ee){return S(Z,me,Me,Ee),S(re,be,ve,Ee),S(ne,Z,re,2*Ee*(1-Ee)),ne});st.sqlerp=ee;var te,pe=(te=i.create(),function(ne,me,be,ve){return te[0]=be[0],te[3]=be[1],te[6]=be[2],te[1]=ve[0],te[4]=ve[1],te[7]=ve[2],te[2]=-me[0],te[5]=-me[1],te[8]=-me[2],N(ne,b(ne,te))});return st.setAxes=pe,st}var nr,hi={};function Ti(){if(nr)return hi;function n(S){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(b){return typeof b}:function(b){return b&&typeof Symbol=="function"&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b},n(S)}nr=1,Object.defineProperty(hi,"__esModule",{value:!0}),hi.create=function(){var S=new e.ARRAY_TYPE(8);return e.ARRAY_TYPE!=Float32Array&&(S[0]=0,S[1]=0,S[2]=0,S[4]=0,S[5]=0,S[6]=0,S[7]=0),S[3]=1,S},hi.clone=function(S){var b=new e.ARRAY_TYPE(8);return b[0]=S[0],b[1]=S[1],b[2]=S[2],b[3]=S[3],b[4]=S[4],b[5]=S[5],b[6]=S[6],b[7]=S[7],b},hi.fromValues=function(S,b,T,M,D,z,N,B){var F=new e.ARRAY_TYPE(8);return F[0]=S,F[1]=b,F[2]=T,F[3]=M,F[4]=D,F[5]=z,F[6]=N,F[7]=B,F},hi.fromRotationTranslationValues=function(S,b,T,M,D,z,N){var B=new e.ARRAY_TYPE(8);B[0]=S,B[1]=b,B[2]=T,B[3]=M;var F=.5*D,U=.5*z,q=.5*N;return B[4]=F*M+U*T-q*b,B[5]=U*M+q*S-F*T,B[6]=q*M+F*b-U*S,B[7]=-F*S-U*b-q*T,B},hi.fromRotationTranslation=h,hi.fromTranslation=function(S,b){return S[0]=0,S[1]=0,S[2]=0,S[3]=1,S[4]=.5*b[0],S[5]=.5*b[1],S[6]=.5*b[2],S[7]=0,S},hi.fromRotation=function(S,b){return S[0]=b[0],S[1]=b[1],S[2]=b[2],S[3]=b[3],S[4]=0,S[5]=0,S[6]=0,S[7]=0,S},hi.fromMat4=function(S,b){var T=i.create();o.getRotation(T,b);var M=new e.ARRAY_TYPE(3);return o.getTranslation(M,b),h(S,T,M),S},hi.copy=_,hi.identity=function(S){return S[0]=0,S[1]=0,S[2]=0,S[3]=1,S[4]=0,S[5]=0,S[6]=0,S[7]=0,S},hi.set=function(S,b,T,M,D,z,N,B,F){return S[0]=b,S[1]=T,S[2]=M,S[3]=D,S[4]=z,S[5]=N,S[6]=B,S[7]=F,S},hi.getDual=function(S,b){return S[0]=b[4],S[1]=b[5],S[2]=b[6],S[3]=b[7],S},hi.setDual=function(S,b){return S[4]=b[0],S[5]=b[1],S[6]=b[2],S[7]=b[3],S},hi.getTranslation=function(S,b){var T=b[4],M=b[5],D=b[6],z=b[7],N=-b[0],B=-b[1],F=-b[2],U=b[3];return S[0]=2*(T*U+z*N+M*F-D*B),S[1]=2*(M*U+z*B+D*N-T*F),S[2]=2*(D*U+z*F+T*B-M*N),S},hi.translate=function(S,b,T){var M=b[0],D=b[1],z=b[2],N=b[3],B=.5*T[0],F=.5*T[1],U=.5*T[2],q=b[4],Z=b[5],re=b[6],ee=b[7];return S[0]=M,S[1]=D,S[2]=z,S[3]=N,S[4]=N*B+D*U-z*F+q,S[5]=N*F+z*B-M*U+Z,S[6]=N*U+M*F-D*B+re,S[7]=-M*B-D*F-z*U+ee,S},hi.rotateX=function(S,b,T){var M=-b[0],D=-b[1],z=-b[2],N=b[3],B=b[4],F=b[5],U=b[6],q=b[7],Z=B*N+q*M+F*z-U*D,re=F*N+q*D+U*M-B*z,ee=U*N+q*z+B*D-F*M,te=q*N-B*M-F*D-U*z;return i.rotateX(S,b,T),S[4]=Z*(N=S[3])+te*(M=S[0])+re*(z=S[2])-ee*(D=S[1]),S[5]=re*N+te*D+ee*M-Z*z,S[6]=ee*N+te*z+Z*D-re*M,S[7]=te*N-Z*M-re*D-ee*z,S},hi.rotateY=function(S,b,T){var M=-b[0],D=-b[1],z=-b[2],N=b[3],B=b[4],F=b[5],U=b[6],q=b[7],Z=B*N+q*M+F*z-U*D,re=F*N+q*D+U*M-B*z,ee=U*N+q*z+B*D-F*M,te=q*N-B*M-F*D-U*z;return i.rotateY(S,b,T),S[4]=Z*(N=S[3])+te*(M=S[0])+re*(z=S[2])-ee*(D=S[1]),S[5]=re*N+te*D+ee*M-Z*z,S[6]=ee*N+te*z+Z*D-re*M,S[7]=te*N-Z*M-re*D-ee*z,S},hi.rotateZ=function(S,b,T){var M=-b[0],D=-b[1],z=-b[2],N=b[3],B=b[4],F=b[5],U=b[6],q=b[7],Z=B*N+q*M+F*z-U*D,re=F*N+q*D+U*M-B*z,ee=U*N+q*z+B*D-F*M,te=q*N-B*M-F*D-U*z;return i.rotateZ(S,b,T),S[4]=Z*(N=S[3])+te*(M=S[0])+re*(z=S[2])-ee*(D=S[1]),S[5]=re*N+te*D+ee*M-Z*z,S[6]=ee*N+te*z+Z*D-re*M,S[7]=te*N-Z*M-re*D-ee*z,S},hi.rotateByQuatAppend=function(S,b,T){var M=T[0],D=T[1],z=T[2],N=T[3],B=b[0],F=b[1],U=b[2],q=b[3];return S[0]=B*N+q*M+F*z-U*D,S[1]=F*N+q*D+U*M-B*z,S[2]=U*N+q*z+B*D-F*M,S[3]=q*N-B*M-F*D-U*z,S[4]=(B=b[4])*N+(q=b[7])*M+(F=b[5])*z-(U=b[6])*D,S[5]=F*N+q*D+U*M-B*z,S[6]=U*N+q*z+B*D-F*M,S[7]=q*N-B*M-F*D-U*z,S},hi.rotateByQuatPrepend=function(S,b,T){var M=b[0],D=b[1],z=b[2],N=b[3],B=T[0],F=T[1],U=T[2],q=T[3];return S[0]=M*q+N*B+D*U-z*F,S[1]=D*q+N*F+z*B-M*U,S[2]=z*q+N*U+M*F-D*B,S[3]=N*q-M*B-D*F-z*U,S[4]=M*(q=T[7])+N*(B=T[4])+D*(U=T[6])-z*(F=T[5]),S[5]=D*q+N*F+z*B-M*U,S[6]=z*q+N*U+M*F-D*B,S[7]=N*q-M*B-D*F-z*U,S},hi.rotateAroundAxis=function(S,b,T,M){if(Math.abs(M)<e.EPSILON)return _(S,b);var D=Math.hypot(T[0],T[1],T[2]);M*=.5;var z=Math.sin(M),N=z*T[0]/D,B=z*T[1]/D,F=z*T[2]/D,U=Math.cos(M),q=b[0],Z=b[1],re=b[2],ee=b[3];S[0]=q*U+ee*N+Z*F-re*B,S[1]=Z*U+ee*B+re*N-q*F,S[2]=re*U+ee*F+q*B-Z*N,S[3]=ee*U-q*N-Z*B-re*F;var te=b[4],pe=b[5],ne=b[6],me=b[7];return S[4]=te*U+me*N+pe*F-ne*B,S[5]=pe*U+me*B+ne*N-te*F,S[6]=ne*U+me*F+te*B-pe*N,S[7]=me*U-te*N-pe*B-ne*F,S},hi.add=function(S,b,T){return S[0]=b[0]+T[0],S[1]=b[1]+T[1],S[2]=b[2]+T[2],S[3]=b[3]+T[3],S[4]=b[4]+T[4],S[5]=b[5]+T[5],S[6]=b[6]+T[6],S[7]=b[7]+T[7],S},hi.multiply=y,hi.scale=function(S,b,T){return S[0]=b[0]*T,S[1]=b[1]*T,S[2]=b[2]*T,S[3]=b[3]*T,S[4]=b[4]*T,S[5]=b[5]*T,S[6]=b[6]*T,S[7]=b[7]*T,S},hi.lerp=function(S,b,T,M){var D=1-M;return w(b,T)<0&&(M=-M),S[0]=b[0]*D+T[0]*M,S[1]=b[1]*D+T[1]*M,S[2]=b[2]*D+T[2]*M,S[3]=b[3]*D+T[3]*M,S[4]=b[4]*D+T[4]*M,S[5]=b[5]*D+T[5]*M,S[6]=b[6]*D+T[6]*M,S[7]=b[7]*D+T[7]*M,S},hi.invert=function(S,b){var T=x(b);return S[0]=-b[0]/T,S[1]=-b[1]/T,S[2]=-b[2]/T,S[3]=b[3]/T,S[4]=-b[4]/T,S[5]=-b[5]/T,S[6]=-b[6]/T,S[7]=b[7]/T,S},hi.conjugate=function(S,b){return S[0]=-b[0],S[1]=-b[1],S[2]=-b[2],S[3]=b[3],S[4]=-b[4],S[5]=-b[5],S[6]=-b[6],S[7]=b[7],S},hi.normalize=function(S,b){var T=x(b);if(T>0){T=Math.sqrt(T);var M=b[0]/T,D=b[1]/T,z=b[2]/T,N=b[3]/T,B=b[4],F=b[5],U=b[6],q=b[7],Z=M*B+D*F+z*U+N*q;S[0]=M,S[1]=D,S[2]=z,S[3]=N,S[4]=(B-M*Z)/T,S[5]=(F-D*Z)/T,S[6]=(U-z*Z)/T,S[7]=(q-N*Z)/T}return S},hi.str=function(S){return"quat2("+S[0]+", "+S[1]+", "+S[2]+", "+S[3]+", "+S[4]+", "+S[5]+", "+S[6]+", "+S[7]+")"},hi.exactEquals=function(S,b){return S[0]===b[0]&&S[1]===b[1]&&S[2]===b[2]&&S[3]===b[3]&&S[4]===b[4]&&S[5]===b[5]&&S[6]===b[6]&&S[7]===b[7]},hi.equals=function(S,b){var T=S[0],M=S[1],D=S[2],z=S[3],N=S[4],B=S[5],F=S[6],U=S[7],q=b[0],Z=b[1],re=b[2],ee=b[3],te=b[4],pe=b[5],ne=b[6],me=b[7];return Math.abs(T-q)<=e.EPSILON*Math.max(1,Math.abs(T),Math.abs(q))&&Math.abs(M-Z)<=e.EPSILON*Math.max(1,Math.abs(M),Math.abs(Z))&&Math.abs(D-re)<=e.EPSILON*Math.max(1,Math.abs(D),Math.abs(re))&&Math.abs(z-ee)<=e.EPSILON*Math.max(1,Math.abs(z),Math.abs(ee))&&Math.abs(N-te)<=e.EPSILON*Math.max(1,Math.abs(N),Math.abs(te))&&Math.abs(B-pe)<=e.EPSILON*Math.max(1,Math.abs(B),Math.abs(pe))&&Math.abs(F-ne)<=e.EPSILON*Math.max(1,Math.abs(F),Math.abs(ne))&&Math.abs(U-me)<=e.EPSILON*Math.max(1,Math.abs(U),Math.abs(me))},hi.sqrLen=hi.squaredLength=hi.len=hi.length=hi.dot=hi.mul=hi.setReal=hi.getReal=void 0;var e=a(Ne()),i=a(bi()),o=a(di());function l(S){if(typeof WeakMap!="function")return null;var b=new WeakMap,T=new WeakMap;return(l=function(M){return M?T:b})(S)}function a(S,b){if(S&&S.__esModule)return S;if(S===null||n(S)!=="object"&&typeof S!="function")return{default:S};var T=l(b);if(T&&T.has(S))return T.get(S);var M={},D=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var z in S)if(z!=="default"&&Object.prototype.hasOwnProperty.call(S,z)){var N=D?Object.getOwnPropertyDescriptor(S,z):null;N&&(N.get||N.set)?Object.defineProperty(M,z,N):M[z]=S[z]}return M.default=S,T&&T.set(S,M),M}function h(S,b,T){var M=.5*T[0],D=.5*T[1],z=.5*T[2],N=b[0],B=b[1],F=b[2],U=b[3];return S[0]=N,S[1]=B,S[2]=F,S[3]=U,S[4]=M*U+D*F-z*B,S[5]=D*U+z*N-M*F,S[6]=z*U+M*B-D*N,S[7]=-M*N-D*B-z*F,S}function _(S,b){return S[0]=b[0],S[1]=b[1],S[2]=b[2],S[3]=b[3],S[4]=b[4],S[5]=b[5],S[6]=b[6],S[7]=b[7],S}function y(S,b,T){var M=b[0],D=b[1],z=b[2],N=b[3],B=T[4],F=T[5],U=T[6],q=T[7],Z=b[4],re=b[5],ee=b[6],te=b[7],pe=T[0],ne=T[1],me=T[2],be=T[3];return S[0]=M*be+N*pe+D*me-z*ne,S[1]=D*be+N*ne+z*pe-M*me,S[2]=z*be+N*me+M*ne-D*pe,S[3]=N*be-M*pe-D*ne-z*me,S[4]=M*q+N*B+D*U-z*F+Z*be+te*pe+re*me-ee*ne,S[5]=D*q+N*F+z*B-M*U+re*be+te*ne+ee*pe-Z*me,S[6]=z*q+N*U+M*F-D*B+ee*be+te*me+Z*ne-re*pe,S[7]=N*q-M*B-D*F-z*U+te*be-Z*pe-re*ne-ee*me,S}hi.getReal=i.copy,hi.setReal=i.copy,hi.mul=y;var w=i.dot;hi.dot=w;var p=i.length;hi.length=p,hi.len=p;var x=i.squaredLength;return hi.squaredLength=x,hi.sqrLen=x,hi}var Bt,gi,Zt={};function qr(){if(Bt)return Zt;function n(b){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(T){return typeof T}:function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},n(b)}Bt=1,Object.defineProperty(Zt,"__esModule",{value:!0}),Zt.create=o,Zt.clone=function(b){var T=new e.ARRAY_TYPE(2);return T[0]=b[0],T[1]=b[1],T},Zt.fromValues=function(b,T){var M=new e.ARRAY_TYPE(2);return M[0]=b,M[1]=T,M},Zt.copy=function(b,T){return b[0]=T[0],b[1]=T[1],b},Zt.set=function(b,T,M){return b[0]=T,b[1]=M,b},Zt.add=function(b,T,M){return b[0]=T[0]+M[0],b[1]=T[1]+M[1],b},Zt.subtract=l,Zt.multiply=a,Zt.divide=h,Zt.ceil=function(b,T){return b[0]=Math.ceil(T[0]),b[1]=Math.ceil(T[1]),b},Zt.floor=function(b,T){return b[0]=Math.floor(T[0]),b[1]=Math.floor(T[1]),b},Zt.min=function(b,T,M){return b[0]=Math.min(T[0],M[0]),b[1]=Math.min(T[1],M[1]),b},Zt.max=function(b,T,M){return b[0]=Math.max(T[0],M[0]),b[1]=Math.max(T[1],M[1]),b},Zt.round=function(b,T){return b[0]=Math.round(T[0]),b[1]=Math.round(T[1]),b},Zt.scale=function(b,T,M){return b[0]=T[0]*M,b[1]=T[1]*M,b},Zt.scaleAndAdd=function(b,T,M,D){return b[0]=T[0]+M[0]*D,b[1]=T[1]+M[1]*D,b},Zt.distance=_,Zt.squaredDistance=y,Zt.length=w,Zt.squaredLength=p,Zt.negate=function(b,T){return b[0]=-T[0],b[1]=-T[1],b},Zt.inverse=function(b,T){return b[0]=1/T[0],b[1]=1/T[1],b},Zt.normalize=function(b,T){var M=T[0],D=T[1],z=M*M+D*D;return z>0&&(z=1/Math.sqrt(z)),b[0]=T[0]*z,b[1]=T[1]*z,b},Zt.dot=function(b,T){return b[0]*T[0]+b[1]*T[1]},Zt.cross=function(b,T,M){var D=T[0]*M[1]-T[1]*M[0];return b[0]=b[1]=0,b[2]=D,b},Zt.lerp=function(b,T,M,D){var z=T[0],N=T[1];return b[0]=z+D*(M[0]-z),b[1]=N+D*(M[1]-N),b},Zt.random=function(b,T){T=T||1;var M=2*e.RANDOM()*Math.PI;return b[0]=Math.cos(M)*T,b[1]=Math.sin(M)*T,b},Zt.transformMat2=function(b,T,M){var D=T[0],z=T[1];return b[0]=M[0]*D+M[2]*z,b[1]=M[1]*D+M[3]*z,b},Zt.transformMat2d=function(b,T,M){var D=T[0],z=T[1];return b[0]=M[0]*D+M[2]*z+M[4],b[1]=M[1]*D+M[3]*z+M[5],b},Zt.transformMat3=function(b,T,M){var D=T[0],z=T[1];return b[0]=M[0]*D+M[3]*z+M[6],b[1]=M[1]*D+M[4]*z+M[7],b},Zt.transformMat4=function(b,T,M){var D=T[0],z=T[1];return b[0]=M[0]*D+M[4]*z+M[12],b[1]=M[1]*D+M[5]*z+M[13],b},Zt.rotate=function(b,T,M,D){var z=T[0]-M[0],N=T[1]-M[1],B=Math.sin(D),F=Math.cos(D);return b[0]=z*F-N*B+M[0],b[1]=z*B+N*F+M[1],b},Zt.angle=function(b,T){var M=b[0],D=b[1],z=T[0],N=T[1],B=Math.sqrt(M*M+D*D)*Math.sqrt(z*z+N*N);return Math.acos(Math.min(Math.max(B&&(M*z+D*N)/B,-1),1))},Zt.zero=function(b){return b[0]=0,b[1]=0,b},Zt.str=function(b){return"vec2("+b[0]+", "+b[1]+")"},Zt.exactEquals=function(b,T){return b[0]===T[0]&&b[1]===T[1]},Zt.equals=function(b,T){var M=b[0],D=b[1],z=T[0],N=T[1];return Math.abs(M-z)<=e.EPSILON*Math.max(1,Math.abs(M),Math.abs(z))&&Math.abs(D-N)<=e.EPSILON*Math.max(1,Math.abs(D),Math.abs(N))},Zt.forEach=Zt.sqrLen=Zt.sqrDist=Zt.dist=Zt.div=Zt.mul=Zt.sub=Zt.len=void 0;var e=function(b,T){if(b&&b.__esModule)return b;if(b===null||n(b)!=="object"&&typeof b!="function")return{default:b};var M=i(void 0);if(M&&M.has(b))return M.get(b);var D={},z=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var N in b)if(N!=="default"&&Object.prototype.hasOwnProperty.call(b,N)){var B=z?Object.getOwnPropertyDescriptor(b,N):null;B&&(B.get||B.set)?Object.defineProperty(D,N,B):D[N]=b[N]}return D.default=b,M&&M.set(b,D),D}(Ne());function i(b){if(typeof WeakMap!="function")return null;var T=new WeakMap,M=new WeakMap;return(i=function(D){return D?M:T})(b)}function o(){var b=new e.ARRAY_TYPE(2);return e.ARRAY_TYPE!=Float32Array&&(b[0]=0,b[1]=0),b}function l(b,T,M){return b[0]=T[0]-M[0],b[1]=T[1]-M[1],b}function a(b,T,M){return b[0]=T[0]*M[0],b[1]=T[1]*M[1],b}function h(b,T,M){return b[0]=T[0]/M[0],b[1]=T[1]/M[1],b}function _(b,T){return Math.hypot(T[0]-b[0],T[1]-b[1])}function y(b,T){var M=T[0]-b[0],D=T[1]-b[1];return M*M+D*D}function w(b){return Math.hypot(b[0],b[1])}function p(b){var T=b[0],M=b[1];return T*T+M*M}Zt.len=w,Zt.sub=l,Zt.mul=a,Zt.div=h,Zt.dist=_,Zt.sqrDist=y,Zt.sqrLen=p;var x,S=(x=o(),function(b,T,M,D,z,N){var B,F;for(T||(T=2),M||(M=0),F=D?Math.min(D*T+M,b.length):b.length,B=M;B<F;B+=T)x[0]=b[B],x[1]=b[B+1],z(x,x,N),b[B]=x[0],b[B+1]=x[1];return b});return Zt.forEach=S,Zt}function yn(){if(gi)return ae;function n(b){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(T){return typeof T}:function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},n(b)}gi=1,Object.defineProperty(ae,"__esModule",{value:!0}),ae.vec4=ae.vec3=ae.vec2=ae.quat2=ae.quat=ae.mat4=ae.mat3=ae.mat2d=ae.mat2=ae.glMatrix=void 0;var e=S(Ne());ae.glMatrix=e;var i=S(et());ae.mat2=i;var o=S(gt());ae.mat2d=o;var l=S(ui());ae.mat3=l;var a=S(di());ae.mat4=a;var h=S(bi());ae.quat=h;var _=S(Ti());ae.quat2=_;var y=S(qr());ae.vec2=y;var w=S(ji());ae.vec3=w;var p=S(Yi());function x(b){if(typeof WeakMap!="function")return null;var T=new WeakMap,M=new WeakMap;return(x=function(D){return D?M:T})(b)}function S(b,T){if(b&&b.__esModule)return b;if(b===null||n(b)!=="object"&&typeof b!="function")return{default:b};var M=x(T);if(M&&M.has(b))return M.get(b);var D={},z=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var N in b)if(N!=="default"&&Object.prototype.hasOwnProperty.call(b,N)){var B=z?Object.getOwnPropertyDescriptor(b,N):null;B&&(B.get||B.set)?Object.defineProperty(D,N,B):D[N]=b[N]}return D.default=b,M&&M.set(b,D),D}return ae.vec4=p,ae}var fr,mt,Qt,Kt,J=yn(),pr=function(){if(mt)return fr;function n(e,i,o,l){this.cx=3*e,this.bx=3*(o-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(l-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=o,this.p2y=l}return mt=1,fr=n,n.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var o=e,l=0;l<8;l++){var a=this.sampleCurveX(o)-e;if(Math.abs(a)<i)return o;var h=this.sampleCurveDerivativeX(o);if(Math.abs(h)<1e-6)break;o-=a/h}var _=0,y=1;for(o=e,l=0;l<20&&(a=this.sampleCurveX(o),!(Math.abs(a-e)<i));l++)e>a?_=o:y=o,o=.5*(y-_)+_;return o},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},fr}(),ze=Q(pr);function Be(){if(Kt)return Qt;function n(e,i){this.x=e,this.y=i}return Kt=1,Qt=n,n.prototype={clone:function(){return new n(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,i){return this.clone()._rotateAround(e,i)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var i=e.x-this.x,o=e.y-this.y;return i*i+o*o},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,i){return Math.atan2(this.x*i-this.y*e,this.x*e+this.y*i)},_matMult:function(e){var i=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=i,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var i=Math.cos(e),o=Math.sin(e),l=o*this.x+i*this.y;return this.x=i*this.x-o*this.y,this.y=l,this},_rotateAround:function(e,i){var o=Math.cos(e),l=Math.sin(e),a=i.y+l*(this.x-i.x)+o*(this.y-i.y);return this.x=i.x+o*(this.x-i.x)-l*(this.y-i.y),this.y=a,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},n.convert=function(e){return e instanceof n?e:Array.isArray(e)?new n(e[0],e[1]):e},Qt}var we=Q(Be());function bt(n,e){if(Array.isArray(n)){if(!Array.isArray(e)||n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(!bt(n[i],e[i]))return!1;return!0}if(typeof n=="object"&&n!==null&&e!==null){if(typeof e!="object"||Object.keys(n).length!==Object.keys(e).length)return!1;for(const i in n)if(!bt(n[i],e[i]))return!1;return!0}return n===e}const Tt=Math.PI/180,St=180/Math.PI;function xt(n){return n*Tt}function Ut(n){return n*St}const Gt=[[0,0],[1,0],[1,1],[0,1]];function Nt(n){if(n<=0)return 0;if(n>=1)return 1;const e=n*n,i=e*n;return 4*(n<.5?i:3*(n-e)+i-.75)}function xi(n,e,i,o){const l=new ze(n,e,i,o);return function(a){return l.solve(a)}}const Jt=xi(.25,.1,.25,1);function Dt(n,e,i){return Math.min(i,Math.max(e,n))}function yi(n,e,i){return(i=Dt((i-n)/(e-n),0,1))*i*(3-2*i)}function Ji(n,e,i){const o=i-e,l=((n-e)%o+o)%o+e;return l===e?i:l}function gr(n,e,i){if(!n.length)return i(null,[]);let o=n.length;const l=new Array(n.length);let a=null;n.forEach((h,_)=>{e(h,(y,w)=>{y&&(a=y),l[_]=w,--o==0&&i(a,l)})})}function Gi(n,...e){for(const i of e)for(const o in i)n[o]=i[o];return n}let Kr=1;function Vr(){return Kr++}function zn(n){return n<=1?1:Math.pow(2,Math.ceil(Math.log(n)/Math.LN2))}function Ln(n,e){n.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function ns(n,e,i){const o={};for(const l in n)o[l]=e.call(this,n[l],l,n);return o}function Hs(n,e,i){const o={};for(const l in n)e.call(this,n[l],l,n)&&(o[l]=n[l]);return o}function Or(n){return Array.isArray(n)?n.map(Or):typeof n=="object"&&n?ns(n,Or):n}const En={};function br(n){En[n]||(typeof console<"u"&&console.warn(n),En[n]=!0)}function ar(n,e,i){return(i.y-n.y)*(e.x-n.x)>(e.y-n.y)*(i.x-n.x)}function Bl(n){let e=0;for(let i,o,l=0,a=n.length,h=a-1;l<a;h=l++)i=n[l],o=n[h],e+=(o.x-i.x)*(i.y+o.y);return e}function Pa([n,e,i]){const o=xt(e+90),l=xt(i);return{x:n*Math.cos(o)*Math.sin(l),y:n*Math.sin(o)*Math.sin(l),z:n*Math.cos(l),azimuthal:e,polar:i}}function Nn(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function sa(n){const e={};if(n.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,o,l,a)=>{const h=l||a;return e[o]=!h||h.toLowerCase(),""}),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Nl=null;function Ra(n,e){return[n[4*e],n[4*e+1],n[4*e+2],n[4*e+3]]}function Hc(n,e,i,o){for(;e<i;){const l=e+i>>1;n[l]<o?e=l+1:i=l}return e}function Zc(n,e,i,o){for(;e<i;){const l=e+i>>1;n[l]<=o?e=l+1:i=l}return e}function Vl(n){return n>0?1/(1.001-n):1+n}function $e(n){return n>0?1-1/(1.001-n):-n}const X={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!X.API_URL)return null;try{const n=new URL(X.API_URL);return n.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":n.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function Y(n){return X.API_URL_REGEX.test(n)}function le(n){return X.API_SPRITE_REGEX.test(n)}let ge,ye,Se,Ve,Ae,Ge;function We(){return ge==null&&(ge=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),ge}const qe={now:()=>Ve!==void 0?Ve:performance.now(),setNow(n){Ve=n},restoreNow(){Ve=void 0},frame(n){const e=requestAnimationFrame(n);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(n,e=0){const{width:i,height:o}=n;Ae||(Ae=document.createElement("canvas"));const l=Ae.getContext("2d",{willReadFrequently:!0});if(!l)throw new Error("failed to create canvas 2d context");return(i>Ae.width||o>Ae.height)&&(Ae.width=i,Ae.height=o),l.clearRect(-e,-e,i+2*e,o+2*e),l.drawImage(n,0,0,i,o),l.getImageData(-e,-e,i+2*e,o+2*e)},resolveURL:n=>(ye||(ye=document.createElement("a")),ye.href=n,ye.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Se==null&&(Se=window.matchMedia("(prefers-reduced-motion: reduce)")),Se.matches)},hasCanvasFingerprintNoise(){if(Ge!==void 0)return Ge;if(!We())return Ge=!1,!1;const n=new OffscreenCanvas(85,1),e=n.getContext("2d",{willReadFrequently:!0});let i=0;for(let l=0;l<n.width;++l)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(l,0,1,1);const o=e.getImageData(0,0,n.width,n.height);i=0;for(let l=0;l<o.data.length;++l)if(l%4!=3&&i++!==o.data[l])return Ge=!0,!0;return Ge=!1,!1}};function lt(n,e){const i=n.indexOf("?");if(i<0)return`${n}?${new URLSearchParams(e).toString()}`;const o=new URLSearchParams(n.slice(i));for(const l in e)o.set(l,e[l]);return`${n.slice(0,i)}?${o.toString()}`}function Mt(n,e={persistentParams:[]}){const i=n.indexOf("?");if(i<0)return n;const o=new URLSearchParams,l=new URLSearchParams(n.slice(i));for(const h of e.persistentParams){const _=l.get(h);_&&o.set(h,_)}const a=o.toString();return`${n.slice(0,i)}${a.length>0?`?${a}`:""}`}const Rt="mapbox-tiles";let ai=500,fi=50;const pi=["language","worldview","jobid"];let vi,mr;function Ar(){try{return caches}catch{}}function Mi(){const n=Ar();n&&vi==null&&(vi=n.open(Rt))}let Qi=1/0;const er={supported:!1,testSupport:function(n){!an&&Br&&(Mn?On(n):rr=n)}};let rr,Br,an=!1,Mn=!1;const ys=typeof self<"u"?self:{};function On(n){const e=n.createTexture();n.bindTexture(n.TEXTURE_2D,e);try{if(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,Br),n.isContextLost())return;er.supported=!0}catch{}n.deleteTexture(e),an=!0}ys.document&&(Br=ys.document.createElement("img"),Br.onload=function(){rr&&On(rr),rr=null,Mn=!0},Br.onerror=function(){an=!0,rr=null},Br.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const ln={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(ln);class hn extends Error{constructor(e,i,o){i===401&&Y(o)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=o}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Da=Nn()?()=>self.worker&&self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,vs=function(n,e){if(!(/^file:/.test(i=n.url)||/^file:/.test(Da())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(o,l){const a=new AbortController,h=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,referrer:Da(),referrerPolicy:o.referrerPolicy,signal:a.signal});let _=!1,y=!1;const w=(p=h.url).indexOf("sku=")>0&&Y(p);var p;o.type==="json"&&h.headers.set("Accept","application/json");const x=(b,T,M)=>{if(y)return;if(b&&b.message!=="SecurityError"&&br(b.toString()),T&&M)return S(T);const D=Date.now();fetch(h).then(z=>{if(z.ok){const N=w?z.clone():null;return S(z,N,D)}return l(new hn(z.statusText,z.status,o.url))}).catch(z=>{z.name!=="AbortError"&&l(new Error(`${z.message} ${o.url}`))})},S=(b,T,M)=>{(o.type==="arrayBuffer"?b.arrayBuffer():o.type==="json"?b.json():b.text()).then(D=>{y||(T&&M&&function(z,N,B){if(Mi(),vi==null)return;const F=sa(N.headers.get("Cache-Control")||"");if(F["no-store"])return;const U={status:N.status,statusText:N.statusText,headers:new Headers};N.headers.forEach((re,ee)=>U.headers.set(ee,re)),F["max-age"]&&U.headers.set("Expires",new Date(B+1e3*F["max-age"]).toUTCString());const q=U.headers.get("Expires");if(!q||new Date(q).getTime()-B<42e4)return;let Z=Mt(z.url,{persistentParams:pi});if(N.status===206){const re=z.headers.get("Range");if(!re)return;U.status=200,Z=lt(Z,{range:re})}(function(re,ee){if(mr===void 0)try{new Response(new ReadableStream),mr=!0}catch{mr=!1}mr?ee(re.body):re.blob().then(ee)})(N,re=>{const ee=new Response((te=N.status)!==200&&te!==404&&[101,103,204,205,304].includes(te)?null:re,U);var te;Mi(),vi!=null&&vi.then(pe=>pe.put(Z,ee)).catch(pe=>br(pe.message))})}(h,T,M),_=!0,l(null,D,b.headers.get("Cache-Control"),b.headers.get("Expires")))}).catch(D=>{y||l(new Error(D.message))})};return w?function(b,T){if(Mi(),vi==null)return T(null);vi.then(M=>{let D=Mt(b.url,{persistentParams:pi});const z=b.headers.get("Range");z&&(D=lt(D,{range:z})),M.match(D).then(N=>{const B=function(F){if(!F)return!1;const U=new Date(F.headers.get("Expires")||0),q=sa(F.headers.get("Cache-Control")||"");return U>Date.now()&&!q["no-cache"]}(N);M.delete(D),B&&M.put(D,N.clone()),T(null,N,B)}).catch(T)}).catch(T)}(h,x):x(null,null),{cancel:()=>{y=!0,_||a.abort()}}}(n,e);if(Nn()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",n,e,void 0,!0)}var i;return function(o,l){const a=new XMLHttpRequest;a.open(o.method||"GET",o.url,!0),o.type==="arrayBuffer"&&(a.responseType="arraybuffer");for(const h in o.headers)a.setRequestHeader(h,o.headers[h]);return o.type==="json"&&(a.responseType="text",a.setRequestHeader("Accept","application/json")),a.withCredentials=o.credentials==="include",a.onerror=()=>{l(new Error(a.statusText))},a.onload=()=>{if((a.status>=200&&a.status<300||a.status===0)&&a.response!==null){let h=a.response;if(o.type==="json")try{h=JSON.parse(a.response)}catch(_){return l(_)}l(null,h,a.getResponseHeader("Cache-Control"),a.getResponseHeader("Expires"))}else l(new hn(a.statusText,a.status,o.url))},a.send(o.body),{cancel:()=>a.abort()}}(n,e)},so=function(n,e){return vs(Gi(n,{type:"arrayBuffer"}),e)};function Th(n){const e=document.createElement("a");return e.href=n,e.protocol===location.protocol&&e.host===location.host}const Wc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Ul,za;Ul=[],za=0;const Sh=function(n,e){if(er.supported&&(n.headers||(n.headers={}),n.headers.accept="image/webp,*/*"),za>=X.MAX_PARALLEL_IMAGE_REQUESTS){const a={requestParameters:n,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Ul.push(a),a}za++;let i=!1;const o=()=>{if(!i)for(i=!0,za--;Ul.length&&za<X.MAX_PARALLEL_IMAGE_REQUESTS;){const a=Ul.shift(),{requestParameters:h,callback:_,cancelled:y}=a;y||(a.cancel=Sh(h,_).cancel)}},l=so(n,(a,h,_,y)=>{o(),a?e(a):h&&(self.createImageBitmap?function(w,p){const x=new Blob([new Uint8Array(w)],{type:"image/png"});createImageBitmap(x).then(S=>{p(null,S)}).catch(S=>{p(new Error(`Could not load image because of ${S.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(h,(w,p)=>e(w,p,_,y)):function(w,p){const x=new Image;x.onload=()=>{p(null,x),URL.revokeObjectURL(x.src),x.onload=null,requestAnimationFrame(()=>{x.src=Wc})},x.onerror=()=>p(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const S=new Blob([new Uint8Array(w)],{type:"image/png"});x.src=w.byteLength?URL.createObjectURL(S):Wc}(h,(w,p)=>e(w,p,_,y)))});return{cancel:()=>{l.cancel(),o()}}};var Kf,Yf,Eh,La={exports:{}},ss={exports:{}},zs={exports:{}},zo=function(){if(Eh)return La.exports;Eh=1;var n=(Kf||(Kf=1,ss.exports=function(i,o){var l,a,h,_,y,w,p,x;for(a=i.length-(l=3&i.length),h=o,y=3432918353,w=461845907,x=0;x<a;)p=255&i.charCodeAt(x)|(255&i.charCodeAt(++x))<<8|(255&i.charCodeAt(++x))<<16|(255&i.charCodeAt(++x))<<24,++x,h=27492+(65535&(_=5*(65535&(h=(h^=p=(65535&(p=(p=(65535&p)*y+(((p>>>16)*y&65535)<<16)&4294967295)<<15|p>>>17))*w+(((p>>>16)*w&65535)<<16)&4294967295)<<13|h>>>19))+((5*(h>>>16)&65535)<<16)&4294967295))+((58964+(_>>>16)&65535)<<16);switch(p=0,l){case 3:p^=(255&i.charCodeAt(x+2))<<16;case 2:p^=(255&i.charCodeAt(x+1))<<8;case 1:h^=p=(65535&(p=(p=(65535&(p^=255&i.charCodeAt(x)))*y+(((p>>>16)*y&65535)<<16)&4294967295)<<15|p>>>17))*w+(((p>>>16)*w&65535)<<16)&4294967295}return h^=i.length,h=2246822507*(65535&(h^=h>>>16))+((2246822507*(h>>>16)&65535)<<16)&4294967295,h=3266489909*(65535&(h^=h>>>13))+((3266489909*(h>>>16)&65535)<<16)&4294967295,(h^=h>>>16)>>>0}),ss.exports),e=(Yf||(Yf=1,zs.exports=function(i,o){for(var l,a=i.length,h=o^a,_=0;a>=4;)l=1540483477*(65535&(l=255&i.charCodeAt(_)|(255&i.charCodeAt(++_))<<8|(255&i.charCodeAt(++_))<<16|(255&i.charCodeAt(++_))<<24))+((1540483477*(l>>>16)&65535)<<16),h=1540483477*(65535&h)+((1540483477*(h>>>16)&65535)<<16)^(l=1540483477*(65535&(l^=l>>>24))+((1540483477*(l>>>16)&65535)<<16)),a-=4,++_;switch(a){case 3:h^=(255&i.charCodeAt(_+2))<<16;case 2:h^=(255&i.charCodeAt(_+1))<<8;case 1:h=1540483477*(65535&(h^=255&i.charCodeAt(_)))+((1540483477*(h>>>16)&65535)<<16)}return h=1540483477*(65535&(h^=h>>>13))+((1540483477*(h>>>16)&65535)<<16),(h^=h>>>15)>>>0}),zs.exports);return La.exports=n,La.exports.murmur3=n,La.exports.murmur2=e,La.exports}(),os=Q(zo);class Hn{constructor(e,...i){Gi(this,i[0]||{}),this.type=e}}class Oa extends Hn{constructor(e,i={}){super("error",Gi({error:e},i))}}function Mh(n,e,i){i[n]&&i[n].indexOf(e)!==-1||(i[n]=i[n]||[],i[n].push(e))}function Xc(n,e,i){if(i&&i[n]){const o=i[n].indexOf(e);o!==-1&&i[n].splice(o,1)}}class Ls{on(e,i){return this._listeners=this._listeners||{},Mh(e,i,this._listeners),this}off(e,i){return Xc(e,i,this._listeners),Xc(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},Mh(e,i,this._oneTimeListeners),this):new Promise(o=>{this.once(e,o)})}fire(e,i){const o=typeof e=="string"?new Hn(e,i):e,l=o.type;if(this.listens(l)){o.target=this;const a=this._listeners&&this._listeners[l]?this._listeners[l].slice():[];for(const y of a)y.call(this,o);const h=this._oneTimeListeners&&this._oneTimeListeners[l]?this._oneTimeListeners[l].slice():[];for(const y of h)Xc(l,y,this._oneTimeListeners),y.call(this,o);const _=this._eventedParent;_&&(Gi(o,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),_.fire(o))}else o instanceof Oa&&console.error(o.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class Vn{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new Vn(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){const[i,o]=e.split("");return new Vn({name:i,iconsetId:o})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return Vn.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Jf,Ah={},xs=function(){if(Jf)return Ah;Jf=1;var n={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(a){return(a=Math.round(a))<0?0:a>255?255:a}function i(a){return e(a[a.length-1]==="%"?parseFloat(a)/100*255:parseInt(a))}function o(a){return(h=a[a.length-1]==="%"?parseFloat(a)/100:parseFloat(a))<0?0:h>1?1:h;var h}function l(a,h,_){return _<0?_+=1:_>1&&(_-=1),6*_<1?a+(h-a)*_*6:2*_<1?h:3*_<2?a+(h-a)*(2/3-_)*6:a}try{Ah.parseCSSColor=function(a){var h,_=a.replace(/ /g,"").toLowerCase();if(_ in n)return n[_].slice();if(_[0]==="#")return _.length===4?(h=parseInt(_.substr(1),16))>=0&&h<=4095?[(3840&h)>>4|(3840&h)>>8,240&h|(240&h)>>4,15&h|(15&h)<<4,1]:null:_.length===7&&(h=parseInt(_.substr(1),16))>=0&&h<=16777215?[(16711680&h)>>16,(65280&h)>>8,255&h,1]:null;var y=_.indexOf("("),w=_.indexOf(")");if(y!==-1&&w+1===_.length){var p=_.substr(0,y),x=_.substr(y+1,w-(y+1)).split(","),S=1;switch(p){case"rgba":if(x.length!==4)return null;S=o(x.pop());case"rgb":return x.length!==3?null:[i(x[0]),i(x[1]),i(x[2]),S];case"hsla":if(x.length!==4)return null;S=o(x.pop());case"hsl":if(x.length!==3)return null;var b=(parseFloat(x[0])%360+360)%360/360,T=o(x[1]),M=o(x[2]),D=M<=.5?M*(T+1):M+T-M*T,z=2*M-D;return[e(255*l(z,D,b+1/3)),e(255*l(z,D,b)),e(255*l(z,D,b-1/3)),S];default:return null}}return null}}catch{}return Ah}();class tr{constructor(e,i,o,l=1){this.r=e,this.g=i,this.b=o,this.a=l}static parse(e){if(!e)return;if(e instanceof tr)return e;if(typeof e!="string")return;const i=xs.parseCSSColor(e);return i?new tr(i[0]/255*i[3],i[1]/255*i[3],i[2]/255*i[3],i[3]):void 0}toStringPremultipliedAlpha(){const[e,i,o,l]=this.a===0?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(e)},${Math.round(i)},${Math.round(o)},${l})`}toString(){const[e,i,o,l]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*o)},${l})`}toRenderColor(e){const{r:i,g:o,b:l,a}=this;return new Ih(e,i,o,l,a)}clone(){return new tr(this.r,this.g,this.b,this.a)}}class Ih{constructor(e,i,o,l,a){if(e){const h=e.image.height,_=h*h;i=a===0?0:i/a*(h-1),o=a===0?0:o/a*(h-1),l=a===0?0:l/a*(h-1);const y=Math.floor(i),w=Math.floor(o),p=Math.floor(l),x=Math.ceil(i),S=Math.ceil(o),b=Math.ceil(l),T=i-y,M=o-w,D=l-p,z=e.image.data,N=4*(y+w*_+p*h),B=4*(y+w*_+b*h),F=4*(y+S*_+p*h),U=4*(y+S*_+b*h),q=4*(x+w*_+p*h),Z=4*(x+w*_+b*h),re=4*(x+S*_+p*h),ee=4*(x+S*_+b*h);if(N<0||ee>=z.length)throw new Error("out of range");this.r=Xt(Xt(Xt(z[N],z[B],D),Xt(z[F],z[U],D),M),Xt(Xt(z[q],z[Z],D),Xt(z[re],z[ee],D),M),T)/255*a,this.g=Xt(Xt(Xt(z[N+1],z[B+1],D),Xt(z[F+1],z[U+1],D),M),Xt(Xt(z[q+1],z[Z+1],D),Xt(z[re+1],z[ee+1],D),M),T)/255*a,this.b=Xt(Xt(Xt(z[N+2],z[B+2],D),Xt(z[F+2],z[U+2],D),M),Xt(Xt(z[q+2],z[Z+2],D),Xt(z[re+2],z[ee+2],D),M),T)/255*a,this.a=a}else this.r=i,this.g=o,this.b=l,this.a=a}toArray(){const{r:e,g:i,b:o,a:l}=this;return l===0?[0,0,0,0]:[255*e/l,255*i/l,255*o/l,l]}toHslaArray(){if(this.a===0)return[0,0,0,0];const{r:e,g:i,b:o,a:l}=this,a=Math.min(Math.max(e/l,0),1),h=Math.min(Math.max(i/l,0),1),_=Math.min(Math.max(o/l,0),1),y=Math.min(a,h,_),w=Math.max(a,h,_),p=(y+w)/2;if(y===w)return[0,0,100*p,l];const x=w-y,S=p>.5?x/(2-w-y):x/(w+y);let b=0;return w===a?b=(h-_)/x+(h<_?6:0):w===h?b=(_-a)/x+2:w===_&&(b=(a-h)/x+4),b*=60,[Math.min(Math.max(b,0),360),Math.min(Math.max(100*S,0),100),Math.min(Math.max(100*p,0),100),l]}toArray01(){const{r:e,g:i,b:o,a:l}=this;return l===0?[0,0,0,0]:[e/l,i/l,o/l,l]}toArray01Scaled(e){const{r:i,g:o,b:l,a}=this;return a===0?[0,0,0]:[i/a*e,o/a*e,l/a*e]}toArray01PremultipliedAlpha(){const{r:e,g:i,b:o,a:l}=this;return[e,i,o,l]}toArray01Linear(){const{r:e,g:i,b:o,a:l}=this;return l===0?[0,0,0,0]:[Math.pow(e/l,2.2),Math.pow(i/l,2.2),Math.pow(o/l,2.2),l]}}function Xt(n,e,i){return n*(1-i)+e*i}function Qf(n,e,i){return n.map((o,l)=>Xt(o,e[l],i))}function ep(n){return n*n*n*n*n}tr.black=new tr(0,0,0,1),tr.white=new tr(1,1,1,1),tr.transparent=new tr(0,0,0,0),tr.red=new tr(1,0,0,1),tr.blue=new tr(0,0,1,1);var jl=Object.freeze({__proto__:null,array:Qf,color:function(n,e,i){return new tr(Xt(n.r,e.r,i),Xt(n.g,e.g,i),Xt(n.b,e.b,i),Xt(n.a,e.a,i))},easeIn:ep,number:Xt});function qi(n,...e){for(const i of e)for(const o in i)n[o]=i[o];return n}class bs extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class Kc{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[o,l]of i)this.bindings[o]=l}concat(e){return new Kc(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const ka={kind:"null"},Ft={kind:"number"},Ki={kind:"string"},Fi={kind:"boolean"},An={kind:"color"},Fa={kind:"object"},$i={kind:"value"},oo={kind:"collator"},Gl={kind:"formatted"},ao={kind:"resolvedImage"};function vn(n,e){return{kind:"array",itemType:n,N:e}}function Nr(n){if(n.kind==="array"){const e=Nr(n.itemType);return typeof n.N=="number"?`array<${e}, ${n.N}>`:n.itemType.kind==="value"?"array":`array<${e}>`}return n.kind}const Os=[ka,Ft,Ki,Fi,An,Gl,Fa,vn($i),ao];function Ba(n,e){if(e.kind==="error")return null;if(n.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Ba(n.itemType,e.itemType))&&(typeof n.N!="number"||n.N===e.N))return null}else{if(n.kind===e.kind)return null;if(n.kind==="value"){for(const i of Os)if(!Ba(i,e))return null}}return`Expected ${Nr(n)} but found ${Nr(e)} instead.`}function Ch(n,e){return e.some(i=>i.kind===n.kind)}function Na(n,e){return e.some(i=>i==="null"?n===null:i==="array"?Array.isArray(n):i==="object"?n&&!Array.isArray(n)&&typeof n=="object":i===typeof n)}class Yc{constructor(e,i,o){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class ql{constructor(e,i,o,l,a){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=o,this.fontStack=l,this.textColor=a}}class In{constructor(e){this.sections=e}static fromString(e){return new In([new ql(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof In?e:In.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){const l=i.image.getPrimary().id.toString();e.push(["image",l]);continue}e.push(i.text);const o={};i.fontStack&&(o["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(o["font-scale"]=i.scale),i.textColor&&(o["text-color"]=["rgba"].concat(i.textColor.toRenderColor(null).toArray())),e.push(o)}return e}}class Zs{constructor(e,i={}){if(this.id=Vn.from(e),this.options=Object.assign({},i),i.transform){const{a:o,b:l,c:a,d:h,e:_,f:y}=i.transform;this.options.transform=new DOMMatrix([o,l,a,h,_,y])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:e,b:i,c:o,d:l,e:a,f:h}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:i,c:o,d:l,e:a,f:h}})}static parse(e){let i,o,l,a;try{({name:i,iconsetId:o,params:l,transform:a}=JSON.parse(e)||{})}catch{return null}if(!i)return null;const{a:h,b:_,c:y,d:w,e:p,f:x}=a||{};return new Zs({name:i,iconsetId:o},{params:l,transform:new DOMMatrix([h,_,y,w,p,x])})}scaleSelf(e){return this.options.transform.scaleSelf(e),this}}class Cn{constructor(e,i,o,l,a=!1){this.primaryId=Vn.from(e),this.primaryOptions=i,o&&(this.secondaryId=Vn.from(o)),this.secondaryOptions=l,this.available=a}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Zs(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Zs(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?Cn.build({name:e}):e}static build(e,i,o,l){return!e||typeof e=="object"&&!("name"in e)?null:new Cn(e,o,i,l)}}function $l(n,e,i,o){return typeof n=="number"&&n>=0&&n<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[n,e,i,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[n,e,i,o]:[n,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function ks(n){if(n===null||typeof n=="string"||typeof n=="boolean"||typeof n=="number"||n instanceof tr||n instanceof Yc||n instanceof In||n instanceof Cn)return!0;if(Array.isArray(n)){for(const e of n)if(!ks(e))return!1;return!0}if(typeof n=="object"){for(const e in n)if(!ks(n[e]))return!1;return!0}return!1}function Yr(n){if(n===null)return ka;if(typeof n=="string")return Ki;if(typeof n=="boolean")return Fi;if(typeof n=="number")return Ft;if(n instanceof tr)return An;if(n instanceof Yc)return oo;if(n instanceof In)return Gl;if(n instanceof Cn)return ao;if(Array.isArray(n)){const e=n.length;let i;for(const o of n){const l=Yr(o);if(i){if(i===l)continue;i=$i;break}i=l}return vn(i||$i,e)}return Fa}function cn(n){const e=typeof n;return n===null?"":e==="string"||e==="number"||e==="boolean"?String(n):n instanceof tr?n.toStringPremultipliedAlpha():n instanceof In||n instanceof Cn?n.toString():JSON.stringify(n)}class lo{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!ks(e[1]))return i.error("invalid value");const o=e[1];let l=Yr(o);const a=i.expectedType;return l.kind!=="array"||l.N!==0||!a||a.kind!=="array"||typeof a.N=="number"&&a.N!==0||(l=a),new lo(l,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof tr?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof In?this.value.serialize():this.value}}class Ur{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const Ph={string:Ki,number:Ft,boolean:Fi,object:Fa};class as{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let o,l=1;const a=e[0];if(a==="array"){let _,y;if(e.length>2){const w=e[1];if(typeof w!="string"||!(w in Ph)||w==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);_=Ph[w],l++}else _=$i;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);y=e[2],l++}o=vn(_,y)}else o=Ph[a];const h=[];for(;l<e.length;l++){const _=i.parse(e[l],l,$i);if(!_)return null;h.push(_)}return new as(o,h)}evaluate(e){for(let i=0;i<this.args.length;i++){const o=this.args[i].evaluate(e);if(!Ba(this.type,Yr(o)))return o;if(i===this.args.length-1)throw new Ur(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${Nr(Yr(o))} but was expected to be of type ${Nr(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const o=e.itemType;if(o.kind==="string"||o.kind==="number"||o.kind==="boolean"){i.push(o.kind);const l=e.N;(typeof l=="number"||this.args.length>1)&&i.push(l)}}return i.concat(this.args.map(o=>o.serialize()))}}class Va{constructor(e){this.type=Gl,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[1];if(!Array.isArray(o)&&typeof o=="object")return i.error("First argument must be an image or text section.");const l=[];let a=!1;for(let h=1;h<=e.length-1;++h){const _=e[h];if(a&&typeof _=="object"&&!Array.isArray(_)){a=!1;let y=null;if(_["font-scale"]&&(y=i.parseObjectValue(_["font-scale"],h,"font-scale",Ft),!y))return null;let w=null;if(_["text-font"]&&(w=i.parseObjectValue(_["text-font"],h,"text-font",vn(Ki)),!w))return null;let p=null;if(_["text-color"]&&(p=i.parseObjectValue(_["text-color"],h,"text-color",An),!p))return null;const x=l[l.length-1];x.scale=y,x.font=w,x.textColor=p}else{const y=i.parse(e[h],h,$i);if(!y)return null;const w=y.type.kind;if(w!=="string"&&w!=="value"&&w!=="null"&&w!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");a=!0,l.push({content:y,scale:null,font:null,textColor:null})}}return new Va(l)}evaluate(e){return new In(this.sections.map(i=>{const o=i.content.evaluate(e);return Yr(o)===ao?new ql("",o,null,null,null):new ql(cn(o),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const o={};i.scale&&(o["font-scale"]=i.scale.serialize()),i.font&&(o["text-font"]=i.font.serialize()),i.textColor&&(o["text-color"]=i.textColor.serialize()),e.push(o)}return e}}class Lo{constructor(e,i,o,l){this._imageWarnHistory={},this.type=ao,this.namePrimary=e,this.nameSecondary=i,o&&(this.paramsPrimary=o.params,this.iconsetIdPrimary=o.iconset?o.iconset.id:void 0),l&&(this.paramsSecondary=l.params,this.iconsetIdSecondary=l.iconset?l.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let o=1;const l=[];function a(){if(o<e.length){const _=i.parse(e[o],o++,Ki);return _?(l.push({image:_,options:{}}),!0):(i.error(l.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function h(){if(o<e.length){const y=e[o];if((_=y)===null||typeof _!="object"||Array.isArray(_))return!0;const w=y.params,p=y.iconset,x=i.concat(o);if(!w&&!p)return o++,!0;if(w){if(typeof w!="object"||w.constructor!==Object)return x.error('Image options "params" should be an object'),!1;const S={},b=x.concat(void 0,"params");for(const T in w){if(!T)return b.error("Image parameter name should be non-empty"),!1;const M=b.concat(void 0,T).parse(w[T],void 0,An,void 0,{typeAnnotation:"coerce"});if(!M)return!1;S[T]=M}l[l.length-1].options.params=S}if(p){if(typeof p!="object"||p.constructor!==Object)return x.error('Image options "iconset" should be an object'),!1;if(!p.id)return x.error('Image options "iconset" should have an "id" property'),!1;l[l.length-1].options.iconset=p}return o++,!0}var _;return!0}for(let _=0;_<2;_++)if(!a()||!h())return;return new Lo(l[0].image,l[1]?l[1].image:void 0,l[0].options,l[1]?l[1].options:void 0)}evaluateParams(e,i){const o={};if(i){for(const l in i)if(i[l])try{o[l]=i[l].evaluate(e)}catch{continue}if(Object.keys(o).length!==0)return{params:o}}}evaluate(e){const i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},o=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,l=Cn.build(i,o,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(l&&e.availableImages){const a=l.getPrimary().id;if(l.available=e.availableImages.some(h=>Vn.isEqual(h,a)),l.available){const h=l.getSecondary()?l.getSecondary().id:null;h&&(l.available=e.availableImages.some(_=>Vn.isEqual(_,h)))}}return l}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){const o={};if(i&&(o.iconset={id:i}),e){o.params={};for(const l in e)e[l]&&(o.params[l]=e[l].serialize())}return Object.keys(o).length>0?o:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function co(n){return n instanceof Number?"number":n instanceof String?"string":n instanceof Boolean?"boolean":Array.isArray(n)?"array":n===null?"null":typeof n}const P_={"to-boolean":Fi,"to-color":An,"to-number":Ft,"to-string":Ki};class uo{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[0],l=[];let a=ka;if(o==="to-array"){if(!Array.isArray(e[1]))return null;const h=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);a=vn(i.expectedType.itemType,h)}else{if(!(h>0&&ks(e[1][0])))return null;a=vn(Yr(e[1][0]),h)}for(let _=0;_<h;_++){const y=e[1][_];let w;if(co(y)==="array")w=i.parse(y,void 0,a.itemType);else{const p=co(y);if(p!==a.itemType.kind)return i.error(`Expected ${a.itemType.kind} but found ${p}.`);w=i.registry.literal.parse(["literal",y===void 0?null:y],i)}if(!w)return null;l.push(w)}}else{if((o==="to-boolean"||o==="to-string")&&e.length!==2)return i.error("Expected one argument.");a=P_[o];for(let h=1;h<e.length;h++){const _=i.parse(e[h],h,$i);if(!_)return null;l.push(_)}}return new uo(a,l)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,o;for(const l of this.args){if(i=l.evaluate(e),o=null,i instanceof tr)return i;if(typeof i=="string"){const a=e.parseColor(i);if(a)return a}else if(Array.isArray(i)&&(o=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:$l(i[0],i[1],i[2],i[3]),!o))return new tr(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new Ur(o||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const o of this.args){if(i=o.evaluate(e),i===null)return 0;const l=Number(i);if(!isNaN(l))return l}throw new Ur(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?In.fromString(cn(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Cn.build(cn(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(i=>i.evaluate(e)):cn(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Va([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Lo(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}const R_=["Unknown","Point","LineString","Polygon"];class Jc{constructor(e,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?R_[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:o,y:l}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(o*i-e[0])+this.featureDistanceData.bearing[1]*(l*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=tr.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class kn{constructor(e,i,o,l,a){this.name=e,this.type=i,this._evaluate=o,this.args=l,this._overloadIndex=a}evaluate(e){if(!this._evaluate){const i=kn.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){const o=e[0],l=kn.definitions[o];if(!l)return i.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);const a=Array.isArray(l)?l[0]:l.type,h=Array.isArray(l)?[[l[1],l[2]]]:l.overloads,_=[];let y=null,w=-1;for(const[p,x]of h){if(Array.isArray(p)&&p.length!==e.length-1)continue;_.push(p),w++,y=new Fh(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);const S=[];let b=!1;for(let T=1;T<e.length;T++){const M=e[T],D=Array.isArray(p)?p[T-1]:p.type,z=y.parse(M,1+S.length,D);if(!z){b=!0;break}S.push(z)}if(!b)if(Array.isArray(p)&&p.length!==S.length)y.error(`Expected ${p.length} arguments, but found ${S.length} instead.`);else{for(let T=0;T<S.length;T++){const M=Array.isArray(p)?p[T]:p.type,D=S[T];y.concat(T+1).checkSubtype(M,D.type)}if(y.errors.length===0)return new kn(o,a,x,S,w)}}if(_.length===1)i.errors.push(...y.errors);else{const p=(_.length?_:h.map(([S])=>S)).map(D_).join(" | "),x=[];for(let S=1;S<e.length;S++){const b=i.parse(e[S],1+x.length);if(!b)return null;x.push(Nr(b.type))}i.error(`Expected arguments of type ${p}, but found (${x.join(", ")}) instead.`)}return null}static register(e,i){kn.definitions=i;for(const o in i)e[o]=kn}}function D_(n){return Array.isArray(n)?`(${n.map(Nr).join(", ")})`:`(${Nr(n.type)}...)`}class oa{constructor(e,i,o){this.type=oo,this.locale=o,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const o=e[1];if(typeof o!="object"||Array.isArray(o))return i.error("Collator options argument must be an object.");const l=o["case-sensitive"]===void 0?i.parse(!1,1,Fi):i.parseObjectValue(o["case-sensitive"],1,"case-sensitive",Fi);if(!l)return null;const a=o["diacritic-sensitive"]===void 0?i.parse(!1,1,Fi):i.parseObjectValue(o["diacritic-sensitive"],1,"diacritic-sensitive",Fi);if(!a)return null;let h=null;return o.locale&&(h=i.parseObjectValue(o.locale,1,"locale",Ki),!h)?null:new oa(l,a,h)}evaluate(e){return new Yc(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function tp(n,e,i=0,o=n.length-1,l=z_){for(;o>i;){if(o-i>600){const y=o-i+1,w=e-i+1,p=Math.log(y),x=.5*Math.exp(2*p/3),S=.5*Math.sqrt(p*x*(y-x)/y)*(w-y/2<0?-1:1);tp(n,e,Math.max(i,Math.floor(e-w*x/y+S)),Math.min(o,Math.floor(e+(y-w)*x/y+S)),l)}const a=n[e];let h=i,_=o;for(Hl(n,i,e),l(n[o],a)>0&&Hl(n,i,o);h<_;){for(Hl(n,h,_),h++,_--;l(n[h],a)<0;)h++;for(;l(n[_],a)>0;)_--}l(n[i],a)===0?Hl(n,i,_):(_++,Hl(n,_,o)),_<=e&&(i=_+1),e<=_&&(o=_-1)}}function Hl(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}function z_(n,e){return n<e?-1:n>e?1:0}function L_(n){let e=0;for(let i,o,l=0,a=n.length,h=a-1;l<a;h=l++)i=n[l],o=n[h],e+=(o.x-i.x)*(i.y+o.y);return e}function Zl(n,e){n[0]=Math.min(n[0],e[0]),n[1]=Math.min(n[1],e[1]),n[2]=Math.max(n[2],e[0]),n[3]=Math.max(n[3],e[1])}function Wl(n,e){return!(n[0]<=e[0]||n[2]>=e[2]||n[1]<=e[1]||n[3]>=e[3])}function O_(n,e,i){const o=n[0]-e[0],l=n[1]-e[1],a=n[0]-i[0],h=n[1]-i[1];return o*h-a*l==0&&o*a<=0&&l*h<=0}function aa(n,e,i=!1){let o=!1;for(let _=0,y=e.length;_<y;_++){const w=e[_];for(let p=0,x=w.length,S=x-1;p<x;S=p++){const b=w[S],T=w[p];if(O_(n,b,T))return i;(a=b)[1]>(l=n)[1]!=(h=T)[1]>l[1]&&l[0]<(h[0]-a[0])*(l[1]-a[1])/(h[1]-a[1])+a[0]&&(o=!o)}}var l,a,h;return o}function la(n,e,i,o){const l=o[0]-i[0],a=o[1]-i[1],h=(n[0]-i[0])*a-l*(n[1]-i[1]),_=(e[0]-i[0])*a-l*(e[1]-i[1]);return h>0&&_<0||h<0&&_>0}function Qc(n,e,i,o){return(l=[o[0]-i[0],o[1]-i[1]])[0]*(a=[e[0]-n[0],e[1]-n[1]])[1]-l[1]*a[0]!=0&&!(!la(n,e,i,o)||!la(i,o,n,e));var l,a}const Oo=8192;function Rh(n,e){const i=(180+n[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n[1]*Math.PI/360)))/360,l=Math.pow(2,e.z);return[Math.round(i*l*Oo),Math.round(o*l*Oo)]}function k_(n,e){for(let i=0;i<e.length;i++)if(aa(n,e[i]))return!0;return!1}function F_(n,e,i){for(const o of i)for(let l=0,a=o.length,h=a-1;l<a;h=l++)if(Qc(n,e,o[h],o[l]))return!0;return!1}function ip(n,e){for(let i=0;i<n.length;++i)if(!aa(n[i],e))return!1;for(let i=0;i<n.length-1;++i)if(F_(n[i],n[i+1],e))return!1;return!0}function B_(n,e){for(let i=0;i<e.length;i++)if(ip(n,e[i]))return!0;return!1}function ko(n,e,i){const o=[];for(let l=0;l<n.length;l++){const a=[];for(let h=0;h<n[l].length;h++){const _=Rh(n[l][h],i);Zl(e,_),a.push(_)}o.push(a)}return o}function Si(n,e,i){const o=[];for(let l=0;l<n.length;l++){const a=ko(n[l],e,i);o.push(a)}return o}function qt(n,e,i,o){if(n[0]<i[0]||n[0]>i[2]){const l=.5*o;let a=n[0]-i[0]>l?-o:i[0]-n[0]>l?o:0;a===0&&(a=n[0]-i[2]>l?-o:i[2]-n[0]>l?o:0),n[0]+=a}Zl(e,n)}function eu(n,e,i,o){const l=Math.pow(2,o.z)*Oo,a=[o.x*Oo,o.y*Oo],h=[];if(!n)return h;for(const _ of n)for(const y of _){const w=[y.x+a[0],y.y+a[1]];qt(w,e,i,l),h.push(w)}return h}function li(n,e,i,o){const l=Math.pow(2,o.z)*Oo,a=[o.x*Oo,o.y*Oo],h=[];if(!n)return h;for(const y of n){const w=[];for(const p of y){const x=[p.x+a[0],p.y+a[1]];Zl(e,x),w.push(x)}h.push(w)}if(e[2]-e[0]<=l/2){(_=e)[0]=_[1]=1/0,_[2]=_[3]=-1/0;for(const y of h)for(const w of y)qt(w,e,i,l)}var _;return h}class ho{constructor(e,i){this.type=Fi,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(ks(e[1])){const o=e[1];if(o.type==="FeatureCollection")for(let l=0;l<o.features.length;++l){const a=o.features[l].geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new ho(o,o.features[l].geometry)}else if(o.type==="Feature"){const l=o.geometry.type;if(l==="Polygon"||l==="MultiPolygon")return new ho(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new ho(o,o)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(i,o){const l=[1/0,1/0,-1/0,-1/0],a=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(o.type==="Polygon"){const _=ko(o.coordinates,a,h),y=eu(i.geometry(),l,a,h);if(!Wl(l,a))return!1;for(const w of y)if(!aa(w,_))return!1}if(o.type==="MultiPolygon"){const _=Si(o.coordinates,a,h),y=eu(i.geometry(),l,a,h);if(!Wl(l,a))return!1;for(const w of y)if(!k_(w,_))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(i,o){const l=[1/0,1/0,-1/0,-1/0],a=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(o.type==="Polygon"){const _=ko(o.coordinates,a,h),y=li(i.geometry(),l,a,h);if(!Wl(l,a))return!1;for(const w of y)if(!ip(w,_))return!1}if(o.type==="MultiPolygon"){const _=Si(o.coordinates,a,h),y=li(i.geometry(),l,a,h);if(!Wl(l,a))return!1;for(const w of y)if(!B_(w,_))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Ua={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},ni=1/298.257223563,Dh=ni*(2-ni),ca=Math.PI/180;class ja{static fromTile(e,i,o){const l=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),a=Math.atan(.5*(Math.exp(l)-Math.exp(-l)))/ca;return new ja(a,o)}static get units(){return Ua}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!Ua[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(Ua).join(", ")}`);const o=6378.137*ca*(i?Ua[i]:1),l=Math.cos(e*ca),a=1/(1-Dh*(1-l*l)),h=Math.sqrt(a);this.kx=o*h*l,this.ky=o*h*a*(1-Dh)}distance(e,i){const o=kr(e[0]-i[0])*this.kx,l=(e[1]-i[1])*this.ky;return Math.sqrt(o*o+l*l)}bearing(e,i){const o=kr(i[0]-e[0])*this.kx;return Math.atan2(o,(i[1]-e[1])*this.ky)/ca}destination(e,i,o){const l=o*ca;return this.offset(e,Math.sin(l)*i,Math.cos(l)*i)}offset(e,i,o){return[e[0]+i/this.kx,e[1]+o/this.ky]}lineDistance(e){let i=0;for(let o=0;o<e.length-1;o++)i+=this.distance(e[o],e[o+1]);return i}area(e){let i=0;for(let o=0;o<e.length;o++){const l=e[o];for(let a=0,h=l.length,_=h-1;a<h;_=a++)i+=kr(l[a][0]-l[_][0])*(l[a][1]+l[_][1])*(o?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let o=0;if(i<=0)return e[0];for(let l=0;l<e.length-1;l++){const a=e[l],h=e[l+1],_=this.distance(a,h);if(o+=_,o>i)return Ga(a,h,(i-(o-_))/_)}return e[e.length-1]}pointToSegmentDistance(e,i,o){let[l,a]=i,h=kr(o[0]-l)*this.kx,_=(o[1]-a)*this.ky;if(h!==0||_!==0){const y=(kr(e[0]-l)*this.kx*h+(e[1]-a)*this.ky*_)/(h*h+_*_);y>1?(l=o[0],a=o[1]):y>0&&(l+=h/this.kx*y,a+=_/this.ky*y)}return h=kr(e[0]-l)*this.kx,_=(e[1]-a)*this.ky,Math.sqrt(h*h+_*_)}pointOnLine(e,i){let o=1/0,l=e[0][0],a=e[0][1],h=0,_=0;for(let y=0;y<e.length-1;y++){let w=e[y][0],p=e[y][1],x=kr(e[y+1][0]-w)*this.kx,S=(e[y+1][1]-p)*this.ky,b=0;x===0&&S===0||(b=(kr(i[0]-w)*this.kx*x+(i[1]-p)*this.ky*S)/(x*x+S*S),b>1?(w=e[y+1][0],p=e[y+1][1]):b>0&&(w+=x/this.kx*b,p+=S/this.ky*b)),x=kr(i[0]-w)*this.kx,S=(i[1]-p)*this.ky;const T=x*x+S*S;T<o&&(o=T,l=w,a=p,h=y,_=b)}return{point:[l,a],index:h,t:Math.max(0,Math.min(1,_))}}lineSlice(e,i,o){let l=this.pointOnLine(o,e),a=this.pointOnLine(o,i);if(l.index>a.index||l.index===a.index&&l.t>a.t){const w=l;l=a,a=w}const h=[l.point],_=l.index+1,y=a.index;!zh(o[_],h[0])&&_<=y&&h.push(o[_]);for(let w=_+1;w<=y;w++)h.push(o[w]);return zh(o[y],a.point)||h.push(a.point),h}lineSliceAlong(e,i,o){let l=0;const a=[];for(let h=0;h<o.length-1;h++){const _=o[h],y=o[h+1],w=this.distance(_,y);if(l+=w,l>e&&a.length===0&&a.push(Ga(_,y,(e-(l-w))/w)),l>=i)return a.push(Ga(_,y,(i-(l-w))/w)),a;l>e&&a.push(y)}return a}bufferPoint(e,i){const o=i/this.ky,l=i/this.kx;return[e[0]-l,e[1]-o,e[0]+l,e[1]+o]}bufferBBox(e,i){const o=i/this.ky,l=i/this.kx;return[e[0]-l,e[1]-o,e[2]+l,e[3]+o]}insideBBox(e,i){return kr(e[0]-i[0])>=0&&kr(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function zh(n,e){return n[0]===e[0]&&n[1]===e[1]}function Ga(n,e,i){const o=kr(e[0]-n[0]);return[n[0]+o*i,n[1]+(e[1]-n[1])*i]}function kr(n){for(;n<-180;)n+=360;for(;n>180;)n-=360;return n}class Xl{constructor(e=[],i=(o,l)=>o<l?-1:o>l?1:0){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:o}=this,l=i[e];for(;e>0;){const a=e-1>>1,h=i[a];if(o(l,h)>=0)break;i[e]=h,e=a}i[e]=l}_down(e){const{data:i,compare:o}=this,l=this.length>>1,a=i[e];for(;e<l;){let h=1+(e<<1);const _=h+1;if(_<this.length&&o(i[_],i[h])<0&&(h=_),o(i[h],a)>=0)break;i[e]=i[h],e=h}i[e]=a}}var ht=8192;function tu(n,e){return e.dist-n.dist}const fo=100,xn=50;function rp(n){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==n.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==n[i])return!1;return!0}function iu(n){return n[1]-n[0]+1}function po(n,e){const i=n[1]>=n[0]&&n[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function qa(n,e){if(n[0]>n[1])return[null,null];const i=iu(n);if(e){if(i===2)return[n,null];const o=Math.floor(i/2);return[[n[0],n[0]+o],[n[0]+o,n[1]]]}{if(i===1)return[n,null];const o=Math.floor(i/2)-1;return[[n[0],n[0]+o],[n[0]+o+1,n[1]]]}}function Fo(n,e){const i=[1/0,1/0,-1/0,-1/0];if(!po(e,n.length))return i;for(let o=e[0];o<=e[1];++o)Zl(i,n[o]);return i}function $a(n){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<n.length;++i)for(let o=0;o<n[i].length;++o)Zl(e,n[i][o]);return e}function Ha(n,e,i){if(rp(n)||rp(e))return NaN;let o=0,l=0;return n[2]<e[0]&&(o=e[0]-n[2]),n[0]>e[2]&&(o=n[0]-e[2]),n[1]>e[3]&&(l=n[1]-e[3]),n[3]<e[1]&&(l=e[1]-n[3]),i.distance([0,0],[o,l])}function N_(n){return 360*n-180}function V_(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function Lh(n,e){const i=Math.pow(2,e.z),o=(n.y/ht+e.y)/i;return[N_((n.x/ht+e.x)/i),V_(o)]}function np(n,e){const i=[];for(let o=0;o<n.length;++o)i.push(Lh(n[o],e));return i}function sp(n,e,i){const o=i.pointOnLine(e,n).point;return i.distance(n,o)}function op(n,e,i,o,l){const a=i.slice(o[0],o[1]+1);let h=1/0;for(let _=e[0];_<=e[1];++_)if((h=Math.min(h,sp(n[_],a,l)))===0)return 0;return h}function ru(n,e,i,o,l){const a=Math.min(l.pointToSegmentDistance(n,i,o),l.pointToSegmentDistance(e,i,o)),h=Math.min(l.pointToSegmentDistance(i,n,e),l.pointToSegmentDistance(o,n,e));return Math.min(a,h)}function U_(n,e,i,o,l){if(!po(e,n.length)||!po(o,i.length))return NaN;let a=1/0;for(let h=e[0];h<e[1];++h)for(let _=o[0];_<o[1];++_){if(Qc(n[h],n[h+1],i[_],i[_+1]))return 0;a=Math.min(a,ru(n[h],n[h+1],i[_],i[_+1],l))}return a}function ua(n,e,i,o,l){if(!po(e,n.length)||!po(o,i.length))return NaN;let a=1/0;for(let h=e[0];h<=e[1];++h)for(let _=o[0];_<=o[1];++_)if((a=Math.min(a,l.distance(n[h],i[_])))===0)return a;return a}function j_(n,e,i){if(aa(n,e,!0))return 0;let o=1/0;for(const l of e){const a=l.length;if(a<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(l[0]!==l[a-1]&&(o=Math.min(o,i.pointToSegmentDistance(n,l[a-1],l[0])))===0||(o=Math.min(o,sp(n,l,i)))===0)return o}return o}function G_(n,e,i,o){if(!po(e,n.length))return NaN;for(let a=e[0];a<=e[1];++a)if(aa(n[a],i,!0))return 0;let l=1/0;for(let a=e[0];a<e[1];++a)for(const h of i)for(let _=0,y=h.length,w=y-1;_<y;w=_++){if(Qc(n[a],n[a+1],h[w],h[_]))return 0;l=Math.min(l,ru(n[a],n[a+1],h[w],h[_],o))}return l}function nu(n,e){for(const i of n)for(let o=0;o<=i.length-1;++o)if(aa(i[o],e,!0))return!0;return!1}function ap(n,e,i,o=1/0){const l=$a(n),a=$a(e);if(o!==1/0&&Ha(l,a,i)>=o)return o;if(Wl(l,a)){if(nu(n,e))return 0}else if(nu(e,n))return 0;let h=o;for(const _ of n)for(let y=0,w=_.length,p=w-1;y<w;p=y++)for(const x of e)for(let S=0,b=x.length,T=b-1;S<b;T=S++){if(Qc(_[p],_[y],x[T],x[S]))return 0;h=Math.min(h,ru(_[p],_[y],x[T],x[S],i))}return h}function Kl(n,e,i,o,l,a,h){if(a===null||h===null)return;const _=Ha(Fo(o,a),Fo(l,h),i);_<e&&n.push({dist:_,range1:a,range2:h})}function Fs(n,e,i,o,l=1/0){let a=Math.min(o.distance(n[0],i[0][0]),l);if(a===0)return a;const h=new Xl([{dist:0,range1:[0,n.length-1],range2:[0,0]}],tu),_=e?xn:fo,y=$a(i);for(;h.length;){const w=h.pop();if(w.dist>=a)continue;const p=w.range1;if(iu(p)<=_){if(!po(p,n.length))return NaN;if(e){const x=G_(n,p,i,o);if((a=Math.min(a,x))===0)return a}else for(let x=p[0];x<=p[1];++x){const S=j_(n[x],i,o);if((a=Math.min(a,S))===0)return a}}else{const x=qa(p,e);if(x[0]!==null){const S=Ha(Fo(n,x[0]),y,o);S<a&&h.push({dist:S,range1:x[0],range2:[0,0]})}if(x[1]!==null){const S=Ha(Fo(n,x[1]),y,o);S<a&&h.push({dist:S,range1:x[1],range2:[0,0]})}}}return a}function Oh(n,e,i,o,l,a=1/0){let h=Math.min(a,l.distance(n[0],i[0]));if(h===0)return h;const _=new Xl([{dist:0,range1:[0,n.length-1],range2:[0,i.length-1]}],tu),y=e?xn:fo,w=o?xn:fo;for(;_.length;){const p=_.pop();if(p.dist>=h)continue;const x=p.range1,S=p.range2;if(iu(x)<=y&&iu(S)<=w){if(!po(x,n.length)||!po(S,i.length))return NaN;if(e&&o?h=Math.min(h,U_(n,x,i,S,l)):e||o?e&&!o?h=Math.min(h,op(i,S,n,x,l)):!e&&o&&(h=Math.min(h,op(n,x,i,S,l))):h=Math.min(h,ua(n,x,i,S,l)),h===0)return h}else{const b=qa(x,e),T=qa(S,o);Kl(_,h,l,n,i,b[0],T[0]),Kl(_,h,l,n,i,b[0],T[1]),Kl(_,h,l,n,i,b[1],T[0]),Kl(_,h,l,n,i,b[1],T[1])}}return h}function su(n,e,i,o,l=1/0){let a=l;const h=Fo(n,[0,n.length-1]);for(const _ of i)if(!(a!==1/0&&Ha(h,Fo(_,[0,_.length-1]),o)>=a)&&(a=Math.min(a,Oh(n,e,_,!0,o,a)),a===0))return a;return a}function Yl(n,e,i,o,l=1/0){let a=l;const h=Fo(n,[0,n.length-1]);for(const _ of i){if(a!==1/0&&Ha(h,$a(_),o)>=a)continue;const y=Fs(n,e,_,o,a);if(isNaN(y))return y;if((a=Math.min(a,y))===0)return a}return a}function ou(n){return n==="Point"||n==="MultiPoint"||n==="LineString"||n==="MultiLineString"||n==="Polygon"||n==="MultiPolygon"}class Bo{constructor(e,i){this.type=Ft,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(ks(e[1])){const o=e[1];if(o.type==="FeatureCollection"){for(let l=0;l<o.features.length;++l)if(ou(o.features[l].geometry.type))return new Bo(o,o.features[l].geometry)}else if(o.type==="Feature"){if(ou(o.geometry.type))return new Bo(o,o.geometry)}else if(ou(o.type))return new Bo(o,o)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),o=e.canonicalID();if(i!=null&&o!=null){if(e.geometryType()==="Point")return function(l,a,h){const _=[];for(const w of l)for(const p of w)_.push(Lh(p,a));const y=new ja(_[0][1],"meters");return h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString"?Oh(_,!1,h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",y):h.type==="MultiLineString"?su(_,!1,h.coordinates,y):h.type==="Polygon"||h.type==="MultiPolygon"?Yl(_,!1,h.type==="Polygon"?[h.coordinates]:h.coordinates,y):null}(i,o,this.geometries);if(e.geometryType()==="LineString")return function(l,a,h){const _=[];for(const w of l){const p=[];for(const x of w)p.push(Lh(x,a));_.push(p)}const y=new ja(_[0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return su(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",_,y);if(h.type==="MultiLineString"){let w=1/0;for(let p=0;p<h.coordinates.length;p++){const x=su(h.coordinates[p],!0,_,y,w);if(isNaN(x))return x;if((w=Math.min(w,x))===0)return w}return w}if(h.type==="Polygon"||h.type==="MultiPolygon"){let w=1/0;for(let p=0;p<_.length;p++){const x=Yl(_[p],!0,h.type==="Polygon"?[h.coordinates]:h.coordinates,y,w);if(isNaN(x))return x;if((w=Math.min(w,x))===0)return w}return w}return null}(i,o,this.geometries);if(e.geometryType()==="Polygon")return function(l,a,h){const _=[];for(const w of function(p,x){const S=p.length;if(S<=1)return[p];const b=[];let T,M;for(let D=0;D<S;D++){const z=L_(p[D]);z!==0&&(p[D].area=Math.abs(z),M===void 0&&(M=z<0),M===z<0?(T&&b.push(T),T=[p[D]]):T.push(p[D]))}return T&&b.push(T),b}(l)){const p=[];for(let x=0;x<w.length;++x)p.push(np(w[x],a));_.push(p)}const y=new ja(_[0][0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return Yl(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",_,y);if(h.type==="MultiLineString"){let w=1/0;for(let p=0;p<h.coordinates.length;p++){const x=Yl(h.coordinates[p],!0,_,y,w);if(isNaN(x))return x;if((w=Math.min(w,x))===0)return w}return w}return h.type==="Polygon"||h.type==="MultiPolygon"?function(w,p,x){let S=1/0;for(const b of w)for(const T of p){const M=ap(b,T,x,S);if(isNaN(M))return M;if((S=Math.min(S,M))===0)return S}return S}(h.type==="Polygon"?[h.coordinates]:h.coordinates,_,y):null}(i,o,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function au(n,e){switch(n){case"string":return cn(e);case"number":return+e;case"boolean":return!!e;case"color":return tr.parse(e);case"formatted":return In.fromString(cn(e));case"resolvedImage":return Cn.build(cn(e))}return e}function kh(n,e,i,o){return o!==void 0&&(n=o*Math.round(n/o)),e!==void 0&&n<e&&(n=e),i!==void 0&&n>i&&(n=i),n}class ha{constructor(e,i,o){this.type=e,this.key=i,this.scope=o}static parse(e,i){let o=i.expectedType;if(o==null&&(o=$i),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const l=i.parse(e[1],1);if(!(l instanceof lo))return i.error("Key name of 'config' expression must be a string literal.");if(e.length>=3){const a=i.parse(e[2],2);return a instanceof lo?new ha(o,cn(l.value),cn(a.value)):i.error("Scope of 'config' expression must be a string literal.")}return new ha(o,cn(l.value))}evaluate(e){const i=[this.key,this.scope,e.scope].filter(Boolean).join(""),o=e.getConfig(i);if(!o)return null;const{type:l,value:a,values:h,minValue:_,maxValue:y,stepValue:w}=o,p=o.default.evaluate(e);let x=p;if(a){const S=e.scope;e.scope=(S||"").split("").slice(1).join(""),x=a.evaluate(e),e.scope=S}return l&&(x=au(l,x)),x===void 0||_===void 0&&y===void 0&&w===void 0||(typeof x=="number"?x=kh(x,_,y,w):Array.isArray(x)&&(x=x.map(S=>typeof S=="number"?kh(S,_,y,w):S))),a!==void 0&&x!==void 0&&h&&!h.includes(x)&&(x=p,l&&(x=au(l,x))),(l&&l!==this.type||x!==void 0&&Yr(x)!==this.type)&&(x=au(this.type.kind,x)),x}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.key),e}}function Za(n){if(n instanceof kn&&(n.name==="get"&&n.args.length===1||n.name==="feature-state"||n.name==="has"&&n.args.length===1||n.name==="properties"||n.name==="geometry-type"||n.name==="id"||/^filter-/.test(n.name))||n instanceof ho||n instanceof Bo)return!1;let e=!0;return n.eachChild(i=>{e&&!Za(i)&&(e=!1)}),e}function Jl(n){if(n instanceof kn&&n.name==="feature-state")return!1;let e=!0;return n.eachChild(i=>{e&&!Jl(i)&&(e=!1)}),e}function Ql(n){if(n instanceof ha)return new Set([n.key]);let e=new Set;return n.eachChild(i=>{e=new Set([...e,...Ql(i)])}),e}function mo(n,e){if(n instanceof kn&&e.indexOf(n.name)>=0)return!1;let i=!0;return n.eachChild(o=>{i&&!mo(o,e)&&(i=!1)}),i}class da{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const o=e[1];return i.scope.has(o)?new da(o,i.scope.get(o)):i.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Wa{constructor(e,i=[],o,l=new Kc,a=[],h,_){this.registry=e,this.path=i,this.key=i.map(y=>typeof y=="string"?`['${y}']`:`[${y}]`).join(""),this.scope=l,this.errors=a,this.expectedType=o,this._scope=h,this.options=_}parse(e,i,o,l,a={}){return i||o?this.concat(i,null,o,l)._parse(e,a):this._parse(e,a)}parseObjectValue(e,i,o,l,a,h={}){return this.concat(i,o,l,a)._parse(e,h)}_parse(e,i){function o(l,a,h){return h==="assert"?new as(a,[l]):h==="coerce"?new uo(a,[l]):l}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const l=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(l){let a=l.parse(e,this);if(!a)return null;if(this.expectedType){const h=this.expectedType,_=a.type;if(h.kind!=="string"&&h.kind!=="number"&&h.kind!=="boolean"&&h.kind!=="object"&&h.kind!=="array"||_.kind!=="value")if(h.kind!=="color"&&h.kind!=="formatted"&&h.kind!=="resolvedImage"||_.kind!=="value"&&_.kind!=="string"){if(this.checkSubtype(h,_))return null}else a=o(a,h,i.typeAnnotation||"coerce");else a=o(a,h,i.typeAnnotation||"assert")}if(!(a instanceof lo)&&a.type.kind!=="resolvedImage"&&lu(a)){const h=new Jc(this._scope,this.options);try{a=new lo(a.type,a.evaluate(h))}catch(_){return this.error(_.message),null}}return a}return uo.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,o,l){let a=typeof e=="number"?this.path.concat(e):this.path;a=typeof i=="string"?a.concat(i):a;const h=l?this.scope.concat(l):this.scope;return new Wa(this.registry,a,o||null,h,this.errors,this._scope,this.options)}error(e,...i){const o=`${this.key}${i.map(l=>`[${l}]`).join("")}`;this.errors.push(new bs(o,e))}checkSubtype(e,i){const o=Ba(e,i);return o&&this.error(o),o}}var Fh=Wa;function lu(n){if(n instanceof da)return lu(n.boundExpression);if(n instanceof kn&&n.name==="error"||n instanceof oa||n instanceof ho||n instanceof Bo||n instanceof ha)return!1;const e=n instanceof uo||n instanceof as;let i=!0;return n.eachChild(o=>{i=e?i&&lu(o):i&&o instanceof lo}),!!i&&Za(n)&&mo(n,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function ec(n,e){const i=n.length-1;let o,l,a=0,h=i,_=0;for(;a<=h;)if(_=Math.floor((a+h)/2),o=n[_],l=n[_+1],o<=e){if(_===i||e<l)return _;a=_+1}else{if(!(o>e))throw new Ur("Input is not a number.");h=_-1}return 0}class Ws{constructor(e,i,o){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[l,a]of o)this.labels.push(l),this.outputs.push(a)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const o=i.parse(e[1],1,Ft);if(!o)return null;const l=[];let a=null;i.expectedType&&i.expectedType.kind!=="value"&&(a=i.expectedType);for(let h=1;h<e.length;h+=2){const _=h===1?-1/0:e[h],y=e[h+1],w=h,p=h+1;if(typeof _!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(l.length&&l[l.length-1][0]>=_)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',w);const x=i.parse(y,p,a);if(!x)return null;a=a||x.type,l.push([_,x])}return new Ws(a,o,l)}evaluate(e){const i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(e);const l=this.input.evaluate(e);if(l<=i[0])return o[0].evaluate(e);const a=i.length;return l>=i[a-1]?o[a-1].evaluate(e):o[ec(i,l)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const Pi=.95047,lp=1.08883,cp=4/29,Xa=6/29,Bh=3*Xa*Xa,q_=Xa*Xa*Xa,wr=Math.PI/180,$_=180/Math.PI;function Nh(n){return n>q_?Math.pow(n,1/3):n/Bh+cp}function Vh(n){return n>Xa?n*n*n:Bh*(n-cp)}function Uh(n){return 255*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055)}function jh(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function up(n){const e=jh(n.r),i=jh(n.g),o=jh(n.b),l=Nh((.4124564*e+.3575761*i+.1804375*o)/Pi),a=Nh((.2126729*e+.7151522*i+.072175*o)/1);return{l:116*a-16,a:500*(l-a),b:200*(a-Nh((.0193339*e+.119192*i+.9503041*o)/lp)),alpha:n.a}}function hp(n){let e=(n.l+16)/116,i=isNaN(n.a)?e:e+n.a/500,o=isNaN(n.b)?e:e-n.b/200;return e=1*Vh(e),i=Pi*Vh(i),o=lp*Vh(o),new tr(Uh(3.2404542*i-1.5371385*e-.4985314*o),Uh(-.969266*i+1.8760108*e+.041556*o),Uh(.0556434*i-.2040259*e+1.0572252*o),n.alpha)}function H_(n,e,i){const o=e-n;return n+i*(o>180||o<-180?o-360*Math.round(o/360):o)}const tc={forward:up,reverse:hp,interpolate:function(n,e,i){return{l:Xt(n.l,e.l,i),a:Xt(n.a,e.a,i),b:Xt(n.b,e.b,i),alpha:Xt(n.alpha,e.alpha,i)}}},ic={forward:function(n){const{l:e,a:i,b:o}=up(n),l=Math.atan2(o,i)*$_;return{h:l<0?l+360:l,c:Math.sqrt(i*i+o*o),l:e,alpha:n.a}},reverse:function(n){const e=n.h*wr,i=n.c;return hp({l:n.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:n.alpha})},interpolate:function(n,e,i){return{h:H_(n.h,e.h,i),c:Xt(n.c,e.c,i),l:Xt(n.l,e.l,i),alpha:Xt(n.alpha,e.alpha,i)}}};var dp=Object.freeze({__proto__:null,hcl:ic,lab:tc});class ls{constructor(e,i,o,l,a){this.type=e,this.operator=i,this.interpolation=o,this.input=l,this.labels=[],this.outputs=[];for(const[h,_]of a)this.labels.push(h),this.outputs.push(_)}static interpolationFactor(e,i,o,l){let a=0;if(e.name==="exponential")a=Gh(i,e.base,o,l);else if(e.name==="linear")a=Gh(i,1,o,l);else if(e.name==="cubic-bezier"){const h=e.controlPoints;a=new ze(h[0],h[1],h[2],h[3]).solve(Gh(i,1,o,l))}return a}static parse(e,i){let[o,l,a,...h]=e;if(!Array.isArray(l)||l.length===0)return i.error("Expected an interpolation type expression.",1);if(l[0]==="linear")l={name:"linear"};else if(l[0]==="exponential"){const w=l[1];if(typeof w!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);l={name:"exponential",base:w}}else{if(l[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(l[0])}`,1,0);{const w=l.slice(1);if(w.length!==4||w.some(p=>typeof p!="number"||p<0||p>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);l={name:"cubic-bezier",controlPoints:w}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(a=i.parse(a,2,Ft),!a)return null;const _=[];let y=null;o==="interpolate-hcl"||o==="interpolate-lab"?y=An:i.expectedType&&i.expectedType.kind!=="value"&&(y=i.expectedType);for(let w=0;w<h.length;w+=2){const p=h[w],x=h[w+1],S=w+3,b=w+4;if(typeof p!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',S);if(_.length&&_[_.length-1][0]>=p)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',S);const T=i.parse(x,b,y);if(!T)return null;y=y||T.type,_.push([p,T])}return y.kind==="number"||y.kind==="color"||y.kind==="array"&&y.itemType.kind==="number"&&typeof y.N=="number"?new ls(y,o,l,a,_):i.error(`Type ${Nr(y)} is not interpolatable.`)}evaluate(e){const i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(e);const l=this.input.evaluate(e);if(l<=i[0])return o[0].evaluate(e);const a=i.length;if(l>=i[a-1])return o[a-1].evaluate(e);const h=ec(i,l),_=ls.interpolationFactor(this.interpolation,l,i[h],i[h+1]),y=o[h].evaluate(e),w=o[h+1].evaluate(e);return this.operator==="interpolate"?jl[this.type.kind.toLowerCase()](y,w,_):this.operator==="interpolate-hcl"?ic.reverse(ic.interpolate(ic.forward(y),ic.forward(w),_)):tc.reverse(tc.interpolate(tc.forward(y),tc.forward(w),_))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const i=[this.operator,e,this.input.serialize()];for(let o=0;o<this.labels.length;o++)i.push(this.labels[o],this.outputs[o].serialize());return i}}function Gh(n,e,i,o){const l=o-i,a=n-i;return l===0?0:e===1?a/l:(Math.pow(e,a)-1)/(Math.pow(e,l)-1)}class cu{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let o=null;const l=i.expectedType;l&&l.kind!=="value"&&(o=l);const a=[];for(const _ of e.slice(1)){const y=i.parse(_,1+a.length,o,void 0,{typeAnnotation:"omit"});if(!y)return null;o=o||y.type,a.push(y)}const h=l&&a.some(_=>Ba(l,_.type));return new cu(h?$i:o,a)}evaluate(e){let i,o=null,l=0;for(const a of this.args){if(l++,o=a.evaluate(e),o&&o instanceof Cn&&!o.available&&(i||(i=o),o=null,l===this.args.length))return i;if(o!==null)break}return o}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class uu{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const o=[];for(let a=1;a<e.length-1;a+=2){const h=e[a];if(typeof h!="string")return i.error(`Expected string, but found ${typeof h} instead.`,a);if(/[^a-zA-Z0-9_]/.test(h))return i.error("Variable names must contain only alphanumeric characters or '_'.",a);const _=i.parse(e[a+1],a+1);if(!_)return null;o.push([h,_])}const l=i.parse(e[e.length-1],e.length-1,i.expectedType,o);return l?new uu(o,l):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,o]of this.bindings)e.push(i,o.serialize());return e.push(this.result.serialize()),e}}class qh{constructor(e,i,o){this.type=e,this.index=i,this.input=o}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Ft),l=i.parse(e[2],2,vn(i.expectedType||$i));return o&&l?new qh(l.type.itemType,o,l):null}evaluate(e){const i=this.index.evaluate(e),o=this.input.evaluate(e);if(i<0)throw new Ur(`Array index out of bounds: ${i} < 0.`);if(i>=o.length)throw new Ur(`Array index out of bounds: ${i} > ${o.length-1}.`);if(i!==Math.floor(i))throw new Ur(`Array index must be an integer, but found ${i} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return o[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class $h{constructor(e,i,o){this.type=e,this.index=i,this.input=o}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Ft),l=i.parse(e[2],2,vn(i.expectedType||$i));return o&&l?new $h(l.type.itemType,o,l):null}evaluate(e){const i=this.index.evaluate(e),o=this.input.evaluate(e);if(i<0)throw new Ur(`Array index out of bounds: ${i} < 0.`);if(i>o.length-1)throw new Ur(`Array index out of bounds: ${i} > ${o.length-1}.`);if(i===Math.floor(i))return o[i];const l=Math.floor(i),a=Math.ceil(i),h=o[l],_=o[a];if(typeof h!="number"||typeof _!="number")throw new Ur(`Cannot interpolate between non-number values at index ${i}.`);const y=i-l;return h*(1-y)+_*y}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Hh{constructor(e,i){this.type=Fi,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,$i),l=i.parse(e[2],2,$i);return o&&l?Ch(o.type,[Fi,Ki,Ft,ka,$i])?new Hh(o,l):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${Nr(o.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(o==null)return!1;if(!Na(i,["boolean","string","number","null"]))throw new Ur(`Expected first argument to be of type boolean, string, number or null, but found ${Nr(Yr(i))} instead.`);if(!Na(o,["string","array"]))throw new Ur(`Expected second argument to be of type array or string, but found ${Nr(Yr(o))} instead.`);return o.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class hu{constructor(e,i,o){this.type=Ft,this.needle=e,this.haystack=i,this.fromIndex=o}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,$i),l=i.parse(e[2],2,$i);if(!o||!l)return null;if(!Ch(o.type,[Fi,Ki,Ft,ka,$i]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${Nr(o.type)} instead`);if(e.length===4){const a=i.parse(e[3],3,Ft);return a?new hu(o,l,a):null}return new hu(o,l)}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!Na(i,["boolean","string","number","null"]))throw new Ur(`Expected first argument to be of type boolean, string, number or null, but found ${Nr(Yr(i))} instead.`);if(!Na(o,["string","array"]))throw new Ur(`Expected second argument to be of type array or string, but found ${Nr(Yr(o))} instead.`);if(this.fromIndex){const l=this.fromIndex.evaluate(e);return o.indexOf(i,l)}return o.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Zh{constructor(e,i,o,l,a,h){this.inputType=e,this.type=i,this.input=o,this.cases=l,this.outputs=a,this.otherwise=h}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let o,l;i.expectedType&&i.expectedType.kind!=="value"&&(l=i.expectedType);const a={},h=[];for(let w=2;w<e.length-1;w+=2){let p=e[w];const x=e[w+1];Array.isArray(p)||(p=[p]);const S=i.concat(w);if(p.length===0)return S.error("Expected at least one branch label.");for(const T of p){if(typeof T!="number"&&typeof T!="string")return S.error("Branch labels must be numbers or strings.");if(typeof T=="number"&&Math.abs(T)>Number.MAX_SAFE_INTEGER)return S.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof T=="number"&&Math.floor(T)!==T)return S.error("Numeric branch labels must be integer values.");if(o){if(S.checkSubtype(o,Yr(T)))return null}else o=Yr(T);if(a[String(T)]!==void 0)return S.error("Branch labels must be unique.");a[String(T)]=h.length}const b=i.parse(x,w,l);if(!b)return null;l=l||b.type,h.push(b)}const _=i.parse(e[1],1,$i);if(!_)return null;const y=i.parse(e[e.length-1],e.length-1,l);return y?_.type.kind!=="value"&&i.concat(1).checkSubtype(o,_.type)?null:new Zh(o,l,_,a,h,y):null}evaluate(e){const i=this.input.evaluate(e);return(Yr(i)===this.inputType&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),o=[],l={};for(const h of i){const _=l[this.cases[h]];_===void 0?(l[this.cases[h]]=o.length,o.push([this.cases[h],[h]])):o[_][1].push(h)}const a=h=>this.inputType.kind==="number"?Number(h):h;for(const[h,_]of o)e.push(_.length===1?a(_[0]):_.map(a)),e.push(this.outputs[h].serialize());return e.push(this.otherwise.serialize()),e}}class Wh{constructor(e,i,o){this.type=e,this.branches=i,this.otherwise=o}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let o;i.expectedType&&i.expectedType.kind!=="value"&&(o=i.expectedType);const l=[];for(let h=1;h<e.length-1;h+=2){const _=i.parse(e[h],h,Fi);if(!_)return null;const y=i.parse(e[h+1],h+1,o);if(!y)return null;l.push([_,y]),o=o||y.type}const a=i.parse(e[e.length-1],e.length-1,o);return a?new Wh(o,l,a):null}evaluate(e){for(const[i,o]of this.branches)if(i.evaluate(e))return o.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,o]of this.branches)e(i),e(o);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class du{constructor(e,i,o,l){this.type=e,this.input=i,this.beginIndex=o,this.endIndex=l}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,$i),l=i.parse(e[2],2,Ft);if(!o||!l)return null;if(!Ch(o.type,[vn($i),Ki,$i]))return i.error(`Expected first argument to be of type array or string, but found ${Nr(o.type)} instead`);if(e.length===4){const a=i.parse(e[3],3,Ft);return a?new du(o.type,o,l,a):null}return new du(o.type,o,l)}evaluate(e){const i=this.input.evaluate(e),o=this.beginIndex.evaluate(e);if(!Na(i,["string","array"]))throw new Ur(`Expected first argument to be of type array or string, but found ${Nr(Yr(i))} instead.`);if(this.endIndex){const l=this.endIndex.evaluate(e);return i.slice(o,l)}return i.slice(o)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function fp(n,e){return n==="=="||n==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function pp(n,e,i,o){return o.compare(e,i)===0}function Ka(n,e,i){const o=n!=="=="&&n!=="!=";return class xT{constructor(a,h,_){this.type=Fi,this.lhs=a,this.rhs=h,this.collator=_,this.hasUntypedArgument=a.type.kind==="value"||h.type.kind==="value"}static parse(a,h){if(a.length!==3&&a.length!==4)return h.error("Expected two or three arguments.");const _=a[0];let y=h.parse(a[1],1,$i);if(!y)return null;if(!fp(_,y.type))return h.concat(1).error(`"${_}" comparisons are not supported for type '${Nr(y.type)}'.`);let w=h.parse(a[2],2,$i);if(!w)return null;if(!fp(_,w.type))return h.concat(2).error(`"${_}" comparisons are not supported for type '${Nr(w.type)}'.`);if(y.type.kind!==w.type.kind&&y.type.kind!=="value"&&w.type.kind!=="value")return h.error(`Cannot compare types '${Nr(y.type)}' and '${Nr(w.type)}'.`);o&&(y.type.kind==="value"&&w.type.kind!=="value"?y=new as(w.type,[y]):y.type.kind!=="value"&&w.type.kind==="value"&&(w=new as(y.type,[w])));let p=null;if(a.length===4){if(y.type.kind!=="string"&&w.type.kind!=="string"&&y.type.kind!=="value"&&w.type.kind!=="value")return h.error("Cannot use collator to compare non-string types.");if(p=h.parse(a[3],3,oo),!p)return null}return new xT(y,w,p)}evaluate(a){const h=this.lhs.evaluate(a),_=this.rhs.evaluate(a);if(o&&this.hasUntypedArgument){const y=Yr(h),w=Yr(_);if(y.kind!==w.kind||y.kind!=="string"&&y.kind!=="number")throw new Ur(`Expected arguments for "${n}" to be (string, string) or (number, number), but found (${y.kind}, ${w.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const y=Yr(h),w=Yr(_);if(y.kind!=="string"||w.kind!=="string")return e(a,h,_)}return this.collator?i(a,h,_,this.collator.evaluate(a)):e(a,h,_)}eachChild(a){a(this.lhs),a(this.rhs),this.collator&&a(this.collator)}outputDefined(){return!0}serialize(){const a=[n];return this.eachChild(h=>{a.push(h.serialize())}),a}}}const Z_=Ka("==",function(n,e,i){return e===i},pp),W_=Ka("!=",function(n,e,i){return e!==i},function(n,e,i,o){return!pp(0,e,i,o)}),X_=Ka("<",function(n,e,i){return e<i},function(n,e,i,o){return o.compare(e,i)<0}),K_=Ka(">",function(n,e,i){return e>i},function(n,e,i,o){return o.compare(e,i)>0}),Y_=Ka("<=",function(n,e,i){return e<=i},function(n,e,i,o){return o.compare(e,i)<=0}),J_=Ka(">=",function(n,e,i){return e>=i},function(n,e,i,o){return o.compare(e,i)>=0});class rc{constructor(e,i,o,l,a,h){this.type=Ki,this.number=e,this.locale=i,this.currency=o,this.unit=l,this.minFractionDigits=a,this.maxFractionDigits=h}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const o=i.parse(e[1],1,Ft);if(!o)return null;const l=e[2];if(typeof l!="object"||Array.isArray(l))return i.error("NumberFormat options argument must be an object.");let a=null;if(l.locale&&(a=i.parseObjectValue(l.locale,2,"locale",Ki),!a))return null;let h=null;if(l.currency&&(h=i.parseObjectValue(l.currency,2,"currency",Ki),!h))return null;let _=null;if(l.unit&&(_=i.parseObjectValue(l.unit,2,"unit",Ki),!_))return null;let y=null;if(l["min-fraction-digits"]&&(y=i.parseObjectValue(l["min-fraction-digits"],2,"min-fraction-digits",Ft),!y))return null;let w=null;return l["max-fraction-digits"]&&(w=i.parseObjectValue(l["max-fraction-digits"],2,"max-fraction-digits",Ft),!w)?null:new rc(o,a,h,_,y,w)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Xh{constructor(e){this.type=Ft,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const o=i.parse(e[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${Nr(o.type)} instead.`):new Xh(o):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new Ur(`Expected value to be of type string or array, but found ${Nr(Yr(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function Kh(n){return function(){n=1831565813+(n|=0)|0;let e=Math.imul(n^n>>>15,1|n);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const Ya={"==":Z_,"!=":W_,">":K_,"<":X_,">=":J_,"<=":Y_,array:as,at:qh,"at-interpolated":$h,boolean:as,case:Wh,coalesce:cu,collator:oa,format:Va,image:Lo,in:Hh,"index-of":hu,interpolate:ls,"interpolate-hcl":ls,"interpolate-lab":ls,length:Xh,let:uu,literal:lo,match:Zh,number:as,"number-format":rc,object:as,slice:du,step:Ws,string:as,"to-boolean":uo,"to-color":uo,"to-number":uo,"to-string":uo,var:da,within:ho,distance:Bo,config:ha};function mp(n,[e,i,o,l]){e=e.evaluate(n),i=i.evaluate(n),o=o.evaluate(n);const a=l?l.evaluate(n):1,h=$l(e,i,o,a);if(h)throw new Ur(h);return new tr(e/255*a,i/255*a,o/255*a,a)}function _p(n,[e,i,o,l]){e=e.evaluate(n),i=i.evaluate(n),o=o.evaluate(n);const a=l?l.evaluate(n):1,h=function(w,p,x,S){return typeof w=="number"&&w>=0&&w<=360?typeof p=="number"&&p>=0&&p<=100&&typeof x=="number"&&x>=0&&x<=100?S===void 0||typeof S=="number"&&S>=0&&S<=1?null:`Invalid hsla value [${[w,p,x,S].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof S=="number"?[w,p,x,S]:[w,p,x]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof S=="number"?[w,p,x,S]:[w,p,x]).join(", ")}]: 'h' must be between 0 and 360.`}(e,i,o,a);if(h)throw new Ur(h);const _=`hsla(${e}, ${i}%, ${o}%, ${a})`,y=tr.parse(_);if(!y)throw new Ur(`Failed to parse HSLA color: ${_}`);return y}function Yh(n,e){return n in e}function fu(n,e){const i=e[n];return i===void 0?null:i}function ws(n){return{type:n}}function Jh(n){return{result:"success",value:n}}function _o(n){return{result:"error",value:n}}function Qh(n,e){return!!n&&!!n.parameters&&n.parameters.indexOf(e)>-1}function Ja(n){return n["property-type"]==="data-driven"}function pu(n){return Qh(n.expression,"measure-light")}function gp(n){return Qh(n.expression,"zoom")}function ed(n){return!!n.expression&&n.expression.interpolated}function mu(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function yp(n){return n}function vp(n,e){const i=e.type==="color",o=n.stops&&typeof n.stops[0][0]=="object",l=o||!(o||n.property!==void 0),a=n.type||(ed(e)?"exponential":"interval");if(i&&((n=qi({},n)).stops&&(n.stops=n.stops.map(w=>[w[0],tr.parse(w[1])])),n.default=tr.parse(n.default?n.default:e.default)),n.colorSpace&&n.colorSpace!=="rgb"&&!dp[n.colorSpace])throw new Error(`Unknown color space: ${n.colorSpace}`);let h,_,y;if(a==="exponential")h=td;else if(a==="interval")h=xp;else if(a==="categorical"){h=Q_,_=Object.create(null);for(const w of n.stops)_[w[0]]=w[1];y=typeof n.stops[0][0]}else{if(a!=="identity")throw new Error(`Unknown function type "${a}"`);h=_u}if(o){const w={},p=[];for(let b=0;b<n.stops.length;b++){const T=n.stops[b],M=T[0].zoom;w[M]===void 0&&(w[M]={zoom:M,type:n.type,property:n.property,default:n.default,stops:[]},p.push(M)),w[M].stops.push([T[0].value,T[1]])}const x=[];for(const b of p)x.push([w[b].zoom,vp(w[b],e)]);const S={name:"linear"};return{kind:"composite",interpolationType:S,interpolationFactor:ls.interpolationFactor.bind(void 0,S),zoomStops:x.map(b=>b[0]),evaluate:({zoom:b},T)=>td({stops:x,base:n.base},e,b).evaluate(b,T)}}if(l){const w=a==="exponential"?{name:"exponential",base:n.base!==void 0?n.base:1}:null;return{kind:"camera",interpolationType:w,interpolationFactor:ls.interpolationFactor.bind(void 0,w),zoomStops:n.stops.map(p=>p[0]),evaluate:({zoom:p})=>h(n,e,p,_,y)}}return{kind:"source",evaluate(w,p){const x=p&&p.properties?p.properties[n.property]:void 0;return x===void 0?nc(n.default,e.default):h(n,e,x,_,y)}}}function nc(n,e,i){return n!==void 0?n:e!==void 0?e:i!==void 0?i:void 0}function Q_(n,e,i,o,l){return nc(typeof i===l?o[i]:void 0,n.default,e.default)}function xp(n,e,i){if(co(i)!=="number")return nc(n.default,e.default);const o=n.stops.length;if(o===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[o-1][0])return n.stops[o-1][1];const l=ec(n.stops.map(a=>a[0]),i);return n.stops[l][1]}function td(n,e,i){const o=n.base!==void 0?n.base:1;if(co(i)!=="number")return nc(n.default,e.default);const l=n.stops.length;if(l===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[l-1][0])return n.stops[l-1][1];const a=ec(n.stops.map(p=>p[0]),i),h=function(p,x,S,b){const T=b-S,M=p-S;return T===0?0:x===1?M/T:(Math.pow(x,M)-1)/(Math.pow(x,T)-1)}(i,o,n.stops[a][0],n.stops[a+1][0]),_=n.stops[a][1],y=n.stops[a+1][1];let w=jl[e.type]||yp;if(n.colorSpace&&n.colorSpace!=="rgb"){const p=dp[n.colorSpace];w=(x,S)=>p.reverse(p.interpolate(p.forward(x),p.forward(S),h))}return typeof _.evaluate=="function"?{evaluate(...p){const x=_.evaluate.apply(void 0,p),S=y.evaluate.apply(void 0,p);if(x!==void 0&&S!==void 0)return w(x,S,h)}}:w(_,y,h)}function _u(n,e,i){return e.type==="color"?i=tr.parse(i):e.type==="formatted"?i=In.fromString(i.toString()):e.type==="resolvedImage"?i=Cn.build(i.toString()):co(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),nc(i,n.default,e.default)}kn.register(Ya,{error:[{kind:"error"},[Ki],(n,[e])=>{throw new Ur(e.evaluate(n))}],typeof:[Ki,[$i],(n,[e])=>Nr(Yr(e.evaluate(n)))],"to-rgba":[vn(Ft,4),[An],(n,[e])=>e.evaluate(n).toRenderColor(null).toArray()],"to-hsla":[vn(Ft,4),[An],(n,[e])=>e.evaluate(n).toRenderColor(null).toHslaArray()],rgb:[An,[Ft,Ft,Ft],mp],rgba:[An,[Ft,Ft,Ft,Ft],mp],hsl:[An,[Ft,Ft,Ft],_p],hsla:[An,[Ft,Ft,Ft,Ft],_p],has:{type:Fi,overloads:[[[Ki],(n,[e])=>Yh(e.evaluate(n),n.properties())],[[Ki,Fa],(n,[e,i])=>Yh(e.evaluate(n),i.evaluate(n))]]},get:{type:$i,overloads:[[[Ki],(n,[e])=>fu(e.evaluate(n),n.properties())],[[Ki,Fa],(n,[e,i])=>fu(e.evaluate(n),i.evaluate(n))]]},"feature-state":[$i,[Ki],(n,[e])=>fu(e.evaluate(n),n.featureState||{})],properties:[Fa,[],n=>n.properties()],"geometry-type":[Ki,[],n=>n.geometryType()],id:[$i,[],n=>n.id()],zoom:[Ft,[],n=>n.globals.zoom],pitch:[Ft,[],n=>n.globals.pitch||0],"distance-from-center":[Ft,[],n=>n.distanceFromCenter()],"measure-light":[Ft,[Ki],(n,[e])=>n.measureLight(e.evaluate(n))],"heatmap-density":[Ft,[],n=>n.globals.heatmapDensity||0],"line-progress":[Ft,[],n=>n.globals.lineProgress||0],"raster-value":[Ft,[],n=>n.globals.rasterValue||0],"raster-particle-speed":[Ft,[],n=>n.globals.rasterParticleSpeed||0],"sky-radial-progress":[Ft,[],n=>n.globals.skyRadialProgress||0],accumulated:[$i,[],n=>n.globals.accumulated===void 0?null:n.globals.accumulated],"+":[Ft,ws(Ft),(n,e)=>{let i=0;for(const o of e)i+=o.evaluate(n);return i}],"*":[Ft,ws(Ft),(n,e)=>{let i=1;for(const o of e)i*=o.evaluate(n);return i}],"-":{type:Ft,overloads:[[[Ft,Ft],(n,[e,i])=>e.evaluate(n)-i.evaluate(n)],[[Ft],(n,[e])=>-e.evaluate(n)]]},"/":[Ft,[Ft,Ft],(n,[e,i])=>e.evaluate(n)/i.evaluate(n)],"%":[Ft,[Ft,Ft],(n,[e,i])=>e.evaluate(n)%i.evaluate(n)],ln2:[Ft,[],()=>Math.LN2],pi:[Ft,[],()=>Math.PI],e:[Ft,[],()=>Math.E],"^":[Ft,[Ft,Ft],(n,[e,i])=>Math.pow(e.evaluate(n),i.evaluate(n))],sqrt:[Ft,[Ft],(n,[e])=>Math.sqrt(e.evaluate(n))],log10:[Ft,[Ft],(n,[e])=>Math.log(e.evaluate(n))/Math.LN10],ln:[Ft,[Ft],(n,[e])=>Math.log(e.evaluate(n))],log2:[Ft,[Ft],(n,[e])=>Math.log(e.evaluate(n))/Math.LN2],sin:[Ft,[Ft],(n,[e])=>Math.sin(e.evaluate(n))],cos:[Ft,[Ft],(n,[e])=>Math.cos(e.evaluate(n))],tan:[Ft,[Ft],(n,[e])=>Math.tan(e.evaluate(n))],asin:[Ft,[Ft],(n,[e])=>Math.asin(e.evaluate(n))],acos:[Ft,[Ft],(n,[e])=>Math.acos(e.evaluate(n))],atan:[Ft,[Ft],(n,[e])=>Math.atan(e.evaluate(n))],min:[Ft,ws(Ft),(n,e)=>Math.min(...e.map(i=>i.evaluate(n)))],max:[Ft,ws(Ft),(n,e)=>Math.max(...e.map(i=>i.evaluate(n)))],abs:[Ft,[Ft],(n,[e])=>Math.abs(e.evaluate(n))],round:[Ft,[Ft],(n,[e])=>{const i=e.evaluate(n);return i<0?-Math.round(-i):Math.round(i)}],floor:[Ft,[Ft],(n,[e])=>Math.floor(e.evaluate(n))],ceil:[Ft,[Ft],(n,[e])=>Math.ceil(e.evaluate(n))],"filter-==":[Fi,[Ki,$i],(n,[e,i])=>n.properties()[e.value]===i.value],"filter-id-==":[Fi,[$i],(n,[e])=>n.id()===e.value],"filter-type-==":[Fi,[Ki],(n,[e])=>n.geometryType()===e.value],"filter-<":[Fi,[Ki,$i],(n,[e,i])=>{const o=n.properties()[e.value],l=i.value;return typeof o==typeof l&&o<l}],"filter-id-<":[Fi,[$i],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i<o}],"filter->":[Fi,[Ki,$i],(n,[e,i])=>{const o=n.properties()[e.value],l=i.value;return typeof o==typeof l&&o>l}],"filter-id->":[Fi,[$i],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i>o}],"filter-<=":[Fi,[Ki,$i],(n,[e,i])=>{const o=n.properties()[e.value],l=i.value;return typeof o==typeof l&&o<=l}],"filter-id-<=":[Fi,[$i],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i<=o}],"filter->=":[Fi,[Ki,$i],(n,[e,i])=>{const o=n.properties()[e.value],l=i.value;return typeof o==typeof l&&o>=l}],"filter-id->=":[Fi,[$i],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i>=o}],"filter-has":[Fi,[$i],(n,[e])=>e.value in n.properties()],"filter-has-id":[Fi,[],n=>n.id()!==null&&n.id()!==void 0],"filter-type-in":[Fi,[vn(Ki)],(n,[e])=>e.value.indexOf(n.geometryType())>=0],"filter-id-in":[Fi,[vn($i)],(n,[e])=>e.value.indexOf(n.id())>=0],"filter-in-small":[Fi,[Ki,vn($i)],(n,[e,i])=>i.value.indexOf(n.properties()[e.value])>=0],"filter-in-large":[Fi,[Ki,vn($i)],(n,[e,i])=>function(o,l,a,h){for(;a<=h;){const _=a+h>>1;if(l[_]===o)return!0;l[_]>o?h=_-1:a=_+1}return!1}(n.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Fi,overloads:[[[Fi,Fi],(n,[e,i])=>e.evaluate(n)&&i.evaluate(n)],[ws(Fi),(n,e)=>{for(const i of e)if(!i.evaluate(n))return!1;return!0}]]},any:{type:Fi,overloads:[[[Fi,Fi],(n,[e,i])=>e.evaluate(n)||i.evaluate(n)],[ws(Fi),(n,e)=>{for(const i of e)if(i.evaluate(n))return!0;return!1}]]},"!":[Fi,[Fi],(n,[e])=>!e.evaluate(n)],"is-supported-script":[Fi,[Ki],(n,[e])=>{const i=n.globals&&n.globals.isSupportedScript;return!i||i(e.evaluate(n))}],upcase:[Ki,[Ki],(n,[e])=>e.evaluate(n).toUpperCase()],downcase:[Ki,[Ki],(n,[e])=>e.evaluate(n).toLowerCase()],concat:[Ki,ws($i),(n,e)=>e.map(i=>cn(i.evaluate(n))).join("")],"resolved-locale":[Ki,[oo],(n,[e])=>e.evaluate(n).resolvedLocale()],random:[Ft,[Ft,Ft,$i],(n,e)=>{const[i,o,l]=e.map(h=>h.evaluate(n));if(i>o||i===o)return i;let a;if(typeof l=="string")a=function(h){let _=0;if(h.length===0)return _;for(let y=0;y<h.length;y++)_=(_<<5)-_+h.charCodeAt(y),_|=0;return _}(l);else{if(typeof l!="number")throw new Ur(`Invalid seed input: ${l}`);a=l}return i+Kh(a)()*(o-i)}]});class id{constructor(e,i,o,l){this.expression=e,this._warningHistory={},this._evaluator=new Jc(o,l),this._defaultValue=i?function(a){return a.type==="color"&&(mu(a.default)||Array.isArray(a.default))?new tr(0,0,0,0):a.type==="color"?tr.parse(a.default)||null:a.default===void 0?null:a.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=Ql(e)}evaluateWithoutErrorHandling(e,i,o,l,a,h,_,y){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=o,this._evaluator.canonical=l||null,this._evaluator.availableImages=a||null,this._evaluator.formattedSection=h,this._evaluator.featureTileCoord=_||null,this._evaluator.featureDistanceData=y||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,o,l,a,h,_,y){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=o||null,this._evaluator.canonical=l||null,this._evaluator.availableImages=a||null,this._evaluator.formattedSection=h||null,this._evaluator.featureTileCoord=_||null,this._evaluator.featureDistanceData=y||null;try{const w=this.expression.evaluate(this._evaluator);if(w==null||typeof w=="number"&&w!=w)return this._defaultValue;if(this._enumValues&&!(w in this._enumValues))throw new Ur(`Expected value to be one of ${Object.keys(this._enumValues).map(p=>JSON.stringify(p)).join(", ")}, but found ${JSON.stringify(w)} instead.`);return w}catch(w){return this._warningHistory[w.message]||(this._warningHistory[w.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${w.message}`)),this._defaultValue}}}function gu(n){return Array.isArray(n)&&n.length>0&&typeof n[0]=="string"&&n[0]in Ya}function Qa(n,e,i,o){const l=new Fh(Ya,[],e?function(h){const _={color:An,string:Ki,number:Ft,enum:Ki,boolean:Fi,formatted:Gl,resolvedImage:ao};return h.type==="array"?vn(_[h.value]||$i,h.length):_[h.type]}(e):void 0,void 0,void 0,i,o),a=l.parse(n,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return a?Jh(new id(a,e,i,o)):_o(l.errors)}class rd{constructor(e,i,o,l){this.kind=e,this._styleExpression=i,this.isLightConstant=o,this.isLineProgressConstant=l,this.isStateDependent=e!=="constant"&&!Jl(i.expression),this.configDependencies=Ql(i.expression)}evaluateWithoutErrorHandling(e,i,o,l,a,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,l,a,h)}evaluate(e,i,o,l,a,h){return this._styleExpression.evaluate(e,i,o,l,a,h)}}class el{constructor(e,i,o,l,a,h){this.kind=e,this.zoomStops=o,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!Jl(i.expression),this.isLightConstant=a,this.isLineProgressConstant=h,this.configDependencies=Ql(i.expression),this.interpolationType=l}evaluateWithoutErrorHandling(e,i,o,l,a,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,l,a,h)}evaluate(e,i,o,l,a,h){return this._styleExpression.evaluate(e,i,o,l,a,h)}interpolationFactor(e,i,o){return this.interpolationType?ls.interpolationFactor(this.interpolationType,e,i,o):0}}function nd(n,e,i,o){if((n=Qa(n,e,i,o)).result==="error")return n;const l=n.value.expression,a=Za(l);if(!a&&!Ja(e))return _o([new bs("","data expressions not supported")]);const h=mo(l,["zoom","pitch","distance-from-center"]);if(!h&&!gp(e))return _o([new bs("","zoom expressions not supported")]);const _=mo(l,["measure-light"]);if(!_&&!pu(e))return _o([new bs("","measure-light expression not supported")]);const y=mo(l,["line-progress"]);if(!y&&!function(x){return Qh(x.expression,"line-progress")}(e))return _o([new bs("","line-progress expression not supported")]);const w=e.expression&&e.expression.relaxZoomRestriction,p=vu(l);return p||h||w?p instanceof bs?_o([p]):p instanceof ls&&!ed(e)?_o([new bs("",'"interpolate" expressions cannot be used with this property')]):Jh(p?new el(a&&y?"camera":"composite",n.value,p.labels,p instanceof ls?p.interpolation:void 0,_,y):new rd(a&&y?"constant":"source",n.value,_,y)):_o([new bs("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class yu{constructor(e,i){this._parameters=e,this._specification=i,qi(this,vp(this._parameters,this._specification))}static deserialize(e){return new yu(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function vu(n){let e=null;if(n instanceof uu)e=vu(n.result);else if(n instanceof cu){for(const i of n.args)if(e=vu(i),e)break}else(n instanceof Ws||n instanceof ls)&&n.input instanceof kn&&n.input.name==="zoom"&&(e=n);return e instanceof bs||n.eachChild(i=>{const o=vu(i);o instanceof bs?e=o:e&&o&&e!==o&&(e=new bs("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var sc,bp,wp=function(){if(bp)return sc;bp=1,sc=e;var n=3;function e(i,o,l){var a=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var h=new Int32Array(this.arrayBuffer);i=h[0],this.d=(o=h[1])+2*(l=h[2]);for(var _=0;_<this.d*this.d;_++){var y=h[n+_],w=h[n+_+1];a.push(y===w?null:h.subarray(y,w))}var p=h[n+a.length+1];this.keys=h.subarray(h[n+a.length],p),this.bboxes=h.subarray(p),this.insert=this._insertReadonly}else{this.d=o+2*l;for(var x=0;x<this.d*this.d;x++)a.push([]);this.keys=[],this.bboxes=[]}this.n=o,this.extent=i,this.padding=l,this.scale=o/i,this.uid=0;var S=l/o*i;this.min=-S,this.max=i+S}return e.prototype.insert=function(i,o,l,a,h){this._forEachCell(o,l,a,h,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(o),this.bboxes.push(l),this.bboxes.push(a),this.bboxes.push(h)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,o,l,a,h,_){this.cells[h].push(_)},e.prototype.query=function(i,o,l,a,h){var _=this.min,y=this.max;if(i<=_&&o<=_&&y<=l&&y<=a&&!h)return Array.prototype.slice.call(this.keys);var w=[];return this._forEachCell(i,o,l,a,this._queryCell,w,{},h),w},e.prototype._queryCell=function(i,o,l,a,h,_,y,w){var p=this.cells[h];if(p!==null)for(var x=this.keys,S=this.bboxes,b=0;b<p.length;b++){var T=p[b];if(y[T]===void 0){var M=4*T;(w?w(S[M+0],S[M+1],S[M+2],S[M+3]):i<=S[M+2]&&o<=S[M+3]&&l>=S[M+0]&&a>=S[M+1])?(y[T]=!0,_.push(x[T])):y[T]=!1}}},e.prototype._forEachCell=function(i,o,l,a,h,_,y,w){for(var p=this._convertToCellCoord(i),x=this._convertToCellCoord(o),S=this._convertToCellCoord(l),b=this._convertToCellCoord(a),T=p;T<=S;T++)for(var M=x;M<=b;M++){var D=this.d*M+T;if((!w||w(this._convertFromCellCoord(T),this._convertFromCellCoord(M),this._convertFromCellCoord(T+1),this._convertFromCellCoord(M+1)))&&h.call(this,i,o,l,a,D,_,y,w))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,o=n+this.cells.length+1+1,l=0,a=0;a<this.cells.length;a++)l+=this.cells[a].length;var h=new Int32Array(o+l+this.keys.length+this.bboxes.length);h[0]=this.extent,h[1]=this.n,h[2]=this.padding;for(var _=o,y=0;y<i.length;y++){var w=i[y];h[n+y]=_,h.set(w,_),_+=w.length}return h[n+i.length]=_,h.set(this.keys,_),h[n+i.length+1]=_+=this.keys.length,h.set(this.bboxes,_),_+=this.bboxes.length,h.buffer},sc}(),tl=Q(wp);const xu={};function It(n,e,i={}){Object.defineProperty(n,"_classRegistryKey",{value:e,writable:!1}),xu[e]={klass:n,omit:i.omit||[]}}It(Object,"Object"),tl.serialize=function(n,e){const i=n.toArrayBuffer();return e&&e.add(i),{buffer:i}},tl.deserialize=function(n){return new tl(n.buffer)},Object.defineProperty(tl,"name",{value:"Grid"}),It(tl,"Grid"),typeof DOMMatrix<"u"&&It(DOMMatrix,"DOMMatrix"),It(tr,"Color"),It(Error,"Error"),It(In,"Formatted"),It(ql,"FormattedSection"),It(hn,"AJAXError"),It(Cn,"ResolvedImage"),It(yu,"StylePropertyFunction"),It(id,"StyleExpression",{omit:["_evaluator"]}),It(Vn,"ImageId"),It(Zs,"ImageVariant"),It(el,"ZoomDependentExpression"),It(rd,"ZoomConstantExpression"),It(kn,"CompoundExpression",{omit:["_evaluate"]});for(const n in Ya)xu[Ya[n]._classRegistryKey]||It(Ya[n],`Expression${n}`);function sd(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function od(n){return self.ImageBitmap&&n instanceof ImageBitmap}function No(n,e){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp)return n;if(sd(n)||od(n))return e&&e.add(n),n;if(ArrayBuffer.isView(n))return e&&e.add(n.buffer),n;if(n instanceof ImageData)return e&&e.add(n.data.buffer),n;if(Array.isArray(n)){const i=[];for(const o of n)i.push(No(o,e));return i}if(n instanceof Map){const i={$name:"Map",entries:[]};for(const[o,l]of n.entries())i.entries.push(No(o),No(l));return i}if(n instanceof Set){const i={$name:"Set"};let o=0;for(const l of n.values())i[++o]=No(l);return i}if(n instanceof DOMMatrix){const i={$name:"DOMMatrix"},o=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const l of o)i[l]=n[l];return i}if(typeof n=="bigint")return{$name:"BigInt",value:n.toString()};if(typeof n=="object"){const i=n.constructor,o=i._classRegistryKey;if(!o)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);const l=i.serialize?i.serialize(n,e):{};if(!i.serialize){for(const a in n)n.hasOwnProperty(a)&&(xu[o].omit.indexOf(a)>=0||(l[a]=No(n[a],e)));n instanceof Error&&(l.message=n.message)}if(l.$name)throw new Error("$name property is reserved for worker serialization logic.");return o!=="Object"&&(l.$name=o),l}throw new Error("can't serialize object of type "+typeof n)}function cs(n){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp||sd(n)||od(n)||ArrayBuffer.isView(n)||n instanceof ImageData)return n;if(Array.isArray(n))return n.map(cs);if(typeof n=="object"){const e=n.$name||"Object";if(e==="Map"){const l=n.entries||[],a=new Map;for(let h=0;h<l.length;h+=2)a.set(cs(l[h]),cs(l[h+1]));return a}if(e==="Set"){const l=new Set;for(const a of Object.keys(n))a!=="$name"&&l.add(cs(n[a]));return l}if(e==="DOMMatrix"){let l;return l=n.is2D?[n.a,n.b,n.c,n.d,n.e,n.f]:[n.m11,n.m12,n.m13,n.m14,n.m21,n.m22,n.m23,n.m24,n.m31,n.m32,n.m33,n.m34,n.m41,n.m42,n.m43,n.m44],new DOMMatrix(l)}if(e==="BigInt")return BigInt(n.value);const{klass:i}=xu[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(n);const o=Object.create(i.prototype);for(const l of Object.keys(n))l!=="$name"&&(o[l]=cs(n[l]));return o}throw new Error("can't deserialize object of type "+typeof n)}const $t={"Latin-1 Supplement":n=>n>=128&&n<=255,Arabic:n=>n>=1536&&n<=1791,"Arabic Supplement":n=>n>=1872&&n<=1919,"Arabic Extended-A":n=>n>=2208&&n<=2303,"Hangul Jamo":n=>n>=4352&&n<=4607,"Unified Canadian Aboriginal Syllabics":n=>n>=5120&&n<=5759,Khmer:n=>n>=6016&&n<=6143,"Unified Canadian Aboriginal Syllabics Extended":n=>n>=6320&&n<=6399,"General Punctuation":n=>n>=8192&&n<=8303,"Letterlike Symbols":n=>n>=8448&&n<=8527,"Number Forms":n=>n>=8528&&n<=8591,"Miscellaneous Technical":n=>n>=8960&&n<=9215,"Control Pictures":n=>n>=9216&&n<=9279,"Optical Character Recognition":n=>n>=9280&&n<=9311,"Enclosed Alphanumerics":n=>n>=9312&&n<=9471,"Geometric Shapes":n=>n>=9632&&n<=9727,"Miscellaneous Symbols":n=>n>=9728&&n<=9983,"Miscellaneous Symbols and Arrows":n=>n>=11008&&n<=11263,"CJK Radicals Supplement":n=>n>=11904&&n<=12031,"Kangxi Radicals":n=>n>=12032&&n<=12255,"Ideographic Description Characters":n=>n>=12272&&n<=12287,"CJK Symbols and Punctuation":n=>n>=12288&&n<=12351,Hiragana:n=>n>=12352&&n<=12447,Katakana:n=>n>=12448&&n<=12543,Bopomofo:n=>n>=12544&&n<=12591,"Hangul Compatibility Jamo":n=>n>=12592&&n<=12687,Kanbun:n=>n>=12688&&n<=12703,"Bopomofo Extended":n=>n>=12704&&n<=12735,"CJK Strokes":n=>n>=12736&&n<=12783,"Katakana Phonetic Extensions":n=>n>=12784&&n<=12799,"Enclosed CJK Letters and Months":n=>n>=12800&&n<=13055,"CJK Compatibility":n=>n>=13056&&n<=13311,"CJK Unified Ideographs Extension A":n=>n>=13312&&n<=19903,"Yijing Hexagram Symbols":n=>n>=19904&&n<=19967,"CJK Unified Ideographs":n=>n>=19968&&n<=40959,"Yi Syllables":n=>n>=40960&&n<=42127,"Yi Radicals":n=>n>=42128&&n<=42191,"Hangul Jamo Extended-A":n=>n>=43360&&n<=43391,"Hangul Syllables":n=>n>=44032&&n<=55215,"Hangul Jamo Extended-B":n=>n>=55216&&n<=55295,"Private Use Area":n=>n>=57344&&n<=63743,"CJK Compatibility Ideographs":n=>n>=63744&&n<=64255,"Arabic Presentation Forms-A":n=>n>=64336&&n<=65023,"Vertical Forms":n=>n>=65040&&n<=65055,"CJK Compatibility Forms":n=>n>=65072&&n<=65103,"Small Form Variants":n=>n>=65104&&n<=65135,"Arabic Presentation Forms-B":n=>n>=65136&&n<=65279,"Halfwidth and Fullwidth Forms":n=>n>=65280&&n<=65519,Osage:n=>n>=66736&&n<=66815,"CJK Unified Ideographs Extension B":n=>n>=131072&&n<=173791};function ad(n){for(const e of n)if(bu(e.charCodeAt(0)))return!0;return!1}function eg(n){for(const e of n)if(!Tp(e.charCodeAt(0)))return!1;return!0}function Tp(n){return!($t.Arabic(n)||$t["Arabic Supplement"](n)||$t["Arabic Extended-A"](n)||$t["Arabic Presentation Forms-A"](n)||$t["Arabic Presentation Forms-B"](n))}function bu(n){return!(n!==746&&n!==747&&(n<4352||!($t["Bopomofo Extended"](n)||$t.Bopomofo(n)||$t["CJK Compatibility Forms"](n)&&!(n>=65097&&n<=65103)||$t["CJK Compatibility Ideographs"](n)||$t["CJK Compatibility"](n)||$t["CJK Radicals Supplement"](n)||$t["CJK Strokes"](n)||!(!$t["CJK Symbols and Punctuation"](n)||n>=12296&&n<=12305||n>=12308&&n<=12319||n===12336)||$t["CJK Unified Ideographs Extension A"](n)||$t["CJK Unified Ideographs"](n)||$t["Enclosed CJK Letters and Months"](n)||$t["Hangul Compatibility Jamo"](n)||$t["Hangul Jamo Extended-A"](n)||$t["Hangul Jamo Extended-B"](n)||$t["Hangul Jamo"](n)||$t["Hangul Syllables"](n)||$t.Hiragana(n)||$t["Ideographic Description Characters"](n)||$t.Kanbun(n)||$t["Kangxi Radicals"](n)||$t["Katakana Phonetic Extensions"](n)||$t.Katakana(n)&&n!==12540||!(!$t["Halfwidth and Fullwidth Forms"](n)||n===65288||n===65289||n===65293||n>=65306&&n<=65310||n===65339||n===65341||n===65343||n>=65371&&n<=65503||n===65507||n>=65512&&n<=65519)||!(!$t["Small Form Variants"](n)||n>=65112&&n<=65118||n>=65123&&n<=65126)||$t["Unified Canadian Aboriginal Syllabics"](n)||$t["Unified Canadian Aboriginal Syllabics Extended"](n)||$t["Vertical Forms"](n)||$t["Yijing Hexagram Symbols"](n)||$t["Yi Syllables"](n)||$t["Yi Radicals"](n))))}function ld(n){return!(bu(n)||function(e){return!!($t["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||$t["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||$t["Letterlike Symbols"](e)||$t["Number Forms"](e)||$t["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||$t["Control Pictures"](e)&&e!==9251||$t["Optical Character Recognition"](e)||$t["Enclosed Alphanumerics"](e)||$t["Geometric Shapes"](e)||$t["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||$t["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||$t["CJK Symbols and Punctuation"](e)||$t.Katakana(e)||$t["Private Use Area"](e)||$t["CJK Compatibility Forms"](e)||$t["Small Form Variants"](e)||$t["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(n))}function Sp(n){return $t.Arabic(n)||$t["Arabic Supplement"](n)||$t["Arabic Extended-A"](n)||$t["Arabic Presentation Forms-A"](n)||$t["Arabic Presentation Forms-B"](n)}function wu(n){return n>=1424&&n<=2303||$t["Arabic Presentation Forms-A"](n)||$t["Arabic Presentation Forms-B"](n)}function cd(n,e){return!(!e&&wu(n)||n>=2304&&n<=3583||n>=3840&&n<=4255||$t.Khmer(n))}function Ep(n){for(const e of n)if(wu(e.charCodeAt(0)))return!0;return!1}const ud="deferred",Xs="loading",hd="loaded";let dd=null,Un="unavailable",Vo=null;const oc=function(n){n&&typeof n=="string"&&n.indexOf("NetworkError")>-1&&(Un="error"),dd&&dd(n)};function Tu(){il.fire(new Hn("pluginStateChange",{pluginStatus:Un,pluginURL:Vo}))}const il=new Ls,Su=function(){return Un},Mp=function(){if(Un!==ud||!Vo)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Un=Xs,Tu(),Vo&&so({url:Vo},n=>{n?oc(n):(Un=hd,Tu())})},Ts={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Un===hd||Ts.applyArabicShaping!=null,isLoading:()=>Un===Xs,setState(n){Un=n.pluginStatus,Vo=n.pluginURL},isParsed:()=>Ts.applyArabicShaping!=null&&Ts.processBidirectionalText!=null&&Ts.processStyledBidirectionalText!=null,getPluginURL:()=>Vo};class ur{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,o){for(const l of i)if(!cd(l.charCodeAt(0),o))return!1;return!0}(e,Ts.isLoaded())}}class rl{constructor(e,i,o,l){this.property=e,this.value=i,this.expression=function(a,h,_,y){if(mu(a))return new yu(a,h);if(gu(a)||Array.isArray(a)&&a.length>0){const w=nd(a,h,_,y);if(w.result==="error")throw new Error(w.value.map(p=>`${p.key}: ${p.message}`).join(", "));return w.value}{let w=a;return typeof a=="string"&&h.type==="color"&&(w=tr.parse(a)),{kind:"constant",configDependencies:new Set,evaluate:()=>w}}}(i===void 0?e.specification.default:i,e.specification,o,l)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,o){return this.property.possiblyEvaluate(this,e,i,o)}}class fd{constructor(e,i,o){this.property=e,this.value=new rl(e,void 0,i,o)}transitioned(e,i){return new Eu(this.property,this.value,i,Gi({},e.transition,this.transition),e.now)}untransitioned(){return new Eu(this.property,this.value,null,{},0)}}class pd{constructor(e,i,o){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=o,this.configDependencies=new Set}getValue(e){return Or(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new fd(this._values[e].property,this._scope,this._options)),this._values[e].value=new rl(this._values[e].property,i===null?void 0:Or(i),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,i){i&&(this._options=i);const o=this._properties.properties;if(e)for(const l in e){const a=e[l];if(l.endsWith("-transition")){const h=l.slice(0,-11);o[h]&&this.setTransition(h,a)}else o.hasOwnProperty(l)&&this.setValue(l,a)}}getTransition(e){return Or(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new fd(this._values[e].property)),this._values[e].transition=Or(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o);const l=this.getTransition(i);l!==void 0&&(e[`${i}-transition`]=l)}return e}transitioned(e,i){const o=new ac(this._properties);for(const l of Object.keys(this._values))o._values[l]=this._values[l].transitioned(e,i._values[l]);return o}untransitioned(){const e=new ac(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class Eu{constructor(e,i,o,l,a){const h=l.delay||0,_=l.duration||0;a=a||0,this.property=e,this.value=i,this.begin=a+h,this.end=this.begin+_,e.specification.transition&&(l.delay||l.duration)&&(this.prior=o)}possiblyEvaluate(e,i,o){const l=e.now||0,a=this.value.possiblyEvaluate(e,i,o),h=this.prior;if(h){if(l>this.end)return this.prior=null,a;if(this.value.isDataDriven())return this.prior=null,a;if(l<this.begin)return h.possiblyEvaluate(e,i,o);{const _=(l-this.begin)/(this.end-this.begin);return this.property.interpolate(h.possiblyEvaluate(e,i,o),a,Nt(_))}}return a}}class ac{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,o){const l=new ol(this._properties);for(const a of Object.keys(this._values))l._values[a]=this._values[a].possiblyEvaluate(e,i,o);return l}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class nl{constructor(e,i,o){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=o,this.configDependencies=new Set}getValue(e){return Or(this._values[e].value)}setValue(e,i){this._values[e]=new rl(this._values[e].property,i===null?void 0:Or(i),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o)}return e}possiblyEvaluate(e,i,o){const l=new ol(this._properties);for(const a of Object.keys(this._values))l._values[a]=this._values[a].possiblyEvaluate(e,i,o);return l}}class sl{constructor(e,i,o){this.property=e,this.value=i,this.parameters=o}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,o,l){return this.property.evaluate(this.value,this.parameters,e,i,o,l)}}class ol{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ct{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,o){const l=jl[this.specification.type];return l?l(e,i,o):e}}class At{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,o,l){return new sl(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(i,null,{},o,l)}:e.expression,i)}interpolate(e,i,o){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new sl(this,{kind:"constant",value:void 0},e.parameters);const l=jl[this.specification.type];return l?new sl(this,{kind:"constant",value:l(e.value.value,i.value.value,o)},e.parameters):e}evaluate(e,i,o,l,a,h){return e.kind==="constant"?e.value:e.evaluate(i,o,l,a,h)}}class al{constructor(e){this.specification=e}possiblyEvaluate(e,i,o,l){return!!e.expression.evaluate(i,null,{},o,l)}interpolate(){return!1}}class Cr{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new ur(0,{});for(const o in e){const l=e[o];l.specification.overridable&&this.overridableProperties.push(o);const a=this.defaultPropertyValues[o]=new rl(l,void 0),h=this.defaultTransitionablePropertyValues[o]=new fd(l);this.defaultTransitioningPropertyValues[o]=h.untransitioned(),this.defaultPossiblyEvaluatedValues[o]=a.possiblyEvaluate(i)}}}It(At,"DataDrivenProperty"),It(ct,"DataConstantProperty"),It(al,"ColorRampProperty");var Fe=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow","experimental":true},"rain":{"type":"rain","experimental":true},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor","experimental":true},"imports":{"type":"array","value":"import"},"iconsets":{"experimental":true,"type":"iconsets"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"metadata":{"experimental":true,"type":"*"},"selectors":{"experimental":true,"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"experimental":true,"type":"string","required":true},"properties":{"experimental":true,"type":"selectorProperty","required":false},"featureNamespace":{"experimental":true,"type":"string","required":false},"_uniqueFeatureID":{"experimental":true,"type":"boolean","private":true,"required":false}},"selectorProperty":{"experimental":true,"*":{"experimental":true,"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-quality":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]},"experimental":true},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"required":true,"type":"enum","values":{"sprite":1}},"url":{"required":true,"type":"string"}},"iconset_source":{"type":{"required":true,"type":"enum","values":{"source":1}},"source":{"required":true,"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant"},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","experimental":true,"private":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"line-cross-slope":{"type":"number","experimental":true,"expression":{},"property-type":"constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","experimental":true,"private":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.4,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","property-type":"data-constant","default":0.71,"minimum":0,"maximum":5,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.57,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","property-type":"data-constant","default":0.7,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}},"buildingFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","experimental":true,"private":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","transition":true,"experimental":true,"private":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"flat","property-type":"data-constant"},"fill-extrusion-base-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"terrain","property-type":"data-constant"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"experimental":true,"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"*"}}}');function Ap(n){return n instanceof Number||n instanceof String||n instanceof Boolean?n.valueOf():n}function Mu(n){if(Array.isArray(n))return n.map(Mu);if(n instanceof Object&&!(n instanceof Number||n instanceof String||n instanceof Boolean)){const e={};for(const i in n)e[i]=Mu(n[i]);return e}return Ap(n)}function md(n){if(n===!0||n===!1)return!0;if(!Array.isArray(n)||n.length===0)return!1;switch(n[0]){case"has":return n.length>=2&&n[1]!=="$id"&&n[1]!=="$type";case"in":return n.length>=3&&(typeof n[1]!="string"||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return n.length!==3||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const e of n.slice(1))if(!md(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function _d(n,e="",i=null,o="fill"){if(n==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};md(n)||(n=Au(n));const l=n;let a=!0;try{a=function(p){if(!ll(p))return p;let x=Mu(p);return Cp(x),x=Ip(x),x}(l)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(l,null,2)}
        `)}let h=null,_=null;if(o!=="background"&&o!=="sky"&&o!=="slot"){_=Fe[`filter_${o}`];const p=Qa(a,_,e,i);if(p.result==="error")throw new Error(p.value.map(x=>`${x.key}: ${x.message}`).join(", "));h=(x,S,b)=>p.value.evaluate(x,S,{},b)}let y=null,w=null;if(a!==l){const p=Qa(l,_,e,i);if(p.result==="error")throw new Error(p.value.map(x=>`${x.key}: ${x.message}`).join(", "));y=(x,S,b,T,M)=>p.value.evaluate(x,S,{},b,void 0,void 0,T,M),w=!Za(p.value.expression)}return{filter:h,dynamicFilter:y||void 0,needGeometry:Pp(a),needFeature:!!w}}function Ip(n){if(!Array.isArray(n))return n;const e=function(i){if(tg.has(i[0])){for(let o=1;o<i.length;o++)if(ll(i[o]))return!0}return i}(n);return e===!0?e:e.map(i=>Ip(i))}function Cp(n){let e=!1;const i=[];if(n[0]==="case"){for(let o=1;o<n.length-1;o+=2)e=e||ll(n[o]),i.push(n[o+1]);i.push(n[n.length-1])}else if(n[0]==="match"){e=e||ll(n[1]);for(let o=2;o<n.length-1;o+=2)i.push(n[o+1]);i.push(n[n.length-1])}else if(n[0]==="step"){e=e||ll(n[1]);for(let o=1;o<n.length-1;o+=2)i.push(n[o+1])}e&&(n.length=0,n.push("any",...i));for(let o=1;o<n.length;o++)Cp(n[o])}function ll(n){if(!Array.isArray(n))return!1;if((e=n[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<n.length;i++)if(ll(n[i]))return!0;return!1}const tg=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function ig(n,e){return n<e?-1:n>e?1:0}function Pp(n){if(!Array.isArray(n))return!1;if(n[0]==="within"||n[0]==="distance")return!0;for(let e=1;e<n.length;e++)if(Pp(n[e]))return!0;return!1}function Au(n){if(!n)return!0;const e=n[0];return n.length<=1?e!=="any":e==="=="?Uo(n[1],n[2],"=="):e==="!="?fa(Uo(n[1],n[2],"==")):e==="<"||e===">"||e==="<="||e===">="?Uo(n[1],n[2],e):e==="any"?(i=n.slice(1),["any"].concat(i.map(Au))):e==="all"?["all"].concat(n.slice(1).map(Au)):e==="none"?["all"].concat(n.slice(1).map(Au).map(fa)):e==="in"?gd(n[1],n.slice(2)):e==="!in"?fa(gd(n[1],n.slice(2))):e==="has"?yd(n[1]):e!=="!has"||fa(yd(n[1]));var i}function Uo(n,e,i){switch(n){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,n,e]}}function gd(n,e){if(e.length===0)return!1;switch(n){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",n,["literal",e.sort(ig)]]:["filter-in-small",n,["literal",e]]}}function yd(n){switch(n){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",n]}}function fa(n){return["!",n]}const Iu="";function cl(n,e){return e?`${n}${Iu}${e}`:n}const go="-transition",Rp=new Set(["fill","line","background","hillshade","raster"]);class un extends Ls{constructor(e,i,o,l,a){if(super(),this.id=e.id,this.fqid=cl(this.id,o),this.type=e.type,this.scope=o,this.lut=l,this.options=a,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const h=Qa(this.filter,Fe[`filter_${e.type}`]);h.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...h.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),i.layout&&(this._unevaluatedLayout=new nl(i.layout,this.scope,a),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint){this._transitionablePaint=new pd(i.paint,this.scope,a);for(const h in e.paint)this.setPaintProperty(h,e.paint[h]);for(const h in e.layout)this.setLayoutProperty(h,e.layout[h]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new ol(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Rp.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const o=this._unevaluatedLayout;o._properties.properties[e]&&(o.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...o.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(go)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){const o=this._transitionablePaint,l=o._properties.properties;if(e.endsWith(go)){const x=e.slice(0,-11);return l[x]&&o.setTransition(x,i||void 0),!1}if(!l[e])return!1;const a=o._values[e],h=a.value.isDataDriven(),_=a.value;o.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...o.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);const y=o._values[e].value,w=y.isDataDriven(),p=e.endsWith("pattern")||e==="line-dasharray";return w||h||p||this._handleOverridablePaintPropertyUpdate(e,_,y)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,o){return null}_handleOverridablePaintPropertyUpdate(e,i,o){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){return Hs({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,i)=>!(e===void 0||i==="layout"&&!Object.keys(e).length||i==="paint"&&!Object.keys(e).length))}is3D(e){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof sl&&Ja(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=_d(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,i,o,l,a,h,_,y,w){}}const rg={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class lc{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class _r{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&(e.isTransferred=!0,i.add(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Hi(n,e=1){let i=0,o=0;return{members:n.map(l=>{const a=rg[l.type].BYTES_PER_ELEMENT,h=i=Dp(i,Math.max(e,a)),_=l.components||1;return o=Math.max(o,a),i+=a*_,{name:l.name,type:l.type,components:_,offset:h}}),size:Dp(i,Math.max(o,e)),alignment:e}}function Dp(n,e){return Math.ceil(n/e)*e}class yo extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const l=2*e;return this.int16[l+0]=i,this.int16[l+1]=o,e}}yo.prototype.bytesPerElement=4,It(yo,"StructArrayLayout2i4");class ul extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const a=3*e;return this.int16[a+0]=i,this.int16[a+1]=o,this.int16[a+2]=l,e}}ul.prototype.bytesPerElement=6,It(ul,"StructArrayLayout3i6");class vo extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o,l)}emplace(e,i,o,l,a){const h=4*e;return this.int16[h+0]=i,this.int16[h+1]=o,this.int16[h+2]=l,this.int16[h+3]=a,e}}vo.prototype.bytesPerElement=8,It(vo,"StructArrayLayout4i8");class pa extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}pa.prototype.bytesPerElement=4,It(pa,"StructArrayLayout1f4");class cc extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const a=4*e,h=2*e;return this.int16[a+0]=i,this.int16[a+1]=o,this.float32[h+1]=l,e}}cc.prototype.bytesPerElement=8,It(cc,"StructArrayLayout2i1f8");class vd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const a=4*e;return this.int16[a+0]=i,this.int16[a+1]=o,this.int16[a+2]=l,e}}vd.prototype.bytesPerElement=8,It(vd,"StructArrayLayout3i8");class Ss extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,l,a)}emplace(e,i,o,l,a,h){const _=5*e;return this.int16[_+0]=i,this.int16[_+1]=o,this.int16[_+2]=l,this.int16[_+3]=a,this.int16[_+4]=h,e}}Ss.prototype.bytesPerElement=10,It(Ss,"StructArrayLayout5i10");class xd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,l,a,h,_)}emplace(e,i,o,l,a,h,_,y){const w=6*e,p=12*e,x=3*e;return this.int16[w+0]=i,this.int16[w+1]=o,this.uint8[p+4]=l,this.uint8[p+5]=a,this.uint8[p+6]=h,this.uint8[p+7]=_,this.float32[x+2]=y,e}}xd.prototype.bytesPerElement=12,It(xd,"StructArrayLayout2i4ub1f12");class Bs extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const a=3*e;return this.float32[a+0]=i,this.float32[a+1]=o,this.float32[a+2]=l,e}}Bs.prototype.bytesPerElement=12,It(Bs,"StructArrayLayout3f12");class jo extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,l,a)}emplace(e,i,o,l,a,h){const _=6*e,y=3*e;return this.uint16[_+0]=i,this.uint16[_+1]=o,this.uint16[_+2]=l,this.uint16[_+3]=a,this.float32[y+2]=h,e}}jo.prototype.bytesPerElement=12,It(jo,"StructArrayLayout4ui1f12");class Cu extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,l){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o,l)}emplace(e,i,o,l,a){const h=4*e;return this.uint16[h+0]=i,this.uint16[h+1]=o,this.uint16[h+2]=l,this.uint16[h+3]=a,e}}Cu.prototype.bytesPerElement=8,It(Cu,"StructArrayLayout4ui8");class Pu extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,l,a,h)}emplace(e,i,o,l,a,h,_){const y=6*e;return this.int16[y+0]=i,this.int16[y+1]=o,this.int16[y+2]=l,this.int16[y+3]=a,this.int16[y+4]=h,this.int16[y+5]=_,e}}Pu.prototype.bytesPerElement=12,It(Pu,"StructArrayLayout6i12");class bd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_,y,w,p,x,S){const b=this.length;return this.resize(b+1),this.emplace(b,e,i,o,l,a,h,_,y,w,p,x,S)}emplace(e,i,o,l,a,h,_,y,w,p,x,S,b){const T=12*e;return this.int16[T+0]=i,this.int16[T+1]=o,this.int16[T+2]=l,this.int16[T+3]=a,this.uint16[T+4]=h,this.uint16[T+5]=_,this.uint16[T+6]=y,this.uint16[T+7]=w,this.int16[T+8]=p,this.int16[T+9]=x,this.int16[T+10]=S,this.int16[T+11]=b,e}}bd.prototype.bytesPerElement=24,It(bd,"StructArrayLayout4i4ui4i24");class wd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,l,a,h)}emplace(e,i,o,l,a,h,_){const y=10*e,w=5*e;return this.int16[y+0]=i,this.int16[y+1]=o,this.int16[y+2]=l,this.float32[w+2]=a,this.float32[w+3]=h,this.float32[w+4]=_,e}}wd.prototype.bytesPerElement=20,It(wd,"StructArrayLayout3i3f20");class ma extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o,l)}emplace(e,i,o,l,a){const h=4*e;return this.float32[h+0]=i,this.float32[h+1]=o,this.float32[h+2]=l,this.float32[h+3]=a,e}}ma.prototype.bytesPerElement=16,It(ma,"StructArrayLayout4f16");class Td extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}Td.prototype.bytesPerElement=4,It(Td,"StructArrayLayout1ul4");class Go extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const l=2*e;return this.uint16[l+0]=i,this.uint16[l+1]=o,e}}Go.prototype.bytesPerElement=4,It(Go,"StructArrayLayout2ui4");class Sd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_,y,w,p,x,S,b){const T=this.length;return this.resize(T+1),this.emplace(T,e,i,o,l,a,h,_,y,w,p,x,S,b)}emplace(e,i,o,l,a,h,_,y,w,p,x,S,b,T){const M=20*e,D=10*e;return this.int16[M+0]=i,this.int16[M+1]=o,this.int16[M+2]=l,this.int16[M+3]=a,this.int16[M+4]=h,this.float32[D+3]=_,this.float32[D+4]=y,this.float32[D+5]=w,this.float32[D+6]=p,this.int16[M+14]=x,this.uint32[D+8]=S,this.uint16[M+18]=b,this.uint16[M+19]=T,e}}Sd.prototype.bytesPerElement=40,It(Sd,"StructArrayLayout5i4f1i1ul2ui40");class uc extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,l,a,h,_)}emplace(e,i,o,l,a,h,_,y){const w=8*e;return this.int16[w+0]=i,this.int16[w+1]=o,this.int16[w+2]=l,this.int16[w+4]=a,this.int16[w+5]=h,this.int16[w+6]=_,this.int16[w+7]=y,e}}uc.prototype.bytesPerElement=16,It(uc,"StructArrayLayout3i2i2i16");class Ed extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,l,a)}emplace(e,i,o,l,a,h){const _=4*e,y=8*e;return this.float32[_+0]=i,this.float32[_+1]=o,this.float32[_+2]=l,this.int16[y+6]=a,this.int16[y+7]=h,e}}Ed.prototype.bytesPerElement=16,It(Ed,"StructArrayLayout2f1f2i16");class Md extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,o,l,a,h)}emplace(e,i,o,l,a,h,_){const y=20*e,w=5*e;return this.uint8[y+0]=i,this.uint8[y+1]=o,this.float32[w+1]=l,this.float32[w+2]=a,this.float32[w+3]=h,this.float32[w+4]=_,e}}Md.prototype.bytesPerElement=20,It(Md,"StructArrayLayout2ub4f20");class dn extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o){const l=this.length;return this.resize(l+1),this.emplace(l,e,i,o)}emplace(e,i,o,l){const a=3*e;return this.uint16[a+0]=i,this.uint16[a+1]=o,this.uint16[a+2]=l,e}}dn.prototype.bytesPerElement=6,It(dn,"StructArrayLayout3ui6");class Ru extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D,z,N,B,F,U){const q=this.length;return this.resize(q+1),this.emplace(q,e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D,z,N,B,F,U)}emplace(e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D,z,N,B,F,U,q){const Z=30*e,re=15*e,ee=60*e;return this.int16[Z+0]=i,this.int16[Z+1]=o,this.int16[Z+2]=l,this.float32[re+2]=a,this.float32[re+3]=h,this.uint16[Z+8]=_,this.uint16[Z+9]=y,this.uint32[re+5]=w,this.uint32[re+6]=p,this.uint32[re+7]=x,this.uint16[Z+16]=S,this.uint16[Z+17]=b,this.uint16[Z+18]=T,this.float32[re+10]=M,this.float32[re+11]=D,this.uint8[ee+48]=z,this.uint8[ee+49]=N,this.uint8[ee+50]=B,this.uint32[re+13]=F,this.int16[Z+28]=U,this.uint8[ee+58]=q,e}}Ru.prototype.bytesPerElement=60,It(Ru,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Du extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D,z,N,B,F,U,q,Z,re,ee,te,pe,ne,me,be,ve,Me,Ee){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D,z,N,B,F,U,q,Z,re,ee,te,pe,ne,me,be,ve,Me,Ee)}emplace(e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D,z,N,B,F,U,q,Z,re,ee,te,pe,ne,me,be,ve,Me,Ee,Oe){const Ce=20*e,ke=40*e,rt=80*e;return this.float32[Ce+0]=i,this.float32[Ce+1]=o,this.int16[ke+4]=l,this.int16[ke+5]=a,this.int16[ke+6]=h,this.int16[ke+7]=_,this.int16[ke+8]=y,this.int16[ke+9]=w,this.int16[ke+10]=p,this.int16[ke+11]=x,this.int16[ke+12]=S,this.uint16[ke+13]=b,this.uint16[ke+14]=T,this.uint16[ke+15]=M,this.uint16[ke+16]=D,this.uint16[ke+17]=z,this.uint16[ke+18]=N,this.uint16[ke+19]=B,this.uint16[ke+20]=F,this.uint16[ke+21]=U,this.uint16[ke+22]=q,this.uint16[ke+23]=Z,this.uint16[ke+24]=re,this.uint16[ke+25]=ee,this.uint16[ke+26]=te,this.uint16[ke+27]=pe,this.uint32[Ce+14]=ne,this.float32[Ce+15]=me,this.float32[Ce+16]=be,this.float32[Ce+17]=ve,this.float32[Ce+18]=Me,this.uint8[rt+76]=Ee,this.uint16[ke+39]=Oe,e}}Du.prototype.bytesPerElement=80,It(Du,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Zn extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,l,a)}emplace(e,i,o,l,a,h){const _=5*e;return this.float32[_+0]=i,this.float32[_+1]=o,this.float32[_+2]=l,this.float32[_+3]=a,this.float32[_+4]=h,e}}Zn.prototype.bytesPerElement=20,It(Zn,"StructArrayLayout5f20");class zu extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,l,a,h,_)}emplace(e,i,o,l,a,h,_,y){const w=7*e;return this.float32[w+0]=i,this.float32[w+1]=o,this.float32[w+2]=l,this.float32[w+3]=a,this.float32[w+4]=h,this.float32[w+5]=_,this.float32[w+6]=y,e}}zu.prototype.bytesPerElement=28,It(zu,"StructArrayLayout7f28");class Ad extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_,y,w,p,x){const S=this.length;return this.resize(S+1),this.emplace(S,e,i,o,l,a,h,_,y,w,p,x)}emplace(e,i,o,l,a,h,_,y,w,p,x,S){const b=11*e;return this.float32[b+0]=i,this.float32[b+1]=o,this.float32[b+2]=l,this.float32[b+3]=a,this.float32[b+4]=h,this.float32[b+5]=_,this.float32[b+6]=y,this.float32[b+7]=w,this.float32[b+8]=p,this.float32[b+9]=x,this.float32[b+10]=S,e}}Ad.prototype.bytesPerElement=44,It(Ad,"StructArrayLayout11f44");class Id extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_,y,w){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,o,l,a,h,_,y,w)}emplace(e,i,o,l,a,h,_,y,w,p){const x=9*e;return this.float32[x+0]=i,this.float32[x+1]=o,this.float32[x+2]=l,this.float32[x+3]=a,this.float32[x+4]=h,this.float32[x+5]=_,this.float32[x+6]=y,this.float32[x+7]=w,this.float32[x+8]=p,e}}Id.prototype.bytesPerElement=36,It(Id,"StructArrayLayout9f36");class hl extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const l=2*e;return this.float32[l+0]=i,this.float32[l+1]=o,e}}hl.prototype.bytesPerElement=8,It(hl,"StructArrayLayout2f8");class hc extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,l){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o,l)}emplace(e,i,o,l,a){const h=6*e;return this.uint32[3*e+0]=i,this.uint16[h+2]=o,this.uint16[h+3]=l,this.uint16[h+4]=a,e}}hc.prototype.bytesPerElement=12,It(hc,"StructArrayLayout1ul3ui12");class Lu extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}Lu.prototype.bytesPerElement=2,It(Lu,"StructArrayLayout1ui2");class Ou extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D){const z=this.length;return this.resize(z+1),this.emplace(z,e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D)}emplace(e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D,z){const N=16*e;return this.float32[N+0]=i,this.float32[N+1]=o,this.float32[N+2]=l,this.float32[N+3]=a,this.float32[N+4]=h,this.float32[N+5]=_,this.float32[N+6]=y,this.float32[N+7]=w,this.float32[N+8]=p,this.float32[N+9]=x,this.float32[N+10]=S,this.float32[N+11]=b,this.float32[N+12]=T,this.float32[N+13]=M,this.float32[N+14]=D,this.float32[N+15]=z,e}}Ou.prototype.bytesPerElement=64,It(Ou,"StructArrayLayout16f64");class ku extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,l,a,h,_){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,l,a,h,_)}emplace(e,i,o,l,a,h,_,y){const w=10*e,p=5*e;return this.uint16[w+0]=i,this.uint16[w+1]=o,this.uint16[w+2]=l,this.uint16[w+3]=a,this.float32[p+2]=h,this.float32[p+3]=_,this.float32[p+4]=y,e}}ku.prototype.bytesPerElement=20,It(ku,"StructArrayLayout4ui3f20");class Fu extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}Fu.prototype.bytesPerElement=2,It(Fu,"StructArrayLayout1i2");class Cd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}Cd.prototype.bytesPerElement=1,It(Cd,"StructArrayLayout1ub1");class Pd extends lc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Pd.prototype.size=40;class dc extends Sd{get(e){return new Pd(this,e)}}It(dc,"CollisionBoxArray");class zp extends lc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}zp.prototype.size=60;class Lp extends Ru{get(e){return new zp(this,e)}}It(Lp,"PlacedSymbolArray");class Op extends lc{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}Op.prototype.size=80;class kp extends Du{get(e){return new Op(this,e)}}It(kp,"SymbolInstanceArray");class Fp extends pa{getoffsetX(e){return this.float32[1*e+0]}}It(Fp,"GlyphOffsetArray");class fc extends yo{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}It(fc,"SymbolLineVertexArray");class pc extends lc{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}pc.prototype.size=12;class Wn extends hc{get(e){return new pc(this,e)}}It(Wn,"FeatureIndexArray");class mc extends Go{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}It(mc,"FillExtrusionCentroidArray");class Bp extends lc{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Bp.prototype.size=6;class Np extends ul{get(e){return new Bp(this,e)}}It(Np,"FillExtrusionWallArray");const ng=Hi([{name:"a_pos",components:2,type:"Int16"}],4),sg=Hi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Tr{constructor(e=[]){this.segments=e}_prepareSegment(e,i,o,l){let a=this.segments[this.segments.length-1];return e>Tr.MAX_VERTEX_ARRAY_LENGTH&&br(`Max vertices per segment is ${Tr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!a||a.vertexLength+e>Tr.MAX_VERTEX_ARRAY_LENGTH||a.sortKey!==l)&&(a={vertexOffset:i,primitiveOffset:o,vertexLength:0,primitiveLength:0},l!==void 0&&(a.sortKey=l),this.segments.push(a)),a}prepareSegment(e,i,o,l){return this._prepareSegment(e,i.length,o.length,l)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,o,l){return new Tr([{vertexOffset:e,primitiveOffset:i,vertexLength:o,primitiveLength:l,vaos:{},sortKey:0}])}}function Vp(n,e){return 256*(n=Dt(Math.floor(n),0,255))+Dt(Math.floor(e),0,255)}Tr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,It(Tr,"SegmentVector");const Rd=Hi([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),og=Hi([{name:"a_dash",components:4,type:"Uint16"}]);class _c{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,o,l){this.ids.push(Dd(e)),this.positions.push(i,o,l)}eachPosition(e,i){const o=Dd(e);let l=0,a=this.ids.length-1;for(;l<a;){const h=l+a>>1;this.ids[h]>=o?a=h:l=h+1}for(;this.ids[l]===o;)i(this.positions[3*l],this.positions[3*l+1],this.positions[3*l+2]),l++}static serialize(e,i){const o=new Float64Array(e.ids),l=new Uint32Array(e.positions);return gc(o,l,0,o.length-1),i&&(i.add(o.buffer),i.add(l.buffer)),{ids:o,positions:l}}static deserialize(e){const i=new _c;let o;i.ids=e.ids,i.positions=e.positions;for(const l of i.ids)l!==o&&i.uniqueIds.push(l),o=l;return i.indexed=!0,i}}function Dd(n){const e=+n;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:os(String(n))}function gc(n,e,i,o){for(;i<o;){const l=n[i+o>>1];let a=i-1,h=o+1;for(;;){do a++;while(n[a]<l);do h--;while(n[h]>l);if(a>=h)break;Bu(n,a,h),Bu(e,3*a,3*h),Bu(e,3*a+1,3*h+1),Bu(e,3*a+2,3*h+2)}h-i<o-h?(gc(n,e,i,h),i=h+1):(gc(n,e,h+1,o),o=h)}}function Bu(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}It(_c,"FeaturePositionMap");class Ks{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,o){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class yc extends Ks{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1i(this.location,o))}}class jr extends Ks{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1f(this.location,o))}}class Es extends Ks{constructor(e){super(e),this.current=[0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]||(this.current=o,this.gl.uniform2f(this.location,o[0],o[1])))}}class dl extends Ks{constructor(e){super(e),this.current=[0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]||(this.current=o,this.gl.uniform3f(this.location,o[0],o[1],o[2])))}}class vc extends Ks{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]&&o[3]===this.current[3]||(this.current=o,this.gl.uniform4f(this.location,o[0],o[1],o[2],o[3])))}}class Up extends Ks{constructor(e){super(e),this.current=tr.transparent.toRenderColor(null)}set(e,i,o){this.fetchUniformLocation(e,i)&&(o.r===this.current.r&&o.g===this.current.g&&o.b===this.current.b&&o.a===this.current.a||(this.current=o,this.gl.uniform4f(this.location,o.r,o.g,o.b,o.a)))}}const jp=new Float32Array(16);class xc extends Ks{constructor(e){super(e),this.current=jp}set(e,i,o){if(this.fetchUniformLocation(e,i)){if(o[12]!==this.current[12]||o[0]!==this.current[0])return this.current=o,void this.gl.uniformMatrix4fv(this.location,!1,o);for(let l=1;l<16;l++)if(o[l]!==this.current[l]){this.current=o,this.gl.uniformMatrix4fv(this.location,!1,o);break}}}}const zd=new Float32Array(9),ag=new Float32Array(4);class Ld extends Ks{constructor(e){super(e),this.current=ag}set(e,i,o){if(this.fetchUniformLocation(e,i)){for(let l=0;l<4;l++)if(o[l]!==this.current[l]){this.current=o,this.gl.uniformMatrix2fv(this.location,!1,o);break}}}}function Od(n){return[Vp(255*n.r,255*n.g),Vp(255*n.b,255*n.a)]}class bc{constructor(e,i,o,l){this.value=e,this.uniformNames=i.map(a=>`u_${a}`),this.type=o,this.context=l}setUniform(e,i,o,l,a){const h=l.constantOr(this.value);i.set(e,a,h instanceof tr?h.toRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):h)}getBinding(e,i){return this.type==="color"?new Up(e):new jr(e)}}class _a{constructor(e,i){this.uniformNames=i.map(o=>`u_${o}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(e){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br)}setUniform(e,i,o,l,a){const h=a==="u_pattern"||a==="u_dash"?this.pattern:a==="u_pixel_ratio"?this.pixelRatio:null;h&&i.set(e,a,h)}getBinding(e,i){return i==="u_pattern"||i==="u_dash"?new vc(e):new jr(e)}}class xo{constructor(e,i,o,l){this.expression=e,this.type=o,this.maxValue=0,this.paintVertexAttributes=i.map(a=>({name:`a_${a}`,type:"Float32",components:o==="color"?2:1,offset:0})),this.paintVertexArray=new l}populatePaintArray(e,i,o,l,a,h,_){const y=this.paintVertexArray.length,w=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new ur(0,{brightness:h}),i,{},a,l,_):this.expression.kind==="constant"&&this.expression.value,p=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ur(0,{brightness:h}),i,{},a,l,_):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(y,e,w,p?null:this.context.lut)}updatePaintArray(e,i,o,l,a,h,_){const y=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:_},o,l,void 0,a):this.expression.kind==="constant"&&this.expression.value,w=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ur(0,{brightness:_}),o,l,void 0,a):this.lutExpression.value)==="none";this._setPaintValue(e,i,y,w?null:this.context.lut)}_setPaintValue(e,i,o,l){if(this.type==="color"){const a=Od(o.toRenderColor(l));for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,a[0],a[1])}else{for(let a=e;a<i;a++)this.paintVertexArray.emplace(a,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ns{constructor(e,i,o,l,a,h){this.expression=e,this.uniformNames=i.map(_=>`u_${_}_t`),this.type=o,this.useIntegerZoom=l,this.context=a,this.maxValue=0,this.paintVertexAttributes=i.map(_=>({name:`a_${_}`,type:"Float32",components:o==="color"?4:2,offset:0})),this.paintVertexArray=new h}populatePaintArray(e,i,o,l,a,h,_){const y=this.expression.evaluate(new ur(this.context.zoom,{brightness:h}),i,{},a,l,_),w=this.expression.evaluate(new ur(this.context.zoom+1,{brightness:h}),i,{},a,l,_),p=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ur(0,{brightness:h}),i,{},a,l,_):this.lutExpression.value)==="none",x=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(x,e,y,w,p?null:this.context.lut)}updatePaintArray(e,i,o,l,a,h,_){const y=this.expression.evaluate({zoom:this.context.zoom,brightness:_},o,l,void 0,a),w=this.expression.evaluate({zoom:this.context.zoom+1,brightness:_},o,l,void 0,a),p=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ur(0,{brightness:_}),o,l,void 0,a):this.lutExpression.value)==="none";this._setPaintValue(e,i,y,w,p?null:this.context.lut)}_setPaintValue(e,i,o,l,a){if(this.type==="color"){const h=Od(o.toRenderColor(a)),_=Od(o.toRenderColor(a));for(let y=e;y<i;y++)this.paintVertexArray.emplace(y,h[0],h[1],_[0],_[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,o,l);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(l))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,o,l,a){const h=this.useIntegerZoom?Math.floor(o.zoom):o.zoom,_=Dt(this.expression.interpolationFactor(h,this.context.zoom,this.context.zoom+1),0,1);i.set(e,a,_)}getBinding(e,i){return new jr(e)}}class qo{constructor(e,i,o,l,a){this.expression=e,this.layerId=a,this.paintVertexAttributes=(o==="array"?og:Rd).members;for(let h=0;h<i.length;++h);this.paintVertexArray=new l}populatePaintArray(e,i,o,l){const a=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(a,e,i.patterns&&i.patterns[this.layerId],o)}updatePaintArray(e,i,o,l,a,h,_){this._setPaintValues(e,i,o.patterns&&o.patterns[this.layerId],h)}_setPaintValues(e,i,o,l){if(!l||!o)return;const a=l[o];if(!a)return;const{tl:h,br:_,pixelRatio:y}=a;for(let w=e;w<i;w++)this.paintVertexArray.emplace(w,h[0],h[1],_[0],_[1],y)}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ga{constructor(e,i,o=()=>!0){this.binders={},this._buffers=[],this.context=i;const l=[];for(const a in e.paint._values){const h=e.paint.get(a);if(a.endsWith("-use-theme")||!o(a)||!(h instanceof sl&&Ja(h.property.specification)))continue;const _=cg(a,e.type),y=h.value,w=h.property.specification.type,p=!!h.property.useIntegerZoom,x=a==="line-dasharray"||a.endsWith("pattern"),S=e.paint.get(`${a}-use-theme`),b=a==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||S&&S.value.kind!=="constant";if(y.kind!=="constant"||b)if(y.kind==="source"||b||x){const T=Gp(a,w,"source");this.binders[a]=x?new qo(y,_,w,T,e.id):new xo(y,_,w,T),l.push(`/a_${a}`)}else{const T=Gp(a,w,"composite");this.binders[a]=new Ns(y,_,w,p,i,T),l.push(`/z_${a}`)}else this.binders[a]=x?new _a(y.value,_):new bc(y.value,_,w,i),l.push(`/u_${a}`);S&&(this.binders[a].lutExpression=S.value)}this.cacheKey=l.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof xo||i instanceof Ns?i.maxValue:0}populatePaintArrays(e,i,o,l,a,h,_){for(const y in this.binders){const w=this.binders[y];w.context=this.context,(w instanceof xo||w instanceof Ns||w instanceof qo)&&w.populatePaintArray(e,i,o,l,a,h,_)}}setConstantPatternPositions(e){for(const i in this.binders){const o=this.binders[i];o instanceof _a&&o.setConstantPatternPositions(e)}}updatePaintArrays(e,i,o,l,a,h,_,y,w){let p=!1;const x=Object.keys(e),S=x.length!==0&&!y,b=S?x:i.uniqueIds;this.context.lut=a.lut;for(const T in this.binders){const M=this.binders[T];if(M.context=this.context,(M instanceof xo||M instanceof Ns||M instanceof qo)&&M.expression&&M.expression.kind&&M.expression.kind!=="constant"&&(M.expression.isStateDependent===!0||M.expression.isLightConstant===!1)){const D=a.paint.get(T);M.expression=D.value;for(const z of b){const N=e[z.toString()];i.eachPosition(z,(B,F,U)=>{const q=l.feature(B);M.updatePaintArray(F,U,q,N,h,_,w)})}if(!S)for(const z of o.uniqueIds){const N=e[z.toString()];o.eachPosition(z,(B,F,U)=>{const q=l.feature(B);M.updatePaintArray(F,U,q,N,h,_,w)})}p=!0}}return p}defines(){const e=[];for(const i in this.binders){const o=this.binders[i];(o instanceof bc||o instanceof _a)&&e.push(...o.uniformNames.map(l=>`#define HAS_UNIFORM_${l}`))}return e}getBinderAttributes(){const e=[];for(const i in this.binders){const o=this.binders[i];if(o instanceof xo||o instanceof Ns||o instanceof qo)for(let l=0;l<o.paintVertexAttributes.length;l++)e.push(o.paintVertexAttributes[l].name)}return e}getBinderUniforms(){const e=[];for(const i in this.binders){const o=this.binders[i];if(o instanceof bc||o instanceof _a||o instanceof Ns)for(const l of o.uniformNames)e.push(l)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const o in this.binders){const l=this.binders[o];if(l instanceof bc||l instanceof _a||l instanceof Ns)for(const a of l.uniformNames)i.push({name:a,property:o,binding:l.getBinding(e,a)})}return i}setUniforms(e,i,o,l,a){for(const{name:h,property:_,binding:y}of o)this.binders[_].setUniform(e,y,a,l.get(_),h)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof xo||i instanceof Ns||i instanceof qo)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer)}}upload(e){for(const i in this.binders){const o=this.binders[i];(o instanceof xo||o instanceof Ns||o instanceof qo)&&o.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof xo||i instanceof Ns||i instanceof qo)&&i.destroy()}}}class $o{constructor(e,i,o=()=>!0){this.programConfigurations={};for(const l of e)this.programConfigurations[l.id]=new ga(l,i,o);this.needsUpload=!1,this._featureMap=new _c,this._featureMapWithoutIds=new _c,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,o,l,a,h,_,y){for(const w in this.programConfigurations)this.programConfigurations[w].populatePaintArrays(e,i,l,a,h,_,y);i.id!==void 0?this._featureMap.add(i.id,o,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,o,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,o,l,a,h,_){for(const y of o)this.needsUpload=this.programConfigurations[y.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,y,l,a,h,_||0)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const lg={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function cg(n,e){return lg[n]||[n.replace(`${e}-`,"").replace(/-/g,"_")]}const ug={"line-pattern":{source:jo,composite:jo},"fill-pattern":{source:jo,composite:jo},"fill-extrusion-pattern":{source:jo,composite:jo},"line-dasharray":{source:Cu,composite:Cu}},Nu={color:{source:hl,composite:ma},number:{source:pa,composite:hl}};function Gp(n,e,i){const o=ug[n];return o&&o[i]||Nu[e][i]}It(bc,"ConstantBinder"),It(_a,"PatternConstantBinder"),It(xo,"SourceExpressionBinder"),It(qo,"PatternCompositeBinder"),It(Ns,"CompositeExpressionBinder"),It(ga,"ProgramConfiguration",{omit:["_buffers"]}),It($o,"ProgramConfigurationSet");const Fn=ht/Math.PI/2,fl=5,qp=6,$p=16383,pl=64,Vu=[pl,32,16],us=-Fn,hs=Fn;function ml(n,e,i,o=Fn){return i=xt(i),[n*Math.sin(i)*o,-e*o,n*Math.cos(i)*o]}function ya(n,e,i){return ml(Math.cos(xt(n)),Math.sin(xt(n)),e,i)}const va=63710088e-1,kd=2*Math.PI*va;class Zi{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Zi(Ji(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,o=this.lat*i,l=e.lat*i,a=Math.sin(o)*Math.sin(l)+Math.cos(o)*Math.cos(l)*Math.cos((e.lng-this.lng)*i);return va*Math.acos(Math.min(a,1))}toBounds(e=0){const i=360*e/40075017,o=i/Math.cos(Math.PI/180*this.lat);return new Ho({lng:this.lng-o,lat:this.lat-i},{lng:this.lng+o,lat:this.lat+i})}toEcef(e){return ya(this.lat,this.lng,Fn+e*Fn/va)}static convert(e){if(e instanceof Zi)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Zi(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Zi(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class Ho{constructor(e,i){if(e)if(i)this.setSouthWest(e).setNorthEast(i);else if(e.length===4){const o=e;this.setSouthWest([o[0],o[1]]).setNorthEast([o[2],o[3]])}else{const o=e;this.setSouthWest(o[0]).setNorthEast(o[1])}}setNorthEast(e){return this._ne=e instanceof Zi?new Zi(e.lng,e.lat):Zi.convert(e),this}setSouthWest(e){return this._sw=e instanceof Zi?new Zi(e.lng,e.lat):Zi.convert(e),this}extend(e){const i=this._sw,o=this._ne;let l,a;if(e instanceof Zi)l=e,a=e;else{if(!(e instanceof Ho))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(Ho.convert(e)):this.extend(Zi.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(Zi.convert(e)):this;if(l=e._sw,a=e._ne,!l||!a)return this}return i||o?(i.lng=Math.min(l.lng,i.lng),i.lat=Math.min(l.lat,i.lat),o.lng=Math.max(a.lng,o.lng),o.lat=Math.max(a.lat,o.lat)):(this._sw=new Zi(l.lng,l.lat),this._ne=new Zi(a.lng,a.lat)),this}getCenter(){return new Zi((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Zi(this.getWest(),this.getNorth())}getSouthEast(){return new Zi(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:o}=Zi.convert(e);let l=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(l=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=o&&o<=this._ne.lat&&l}static convert(e){if(e)return e instanceof Ho?e:new Ho(e)}}const hg=0,dg=25.5;function Uu(n){return kd*Math.cos(n*Math.PI/180)}function Ys(n){return(180+n)/360}function Xn(n){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360}function bn(n,e){return n/Uu(e)}function Kn(n){return 360*n-180}function fn(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function Fd(n,e){return n*Uu(fn(e))}const jn=85.051129;function Hp(n){return Math.cos(xt(Dt(n,-85.051129,jn)))}function Zo(n,e){const i=Dt(e,hg,dg),o=Math.pow(2,i);return Hp(n)*kd/(512*o)}function fg(n){return 1/Math.cos(n*Math.PI/180)}function u(n,e=0){const i=Math.exp(Math.PI*(1-(n.y+e/ht)/(1<<n.z)*2));return 80150034*i/(i*i+1)/ht/(1<<n.z)}class t{constructor(e,i,o=0){this.x=+e,this.y=+i,this.z=+o}static fromLngLat(e,i=0){const o=Zi.convert(e);return new t(Ys(o.lng),Xn(o.lat),bn(i,o.lat))}toLngLat(){return new Zi(Kn(this.x),fn(this.y))}toAltitude(){return Fd(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/kd*fg(fn(this.y))}}function r(n,e,i,o,l,a,h,_,y){const w=(e+o)/2,p=(i+l)/2,x=new we(w,p);_(x),function(S,b,T,M,D,z){const N=T-D,B=M-z;return Math.abs((M-b)*N-(T-S)*B)/Math.hypot(N,B)}(x.x,x.y,a.x,a.y,h.x,h.y)>=y?(r(n,e,i,w,p,a,x,_,y),r(n,w,p,o,l,x,h,_,y)):n.push(h)}function c(n,e,i){let o=n[0],l=o.x,a=o.y;e(o);const h=[o];for(let _=1;_<n.length;_++){const y=n[_],{x:w,y:p}=y;e(y),r(h,l,a,w,p,o,y,e,i),l=w,a=p,o=y}return h}function d(n,e,i,o){if(o(e,i)){const l=e.add(i)._mult(.5);d(n,e,l,o),d(n,l,i,o)}else n.push(i)}function m(n,e){let i=n[0];const o=[i];for(let l=1;l<n.length;l++){const a=n[l];d(o,i,a,e),i=a}return o}const g=Math.pow(2,14)-1,E=-g-1;function A(n,e){const i=Math.round(n.x*e),o=Math.round(n.y*e);return n.x=Dt(i,E,g),n.y=Dt(o,E,g),(i<n.x||i>n.x+1||o<n.y||o>n.y+1)&&br("Geometry exceeds allowed extent, reduce your vector tile buffer size"),n}function C(n,e,i){const o=n.loadGeometry(),l=n.extent,a=ht/l;if(e&&i&&i.projection.isReprojectedInTileSpace){const h=1<<e.z,{scale:_,x:y,y:w,projection:p}=i,x=S=>{const b=Kn((e.x+S.x/l)/h),T=fn((e.y+S.y/l)/h),M=p.project(b,T);S.x=(M.x*_-y)*l,S.y=(M.y*_-w)*l};for(let S=0;S<o.length;S++)if(n.type!==1)o[S]=c(o[S],x,1);else{const b=[];for(const T of o[S])T.x<0||T.x>=l||T.y<0||T.y>=l||(x(T),b.push(T));o[S]=b}}for(const h of o)for(const _ of h)A(_,a);return o}function R(n,e){return{type:n.type,id:n.id,properties:n.properties,geometry:e?C(n):[]}}function L(n,e,i,o,l){n.emplaceBack(2*e+(o+1)/2,2*i+(l+1)/2)}function O(n,e,i){n.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class V{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new yo,this.indexArray=new dn,this.segments=new Tr,this.programConfigurations=new $o(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id)}updateFootprints(e,i){}populate(e,i,o,l){const a=this.layers[0],h=[];let _=null;a.type==="circle"&&(_=a.layout.get("circle-sort-key"));for(const{feature:w,id:p,index:x,sourceLayerIndex:S}of e){const b=this.layers[0]._featureFilter.needGeometry,T=R(w,b);if(!this.layers[0]._featureFilter.filter(new ur(this.zoom),T,o))continue;const M=_?_.evaluate(T,{},o):void 0,D={id:p,properties:w.properties,type:w.type,sourceLayerIndex:S,index:x,geometry:b?T.geometry:C(w,o,l),patterns:{},sortKey:M};h.push(D)}_&&h.sort((w,p)=>w.sortKey-p.sortKey);let y=null;l.projection.name==="globe"&&(this.globeExtVertexArray=new Pu,y=l.projection);for(const w of h){const{geometry:p,index:x,sourceLayerIndex:S}=w,b=e[x].feature;this.addFeature(w,p,x,i.availableImages,o,y,i.brightness),i.featureIndex.insert(b,p,x,S,this.index)}}update(e,i,o,l,a,h,_){this.programConfigurations.updatePaintArrays(e,i,a,o,l,h,_)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,ng.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,sg.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,i,o,l,a,h,_){for(const y of i)for(const w of y){const p=w.x,x=w.y;if(p<0||p>=ht||x<0||x>=ht)continue;if(h){const T=h.projectTilePoint(p,x,a),M=h.upVector(a,p,x),D=this.globeExtVertexArray;O(D,T,M),O(D,T,M),O(D,T,M),O(D,T,M)}const S=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),b=S.vertexLength;L(this.layoutVertexArray,p,x,-1,-1),L(this.layoutVertexArray,p,x,1,-1),L(this.layoutVertexArray,p,x,1,1),L(this.layoutVertexArray,p,x,-1,1),this.indexArray.emplaceBack(b,b+1,b+2),this.indexArray.emplaceBack(b,b+2,b+3),S.vertexLength+=4,S.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},l,a,_)}}function H(n,e){for(let i=0;i<n.length;i++)if(ue(e,n[i]))return!0;for(let i=0;i<e.length;i++)if(ue(n,e[i]))return!0;return!!ie(n,e)}function G(n,e,i){return!!ue(n,e)||!!se(e,n,i)}function W(n,e){if(n.length===1)return ce(e,n[0]);for(let i=0;i<e.length;i++){const o=e[i];for(let l=0;l<o.length;l++)if(ue(n,o[l]))return!0}for(let i=0;i<n.length;i++)if(ce(e,n[i]))return!0;for(let i=0;i<e.length;i++)if(ie(n,e[i]))return!0;return!1}function K(n,e,i){if(n.length>1){if(ie(n,e))return!0;for(let o=0;o<e.length;o++)if(se(e[o],n,i))return!0}for(let o=0;o<n.length;o++)if(se(n[o],e,i))return!0;return!1}function ie(n,e){if(n.length===0||e.length===0)return!1;for(let i=0;i<n.length-1;i++){const o=n[i],l=n[i+1];for(let a=0;a<e.length-1;a++)if(oe(o,l,e[a],e[a+1]))return!0}return!1}function oe(n,e,i,o){return ar(n,i,o)!==ar(e,i,o)&&ar(n,e,i)!==ar(n,e,o)}function se(n,e,i){const o=i*i;if(e.length===1)return n.distSqr(e[0])<o;for(let l=1;l<e.length;l++)if(fe(n,e[l-1],e[l])<o)return!0;return!1}function fe(n,e,i){const o=e.distSqr(i);if(o===0)return n.distSqr(e);const l=((n.x-e.x)*(i.x-e.x)+(n.y-e.y)*(i.y-e.y))/o;return n.distSqr(l<0?e:l>1?i:i.sub(e)._mult(l)._add(e))}function ce(n,e){let i,o,l,a=!1;for(let h=0;h<n.length;h++){i=n[h];for(let _=0,y=i.length-1;_<i.length;y=_++)o=i[_],l=i[y],o.y>e.y!=l.y>e.y&&e.x<(l.x-o.x)*(e.y-o.y)/(l.y-o.y)+o.x&&(a=!a)}return a}function ue(n,e){let i=!1;for(let o=0,l=n.length-1;o<n.length;l=o++){const a=n[o],h=n[l];a.y>e.y!=h.y>e.y&&e.x<(h.x-a.x)*(e.y-a.y)/(h.y-a.y)+a.x&&(i=!i)}return i}function he(n,e,i,o,l){for(const h of n)if(e<=h.x&&i<=h.y&&o>=h.x&&l>=h.y)return!0;const a=[new we(e,i),new we(e,l),new we(o,l),new we(o,i)];if(n.length>2){for(const h of a)if(ue(n,h))return!0}for(let h=0;h<n.length-1;h++)if(_e(n[h],n[h+1],a))return!0;return!1}function _e(n,e,i){const o=i[0],l=i[2];if(n.x<o.x&&e.x<o.x||n.x>l.x&&e.x>l.x||n.y<o.y&&e.y<o.y||n.y>l.y&&e.y>l.y)return!1;const a=ar(n,e,i[0]);return a!==ar(n,e,i[1])||a!==ar(n,e,i[2])||a!==ar(n,e,i[3])}function xe(n,e,i,o,l,a){let h=e.y-n.y,_=n.x-e.x;if(a=a||0){const y=h*h+_*_;if(y===0)return!0;const w=Math.sqrt(y);h/=w,_/=w}return!((i.x-n.x)*h+(i.y-n.y)*_-a<0||(o.x-n.x)*h+(o.y-n.y)*_-a<0||(l.x-n.x)*h+(l.y-n.y)*_-a<0)}function Ue(n,e,i,o,l,a,h){return!(xe(n,e,o,l,a,h)||xe(e,i,o,l,a,h)||xe(i,n,o,l,a,h)||xe(o,l,n,e,i,h)||xe(l,a,n,e,i,h)||xe(a,o,n,e,i,h))}function Le(n,e,i){const o=e.paint.get(n).value;return o.kind==="constant"?o.value:i.programConfigurations.get(e.id).getMaxValue(n)}function Ye(n){return Math.sqrt(n[0]*n[0]+n[1]*n[1])}function Je(n,e,i,o,l){if(!e[0]&&!e[1])return n;const a=we.convert(e)._mult(l);i==="viewport"&&a._rotate(-o);const h=[];for(let _=0;_<n.length;_++)h.push(n[_].sub(a));return h}function at(n,e,i,o){const l=we.convert(n)._mult(o);return e==="viewport"&&l._rotate(-i),l}let De,Ke;It(V,"CircleBucket",{omit:["layers"]});var Ie,Xe={exports:{}},He=(Ie||(Ie=1,function(n,e){(function(i){function o(a,h,_){var y=l(256*a,256*(h=Math.pow(2,_)-h-1),_),w=l(256*(a+1),256*(h+1),_);return y[0]+","+y[1]+","+w[0]+","+w[1]}function l(a,h,_){var y=2*Math.PI*6378137/256/Math.pow(2,_);return[a*y-2*Math.PI*6378137/2,h*y-2*Math.PI*6378137/2]}i.getURL=function(a,h,_,y,w,p){return p=p||{},a+"?"+["bbox="+o(_,y,w),"format="+(p.format||"image/png"),"service="+(p.service||"WMS"),"version="+(p.version||"1.1.1"),"request="+(p.request||"GetMap"),"srs="+(p.srs||"EPSG:3857"),"width="+(p.width||256),"height="+(p.height||256),"layers="+h].join("&")},i.getTileBBox=o,i.getMercCoords=l,Object.defineProperty(i,"__esModule",{value:!0})})(e)}(0,Xe.exports)),Xe.exports);class Qe{constructor(e,i,o){this.z=e,this.x=i,this.y=o,this.key=_t(0,e,e,i,o)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,i){const o=He.getTileBBox(this.x,this.y,this.z),l=function(a,h,_){let y,w="";for(let p=a;p>0;p--)y=1<<p-1,w+=(h&y?1:0)+(_&y?2:0);return w}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",l).replace("{bbox-epsg-3857}",o)}toString(){return`${this.z}/${this.x}/${this.y}`}}class je{constructor(e,i){this.wrap=e,this.canonical=i,this.key=_t(e,i.z,i.z,i.x,i.y)}}class it{constructor(e,i,o,l,a){this.overscaledZ=e,this.wrap=i,this.canonical=new Qe(o,+l,+a),this.key=i===0&&e===o?this.canonical.key:_t(i,e,o,l,a)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new it(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new it(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return _t(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const o=this.canonical.z-e;return _t(this.wrap*+i,e,e,this.canonical.x>>o,this.canonical.y>>o)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new it(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,o=2*this.canonical.x,l=2*this.canonical.y;return[new it(i,this.wrap,i,o,l),new it(i,this.wrap,i,o+1,l),new it(i,this.wrap,i,o,l+1),new it(i,this.wrap,i,o+1,l+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new it(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new it(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new je(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function _t(n,e,i,o,l){const a=1<<Math.min(i,22);let h=a*(l%a)+o%a;return n&&i<22&&(h+=a*a*((n<0?-2*n-1:2*n)%(1<<2*(22-i)))),16*(32*h+i)+(e-i)}const yt=[n=>{let e=n.canonical.x-1,i=n.wrap;return e<0&&(e=(1<<n.canonical.z)-1,i--),new it(n.overscaledZ,i,n.canonical.z,e,n.canonical.y)},n=>{let e=n.canonical.x+1,i=n.wrap;return e===1<<n.canonical.z&&(e=0,i++),new it(n.overscaledZ,i,n.canonical.z,e,n.canonical.y)},n=>new it(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,(n.canonical.y===0?1<<n.canonical.z:n.canonical.y)-1),n=>new it(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,n.canonical.y===(1<<n.canonical.z)-1?0:n.canonical.y+1)];It(Qe,"CanonicalTileID"),It(it,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const wt=Hi([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Ot}=wt,si=Hi([{name:"a_pos_3",components:3,type:"Int16"}]);var Wt=Hi([{name:"a_pos",type:"Int16",components:2}]);class ii{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,o){const l=J.vec2.dot(i,this.dir);if(Math.abs(l)<1e-6)return!1;const a=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/l;return o[0]=this.pos[0]+this.dir[0]*a,o[1]=this.pos[1]+this.dir[1]*a,!0}}class Yt{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,o){const l=J.vec3.dot(i,this.dir);if(Math.abs(l)<1e-6)return!1;const a=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/l;return o[0]=this.pos[0]+this.dir[0]*a,o[1]=this.pos[1]+this.dir[1]*a,o[2]=this.pos[2]+this.dir[2]*a,!0}closestPointOnSphere(e,i,o){if(J.vec3.equals(this.pos,e)||i===0)return o[0]=o[1]=o[2]=0,!1;const[l,a,h]=this.dir,_=this.pos[0]-e[0],y=this.pos[1]-e[1],w=this.pos[2]-e[2],p=l*l+a*a+h*h,x=2*(_*l+y*a+w*h),S=x*x-4*p*(_*_+y*y+w*w-i*i);if(S<0){const b=Math.max(-x/2,0),T=_+l*b,M=y+a*b,D=w+h*b,z=Math.hypot(T,M,D);return o[0]=T*i/z,o[1]=M*i/z,o[2]=D*i/z,!1}{const b=(-x-Math.sqrt(S))/(2*p);if(b<0){const T=Math.hypot(_,y,w);return o[0]=_*i/T,o[1]=y*i/T,o[2]=w*i/T,!1}return o[0]=_+l*b,o[1]=y+a*b,o[2]=w+h*b,!0}}}class Ii{constructor(e,i,o,l,a){this.TL=e,this.TR=i,this.BR=o,this.BL=l,this.horizon=a}static fromInvProjectionMatrix(e,i,o){const l=[-1,1,1],a=[1,1,1],h=[1,-1,1],_=[-1,-1,1],y=J.vec3.transformMat4(l,l,e),w=J.vec3.transformMat4(a,a,e),p=J.vec3.transformMat4(h,h,e),x=J.vec3.transformMat4(_,_,e);return new Ii(y,w,p,x,i/o)}}function Wi(n,e,i){let o=1/0,l=-1/0;const a=[];for(const h of n){J.vec3.sub(a,h,e);const _=J.vec3.dot(a,i);o=Math.min(o,_),l=Math.max(l,_)}return[o,l]}function dr(n,e){let i=!0;for(let o=0;o<n.planes.length;o++){const l=n.planes[o];let a=0;for(let h=0;h<e.length;h++)a+=J.vec3.dot(l,e[h])+l[3]>=0;if(a===0)return 0;a!==e.length&&(i=!1)}return i?2:1}function wi(n,e){for(const i of n.projections){const o=Wi(e,n.points[0],i.axis);if(i.projection[1]<o[0]||i.projection[0]>o[1])return 0}return 1}function Sr(n,e){let i=0;const o=[0,0,0,0];for(let l=0;l<n.length;l++)o[0]=n[l][0],o[1]=n[l][1],o[2]=n[l][2],o[3]=1,J.vec4.dot(o,e)>=0&&i++;return i}class ci{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=kt.fromPoints(this.points),this.projections=[],this.frustumEdges=[J.vec3.sub([],this.points[2],this.points[3]),J.vec3.sub([],this.points[0],this.points[3]),J.vec3.sub([],this.points[4],this.points[0]),J.vec3.sub([],this.points[5],this.points[1]),J.vec3.sub([],this.points[6],this.points[2]),J.vec3.sub([],this.points[7],this.points[3])];for(const o of this.frustumEdges){const l=[0,-o[2],o[1]],a=[o[2],0,-o[0]];this.projections.push({axis:l,projection:Wi(this.points,this.points[0],l)}),this.projections.push({axis:a,projection:Wi(this.points,this.points[0],a)})}}static fromInvProjectionMatrix(e,i,o,l){const a=Math.pow(2,o),h=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(w=>{const p=J.vec4.transformMat4([],w,e),x=1/p[3]/i*a;return J.vec4.mul(p,p,[x,x,l?1/p[3]:x,x])}),_=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(w=>{const p=J.vec3.sub([],h[w[0]],h[w[1]]),x=J.vec3.sub([],h[w[2]],h[w[1]]),S=J.vec3.normalize([],J.vec3.cross([],p,x)),b=-J.vec3.dot(S,h[w[1]]);return S.concat(b)}),y=[];for(let w=0;w<h.length;w++)y.push([h[w][0],h[w][1],h[w][2]]);return new ci(y,_)}intersectsPrecise(e,i,o){for(let l=0;l<i.length;l++)if(!Sr(e,i[l]))return 0;for(let l=0;l<this.planes.length;l++)if(!Sr(e,this.planes[l]))return 0;for(const l of o)for(const a of this.frustumEdges){const h=J.vec3.cross([],l,a),_=J.vec3.length(h);if(_===0)continue;J.vec3.scale(h,h,1/_);const y=Wi(this.points,this.points[0],h),w=Wi(e,this.points[0],h);if(y[0]>w[1]||w[0]>y[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const o=i[3];if(J.vec3.dot([i[0],i[1],i[2]],e)+o<0)return!1}return!0}}class kt{static fromPoints(e){const i=[1/0,1/0,1/0],o=[-1/0,-1/0,-1/0];for(const l of e)J.vec3.min(i,i,l),J.vec3.max(o,o,l);return new kt(i,o)}static fromTileIdAndHeight(e,i,o){const l=1<<e.canonical.z,a=e.canonical.x,h=e.canonical.y;return new kt([a/l,h/l,i],[(a+1)/l,(h+1)/l,o])}static applyTransform(e,i){const o=e.getCorners();for(let l=0;l<o.length;++l)J.vec3.transformMat4(o[l],o[l],i);return kt.fromPoints(o)}static applyTransformFast(e,i){const o=[i[12],i[13],i[14]],l=[...o];for(let a=0;a<3;a++)for(let h=0;h<3;h++){const _=i[4*h+a],y=_*e.min[h],w=_*e.max[h];o[a]+=Math.min(y,w),l[a]+=Math.max(y,w)}return new kt(o,l)}static projectAabbCorners(e,i){const o=e.getCorners();for(let l=0;l<o.length;++l)J.vec3.transformMat4(o[l],o[l],i);return o}constructor(e,i){this.min=e,this.max=i,this.center=J.vec3.scale([],J.vec3.add([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],o=J.vec3.clone(this.min),l=J.vec3.clone(this.max);for(let a=0;a<i.length;a++)o[a]=i[a]?this.min[a]:this.center[a],l[a]=i[a]?this.center[a]:this.max[a];return l[2]=this.max[2],new kt(o,l)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?dr(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?dr(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?wi(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?wi(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}function Ri(n){return n*Fn/va}It(kt,"Aabb");const ir=[new kt([us,us,us],[hs,hs,hs]),new kt([us,us,us],[0,0,hs]),new kt([0,us,us],[hs,0,hs]),new kt([us,0,us],[0,hs,hs]),new kt([0,0,us],[hs,hs,hs])];function Bi(n,e,i,o=!0){const l=J.vec3.scale([],n._camera.position,n.worldSize),a=[e,i,1,1];J.vec4.transformMat4(a,a,n.pixelMatrixInverse),J.vec4.scale(a,a,1/a[3]);const h=J.vec3.sub([],a,l),_=J.vec3.normalize([],h),y=n.globeMatrix,w=[y[12],y[13],y[14]],p=J.vec3.sub([],w,l),x=J.vec3.length(p),S=J.vec3.normalize([],p),b=n.worldSize/(2*Math.PI),T=J.vec3.dot(S,_),M=Math.asin(b/x);if(M<Math.acos(T)){if(!o)return null;const pe=[],ne=[];J.vec3.scale(pe,_,x/T),J.vec3.normalize(ne,J.vec3.sub(ne,pe,p)),J.vec3.normalize(_,J.vec3.add(_,p,J.vec3.scale(_,ne,Math.tan(M)*x)))}const D=[];new Yt(l,_).closestPointOnSphere(w,b,D);const z=J.vec3.normalize([],Ra(y,0)),N=J.vec3.normalize([],Ra(y,1)),B=J.vec3.normalize([],Ra(y,2)),F=J.vec3.dot(z,D),U=J.vec3.dot(N,D),q=J.vec3.dot(B,D),Z=Ut(Math.asin(-U/b));let re=Ut(Math.atan2(F,q));re=n.center.lng+function(pe,ne){const me=(ne-pe+180)%360-180;return me<-180?me+360:me}(n.center.lng,re);const ee=Ys(re),te=Dt(Xn(Z),0,1);return new t(ee,te)}class Rr{constructor(e,i,o){this.a=J.vec3.sub([],e,o),this.b=J.vec3.sub([],i,o),this.center=o;const l=J.vec3.normalize([],this.a),a=J.vec3.normalize([],this.b);this.angle=Math.acos(J.vec3.dot(l,a))}}function $r(n,e){if(n.angle===0)return null;let i;return i=n.a[e]===0?1/n.angle*.5*Math.PI:1/n.angle*Math.atan(n.b[e]/n.a[e]/Math.sin(n.angle)-1/Math.tan(n.angle)),i<0||i>1?null:function(o,l,a,h){const _=Math.sin(a);return o*(Math.sin((1-h)*a)/_)+l*(Math.sin(h*a)/_)}(n.a[e],n.b[e],n.angle,Dt(i,0,1))+n.center[e]}function tn(n){if(n.z<=1)return ir[n.z+2*n.y+n.x];const e=Er(Li(n));return kt.fromPoints(e)}function nn(n,e,i){return J.vec3.scale(n,n,1-i),J.vec3.scaleAndAdd(n,n,e,i)}function ds(n,e,i){for(const o of n)J.vec3.transformMat4(o,o,e),J.vec3.scale(o,o,i)}function Pn(n,e,i,o){const l=e/n.worldSize,a=n.globeMatrix;if(i.z<=1){const ee=tn(i).getCorners();return ds(ee,a,l),kt.fromPoints(ee)}const h=Li(i,o),_=Er(h,Fn+Ri(n._tileCoverLift));ds(_,a,l);const y=Number.MAX_VALUE,w=[-y,-y,-y],p=[y,y,y];if(h.contains(n.center)){for(const pe of _)J.vec3.min(p,p,pe),J.vec3.max(w,w,pe);w[2]=0;const ee=n.point,te=[ee.x*l,ee.y*l,0];return J.vec3.min(p,p,te),J.vec3.max(w,w,te),new kt(p,w)}if(n._tileCoverLift>0){for(const ee of _)J.vec3.min(p,p,ee),J.vec3.max(w,w,ee);return new kt(p,w)}const x=[a[12]*l,a[13]*l,a[14]*l],S=h.getCenter(),b=Dt(n.center.lat,-85.051129,jn),T=Dt(S.lat,-85.051129,jn),M=Ys(n.center.lng),D=Xn(b);let z=M-Ys(S.lng);const N=D-Xn(T);z>.5?z-=1:z<-.5&&(z+=1);let B=0;if(Math.abs(z)>Math.abs(N))B=z>=0?1:3;else{B=N>=0?0:2;const ee=[a[4]*l,a[5]*l,a[6]*l],te=-Math.sin(xt(N>=0?h.getSouth():h.getNorth()))*Fn;J.vec3.scaleAndAdd(x,x,ee,te)}const F=_[B],U=_[(B+1)%4],q=new Rr(F,U,x),Z=[$r(q,0)||F[0],$r(q,1)||F[1],$r(q,2)||F[2]],re=Gn(n.zoom);if(re>0){const ee=function({x:pe,y:ne,z:me},be,ve,Me,Ee){const Oe=1/(1<<me);let Ce=pe*Oe,ke=Ce+Oe,rt=ne*Oe,tt=rt+Oe,Ct=0;const ot=(Ce+ke)/2-Me;return ot>.5?Ct=-1:ot<-.5&&(Ct=1),Ce=((Ce+Ct)*be-(Me*=be))*ve+Me,ke=((ke+Ct)*be-Me)*ve+Me,rt=(rt*be-(Ee*=be))*ve+Ee,tt=(tt*be-Ee)*ve+Ee,[[Ce,tt,0],[ke,tt,0],[ke,rt,0],[Ce,rt,0]]}(i,e,n._pixelsPerMercatorPixel,M,D);for(let pe=0;pe<_.length;pe++)nn(_[pe],ee[pe],re);const te=J.vec3.add([],ee[B],ee[(B+1)%4]);J.vec3.scale(te,te,.5),nn(Z,te,re)}for(const ee of _)J.vec3.min(p,p,ee),J.vec3.max(w,w,ee);return p[2]=Math.min(F[2],U[2]),J.vec3.min(p,p,Z),J.vec3.max(w,w,Z),new kt(p,w)}function Li({x:n,y:e,z:i},o=!1){const l=1/(1<<i),a=new Zi(Kn(n*l),e===(1<<i)-1&&o?-90:fn((e+1)*l)),h=new Zi(Kn((n+1)*l),e===0&&o?90:fn(e*l));return new Ho(a,h)}function Er(n,e=Fn){const i=xt(n.getNorth()),o=xt(n.getSouth()),l=Math.cos(i),a=Math.cos(o),h=Math.sin(i),_=Math.sin(o),y=n.getWest(),w=n.getEast();return[ml(a,_,y,e),ml(a,_,w,e),ml(l,h,w,e),ml(l,h,y,e)]}function Xi(n,e,i,o){const l=1<<i.z,a=(n/ht+i.x)/l;return ya(fn((e/ht+i.y)/l),Kn(a),o)}function lr({min:n,max:e}){return $p/Math.max(e[0]-n[0],e[1]-n[1],e[2]-n[2])}const pn=new Float64Array(16);function yr(n){const e=lr(n),i=J.mat4.fromScaling(pn,[e,e,e]);return J.mat4.translate(i,i,J.vec3.negate([],n.min))}function rn(n){const e=J.mat4.fromTranslation(pn,n.min),i=1/lr(n);return J.mat4.scale(e,e,[i,i,i])}function Js(n){const e=ht/(2*Math.PI);return n/(2*Math.PI)/e}function Yn(n,e){return ht/(512*Math.pow(2,n))*lr(tn(e))}function Ms(n,e,i,o,l){const a=Js(i),h=[n,e,-i/(2*Math.PI)],_=J.mat4.identity(new Float64Array(16));return J.mat4.translate(_,_,h),J.mat4.scale(_,_,[a,a,a]),J.mat4.rotateX(_,_,xt(-l)),J.mat4.rotateY(_,_,xt(-o)),_}function Gn(n){return yi(fl,qp,n)}function As(n,e){const i=ya(e.lat,e.lng),o=function(a){const h=ya(a._center.lat,a._center.lng),_=J.vec3.fromValues(0,1,0);let y=J.vec3.cross([],_,h);const w=J.mat4.fromRotation([],-a.angle,h);y=J.vec3.transformMat4(y,y,w),J.mat4.fromRotation(w,-a._pitch,y);const p=J.vec3.normalize([],h);return J.vec3.scale(p,p,Ri(a.cameraToCenterDistance/a.pixelsPerMeter)),J.vec3.transformMat4(p,p,w),J.vec3.add([],h,p)}(n),l=J.vec3.subtract([],o,i);return J.vec3.angle(l,i)}function Jn(n,e){return As(n,e)>Math.PI/2*1.01}const bo=xt(85),Qs=Math.cos(bo),wo=Math.sin(bo),Bd=J.mat4.create(),_l=n=>{const e=[];return n.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),n.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function ju(n,e,i,o,l,a,h,_,y){if(a&&n.queryGeometry.isAboveHorizon)return!1;a&&(y*=n.pixelToTileUnitsFactor);const w=n.tileID.canonical,p=i.projection.upVectorScale(w,i.center.lat,i.worldSize).metersToTile;for(const x of e)for(const S of x){const b=S.add(_),T=l&&i.elevation?i.elevation.exaggeration()*l.getElevationAt(b.x,b.y,!0):0,M=i.projection.projectTilePoint(b.x,b.y,w);if(T>0){const B=i.projection.upVector(w,b.x,b.y);M.x+=B[0]*p*T,M.y+=B[1]*p*T,M.z+=B[2]*p*T}const D=a?b:Nd(M.x,M.y,M.z,o),z=a?n.tilespaceRays.map(B=>wT(B,T)):n.queryGeometry.screenGeometry,N=J.vec4.transformMat4([],[M.x,M.y,M.z,1],o);if(!h&&a?y*=N[3]/i.cameraToCenterDistance:h&&!a&&(y*=i.cameraToCenterDistance/N[3]),a){const B=fn((S.y/ht+w.y)/(1<<w.z));y/=i.projection.pixelsPerMeter(B,1)/bn(1,B)}if(G(z,D,y))return!0}return!1}function Nd(n,e,i,o){const l=J.vec4.transformMat4([],[n,e,i,1],o);return new we(l[0]/l[3],l[1]/l[3])}const kv=J.vec3.fromValues(0,0,0),bT=J.vec3.fromValues(0,0,1);function wT(n,e){const i=J.vec3.create();return kv[2]=e,n.intersectsPlane(kv,bT,i),new we(i[0],i[1])}class Fv extends V{}let Bv,Nv,Vv,Uv;function jv(n,{width:e,height:i},o,l){if(l){if(l instanceof Uint8ClampedArray)l=new Uint8Array(l.buffer);else if(l.length!==e*i*o)throw new RangeError("mismatched image size")}else l=new Uint8Array(e*i*o);return n.width=e,n.height=i,n.data=l,n}function Gv(n,e,i){const{width:o,height:l}=e;o===n.width&&l===n.height||(pg(n,e,{x:0,y:0},{x:0,y:0},{width:Math.min(n.width,o),height:Math.min(n.height,l)},i,null),n.width=o,n.height=l,n.data=e.data)}function pg(n,e,i,o,l,a,h,_){if(l.width===0||l.height===0)return e;if(l.width>n.width||l.height>n.height||i.x>n.width-l.width||i.y>n.height-l.height)throw new RangeError("out of range source coordinates for image copy");if(l.width>e.width||l.height>e.height||o.x>e.width-l.width||o.y>e.height-l.height)throw new RangeError("out of range destination coordinates for image copy");const y=n.data,w=e.data,p=a===4&&_;for(let x=0;x<l.height;x++){const S=((i.y+x)*n.width+i.x)*a,b=((o.y+x)*e.width+o.x)*a;if(p)for(let T=0;T<l.width;T++){const M=S+T*a+3,D=b+T*a;w[D+0]=255,w[D+1]=255,w[D+2]=255,w[D+3]=y[M]}else if(h)for(let T=0;T<l.width;T++){const M=S+T*a,D=b+T*a,z=y[M+3],N=new tr(y[M+0]/255*z,y[M+1]/255*z,y[M+2]/255*z,z).toRenderColor(h).toArray();w[D+0]=N[0],w[D+1]=N[1],w[D+2]=N[2],w[D+3]=N[3]}else for(let T=0;T<l.width*a;T++)w[b+T]=y[S+T]}return e}It(Fv,"HeatmapBucket",{omit:["layers"]});class gl{constructor(e,i){jv(this,e,1,i)}resize(e){Gv(this,new gl(e),1)}clone(){return new gl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,l,a){pg(e,i,o,l,a,1,null)}}class wn{constructor(e,i){jv(this,e,4,i)}resize(e){Gv(this,new wn(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new wn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,l,a,h,_){pg(e,i,o,l,a,4,h,_)}}class qv{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function Vd(n){const e={},i=n.resolution||256,o=n.clips?n.clips.length:1,l=n.image||new wn({width:i,height:o}),a=(h,_,y)=>{e[n.evaluationKey]=y;const w=n.expression.evaluate(e);w&&(l.data[h+_+0]=Math.floor(255*w.r/w.a),l.data[h+_+1]=Math.floor(255*w.g/w.a),l.data[h+_+2]=Math.floor(255*w.b/w.a),l.data[h+_+3]=Math.floor(255*w.a))};if(n.clips)for(let h=0,_=0;h<o;++h,_+=4*i)for(let y=0,w=0;y<i;y++,w+=4){const p=y/(i-1),{start:x,end:S}=n.clips[h];a(_,w,x*(1-p)+S*p)}else for(let h=0,_=0;h<i;h++,_+=4)a(0,_,h/(i-1));return l}It(gl,"AlphaImage"),It(wn,"RGBAImage");const TT=Hi([{name:"a_pos",components:2,type:"Int16"}],4),ST=Hi([{name:"a_road_z_offset",components:1,type:"Float32"}],4),ET=Hi([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),MT=Hi([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Ud(n,e,i=2){const o=e&&e.length,l=o?e[0]*i:n.length;let a=$v(n,0,l,i,!0);const h=[];if(!a||a.next===a.prev)return h;let _,y,w;if(o&&(a=function(p,x,S,b){const T=[];for(let M=0,D=x.length;M<D;M++){const z=$v(p,x[M]*b,M<D-1?x[M+1]*b:p.length,b,!1);z===z.next&&(z.steiner=!0),T.push(LT(z))}T.sort(RT);for(let M=0;M<T.length;M++)S=DT(T[M],S);return S}(n,e,a,i)),n.length>80*i){_=1/0,y=1/0;let p=-1/0,x=-1/0;for(let S=i;S<l;S+=i){const b=n[S],T=n[S+1];b<_&&(_=b),T<y&&(y=T),b>p&&(p=b),T>x&&(x=T)}w=Math.max(p-_,x-y),w=w!==0?32767/w:0}return jd(a,h,i,_,y,w,0),h}function $v(n,e,i,o,l){let a;if(l===function(h,_,y,w){let p=0;for(let x=_,S=y-w;x<y;x+=w)p+=(h[S]-h[x])*(h[x+1]+h[S+1]),S=x;return p}(n,e,i,o)>0)for(let h=e;h<i;h+=o)a=Wv(h/o|0,n[h],n[h+1],a);else for(let h=i-o;h>=e;h-=o)a=Wv(h/o|0,n[h],n[h+1],a);return a&&Zp(a,a.next)&&(qd(a),a=a.next),a}function wc(n,e){if(!n)return n;e||(e=n);let i,o=n;do if(i=!1,o.steiner||!Zp(o,o.next)&&sn(o.prev,o,o.next)!==0)o=o.next;else{if(qd(o),o=e=o.prev,o===o.next)break;i=!0}while(i||o!==e);return e}function jd(n,e,i,o,l,a,h){if(!n)return;!h&&a&&function(y,w,p,x){let S=y;do S.z===0&&(S.z=mg(S.x,S.y,w,p,x)),S.prevZ=S.prev,S.nextZ=S.next,S=S.next;while(S!==y);S.prevZ.nextZ=null,S.prevZ=null,function(b){let T,M=1;do{let D,z=b;b=null;let N=null;for(T=0;z;){T++;let B=z,F=0;for(let q=0;q<M&&(F++,B=B.nextZ,B);q++);let U=M;for(;F>0||U>0&&B;)F!==0&&(U===0||!B||z.z<=B.z)?(D=z,z=z.nextZ,F--):(D=B,B=B.nextZ,U--),N?N.nextZ=D:b=D,D.prevZ=N,N=D;z=B}N.nextZ=null,M*=2}while(T>1)}(S)}(n,o,l,a);let _=n;for(;n.prev!==n.next;){const y=n.prev,w=n.next;if(a?IT(n,o,l,a):AT(n))e.push(y.i,n.i,w.i),qd(n),n=w.next,_=w.next;else if((n=w)===_){h?h===1?jd(n=CT(wc(n),e),e,i,o,l,a,2):h===2&&PT(n,e,i,o,l,a):jd(wc(n),e,i,o,l,a,1);break}}}function AT(n){const e=n.prev,i=n,o=n.next;if(sn(e,i,o)>=0)return!1;const l=e.x,a=i.x,h=o.x,_=e.y,y=i.y,w=o.y,p=l<a?l<h?l:h:a<h?a:h,x=_<y?_<w?_:w:y<w?y:w,S=l>a?l>h?l:h:a>h?a:h,b=_>y?_>w?_:w:y>w?y:w;let T=o.next;for(;T!==e;){if(T.x>=p&&T.x<=S&&T.y>=x&&T.y<=b&&Gu(l,_,a,y,h,w,T.x,T.y)&&sn(T.prev,T,T.next)>=0)return!1;T=T.next}return!0}function IT(n,e,i,o){const l=n.prev,a=n,h=n.next;if(sn(l,a,h)>=0)return!1;const _=l.x,y=a.x,w=h.x,p=l.y,x=a.y,S=h.y,b=_<y?_<w?_:w:y<w?y:w,T=p<x?p<S?p:S:x<S?x:S,M=_>y?_>w?_:w:y>w?y:w,D=p>x?p>S?p:S:x>S?x:S,z=mg(b,T,e,i,o),N=mg(M,D,e,i,o);let B=n.prevZ,F=n.nextZ;for(;B&&B.z>=z&&F&&F.z<=N;){if(B.x>=b&&B.x<=M&&B.y>=T&&B.y<=D&&B!==l&&B!==h&&Gu(_,p,y,x,w,S,B.x,B.y)&&sn(B.prev,B,B.next)>=0||(B=B.prevZ,F.x>=b&&F.x<=M&&F.y>=T&&F.y<=D&&F!==l&&F!==h&&Gu(_,p,y,x,w,S,F.x,F.y)&&sn(F.prev,F,F.next)>=0))return!1;F=F.nextZ}for(;B&&B.z>=z;){if(B.x>=b&&B.x<=M&&B.y>=T&&B.y<=D&&B!==l&&B!==h&&Gu(_,p,y,x,w,S,B.x,B.y)&&sn(B.prev,B,B.next)>=0)return!1;B=B.prevZ}for(;F&&F.z<=N;){if(F.x>=b&&F.x<=M&&F.y>=T&&F.y<=D&&F!==l&&F!==h&&Gu(_,p,y,x,w,S,F.x,F.y)&&sn(F.prev,F,F.next)>=0)return!1;F=F.nextZ}return!0}function CT(n,e){let i=n;do{const o=i.prev,l=i.next.next;!Zp(o,l)&&Hv(o,i,i.next,l)&&Gd(o,l)&&Gd(l,o)&&(e.push(o.i,i.i,l.i),qd(i),qd(i.next),i=n=l),i=i.next}while(i!==n);return wc(i)}function PT(n,e,i,o,l,a){let h=n;do{let _=h.next.next;for(;_!==h.prev;){if(h.i!==_.i&&OT(h,_)){let y=Zv(h,_);return h=wc(h,h.next),y=wc(y,y.next),jd(h,e,i,o,l,a,0),void jd(y,e,i,o,l,a,0)}_=_.next}h=h.next}while(h!==n)}function RT(n,e){return n.x-e.x}function DT(n,e){const i=function(l,a){let h=a;const _=l.x,y=l.y;let w,p=-1/0;do{if(y<=h.y&&y>=h.next.y&&h.next.y!==h.y){const M=h.x+(y-h.y)*(h.next.x-h.x)/(h.next.y-h.y);if(M<=_&&M>p&&(p=M,w=h.x<h.next.x?h:h.next,M===_))return w}h=h.next}while(h!==a);if(!w)return null;const x=w,S=w.x,b=w.y;let T=1/0;h=w;do{if(_>=h.x&&h.x>=S&&_!==h.x&&Gu(y<b?_:p,y,S,b,y<b?p:_,y,h.x,h.y)){const M=Math.abs(y-h.y)/(_-h.x);Gd(h,l)&&(M<T||M===T&&(h.x>w.x||h.x===w.x&&zT(w,h)))&&(w=h,T=M)}h=h.next}while(h!==x);return w}(n,e);if(!i)return e;const o=Zv(i,n);return wc(o,o.next),wc(i,i.next)}function zT(n,e){return sn(n.prev,n,e.prev)<0&&sn(e.next,n,n.next)<0}function mg(n,e,i,o,l){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-i)*l|0)|n<<8))|n<<4))|n<<2))|n<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-o)*l|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function LT(n){let e=n,i=n;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==n);return i}function Gu(n,e,i,o,l,a,h,_){return(l-h)*(e-_)>=(n-h)*(a-_)&&(n-h)*(o-_)>=(i-h)*(e-_)&&(i-h)*(a-_)>=(l-h)*(o-_)}function OT(n,e){return n.next.i!==e.i&&n.prev.i!==e.i&&!function(i,o){let l=i;do{if(l.i!==i.i&&l.next.i!==i.i&&l.i!==o.i&&l.next.i!==o.i&&Hv(l,l.next,i,o))return!0;l=l.next}while(l!==i);return!1}(n,e)&&(Gd(n,e)&&Gd(e,n)&&function(i,o){let l=i,a=!1;const h=(i.x+o.x)/2,_=(i.y+o.y)/2;do l.y>_!=l.next.y>_&&l.next.y!==l.y&&h<(l.next.x-l.x)*(_-l.y)/(l.next.y-l.y)+l.x&&(a=!a),l=l.next;while(l!==i);return a}(n,e)&&(sn(n.prev,n,e.prev)||sn(n,e.prev,e))||Zp(n,e)&&sn(n.prev,n,n.next)>0&&sn(e.prev,e,e.next)>0)}function sn(n,e,i){return(e.y-n.y)*(i.x-e.x)-(e.x-n.x)*(i.y-e.y)}function Zp(n,e){return n.x===e.x&&n.y===e.y}function Hv(n,e,i,o){const l=Xp(sn(n,e,i)),a=Xp(sn(n,e,o)),h=Xp(sn(i,o,n)),_=Xp(sn(i,o,e));return l!==a&&h!==_||!(l!==0||!Wp(n,i,e))||!(a!==0||!Wp(n,o,e))||!(h!==0||!Wp(i,n,o))||!(_!==0||!Wp(i,e,o))}function Wp(n,e,i){return e.x<=Math.max(n.x,i.x)&&e.x>=Math.min(n.x,i.x)&&e.y<=Math.max(n.y,i.y)&&e.y>=Math.min(n.y,i.y)}function Xp(n){return n>0?1:n<0?-1:0}function Gd(n,e){return sn(n.prev,n,n.next)<0?sn(n,e,n.next)>=0&&sn(n,n.prev,e)>=0:sn(n,e,n.prev)<0||sn(n,n.next,e)<0}function Zv(n,e){const i=_g(n.i,n.x,n.y),o=_g(e.i,e.x,e.y),l=n.next,a=e.prev;return n.next=e,e.prev=n,i.next=l,l.prev=i,o.next=i,i.prev=o,a.next=o,o.prev=a,o}function Wv(n,e,i,o){const l=_g(n,e,i);return o?(l.next=o.next,l.prev=o,o.next.prev=l,o.next=l):(l.prev=l,l.next=l),l}function qd(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function _g(n,e,i){return{i:n,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Kp(n,e){const i=n.length;if(i<=1)return[n];const o=[];let l,a;for(let h=0;h<i;h++){const _=Bl(n[h]);_!==0&&(n[h].area=Math.abs(_),a===void 0&&(a=_<0),a===_<0?(l&&o.push(l),l=[n[h]]):l.push(n[h]))}if(l&&o.push(l),e>1)for(let h=0;h<o.length;h++)o[h].length<=e||(tp(o[h],e,1,o[h].length-1,kT),o[h]=o[h].slice(0,e));return o}function kT(n,e){return e.area-n.area}function Xv(n,e,i=1){if(!n)return null;const o=typeof n=="string"?Cn.from(n).getPrimary():n.getPrimary(),l=o.id.toString();return e.has(l)||e.set(l,[]),o.scaleSelf(i),e.get(l).push(o),o.toString()}function gg(n,e,i,o){const l=o.patternDependencies;let a=!1;for(const h of e){const _=h.paint.get(`${n}-pattern`);_.isConstant()||(a=!0),Xv(_.constantOr(null),l,i)&&(a=!0)}return a}function yg(n,e,i,o,l,a){const h=a.patternDependencies;for(const _ of e){const y=_.paint.get(`${n}-pattern`).value;if(y.kind!=="constant"){let w=y.evaluate({zoom:o},i,{},a.availableImages);w=w&&w.name?w.name:w;const p=Xv(w,h,l);p&&(i.patterns[_.id]=p)}}return i}var vg,Kv,xg,Yv,bg,Jv,Qv,Yp={};function e0(){if(Kv)return vg;Kv=1;var n=Be();function e(l,a,h,_,y){this.properties={},this.extent=h,this.type=0,this._pbf=l,this._geometry=-1,this._keys=_,this._values=y,l.readFields(i,this,a)}function i(l,a,h){l==1?a.id=h.readVarint():l==2?function(_,y){for(var w=_.readVarint()+_.pos;_.pos<w;){var p=y._keys[_.readVarint()],x=y._values[_.readVarint()];y.properties[p]=x}}(h,a):l==3?a.type=h.readVarint():l==4&&(a._geometry=h.pos)}function o(l){for(var a,h,_=0,y=0,w=l.length,p=w-1;y<w;p=y++)_+=((h=l[p]).x-(a=l[y]).x)*(a.y+h.y);return _}return vg=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var l=this._pbf;l.pos=this._geometry;for(var a,h=l.readVarint()+l.pos,_=1,y=0,w=0,p=0,x=[];l.pos<h;){if(y<=0){var S=l.readVarint();_=7&S,y=S>>3}if(y--,_===1||_===2)w+=l.readSVarint(),p+=l.readSVarint(),_===1&&(a&&x.push(a),a=[]),a.push(new n(w,p));else{if(_!==7)throw new Error("unknown command "+_);a&&a.push(a[0].clone())}}return a&&x.push(a),x},e.prototype.bbox=function(){var l=this._pbf;l.pos=this._geometry;for(var a=l.readVarint()+l.pos,h=1,_=0,y=0,w=0,p=1/0,x=-1/0,S=1/0,b=-1/0;l.pos<a;){if(_<=0){var T=l.readVarint();h=7&T,_=T>>3}if(_--,h===1||h===2)(y+=l.readSVarint())<p&&(p=y),y>x&&(x=y),(w+=l.readSVarint())<S&&(S=w),w>b&&(b=w);else if(h!==7)throw new Error("unknown command "+h)}return[p,S,x,b]},e.prototype.toGeoJSON=function(l,a,h){var _,y,w=this.extent*Math.pow(2,h),p=this.extent*l,x=this.extent*a,S=this.loadGeometry(),b=e.types[this.type];function T(z){for(var N=0;N<z.length;N++){var B=z[N];z[N]=[360*(B.x+p)/w-180,360/Math.PI*Math.atan(Math.exp((180-360*(B.y+x)/w)*Math.PI/180))-90]}}switch(this.type){case 1:var M=[];for(_=0;_<S.length;_++)M[_]=S[_][0];T(S=M);break;case 2:for(_=0;_<S.length;_++)T(S[_]);break;case 3:for(S=function(z){var N=z.length;if(N<=1)return[z];for(var B,F,U=[],q=0;q<N;q++){var Z=o(z[q]);Z!==0&&(F===void 0&&(F=Z<0),F===Z<0?(B&&U.push(B),B=[z[q]]):B.push(z[q]))}return B&&U.push(B),U}(S),_=0;_<S.length;_++)for(y=0;y<S[_].length;y++)T(S[_][y])}S.length===1?S=S[0]:b="Multi"+b;var D={type:"Feature",geometry:{type:b,coordinates:S},properties:this.properties};return"id"in this&&(D.id=this.id),D},vg}function t0(){if(Yv)return xg;Yv=1;var n=e0();function e(o,l){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=o,this._keys=[],this._values=[],this._features=[],o.readFields(i,this,l),this.length=this._features.length}function i(o,l,a){o===15?l.version=a.readVarint():o===1?l.name=a.readString():o===5?l.extent=a.readVarint():o===2?l._features.push(a.pos):o===3?l._keys.push(a.readString()):o===4&&l._values.push(function(h){for(var _=null,y=h.readVarint()+h.pos;h.pos<y;){var w=h.readVarint()>>3;_=w===1?h.readString():w===2?h.readFloat():w===3?h.readDouble():w===4?h.readVarint64():w===5?h.readVarint():w===6?h.readSVarint():w===7?h.readBoolean():null}return _}(a))}return xg=e,e.prototype.feature=function(o){if(o<0||o>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[o];var l=this._pbf.readVarint()+this._pbf.pos;return new n(this._pbf,l,this.extent,this._keys,this._values)},xg}function i0(){return Qv||(Qv=1,Yp.VectorTile=function(){if(Jv)return bg;Jv=1;var n=t0();function e(i,o,l){if(i===3){var a=new n(l,l.readVarint()+l.pos);a.length&&(o[a.name]=a)}}return bg=function(i,o){this.layers=i.readFields(e,{},o)},bg}(),Yp.VectorTileFeature=e0(),Yp.VectorTileLayer=t0()),Yp}var yl=i0();const Tc="3d_elevation_id",r0="level";class FT{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,o){return this.get(e,!0,i,o)}optional(e,i,o){return this.get(e,!1,i,o)}success(){return this._valid}get(e,i,o,l){const a=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&a!==void 0?o(l?l(a):a):i&&(this._valid=!1),this}}class n0{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,o){return this.featureFunc(e,i,o)}parseVertex(e,i,o){return this.vertexFunc(e,i,o)}}const BT=new n0((n,e,i)=>n.reset(e).require(Tc,o=>{i.id=o}).optional("fixed_height_relative",o=>{i.constantHeight=o},xa.decodeRelativeHeight).geometry(o=>{i.bounds=o},xa.computeBounds).success(),(n,e,i)=>n.reset(e).require(Tc,o=>{i.id=o}).require("elevation_idx",o=>{i.idx=o}).require("extent",o=>{i.extent=o}).require("height_relative",o=>{i.height=o},xa.decodeRelativeHeight).geometry(o=>{i.position=o},xa.getPoint).success()),NT=new n0((n,e,i)=>n.reset(e).require(Tc,o=>{i.id=o}).optional("fixed_height",o=>{i.constantHeight=o},xa.decodeMetricHeight).geometry(o=>{i.bounds=o},xa.computeBounds).success(),(n,e,i)=>n.reset(e).require(Tc,o=>{i.id=o}).require("elevation_idx",o=>{i.idx=o}).require("extent",o=>{i.extent=o}).require("height",o=>{i.height=o},xa.decodeMetricHeight).geometry(o=>{i.position=o},xa.getPoint).success());class xa{static computeBounds(e){const i=new we(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),o=new we(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const l of e[0])i.x>l.x&&(i.x=l.x),i.y>l.y&&(i.y=l.y),o.x<l.x&&(o.x=l.x),o.y<l.y&&(o.y=l.y);return{min:i,max:o}}static getPoint(e){return J.vec2.fromValues(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){const i=[],o=[],l=e.length,a=new FT;for(let _=0;_<l;_++){const y=e.feature(_),w=y.properties.hasOwnProperty("version")?String(y.properties.version):void 0,p=(h=w)?h==="1.0.1"?NT:void 0:BT;if(p===void 0){br(`Unknown elevation feature version number ${w||"(unknown)"}`);continue}const x=y.properties.hasOwnProperty("type")?y.properties.type:void 0;if(x){if(yl.VectorTileFeature.types[y.type]==="Point"&&x==="curve_point"){const S={};p.parseVertex(a,y,S)&&i.push(S)}else if(yl.VectorTileFeature.types[y.type]==="Polygon"&&x==="curve_meta"){const S={};p.parseFeature(a,y,S)&&o.push(S)}}}var h;return{vertices:i,features:o}}}class wg{constructor(e,i,o,l,a,h){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:o,max:o},this.safeArea=i,this.constantHeight=o,this.constantHeight==null&&(this.constantHeight!=null||l.length!==0)){this.vertices=l,this.edges=a,this.edges=this.edges.filter(_=>_.a<this.vertices.length&&_.b<this.vertices.length&&!J.vec2.exactEquals(this.vertices[_.a].position,this.vertices[_.b].position)),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const _ of this.vertices)this.vertexProps.push({dir:J.vec2.fromValues(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,_.height),this.heightRange.max=Math.max(this.heightRange.max,_.height);for(const _ of this.edges){const y=this.vertices[_.a].position,w=this.vertices[_.b].position,p=J.vec2.subtract(J.vec2.create(),w,y),x=J.vec2.length(p),S=J.vec2.scale(J.vec2.create(),p,1/x);this.edgeProps.push({vec:p,dir:S,len:x});const b=this.vertexProps[_.a].dir,T=this.vertexProps[_.b].dir;J.vec2.add(b,b,S),J.vec2.add(T,T,S)}for(const _ of this.vertexProps)_.dir[0]===0&&_.dir[1]===0||J.vec2.normalize(_.dir,_.dir);this.tessellate(h)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;const i=this.getClosestEdge(e);if(i==null)return 0;const[o,l]=i;return((a,h,_)=>(1-_)*a+_*h)(this.vertices[this.edges[o].a].height,this.vertices[this.edges[o].b].height,l)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,o=Number.POSITIVE_INFINITY,l=0;const a=J.vec2.fromValues(e.x,e.y);for(let h=0;h<this.edges.length;h++){const _=this.edges[h],y=this.edgeProps[h].dir,w=new ii(a,this.edgeProps[h].dir),p=this.vertices[_.a].position,x=this.vertices[_.b].position,S=J.vec2.create(),b=J.vec2.create(),T=w.intersectsPlane(p,this.vertexProps[_.a].dir,S),M=w.intersectsPlane(x,this.vertexProps[_.b].dir,b);if(!T||!M)continue;const D=J.vec2.subtract(J.vec2.create(),b,S),z=J.vec2.subtract(J.vec2.create(),a,S),N=J.vec2.dot(D,D),B=N>0?J.vec2.dot(z,D)/N:0,F=Dt(B,0,1),U=Math.abs((B-F)*this.edgeProps[h].len),q=J.vec2.subtract(J.vec2.create(),a,p),Z=U+Math.abs(J.vec2.dot(q,J.vec2.fromValues(y[1],-y[0])));Z<o&&(i=h,o=Z,l=F)}return[i,l]}tessellate(e){for(let i=this.edges.length-1;i>=0;--i){const o=this.edges[i].a,l=this.edges[i].b,{position:a,height:h,extent:_}=this.vertices[o],{position:y,height:w,extent:p}=this.vertices[l],x=this.vertexProps[o].dir,S=this.vertexProps[l].dir,b=J.vec3.fromValues(a[0]/e,a[1]/e,h),T=J.vec3.fromValues(y[0]/e,y[1]/e,w),M=J.vec3.fromValues(x[1],-x[0],0);J.vec3.scale(M,M,_);const D=J.vec3.fromValues(S[1],-S[0],0);if(J.vec3.scale(D,D,p),this.distSqLines(J.vec3.fromValues(b[0]+.5*M[0],b[1]+.5*M[1],b[2]+.5*M[2]),J.vec3.fromValues(T[0]-.5*D[0],T[1]-.5*D[1],T[2]-.5*D[2]),J.vec3.fromValues(b[0]-.5*M[0],b[1]-.5*M[1],b[2]-.5*M[2]),J.vec3.fromValues(T[0]+.5*D[0],T[1]+.5*D[1],T[2]+.5*D[2]))<=.05*.05)continue;const z=this.vertices.length,N=J.vec2.add(J.vec2.create(),a,y);this.vertices.push({position:J.vec2.scale(N,N,.5),height:.5*(h+w),extent:.5*(_+p)});const B=J.vec2.add(J.vec2.create(),x,S);this.vertexProps.push({dir:J.vec2.normalize(B,B)}),this.edges.splice(i,1),this.edgeProps.splice(i,1),this.edges.push({a:o,b:z}),this.edges.push({a:z,b:l});const F=J.vec2.subtract(J.vec2.create(),this.vertices[z].position,a),U=J.vec2.length(F),q={vec:F,dir:J.vec2.scale(J.vec2.create(),F,1/U),len:U};this.edgeProps.push(q),this.edgeProps.push(q)}}distSqLines(e,i,o,l){const a=J.vec3.subtract(J.vec3.create(),i,e),h=J.vec3.subtract(J.vec3.create(),l,o),_=J.vec3.subtract(J.vec3.create(),e,o),y=J.vec3.dot(a,a),w=J.vec3.dot(a,h),p=J.vec3.dot(a,_),x=J.vec3.dot(h,h),S=J.vec3.dot(h,_),b=y*x-w*w;if(b===0){const N=J.vec3.dot(_,h)/J.vec3.dot(h,h),B=J.vec3.lerp(J.vec3.create(),o,l,N);return J.vec3.squaredDistance(B,e)}const T=(w*S-p*x)/b,M=(y*S-w*p)/b,D=J.vec3.lerp(J.vec3.create(),e,i,T),z=J.vec3.lerp(J.vec3.create(),o,l,M);return J.vec3.squaredDistance(D,z)}}class VT{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*ht,this.yOffset=(e.y*this.zScale-i.y)*ht)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,o){const l=this.constantElevation(i,o);return l??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),o))}computeBiasedHeight(e,i){return i<=0?e:e+i*yi(0,i,e>=0?e:Math.abs(.5*e))}}It(wg,"ElevationFeature");class s0{constructor(){this.polygons=new Map}add(e,...i){this.polygons.has(e)?this.polygons.get(e).push(...i):this.polygons.set(e,i)}merge(e){for(const[i,o]of e.polygons)this.add(i,...o)}}class Sc{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new Sc;let i=[];for(const w of e)i.push(...w.portals);if(i.length===0)return new Sc;const o=(w,p)=>w<=0&&p<=0||w>=ht&&p>=ht;for(const w of i){const p=w.va,x=w.vb;(o(p.x,x.x)||o(p.y,x.y))&&(w.type="border")}const l=i.filter(w=>w.type!=="unevaluated"),a=i.filter(w=>w.type==="unevaluated");if(a.length===0)return new Sc;a.sort((w,p)=>w.hash===p.hash?w.isTunnel===p.isTunnel?0:w.isTunnel?-1:1:w.hash<p.hash?1:-1),i=l.concat(a);let h=l.length,_=h,y=h;do if(_++,_===i.length||i[h].hash!==i[_].hash){if(_-h==2){y<h&&(i[y]=i[h],i[h]=null);const w=i[y],p=i[_-1];w.type=w.isTunnel!==p.isTunnel?"tunnel":"polygon",w.connection={a:w.connection.a,b:p.connection.a},y++}h=_}while(h!==i.length);return i.splice(y),i.sort((w,p)=>w.hash<p.hash?1:-1),{portals:i}}}It(Sc,"ElevationPortalGraph"),It(s0,"ElevationPolygons");class UT{constructor(e,i,o){this.outPositions=e,this.outNormals=i,this.outIndices=o,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,i,o){let l=e[2];o!=null&&(l*=o);const a=this.getVec3Bits(e)<<96n|this.getVec3Bits(i),h=this.vertexLookup.get(a);if(h!=null)return h;const _=this.outPositions.length;this.vertexLookup.set(a,_);const y=Math.trunc(16384*i[0]),w=Math.trunc(16384*i[1]),p=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],l),this.outNormals.emplaceBack(y,w,p),_}addVertices(e,i,...o){const l=[];for(const a of o){const h=this.addVertex(a,e,i);l.push(h)}return l}addTriangles(e,i,o){if(i&&o){const l=o.length===1,a=J.vec3.fromValues(0,0,0);for(let h=0;h<e.length;h+=3){const _=i[e[h+0]],y=i[e[h+1]],w=i[e[h+2]],p=l?o[0]:o[e[h+1]],x=l?o[0]:o[e[h+2]],S=this.addVertex(J.vec3.fromValues(_.x,_.y,l?o[0]:o[e[h+0]]),a),b=this.addVertex(J.vec3.fromValues(y.x,y.y,p),a),T=this.addVertex(J.vec3.fromValues(w.x,w.y,x),a);this.outIndices.emplaceBack(S,b,T)}}else for(let l=0;l<e.length;l+=3)this.outIndices.emplaceBack(e[l+0],e[l+1],e[l+2])}addQuad(e,i){const o=this.addVertices(i,void 0,...e.map(y=>J.vec3.fromValues(y.coord.x,y.coord.y,y.height))),[l,a,h,_]=o;this.addTriangles([l,a,h,h,_,l])}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class To{constructor(e){this.unevaluatedPortals=new Sc,this.portalPolygons=new s0,this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new cc,this.vertexNormals=new vd,this.indexArray=new dn,this.tileToMeters=u(e)}addVertices(e,i){const o=this.unevalVertices.length;for(let l=0;l<e.length;l++)this.unevalVertices.push(e[l]),this.unevalHeights.push(i[l]);return o}addTriangles(e,i,o){const l=o?this.unevalTunnelTriangles:this.unevalTriangles;for(const a of e)l.push(a+i)}addRenderableRing(e,i,o,l,a){const h=[new we(a.min.x,a.min.y),new we(a.max.x,a.min.y),new we(a.max.x,a.max.y),new we(a.min.x,a.max.y)];for(let _=0;_<o-1;_++){const y=i+_,w=y+1,p=this.unevalVertices[y],x=this.unevalVertices[w];if(!(p.x>=a.min.x&&p.x<=a.max.x&&p.y>=a.min.y&&p.y<=a.max.y||x.x>=a.min.x&&x.x<=a.max.x&&x.y>=a.min.y&&x.y<=a.max.y||_e(p,x,h))||this.isOnBorder(p.x,x.x)||this.isOnBorder(p.y,x.y))continue;const S=To.computeEdgeHash(this.unevalVertices[y],this.unevalVertices[w]);let b,T=this.vertexHashLookup.get(To.computePosHash(p));T!=null?b=T.next:(T=this.vertexHashLookup.get(To.computePosHash(x)),b=T!=null?T.prev:S),this.unevalEdges.push({polygonIdx:e,a:y,b:w,hash:S,portalHash:b,isTunnel:l,type:"unevaluated"})}}addPortalCandidates(e,i,o,l,a){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:a});const h=i[0];this.vertexHashLookup.clear();let _=To.computeEdgeHash(h[h.length-2],h[h.length-1]);for(let y=0;y<h.length-1;y++){const w=h[y+0],p=h[y+1],x=J.vec2.fromValues(p.x-w.x,p.y-w.y),S=J.vec2.length(x);if(S===0)continue;let b="unevaluated";const T=l.pointElevation(w),M=l.pointElevation(p);Math.abs(T)<.01&&Math.abs(M)<.01?b="entrance":(this.isOnBorder(w.x,p.x)||this.isOnBorder(w.y,p.y))&&(b="border");const D=To.computeEdgeHash(w,p);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:w,vb:p,vab:x,length:S,hash:D,isTunnel:o,type:b});const z=To.computePosHash(w);this.vertexHashLookup.set(z,{prev:_,next:D}),_=D}}construct(e){if(this.unevalVertices.length===0)return;const i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),o=x=>{x.primitiveLength=this.indexArray.length-x.primitiveOffset},l=new UT(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const a=i(),h=i(),_=i(),y=(x,S)=>{x.sort((T,M)=>T.type===S&&M.type!==S?-1:T.type!==S&&M.type===S?1:0);const b=x.findIndex(T=>T.type!==S);return b>=0?b:x.length};let w=0;this.unevalEdges.length>0&&(w=y(this.unevalEdges,"none"),this.constructBridgeStructures(l,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:w},this.tileToMeters));const p=i();if(this.unevalEdges.length>0){const x=this.unevalEdges.splice(w),S=y(x,"tunnel")+w;this.unevalEdges.push(...x),this.constructTunnelStructures(l,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:w},{min:w,max:S})}o(_),l.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),o(p),l.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),o(h),l.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),o(a),this.maskSegments=Tr.simpleSegment(0,p.primitiveOffset,0,p.primitiveLength),this.depthSegments=Tr.simpleSegment(0,h.primitiveOffset,0,h.primitiveLength),this.renderableSegments=Tr.simpleSegment(0,_.primitiveOffset,0,_.primitiveLength),this.shadowCasterSegments=Tr.simpleSegment(0,a.primitiveOffset,0,a.primitiveLength)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,ET.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,MT.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableSegments.destroy(),this.shadowCasterSegments.destroy())}computeVertexConnections(e,i,o,l){const a=new Map;for(let h=o;h<l;h++){const _=i[h],y=_.a,w=_.b;a.has(y)||a.set(y,{}),a.has(w)||a.set(w,{});const p=a.get(y),x=a.get(w);e[w]>0&&(p.to=w),e[y]>0&&(x.from=y)}return a}constructBridgeStructures(e,i,o,l,a,h){const _=this.computeVertexConnections(o,l,a.min,a.max),y=1/h,w=.5*y,p=S=>J.vec3.fromValues(i[S].x,i[S].y,o[S]*y),x=S=>{const b=_.get(S),T=b.from,M=b.to;if(!T||!M)return;const D=p(T),z=p(S),N=p(M),B=J.vec3.fromValues(0,0,0);if(!J.vec3.exactEquals(D,z)){const U=J.vec3.sub(J.vec3.create(),z,D);J.vec3.add(B,B,J.vec3.normalize(U,U))}if(!J.vec3.exactEquals(N,z)){const U=J.vec3.sub(J.vec3.create(),N,z);J.vec3.add(B,B,J.vec3.normalize(U,U))}const F=J.vec3.len(B);return F>0?J.vec3.scale(B,B,1/F):void 0};for(let S=a.min;S<a.max;S++){const b=l[S],T=this.prepareEdgePoints(i,o,b,(nt,Ht)=>nt>=Ht);if(T==null)continue;const M=T[0],D=T[1],z=J.vec3.fromValues(M.coord.x,M.coord.y,y*M.height),N=J.vec3.fromValues(D.coord.x,D.coord.y,y*D.height);if(J.vec3.exactEquals(z,N))continue;const B=J.vec3.sub(J.vec3.create(),N,z);J.vec3.normalize(B,B);const F=nt=>J.vec3.normalize(nt,nt),U=x(b.a)||B,q=x(b.b)||B,Z=F(J.vec3.fromValues(U[1],-U[0],0)),re=F(J.vec3.fromValues(q[1],-q[0],0)),ee=F(J.vec3.cross(J.vec3.create(),Z,U)),te=F(J.vec3.cross(J.vec3.create(),re,q)),pe=J.vec3.create(),ne=[J.vec3.add(J.vec3.create(),z,J.vec3.scale(pe,J.vec3.sub(pe,Z,ee),w)),J.vec3.add(J.vec3.create(),z,J.vec3.scale(pe,J.vec3.add(pe,Z,ee),w)),J.vec3.add(J.vec3.create(),z,J.vec3.scale(pe,ee,w)),z],me=[J.vec3.add(J.vec3.create(),N,J.vec3.scale(pe,J.vec3.sub(pe,re,te),w)),J.vec3.add(J.vec3.create(),N,J.vec3.scale(pe,J.vec3.add(pe,re,te),w)),J.vec3.add(J.vec3.create(),N,J.vec3.scale(pe,te,w)),N],[be,ve]=e.addVertices(Z,h,ne[0],ne[1]),[Me,Ee]=e.addVertices(re,h,me[0],me[1]);e.addTriangles([be,ve,Me,ve,Ee,Me]);const[Oe,Ce]=e.addVertices(ee,h,ne[1],ne[2]),[ke,rt]=e.addVertices(te,h,me[1],me[2]);e.addTriangles([Oe,Ce,ke,Ce,rt,ke]);const[tt,Ct]=e.addVertices(J.vec3.negate(Z,Z),h,ne[2],ne[3]),[ot,ut]=e.addVertices(J.vec3.negate(re,re),h,me[2],me[3]);e.addTriangles([tt,Ct,ot,Ct,ut,ot])}}constructTunnelStructures(e,i,o,l,a,h){const _=y=>J.vec3.normalize(y,y);for(let y=a.min;y<a.max;y++){const w=this.prepareEdgePoints(i,o,l[y],(b,T)=>b<=T);if(w==null)continue;const[p,x]=w,S=_(J.vec3.fromValues(x.coord.y-p.coord.y,-(x.coord.x-p.coord.x),0));e.addQuad([p,x,{coord:x.coord,height:l[y].isTunnel?-.1:0},{coord:p.coord,height:l[y].isTunnel?-.1:0}],S)}for(let y=h.min;y<h.max;y++){const w=l[y],p=i[w.a],x=i[w.b],S=_(J.vec3.fromValues(x.y-p.y,-(x.x-p.x),0));e.addQuad([{coord:x,height:0},{coord:p,height:0},{coord:p,height:o[w.a]+4},{coord:x,height:o[w.b]+4}],S),e.addQuad([{coord:p,height:0},{coord:x,height:0},{coord:x,height:o[w.b]+4},{coord:p,height:o[w.a]+4}],S)}}prepareEdgePoints(e,i,o,l){const a=e[o.a],h=e[o.b];let _=i[o.a],y=i[o.b];if(!(_!==0&&l(_,0)||y!==0&&l(y,0)))return;const w=a.clone(),p=h.clone();if(l(_,0)){if(!l(y,0)){const x=y/(y-_);p.x=Xt(p.x,w.x,x),p.y=Xt(p.y,w.y,x),y=Xt(y,_,x)}}else{const x=_/(_-y);w.x=Xt(w.x,p.x,x),w.y=Xt(w.y,p.y,x),_=Xt(_,y,x)}return[{coord:w,height:_},{coord:p,height:y}]}prepareEdges(e,i){if(i.length===0)return;i.sort((_,y)=>_.hash===y.hash?y.polygonIdx-_.polygonIdx:y.hash>_.hash?1:-1);let o=0,l=0,a=0,h=i[o].polygonIdx;do l++,(l===i.length||i[o].hash!==i[l].hash)&&((l-o==1||i[l-1].polygonIdx!==h)&&(a<o&&(i[a]=i[o],i[o]=null),i[a].type="none",a++),o=l,o!==i.length&&(h=i[o].polygonIdx));while(o!==i.length);if(i.splice(a),i.length!==0&&e.length!==0){i.sort((w,p)=>w.hash<p.hash?1:-1);let _=0,y=0;for(;_!==i.length&&y!==e.length;){const w=i[_],p=e[y];w.portalHash>p.hash?_++:p.hash>w.portalHash?y++:(w.type=p.type,_++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=ht&&i>=ht}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(To.computePosHash(e))<<32n|BigInt(To.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}class Tg{constructor(e,i){this.layoutVertexArray=new yo,this.indexArray=new dn,this.lineIndexArray=new Go,this.triangleSegments=new Tr,this.lineSegments=new Tr,this.programConfigurations=new $o(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new pa)}update(e,i,o,l,a,h,_){this.programConfigurations.updatePaintArrays(e,i,a,o,l,h,_)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,TT.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,ST.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,o,l,a,h){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,o,l,a,h)}}class Sg{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.bufferData=new Tg(e,!1),this.elevationBufferData=new Tg(e,!0),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference")}updateFootprints(e,i){}populate(e,i,o,l){this.hasPattern=gg("fill",this.layers,this.pixelRatio,i);const a=this.layers[0].layout.get("fill-sort-key"),h=[];for(const{feature:_,id:y,index:w,sourceLayerIndex:p}of e){const x=this.layers[0]._featureFilter.needGeometry,S=R(_,x);if(!this.layers[0]._featureFilter.filter(new ur(this.zoom),S,o))continue;const b=a?a.evaluate(S,{},o,i.availableImages):void 0,T={id:y,properties:_.properties,type:_.type,sourceLayerIndex:p,index:w,geometry:x?S.geometry:C(_,o,l),patterns:{},sortKey:b};h.push(T)}a&&h.sort((_,y)=>_.sortKey-y.sortKey);for(const _ of h){const{geometry:y,index:w,sourceLayerIndex:p}=_;if(this.hasPattern){const x=yg("fill",this.layers,_,this.zoom,this.pixelRatio,i);this.patternFeatures.push(x)}else this.addFeature(_,y,w,o,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[w].feature,y,w,p,this.index)}}update(e,i,o,l,a,h,_){this.bufferData.update(e,i,o,l,a,h,_),this.elevationBufferData.update(e,i,o,l,a,h,_)}addFeatures(e,i,o,l,a,h){for(const _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,i,o,l,h,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,o,l,a,h=[],_,y){const w=Kp(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,w,l,o,y):this.addGeometry(w,this.bufferData),this.bufferData.populatePaintArrays(e,o,a,h,l,_),this.elevationBufferData.populatePaintArrays(e,o,a,h,l,_)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e){this.elevatedStructures&&this.elevatedStructures.construct(e)}addElevatedRoadFeature(e,i,o,l,a){const h=new Array,_=this.getElevationFeature(e,a);if(_){h.push({polygons:i,elevationFeature:_,elevationTileID:o});for(const y of h)if(y.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new To(y.elevationTileID));const p=y.elevationFeature.isTunnel();let x=0;e.properties.hasOwnProperty(r0)&&(x=+e.properties[r0]);for(const S of y.polygons)this.elevatedStructures.addPortalCandidates(y.elevationFeature.id,S,p,y.elevationFeature,x)}const w=new VT(o,y.elevationTileID);this.addElevatedGeometry(y.polygons,w,y.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,l)}}else this.addGeometry(i,this.bufferData)}addElevatedGeometry(e,i,o,l,a){const h={elevation:o,elevationSampler:i,bias:l,index:a},[_,y]=this.addGeometry(e,this.elevationBufferData,h);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:_,max:y}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,_),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,y))}addGeometry(e,i,o){let l=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,h=null;o&&(h=o.elevationSampler.constantElevation(o.elevation,o.bias),h!=null&&(l=h,a=h));const _=(y,w,p)=>{if(o!=null)if(w.push(y),h!=null)i.elevatedLayoutVertexArray.emplaceBack(h),p.push(h);else{const x=o.elevationSampler.pointElevation(y,o.elevation,o.bias);i.elevatedLayoutVertexArray.emplaceBack(x),p.push(x),l=Math.min(l,x),a=Math.max(a,x)}};for(const y of e){let w=0;for(const B of y)w+=B.length;const p=i.triangleSegments.prepareSegment(w,i.layoutVertexArray,i.indexArray),x=p.vertexLength,S=[],b=[],T=[],M=[],D=[],z=i.layoutVertexArray.length;for(const B of y){if(B.length===0)continue;B!==y[0]&&b.push(S.length/2);const F=i.lineSegments.prepareSegment(B.length,i.layoutVertexArray,i.lineIndexArray),U=F.vertexLength;o&&D.push(i.layoutVertexArray.length-z),_(B[0],T,M),i.layoutVertexArray.emplaceBack(B[0].x,B[0].y),i.lineIndexArray.emplaceBack(U+B.length-1,U),S.push(B[0].x),S.push(B[0].y);for(let q=1;q<B.length;q++)_(B[q],T,M),i.layoutVertexArray.emplaceBack(B[q].x,B[q].y),i.lineIndexArray.emplaceBack(U+q-1,U+q),S.push(B[q].x),S.push(B[q].y);F.vertexLength+=B.length,F.primitiveLength+=B.length}const N=Ud(S,b);for(let B=0;B<N.length;B+=3)i.indexArray.emplaceBack(x+N[B],x+N[B+1],x+N[B+2]);if(o&&this.elevationMode==="hd-road-base"){const B=o.elevation.isTunnel(),F=o.elevation.safeArea,U=this.elevatedStructures.addVertices(T,M);this.elevatedStructures.addTriangles(N,U,B);const q=D.length;if(q>0){for(let Z=0;Z<q-1;Z++)this.elevatedStructures.addRenderableRing(o.index,D[Z]+U,D[Z+1]-D[Z],B,F);this.elevatedStructures.addRenderableRing(o.index,D[q-1]+U,T.length-D[q-1],B,F)}}p.vertexLength+=w,p.primitiveLength+=N.length/3}return[l,a]}getElevationFeature(e,i){if(!i)return;const o=+e.properties[Tc];return o!=null?i.find(l=>l.id===o):void 0}}let o0,a0,l0,c0;It(Sg,"FillBucket",{omit:["layers","patternFeatures"]}),It(Tg,"FillBufferData"),It(To,"ElevatedStructures");class Eg{constructor(e,i,o,l){if(this.triangleCount=i.length/3,this.min=new we(0,0),this.max=new we(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[a,h]=[e[0].clone(),e[0].clone()];for(let x=1;x<e.length;++x){const S=e[x];a.x=Math.min(a.x,S.x),a.y=Math.min(a.y,S.y),h.x=Math.max(h.x,S.x),h.y=Math.max(h.y,S.y)}if(l){const x=Math.ceil(Math.max(h.x-a.x,h.y-a.y)/l);o=Math.max(o,x)}if(o===0)return;this.min=a,this.max=h;const _=this.max.sub(this.min);_.x=Math.max(_.x,1),_.y=Math.max(_.y,1);const y=Math.max(_.x,_.y)/o;this.cellsX=Math.max(1,Math.ceil(_.x/y)),this.cellsY=Math.max(1,Math.ceil(_.y/y)),this.xScale=1/y,this.yScale=1/y;const w=[];for(let x=0;x<this.triangleCount;x++){const S=e[i[3*x+0]].sub(this.min),b=e[i[3*x+1]].sub(this.min),T=e[i[3*x+2]].sub(this.min),M=Wo(Math.floor(Math.min(S.x,b.x,T.x)),this.xScale,this.cellsX),D=Wo(Math.floor(Math.max(S.x,b.x,T.x)),this.xScale,this.cellsX),z=Wo(Math.floor(Math.min(S.y,b.y,T.y)),this.yScale,this.cellsY),N=Wo(Math.floor(Math.max(S.y,b.y,T.y)),this.yScale,this.cellsY),B=new we(0,0),F=new we(0,0),U=new we(0,0),q=new we(0,0);for(let Z=z;Z<=N;++Z){B.y=F.y=Z*y,U.y=q.y=(Z+1)*y;for(let re=M;re<=D;++re)B.x=U.x=re*y,F.x=q.x=(re+1)*y,(Ue(S,b,T,B,F,q)||Ue(S,b,T,B,q,U))&&w.push({cellIdx:Z*this.cellsX+re,triIdx:x})}}if(w.length===0)return;w.sort((x,S)=>x.cellIdx-S.cellIdx||x.triIdx-S.triIdx);let p=0;for(;p<w.length;){const x=w[p].cellIdx,S={start:this.payload.length,len:0};for(;p<w.length&&w[p].cellIdx===x;)++S.len,this.payload.push(w[p++].triIdx);this.cells[x]=S}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const o=Wo(e.x-this.min.x,this.xScale,this.cellsX),l=Wo(e.y-this.min.y,this.yScale,this.cellsY),a=this.cells[l*this.cellsX+o];if(a){this._lazyInitLookup();for(let h=0;h<a.len;h++){const _=this.payload[a.start+h],y=Math.floor(_/8),w=1<<_%8;if(!(this.lookup[y]&w)&&(this.lookup[y]|=w,i.push(_),i.length===this.triangleCount))return}}}query(e,i,o){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const l=Wo(e.x-this.min.x,this.xScale,this.cellsX),a=Wo(i.x-this.min.x,this.xScale,this.cellsX),h=Wo(e.y-this.min.y,this.yScale,this.cellsY),_=Wo(i.y-this.min.y,this.yScale,this.cellsY);for(let y=h;y<=_;y++)for(let w=l;w<=a;w++){const p=this.cells[y*this.cellsX+w];if(p)for(let x=0;x<p.len;x++){const S=this.payload[p.start+x],b=Math.floor(S/8),T=1<<S%8;if(!(this.lookup[b]&T)&&(this.lookup[b]|=T,o.push(S),o.length===this.triangleCount))return}}}}function Wo(n,e,i){return Math.max(0,Math.min(i-1,Math.floor(n*e)))}It(Eg,"TriangleGridIndex");class u0{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[]}updateFootprints(e,i){for(const o of this.footprints)i.push({footprint:o,id:e})}populate(e,i,o,l){const a=[];for(const{feature:h,id:_,index:y,sourceLayerIndex:w}of e){const p=this.layers[0]._featureFilter.needGeometry,x=R(h,p);if(!this.layers[0]._featureFilter.filter(new ur(this.zoom),x,o))continue;const S={id:_,properties:h.properties,type:h.type,sourceLayerIndex:w,index:y,geometry:p?x.geometry:C(h,o,l),patterns:{}};a.push(S)}for(const h of a){const{geometry:_,index:y,sourceLayerIndex:w}=h;this.addFeature(h,_,y,o,{},i.availableImages,i.brightness),i.featureIndex.insert(e[y].feature,_,y,w,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,o,l,a,h,_){}destroy(){}addFeature(e,i,o,l,a,h=[],_){for(const y of Kp(i,2)){const w=[],p=[],x=[],S=new we(1/0,1/0),b=new we(-1/0,-1/0);for(const D of y)if(D.length!==0){D!==y[0]&&x.push(p.length/2);for(let z=0;z<D.length;z++)p.push(D[z].x),p.push(D[z].y),w.push(D[z]),S.x=Math.min(S.x,D[z].x),S.y=Math.min(S.y,D[z].y),b.x=Math.max(b.x,D[z].x),b.y=Math.max(b.y,D[z].y)}const T=Ud(p,x),M=new Eg(w,T,8,256);this.footprints.push({vertices:w,indices:T,grid:M,min:S,max:b})}}}It(u0,"ClipBucket",{omit:["layers"]});const jT=Hi([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),GT=Hi([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),qT=Hi([{name:"a_centroid_pos",components:2,type:"Uint16"}]),$T=Hi([{name:"a_join_normal_inside",components:3,type:"Int16"}]),HT=Hi([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),ZT=Hi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:WT}=jT;class Ec extends we{constructor(e,i,o){super(e,i),this.z=o}}class h0 extends Ec{constructor(e,i,o,l){super(e,i,o),this.w=l}}function Jp(n,e,i,o){const l=[],a=o===0?(h,_,y,w,p,x)=>{h.push(new we(x,y+(x-_)/(w-_)*(p-y)))}:(h,_,y,w,p,x)=>{h.push(new we(_+(x-y)/(p-y)*(w-_),x))};for(const h of n){const _=[];for(const y of h){if(y.length<=2)continue;const w=[];for(let S=0;S<y.length-1;S++){const b=y[S].x,T=y[S].y,M=y[S+1].x,D=y[S+1].y,z=o===0?b:T,N=o===0?M:D;z<e?N>e&&a(w,b,T,M,D,e):z>i?N<i&&a(w,b,T,M,D,i):w.push(y[S]),N<e&&z>=e&&a(w,b,T,M,D,e),N>i&&z<=i&&a(w,b,T,M,D,i)}let p=y[y.length-1];const x=o===0?p.x:p.y;x>=e&&x<=i&&w.push(p),w.length&&(p=w[w.length-1],w[0].x===p.x&&w[0].y===p.y||w.push(w[0]),_.push(w))}_.length&&l.push(_)}return l}function d0(n,e,i,o){const l=i==="x"?"y":"x",a=(o-n[i])/(e[i]-n[i]);n[l]=n[l]+(e[l]-n[l])*a,n[i]=o,n.hasOwnProperty("z")&&(n.z=Xt(n.z,e.z,a)),n.hasOwnProperty("w")&&(n.w=Xt(n.w,e.w,a))}function f0(n,e,i,o){const l=i,a=o;for(const h of["x","y"]){let _=n,y=e;_[h]>=y[h]&&(_=e,y=n),_[h]<l&&y[h]>l&&d0(_,y,h,l),_[h]<a&&y[h]>a&&d0(y,_,h,a)}}const Qp=Number.MAX_SAFE_INTEGER;function p0(n,e,i,o){return n.order<e||n.order===Qp||!(n.clipMask&i)||function(l,a){return a.length!==0&&a.find(h=>h===l)===void 0}(o,n.clipScope)}function em(n,e){return n.x-e.x||n.y-e.y}function m0(n,e){return em(n.min,e.min)===0&&em(n.max,e.max)===0}function Mg(n,e){return!(n.min.x>e.max.x||n.max.x<e.min.x||n.min.y>e.max.y||n.max.y<e.min.y)}function Ag(n,e){if(n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(n[i].sourceId!==e[i].sourceId||!m0(n[i],e[i])||n[i].order!==e[i].order||n[i].clipMask!==e[i].clipMask||!bt(n[i].clipScope,e[i].clipScope))return!1;return!0}function _0(n,e,i){const o=1/ht,l=1/(1<<i.canonical.z),a=(e.x*o+i.canonical.x)*l+i.wrap,h=(e.y*o+i.canonical.y)*l;return{min:new we((n.x*o+i.canonical.x)*l+i.wrap,(n.y*o+i.canonical.y)*l),max:new we(a,h)}}function XT(n,e,i){const o=1<<i.canonical.z,l=((e.x-i.wrap)*o-i.canonical.x)*ht,a=(e.y*o-i.canonical.y)*ht;return{min:new we(((n.x-i.wrap)*o-i.canonical.x)*ht,(n.y*o-i.canonical.y)*ht),max:new we(l,a)}}function g0(n,e,i,o,l,a,h){const _=n.indices,y=n.vertices,w=[];for(let p=o;p<o+l;p+=3){const x=e[i[p+0]+a],S=e[i[p+1]+a],b=e[i[p+2]+a],T=Math.min(x.x,S.x,b.x),M=Math.max(x.x,S.x,b.x),D=Math.min(x.y,S.y,b.y),z=Math.max(x.y,S.y,b.y);w.length=0,n.grid.query(new we(T,D),new we(M,z),w);for(let N=0;N<w.length;N++){const B=w[N];if(Ue(y[_[3*B+0]],y[_[3*B+1]],y[_[3*B+2]],x,S,b,h))return!0}}return!1}function y0(n,e,i,o){if(!n||!i)return!1;let l=n.vertices;if(!e.canonical.equals(o.canonical)||e.wrap!==o.wrap){if(i.vertices.length<n.vertices.length)return y0(i,o,n,e);const a=e.canonical,h=o.canonical,_=Math.pow(2,h.z-a.z);l=n.vertices.map(y=>new we((y.x+a.x*ht)*_-h.x*ht,(y.y+a.y*ht)*_-h.y*ht))}return g0(i,l,n.indices,0,n.indices.length,0,0)}function v0(n,e,i,o){const l=Math.pow(2,o.z-i.z);return new we((n+i.x*ht)*l-o.x*ht,(e+i.y*ht)*l-o.y*ht)}function x0(n,e){const i=[];e.grid.queryPoint(n,i);const o=e.indices,l=e.vertices;for(let a=0;a<i.length;a++){const h=i[a];if(ue([l[o[3*h+0]],l[o[3*h+1]],l[o[3*h+2]]],n))return!0}return!1}const Ig=[new we(0,0),new we(ht,0),new we(ht,ht),new we(0,ht)];function b0(n,e){const i=[];let o=[];if(!e||n.length<2)return[n];if(n.length===2)return _e(n[0],n[1],Ig)?[n]:[];for(let l=0;l<n.length+2;l++){const a=n[l%n.length],h=n[(l+1)%n.length],_=_e(l===0?n[n.length-1]:n[(l-1)%n.length],a,Ig),y=_e(a,h,Ig),w=_||y;w&&o.push(a),w&&y||o.length>0&&(o.length>1&&i.push(o),o=[])}return o.length>1&&i.push(o),i}const Cg=yl.VectorTileFeature.types,KT=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],YT=["fill-extrusion-flood-light-ground-radius"],JT=Math.pow(2,13),QT=Math.pow(2,15)-1,w0=new we(0,1),vl=2147483648;function $d(n,e,i,o,l,a,h,_){n.emplaceBack((e<<1)+h,(i<<1)+a,(Math.floor(o*JT)<<1)+l,Math.round(_))}function Hd(n,e,i){n.emplaceBack(e.x*ht,e.y*ht,i?1:0)}function tm(n,e,i,o,l,a){n.emplaceBack(e.x,e.y,(i.x<<1)+o,(i.y<<1)+l,a)}function Zd(n,e,i){n.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class T0{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class S0{constructor(){this.centroidXY=new we(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new we(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new we(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new we(this.max.x-this.min.x,this.max.y-this.min.y)}}class E0{constructor(){this.acc=new we(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,o){this.accCount++,this.acc._add(i);let l=!!this.borders;i.x<e.min.x?(e.min.x=i.x,l=!0):i.x>e.max.x&&(e.max.x=i.x,l=!0),i.y<e.min.y?(e.min.y=i.y,l=!0):i.y>e.max.y&&(e.max.y=i.y,l=!0),((i.x===0||i.x===ht)&&i.x===o.x)!=((i.y===0||i.y===ht)&&i.y===o.y)&&this.processBorderOverlap(i,o),l&&this.checkBorderIntersection(i,o)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Xt(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>ht!=e.x>ht&&this.addBorderIntersection(1,Xt(i.y,e.y,(ht-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Xt(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>ht!=e.y>ht&&this.addBorderIntersection(3,Xt(i.x,e.x,(ht-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const o=this.borders[e];i<o[0]&&(o[0]=i),i>o[1]&&(o[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const o=e.x===0?0:1;this.addBorderIntersection(o,i.y),this.addBorderIntersection(o,e.y)}else{const o=e.y===0?2:3;this.addBorderIntersection(o,i.x),this.addBorderIntersection(o,e.x)}}centroid(){return this.accCount===0?new we(0,0):new we(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function M0(n,e){const i=n.add(e)._unit(),o=Dt(n.x*i.x+n.y*i.y,-1,1);var l,a,h;return h=Math.acos(o),Math.min(4,Math.max(-4,Math.tan(h)))/4*QT*((l=n).x*(a=e).y-l.y*a.x<0?-1:1)}const eS=[n=>n.x<0,n=>n.x>ht,n=>n.y<0,n=>n.y>ht];function tS(n,e,i,o){const l=[4];if(o===0)return l;i._mult(o);const a=n.sub(i),h=e.sub(i),_=[n,e,a,h];for(let y=0;y<4;y++)for(const w of _)if(eS[y](w)){l.push(y);break}return l}class A0{constructor(e){this.vertexArray=new Ss,this.indexArray=new dn,this.programConfigurations=new $o(e.layers,{zoom:e.zoom,lut:e.lut},i=>YT.includes(i)),this._segments=new Tr,this.hiddenByLandmarkVertexArray=new Cd,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Tr}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,o,l=!1){const a=e.length;if(a>2){let h=Math.max(0,this._segments.get().length-1);const _=this._segments._prepareSegment(4*a,this.vertexArray.length,2*this._segmentToGroundQuads[h].length);let y;h!==this._segments.get().length-1&&(h++,this._segmentToGroundQuads[h]=[],this._segmentToRegionTriCounts[h]=[0,0,0,0,0]);{const w=e[0],p=e[1];y=M0(w.sub(e[a-1])._perp()._unit(),p.sub(w)._perp()._unit())}for(let w=0;w<a;w++){const p=w===a-1?0:w+1,x=e[w],S=e[p],b=e[p===a-1?0:p+1],T=S.sub(x)._perp()._unit(),M=M0(T,b.sub(S)._perp()._unit()),D=y,z=M;if(Pg(x,S,i)||l&&P0(x,i)&&P0(S,i)){y=M;continue}const N=_.vertexLength;tm(this.vertexArray,x,S,1,1,D),tm(this.vertexArray,x,S,1,0,D),tm(this.vertexArray,x,S,0,1,z),tm(this.vertexArray,x,S,0,0,z),_.vertexLength+=4;const B=tS(x,S,T,o);for(const F of B)this._segmentToGroundQuads[h].push({id:N,region:F}),this._segmentToRegionTriCounts[h][F]+=2,_.primitiveLength+=2;y=M}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let o=0;o<i;o++)this._segmentToGroundQuads[o].sort((l,a)=>l.region-a.region);for(let o=0;o<i;o++){const l=this._segmentToGroundQuads[o],a=e[o],h=this._segmentToRegionTriCounts[o];h.reduce((y,w)=>y+w,0);let _=0;for(let y=0;y<=4;y++){const w=h[y];if(w!==0){let p=this.regionSegments[y];p||(p=this.regionSegments[y]=new Tr);const x={vertexOffset:a.vertexOffset,primitiveOffset:a.primitiveOffset+_,vertexLength:a.vertexLength,primitiveLength:w};p.get().push(x)}_+=w}for(let y=0;y<l.length;y++){const w=l[y].id;this.indexArray.emplaceBack(w,w+1,w+3),this.indexArray.emplaceBack(w,w+3,w+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,o,l,a,h){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,o,l,a,h)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,GT.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,o,l,a,h,_){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,o,l,a,h,_)}updateHiddenByLandmark(e){if(!this.hasData())return;const i=e.groundVertexCount+e.groundVertexArrayOffset;if(e.groundVertexCount===0)return;const o=e.flags&vl?1:0;for(let l=e.groundVertexArrayOffset;l<i;++l)this.hiddenByLandmarkVertexArray.emplace(l,o);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,HT.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class im{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new dn,this.footprintVertices=new yo,this.footprintSegments=[],this.layoutVertexArray=new vo,this.centroidVertexArray=new mc,this.wallVertexArray=new Np,this.indexArray=new dn,this.programConfigurations=new $o(e.layers,{zoom:e.zoom,lut:e.lut},i=>KT.includes(i)),this.segments=new Tr,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new A0(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(e,i){}populate(e,i,o,l){this.features=[],this.hasPattern=gg("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=u(o),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:a,id:h,index:_,sourceLayerIndex:y}of e){const w=this.layers[0]._featureFilter.needGeometry,p=R(a,w);if(!this.layers[0]._featureFilter.filter(new ur(this.zoom),p,o))continue;const x={id:h,sourceLayerIndex:y,index:_,geometry:w?p.geometry:C(a,o,l),properties:a.properties,type:a.type,patterns:{}},S=this.layoutVertexArray.length,b=Cg[x.type]==="Polygon";if(this.hasPattern)this.features.push(yg("fill-extrusion",this.layers,x,this.zoom,this.pixelRatio,i));else if(this.wallMode)for(const T of x.geometry)for(const M of b0(T,b))this.addFeature(x,[M],_,o,{},i.availableImages,l,i.brightness);else this.addFeature(x,x.geometry,_,o,{},i.availableImages,l,i.brightness);i.featureIndex.insert(a,x.geometry,_,y,this.index,S)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,o,l,a,h){for(const _ of this.features){const y=Cg[_.type]==="Polygon",{geometry:w}=_;if(this.wallMode)for(const p of w)for(const x of b0(p,y))this.addFeature(_,[x],_.index,i,o,l,a,h);else this.addFeature(_,w,_.index,i,o,l,a,h)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,o,l,a,h,_){this.programConfigurations.updatePaintArrays(e,i,a,o,l,h,_),this.groundEffect.update(e,i,a,o,l,h,_)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,WT),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,$T.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,ZT.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,qT.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,o,l,a,h,_,y){const w=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,p=[new we(0,0),new we(ht,ht)],x=_.projection,S=x.name==="globe",b=this.wallMode||Cg[e.type]==="Polygon",T=new E0;T.centroidDataIndex=this.centroidData.length;const M=new S0,D=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},l)<=0,z=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},l);let N;if(M.height=z,M.vertexArrayOffset=this.layoutVertexArray.length,M.groundVertexArrayOffset=this.groundEffect.vertexArray.length,S&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Pu),this.wallMode){if(S)return void br("Non zero fill-extrusion-line-width is not yet supported on globe.");if(i.length!==1)return;N=function(te){const pe=te[0].x===te[te.length-1].x&&te[0].y===te[te.length-1].y;(function(ut){let nt=0;const Ht=ut.length;for(let Et=0;Et<Ht;Et++)nt+=(ut[(Et+1)%Ht].x-ut[Et].x)*(ut[(Et+1)%Ht].y+ut[Et].y);return nt>=0})(te)||(te=te.reverse());const me={geometry:[],joinNormals:[],indices:[]},be=[],ve=[],Me=[];let Ee=te.length;for(;Ee>=2&&te[Ee-1].equals(te[Ee-2]);)Ee--;if(Ee<(pe?3:2))return me;let Oe,Ce,ke,rt,tt,Ct=0;for(;Ct<Ee-1&&te[Ct].equals(te[Ct+1]);)Ct++;pe&&(Oe=te[Ee-2],tt=te[Ct].sub(Oe)._unit()._perp());for(let ut=Ct;ut<Ee;ut++){if(ke=ut===Ee-1?pe?te[Ct+1]:void 0:te[ut+1],ke&&te[ut].equals(ke))continue;tt&&(rt=tt),Oe&&(Ce=Oe),Oe=te[ut],tt=ke?ke.sub(Oe)._unit()._perp():rt,rt=rt||tt;let nt=rt.add(tt);nt.x===0&&nt.y===0||nt._unit();const Ht=nt.x*tt.x+nt.y*tt.y,Et=Ht!==0?1/Ht:1/0,Lt=rt.x*tt.y-rt.y*tt.x>0;let ei="miter";const _i=2;ei==="miter"&&Et>_i&&(ei="bevel"),ei==="bevel"&&(Et>100&&(ei="flipbevel"),Et<_i&&(ei="miter"));const ri=(Ei,mi,Ai,Ni)=>{const hr=new we(Ei.x,Ei.y),ti=new we(Ei.x,Ei.y);hr.x+=mi.x*Ni,hr.y+=mi.y*Ni,ti.x-=mi.x*Math.max(Ai,1),ti.y-=mi.y*Math.max(Ai,1),Me.push(mi),be.push(hr),ve.push(ti)};if(ei==="miter")nt._mult(Et),ri(Oe,nt,0,0);else if(ei==="flipbevel")nt=tt.mult(-1),ri(Oe,nt,0,0),ri(Oe,nt.mult(-1),0,0);else{const Ei=-Math.sqrt(Et*Et-1),mi=Lt?Ei:0,Ai=Lt?0:Ei;Ce&&ri(Oe,rt,mi,Ai),ke&&ri(Oe,tt,mi,Ai)}}me.geometry=[...be,...ve.reverse(),be[0]],me.joinNormals=[...Me,...Me.reverse(),Me[Me.length-1]];const ot=me.geometry.length-1;for(let ut=0;ut<ot/2;ut++)if(ut+1<ot/2){let nt=ut,Ht=ut+1,Et=ot-1-ut,Lt=ot-2-ut;nt=nt===0?ot-1:nt-1,Ht=Ht===0?ot-1:Ht-1,Et=Et===0?ot-1:Et-1,Lt=Lt===0?ot-1:Lt-1,me.indices.push(Et),me.indices.push(Ht),me.indices.push(nt),me.indices.push(Et),me.indices.push(Lt),me.indices.push(Ht)}return me}(i[0]),i=[N.geometry]}const B=(te,pe)=>te<(pe.length-1)/2||te===pe.length-1,F=this.wallMode?[i]:Kp(i,500);for(let te=F.length-1;te>=0;te--){const pe=F[te];(pe.length===0||(U=pe[0]).every(ne=>ne.x<=0)||U.every(ne=>ne.x>=ht)||U.every(ne=>ne.y<=0)||U.every(ne=>ne.y>=ht))&&F.splice(te,1)}var U;let q;if(S)q=L0(F,p,l);else{q=[];for(const te of F)q.push({polygon:te,bounds:p})}const Z=b?this.edgeRadius:0,re=Z>0&&this.zoom<17,ee=(te,pe)=>{if(te.length===0)return!1;const ne=te[te.length-1];return pe.x===ne.x&&pe.y===ne.y};for(const{polygon:te,bounds:pe}of q){let ne=0,me=0;for(const Ee of te)b&&!Ee[0].equals(Ee[Ee.length-1])&&Ee.push(Ee[0]),me+=b?Ee.length-1:Ee.length;const be=this.segments.prepareSegment((b?5:4)*me,this.layoutVertexArray,this.indexArray);M.footprintSegIdx<0&&(M.footprintSegIdx=this.footprintSegments.length),M.polygonSegIdx<0&&(M.polygonSegIdx=this.polygonSegments.length);const ve={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Me=new T0;if(Me.vertexOffset=this.footprintVertices.length,Me.indexOffset=3*this.footprintIndices.length,Me.ringIndices=[],b){const Ee=[],Oe=[];ne=be.vertexLength;for(let ke=0;ke<te.length;ke++){const rt=te[ke];rt.length&&ke!==0&&Oe.push(Ee.length/2);const tt=[];let Ct,ot;Ct=rt[1].sub(rt[0])._perp()._unit(),Me.ringIndices.push(rt.length-1);for(let ut=1;ut<rt.length;ut++){const nt=rt[ut],Ht=rt[ut===rt.length-1?1:ut+1],Et=nt.clone();if(Z){ot=Ht.sub(nt)._perp()._unit();const Lt=Ct.add(ot)._unit(),ei=Z*Math.min(4,1/(Ct.x*Lt.x+Ct.y*Lt.y));Et.x+=ei*Lt.x,Et.y+=ei*Lt.y,Et.x=Math.round(Et.x),Et.y=Math.round(Et.y),Ct=ot}if(!D||Z!==0&&!re||ee(tt,Et)||tt.push(Et),$d(this.layoutVertexArray,Et.x,Et.y,0,0,1,1,0),this.wallMode){const Lt=B(ut,rt);Hd(this.wallVertexArray,N.joinNormals[ut],!Lt)}be.vertexLength++,this.footprintVertices.emplaceBack(nt.x,nt.y),Ee.push(nt.x,nt.y),S&&Zd(this.layoutVertexExtArray,x.projectTilePoint(Et.x,Et.y,l),x.upVector(l,Et.x,Et.y))}D&&(Z===0||re)&&(tt.length!==0&&ee(tt,tt[0])&&tt.pop(),this.groundEffect.addData(tt,pe,w))}const Ce=this.wallMode?N.indices:Ud(Ee,Oe);for(let ke=0;ke<Ce.length;ke+=3)this.footprintIndices.emplaceBack(Me.vertexOffset+Ce[ke+0],Me.vertexOffset+Ce[ke+1],Me.vertexOffset+Ce[ke+2]),this.indexArray.emplaceBack(ne+Ce[ke],ne+Ce[ke+2],ne+Ce[ke+1]),be.primitiveLength++;Me.indexCount+=Ce.length,Me.vertexCount+=this.footprintVertices.length-Me.vertexOffset}for(let Ee=0;Ee<te.length;Ee++){const Oe=te[Ee];T.startRing(M,Oe[0]);let Ce=Oe.length>4&&R0(Oe[Oe.length-2],Oe[0],Oe[1]),ke=Z?iS(Oe[Oe.length-2],Oe[0],Oe[1],Z):0;const rt=[];let tt,Ct,ot;Ct=Oe[1].sub(Oe[0])._perp()._unit();let ut=!0;for(let nt=1,Ht=0;nt<Oe.length;nt++){let Et=Oe[nt-1],Lt=Oe[nt];const ei=Oe[nt===Oe.length-1?1:nt+1];if(T.appendEdge(M,Lt,Et),Pg(Lt,Et,pe)){Z&&(Ct=ei.sub(Lt)._perp()._unit(),ut=!ut);continue}const _i=Lt.sub(Et)._perp(),ri=_i.x/(Math.abs(_i.x)+Math.abs(_i.y)),Ei=_i.y>0?1:0,mi=Et.dist(Lt);if(Ht+mi>32768&&(Ht=0),Z){ot=ei.sub(Lt)._perp()._unit();let ti=C0(Et,Lt,ei,I0(Ct,ot),Z);isNaN(ti)&&(ti=0);const Di=Lt.sub(Et)._unit();Et=Et.add(Di.mult(ke))._round(),Lt=Lt.add(Di.mult(-ti))._round(),ke=ti,Ct=ot,D&&this.zoom>=17&&(ee(rt,Et)||rt.push(Et),ee(rt,Lt)||rt.push(Lt))}const Ai=be.vertexLength,Ni=Oe.length>4&&R0(Et,Lt,ei);let hr=D0(Ht,Ce,ut);if($d(this.layoutVertexArray,Et.x,Et.y,ri,Ei,0,0,hr),$d(this.layoutVertexArray,Et.x,Et.y,ri,Ei,0,1,hr),this.wallMode){const ti=B(nt-1,Oe),Di=N.joinNormals[nt-1];Hd(this.wallVertexArray,Di,ti),Hd(this.wallVertexArray,Di,ti)}if(Ht+=mi,hr=D0(Ht,Ni,!ut),Ce=Ni,$d(this.layoutVertexArray,Lt.x,Lt.y,ri,Ei,0,0,hr),$d(this.layoutVertexArray,Lt.x,Lt.y,ri,Ei,0,1,hr),this.wallMode){const ti=B(nt,Oe),Di=N.joinNormals[nt];Hd(this.wallVertexArray,Di,ti),Hd(this.wallVertexArray,Di,ti)}if(be.vertexLength+=4,this.indexArray.emplaceBack(Ai+0,Ai+1,Ai+2),this.indexArray.emplaceBack(Ai+1,Ai+3,Ai+2),be.primitiveLength+=2,Z){const ti=ne+(nt===1?Oe.length-2:nt-2),Di=nt===1?ne:ti+1;if(this.indexArray.emplaceBack(Ai+1,ti,Ai+3),this.indexArray.emplaceBack(ti,Di,Ai+3),be.primitiveLength+=2,tt===void 0&&(tt=Ai),!Pg(ei,Oe[nt],pe)){const vr=nt===Oe.length-1?tt:be.vertexLength;this.indexArray.emplaceBack(Ai+2,Ai+3,vr),this.indexArray.emplaceBack(Ai+3,vr+1,vr),this.indexArray.emplaceBack(Ai+3,Di,vr+1),be.primitiveLength+=3}ut=!ut}if(S){const ti=this.layoutVertexExtArray,Di=x.projectTilePoint(Et.x,Et.y,l),vr=x.projectTilePoint(Lt.x,Lt.y,l),Mr=x.upVector(l,Et.x,Et.y),Pr=x.upVector(l,Lt.x,Lt.y);Zd(ti,Di,Mr),Zd(ti,Di,Mr),Zd(ti,vr,Pr),Zd(ti,vr,Pr)}}b&&(ne+=Oe.length-1),D&&Z&&this.zoom>=17&&(rt.length!==0&&ee(rt,rt[0])&&rt.pop(),this.groundEffect.addData(rt,pe,w,Z>0))}this.footprintSegments.push(Me),ve.triangleCount=this.indexArray.length-ve.triangleArrayOffset,this.polygonSegments.push(ve),++M.footprintSegLen,++M.polygonSegLen}if(M.vertexCount=this.layoutVertexArray.length-M.vertexArrayOffset,M.groundVertexCount=this.groundEffect.vertexArray.length-M.groundVertexArrayOffset,M.vertexCount!==0){if(M.centroidXY=T.borders?w0:this.encodeCentroid(T,M),this.centroidData.push(M),T.borders){this.featuresOnBorder.push(T);const te=this.featuresOnBorder.length-1;for(let pe=0;pe<T.borders.length;pe++)T.borders[pe][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[pe].push(te)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,a,h,l,y),this.groundEffect.addPaintPropertiesData(e,o,a,h,l,y),this.maxHeight=Math.max(this.maxHeight,z)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,o)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[o].borders[e][0])}splitToSubtiles(){const e=[];for(let _=0;_<this.centroidData.length;_++){const y=this.centroidData[_],w=+(y.min.y+y.max.y>ht),p=2*w+(+(y.min.x+y.max.x>ht)^w);for(let x=0;x<y.polygonSegLen;x++){const S=y.polygonSegIdx+x;e.push({centroidIdx:_,subtile:p,polygonSegmentIdx:S,triangleSegmentIdx:this.polygonSegments[S].triangleSegIdx})}}const i=new dn;e.sort((_,y)=>_.triangleSegmentIdx===y.triangleSegmentIdx?_.subtile-y.subtile:_.triangleSegmentIdx-y.triangleSegmentIdx);let o=0,l=0,a=0;for(const _ of e){if(_.triangleSegmentIdx!==o)break;a++}const h=e.length;for(;l!==e.length;){o=e[l].triangleSegmentIdx;let _=0,y=l,w=l;for(let p=y;p<a&&e[p].subtile===_;p++)w++;for(;y!==a;){const p=e[y];_=p.subtile;const x=this.centroidData[p.centroidIdx].min.clone(),S=this.centroidData[p.centroidIdx].max.clone(),b={vertexOffset:this.segments.segments[o].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[o].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let T=y;T<w;T++){const M=e[T],D=this.polygonSegments[M.polygonSegmentIdx],z=this.centroidData[M.centroidIdx].min,N=this.centroidData[M.centroidIdx].max,B=this.indexArray.uint16;for(let F=D.triangleArrayOffset;F<D.triangleArrayOffset+D.triangleCount;F++)i.emplaceBack(B[3*F],B[3*F+1],B[3*F+2]);b.primitiveLength+=D.triangleCount,x.x=Math.min(x.x,z.x),x.y=Math.min(x.y,z.y),S.x=Math.max(S.x,N.x),S.y=Math.max(S.y,N.y)}b.primitiveLength>0&&this.triangleSubSegments.push({segment:b,min:x,max:S}),y=w;for(let T=y;T<a&&e[T].subtile===e[y].subtile;T++)w++}l=a;for(let p=l;p<h&&e[p].triangleSegmentIdx===e[l].triangleSegmentIdx;p++)a++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,o){const l=new Tr;if(this.wallMode){for(const M of this.triangleSubSegments)l.segments.push(M.segment);return l}let a=0,h=0;const _=1<<e.canonical.z;if(i){const M=i.getMinMaxForTile(e);M&&(a=M.min,h=M.max)}h+=this.maxHeight;const y=e.toUnwrapped();let w;const p=[y.canonical.x/_+y.wrap,y.canonical.y/_],x=[(y.canonical.x+1)/_+y.wrap,(y.canonical.y+1)/_],S=(M,D,z)=>[M[0]*(1-z[0])+D[0]*z[0],M[1]*(1-z[1])+D[1]*z[1]],b=[],T=[];for(const M of this.triangleSubSegments){b[0]=M.min.x/ht,b[1]=M.min.y/ht,T[0]=M.max.x/ht,T[1]=M.max.y/ht;const D=S(p,x,b),z=S(p,x,T);if(new kt([D[0],D[1],a],[z[0],z[1],h]).intersectsPrecise(o)===0){w&&(l.segments.push(w),w=void 0);continue}const N=M.segment;w&&w.vertexOffset!==N.vertexOffset&&(l.segments.push(w),w=void 0),w?(w.vertexLength+=N.vertexLength,w.primitiveLength+=N.primitiveLength):w={vertexOffset:N.vertexOffset,primitiveLength:N.primitiveLength,vertexLength:N.vertexLength,primitiveOffset:N.primitiveOffset,sortKey:void 0,vaos:{}}}return w&&l.segments.push(w),l}encodeCentroid(e,i){const o=e.centroid(),l=i.span(),a=Math.min(7,Math.round(l.x*this.tileToMeter/10)),h=Math.min(7,Math.round(l.y*this.tileToMeter/10));return new we(Dt(o.x,1,ht-1)<<3|a,Dt(o.y,1,ht-1)<<3|h)}encodeBorderCentroid(e){if(!e.borders)return new we(0,0);const i=e.borders,o=Number.MAX_VALUE;if(i[0][0]!==o||i[1][0]!==o){const l=i[0][0]!==o?0:1;return new we(6|(i[0][0]!==o?0:65528),(i[l][0]+i[l][1])/2<<3|6)}{const l=i[2][0]!==o?2:3;return new we((i[l][0]+i[l][1])/2<<3|6,6|(i[2][0]!==o?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=vl,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,o=e.vertexCount+e.vertexArrayOffset,l=e.flags&vl?w0:e.centroidXY,a=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==l.y||a!==l.x){for(let h=i;h<o;++h)this.centroidVertexArray.emplace(h,l.x,l.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,o){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const l=i.getReplacementRegionsForTile(e.toUnwrapped());if(Ag(this.activeReplacements,l))return;if(this.activeReplacements=l,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const h of this.centroidData)h.flags&=2147483647;const a=[];for(const h of this.activeReplacements){if(h.order<o)continue;const _=Math.max(1,Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z));for(const y of this.centroidData)if(!(y.flags&vl||h.min.x>y.max.x||y.min.x>h.max.x||h.min.y>y.max.y||y.min.y>h.max.y))for(let w=0;w<y.footprintSegLen;w++){const p=this.footprintSegments[y.footprintSegIdx+w];if(a.length=0,rS(this.footprintVertices,p.vertexOffset,p.vertexCount,h.footprintTileId.canonical,e.canonical,a),g0(h.footprint,a,this.footprintIndices.uint16,p.indexOffset,p.indexCount,-p.vertexOffset,-_)){y.flags|=vl;break}}}for(const h of this.centroidData)this.writeCentroidToBuffer(h);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,o){let l=!1;for(let a=0;a<o.footprintSegLen;a++){const h=this.footprintSegments[o.footprintSegIdx+a];let _=0;for(const y of h.ringIndices){for(let w=_,p=y+_-1;w<y+_;p=w++){const x=this.footprintVertices.int16[2*(w+h.vertexOffset)+0],S=this.footprintVertices.int16[2*(w+h.vertexOffset)+1],b=this.footprintVertices.int16[2*(p+h.vertexOffset)+1];S>i!=b>i&&e<(this.footprintVertices.int16[2*(p+h.vertexOffset)+0]-x)*(i-S)/(b-S)+x&&(l=!l)}_=y}}return l}getHeightAtTileCoord(e,i){let o=Number.NEGATIVE_INFINITY,l=!0;const a=4*(e+ht)*ht+(i+ht);if(this.partLookup.hasOwnProperty(a)){const h=this.partLookup[a];return h?{height:h.height,hidden:!!(h.flags&vl)}:void 0}for(const h of this.centroidData)e>h.max.x||h.min.x>e||i>h.max.y||h.min.y>i||this.footprintContainsPoint(e,i,h)&&h&&h.height>o&&(o=h.height,this.partLookup[a]=h,l=!!(h.flags&vl));if(o!==Number.NEGATIVE_INFINITY)return{height:o,hidden:l};this.partLookup[a]=void 0}}function I0(n,e){const i=n.add(e)._unit();return n.x*i.x+n.y*i.y}function iS(n,e,i,o){const l=e.sub(n)._perp()._unit(),a=i.sub(e)._perp()._unit();return C0(n,e,i,I0(l,a),o)}function C0(n,e,i,o,l){const a=Math.sqrt(1-o*o);return Math.min(n.dist(e)/3,e.dist(i)/3,l*a/o)}function Pg(n,e,i){return n.x<i[0].x&&e.x<i[0].x||n.x>i[1].x&&e.x>i[1].x||n.y<i[0].y&&e.y<i[0].y||n.y>i[1].y&&e.y>i[1].y}function P0(n,e){return n.x<e[0].x||n.x>e[1].x||n.y<e[0].y||n.y>e[1].y}function R0(n,e,i){if(n.x<0||n.x>=ht||e.x<0||e.x>=ht||i.x<0||i.x>=ht)return!1;const o=i.sub(e),l=o.perp(),a=n.sub(e);return(o.x*a.x+o.y*a.y)/Math.sqrt((o.x*o.x+o.y*o.y)*(a.x*a.x+a.y*a.y))>-.866&&l.x*a.x+l.y*a.y<0}function D0(n,e,i){const o=e?2|n:-3&n;return i?1|o:-2&o}function z0(){const n=Math.PI/32,e=Math.tan(n),i=va;return i*Math.sqrt(1+2*e*e)-i}function L0(n,e,i){const o=1<<i.z,l=Kn(i.x/o),a=Kn((i.x+1)/o),h=fn(i.y/o),_=fn((i.y+1)/o);return function(y,w,p,x,S=0,b){const T=[];if(!y.length||!p||!x)return T;const M=(q,Z)=>{for(const re of q)T.push({polygon:re,bounds:Z})},D=Math.ceil(Math.log2(p)),z=Math.ceil(Math.log2(x)),N=D-z,B=[];for(let q=0;q<Math.abs(N);q++)B.push(N>0?0:1);for(let q=0;q<Math.min(D,z);q++)B.push(0),B.push(1);let F=y;if(F=Jp(F,w[0].y-S,w[1].y+S,1),F=Jp(F,w[0].x-S,w[1].x+S,0),!F.length)return T;const U=[];for(B.length?U.push({polygons:F,bounds:w,depth:0}):M(F,w);U.length;){const q=U.pop(),Z=q.depth,re=B[Z],ee=q.bounds[0],te=q.bounds[1],pe=re===0?ee.x:ee.y,ne=re===0?te.x:te.y,me=b?b(re,pe,ne):.5*(pe+ne),be=Jp(q.polygons,pe-S,me+S,re),ve=Jp(q.polygons,me-S,ne+S,re);if(be.length){const Me=[ee,new we(re===0?me:te.x,re===1?me:te.y)];B.length>Z+1?U.push({polygons:be,bounds:Me,depth:Z+1}):M(be,Me)}if(ve.length){const Me=[new we(re===0?me:ee.x,re===1?me:ee.y),te];B.length>Z+1?U.push({polygons:ve,bounds:Me,depth:Z+1}):M(ve,Me)}}return T}(n,e,Math.ceil((a-l)/11.25),Math.ceil((h-_)/11.25),1,(y,w,p)=>{if(y===0)return .5*(w+p);{const x=fn((i.y+w/ht)/o);return(Xn(.5*(fn((i.y+p/ht)/o)+x))*o-i.y)*ht}})}function rS(n,e,i,o,l,a){const h=Math.pow(2,o.z-l.z);for(let _=0;_<i;_++){let y=n.int16[2*(_+e)+0],w=n.int16[2*(_+e)+1];y=(y+l.x*ht)*h-o.x*ht,w=(w+l.y*ht)*h-o.y*ht,a.push(new we(y,w))}}let O0,k0;function Wd(n,e){return n.x*e.x+n.y*e.y}function F0(n,e){if(n.length===1){let i=0;const o=e[i++];let l;for(;!l||o.equals(l);)if(l=e[i++],!l)return 1/0;for(;i<e.length;i++){const a=e[i],h=n[0],_=l.sub(o),y=a.sub(o),w=h.sub(o),p=Wd(_,_),x=Wd(_,y),S=Wd(y,y),b=Wd(w,_),T=Wd(w,y),M=p*S-x*x,D=(S*b-x*T)/M,z=(p*T-x*b)/M,N=o.z*(1-D-z)+l.z*D+a.z*z;if(isFinite(N))return N}return 1/0}{let i=1/0;for(const o of e)i=Math.min(i,o.z);return i}}function B0(n,e,i,o,l,a,h,_){const y=h*l.getElevationAt(n,e,!0,!0),w=a[0]!==0,p=w?a[1]===0?h*(a[0]/7-450):h*function(x,S,b){const T=Math.floor(S[0]/8),M=Math.floor(S[1]/8),D=10*(S[0]-8*T),z=10*(S[1]-8*M),N=x.getElevationAt(T,M,!0,!0),B=x.getMeterToDEM(b),F=Math.floor(.5*(D*B-1)),U=Math.floor(.5*(z*B-1)),q=x.tileCoordToPixel(T,M),Z=2*F+1,re=2*U+1,ee=function(ve,Me,Ee,Oe,Ce){return[ve.getElevationAtPixel(Me,Ee,!0),ve.getElevationAtPixel(Me+Ce,Ee,!0),ve.getElevationAtPixel(Me,Ee+Ce,!0),ve.getElevationAtPixel(Me+Oe,Ee+Ce,!0)]}(x,q.x-F,q.y-U,Z,re),te=Math.abs(ee[0]-ee[1]),pe=Math.abs(ee[2]-ee[3]),ne=Math.abs(ee[0]-ee[2])+Math.abs(ee[1]-ee[3]),me=Math.min(.25,.5*B*(te+pe)/Z),be=Math.min(.25,.5*B*ne/re);return N+Math.max(me*D,be*z)}(l,a,_):y;return{base:y+(i===0?-1:i),top:w?Math.max(p+o,y+i+2):y+o}}It(im,"FillExtrusionBucket",{omit:["layers","features"]}),It(S0,"PartData"),It(T0,"FootprintSegment"),It(E0,"BorderCentroidData"),It(A0,"GroundEffect");const nS=Hi([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),sS=Hi([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:oS}=nS,aS=Hi([{name:"a_packed",components:3,type:"Float32"}]),{members:lS}=aS,cS=Hi([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:uS}=cS;class N0{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new gl({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const o=this.getKey(e,i);return this.positions[o]}trim(){const e=this.width,i=this.height=zn(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,o){const l=[];let a=e.length%2==1?-e[e.length-1]*o:0,h=e[0]*o,_=!0;l.push({left:a,right:h,isDash:_,zeroLength:e[0]===0});let y=e[0];for(let w=1;w<e.length;w++){_=!_;const p=e[w];a=y*o,y+=p,h=y*o,l.push({left:a,right:h,isDash:_,zeroLength:p===0})}return l}addRoundDash(e,i,o){const l=i/2;for(let a=-o;a<=o;a++){const h=this.width*(this.nextRow+o+a);let _=0,y=e[_];for(let w=0;w<this.width;w++){w/y.right>1&&(y=e[++_]);const p=Math.abs(w-y.left),x=Math.abs(w-y.right),S=Math.min(p,x);let b;const T=a/o*(l+1);if(y.isDash){const M=l-Math.abs(T);b=Math.sqrt(S*S+M*M)}else b=l-Math.sqrt(S*S+T*T);this.image.data[h+w]=Math.max(0,Math.min(255,b+128))}}}addRegularDash(e,i){for(let y=e.length-1;y>=0;--y){const w=e[y],p=e[y+1];w.zeroLength?e.splice(y,1):p&&p.isDash===w.isDash&&(p.left=w.left,e.splice(y,1))}const o=e[0],l=e[e.length-1];o.isDash===l.isDash&&(o.left=l.left-this.width,l.right=o.right+this.width);const a=this.width*this.nextRow;let h=0,_=e[h];for(let y=0;y<this.width;y++){y/_.right>1&&(_=e[++h]);const w=Math.abs(y-_.left),p=Math.abs(y-_.right),x=Math.min(w,p);this.image.data[a+y]=Math.max(0,Math.min(255,(_.isDash?x:-x)+i+128))}}addDash(e,i){const o=this.getKey(e,i);if(this.positions[o])return this.positions[o];const l=i==="round",a=l?7:0,h=2*a+1;if(this.nextRow+h>this.height)return br("LineAtlas out of space"),null;e.length===0&&e.push(1);let _=0;for(let p=0;p<e.length;p++)e[p]<0&&(br("Negative value is found in line dasharray, replacing values with 0"),e[p]=0),_+=e[p];if(_!==0){const p=this.width/_,x=this.getDashRanges(e,this.width,p);l?this.addRoundDash(x,p,a):this.addRegularDash(x,i==="square"?.5*p:0)}const y=this.nextRow+a;this.nextRow+=h;const w={tl:[y,a],br:[_,0]};return this.positions[o]=w,w}}It(N0,"LineAtlas");const hS=yl.VectorTileFeature.types,dS=Math.cos(Math.PI/180*37.5),fS=Math.cos(Math.PI/180*5);class Rg{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasZOffset=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new xd,this.layoutVertexArray2=new Bs,this.patternVertexArray=new Bs,this.indexArray=new dn,this.programConfigurations=new $o(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Tr,this.maxLineLength=0,this.zOffsetVertexArray=new Bs,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:ht/64}updateFootprints(e,i){}populate(e,i,o,l){this.hasPattern=gg("line",this.layers,this.pixelRatio,i);const a=this.layers[0].layout.get("line-sort-key");this.tileToMeter=u(o);const h=this.layers[0].layout.get("line-z-offset"),_=h.isConstant()&&!h.constantOr(0),y=this.layers[0].layout.get("line-elevation-reference");this.hasZOffset=y==="sea"||y==="ground"||!_&&y==="none",this.hasZOffset&&y==="none"&&br(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`);const w=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.hasZOffset&&w!==void 0;const p=[];for(const{feature:T,id:M,index:D,sourceLayerIndex:z}of e){const N=this.layers[0]._featureFilter.needGeometry,B=R(T,N);if(!this.layers[0]._featureFilter.filter(new ur(this.zoom),B,o))continue;const F=a?a.evaluate(B,{},o):void 0,U={id:M,properties:T.properties,type:T.type,sourceLayerIndex:z,index:D,geometry:N?B.geometry:C(T,o,l),patterns:{},sortKey:F};p.push(U)}a&&p.sort((T,M)=>T.sortKey-M.sortKey);const{lineAtlas:x,featureIndex:S}=i,b=this.addConstantDashes(x);for(const T of p){const{geometry:M,index:D,sourceLayerIndex:z}=T;if(b&&this.addFeatureDashes(T,x),this.hasPattern){const N=yg("line",this.layers,T,this.zoom,this.pixelRatio,i);this.patternFeatures.push(N)}else this.addFeature(T,M,D,o,x.positions,i.availableImages,i.brightness);S.insert(e[D].feature,M,D,z,this.index)}}addConstantDashes(e){let i=!1;for(const o of this.layers){const l=o.paint.get("line-dasharray").value,a=o.layout.get("line-cap").value;if(l.kind!=="constant"||a.kind!=="constant")i=!0;else{const h=a.value,_=l.value;if(!_)continue;e.addDash(_,h)}}return i}addFeatureDashes(e,i){const o=this.zoom;for(const l of this.layers){const a=l.paint.get("line-dasharray").value,h=l.layout.get("line-cap").value;if(a.kind==="constant"&&h.kind==="constant")continue;let _,y;if(a.kind==="constant"){if(_=a.value,!_)continue}else _=a.evaluate({zoom:o},e);y=h.kind==="constant"?h.value:h.evaluate({zoom:o},e),i.addDash(_,y),e.patterns[l.id]=i.getKey(_,y)}}update(e,i,o,l,a,h,_){this.programConfigurations.updatePaintArrays(e,i,a,o,l,h,_)}addFeatures(e,i,o,l,a,h){for(const _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,i,o,l,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,lS)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,uS)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,sS.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,oS),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,i,o,l,a,h,_){const y=this.layers[0].layout,w=y.get("line-join").evaluate(e,{}),p=y.get("line-cap").evaluate(e,{}),x=y.get("line-miter-limit"),S=y.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=y.get("line-z-offset").value;const b=this.layers[0].paint.get("line-width").value;b.kind!=="constant"&&b.isLineProgressConstant===!1&&(this.variableWidthValue=b);for(const T of i)this.addLine(T,e,l,w,p,x,S);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,a,h,l,_)}addLine(e,i,o,l,a,h,_){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const y=l==="none";if(this.patternJoinNone=this.hasPattern&&y,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let B=0;B<e.length-1;B++)this.totalDistance+=e[B].dist(e[B+1]);this.totalFeatureLength=this.totalDistance/(this.lineClips.end-this.lineClips.start),this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const w=hS[i.type]==="Polygon";let p=e.length;for(;p>=2&&e[p-1].equals(e[p-2]);)p--;let x=0;for(;x<p-1&&e[x].equals(e[x+1]);)x++;if(p<(w?3:2))return;l==="bevel"&&(h=1.05);const S=this.segments.prepareSegment(10*p,this.layoutVertexArray,this.indexArray);let b,T,M,D,z,N;this.e1=this.e2=-1,w&&(b=e[p-2],z=e[x].sub(b)._unit()._perp());for(let B=x;B<p;B++){if(M=B===p-1?w?e[x+1]:void 0:e[B+1],M&&e[B].equals(M))continue;z&&(D=z),b&&(T=b),b=e[B],N=this.evaluateLineProgressFeatures(T?T.dist(b):0),z=M?M.sub(b)._unit()._perp():D,D=D||z;const F=T&&M;let U=F?l:w||y?"butt":a;const q=D.x*z.x+D.y*z.y;if(y){const be=function(ve){if(ve.patternJoinNone){const Me=ve.segmentPoints.length/2,Ee=ve.lineSoFar-ve.segmentStart;for(let Oe=0;Oe<Me;++Oe){const Ce=ve.segmentPoints[2*Oe+1],ke=Math.round(ve.segmentPoints[2*Oe])+.5+.25*Ce;ve.patternVertexArray.emplaceBack(ke,Ee,ve.segmentStart),ve.patternVertexArray.emplaceBack(ke,Ee,ve.segmentStart)}ve.segmentPoints.length=0}ve.e1=ve.e2=-1};if(F&&q<fS){this.updateDistance(T,b),this.addCurrentVertex(b,D,1,1,S,N),be(this),this.addCurrentVertex(b,z,-1,-1,S,N);continue}if(T){if(!M){this.updateDistance(T,b),this.addCurrentVertex(b,D,1,1,S,N),be(this);continue}U="miter"}}let Z=D.add(z);Z.x===0&&Z.y===0||Z._unit();const re=Z.x*z.x+Z.y*z.y,ee=re!==0?1/re:1/0,te=2*Math.sqrt(2-2*re),pe=re<dS&&T&&M,ne=D.x*z.y-D.y*z.x>0,me=this.overscaling<=16?15*ht/(512*this.overscaling):0;if(F&&U==="round"){if(ee<_)U="miter";else if(ee<=2){const be=Dg(b,-10,ht+10);U=this.hasZOffset&&(be||this.hasCrossSlope)?"miter":"fakeround"}}if(U==="miter"&&ee>h&&(U="bevel"),U==="bevel"&&(ee>2&&(U="flipbevel"),ee<h&&(U="miter")),T&&!(U==="miter"&&pe)&&this.updateDistance(T,b),U==="miter")if(pe){const be=b.dist(T);if(be>2*me){const Me=b.sub(b.sub(T)._mult(me/be)._round());this.updateDistance(T,Me),this.addCurrentVertex(Me,D,0,0,S,N),T=Me}this.updateDistance(T,b),Z._mult(ee),this.addCurrentVertex(b,Z,0,0,S,N);const ve=b.dist(M);if(ve>2*me){const Me=b.add(M.sub(b)._mult(me/ve)._round());this.updateDistance(b,Me),this.addCurrentVertex(Me,z,0,0,S,N),b=Me}}else Z._mult(ee),this.addCurrentVertex(b,Z,0,0,S,N);else if(U==="flipbevel"){if(ee>100)Z=z.mult(-1);else{const be=ee*D.add(z).mag()/D.sub(z).mag();Z._perp()._mult(be*(ne?-1:1))}this.addCurrentVertex(b,Z,0,0,S,N),this.addCurrentVertex(b,Z.mult(-1),0,0,S,N)}else if(U==="bevel"||U==="fakeround"){N!=null&&T&&this.addCurrentVertex(b,D,-1,-1,S,N);const be=b.dist(T)<=2*me&&U!=="bevel",ve=Z.mult(ne?1:-1);ve._mult(ee);const Me=z.mult(ne?-1:1),Ee=D.mult(ne?-1:1),Oe=this.evaluateLineProgressFeatures(this.distance);if(N==null&&(this.addHalfVertex(b,ve.x,ve.y,!1,!ne,0,S,Oe),be||this.addHalfVertex(b,ve.x+2*Ee.x,ve.y+2*Ee.y,!1,ne,0,S,Oe)),U==="fakeround"){const Ce=Math.round(180*te/Math.PI/20);this.addHalfVertex(b,Ee.x,Ee.y,!1,ne,0,S,Oe);for(let ke=0;ke<Ce;ke++){let rt=ke/Ce;if(rt!==.5){const Ct=rt-.5;rt+=rt*Ct*(rt-1)*((1.0904+q*(q*(3.55645-1.43519*q)-3.2452))*Ct*Ct+(.848013+q*(.215638*q-1.06021)))}const tt=Me.sub(Ee)._mult(rt)._add(Ee)._unit();this.addHalfVertex(b,tt.x,tt.y,!1,ne,0,S,Oe)}this.addHalfVertex(b,Me.x,Me.y,!1,ne,0,S,Oe)}be||N!=null||this.addHalfVertex(b,ve.x+2*Me.x,ve.y+2*Me.y,!1,ne,0,S,Oe),N!=null&&M&&this.addCurrentVertex(b,z,1,1,S,N)}else U==="butt"?this.addCurrentVertex(b,Z,0,0,S,N):U==="square"?(T||this.addCurrentVertex(b,Z,-1,-1,S,N),this.addCurrentVertex(b,Z,0,0,S,N),T&&this.addCurrentVertex(b,Z,1,1,S,N)):U==="round"&&(T&&(this.addCurrentVertex(b,D,0,0,S,N),this.addCurrentVertex(b,D,1,1,S,N,!0)),M&&(this.addCurrentVertex(b,z,-1,-1,S,N,!0),this.addCurrentVertex(b,z,0,0,S,N)))}}addVerticesTo(e,i,o,l,a,h,_,y,w,p){const x=(i.w-e.w)/this.tessellationStep|0;let S=0;const b=this.scaledDistance;if(x>1){this.lineSoFar=e.w;const M=(i.x-e.x)/x,D=(i.y-e.y)/x,z=(i.z-e.z)/x,N=(i.w-e.w)/x;for(let B=1;B<x;++B){e.x+=M,e.y+=D,e.z+=z,this.lineSoFar+=N,S+=N;const F=this.evaluateLineProgressFeatures(this.prevDistance+S);this.scaledDistance=(this.prevDistance+S)/this.totalDistance,this.addHalfVertex(e,o,l,p,!1,_,w,F),this.addHalfVertex(e,a,h,p,!0,-y,w,F)}}this.lineSoFar=i.w,this.scaledDistance=b;const T=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,o,l,p,!1,_,w,T),this.addHalfVertex(i,a,h,p,!0,-y,w,T)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&!this.hasZOffset)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):br(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.hasZOffset?this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}:{zOffset:0,variableWidth:i}}addCurrentVertex(e,i,o,l,a,h,_=!1){const y=i.x+i.y*o,w=i.y-i.x*o,p=i.y*l-i.x,x=-i.y-i.x*l;if(h!=null){const S=this.hasZOffset,b=-10,T=ht+10,M=h.zOffset,D=new h0(e.x,e.y,M,this.lineSoFar),z=!!S&&Dg(e,b,T),N=this.lineSoFar,B=this.distance;if(this.currentVertex)if(z){const F=this.currentVertexIsOutside,U=this.currentVertex,q=new h0(e.x,e.y,M,this.lineSoFar);if(f0(U,q,b,T),!Dg(q,b,T)){if(F){this.e1=this.e2=-1,this.distance-=U.dist(D),this.lineSoFar=U.w;const Z=this.evaluateLineProgressFeatures(U.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(U,y,w,_,!1,o,a,Z),this.addHalfVertex(U,p,x,_,!0,-l,a,Z),this.prevDistance=this.distance}this.distance=this.prevDistance+U.dist(q),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(U,q,y,w,p,x,o,l,a,_),this.distance=B,this.scaledDistance=this.distance/this.totalDistance}}else{const F=this.currentVertex;if(this.currentVertexIsOutside){f0(F,D,b,T),this.e1=this.e2=-1,this.distance-=F.dist(D),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=F.w;const U=this.evaluateLineProgressFeatures(F.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(F,y,w,_,!1,o,a,U),this.addHalfVertex(F,p,x,_,!0,-l,a,U),this.prevDistance=this.distance,this.distance=B,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(F,D,y,w,p,x,o,l,a,_)}else z||(this.addHalfVertex(e,y,w,_,!1,o,a,h),this.addHalfVertex(e,p,x,_,!0,-l,a,h));this.currentVertex=D,this.currentVertexIsOutside=z,this.lineSoFar=N}else this.addHalfVertex(e,y,w,_,!1,o,a,h),this.addHalfVertex(e,p,x,_,!0,-l,a,h)}addHalfVertex({x:e,y:i},o,l,a,h,_,y,w){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),h||this.segmentPoints.push(this.lineSoFar-this.segmentStart,_)),this.layoutVertexArray.emplaceBack((e<<1)+(a?1:0),(i<<1)+(h?1:0),Math.round(63*o)+128,Math.round(63*l)+128,1+(_===0?0:_<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const x=Xt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,x)}const p=y.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,p),y.primitiveLength++),h?this.e2=p:this.e1=p,w!=null&&this.zOffsetVertexArray.emplaceBack(w.zOffset,w.variableWidth,w.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function Dg(n,e,i){return n.x<e||n.x>i||n.y<e||n.y>i}let V0,U0;function j0(n,e,i){return e*(ht/(n.tileSize*Math.pow(2,i-n.tileID.overscaledZ)))}It(Rg,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const G0=(n,e,i)=>(1-i)*n+i*e;function q0(n,e){return 1/j0(n,1,e.tileZoom)}function $0(n,e,i,o){return n.translatePosMatrix(o||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const H0=n=>{const e=[];Z0(n)&&e.push("RENDER_LINE_DASH"),n.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=n.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),n.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const o=n.layout.get("line-join").constantOr("miter")==="none",l=!!n.paint.get("line-pattern").constantOr(1);return o&&l&&e.push("LINE_JOIN_NONE"),e};function Z0(n){const e=n.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let zg;const W0=()=>zg||(zg={layout:V0||(V0=new Cr({"line-cap":new At(Fe.layout_line["line-cap"]),"line-join":new At(Fe.layout_line["line-join"]),"line-miter-limit":new ct(Fe.layout_line["line-miter-limit"]),"line-round-limit":new ct(Fe.layout_line["line-round-limit"]),"line-sort-key":new At(Fe.layout_line["line-sort-key"]),"line-z-offset":new At(Fe.layout_line["line-z-offset"]),"line-elevation-reference":new ct(Fe.layout_line["line-elevation-reference"]),"line-cross-slope":new ct(Fe.layout_line["line-cross-slope"]),visibility:new ct(Fe.layout_line.visibility),"line-width-unit":new ct(Fe.layout_line["line-width-unit"])})),paint:U0||(U0=new Cr({"line-opacity":new At(Fe.paint_line["line-opacity"]),"line-color":new At(Fe.paint_line["line-color"]),"line-translate":new ct(Fe.paint_line["line-translate"]),"line-translate-anchor":new ct(Fe.paint_line["line-translate-anchor"]),"line-width":new At(Fe.paint_line["line-width"]),"line-gap-width":new At(Fe.paint_line["line-gap-width"]),"line-offset":new At(Fe.paint_line["line-offset"]),"line-blur":new At(Fe.paint_line["line-blur"]),"line-dasharray":new At(Fe.paint_line["line-dasharray"]),"line-pattern":new At(Fe.paint_line["line-pattern"]),"line-gradient":new al(Fe.paint_line["line-gradient"]),"line-trim-offset":new ct(Fe.paint_line["line-trim-offset"]),"line-trim-fade-range":new ct(Fe.paint_line["line-trim-fade-range"]),"line-trim-color":new ct(Fe.paint_line["line-trim-color"]),"line-emissive-strength":new ct(Fe.paint_line["line-emissive-strength"]),"line-border-width":new At(Fe.paint_line["line-border-width"]),"line-border-color":new At(Fe.paint_line["line-border-color"]),"line-occlusion-opacity":new ct(Fe.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},zg);class pS extends At{possiblyEvaluate(e,i){return i=new ur(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition}),super.possiblyEvaluate(e,i)}evaluate(e,i,o,l){return i=Gi({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,o,l)}}let Xd;function X0(n,e){return e>0?e+2*n:n}const mS=Hi([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),_S=Hi([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),gS=Hi([{name:"a_projected_pos",components:4,type:"Float32"}],4);Hi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const yS=Hi([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),vS=Hi([{name:"a_texb",components:2,type:"Uint16"}]),xS=Hi([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),bS=Hi([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);Hi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const K0=Hi([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),wS=Hi([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Hi([{name:"triangle",components:3,type:"Uint16"}]),Hi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Hi([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),Hi([{type:"Float32",name:"offsetX"}]),Hi([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Tn=24;const So=128;function Y0(n,e,i,o,l){if(n.kind==="camera")return n.maxSize;if(n.kind==="composite"){const a=e.possiblyEvaluate(new ur(n.maxZoom),i).evaluate(l,{},i),h=e.possiblyEvaluate(new ur(n.minZoom),i).evaluate(l,{},i);return Math.max(a,h)}return e.possiblyEvaluate(new ur(o)).evaluate(l,{},i)}function Lg(n,e){const{expression:i}=e;if(i.kind==="constant")return{kind:"constant",layoutSize:i.evaluate(new ur(n+1))};if(i.kind==="source")return{kind:"source"};{const{zoomStops:o,interpolationType:l}=i;let a=0;for(;a<o.length&&o[a]<=n;)a++;a=Math.max(0,a-1);let h=a;for(;h<o.length&&o[h]<n+1;)h++;h=Math.min(o.length-1,h);const _=o[a],y=o[h];return i.kind==="composite"?{kind:"composite",minZoom:_,maxZoom:y,interpolationType:l}:{kind:"camera",minZoom:_,maxZoom:y,minSize:i.evaluate(new ur(_)),maxSize:i.evaluate(new ur(y)),interpolationType:l}}}function rm(n,{uSize:e,uSizeT:i},{lowerSize:o,upperSize:l}){return n.kind==="source"?o/So:n.kind==="composite"?Xt(o/So,l/So,i):e}function qu(n,e,i=1){let o=0,l=0;if(n.kind==="constant")l=n.layoutSize*i;else if(n.kind!=="source"){const{interpolationType:a,minZoom:h,maxZoom:_}=n,y=a?Dt(ls.interpolationFactor(a,e,h,_),0,1):0;n.kind==="camera"?l=Xt(n.minSize,n.maxSize,y)*i:o=y*i}return{uSizeT:o,uSize:l}}var TS=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:So,evaluateSizeForFeature:rm,evaluateSizeForZoom:qu,getRasterizedIconSize:Y0,getSizeData:Lg});function SS(n,e,i){return n.sections.forEach(o=>{o.text=function(l,a,h){const _=a.layout.get("text-transform").evaluate(h,{});return _==="uppercase"?l=l.toLocaleUpperCase():_==="lowercase"&&(l=l.toLocaleLowerCase()),Ts.applyArabicShaping&&(l=Ts.applyArabicShaping(l)),l}(o.text,e,i)}),n}const Kd={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function ES(n){return n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""}function MS(n){return n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""}var J0,Og,Q0,kg={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */function AS(){return J0||(J0=1,kg.read=function(n,e,i,o,l){var a,h,_=8*l-o-1,y=(1<<_)-1,w=y>>1,p=-7,x=i?l-1:0,S=i?-1:1,b=n[e+x];for(x+=S,a=b&(1<<-p)-1,b>>=-p,p+=_;p>0;a=256*a+n[e+x],x+=S,p-=8);for(h=a&(1<<-p)-1,a>>=-p,p+=o;p>0;h=256*h+n[e+x],x+=S,p-=8);if(a===0)a=1-w;else{if(a===y)return h?NaN:1/0*(b?-1:1);h+=Math.pow(2,o),a-=w}return(b?-1:1)*h*Math.pow(2,a-o)},kg.write=function(n,e,i,o,l,a){var h,_,y,w=8*a-l-1,p=(1<<w)-1,x=p>>1,S=l===23?Math.pow(2,-24)-Math.pow(2,-77):0,b=o?0:a-1,T=o?1:-1,M=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(_=isNaN(e)?1:0,h=p):(h=Math.floor(Math.log(e)/Math.LN2),e*(y=Math.pow(2,-h))<1&&(h--,y*=2),(e+=h+x>=1?S/y:S*Math.pow(2,1-x))*y>=2&&(h++,y/=2),h+x>=p?(_=0,h=p):h+x>=1?(_=(e*y-1)*Math.pow(2,l),h+=x):(_=e*Math.pow(2,x-1)*Math.pow(2,l),h=0));l>=8;n[i+b]=255&_,b+=T,_/=256,l-=8);for(h=h<<l|_,w+=l;w>0;n[i+b]=255&h,b+=T,h/=256,w-=8);n[i+b-T]|=128*M}),kg}function ex(){if(Q0)return Og;Q0=1,Og=e;var n=AS();function e(F){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(F)?F:new Uint8Array(F||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var i=4294967296,o=1/i,l=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function a(F){return F.type===e.Bytes?F.readVarint()+F.pos:F.pos+1}function h(F,U,q){return q?4294967296*U+(F>>>0):4294967296*(U>>>0)+(F>>>0)}function _(F,U,q){var Z=U<=16383?1:U<=2097151?2:U<=268435455?3:Math.floor(Math.log(U)/(7*Math.LN2));q.realloc(Z);for(var re=q.pos-1;re>=F;re--)q.buf[re+Z]=q.buf[re]}function y(F,U){for(var q=0;q<F.length;q++)U.writeVarint(F[q])}function w(F,U){for(var q=0;q<F.length;q++)U.writeSVarint(F[q])}function p(F,U){for(var q=0;q<F.length;q++)U.writeFloat(F[q])}function x(F,U){for(var q=0;q<F.length;q++)U.writeDouble(F[q])}function S(F,U){for(var q=0;q<F.length;q++)U.writeBoolean(F[q])}function b(F,U){for(var q=0;q<F.length;q++)U.writeFixed32(F[q])}function T(F,U){for(var q=0;q<F.length;q++)U.writeSFixed32(F[q])}function M(F,U){for(var q=0;q<F.length;q++)U.writeFixed64(F[q])}function D(F,U){for(var q=0;q<F.length;q++)U.writeSFixed64(F[q])}function z(F,U){return(F[U]|F[U+1]<<8|F[U+2]<<16)+16777216*F[U+3]}function N(F,U,q){F[q]=U,F[q+1]=U>>>8,F[q+2]=U>>>16,F[q+3]=U>>>24}function B(F,U){return(F[U]|F[U+1]<<8|F[U+2]<<16)+(F[U+3]<<24)}return e.prototype={destroy:function(){this.buf=null},readFields:function(F,U,q){for(q=q||this.length;this.pos<q;){var Z=this.readVarint(),re=Z>>3,ee=this.pos;this.type=7&Z,F(re,U,this),this.pos===ee&&this.skip(Z)}return U},readMessage:function(F,U){return this.readFields(F,U,this.readVarint()+this.pos)},readFixed32:function(){var F=z(this.buf,this.pos);return this.pos+=4,F},readSFixed32:function(){var F=B(this.buf,this.pos);return this.pos+=4,F},readFixed64:function(){var F=z(this.buf,this.pos)+z(this.buf,this.pos+4)*i;return this.pos+=8,F},readSFixed64:function(){var F=z(this.buf,this.pos)+B(this.buf,this.pos+4)*i;return this.pos+=8,F},readFloat:function(){var F=n.read(this.buf,this.pos,!0,23,4);return this.pos+=4,F},readDouble:function(){var F=n.read(this.buf,this.pos,!0,52,8);return this.pos+=8,F},readVarint:function(F){var U,q,Z=this.buf;return U=127&(q=Z[this.pos++]),q<128?U:(U|=(127&(q=Z[this.pos++]))<<7,q<128?U:(U|=(127&(q=Z[this.pos++]))<<14,q<128?U:(U|=(127&(q=Z[this.pos++]))<<21,q<128?U:function(re,ee,te){var pe,ne,me=te.buf;if(pe=(112&(ne=me[te.pos++]))>>4,ne<128||(pe|=(127&(ne=me[te.pos++]))<<3,ne<128)||(pe|=(127&(ne=me[te.pos++]))<<10,ne<128)||(pe|=(127&(ne=me[te.pos++]))<<17,ne<128)||(pe|=(127&(ne=me[te.pos++]))<<24,ne<128)||(pe|=(1&(ne=me[te.pos++]))<<31,ne<128))return h(re,pe,ee);throw new Error("Expected varint not more than 10 bytes")}(U|=(15&(q=Z[this.pos]))<<28,F,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var F=this.readVarint();return F%2==1?(F+1)/-2:F/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var F=this.readVarint()+this.pos,U=this.pos;return this.pos=F,F-U>=12&&l?function(q,Z,re){return l.decode(q.subarray(Z,re))}(this.buf,U,F):function(q,Z,re){for(var ee="",te=Z;te<re;){var pe,ne,me,be=q[te],ve=null,Me=be>239?4:be>223?3:be>191?2:1;if(te+Me>re)break;Me===1?be<128&&(ve=be):Me===2?(192&(pe=q[te+1]))==128&&(ve=(31&be)<<6|63&pe)<=127&&(ve=null):Me===3?(ne=q[te+2],(192&(pe=q[te+1]))==128&&(192&ne)==128&&((ve=(15&be)<<12|(63&pe)<<6|63&ne)<=2047||ve>=55296&&ve<=57343)&&(ve=null)):Me===4&&(ne=q[te+2],me=q[te+3],(192&(pe=q[te+1]))==128&&(192&ne)==128&&(192&me)==128&&((ve=(15&be)<<18|(63&pe)<<12|(63&ne)<<6|63&me)<=65535||ve>=1114112)&&(ve=null)),ve===null?(ve=65533,Me=1):ve>65535&&(ve-=65536,ee+=String.fromCharCode(ve>>>10&1023|55296),ve=56320|1023&ve),ee+=String.fromCharCode(ve),te+=Me}return ee}(this.buf,U,F)},readBytes:function(){var F=this.readVarint()+this.pos,U=this.buf.subarray(this.pos,F);return this.pos=F,U},readPackedVarint:function(F,U){if(this.type!==e.Bytes)return F.push(this.readVarint(U));var q=a(this);for(F=F||[];this.pos<q;)F.push(this.readVarint(U));return F},readPackedSVarint:function(F){if(this.type!==e.Bytes)return F.push(this.readSVarint());var U=a(this);for(F=F||[];this.pos<U;)F.push(this.readSVarint());return F},readPackedBoolean:function(F){if(this.type!==e.Bytes)return F.push(this.readBoolean());var U=a(this);for(F=F||[];this.pos<U;)F.push(this.readBoolean());return F},readPackedFloat:function(F){if(this.type!==e.Bytes)return F.push(this.readFloat());var U=a(this);for(F=F||[];this.pos<U;)F.push(this.readFloat());return F},readPackedDouble:function(F){if(this.type!==e.Bytes)return F.push(this.readDouble());var U=a(this);for(F=F||[];this.pos<U;)F.push(this.readDouble());return F},readPackedFixed32:function(F){if(this.type!==e.Bytes)return F.push(this.readFixed32());var U=a(this);for(F=F||[];this.pos<U;)F.push(this.readFixed32());return F},readPackedSFixed32:function(F){if(this.type!==e.Bytes)return F.push(this.readSFixed32());var U=a(this);for(F=F||[];this.pos<U;)F.push(this.readSFixed32());return F},readPackedFixed64:function(F){if(this.type!==e.Bytes)return F.push(this.readFixed64());var U=a(this);for(F=F||[];this.pos<U;)F.push(this.readFixed64());return F},readPackedSFixed64:function(F){if(this.type!==e.Bytes)return F.push(this.readSFixed64());var U=a(this);for(F=F||[];this.pos<U;)F.push(this.readSFixed64());return F},skip:function(F){var U=7&F;if(U===e.Varint)for(;this.buf[this.pos++]>127;);else if(U===e.Bytes)this.pos=this.readVarint()+this.pos;else if(U===e.Fixed32)this.pos+=4;else{if(U!==e.Fixed64)throw new Error("Unimplemented type: "+U);this.pos+=8}},writeTag:function(F,U){this.writeVarint(F<<3|U)},realloc:function(F){for(var U=this.length||16;U<this.pos+F;)U*=2;if(U!==this.length){var q=new Uint8Array(U);q.set(this.buf),this.buf=q,this.length=U}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(F){this.realloc(4),N(this.buf,F,this.pos),this.pos+=4},writeSFixed32:function(F){this.realloc(4),N(this.buf,F,this.pos),this.pos+=4},writeFixed64:function(F){this.realloc(8),N(this.buf,-1&F,this.pos),N(this.buf,Math.floor(F*o),this.pos+4),this.pos+=8},writeSFixed64:function(F){this.realloc(8),N(this.buf,-1&F,this.pos),N(this.buf,Math.floor(F*o),this.pos+4),this.pos+=8},writeVarint:function(F){(F=+F||0)>268435455||F<0?function(U,q){var Z,re;if(U>=0?(Z=U%4294967296|0,re=U/4294967296|0):(re=~(-U/4294967296),4294967295^(Z=~(-U%4294967296))?Z=Z+1|0:(Z=0,re=re+1|0)),U>=18446744073709552e3||U<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");q.realloc(10),function(ee,te,pe){pe.buf[pe.pos++]=127&ee|128,ee>>>=7,pe.buf[pe.pos++]=127&ee|128,ee>>>=7,pe.buf[pe.pos++]=127&ee|128,ee>>>=7,pe.buf[pe.pos++]=127&ee|128,pe.buf[pe.pos]=127&(ee>>>=7)}(Z,0,q),function(ee,te){var pe=(7&ee)<<4;te.buf[te.pos++]|=pe|((ee>>>=3)?128:0),ee&&(te.buf[te.pos++]=127&ee|((ee>>>=7)?128:0),ee&&(te.buf[te.pos++]=127&ee|((ee>>>=7)?128:0),ee&&(te.buf[te.pos++]=127&ee|((ee>>>=7)?128:0),ee&&(te.buf[te.pos++]=127&ee|((ee>>>=7)?128:0),ee&&(te.buf[te.pos++]=127&ee)))))}(re,q)}(F,this):(this.realloc(4),this.buf[this.pos++]=127&F|(F>127?128:0),F<=127||(this.buf[this.pos++]=127&(F>>>=7)|(F>127?128:0),F<=127||(this.buf[this.pos++]=127&(F>>>=7)|(F>127?128:0),F<=127||(this.buf[this.pos++]=F>>>7&127))))},writeSVarint:function(F){this.writeVarint(F<0?2*-F-1:2*F)},writeBoolean:function(F){this.writeVarint(!!F)},writeString:function(F){F=String(F),this.realloc(4*F.length),this.pos++;var U=this.pos;this.pos=function(Z,re,ee){for(var te,pe,ne=0;ne<re.length;ne++){if((te=re.charCodeAt(ne))>55295&&te<57344){if(!pe){te>56319||ne+1===re.length?(Z[ee++]=239,Z[ee++]=191,Z[ee++]=189):pe=te;continue}if(te<56320){Z[ee++]=239,Z[ee++]=191,Z[ee++]=189,pe=te;continue}te=pe-55296<<10|te-56320|65536,pe=null}else pe&&(Z[ee++]=239,Z[ee++]=191,Z[ee++]=189,pe=null);te<128?Z[ee++]=te:(te<2048?Z[ee++]=te>>6|192:(te<65536?Z[ee++]=te>>12|224:(Z[ee++]=te>>18|240,Z[ee++]=te>>12&63|128),Z[ee++]=te>>6&63|128),Z[ee++]=63&te|128)}return ee}(this.buf,F,this.pos);var q=this.pos-U;q>=128&&_(U,q,this),this.pos=U-1,this.writeVarint(q),this.pos+=q},writeFloat:function(F){this.realloc(4),n.write(this.buf,F,this.pos,!0,23,4),this.pos+=4},writeDouble:function(F){this.realloc(8),n.write(this.buf,F,this.pos,!0,52,8),this.pos+=8},writeBytes:function(F){var U=F.length;this.writeVarint(U),this.realloc(U);for(var q=0;q<U;q++)this.buf[this.pos++]=F[q]},writeRawMessage:function(F,U){this.pos++;var q=this.pos;F(U,this);var Z=this.pos-q;Z>=128&&_(q,Z,this),this.pos=q-1,this.writeVarint(Z),this.pos+=Z},writeMessage:function(F,U,q){this.writeTag(F,e.Bytes),this.writeRawMessage(U,q)},writePackedVarint:function(F,U){U.length&&this.writeMessage(F,y,U)},writePackedSVarint:function(F,U){U.length&&this.writeMessage(F,w,U)},writePackedBoolean:function(F,U){U.length&&this.writeMessage(F,S,U)},writePackedFloat:function(F,U){U.length&&this.writeMessage(F,p,U)},writePackedDouble:function(F,U){U.length&&this.writeMessage(F,x,U)},writePackedFixed32:function(F,U){U.length&&this.writeMessage(F,b,U)},writePackedSFixed32:function(F,U){U.length&&this.writeMessage(F,T,U)},writePackedFixed64:function(F,U){U.length&&this.writeMessage(F,M,U)},writePackedSFixed64:function(F,U){U.length&&this.writeMessage(F,D,U)},writeBytesField:function(F,U){this.writeTag(F,e.Bytes),this.writeBytes(U)},writeFixed32Field:function(F,U){this.writeTag(F,e.Fixed32),this.writeFixed32(U)},writeSFixed32Field:function(F,U){this.writeTag(F,e.Fixed32),this.writeSFixed32(U)},writeFixed64Field:function(F,U){this.writeTag(F,e.Fixed64),this.writeFixed64(U)},writeSFixed64Field:function(F,U){this.writeTag(F,e.Fixed64),this.writeSFixed64(U)},writeVarintField:function(F,U){this.writeTag(F,e.Varint),this.writeVarint(U)},writeSVarintField:function(F,U){this.writeTag(F,e.Varint),this.writeSVarint(U)},writeStringField:function(F,U){this.writeTag(F,e.Bytes),this.writeString(U)},writeFloatField:function(F,U){this.writeTag(F,e.Fixed32),this.writeFloat(U)},writeDoubleField:function(F,U){this.writeTag(F,e.Fixed64),this.writeDouble(U)},writeBooleanField:function(F,U){this.writeVarintField(F,!!U)}},Og}var nm=Q(ex());const Fg=3;function IS(n,e,i){e.glyphs=[],n===1&&i.readMessage(CS,e)}function CS(n,e,i){if(n===3){const{id:o,bitmap:l,width:a,height:h,left:_,top:y,advance:w}=i.readMessage(PS,{});e.glyphs.push({id:o,bitmap:new gl({width:a+2*Fg,height:h+2*Fg},l),metrics:{width:a,height:h,left:_,top:y,advance:w}})}else n===4?e.ascender=i.readSVarint():n===5&&(e.descender=i.readSVarint())}function PS(n,e,i){n===1?e.id=i.readVarint():n===2?e.bitmap=i.readBytes():n===3?e.width=i.readVarint():n===4?e.height=i.readVarint():n===5?e.left=i.readSVarint():n===6?e.top=i.readSVarint():n===7&&(e.advance=i.readVarint())}const RS=Fg,fs={horizontal:1,vertical:2,horizontalOnly:3};class Yd{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const o=new Yd;return o.scale=e||1,o.fontStack=i,o}static forImage(e){const i=new Yd;return i.image=e,i}}class $u{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,o){const l=new $u;for(let a=0;a<e.sections.length;a++){const h=e.sections[a];h.image?l.addImageSection(h,o):l.addTextSection(h,i)}return l}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,o){let l="";for(let a=0;a<i.length;a++){const h=i.charCodeAt(a+1)||null,_=i.charCodeAt(a-1)||null;l+=!o&&(h&&ld(h)&&!Kd[i[a+1]]||_&&ld(_)&&!Kd[i[a-1]])||!Kd[i[a]]?i[a]:Kd[i[a]]}return l}(this.text,e)}trim(){let e=0;for(let o=0;o<this.text.length&&sm[this.text.charCodeAt(o)];o++)e++;let i=this.text.length;for(let o=this.text.length-1;o>=0&&o>=e&&sm[this.text.charCodeAt(o)];o--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const o=new $u;return o.text=this.text.substring(e,i),o.sectionIndex=this.sectionIndex.slice(e,i),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(Yd.forText(e.scale,e.fontStack||i));const o=this.sections.length-1;for(let l=0;l<e.text.length;++l)this.sectionIndex.push(o)}addImageSection(e,i){const o=e.image?e.image.getPrimary():null;if(!o)return void br("Can't add FormattedSection with an empty image.");o.scaleSelf(i);const l=this.getNextImageSectionCharCode();l?(this.text+=String.fromCodePoint(l),this.sections.push(Yd.forImage(o)),this.sectionIndex.push(this.sections.length-1)):br("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Bg(n,e,i,o,l,a,h,_,y,w,p,x,S,b,T,M=1){const D=$u.fromFeature(n,l,M);x===fs.vertical&&D.verticalizePunctuation(S);let z=[];const N=function(Z,re,ee,te,pe,ne){if(!Z)return[];const me=[],be=function(Oe,Ce,ke,rt,tt,Ct){let ot=0;for(let ut=0;ut<Oe.length();ut++){const nt=Oe.getSection(ut);ot+=tx(Oe.getCodePoint(ut),nt,rt,tt,Ce,Ct)}return ot/Math.max(1,Math.ceil(ot/ke))}(Z,re,ee,te,pe,ne),ve=Z.text.indexOf("")>=0;let Me=0;for(let Oe=0;Oe<Z.length();Oe++){const Ce=Z.getSection(Oe),ke=Z.getCodePoint(Oe);if(sm[ke]||(Me+=tx(ke,Ce,te,pe,re,ne)),Oe<Z.length()-1){const rt=!((Ee=ke)<11904||!($t["Bopomofo Extended"](Ee)||$t.Bopomofo(Ee)||$t["CJK Compatibility Forms"](Ee)||$t["CJK Compatibility Ideographs"](Ee)||$t["CJK Compatibility"](Ee)||$t["CJK Radicals Supplement"](Ee)||$t["CJK Strokes"](Ee)||$t["CJK Symbols and Punctuation"](Ee)||$t["CJK Unified Ideographs Extension A"](Ee)||$t["CJK Unified Ideographs"](Ee)||$t["Enclosed CJK Letters and Months"](Ee)||$t["Halfwidth and Fullwidth Forms"](Ee)||$t.Hiragana(Ee)||$t["Ideographic Description Characters"](Ee)||$t["Kangxi Radicals"](Ee)||$t["Katakana Phonetic Extensions"](Ee)||$t.Katakana(Ee)||$t["Vertical Forms"](Ee)||$t["Yi Radicals"](Ee)||$t["Yi Syllables"](Ee)));(DS[ke]||rt||Ce.image)&&me.push(rx(Oe+1,Me,be,me,zS(ke,Z.getCodePoint(Oe+1),rt&&ve),!1))}}var Ee;return nx(rx(Z.length(),Me,be,me,0,!0))}(D,w,a,e,o,b),{processBidirectionalText:B,processStyledBidirectionalText:F}=Ts;if(B&&D.sections.length===1){const Z=B(D.toString(),N);for(const re of Z){const ee=new $u;ee.text=re,ee.sections=D.sections;for(let te=0;te<re.length;te++)ee.sectionIndex.push(0);z.push(ee)}}else if(F){const Z=F(D.text,D.sectionIndex,N);for(const re of Z){const ee=new $u;ee.text=re[0],ee.sectionIndex=re[1],ee.sections=D.sections,z.push(ee)}}else z=function(Z,re){const ee=[],te=Z.text;let pe=0;for(const ne of re)ee.push(Z.substring(pe,ne)),pe=ne;return pe<te.length&&ee.push(Z.substring(pe,te.length)),ee}(D,N);const U=[],q={positionedLines:U,text:D.toString(),top:p[1],bottom:p[1],left:p[0],right:p[0],writingMode:x,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(Z,re,ee,te,pe,ne,me,be,ve,Me,Ee,Oe){let Ce=0,ke=0,rt=0;const tt=be==="right"?1:be==="left"?0:.5;let Ct=!1;for(const Lt of pe){const ei=Lt.getSections();for(const _i of ei){if(_i.image)continue;const ri=re[_i.fontStack];if(ri&&(Ct=ri.ascender!==void 0&&ri.descender!==void 0,!Ct))break}if(!Ct)break}let ot=0;for(const Lt of pe){Lt.trim();const ei=Lt.getMaxScale(),_i=(ei-1)*Tn,ri={positionedGlyphs:[],lineOffset:0};Z.positionedLines[ot]=ri;const Ei=ri.positionedGlyphs;let mi=0;if(!Lt.length()){ke+=ne,++ot;continue}let Ai=0,Ni=0;for(let ti=0;ti<Lt.length();ti++){const Di=Lt.getSection(ti),vr=Lt.getSectionIndex(ti),Mr=Lt.getCodePoint(ti);let Pr=Di.scale,Dr=null,cr=null,on=null,qn=Tn,Hr=0;ve===fs.vertical&&((ut=Mr)===12312||ut===12313||ut===12316||ut===12540||ut===12448)&&(ve=fs.horizontal);const Qr=!(ve===fs.horizontal||!Ee&&!bu(Mr)||Ee&&(sm[Mr]||Sp(Mr)));if(Di.image){const Rn=te.get(Di.image.toString());if(!Rn)continue;on=Di.image,Z.iconsInText=Z.iconsInText||!0,cr=Rn.paddedRect;const mn=Rn.displaySize;Pr=Pr*Tn/Oe,Dr={width:mn[0],height:mn[1],left:0,top:-3,advance:Qr?mn[1]:mn[0],localGlyph:!1},Hr=Ct?-Dr.height*Pr:ei*Tn-17-mn[1]*Pr,qn=Dr.advance;const Us=(Qr?mn[0]:mn[1])*Pr-Tn*ei;Us>0&&Us>mi&&(mi=Us)}else{const Rn=ee[Di.fontStack];if(!Rn)continue;Rn[Mr]&&(cr=Rn[Mr]);const mn=re[Di.fontStack];if(!mn)continue;const Us=mn.glyphs[Mr];if(!Us)continue;if(Dr=Us.metrics,qn=Mr!==8203?Tn:0,Ct){const Sl=mn.ascender!==void 0?Math.abs(mn.ascender):0,to=mn.descender!==void 0?Math.abs(mn.descender):0,Co=(Sl+to)*Pr;Ai<Co&&(Ai=Co,Ni=(Sl-to)/2*Pr),Hr=-Sl*Pr}else Hr=(ei-Pr)*Tn-17}Qr?(Z.verticalizable=!0,Ei.push({glyph:Mr,image:on,x:Ce,y:ke+Hr,vertical:Qr,scale:Pr,localGlyph:Dr.localGlyph,fontStack:Di.fontStack,sectionIndex:vr,metrics:Dr,rect:cr}),Ce+=qn*Pr+Me):(Ei.push({glyph:Mr,image:on,x:Ce,y:ke+Hr,vertical:Qr,scale:Pr,localGlyph:Dr.localGlyph,fontStack:Di.fontStack,sectionIndex:vr,metrics:Dr,rect:cr}),Ce+=Dr.advance*Pr+Me)}Ei.length!==0&&(rt=Math.max(Ce-Me,rt),Ct?sx(Ei,tt,mi,Ni,ne*ei/2):sx(Ei,tt,mi,0,ne/2)),Ce=0;const hr=ne*ei+mi;ri.lineOffset=Math.max(mi,_i),ke+=hr,++ot}var ut;const nt=ke,{horizontalAlign:Ht,verticalAlign:Et}=Ng(me);(function(Lt,ei,_i,ri,Ei,mi){const Ai=(ei-_i)*Ei,Ni=-mi*ri;for(const hr of Lt)for(const ti of hr.positionedGlyphs)ti.x+=Ai,ti.y+=Ni})(Z.positionedLines,tt,Ht,Et,rt,nt),Z.top+=-Et*nt,Z.bottom=Z.top+nt,Z.left+=-Ht*rt,Z.right=Z.left+rt,Z.hasBaseline=Ct}(q,e,i,o,z,h,_,y,x,w,S,T),!function(Z){for(const re of Z)if(re.positionedGlyphs.length!==0)return!1;return!0}(U))return q}const sm={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},DS={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function tx(n,e,i,o,l,a){if(e.image){const h=o.get(e.image.toString());return h?h.displaySize[0]*e.scale*Tn/a+l:0}{const h=i[e.fontStack],_=h&&h.glyphs[n];return _?_.metrics.advance*e.scale+l:0}}function ix(n,e,i,o){const l=Math.pow(n-e,2);return o?n<e?l/2:2*l:l+Math.abs(i)*i}function zS(n,e,i){let o=0;return n===10&&(o-=1e4),i&&(o+=150),n!==40&&n!==65288||(o+=50),e!==41&&e!==65289||(o+=50),o}function rx(n,e,i,o,l,a){let h=null,_=ix(e,i,l,a);for(const y of o){const w=ix(e-y.x,i,l,a)+y.badness;w<=_&&(h=y,_=w)}return{index:n,x:e,priorBreak:h,badness:_}}function nx(n){return n?nx(n.priorBreak).concat(n.index):[]}function Ng(n){let e=.5,i=.5;switch(n){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(n){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function sx(n,e,i,o,l){if(!(e||i||o||l))return;const a=n.length-1,h=n[a],_=(h.x+h.metrics.advance*h.scale)*e;for(let y=0;y<=a;y++)n[y].x-=_,n[y].y+=i+o+l}function LS(n,e,i,o){const{horizontalAlign:l,verticalAlign:a}=Ng(o),h=i[0]-n.displaySize[0]*l,_=i[1]-n.displaySize[1]*a;return{imagePrimary:n,imageSecondary:e,top:_,bottom:_+n.displaySize[1],left:h,right:h+n.displaySize[0]}}function ox(n,e,i,o,l,a){const h=n.imagePrimary;let _;if(h.content){const D=h.content,z=h.pixelRatio||1;_=[D[0]/z,D[1]/z,h.displaySize[0]-D[2]/z,h.displaySize[1]-D[3]/z]}const y=e.left*a,w=e.right*a;let p,x,S,b;i==="width"||i==="both"?(b=l[0]+y-o[3],x=l[0]+w+o[1]):(b=l[0]+(y+w-h.displaySize[0])/2,x=b+h.displaySize[0]);const T=e.top*a,M=e.bottom*a;return i==="height"||i==="both"?(p=l[1]+T-o[0],S=l[1]+M+o[2]):(p=l[1]+(T+M-h.displaySize[1])/2,S=p+h.displaySize[1]),{imagePrimary:h,imageSecondary:void 0,top:p,right:x,bottom:S,left:b,collisionPadding:_}}class ba extends we{constructor(e,i,o,l,a){super(e,i),this.angle=l,this.z=o,a!==void 0&&(this.segment=a)}clone(){return new ba(this.x,this.y,this.z,this.angle,this.segment)}}function ax(n,e,i,o,l){if(e.segment===void 0)return!0;let a=e,h=e.segment+1,_=0;for(;_>-i/2;){if(h--,h<0)return!1;_-=n[h].dist(a),a=n[h]}_+=n[h].dist(n[h+1]),h++;const y=[];let w=0;for(;_<i/2;){const p=n[h],x=n[h+1];if(!x)return!1;let S=n[h-1].angleTo(p)-p.angleTo(x);for(S=Math.abs((S+3*Math.PI)%(2*Math.PI)-Math.PI),y.push({distance:_,angleDelta:S}),w+=S;_-y[0].distance>o;)w-=y.shift().angleDelta;if(w>l)return!1;h++,_+=p.dist(x)}return!0}function lx(n){let e=0;for(let i=0;i<n.length-1;i++)e+=n[i].dist(n[i+1]);return e}function cx(n,e,i){return n?.6*e*i:0}function ux(n,e){return Math.max(n?n.right-n.left:0,e?e.right-e.left:0)}function OS(n,e,i,o,l,a){const h=cx(i,l,a),_=ux(i,o)*a;let y=0;const w=lx(n)/2;for(let p=0;p<n.length-1;p++){const x=n[p],S=n[p+1],b=x.dist(S);if(y+b>w){const T=(w-y)/b,M=Xt(x.x,S.x,T),D=Xt(x.y,S.y,T),z=new ba(M,D,0,S.angleTo(x),p);return!h||ax(n,z,_,h,e)?z:void 0}y+=b}}function kS(n,e,i,o,l,a,h,_,y){const w=cx(o,a,h),p=ux(o,l),x=p*h,S=n[0].x===0||n[0].x===y||n[0].y===0||n[0].y===y;return e-x<e/4&&(e=x+e/4),hx(n,S?e/2*_%e:(p/2+2*a)*h*_%e,e,w,i,x,S,!1,y)}function hx(n,e,i,o,l,a,h,_,y){const w=a/2,p=lx(n);let x=0,S=e-i,b=[];for(let T=0;T<n.length-1;T++){const M=n[T],D=n[T+1],z=M.dist(D),N=D.angleTo(M);for(;S+i<x+z;){S+=i;const B=(S-x)/z,F=Xt(M.x,D.x,B),U=Xt(M.y,D.y,B);if(F>=0&&F<y&&U>=0&&U<y&&S-w>=0&&S+w<=p){const q=new ba(F,U,0,N,T);o&&!ax(n,q,a,o,l)||b.push(q)}}x+=z}return _||b.length||h||(b=hx(n,x/2,i,o,l,a,h,!0,y)),b}function dx(n,e,i,o,l){const a=[];for(let h=0;h<n.length;h++){const _=n[h];let y;for(let w=0;w<_.length-1;w++){let p=_[w],x=_[w+1];p.x<e&&x.x<e||(p.x<e?p=new we(e,p.y+(e-p.x)/(x.x-p.x)*(x.y-p.y))._round():x.x<e&&(x=new we(e,p.y+(e-p.x)/(x.x-p.x)*(x.y-p.y))._round()),p.y<i&&x.y<i||(p.y<i?p=new we(p.x+(i-p.y)/(x.y-p.y)*(x.x-p.x),i)._round():x.y<i&&(x=new we(p.x+(i-p.y)/(x.y-p.y)*(x.x-p.x),i)._round()),p.x>=o&&x.x>=o||(p.x>=o?p=new we(o,p.y+(o-p.x)/(x.x-p.x)*(x.y-p.y))._round():x.x>=o&&(x=new we(o,p.y+(o-p.x)/(x.x-p.x)*(x.y-p.y))._round()),p.y>=l&&x.y>=l||(p.y>=l?p=new we(p.x+(l-p.y)/(x.y-p.y)*(x.x-p.x),l)._round():x.y>=l&&(x=new we(p.x+(l-p.y)/(x.y-p.y)*(x.x-p.x),l)._round()),y&&p.equals(y[y.length-1])||(y=[p],a.push(y)),y.push(x)))))}}return a}function fx(n){let e=0,i=0;for(const h of n)e+=h.w*h.h,i=Math.max(i,h.w);n.sort((h,_)=>_.h-h.h);const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let l=0,a=0;for(const h of n)for(let _=o.length-1;_>=0;_--){const y=o[_];if(!(h.w>y.w||h.h>y.h)){if(h.x=y.x,h.y=y.y,a=Math.max(a,h.y+h.h),l=Math.max(l,h.x+h.w),h.w===y.w&&h.h===y.h){const w=o.pop();_<o.length&&(o[_]=w)}else h.h===y.h?(y.x+=h.w,y.w-=h.w):h.w===y.w?(y.y+=h.h,y.h-=h.h):(o.push({x:y.x+h.w,y:y.y,w:y.w-h.w,h:h.h}),y.y+=h.h,y.h-=h.h);break}}return{w:l,h:a,fill:e/(l*a)||0}}It(ba,"Anchor");const Hu=1;class Jd{static getImagePositionScale(e,i,o){if(i&&e&&e.options&&e.options.transform){const l=e.options.transform;return{x:l.a,y:l.d}}return{x:o,y:o}}constructor(e,i,o,l){this.paddedRect=e;const{pixelRatio:a,version:h,stretchX:_,stretchY:y,content:w,sdf:p,usvg:x}=i;this.pixelRatio=a,this.stretchX=_,this.stretchY=y,this.content=w,this.version=h,this.padding=o,this.sdf=p,this.scale=Jd.getImagePositionScale(l,x,a)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function px(n,e,i){const o=Zs.parse(n),l=function(a,h,_=[1,1]){return{x:0,y:0,w:(a.data?a.data.width:a.width*_[0])+2*h,h:(a.data?a.data.height:a.height*_[1])+2*h}}(e,i,[o.options.transform.a,o.options.transform.d]);return{bin:l,imagePosition:new Jd(l,e,i,o),imageVariant:o}}class mx{constructor(e,i,o){const l=new Map,a=new Map;this.haveRenderCallbacks=[];const h=[];this.addImages(e,l,Hu,h),this.addImages(i,a,2,h);const{w:_,h:y}=fx(h),w=new wn({width:_||1,height:y||1});for(const[p,x]of e.entries()){const S=l.get(p).paddedRect;wn.copy(x.data,w,{x:0,y:0},{x:S.x+Hu,y:S.y+Hu},x.data,o,x.sdf)}for(const[p,x]of i.entries()){const S=a.get(p),b=S.paddedRect;let T=S.padding;const M=b.x+T,D=b.y+T,z=x.data.width,N=x.data.height;T=T>1?T-1:T,wn.copy(x.data,w,{x:0,y:0},{x:M,y:D},x.data,o),wn.copy(x.data,w,{x:0,y:N-T},{x:M,y:D-T},{width:z,height:T},o),wn.copy(x.data,w,{x:0,y:0},{x:M,y:D+N},{width:z,height:T},o),wn.copy(x.data,w,{x:z-T,y:0},{x:M-T,y:D},{width:T,height:N},o),wn.copy(x.data,w,{x:0,y:0},{x:M+z,y:D},{width:T,height:N},o),wn.copy(x.data,w,{x:z-T,y:N-T},{x:M-T,y:D-T},{width:T,height:T},o),wn.copy(x.data,w,{x:0,y:N-T},{x:M+z,y:D-T},{width:T,height:T},o),wn.copy(x.data,w,{x:0,y:0},{x:M+z,y:D+N},{width:T,height:T},o),wn.copy(x.data,w,{x:z-T,y:0},{x:M-T,y:D+N},{width:T,height:T},o)}this.lut=o,this.image=w,this.iconPositions=l,this.patternPositions=a}addImages(e,i,o,l){for(const[a,h]of e.entries()){const{bin:_,imagePosition:y,imageVariant:w}=px(a,h,o);i.set(a,y),l.push(_),h.hasRenderCallback&&this.haveRenderCallbacks.push(w.id)}}patchUpdatedImages(e,i,o){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(l=>e.hasImage(l,o)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,o);for(const l of e.getUpdatedImages(o)){for(const a of this.iconPositions.keys()){const h=Zs.parse(a);if(Vn.isEqual(h.id,l)){const _=e.getImage(l,o);this.patchUpdatedImage(this.iconPositions.get(a),_,i)}}for(const a of this.patternPositions.keys()){const h=Zs.parse(a);if(Vn.isEqual(h.id,l)){const _=e.getImage(l,o);this.patchUpdatedImage(this.patternPositions.get(a),_,i)}}}}patchUpdatedImage(e,i,o){if(!e||!i||e.version===i.version)return;e.version=i.version;const[l,a]=e.tl,h=e.sdf;if(this.lut||h){const _={width:i.data.width,height:i.data.height},y=new wn(_);wn.copy(i.data,y,{x:0,y:0},{x:0,y:0},_,this.lut,h),o.update(y,{position:{x:l,y:a}})}else o.update(i.data,{position:{x:l,y:a}})}}It(Jd,"ImagePosition"),It(mx,"ImageAtlas");const om=1e20;function _x(n,e,i,o,l,a,h,_,y){for(let w=e;w<e+o;w++)gx(n,i*a+w,a,l,h,_,y);for(let w=i;w<i+l;w++)gx(n,w*a+e,1,o,h,_,y)}function gx(n,e,i,o,l,a,h){a[0]=0,h[0]=-1e20,h[1]=om,l[0]=n[e];for(let _=1,y=0,w=0;_<o;_++){l[_]=n[e+_*i];const p=_*_;do{const x=a[y];w=(l[_]-l[x]+p-x*x)/(_-x)/2}while(w<=h[y]&&--y>-1);y++,a[y]=_,h[y]=w,h[y+1]=om}for(let _=0,y=0;_<o;_++){for(;h[y+1]<_;)y++;const w=a[y],p=_-w;n[e+_*i]=l[w]+p*p}}const Eo=2,Vg={none:0,ideographs:1,all:2};class Zu{constructor(e,i,o){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=o,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,i){this.urls[i]=e}getGlyphs(e,i,o){const l=[],a=this.urls[i]||X.GLYPHS_URL;for(const h in e)for(const _ of e[h])l.push({stack:h,id:_});gr(l,({stack:h,id:_},y)=>{let w=this.entries[h];w||(w=this.entries[h]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let p=w.glyphs[_];if(p!==void 0)return void y(null,{stack:h,id:_,glyph:p});if(p=this._tinySDF(w,h,_),p)return w.glyphs[_]=p,void y(null,{stack:h,id:_,glyph:p});const x=Math.floor(_/256);if(256*x>65535)return br("glyphs > 65535 not supported"),void y(null,{stack:h,id:_,glyph:p});if(w.ranges[x])return void y(null,{stack:h,id:_,glyph:p});let S=w.requests[x];S||(S=w.requests[x]=[],Zu.loadGlyphRange(h,x,a,this.requestManager,(b,T)=>{if(T){w.ascender=T.ascender,w.descender=T.descender;for(const M in T.glyphs)this._doesCharSupportLocalGlyph(+M)||(w.glyphs[+M]=T.glyphs[+M]);w.ranges[x]=!0}for(const M of S)M(b,T);delete w.requests[x]})),S.push((b,T)=>{b?y(b):T&&y(null,{stack:h,id:_,glyph:T.glyphs[_]||null})})},(h,_)=>{if(h)o(h);else if(_){const y={};for(const{stack:w,id:p,glyph:x}of _)y[w]===void 0&&(y[w]={}),y[w].glyphs===void 0&&(y[w].glyphs={}),y[w].glyphs[p]=x&&{id:x.id,bitmap:x.bitmap.clone(),metrics:x.metrics},y[w].ascender=this.entries[w].ascender,y[w].descender=this.entries[w].descender;o(null,y)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Vg.none&&(this.localGlyphMode===Vg.all?!!this.localFontFamily:!!this.localFontFamily&&($t["CJK Unified Ideographs"](e)||$t["Hangul Syllables"](e)||$t.Hiragana(e)||$t.Katakana(e)||$t["CJK Symbols and Punctuation"](e)||$t["CJK Unified Ideographs Extension A"](e)||$t["CJK Unified Ideographs Extension B"](e)||$t.Osage(e)))}_tinySDF(e,i,o){const l=this.localFontFamily;if(!l||!this._doesCharSupportLocalGlyph(o))return;let a=e.tinySDF;if(!a){let M="400";/bold/i.test(i)?M="900":/medium/i.test(i)?M="500":/light/i.test(i)&&(M="200"),a=e.tinySDF=new Zu.TinySDF({fontFamily:l,fontWeight:M,fontSize:24*Eo,buffer:3*Eo,radius:8*Eo}),a.fontWeight=M}if(this.localGlyphs[a.fontWeight][o])return this.localGlyphs[a.fontWeight][o];const h=String.fromCodePoint(o),{data:_,width:y,height:w,glyphWidth:p,glyphHeight:x,glyphLeft:S,glyphTop:b,glyphAdvance:T}=a.draw(h);return this.localGlyphs[a.fontWeight][o]={id:o,bitmap:new gl({width:y,height:w},_),metrics:{width:p/Eo,height:x/Eo,left:S/Eo,top:b/Eo-27,advance:T/Eo,localGlyph:!0}}}}Zu.loadGlyphRange=function(n,e,i,o,l){const a=256*e,h=a+255,_=o.transformRequest(o.normalizeGlyphsURL(i).replace("{fontstack}",n).replace("{range}",`${a}-${h}`),ln.Glyphs);so(_,(y,w)=>{if(y)l(y);else if(w){const p={},x=function(S){return new nm(S).readFields(IS,{})}(w);for(const S of x.glyphs)p[S.id]=S;l(null,{glyphs:p,ascender:x.ascender,descender:x.descender})}})},Zu.TinySDF=class{constructor({fontSize:n=24,buffer:e=3,radius:i=8,cutoff:o=.25,fontFamily:l="sans-serif",fontWeight:a="normal",fontStyle:h="normal"}={}){this.buffer=e,this.cutoff=o,this.radius=i;const _=this.size=n+4*e,y=this._createCanvas(_),w=this.ctx=y.getContext("2d",{willReadFrequently:!0});w.font=`${h} ${a} ${n}px ${l}`,w.textBaseline="alphabetic",w.textAlign="left",w.fillStyle="black",this.gridOuter=new Float64Array(_*_),this.gridInner=new Float64Array(_*_),this.f=new Float64Array(_),this.z=new Float64Array(_+1),this.v=new Uint16Array(_)}_createCanvas(n){const e=document.createElement("canvas");return e.width=e.height=n,e}draw(n){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:o,actualBoundingBoxLeft:l,actualBoundingBoxRight:a}=this.ctx.measureText(n),h=Math.ceil(i),_=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(a-l))),y=Math.min(this.size-this.buffer,h+Math.ceil(o)),w=_+2*this.buffer,p=y+2*this.buffer,x=Math.max(w*p,0),S=new Uint8ClampedArray(x),b={data:S,width:w,height:p,glyphWidth:_,glyphHeight:y,glyphTop:h,glyphLeft:0,glyphAdvance:e};if(_===0||y===0)return b;const{ctx:T,buffer:M,gridInner:D,gridOuter:z}=this;T.clearRect(M,M,_,y),T.fillText(n,M,M+h);const N=T.getImageData(M,M,_,y);z.fill(om,0,x),D.fill(0,0,x);for(let B=0;B<y;B++)for(let F=0;F<_;F++){const U=N.data[4*(B*_+F)+3]/255;if(U===0)continue;const q=(B+M)*w+F+M;if(U===1)z[q]=0,D[q]=om;else{const Z=.5-U;z[q]=Z>0?Z*Z:0,D[q]=Z<0?Z*Z:0}}_x(z,0,0,w,p,w,this.f,this.v,this.z),_x(D,M,M,_,y,w,this.f,this.v,this.z);for(let B=0;B<x;B++){const F=Math.sqrt(z[B])-Math.sqrt(D[B]);S[B]=Math.round(255-255*(F/this.radius+this.cutoff))}return b}};const Mc=Hu;function yx(n,e){return n+e[1]-e[0]}function vx(n,e,i,o,l=1){const a=[],h=n.imagePrimary,_=h.pixelRatio,y=h.paddedRect.w-2*Mc,w=h.paddedRect.h-2*Mc,p=(n.right-n.left)*l,x=(n.bottom-n.top)*l,S=h.stretchX||[[0,y]],b=h.stretchY||[[0,w]],T=S.reduce(yx,0),M=b.reduce(yx,0),D=y-T,z=w-M;let N=0,B=T,F=0,U=M,q=0,Z=D,re=0,ee=z;if(h.content&&o){const pe=h.content;N=am(S,0,pe[0]),F=am(b,0,pe[1]),B=am(S,pe[0],pe[2]),U=am(b,pe[1],pe[3]),q=pe[0]-N,re=pe[1]-F,Z=pe[2]-pe[0]-B,ee=pe[3]-pe[1]-U}const te=(pe,ne,me,be)=>{const ve=lm(pe.stretch-N,B,p,n.left*l),Me=cm(pe.fixed-q,Z,pe.stretch,T),Ee=lm(ne.stretch-F,U,x,n.top*l),Oe=cm(ne.fixed-re,ee,ne.stretch,M),Ce=lm(me.stretch-N,B,p,n.left*l),ke=cm(me.fixed-q,Z,me.stretch,T),rt=lm(be.stretch-F,U,x,n.top*l),tt=cm(be.fixed-re,ee,be.stretch,M),Ct=new we(ve,Ee),ot=new we(Ce,Ee),ut=new we(Ce,rt),nt=new we(ve,rt),Ht=new we(Me/_,Oe/_),Et=new we(ke/_,tt/_),Lt=e*Math.PI/180;if(Lt){const Ai=Math.sin(Lt),Ni=Math.cos(Lt),hr=[Ni,-Ai,Ai,Ni];Ct._matMult(hr),ot._matMult(hr),nt._matMult(hr),ut._matMult(hr)}const ei=pe.stretch+pe.fixed,_i=me.stretch+me.fixed,ri=ne.stretch+ne.fixed,Ei=be.stretch+be.fixed,mi=n.imageSecondary;return{tl:Ct,tr:ot,bl:nt,br:ut,texPrimary:{x:h.paddedRect.x+Mc+ei,y:h.paddedRect.y+Mc+ri,w:_i-ei,h:Ei-ri},texSecondary:mi?{x:mi.paddedRect.x+Mc+ei,y:mi.paddedRect.y+Mc+ri,w:_i-ei,h:Ei-ri}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Ht,pixelOffsetBR:Et,minFontScaleX:Z/_/p,minFontScaleY:ee/_/x,isSDF:i}};if(o&&(h.stretchX||h.stretchY)){const pe=xx(S,D,T),ne=xx(b,z,M);for(let me=0;me<pe.length-1;me++){const be=pe[me],ve=pe[me+1];for(let Me=0;Me<ne.length-1;Me++)a.push(te(be,ne[Me],ve,ne[Me+1]))}}else a.push(te({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:y+1},{fixed:0,stretch:w+1}));return a}function am(n,e,i){let o=0;for(const l of n)o+=Math.max(e,Math.min(i,l[1]))-Math.max(e,Math.min(i,l[0]));return o}function xx(n,e,i){const o=[{fixed:-1,stretch:0}];for(const[l,a]of n){const h=o[o.length-1];o.push({fixed:l-h.stretch,stretch:h.stretch}),o.push({fixed:l-h.stretch,stretch:h.stretch+(a-l)})}return o.push({fixed:e+Mc,stretch:i}),o}function lm(n,e,i,o){return n/e*i+o}function cm(n,e,i,o){return n-e*i/o}function FS(n,e,i,o){const l=e+n.positionedLines[o].lineOffset;return o===0?i+l/2:i+(l+(e+n.positionedLines[o-1].lineOffset))/2}function BS(n,e=1,i=!1){let o=1/0,l=1/0,a=-1/0,h=-1/0;const _=n[0];for(let b=0;b<_.length;b++){const T=_[b];(!b||T.x<o)&&(o=T.x),(!b||T.y<l)&&(l=T.y),(!b||T.x>a)&&(a=T.x),(!b||T.y>h)&&(h=T.y)}const y=Math.min(a-o,h-l);let w=y/2;const p=new Xl([],NS);if(y===0)return new we(o,l);for(let b=o;b<a;b+=y)for(let T=l;T<h;T+=y)p.push(new Wu(b+w,T+w,w,n));let x=function(b){let T=0,M=0,D=0;const z=b[0];for(let N=0,B=z.length,F=B-1;N<B;F=N++){const U=z[N],q=z[F],Z=U.x*q.y-q.x*U.y;M+=(U.x+q.x)*Z,D+=(U.y+q.y)*Z,T+=3*Z}return new Wu(M/T,D/T,0,b)}(n),S=p.length;for(;p.length;){const b=p.pop();(b.d>x.d||!x.d)&&(x=b,i&&console.log("found best %d after %d probes",Math.round(1e4*b.d)/1e4,S)),b.max-x.d<=e||(w=b.h/2,p.push(new Wu(b.p.x-w,b.p.y-w,w,n)),p.push(new Wu(b.p.x+w,b.p.y-w,w,n)),p.push(new Wu(b.p.x-w,b.p.y+w,w,n)),p.push(new Wu(b.p.x+w,b.p.y+w,w,n)),S+=4)}return i&&(console.log(`num probes: ${S}`),console.log(`best distance: ${x.d}`)),x.p}function NS(n,e){return e.max-n.max}class Wu{constructor(e,i,o,l){this.p=new we(e,i),this.h=o,this.d=function(a,h){let _=!1,y=1/0;for(let w=0;w<h.length;w++){const p=h[w];for(let x=0,S=p.length,b=S-1;x<S;b=x++){const T=p[x],M=p[b];T.y>a.y!=M.y>a.y&&a.x<(M.x-T.x)*(a.y-T.y)/(M.y-T.y)+T.x&&(_=!_),y=Math.min(y,fe(a,T,M))}}return(_?1:-1)*Math.sqrt(y)}(this.p,l),this.max=this.d+this.h*Math.SQRT2}}const Ug=Number.POSITIVE_INFINITY,VS=Math.sqrt(2);function bx(n,[e,i]){let o=0,l=0;if(i===Ug){e<0&&(e=0);const a=e/VS;switch(n){case"top-right":case"top-left":l=a-7;break;case"bottom-right":case"bottom-left":l=7-a;break;case"bottom":l=7-e;break;case"top":l=e-7}switch(n){case"top-right":case"bottom-right":o=-a;break;case"top-left":case"bottom-left":o=a;break;case"left":o=e;break;case"right":o=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),n){case"top-right":case"top-left":case"top":l=i-7;break;case"bottom-right":case"bottom-left":case"bottom":l=7-i}switch(n){case"top-right":case"bottom-right":case"right":o=-e;break;case"top-left":case"bottom-left":case"left":o=e}}return[o,l]}function wx(n,e,i,o,l,a,h,_){if(!n)return;const y=Y0(e,i,o,l,a);return n.scaleSelf(y*_*h)}function Tx(n,e,i,o,l,a,h,_){return{iconPrimary:wx(n.getPrimary(),e,i,o,l,a,h,_),iconSecondary:wx(n.getSecondary(),e,i,o,l,a,h,_)}}function Sx(n,e,i,o){if(!n)return;const l=e.get(i.toString());if(n.imagePrimary=l,o){const a=e.get(o.toString());n.imageSecondary=a}}function US(n,e){for(const i in n.horizontal)Ex(n.horizontal[i],e);Ex(n.vertical,e)}function Ex(n,e){if(n){for(const i of n.positionedLines)for(const o of i.positionedGlyphs)if(o.image!==null){const l=o.image.toString();o.rect=e.get(l).paddedRect}}}function jg(n){switch(n){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function jS(n,e,i,o,l,a,h,_,y){const w=Gg(a.horizontal)||a.vertical,p=i.get("icon-text-fit-padding").evaluate(o,{},l);let x,S=e;return e&&y!=="none"&&(n.allowVerticalPlacement&&a.vertical&&(x=ox(e,a.vertical,y,p,_,h)),w&&(S=ox(e,w,y,p,_,h))),{defaultShapedIcon:S,verticallyShapedIcon:x}}function GS(n,e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D,z,N,B){let F=h.textMaxSize.evaluate(e,{},S);F===void 0?F=_*h.textScaleFactor:F*=h.textScaleFactor;const U=n.layers[0].layout,q=Gg(i.horizontal)||i.vertical,Z=b.name==="globe",re=Tn,ee=n.tilePixelRatio*F/re,te=(Me=n.overscaling,n.zoom>18&&Me>2&&(Me>>=1),Math.max(ht/(512*Me),1)*U.get("symbol-spacing")),pe=U.get("text-padding")*n.tilePixelRatio,ne=U.get("icon-padding")*n.tilePixelRatio,me=xt(U.get("text-max-angle")),be=U.get("icon-rotation-alignment")==="map"&&B!=="point",ve=te/2;var Me;n.hasAnyIconTextFit===!1&&D!=="none"&&(n.hasAnyIconTextFit=!0);const Ee=e.properties?+e.properties[Tc]:null,Oe=Ee&&n.elevationFeatureIdToIndex?n.elevationFeatureIdToIndex.get(Ee):65535,Ce=(ke,rt,tt)=>{if(rt.x<0||rt.x>=ht||rt.y<0||rt.y>=ht)return;let Ct=null;if(Z){const{x:ot,y:ut,z:nt}=b.projectTilePoint(rt.x,rt.y,tt);Ct={anchor:new ba(ot,ut,nt,0,void 0),up:b.upVector(tt,rt.x,rt.y)}}(function(ot,ut,nt,Ht,Et,Lt,ei,_i,ri,Ei,mi,Ai,Ni,hr,ti,Di,vr,Mr,Pr,Dr,cr,on,qn,Hr,Qr,Rn,mn,Us,Sl){const to=ot.addToLineVertexArray(ut,Ht);let Co,El,Ml,Rc,ab,lb,cb,ub=0,hb=0,db=0,fb=0,wy=-1,Ty=-1;const Xo={};let pb=os("");const Dc=nt?nt.anchor:ut,Sy=Us!=="none";let Ey=0,My=0;if(ri._unevaluatedLayout.getValue("text-radial-offset")===void 0?[Ey,My]=ri.layout.get("text-offset").evaluate(cr,{},Qr).map(js=>js*Tn):(Ey=ri.layout.get("text-radial-offset").evaluate(cr,{},Qr)*Tn,My=Ug),ot.allowVerticalPlacement&&Et.vertical){const js=Et.vertical;if(ti)lb=qg(js),_i&&(cb=qg(_i));else{const ps=ri.layout.get("text-rotate").evaluate(cr,{},Qr)+90;Ml=um(Ei,Dc,ut,mi,Ai,Ni,js,hr,ps,Di),_i&&(Rc=um(Ei,Dc,ut,mi,Ai,Ni,_i,Mr,ps))}}if(Lt){const js=ot.iconSizeData,ps=ri.layout.get("icon-rotate").evaluate(cr,{},Qr),yf=vx(Lt,ps,qn,Sy,on.iconScaleFactor),Iy=_i?vx(_i,ps,qn,Sy,on.iconScaleFactor):void 0;El=um(Ei,Dc,ut,mi,Ai,Ni,Lt,Mr,ps,null),ub=4*yf.length;let zc=null;js.kind==="source"?(zc=[So*ri.layout.get("icon-size").evaluate(cr,{},Qr)*on.iconScaleFactor],zc[0]>xl&&br(`${ot.layerIds[0]}: Value for "icon-size" is >= ${Qd}. Reduce your "icon-size".`)):js.kind==="composite"&&(zc=[So*on.compositeIconSizes[0].evaluate(cr,{},Qr)*on.iconScaleFactor,So*on.compositeIconSizes[1].evaluate(cr,{},Qr)*on.iconScaleFactor],(zc[0]>xl||zc[1]>xl)&&br(`${ot.layerIds[0]}: Value for "icon-size" is >= ${Qd}. Reduce your "icon-size".`)),ot.addSymbols(ot.icon,yf,zc,Dr,Pr,cr,!1,nt,ut,to.lineStartIndex,to.lineLength,-1,Hr,Qr,Rn,mn),wy=ot.icon.placedSymbolArray.length-1,Iy&&(hb=4*Iy.length,ot.addSymbols(ot.icon,Iy,zc,Dr,Pr,cr,fs.vertical,nt,ut,to.lineStartIndex,to.lineLength,-1,Hr,Qr,Rn,mn),Ty=ot.icon.placedSymbolArray.length-1)}for(const js in Et.horizontal){const ps=Et.horizontal[js];Co||(pb=os(ps.text),ti?ab=qg(ps):Co=um(Ei,Dc,ut,mi,Ai,Ni,ps,hr,ri.layout.get("text-rotate").evaluate(cr,{},Qr),Di));const yf=ps.positionedLines.length===1;if(db+=Mx(ot,nt,ut,ps,ei,ri,ti,cr,Di,to,Et.vertical?fs.horizontal:fs.horizontalOnly,yf?Object.keys(Et.horizontal):[js],Xo,wy,on,Hr,Qr,Rn),yf)break}Et.vertical&&(fb+=Mx(ot,nt,ut,Et.vertical,ei,ri,ti,cr,Di,to,fs.vertical,["vertical"],Xo,Ty,on,Hr,Qr,Rn));let Al=-1;const Ay=(js,ps)=>js?Math.max(js,ps):ps;Al=Ay(ab,Al),Al=Ay(lb,Al),Al=Ay(cb,Al);const bM=Al>-1?1:0;ot.glyphOffsetArray.length>=65535&&br("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),cr.sortKey!==void 0&&ot.addToSortKeyRanges(ot.symbolInstances.length,cr.sortKey),ot.symbolInstances.emplaceBack(ut.x,ut.y,Dc.x,Dc.y,Dc.z,Xo.right>=0?Xo.right:-1,Xo.center>=0?Xo.center:-1,Xo.left>=0?Xo.left:-1,Xo.vertical>=0?Xo.vertical:-1,wy,Ty,pb,Co!==void 0?Co:ot.collisionBoxArray.length,Co!==void 0?Co+1:ot.collisionBoxArray.length,Ml!==void 0?Ml:ot.collisionBoxArray.length,Ml!==void 0?Ml+1:ot.collisionBoxArray.length,El!==void 0?El:ot.collisionBoxArray.length,El!==void 0?El+1:ot.collisionBoxArray.length,Rc||ot.collisionBoxArray.length,Rc?Rc+1:ot.collisionBoxArray.length,mi,db,fb,ub,hb,bM,0,Ey,My,Al,0,Sy?1:0,Sl)})(n,rt,Ct,ke,i,o,a,l,n.layers[0],n.collisionBoxArray,e.index,e.sourceLayerIndex,n.index,pe,N,w,0,ne,be,z,e,h,p,x,S,T,M,D,Oe)};if(B==="line")for(const ke of dx(e.geometry,0,0,ht,ht)){const rt=kS(ke,te,me,i.vertical||q,o,re,ee,n.overscaling,ht);for(const tt of rt)q&&qS(n,q.text,ve,tt)||Ce(ke,tt,S)}else if(B==="line-center"){for(const ke of e.geometry)if(ke.length>1){const rt=OS(ke,me,i.vertical||q,o,re,ee);rt&&Ce(ke,rt,S)}}else if(e.type==="Polygon")for(const ke of Kp(e.geometry,0)){const rt=BS(ke,16);Ce(ke[0],new ba(rt.x,rt.y,0,0,void 0),S)}else if(e.type==="LineString")for(const ke of e.geometry)Ce(ke,new ba(ke[0].x,ke[0].y,0,0,void 0),S);else if(e.type==="Point")for(const ke of e.geometry)for(const rt of ke)Ce([rt],new ba(rt.x,rt.y,0,0,void 0),S)}const Qd=255,xl=Qd*So;function Mx(n,e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D,z){const N=function(U,q,Z,re,ee,te,pe,ne){const me=[];if(q.positionedLines.length===0)return me;const be=re.layout.get("text-rotate").evaluate(te,{})*Math.PI/180,ve=function(ke){const rt=ke[0],tt=ke[1],Ct=rt*tt;return Ct>0?[rt,-tt]:Ct<0?[-rt,tt]:rt===0?[tt,rt]:[tt,-rt]}(Z);let Me=Math.abs(q.top-q.bottom);for(const ke of q.positionedLines)Me-=ke.lineOffset;const Ee=q.positionedLines.length,Oe=Me/Ee;let Ce=q.top-Z[1];for(let ke=0;ke<Ee;++ke){const rt=q.positionedLines[ke];Ce=FS(q,Oe,Ce,ke);for(const tt of rt.positionedGlyphs){if(!tt.rect)continue;const Ct=tt.rect||{};let ot=RS+1,ut=!0,nt=1,Ht=0;if(tt.image){const cr=pe.get(tt.image.toString());if(!cr)continue;if(cr.sdf){br("SDF images are not supported in formatted text and will be ignored.");continue}ut=!1,nt=cr.pixelRatio,ot=Hu/nt}const Et=(ee||ne)&&tt.vertical,Lt=tt.metrics.advance*tt.scale/2,ei=tt.metrics,_i=tt.rect;if(_i===null)continue;ne&&q.verticalizable&&(Ht=tt.image?Lt-tt.metrics.width*tt.scale/2:0);const ri=ee?[tt.x+Lt,tt.y]:[0,0];let Ei=[0,0],mi=[0,0],Ai=!1;ee||(Et?(mi=[tt.x+Lt+ve[0],tt.y+ve[1]-Ht],Ai=!0):Ei=[tt.x+Lt+Z[0],tt.y+Z[1]-Ht]);const Ni=_i.w*tt.scale/(nt*(tt.localGlyph?Eo:1)),hr=_i.h*tt.scale/(nt*(tt.localGlyph?Eo:1));let ti,Di,vr,Mr;if(Et){const cr=tt.y-Ce,on=new we(-Lt,Lt-cr),qn=-Math.PI/2,Hr=new we(...mi);ti=new we(-Lt+Ei[0],Ei[1]),ti._rotateAround(qn,on)._add(Hr),ti.x+=-cr+Lt,ti.y-=(ei.left-ot)*tt.scale;const Qr=tt.image?ei.advance*tt.scale:Tn*tt.scale,Rn=String.fromCodePoint(tt.glyph);ES(Rn)?ti.x+=(1-ot)*tt.scale:MS(Rn)?ti.x+=Qr-ei.height*tt.scale+(-ot-1)*tt.scale:ti.x+=tt.image||ei.width+2*ot===_i.w&&ei.height+2*ot===_i.h?(Qr-hr)/2:(Qr-(ei.height+2*ot)*tt.scale)/2,Di=new we(ti.x,ti.y-Ni),vr=new we(ti.x+hr,ti.y),Mr=new we(ti.x+hr,ti.y-Ni)}else{const cr=(ei.left-ot)*tt.scale-Lt+Ei[0],on=(-ei.top-ot)*tt.scale+Ei[1],qn=cr+Ni,Hr=on+hr;ti=new we(cr,on),Di=new we(qn,on),vr=new we(cr,Hr),Mr=new we(qn,Hr)}if(be){let cr;cr=ee?new we(0,0):Ai?new we(ve[0],ve[1]):new we(Z[0],Z[1]),ti._rotateAround(be,cr),Di._rotateAround(be,cr),vr._rotateAround(be,cr),Mr._rotateAround(be,cr)}const Pr=new we(0,0),Dr=new we(0,0);me.push({tl:ti,tr:Di,bl:vr,br:Mr,texPrimary:Ct,texSecondary:void 0,writingMode:q.writingMode,glyphOffset:ri,sectionIndex:tt.sectionIndex,isSDF:ut,pixelOffsetTL:Pr,pixelOffsetBR:Dr,minFontScaleX:0,minFontScaleY:0})}}return me}(0,o,y,a,h,_,l,n.allowVerticalPlacement),B=n.textSizeData;let F=null;B.kind==="source"?(F=[So*a.layout.get("text-size").evaluate(_,{},D)*T.textScaleFactor],F[0]>xl&&br(`${n.layerIds[0]}: Value for "text-size" is >= ${Qd}. Reduce your "text-size".`)):B.kind==="composite"&&(F=[So*T.compositeTextSizes[0].evaluate(_,{},D)*T.textScaleFactor,So*T.compositeTextSizes[1].evaluate(_,{},D)*T.textScaleFactor],(F[0]>xl||F[1]>xl)&&br(`${n.layerIds[0]}: Value for "text-size" is >= ${Qd}. Reduce your "text-size".`)),n.addSymbols(n.text,N,F,y,h,_,p,e,i,w.lineStartIndex,w.lineLength,b,M,D,z,!1);for(const U of x)S[U]=n.text.placedSymbolArray.length-1;return 4*N.length}function Gg(n){for(const e in n)return n[e];return null}function um(n,e,i,o,l,a,h,_,y,w){let p=h.top,x=h.bottom,S=h.left,b=h.right;const T=h.collisionPadding;if(T&&(S-=T[0],p-=T[1],b+=T[2],x+=T[3]),y){const M=new we(S,p),D=new we(b,p),z=new we(S,x),N=new we(b,x),B=xt(y);let F=new we(0,0);w&&(F=new we(w[0],w[1])),M._rotateAround(B,F),D._rotateAround(B,F),z._rotateAround(B,F),N._rotateAround(B,F),S=Math.min(M.x,D.x,z.x,N.x),b=Math.max(M.x,D.x,z.x,N.x),p=Math.min(M.y,D.y,z.y,N.y),x=Math.max(M.y,D.y,z.y,N.y)}return n.emplaceBack(e.x,e.y,e.z,i.x,i.y,S,p,b,x,_,o,l,a),n.length-1}function qg(n){n.collisionPadding&&(n.top-=n.collisionPadding[1],n.bottom+=n.collisionPadding[3]);const e=n.bottom-n.top;return e>0?Math.max(10,e):null}function qS(n,e,i,o){const l=n.compareText;if(e in l){const a=l[e];for(let h=a.length-1;h>=0;h--)if(o.dist(a[h])<i)return!0}else l[e]=[];return l[e].push(o),!1}function Ax(n,e){const i=n.fovAboveCenter,o=n.elevation?n.elevation.getMinElevationBelowMSL()*e:0,l=(n._camera.position[2]*n.worldSize-o)/Math.cos(n._pitch),a=Math.sin(i)*l/Math.sin(Math.max(Math.PI/2-n._pitch-i,.01));let h=Math.sin(n._pitch)*a+l;const _=l*(1/n._horizonShift);if(!n.elevation||n.elevation.exaggeration()===0){let y=Math.max(n.zoom-17,0);n.isOrthographic&&(y/=10),h*=1+y}return Math.min(1.01*h,_)}function ef(n,e){if(!e.isReprojectedInTileSpace)return{scale:1<<n.z,x:n.x,y:n.y,x2:n.x+1,y2:n.y+1,projection:e};const i=Math.pow(2,-n.z),o=n.x*i,l=(n.x+1)*i,a=n.y*i,h=(n.y+1)*i,_=Kn(o),y=Kn(l),w=fn(a),p=fn(h),x=e.project(_,w),S=e.project(y,w),b=e.project(y,p),T=e.project(_,p);let M=Math.min(x.x,S.x,b.x,T.x),D=Math.min(x.y,S.y,b.y,T.y),z=Math.max(x.x,S.x,b.x,T.x),N=Math.max(x.y,S.y,b.y,T.y);const B=i/16;function F(q,Z,re,ee,te,pe){const ne=(re+te)/2,me=(ee+pe)/2,be=e.project(Kn(ne),fn(me)),ve=Math.max(0,M-be.x,D-be.y,be.x-z,be.y-N);M=Math.min(M,be.x),z=Math.max(z,be.x),D=Math.min(D,be.y),N=Math.max(N,be.y),ve>B&&(F(q,be,re,ee,ne,me),F(be,Z,ne,me,te,pe))}F(x,S,o,a,l,a),F(S,b,l,a,l,h),F(b,T,l,h,o,h),F(T,x,o,h,o,a),M-=B,D-=B,z+=B,N+=B;const U=1/Math.max(z-M,N-D);return{scale:U,x:M*U,y:D*U,x2:z*U,y2:N*U,projection:e}}function Ix(n,{x:e,y:i},o=0){return new we(((e-o)*n.scale-n.x)*ht,(i*n.scale-n.y)*ht)}const $S=J.mat4.identity(new Float32Array(16));class bl{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new Zi(0,0)}projectTilePoint(e,i,o){return{x:e,y:i,z:0}}locationPoint(e,i,o,l=!0){return e._coordinatePoint(e.locationCoordinate(i,o),l)}pixelsPerMeter(e,i){return bn(1,e)*i}pixelSpaceConversion(e,i,o){return 1}farthestPixelDistance(e){return Ax(e,e.pixelsPerMeter)}pointCoordinate(e,i,o,l){const a=e.horizonLineFromTop(!1),h=new we(i,Math.max(a,o));return e.rayIntersectionCoordinate(e.pointRayIntersection(h,l))}pointCoordinate3D(e,i,o){const l=new we(i,o);if(e.elevation)return e.elevation.pointCoordinate(l);{const a=this.pointCoordinate(e,l.x,l.y,0);return[a.x,a.y,a.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const o=e.horizonLineFromTop();return i.y<o}createInversionMatrix(e,i){return $S}createTileMatrix(e,i,o){let l,a,h;const _=o.canonical,y=J.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const w=ef(_,this);l=1,a=w.x+o.wrap*w.scale,h=w.y,J.mat4.scale(y,y,[l/w.scale,l/w.scale,e.pixelsPerMeter/i])}else l=i/e.zoomScale(_.z),a=(_.x+Math.pow(2,_.z)*o.wrap)*l,h=_.y*l;return J.mat4.translate(y,y,[a,h,0]),J.mat4.scale(y,y,[l/ht,l/ht,1]),y}upVector(e,i,o){return[0,0,1]}upVectorScale(e,i,o){return{metersToTile:1}}}class HS extends bl{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,o]=this.parallels=e.parallels||[29.5,45.5],l=Math.sin(xt(i));this.n=(l+Math.sin(xt(o)))/2,this.c=1+l*(2*this.n-l),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:o,c:l,r0:a}=this,h=xt(e-this.center[0]),_=xt(i),y=Math.sqrt(l-2*o*Math.sin(_))/o;return{x:y*Math.sin(h*o),y:y*Math.cos(h*o)-a,z:0}}unproject(e,i){const{n:o,c:l,r0:a}=this,h=a+i;let _=Math.atan2(e,Math.abs(h))*Math.sign(h);h*o<0&&(_-=Math.PI*Math.sign(e)*Math.sign(h));const y=xt(this.center[0])*o;_=Ji(_,-Math.PI-y,Math.PI-y);const w=Dt(Ut(_/o)+this.center[0],-180,180),p=Math.asin(Dt((l-(e*e+h*h)*o*o)/(2*o),-1,1)),x=Dt(Ut(p),-85.051129,jn);return new Zi(w,x)}}const tf=1.340264,rf=-.081106,nf=893e-6,sf=.003796,hm=Math.sqrt(3)/2;class ZS extends bl{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const o=Math.asin(hm*Math.sin(i)),l=o*o,a=l*l*l;return{x:.5*(e*Math.cos(o)/(hm*(tf+3*rf*l+a*(7*nf+9*sf*l)))/Math.PI+.5),y:1-.5*(o*(tf+rf*l+a*(nf+sf*l))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,l=o*o,a=l*l*l;for(let p,x,S,b=0;b<12&&(x=o*(tf+rf*l+a*(nf+sf*l))-i,S=tf+3*rf*l+a*(7*nf+9*sf*l),p=x/S,o=Dt(o-p,-Math.PI/3,Math.PI/3),l=o*o,a=l*l*l,!(Math.abs(p)<1e-12));++b);const h=hm*e*(tf+3*rf*l+a*(7*nf+9*sf*l))/Math.cos(o),_=Math.asin(Math.sin(o)/hm),y=Dt(180*h/Math.PI,-180,180),w=Dt(180*_/Math.PI,-85.051129,jn);return new Zi(y,w)}}class WS extends bl{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const o=360*(e-.5),l=Dt(360*(.5-i),-85.051129,jn);return new Zi(o,l)}}const Xu=Math.PI/2;function dm(n){return Math.tan((Xu+n)/2)}class XS extends bl{constructor(e){super(e),this.center=e.center||[0,30];const[i,o]=this.parallels=e.parallels||[30,30];let l=xt(i),a=xt(o);this.southernCenter=l+a<0,this.southernCenter&&(l=-l,a=-a);const h=Math.cos(l),_=dm(l);this.n=l===a?Math.sin(l):Math.log(h/Math.cos(a))/Math.log(dm(a)/_),this.f=h*Math.pow(dm(l),this.n)/this.n}project(e,i){i=xt(i),this.southernCenter&&(i=-i),e=xt(e-this.center[0]);const o=1e-6,{n:l,f:a}=this;a>0?i<-Xu+o&&(i=-Xu+o):i>Xu-o&&(i=Xu-o);const h=a/Math.pow(dm(i),l);let _=h*Math.sin(l*e),y=a-h*Math.cos(l*e);return _=.5*(_/Math.PI+.5),y=.5*(y/Math.PI+.5),{x:_,y:this.southernCenter?y:1-y,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:o,f:l}=this,a=l-i,h=Math.sign(a),_=Math.sign(o)*Math.sqrt(e*e+a*a);let y=Math.atan2(e,Math.abs(a))*h;a*o<0&&(y-=Math.PI*Math.sign(e)*h);const w=Dt(Ut(y/o)+this.center[0],-180,180),p=Dt(Ut(2*Math.atan(Math.pow(l/_,1/o))-Xu),-85.051129,jn);return new Zi(w,this.southernCenter?-p:p)}}class Cx extends bl{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:Ys(e),y:Xn(i),z:0}}unproject(e,i){const o=Kn(e),l=fn(i);return new Zi(o,l)}}const Px=xt(jn);class KS extends bl{project(e,i){const o=(i=xt(i))*i,l=o*o;return{x:.5*((e=xt(e))*(.8707-.131979*o+l*(l*(.003971*o-.001529*l)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+o*(.015085+l*(.028874*o-.044475-.005916*l)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,l=25,a=0,h=o*o;do{h=o*o;const w=h*h;a=(o*(1.007226+h*(.015085+w*(.028874*h-.044475-.005916*w)))-i)/(1.007226+h*(.045255+w*(.259866*h-.311325-.005916*11*w))),o=Dt(o-a,-Px,Px)}while(Math.abs(a)>1e-6&&--l>0);h=o*o;const _=Dt(Ut(e/(.8707+h*(h*(h*h*h*(.003971-.001529*h)-.013791)-.131979))),-180,180),y=Ut(o);return new Zi(_,y)}}const Rx=xt(jn);class YS extends bl{project(e,i){i=xt(i),e=xt(e);const o=Math.cos(i),l=2/Math.PI,a=Math.acos(o*Math.cos(e/2)),h=Math.sin(a)/a,_=.5*(e*l+2*o*Math.sin(e/2)/h)||0,y=.5*(i+Math.sin(i)/h)||0;return{x:.5*(_/Math.PI+.5),y:1-.5*(y/Math.PI+1),z:0}}unproject(e,i){let o=e=(2*e-.5)*Math.PI,l=i=(2*(1-i)-1)*Math.PI,a=25;const h=1e-6;let _=0,y=0;do{const w=Math.cos(l),p=Math.sin(l),x=2*p*w,S=p*p,b=w*w,T=Math.cos(o/2),M=Math.sin(o/2),D=2*T*M,z=M*M,N=1-b*T*T,B=N?1/N:0,F=N?Math.acos(w*T)*Math.sqrt(1/N):0,U=.5*(2*F*w*M+2*o/Math.PI)-e,q=.5*(F*p+l)-i,Z=.5*B*(b*z+F*w*T*S)+1/Math.PI,re=B*(D*x/4-F*p*M),ee=.125*B*(x*M-F*p*b*D),te=.5*B*(S*T+F*z*w)+.5,pe=re*ee-te*Z;_=(q*re-U*te)/pe,y=(U*ee-q*Z)/pe,o=Dt(o-_,-Math.PI,Math.PI),l=Dt(l-y,-Rx,Rx)}while((Math.abs(_)>h||Math.abs(y)>h)&&--a>0);return new Zi(Ut(o),Ut(l))}}class Dx extends bl{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(xt(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:o,cosPhi:l}=this;return{x:xt(e)*l*o+.5,y:-Math.sin(xt(i))/l*o+.5,z:0}}unproject(e,i){const{scale:o,cosPhi:l}=this,a=-(i-.5)/o,h=Dt(Ut((e-.5)/o)/l,-180,180),_=Math.asin(Dt(a*l,-1,1)),y=Dt(Ut(_),-85.051129,jn);return new Zi(h,y)}}class JS extends Cx{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,o){const l=Xi(e,i,o),a=yr(tn(o));return J.vec3.transformMat4(l,l,a),{x:l[0],y:l[1],z:l[2]}}locationPoint(e,i,o){const l=ya(i.lat,i.lng),a=J.vec3.normalize([],l),h=o?e._centerAltitude+o:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude,_=bn(1,0)*ht*h;J.vec3.scaleAndAdd(l,l,a,_);const y=J.mat4.identity(new Float64Array(16));return J.mat4.multiply(y,e.pixelMatrix,e.globeMatrix),J.vec3.transformMat4(l,l,y),new we(l[0],l[1])}pixelsPerMeter(e,i){return bn(1,0)*i}pixelSpaceConversion(e,i,o){const l=bn(1,e)*i,a=Xt(bn(1,45)*i,l,o);return this.pixelsPerMeter(e,i)/a}createTileMatrix(e,i,o){const l=rn(tn(o.canonical));return J.mat4.multiply(new Float64Array(16),e.globeMatrix,l)}createInversionMatrix(e,i){const{center:o}=e,l=yr(tn(i));return J.mat4.rotateY(l,l,xt(o.lng)),J.mat4.rotateX(l,l,xt(o.lat)),J.mat4.scale(l,l,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(l)}pointCoordinate(e,i,o,l){return Bi(e,i,o,!0)||new t(0,0)}pointCoordinate3D(e,i,o){const l=this.pointCoordinate(e,i,o,0);return[l.x,l.y,l.z]}isPointAboveHorizon(e,i){return!Bi(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=function(l,a){const h=l.cameraToCenterDistance,_=l._centerAltitude*a,y=l._camera,w=l._camera.forward(),p=J.vec3.add([],J.vec3.scale([],w,-h),[0,0,_]),x=l.worldSize/(2*Math.PI),S=[0,0,-x],b=l.width/l.height,T=Math.tan(l.fovAboveCenter),M=J.vec3.scale([],y.up(),T),D=J.vec3.scale([],y.right(),T*b),z=J.vec3.normalize([],J.vec3.add([],J.vec3.add([],w,M),D)),N=[];let B;if(new Yt(p,z).closestPointOnSphere(S,x,N)){const F=J.vec3.add([],N,S),U=J.vec3.sub([],F,p);B=Math.cos(l.fovAboveCenter)*J.vec3.length(U)}else{const F=J.vec3.sub([],p,S),U=J.vec3.sub([],S,p);J.vec3.normalize(U,U);const q=J.vec3.length(F)-x;B=Math.sqrt(q*(q+2*x));const Z=Math.acos(B/(x+q))-Math.acos(J.vec3.dot(w,U));B*=Math.cos(Z)}return 1.01*B}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),o=Gn(e.zoom);if(o>0){const l=Ax(e,bn(1,e.center.lat)*e.worldSize),a=e.worldSize/(2*Math.PI),h=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Xt(i,l+a*(1-Math.cos(h)),Math.pow(o,10))}return i}upVector(e,i,o){return Xi(i,o,e,1)}upVectorScale(e){return{metersToTile:Ri(lr(tn(e)))}}}function zx(n){const e=n.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(n.name){case"mercator":return new Cx(n);case"equirectangular":return new WS(n);case"naturalEarth":return new KS(n);case"equalEarth":return new ZS(n);case"winkelTripel":return new YS(n);case"albers":return i?new Dx(n):new HS(n);case"lambertConformalConic":return i?new Dx(n):new XS(n);case"globe":return new JS(n)}throw new Error(`Invalid projection name: ${n.name}`)}const QS=yl.VectorTileFeature.types,eE=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function fm(n,e,i,o,l,a,h,_,y,w,p,x,S){const b=_?Math.min(xl,Math.round(_[0])):0,T=_?Math.min(xl,Math.round(_[1])):0;n.emplaceBack(e,i,Math.round(32*o),Math.round(32*l),a,h,(b<<1)+(y?1:0),T,16*w,16*p,256*x,256*S)}function pm(n,e,i){n.emplaceBack(e,i)}function mm(n,e,i,o,l,a,h){n.emplaceBack(e,i,o,l,a,h)}function _m(n,e,i,o,l){n.emplaceBack(e,i,o,l),n.emplaceBack(e,i,o,l),n.emplaceBack(e,i,o,l),n.emplaceBack(e,i,o,l)}function tE(n){for(const e of n.sections)if(Ep(e.text))return!0;return!1}class $g{constructor(e){this.layoutVertexArray=new bd,this.indexArray=new dn,this.programConfigurations=e,this.segments=new Tr,this.dynamicLayoutVertexArray=new ma,this.opacityVertexArray=new Td,this.placedSymbolArray=new Lp,this.iconTransitioningVertexArray=new Go,this.globeExtVertexArray=new wd,this.zOffsetVertexArray=new pa}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,i,o,l,a){this.isEmpty()||(o&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,mS.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,gS.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,eE,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,vS.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,_S.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||a)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,yS.members,!0)),this.opacityVertexBuffer.itemSize=1),(o||l)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}It($g,"SymbolBuffers");class Hg{constructor(e,i,o){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new o,this.segments=new Tr,this.collisionVertexArray=new Md,this.collisionVertexArrayExt=new ma}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,xS.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,bS.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}It(Hg,"CollisionBuffers");class gm{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(h=>h.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=J.mat4.identity([]),this.placementViewportMatrix=J.mat4.identity([]);const i=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Lg(this.zoom,i["text-size"]),this.iconSizeData=Lg(this.zoom,i["icon-size"]);const o=this.layers[0].layout,l=o.get("symbol-sort-key"),a=o.get("symbol-z-order");this.canOverlap=o.get("text-allow-overlap")||o.get("icon-allow-overlap")||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=a!=="viewport-y"&&l.constantOr(1)!==void 0,this.sortFeaturesByY=(a==="viewport-y"||a==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=o.get("text-writing-mode").map(h=>fs[h]),this.stateDependentLayerIds=this.layers.filter(h=>h.isStateDependent()).map(h=>h.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new $g(new $o(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new $g(new $o(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new Fp,this.lineVertexArray=new fc,this.symbolInstances=new kp}calculateGlyphDependencies(e,i,o,l,a){for(const h of e){const _=h.codePointAt(0);if(_===void 0)break;if(i[_]=!0,l&&a&&_<=65535){const y=Kd[h];y&&(i[y.charCodeAt(0)]=!0)}}}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Ag(this.activeReplacements,o)&&(this.activeReplacements=o,!0)}populate(e,i,o,l){const a=this.layers[0],h=a.layout,_=this.projection.name==="globe",y=h.get("text-font"),w=h.get("text-field"),p=h.get("icon-image"),[x,S]=h.get("icon-size-scale-range"),b=Dt(i.scaleFactor||1,x,S),T=(w.value.kind!=="constant"||w.value.value instanceof In&&!w.value.value.isEmpty()||w.value.value.toString().length>0)&&(y.value.kind!=="constant"||y.value.value.length>0),M=p.value.kind!=="constant"||!!p.value.value||Object.keys(p.parameters).length>0,D=h.get("symbol-sort-key");if(this.features=[],!T&&!M)return;const z=i.iconDependencies,N=i.glyphDependencies,B=i.availableImages,F=new ur(this.zoom);for(const{feature:U,id:q,index:Z,sourceLayerIndex:re}of e){const ee=a._featureFilter.needGeometry,te=R(U,ee);if(!a._featureFilter.filter(F,te,o))continue;if(ee||(te.geometry=C(U,o,l)),_&&U.type!==1&&o.z<=5){const ve=te.geometry,Me=.98078528056,Ee=(Oe,Ce)=>{const ke=Xi(Oe.x,Oe.y,o,1),rt=Xi(Ce.x,Ce.y,o,1);return J.vec3.dot(ke,rt)<Me};for(let Oe=0;Oe<ve.length;Oe++)ve[Oe]=m(ve[Oe],Ee)}let pe,ne;if(T){const ve=a.getValueAndResolveTokens("text-field",te,o,B),Me=In.factory(ve);tE(Me)&&(this.hasRTLText=!0),(!this.hasRTLText||Su()==="unavailable"||this.hasRTLText&&Ts.isParsed())&&(pe=SS(Me,a,te))}if(M){const ve=a.getValueAndResolveTokens("icon-image",te,o,B);ne=ve instanceof Cn?ve:Cn.build(ve)}if(!pe&&!ne)continue;const me=this.sortFeaturesByKey?D.evaluate(te,{},o):void 0,be={id:q,text:pe,icon:ne,index:Z,sourceLayerIndex:re,geometry:te.geometry,properties:U.properties,type:QS[U.type],sortKey:me};if(this.features.push(be),ne){const ve=this.layers[0]._unevaluatedLayout._values,{iconPrimary:Me,iconSecondary:Ee}=Tx(ne,this.iconSizeData,ve["icon-size"],o,this.zoom,be,this.pixelRatio,b),Oe=Me.id.toString();if(z.has(Oe)?z.get(Oe).push(Me):z.set(Oe,[Me]),Ee){const Ce=Ee.id.toString();z.has(Ce)?z.get(Ce).push(Ee):z.set(Ce,[Ee])}}if(pe){const ve=y.evaluate(te,{},o).join(","),Me=h.get("text-rotation-alignment")==="map"&&h.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(fs.vertical)>=0;for(const Ee of pe.sections)if(Ee.image){const Oe=Ee.image.getPrimary().scaleSelf(this.pixelRatio),Ce=Oe.id.toString(),ke=z.get(Ce)||[];ke.push(Oe),z.set(Ce,ke)}else{const Oe=ad(pe.toString()),Ce=Ee.fontStack||ve,ke=N[Ce]=N[Ce]||{};this.calculateGlyphDependencies(Ee.text,ke,Me,this.allowVerticalPlacement,Oe)}}}if(h.get("symbol-placement")==="line"&&(this.features=function(U){const q={},Z={},re=[];let ee=0;function te(be){re.push(U[be]),ee++}function pe(be,ve,Me){const Ee=Z[be];return delete Z[be],Z[ve]=Ee,re[Ee].geometry[0].pop(),re[Ee].geometry[0]=re[Ee].geometry[0].concat(Me[0]),Ee}function ne(be,ve,Me){const Ee=q[ve];return delete q[ve],q[be]=Ee,re[Ee].geometry[0].shift(),re[Ee].geometry[0]=Me[0].concat(re[Ee].geometry[0]),Ee}function me(be,ve,Me){const Ee=Me?ve[0][ve[0].length-1]:ve[0][0];return`${be}:${Ee.x}:${Ee.y}`}for(let be=0;be<U.length;be++){const ve=U[be],Me=ve.geometry,Ee=ve.text?ve.text.toString():null;if(!Ee){te(be);continue}const Oe=me(Ee,Me),Ce=me(Ee,Me,!0);if(Oe in Z&&Ce in q&&Z[Oe]!==q[Ce]){const ke=ne(Oe,Ce,Me),rt=pe(Oe,Ce,re[ke].geometry);delete q[Oe],delete Z[Ce],Z[me(Ee,re[rt].geometry,!0)]=rt,re[ke].geometry=null}else Oe in Z?pe(Oe,Ce,Me):Ce in q?ne(Oe,Ce,Me):(te(be),q[Oe]=ee-1,Z[Ce]=ee-1)}return re.filter(be=>be.geometry)}(this.features)),h.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const U of i.elevationFeatures)this.elevationFeatureIdToIndex.set(U.id,this.elevationFeatures.length),this.elevationFeatures.push(U)}}else h.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((U,q)=>U.sortKey-q.sortKey)}update(e,i,o,l,a,h,_){this.text.programConfigurations.updatePaintArrays(e,i,a,o,l,h,_),this.icon.programConfigurations.updatePaintArrays(e,i,a,o,l,h,_)}updateRoadElevation(){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let e=!1;for(let i=0;i<this.symbolInstances.length;i++){const o=this.symbolInstances.get(i);if(o.elevationFeatureIndex===65535)continue;const l=this.elevationFeatures[o.elevationFeatureIndex];if(l){const a=.05+l.pointElevation(new we(o.tileAnchorX,o.tileAnchorY));o.zOffset!==a&&(e=!0,o.zOffset=a)}}e&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(a,h,_)=>{o+=h,o>a.length&&a.resize(o);for(let y=-h;y<0;y++)a.emplace(y+o,_)},i=(a,h,_)=>{l+=h,l>a.length&&a.resize(l);for(let y=-h;y<0;y++)a.emplace(y+l,_)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let o=0,l=0;for(let a=0;a<this.symbolInstances.length;a++){const h=this.symbolInstances.get(a),{numHorizontalGlyphVertices:_,numVerticalGlyphVertices:y,numIconVertices:w}=h,p=h.zOffset,x=w>0;if((_>0||y>0)&&(e(this.text.zOffsetVertexArray,_,p),e(this.text.zOffsetVertexArray,y,p)),x){const{placedIconSymbolIndex:S,verticalPlacedIconSymbolIndex:b}=h;S>=0&&i(this.icon.zOffsetVertexArray,w,p),b>=0&&i(this.icon.zOffsetVertexArray,h.numVerticalIconVertices,p)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=zx(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const o=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:l,y:a}of i)this.lineVertexArray.emplaceBack(l,a);return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(e,i,o,l,a,h,_,y,w,p,x,S,b,T,M,D){const z=e.indexArray,N=e.layoutVertexArray,B=e.globeExtVertexArray,F=e.segments.prepareSegment(4*i.length,N,z,this.canOverlap?h.sortKey:void 0),U=this.glyphOffsetArray.length,q=F.vertexLength,Z=this.allowVerticalPlacement&&_===fs.vertical?Math.PI/2:0,re=h.text&&h.text.sections;for(let te=0;te<i.length;te++){const{tl:pe,tr:ne,bl:me,br:be,texPrimary:ve,texSecondary:Me,pixelOffsetTL:Ee,pixelOffsetBR:Oe,minFontScaleX:Ce,minFontScaleY:ke,glyphOffset:rt,isSDF:tt,sectionIndex:Ct}=i[te],ot=F.vertexLength,ut=rt[1];if(fm(N,w.x,w.y,pe.x,ut+pe.y,ve.x,ve.y,o,tt,Ee.x,Ee.y,Ce,ke),fm(N,w.x,w.y,ne.x,ut+ne.y,ve.x+ve.w,ve.y,o,tt,Oe.x,Ee.y,Ce,ke),fm(N,w.x,w.y,me.x,ut+me.y,ve.x,ve.y+ve.h,o,tt,Ee.x,Oe.y,Ce,ke),fm(N,w.x,w.y,be.x,ut+be.y,ve.x+ve.w,ve.y+ve.h,o,tt,Oe.x,Oe.y,Ce,ke),y){const{x:nt,y:Ht,z:Et}=y.anchor,[Lt,ei,_i]=y.up;mm(B,nt,Ht,Et,Lt,ei,_i),mm(B,nt,Ht,Et,Lt,ei,_i),mm(B,nt,Ht,Et,Lt,ei,_i),mm(B,nt,Ht,Et,Lt,ei,_i),_m(e.dynamicLayoutVertexArray,nt,Ht,Et,Z)}else _m(e.dynamicLayoutVertexArray,w.x,w.y,w.z,Z);if(D){const nt=Me||ve;pm(e.iconTransitioningVertexArray,nt.x,nt.y),pm(e.iconTransitioningVertexArray,nt.x+nt.w,nt.y),pm(e.iconTransitioningVertexArray,nt.x,nt.y+nt.h),pm(e.iconTransitioningVertexArray,nt.x+nt.w,nt.y+nt.h)}z.emplaceBack(ot,ot+1,ot+2),z.emplaceBack(ot+1,ot+2,ot+3),F.vertexLength+=4,F.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(rt[0]),te!==i.length-1&&Ct===i[te+1].sectionIndex||e.programConfigurations.populatePaintArrays(N.length,h,h.index,{},b,T,M,re&&re[Ct])}const ee=y?y.anchor:w;e.placedSymbolArray.emplaceBack(ee.x,ee.y,ee.z,w.x,w.y,U,this.glyphOffsetArray.length-U,q,p,x,w.segment,o?o[0]:0,o?o[1]:0,l[0],l[1],_,0,!1,0,S,0)}_commitLayoutVertex(e,i,o,l,a,h,_){e.emplaceBack(i,o,l,a,h,Math.round(_.x),Math.round(_.y))}_addCollisionDebugVertices(e,i,o,l,a,h,_){const y=o.segments.prepareSegment(4,o.layoutVertexArray,o.indexArray),w=y.vertexLength,p=_.tileAnchorX,x=_.tileAnchorY;for(let b=0;b<4;b++)o.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(o.collisionVertexArrayExt,i,e.padding,_.zOffset),this._commitLayoutVertex(o.layoutVertexArray,l,a,h,p,x,new we(e.x1,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,l,a,h,p,x,new we(e.x2,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,l,a,h,p,x,new we(e.x2,e.y2)),this._commitLayoutVertex(o.layoutVertexArray,l,a,h,p,x,new we(e.x1,e.y2)),y.vertexLength+=4;const S=o.indexArray;S.emplaceBack(w,w+1),S.emplaceBack(w+1,w+2),S.emplaceBack(w+2,w+3),S.emplaceBack(w+3,w),y.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,o,l,a,h){for(let _=l;_<a;_++){const y=o.get(_),w=this.getSymbolInstanceTextSize(e,h,i,_);this._addCollisionDebugVertices(y,w,this.textCollisionBox,y.projectedAnchorX,y.projectedAnchorY,y.projectedAnchorZ,h)}}_addIconDebugCollisionBoxes(e,i,o,l,a,h){for(let _=l;_<a;_++){const y=o.get(_),w=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._addCollisionDebugVertices(y,w,this.iconCollisionBox,y.projectedAnchorX,y.projectedAnchorY,y.projectedAnchorZ,h)}}generateCollisionDebugBuffers(e,i,o){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Hg(uc,K0.members,Go),this.iconCollisionBox=new Hg(uc,K0.members,Go);const l=qu(this.iconSizeData,e),a=qu(this.textSizeData,e,o);for(let h=0;h<this.symbolInstances.length;h++){const _=this.symbolInstances.get(h);this._addTextDebugCollisionBoxes(a,e,i,_.textBoxStartIndex,_.textBoxEndIndex,_),this._addTextDebugCollisionBoxes(a,e,i,_.verticalTextBoxStartIndex,_.verticalTextBoxEndIndex,_),this._addIconDebugCollisionBoxes(l,e,i,_.iconBoxStartIndex,_.iconBoxEndIndex,_),this._addIconDebugCollisionBoxes(l,e,i,_.verticalIconBoxStartIndex,_.verticalIconBoxEndIndex,_)}}getSymbolInstanceTextSize(e,i,o,l){const a=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:l),h=rm(this.textSizeData,e,a)/Tn;return this.tilePixelRatio*h}getSymbolInstanceIconSize(e,i,o){const l=this.icon.placedSymbolArray.get(o),a=rm(this.iconSizeData,e,l);return this.tilePixelRatio*a}_commitDebugCollisionVertexUpdate(e,i,o,l){e.emplaceBack(i,-o,-o,l),e.emplaceBack(i,o,-o,l),e.emplaceBack(i,o,o,l),e.emplaceBack(i,-o,o,l)}_updateTextDebugCollisionBoxes(e,i,o,l,a,h,_){for(let y=l;y<a;y++){const w=o.get(y),p=this.getSymbolInstanceTextSize(e,h,i,y);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,p,w.padding,h.zOffset)}}_updateIconDebugCollisionBoxes(e,i,o,l,a,h,_){for(let y=l;y<a;y++){const w=o.get(y),p=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,p,w.padding,h.zOffset)}}updateCollisionDebugBuffers(e,i,o,l){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const a=qu(this.iconSizeData,e,l),h=qu(this.textSizeData,e,o);for(let _=0;_<this.symbolInstances.length;_++){const y=this.symbolInstances.get(_);this._updateTextDebugCollisionBoxes(h,e,i,y.textBoxStartIndex,y.textBoxEndIndex,y,o),this._updateTextDebugCollisionBoxes(h,e,i,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y,o),this._updateIconDebugCollisionBoxes(a,e,i,y.iconBoxStartIndex,y.iconBoxEndIndex,y,l),this._updateIconDebugCollisionBoxes(a,e,i,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex,y,l)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,o,l,a,h,_,y,w){const p={};if(i<o){const{x1:x,y1:S,x2:b,y2:T,padding:M,projectedAnchorX:D,projectedAnchorY:z,projectedAnchorZ:N,tileAnchorX:B,tileAnchorY:F,featureIndex:U}=e.get(i);p.textBox={x1:x,y1:S,x2:b,y2:T,padding:M,projectedAnchorX:D,projectedAnchorY:z,projectedAnchorZ:N,tileAnchorX:B,tileAnchorY:F},p.textFeatureIndex=U}if(l<a){const{x1:x,y1:S,x2:b,y2:T,padding:M,projectedAnchorX:D,projectedAnchorY:z,projectedAnchorZ:N,tileAnchorX:B,tileAnchorY:F,featureIndex:U}=e.get(l);p.verticalTextBox={x1:x,y1:S,x2:b,y2:T,padding:M,projectedAnchorX:D,projectedAnchorY:z,projectedAnchorZ:N,tileAnchorX:B,tileAnchorY:F},p.verticalTextFeatureIndex=U}if(h<_){const{x1:x,y1:S,x2:b,y2:T,padding:M,projectedAnchorX:D,projectedAnchorY:z,projectedAnchorZ:N,tileAnchorX:B,tileAnchorY:F,featureIndex:U}=e.get(h);p.iconBox={x1:x,y1:S,x2:b,y2:T,padding:M,projectedAnchorX:D,projectedAnchorY:z,projectedAnchorZ:N,tileAnchorX:B,tileAnchorY:F},p.iconFeatureIndex=U}if(y<w){const{x1:x,y1:S,x2:b,y2:T,padding:M,projectedAnchorX:D,projectedAnchorY:z,projectedAnchorZ:N,tileAnchorX:B,tileAnchorY:F,featureIndex:U}=e.get(y);p.verticalIconBox={x1:x,y1:S,x2:b,y2:T,padding:M,projectedAnchorX:D,projectedAnchorY:z,projectedAnchorZ:N,tileAnchorX:B,tileAnchorY:F},p.verticalIconFeatureIndex=U}return p}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const o=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const o=e.placedSymbolArray.get(i),l=o.vertexStartIndex+4*o.numGlyphs;for(let a=o.vertexStartIndex;a<l;a+=4)e.indexArray.emplaceBack(a,a+1,a+2),e.indexArray.emplaceBack(a+1,a+2,a+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),o=Math.cos(e),l=[],a=[],h=[];for(let _=0;_<this.symbolInstances.length;++_){h.push(_);const y=this.symbolInstances.get(_);l.push(0|Math.round(i*y.tileAnchorX+o*y.tileAnchorY)),a.push(y.featureIndex)}return h.sort((_,y)=>l[_]-l[y]||a[y]-a[_]),h}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===i?o.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const o=this.symbolInstances.get(i);this.featureSortOrder.push(o.featureIndex);const{rightJustifiedTextSymbolIndex:l,centerJustifiedTextSymbolIndex:a,leftJustifiedTextSymbolIndex:h,verticalPlacedTextSymbolIndex:_,placedIconSymbolIndex:y,verticalPlacedIconSymbolIndex:w}=o;l>=0&&this.addIndicesForPlacedSymbol(this.text,l),a>=0&&a!==l&&this.addIndicesForPlacedSymbol(this.text,a),h>=0&&h!==a&&h!==l&&this.addIndicesForPlacedSymbol(this.text,h),_>=0&&this.addIndicesForPlacedSymbol(this.text,_),y>=0&&this.addIndicesForPlacedSymbol(this.icon,y),w>=0&&this.addIndicesForPlacedSymbol(this.icon,w)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Lx,Ox,Zg;It(gm,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),gm.addDynamicAttributes=_m;class kx{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:ka,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}It(kx,"FormatSectionOverride",{omit:["defaultValue"]});const Wg=()=>Zg||(Zg={layout:Lx||(Lx=new Cr({"symbol-placement":new ct(Fe.layout_symbol["symbol-placement"]),"symbol-spacing":new ct(Fe.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ct(Fe.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new At(Fe.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ct(Fe.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new ct(Fe.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new ct(Fe.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new ct(Fe.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ct(Fe.layout_symbol["icon-ignore-placement"]),"icon-optional":new ct(Fe.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ct(Fe.layout_symbol["icon-rotation-alignment"]),"icon-size":new At(Fe.layout_symbol["icon-size"]),"icon-size-scale-range":new ct(Fe.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new At(Fe.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new At(Fe.layout_symbol["icon-text-fit-padding"]),"icon-image":new At(Fe.layout_symbol["icon-image"]),"icon-rotate":new At(Fe.layout_symbol["icon-rotate"]),"icon-padding":new ct(Fe.layout_symbol["icon-padding"]),"icon-keep-upright":new ct(Fe.layout_symbol["icon-keep-upright"]),"icon-offset":new At(Fe.layout_symbol["icon-offset"]),"icon-anchor":new At(Fe.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ct(Fe.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ct(Fe.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ct(Fe.layout_symbol["text-rotation-alignment"]),"text-field":new At(Fe.layout_symbol["text-field"]),"text-font":new At(Fe.layout_symbol["text-font"]),"text-size":new At(Fe.layout_symbol["text-size"]),"text-size-scale-range":new ct(Fe.layout_symbol["text-size-scale-range"]),"text-max-width":new At(Fe.layout_symbol["text-max-width"]),"text-line-height":new At(Fe.layout_symbol["text-line-height"]),"text-letter-spacing":new At(Fe.layout_symbol["text-letter-spacing"]),"text-justify":new At(Fe.layout_symbol["text-justify"]),"text-radial-offset":new At(Fe.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ct(Fe.layout_symbol["text-variable-anchor"]),"text-anchor":new At(Fe.layout_symbol["text-anchor"]),"text-max-angle":new ct(Fe.layout_symbol["text-max-angle"]),"text-writing-mode":new ct(Fe.layout_symbol["text-writing-mode"]),"text-rotate":new At(Fe.layout_symbol["text-rotate"]),"text-padding":new ct(Fe.layout_symbol["text-padding"]),"text-keep-upright":new ct(Fe.layout_symbol["text-keep-upright"]),"text-transform":new At(Fe.layout_symbol["text-transform"]),"text-offset":new At(Fe.layout_symbol["text-offset"]),"text-allow-overlap":new ct(Fe.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ct(Fe.layout_symbol["text-ignore-placement"]),"text-optional":new ct(Fe.layout_symbol["text-optional"]),visibility:new ct(Fe.layout_symbol.visibility)})),paint:Ox||(Ox=new Cr({"icon-opacity":new At(Fe.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new At(Fe.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new At(Fe.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new At(Fe.paint_symbol["text-emissive-strength"]),"icon-color":new At(Fe.paint_symbol["icon-color"]),"icon-halo-color":new At(Fe.paint_symbol["icon-halo-color"]),"icon-halo-width":new At(Fe.paint_symbol["icon-halo-width"]),"icon-halo-blur":new At(Fe.paint_symbol["icon-halo-blur"]),"icon-translate":new ct(Fe.paint_symbol["icon-translate"]),"icon-translate-anchor":new ct(Fe.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new At(Fe.paint_symbol["icon-image-cross-fade"]),"text-opacity":new At(Fe.paint_symbol["text-opacity"]),"text-occlusion-opacity":new At(Fe.paint_symbol["text-occlusion-opacity"]),"text-color":new At(Fe.paint_symbol["text-color"],{runtimeType:An,getOverride:n=>n.textColor,hasOverride:n=>!!n.textColor}),"text-halo-color":new At(Fe.paint_symbol["text-halo-color"]),"text-halo-width":new At(Fe.paint_symbol["text-halo-width"]),"text-halo-blur":new At(Fe.paint_symbol["text-halo-blur"]),"text-translate":new ct(Fe.paint_symbol["text-translate"]),"text-translate-anchor":new ct(Fe.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new ct(Fe.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new ct(Fe.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new ct(Fe.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new ct(Fe.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new At(Fe.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},Zg);class ym extends un{constructor(e,i,o,l){super(e,Wg(),i,o,l),this._colorAdjustmentMatrix=J.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,i){super.recalculate(e,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const o=this.layout.get("text-writing-mode");if(o){const l=[];for(const a of o)l.indexOf(a)<0&&l.push(a);this.layout._values["text-writing-mode"]=l}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,o,l){return this._saturation===e&&this._contrast===i&&this._brightnessMin===o&&this._brightnessMax===l||(this._colorAdjustmentMatrix=function(a,h,_,y){a=$e(a),h=Vl(h);const w=J.mat4.create(),p=a/3,x=1-2*p,S=[x,p,p,0,p,x,p,0,p,p,x,0,0,0,0,1],b=.5-.5*h,T=y-_;return J.mat4.multiply(w,[T,0,0,0,0,T,0,0,0,0,T,0,_,_,_,1],[h,0,0,0,0,h,0,0,0,0,h,0,b,b,b,1]),J.mat4.multiply(w,w,S),w}(e,i,o,l),this._saturation=e,this._contrast=i,this._brightnessMin=o,this._brightnessMax=l),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,o,l){const a=this.layout.get(e).evaluate(i,{},o,l),h=this._unevaluatedLayout._values[e];return h.isDataDriven()||gu(h.value)||!a?a:function(_,y){return y.replace(/{([^{}]+)}/g,(w,p)=>p in _?String(_[p]):"")}(i.properties,a)}createBucket(e){return new gm(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of Wg().paint.overridableProperties){if(!ym.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),o=new kx(i),l=new id(o,i.property.specification,this.scope,this.options);let a=null;a=i.value.kind==="constant"||i.value.kind==="source"?new rd("source",l):new el("composite",l,i.value.zoomStops,i.value._interpolationType),this.paint._values[e]=new sl(i.property,a,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,o){return!(!this.layout||i.isDataDriven()||o.isDataDriven())&&ym.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const o=e.get("text-field"),l=Wg().paint.properties[i];let a=!1;const h=_=>{for(const y of _)if(l.overrides&&l.overrides.hasOverride(y))return void(a=!0)};if(o.value.kind==="constant"&&o.value.value instanceof In)h(o.value.value.sections);else if(o.value.kind==="source"){const _=w=>{a||(w instanceof lo&&Yr(w.value)===Gl?h(w.value.sections):w instanceof Va?h(w.sections):w.eachChild(_))},y=o.value;y._styleExpression&&_(y._styleExpression.expression)}return a}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,o){return{config:new ga(this,{zoom:i,lut:o}),overrideFog:!1}}}let Fx,Bx,Nx,Vx;var Xg=Hi([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Kg(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function Yg(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class Jg{constructor(e,i,o,l){this.context=e,this.format=o,this.useMipmap=l&&l.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:l&&l.premultiply})}update(e,i){const o=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,l=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:a}=this,{gl:h}=a,{x:_,y}=i&&i.position?i.position:{x:0,y:0},w=_+o,p=y+l;!this.size||this.size[0]===w&&this.size[1]===p||(h.bindTexture(h.TEXTURE_2D,null),h.deleteTexture(this.texture),this.texture=h.createTexture(),this.size=null),h.bindTexture(h.TEXTURE_2D,this.texture),a.pixelStoreUnpackFlipY.set(!1),a.pixelStoreUnpack.set(1),a.pixelStoreUnpackPremultiplyAlpha.set(this.format===h.RGBA8&&(!i||i.premultiply!==!1));const x=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&w>0&&p>0){const S=this.useMipmap?Math.floor(Math.log2(Math.max(w,p)))+1:1;h.texStorage2D(h.TEXTURE_2D,S,this.format,w,p),this.size=[w,p]}if(this.size)if(x)h.texSubImage2D(h.TEXTURE_2D,0,_,y,Kg(this.format),Yg(this.format),e);else{const S=e.data;S&&h.texSubImage2D(h.TEXTURE_2D,0,_,y,o,l,Kg(this.format),Yg(this.format),S)}this.useMipmap&&h.generateMipmap(h.TEXTURE_2D)}bind(e,i,o=!1){const{context:l}=this,{gl:a}=l;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,this.useMipmap&&!o?e===a.NEAREST?a.NEAREST_MIPMAP_NEAREST:a.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,o,l){const{context:a}=this,{gl:h}=a;h.bindTexture(h.TEXTURE_2D,this.texture),i!==this.magFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,this.useMipmap?e===h.NEAREST?h.NEAREST_MIPMAP_NEAREST:h.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),o!==this.wrapS&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,o),this.wrapS=o),l!==this.wrapT&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,l),this.wrapT=l)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class vm{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:o}=this,{gl:l}=o;l.bindTexture(l.TEXTURE_2D,this.texture),e!==this.minFilter&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,e),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,i),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,i),this.wrapS=i)}}function xm(n,e,i,o,l,a,h,_){const y=[n,e,1,i,o,1,l,a,1],w=[h,_,1],p=J.mat3.adjoint([],y),[x,S,b]=J.vec3.transformMat3(w,w,p);return J.mat3.multiply(y,y,[x,0,0,0,S,0,0,0,b])}function Ux(n,e,i,o,l,a,h,_){const y=function(w,p,x,S,b,T,M,D){const z=xm(0,0,1,0,1,1,0,1),N=xm(w,p,x,S,b,T,M,D),B=J.mat3.adjoint([],z);return J.mat3.multiply(N,N,B)}(n,e,i,o,l,a,h,_);return[y[2]/y[8]/ht,y[5]/y[8]/ht]}function bm(n){return[n[0],Math.min(Math.max(n[1],-85.051129),jn)]}class jx extends Ls{constructor(e,i,o,l){super(),this.id=e,this.dispatcher=o,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(l),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new Hn("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Sh(this.map._requestManager.transformRequest(this.url,ln.Image),(o,l)=>{this._imageRequest=null,this._loaded=!0,o?this.fire(new Oa(o)):l&&(this.image=l instanceof HTMLImageElement?qe.getImageData(l):l,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new vm(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Hn("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof vm||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],o=e[0][1];for(const a of e)a[1]>o&&(o=a[1]),a[1]<i&&(i=a[1]);const l=(o+i)/2;if(l>jn?this.onNorthPole=!0:l<-85.051129&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const a=e.map(t.fromLngLat);this.tileID=function(h){let _=1/0,y=1/0,w=-1/0,p=-1/0;for(const M of h)_=Math.min(_,M.x),y=Math.min(y,M.y),w=Math.max(w,M.x),p=Math.max(p,M.y);const x=Math.max(w-_,p-y),S=Math.max(0,Math.floor(-Math.log(x)/Math.LN2)),b=Math.pow(2,S);let T=Math.floor((_+w)/2*b);return T>1&&(T-=1),new Qe(S,T,Math.floor((y+p)/2*b))}(a),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Hn("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const z in this.tiles){const N=this.tiles[z];N.state!=="loaded"&&(N.state="loaded",N.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=ef(new Qe(0,0,0),this.map.transform.projection),o=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(z){const N=z[1].x-z[0].x,B=z[1].y-z[0].y,F=z[2].x-z[1].x,U=z[2].y-z[1].y,q=z[3].x-z[2].x,Z=z[3].y-z[2].y,re=z[0].x-z[3].x,ee=z[0].y-z[3].y,te=N*U-F*B,pe=F*Z-q*U,ne=q*ee-re*Z,me=re*B-N*ee;return te>0&&pe>0&&ne>0&&me>0||te<0&&pe<0&&ne<0&&me<0}(o))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const l=ef(this.tileID,this.map.transform.projection),[a,h,_,y]=this.coordinates.map(z=>{const N=l.projection.project(z[0],z[1]);return Ix(l,N)._round()});this.perspectiveTransform=Ux(a.x,a.y,h.x,h.y,_.x,_.y,y.x,y.y);const w=this._boundsArray=new vo;w.emplaceBack(a.x,a.y,0,0),w.emplaceBack(h.x,h.y,ht,0),w.emplaceBack(y.x,y.y,0,ht),w.emplaceBack(_.x,_.y,ht,ht),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(w,Xg.members),this.boundsSegments=Tr.simpleSegment(0,0,4,2);const p=[],x=[bm((S=this.coordinates)[0]),bm(S[1]),bm(S[2]),bm(S[3])];var S;const[b,T,M,D]=function(z){let N=z[0][0],B=N,F=z[0][1],U=F;for(let q=1;q<z.length;q++)z[q][0]<N?N=z[q][0]:z[q][0]>B&&(B=z[q][0]),z[q][1]<F?F=z[q][1]:z[q][1]>U&&(U=z[q][1]);return[N,F,B-N,U-F]}(x);{const z=new vo,[N,B,F,U]=function(Ee){let Oe=Ee[0].x,Ce=Oe,ke=Ee[0].y,rt=ke;for(let tt=1;tt<Ee.length;tt++)Ee[tt].x<Oe?Oe=Ee[tt].x:Ee[tt].x>Ce&&(Ce=Ee[tt].x),Ee[tt].y<ke?ke=Ee[tt].y:Ee[tt].y>rt&&(rt=Ee[tt].y);return[Oe,ke,Ce-Oe,rt-ke]}(o),q=Ee=>[(Ee.x-N)/F,(Ee.y-B)/U],[Z,re,ee,te]=o.map(q),pe=function(Ee,Oe,Ce,ke,rt,tt,Ct,ot){const ut=xm(0,0,1,0,1,1,0,1),nt=xm(Ee,Oe,Ce,ke,rt,tt,Ct,ot),Ht=J.mat3.adjoint([],nt);return J.mat3.multiply(ut,ut,Ht)}(Z[0],Z[1],re[0],re[1],ee[0],ee[1],te[0],te[1]);this.elevatedGlobePerspectiveTransform=Ux(Z[0],Z[1],re[0],re[1],ee[0],ee[1],te[0],te[1]);const ne=(Ee,Oe)=>{p.push(Ee.lng);const Ce=Math.round((Ee.lng-b)/M*ht),ke=Math.round((Ee.lat-T)/D*ht),rt=q(Oe),tt=J.vec3.transformMat3([],[rt[0],rt[1],1],pe),Ct=Math.round(tt[0]/tt[2]*ht),ot=Math.round(tt[1]/tt[2]*ht);z.emplaceBack(Ce,ke,Ct,ot)},me=o[3].x-o[0].x,be=o[3].y-o[0].y,ve=o[2].x-o[1].x,Me=o[2].y-o[1].y;for(let Ee=0;Ee<65;Ee++){const Oe=Ee/64,Ce=[o[0].x+Oe*me,o[0].y+Oe*be],ke=[o[1].x+Oe*ve,o[1].y+Oe*Me],rt=ke[0]-Ce[0],tt=ke[1]-Ce[1];for(let Ct=0;Ct<65;Ct++){const ot=Ct/64,ut={x:Ce[0]+rt*ot,y:Ce[1]+tt*ot};ne(i.projection.unproject(ut.x,ut.y),ut)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(z,Xg.members)}{this.maxLongitudeTriangleSize=0;let z=[],N=new dn;const B=(F,U,q)=>{N.emplaceBack(F,U,q);const Z=p[F],re=p[U],ee=p[q],te=Math.min(Math.min(Z,re),ee),pe=Math.max(Math.max(Z,re),ee)-te;pe>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=pe),z.push(te+pe/2)};for(let F=0;F<64;F++)for(let U=0;U<64;U++){const q=65*F+U,Z=q+1,re=q+65,ee=re+1;B(q,re,Z),B(Z,re,ee)}[z,N]=function(F,U){const q=Array.from({length:F.length},(ee,te)=>te);q.sort((ee,te)=>F[ee]-F[te]);const Z=[],re=new dn;for(let ee=0;ee<q.length;ee++){const te=q[ee];Z.push(F[te]);const pe=3*te,ne=pe+1;re.emplaceBack(U.uint16[pe],U.uint16[ne],U.uint16[ne+1])}return[Z,re]}(z,N),this.elevatedGlobeTrianglesCenterLongitudes=z,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(N)}this.elevatedGlobeSegments=Tr.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,M/ht,0,D/ht,0,0,T,b,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,o=i.gl;!this._dirty||this.texture instanceof vm||(this.texture?this.texture.update(this.image):(this.texture=new Jg(i,this.image,o.RGBA8),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const o=this.elevatedGlobeTrianglesCenterLongitudes;let l=(a=e+180)+360*Math.round((o[0]-a)/360);var a;const h=new Tr,_=(x,S)=>{h.segments.push({vertexOffset:0,primitiveOffset:x,vertexLength:i.segments[0].vertexLength,primitiveLength:S,sortKey:void 0,vaos:{}})},y=.51*this.maxLongitudeTriangleSize;if(Math.abs(o[0]-l)<=y){const x=Zc(o,0,o.length,l+y);return x===o.length||_(x,Hc(o,x+1,o.length,l+360-y)-x),h}l<o[0]&&(l+=360);const w=Hc(o,0,o.length,l-y);if(w===o.length)return _(0,o.length),h;_(0,w-0);const p=Zc(o,w+1,o.length,l+y);return p!==o.length&&_(p,o.length-p),h}}const iE=(Math.pow(256,2)-1)/16907520;class Gx extends un{constructor(e,i,o,l){super(e,{layout:Nx||(Nx=new Cr({visibility:new ct(Fe.layout_raster.visibility)})),paint:Vx||(Vx=new Cr({"raster-opacity":new ct(Fe.paint_raster["raster-opacity"]),"raster-color":new al(Fe.paint_raster["raster-color"]),"raster-color-mix":new ct(Fe.paint_raster["raster-color-mix"]),"raster-color-range":new ct(Fe.paint_raster["raster-color-range"]),"raster-hue-rotate":new ct(Fe.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ct(Fe.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ct(Fe.paint_raster["raster-brightness-max"]),"raster-saturation":new ct(Fe.paint_raster["raster-saturation"]),"raster-contrast":new ct(Fe.paint_raster["raster-contrast"]),"raster-resampling":new ct(Fe.paint_raster["raster-resampling"]),"raster-fade-duration":new ct(Fe.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new ct(Fe.paint_raster["raster-emissive-strength"]),"raster-array-band":new ct(Fe.paint_raster["raster-array-band"]),"raster-elevation":new ct(Fe.paint_raster["raster-elevation"]),"raster-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},i,o,l),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof jx&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[o,l]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(o)&&isNaN(l)||o===this._curRampRange[0]&&l===this._curRampRange[1]||(this.colorRamp=Vd({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:o,end:l}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[o,l])}}let qx,$x,Hx,Zx,Wx;class Xx extends un{constructor(e,i,o,l){super(e,{layout:qx||(qx=new Cr({visibility:new ct(Fe["layout_raster-particle"].visibility)})),paint:$x||($x=new Cr({"raster-particle-array-band":new ct(Fe["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new ct(Fe["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new al(Fe["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new ct(Fe["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new ct(Fe["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new ct(Fe["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new ct(Fe["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new ct(Fe["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},i,o,l),this._updateColorRamp(),this.lastInvalidatedAt=qe.now()}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Vd({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=qe.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class rE extends un{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function Qg(n,e,i){const o=[0,0,1],l=J.quat.identity([]);return J.quat.rotateY(l,l,i?-xt(n)+Math.PI:xt(n)),J.quat.rotateX(l,l,-xt(e)),J.vec3.transformQuat(o,o,l),J.vec3.normalize(o,o)}function Kx(n,e){const i=wm(n.projection,n.zoom,n.width,n.height),o=function(a,h,_,y,w){const p=new Zi(_.lng-180*wl,_.lat),x=new Zi(_.lng+180*wl,_.lat),S=a.project(p.lng,p.lat),b=a.project(x.lng,x.lat),T=-Math.atan2(b.y-S.y,b.x-S.x),M=t.fromLngLat(_);M.y=Dt(M.y,-1+wl,1-wl);const D=M.toLngLat(),z=a.project(D.lng,D.lat),N=t.fromLngLat(D);N.x+=wl;const B=N.toLngLat(),F=a.project(B.lng,B.lat),U=Jx(F.x-z.x,F.y-z.y,T),q=t.fromLngLat(D);q.y+=wl;const Z=q.toLngLat(),re=a.project(Z.lng,Z.lat),ee=Jx(re.x-z.x,re.y-z.y,T),te=Math.abs(U.x)/Math.abs(ee.y),pe=J.mat4.identity([]);J.mat4.rotateZ(pe,pe,-T*(1-(w?0:y)));const ne=J.mat4.identity([]);return J.mat4.scale(ne,ne,[1,1-(1-te)*y,1]),ne[4]=-ee.x/ee.y*y,J.mat4.rotateZ(ne,ne,T),J.mat4.multiply(ne,pe,ne),ne}(n.projection,0,n.center,i,e),l=Yx(n);return J.mat4.scale(o,o,[l,l,1]),o}function Yx(n){const e=n.projection,i=wm(n.projection,n.zoom,n.width,n.height),o=ey(e,n.center),l=ey(e,Zi.convert(e.center));return Math.pow(2,o*i+(1-i)*l)}function wm(n,e,i,o,l=1/0){const a=n.range;if(!a)return 0;const h=Math.min(l,Math.max(i,o)),_=Math.log(h/1024)/Math.LN2;return yi(a[0]+_,a[1]+_,e)}const wl=1/4e4;function ey(n,e){const i=Dt(e.lat,-85.051129,jn),o=new Zi(e.lng-180*wl,i),l=new Zi(e.lng+180*wl,i),a=n.project(o.lng,i),h=n.project(l.lng,i),_=t.fromLngLat(o),y=t.fromLngLat(l),w=h.x-a.x,p=h.y-a.y,x=y.x-_.x,S=y.y-_.y,b=Math.sqrt((x*x+S*S)/(w*w+p*p));return Math.log(b)/Math.LN2}function Jx(n,e,i){const o=Math.cos(i),l=Math.sin(i);return{x:n*o-e*l,y:n*l+e*o}}function Qx(n,e,i){J.mat4.identity(n),J.mat4.rotateZ(n,n,xt(e[2])),J.mat4.rotateX(n,n,xt(e[0])),J.mat4.rotateY(n,n,xt(e[1])),J.mat4.scale(n,n,i),J.mat4.multiply(n,n,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Tm(n,e,i,o,l,a,h,_){const y=[i[0]-e[0],i[1]-e[1],0],w=[o[0]-e[0],o[1]-e[1],0];if(J.vec3.length(y)<1e-12||J.vec3.length(w)<1e-12)return J.quat.identity(n);const p=J.vec3.cross([],y,w);J.vec3.normalize(p,p),J.vec3.subtract(w,o,e),y[2]=(a-l)*_,w[2]=(h-l)*_;const x=y;return J.vec3.cross(x,y,w),J.vec3.normalize(x,x),J.quat.rotationTo(n,p,x)}function ty(n,e,i=!1){const o=Gn(e.zoom),l=function(a,h,_){const y=h.worldSize,w=[a[12],a[13],a[14]],p=fn(w[1]/y),x=Kn(w[0]/y),S=J.mat4.identity([]),b=bn(1,p)*y,T=bn(1,0)*y*Zo(p,h.zoom),M=1/Js(y);let D=T*M;if(_){const F=wm(h.projection,h.zoom,h.width,h.height,1024);D=M*h.projection.pixelSpaceConversion(h.center.lat,y,F)}const z=ya(p,x);J.vec3.add(z,z,J.vec3.scale([],J.vec3.normalize([],z),b*D*w[2]));const N=function(F){const U=[F[0],F[1],F[2]];let q=[0,1,0];const Z=J.vec3.cross([],q,U);return J.vec3.cross(q,U,Z),J.vec3.squaredLength(q)===0&&(q=[0,1,0],J.vec3.cross(Z,U,q)),J.vec3.normalize(Z,Z),J.vec3.normalize(q,q),J.vec3.normalize(U,U),[Z[0],Z[1],Z[2],0,q[0],q[1],q[2],0,U[0],U[1],U[2],0,F[0],F[1],F[2],1]}(z);J.mat4.scale(S,S,[D,D,D*b]),J.mat4.translate(S,S,[-w[0],-w[1],-w[2]]);const B=J.mat4.multiply([],h.globeMatrix,N);return J.mat4.multiply(B,B,S),J.mat4.multiply(B,B,a),B}(n,e,i);if(o>0){const a=function(h,_){const y=_.worldSize,w=bn(1,0)*y*Zo(_.center.lat,_.zoom)/Js(y),p=bn(1,_.center.lat)*y,x=J.mat4.identity([]);return J.mat4.rotateY(x,x,xt(_.center.lng)),J.mat4.rotateX(x,x,xt(_.center.lat)),J.mat4.translate(x,x,[0,0,Fn]),J.mat4.scale(x,x,[w,w,w*p]),J.mat4.translate(x,x,[_.point.x-.5*y,_.point.y-.5*y,0]),J.mat4.multiply(x,x,h),J.mat4.multiply(x,_.globeMatrix,x)}(n,e);return function(h,_,y){const w=(T,M,D)=>{const z=J.vec3.length(T),N=J.vec3.length(M),B=nn(T,M,D);return J.vec3.scale(B,B,1/J.vec3.length(B)*Xt(z,N,D))},p=w([h[0],h[1],h[2]],[_[0],_[1],_[2]],y),x=w([h[4],h[5],h[6]],[_[4],_[5],_[6]],y),S=w([h[8],h[9],h[10]],[_[8],_[9],_[10]],y),b=nn([h[12],h[13],h[14]],[_[12],_[13],_[14]],y);return[p[0],p[1],p[2],0,x[0],x[1],x[2],0,S[0],S[1],S[2],0,b[0],b[1],b[2],1]}(l,a,o)}return l}function e1(n,e,i,o){const l=kt.projectAabbCorners(o,i);let a=Number.MAX_VALUE,h=-1;for(let w=0;w<l.length;++w){const p=l[w];p[0]=(.5*p[0]+.5)*e.width,p[1]=(.5-.5*p[1])*e.height,p[2]<a&&(h=w,a=p[2])}const _=w=>new we(l[w][0],l[w][1]);let y;switch(h){case 0:case 6:y=[_(1),_(5),_(4),_(7),_(3),_(2),_(1)];break;case 1:case 7:y=[_(0),_(4),_(5),_(6),_(2),_(3),_(0)];break;case 3:case 5:y=[_(1),_(0),_(4),_(7),_(6),_(2),_(1)];break;default:y=[_(1),_(5),_(6),_(7),_(3),_(0),_(1)]}if(H(n,y))return a}const nE=Hi([{name:"a_pos_3f",components:3,type:"Float32"}]),sE=Hi([{name:"a_color_3f",components:3,type:"Float32"}]),oE=Hi([{name:"a_color_4f",components:4,type:"Float32"}]),aE=Hi([{name:"a_uv_2f",components:2,type:"Float32"}]),lE=Hi([{name:"a_normal_3f",components:3,type:"Float32"}]),cE=Hi([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),uE=Hi([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),t1={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class Sm{constructor(e,i,o,l){this.message=(e?`${e}: `:"")+o,l&&(this.identifier=l),i!=null&&i.__line__&&(this.line=i.__line__)}}function i1(n,e){const i=n.indexOf("://")===-1;try{return new URL(n,i&&e?"http://example.com":void 0),!0}catch{return!1}}class r1{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class n1{constructor(){this.instancedDataArray=new Ou,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class iy{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(e,i){}populate(e,i,o,l){this.tileToMeter=u(o);const a=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:h,id:_,index:y,sourceLayerIndex:w}of e){const p=_??(h.properties&&h.properties.hasOwnProperty("id")?h.properties.id:void 0),x=R(h,a);if(!this.layers[0]._featureFilter.filter(new ur(this.zoom),x,o))continue;const S={id:p,sourceLayerIndex:w,index:y,geometry:a?x.geometry:C(h,o,l),properties:h.properties,type:h.type,patterns:{}},b=this.addFeature(S,S.geometry,x);b&&i.featureIndex.insert(h,S.geometry,y,w,this.index,this.instancesPerModel[b].instancedDataArray.length,ht/32)}this.lookup=null}update(e,i,o,l){for(const a in this.instancesPerModel){const h=this.instancesPerModel[a];for(const _ in e)h.idToFeaturesIndex.hasOwnProperty(_)&&(this.evaluate(h.features[h.idToFeaturesIndex[_]],e[_],h,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];for(const l of o.features){const a=this.layers[0],h=l.feature,_=this.canonical,y=a.paint.get("model-rotation").evaluate(h,{},_),w=a.paint.get("model-scale").evaluate(h,{},_),p=a.paint.get("model-translation").evaluate(h,{},_);J.vec3.exactEquals(l.rotation,y)&&J.vec3.exactEquals(l.scale,w)&&J.vec3.exactEquals(l.translation,p)||(this.evaluate(l,l.featureStates,o,!0),e=!0)}}return e}updateReplacement(e,i,o,l){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Ag(this.activeReplacements,a))return!1;this.activeReplacements=a;let h=!1;for(const _ in this.instancesPerModel){const y=this.instancesPerModel[_],w=y.instancedDataArray;for(const p of y.features){const x=p.instancedDataOffset,S=p.instancedDataCount;for(let b=0;b<S;b++){const T=16*(b+x);let M=w.float32[T+0];const D=M>ht;M=D?M-ht:M;const z=Math.floor(M),N=w.float32[T+1];let B=!1;for(const F of this.activeReplacements)if(!p0(F,o,t1.Model,l)&&!(F.min.x>z||z>F.max.x||F.min.y>N||N>F.max.y)&&(B=x0(v0(z,N,e.canonical,F.footprintTileId.canonical),F.footprint),B))break;w.float32[T]=B?M+ht:M,h=h||B!==D}}}return h}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];o.instancedDataArray.length<0||o.instancedDataArray.length===0||(o.instancedDataBuffer?o.instancedDataBuffer.updateData(o.instancedDataArray):o.instancedDataBuffer=e.createVertexBuffer(o.instancedDataArray,cE.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];o.instancedDataArray.length!==0&&o.instancedDataBuffer&&o.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris)for(const i of this.modelUris)e.removeModel(i,"")}addFeature(e,i,o){const l=this.layers[0],a=l.layout.get("model-id").evaluate(o,{},this.canonical);if(!a)return br(`modelId is not evaluated for layer ${l.id} and it is not going to get rendered.`),a;i1(a,!1)&&(this.modelUris.includes(a)||this.modelUris.push(a)),this.instancesPerModel[a]||(this.instancesPerModel[a]=new n1);const h=this.instancesPerModel[a],_=h.instancedDataArray,y=new r1(o,_.length);for(const w of i)for(const p of w){if(p.x<0||p.x>=ht||p.y<0||p.y>=ht)continue;const x=(this.lookupDim-1)/ht,S=this.lookupDim*(p.y*x|0)+p.x*x|0;if(this.lookup){if(this.lookup[S]!==0)continue;this.lookup[S]=1}this.instanceCount++;const b=_.length;_.resize(b+1),h.instancesEvaluatedElevation.push(0),_.float32[16*b]=p.x,_.float32[16*b+1]=p.y}return y.instancedDataCount=h.instancedDataArray.length-y.instancedDataOffset,y.instancedDataCount>0&&(e.id&&(h.idToFeaturesIndex[e.id]=h.features.length),h.features.push(y),this.evaluate(y,{},h,!1)),a}getModelUris(){return this.modelUris}evaluate(e,i,o,l){const a=this.layers[0],h=e.feature,_=this.canonical,y=e.rotation=a.paint.get("model-rotation").evaluate(h,i,_),w=e.scale=a.paint.get("model-scale").evaluate(h,i,_),p=e.translation=a.paint.get("model-translation").evaluate(h,i,_),x=a.paint.get("model-color").evaluate(h,i,_);x.a=a.paint.get("model-color-mix-intensity").evaluate(h,i,_);const S=[];this.maxVerticalOffset<p[2]&&(this.maxVerticalOffset=p[2]),this.maxScale=Math.max(Math.max(this.maxScale,w[0]),Math.max(w[1],w[2])),Qx(S,y,w);const b=Math.round(100*x.a)+x.b/1.05;for(let T=0;T<e.instancedDataCount;++T){const M=e.instancedDataOffset+T,D=16*M,z=o.instancedDataArray.float32;let N=0;l&&(N=z[D+6]-o.instancesEvaluatedElevation[M]);const B=0|z[D+1];z[D]=(0|z[D])+x.r/1.05,z[D+1]=B+x.g/1.05,z[D+2]=b,z[D+3]=1/(_.z>10?this.tileToMeter:u(_,B)),z[D+4]=p[0],z[D+5]=p[1],z[D+6]=p[2]+N,z[D+7]=S[0],z[D+8]=S[1],z[D+9]=S[2],z[D+10]=S[4],z[D+11]=S[5],z[D+12]=S[6],z[D+13]=S[8],z[D+14]=S[9],z[D+15]=S[10],o.instancesEvaluatedElevation[M]=p[2]}}}let s1,o1;It(iy,"ModelBucket",{omit:["layers"]}),It(n1,"PerModelAttributes"),It(r1,"ModelFeature");const Ac=64,Ku={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function a1(n,e,i,o,l,a,h,_,y,w=!1){const p=i.zoom,x=i.project(o),S=Zo(o.lat,p),b=1/S;J.mat4.identity(n),J.mat4.translate(n,n,[x.x+h[0]*b,x.y+h[1]*b,h[2]]);let T=1,M=1;const D=i.worldSize;if(w){if(i.projection.name==="mercator"){let F=0;i.elevation&&(F=i.elevation.getAtPointOrZero(new t(x.x/D,x.y/D),0));const U=J.vec4.transformMat4([],[x.x,x.y,F,1],i.projMatrix)[3]/i.cameraToCenterDistance;T=U,M=U*Zo(i.center.lat,p)}else if(i.projection.name==="globe"){const F=ty(n,i),U=J.mat4.multiply([],i.projMatrix,F),q=[0,0,0,1];J.vec4.transformMat4(q,q,U);const Z=q[3]/i.cameraToCenterDistance,re=Gn(p),ee=i.projection.pixelsPerMeter(o.lat,D)*Zo(o.lat,p),te=i.projection.pixelsPerMeter(i.center.lat,D)*Zo(i.center.lat,p);T=Z/Xt(ee,Hp(i.center.lat),re),M=Z*S/ee,T*=te,M*=te}}else T=b;J.mat4.scale(n,n,[T,T,M]);const z=[...n],N=e.orientation,B=[];if(Qx(B,[N[0]+l[0],N[1]+l[1],N[2]+l[2]],a),J.mat4.multiply(n,z,B),_&&i.elevation){let F=0;const U=[];if(y&&i.elevation){F=function(re,ee,te,pe,ne){const me=ee.elevation;if(!me)return 0;const be=kt.projectAabbCorners(te,pe),ve=bn(1,ne.lat)*ee.worldSize,Me=function(Ht,Et){const Lt=[0,0,1],ei=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const _i of ei){const ri=Ht[_i.corners[0]],Ei=Ht[_i.corners[1]],mi=Ht[_i.corners[2]],Ai=[Ei[0]-ri[0],Ei[1]-ri[1],Et*(Ei[2]-ri[2])],Ni=J.vec3.cross(Ai,Ai,[mi[0]-ri[0],mi[1]-ri[1],Et*(mi[2]-ri[2])]);J.vec3.normalize(Ni,Ni),_i.dotProductWithUp=J.vec3.dot(Ni,Lt)}return ei.sort((_i,ri)=>_i.dotProductWithUp-ri.dotProductWithUp),ei[0].corners}(be,ve),Ee=be[Me[0]],Oe=be[Me[1]],Ce=be[Me[2]],ke=be[Me[3]],rt=me.getAtPointOrZero(new t(Ee[0]/ee.worldSize,Ee[1]/ee.worldSize),0),tt=me.getAtPointOrZero(new t(Oe[0]/ee.worldSize,Oe[1]/ee.worldSize),0),Ct=me.getAtPointOrZero(new t(Ce[0]/ee.worldSize,Ce[1]/ee.worldSize),0),ot=me.getAtPointOrZero(new t(ke[0]/ee.worldSize,ke[1]/ee.worldSize),0),ut=(rt+ot)/2,nt=(tt+Ct)/2;return ut>nt?tt<Ct?Tm(re,Oe,ke,Ee,tt,ot,rt,ve):Tm(re,Ce,Ee,ke,Ct,rt,ot,ve):rt<ot?Tm(re,Ee,Oe,Ce,rt,tt,Ct,ve):Tm(re,ke,Ce,Oe,ot,Ct,tt,ve),Math.max(ut,nt)}(U,i,e.aabb,n,o);const q=J.mat4.fromQuat([],U),Z=J.mat4.multiply([],q,B);J.mat4.multiply(n,z,Z)}else F=i.elevation.getAtPointOrZero(new t(x.x/D,x.y/D),0);F!==0&&(n[14]+=F)}}function of(n,e,i=!1){n.uploaded||(n.gfxTexture=new Jg(e,n.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:n.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),n.uploaded=!0,n.image=null)}function hE(n,e,i){n.indexBuffer=e.createIndexBuffer(n.indexArray,!1,!0),n.vertexBuffer=e.createVertexBuffer(n.vertexArray,nE.members,!1,!0),n.normalArray&&(n.normalBuffer=e.createVertexBuffer(n.normalArray,lE.members,!1,!0)),n.texcoordArray&&(n.texcoordBuffer=e.createVertexBuffer(n.texcoordArray,aE.members,!1,!0)),n.colorArray&&(n.colorBuffer=e.createVertexBuffer(n.colorArray,(n.colorArray.bytesPerElement===12?sE:oE).members,!1,!0)),n.featureArray&&(n.pbrBuffer=e.createVertexBuffer(n.featureArray,uE.members,!0)),n.segments=Tr.simpleSegment(0,0,n.vertexArray.length,n.indexArray.length);const o=n.material;o.pbrMetallicRoughness.baseColorTexture&&of(o.pbrMetallicRoughness.baseColorTexture,e),o.pbrMetallicRoughness.metallicRoughnessTexture&&of(o.pbrMetallicRoughness.metallicRoughnessTexture,e),o.normalTexture&&of(o.normalTexture,e),o.occlusionTexture&&of(o.occlusionTexture,e,i),o.emissionTexture&&of(o.emissionTexture,e)}function ry(n,e,i){if(n.meshes)for(const o of n.meshes)hE(o,e,i);if(n.children)for(const o of n.children)ry(o,e,i)}function Em(n){if(n.meshes)for(const e of n.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(n.children)for(const e of n.children)Em(e)}function ny(n){if(n.meshes)for(const i of n.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(n.children)for(const i of n.children)ny(i)}class Yu{constructor(e,i,o){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=o}static create(e,i,o){const l=o||e.findDEMTileFor(i);if(!l||!l.dem)return;const a=l.dem,h=l.tileID,_=1<<i.canonical.z-h.canonical.z;return new Yu(l,a.dim/ht/_,[(i.canonical.x/_-h.canonical.x)*a.dim,(i.canonical.y/_-h.canonical.y)*a.dim])}tileCoordToPixel(e,i){const o=i*this._scale+this._offset[1],l=Math.floor(e*this._scale+this._offset[0]),a=Math.floor(o);return new we(l,a)}getElevationAt(e,i,o,l){const a=e*this._scale+this._offset[0],h=i*this._scale+this._offset[1],_=Math.floor(a),y=Math.floor(h),w=this._dem;return l=!!l,o?Xt(Xt(w.get(_,y,l),w.get(_,y+1,l),h-y),Xt(w.get(_+1,y,l),w.get(_+1,y+1,l),h-y),a-_):w.get(_,y,l)}getElevationAtPixel(e,i,o){return this._dem.get(e,i,!!o)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*bn(1,e)*this._dem.stride}}const sy=new Float32Array(262144),Ic=new Uint8Array(262144);function l1(n){let e=0;if(n.meshes)for(const i of n.meshes)e=Math.max(e,i.aabb.max[2]);if(n.children)for(const i of n.children)e=Math.max(e,l1(i));return e}function c1(n,e,i){if(n.meshes)for(const o of n.meshes){if(o.aabb.min[0]===1/0)continue;const l=kt.applyTransform(o.aabb,n.matrix);i.insert(e,l.min[0],l.min[1],l.max[0],l.max[1])}if(n.children)for(const o of n.children)c1(o,e,i)}const u1=["","wall","door","roof","window","lamp","logo"];class h1{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:l1(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new kt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new kt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const o of this.node.meshes)this.node.lightMeshIndex!==e&&(o.transformedAabb=kt.applyTransformFast(o.aabb,this.node.matrix),i.encapsulate(o.transformedAabb)),e++;this.aabb=i}return this.aabb}}class Mm{constructor(e,i,o,l,a,h,_){this.id=o,this.layers=e,this.layerIds=this.layers.map(y=>y.fqid),this.stateDependentLayerIds=this.layers.filter(y=>y.isStateDependent()).map(y=>y.id),this.modelTraits|=Ku.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,l&&(this.modelTraits|=Ku.HasMapboxMeshFeatures),a&&(this.modelTraits|=Ku.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=h,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const y of i)this.nodesInfo.push(new h1(y)),c1(y,_.featureIndexArray.length,_.grid),_.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,_.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,i){for(const o of this.getNodesInfo()){const l=o.node;l.footprint&&i.push({footprint:l.footprint,id:e})}}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const o=i?this.stateDependentLayers:this.layers;if(!bt(e,this.states))for(const l of o)this.evaluate(l,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const o of i){const l=o.node;this.uploaded?this.updatePbrBuffer(l):ry(l,e,!0)}for(const o of i)Em(o.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const o of e.meshes)o.pbrBuffer&&(o.pbrBuffer.updateData(o.featureArray),i=!0);return i}needsReEvaluation(e,i,o){const l=e.transform.projectionOptions,a=e.style.getBrightness(),h=this.brightness!==a;if(!this.uploaded||this.dirty||l.name!==this.projection.name||af(o.paint.get("model-color").value,h)||af(o.paint.get("model-color-mix-intensity").value,h)||af(o.paint.get("model-roughness").value,h)||af(o.paint.get("model-emissive-strength").value,h)||af(o.paint.get("model-height-based-emissive-strength-multiplier").value,h)){this.projection=l,this.brightness=a;const _=this.getNodesInfo();for(const y of _)y.state=null;return!0}return!1}evaluateScale(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const o=this.getNodesInfo(),l=this.id.canonical;for(const a of o){const h=a.feature;a.evaluatedScale=i.paint.get("model-scale").evaluate(h,{},l)}}evaluate(e,i){const o=this.getNodesInfo();for(const l of o){if(!l.node.meshes)continue;const a=l.feature,h=i&&i[a.id];if(bt(h,l.state))continue;l.state=structuredClone(h);const _=l.node.meshes&&l.node.meshes[0].featureData,y=l.evaluatedColor[2],w=l.evaluatedRMEA[2],p=this.id.canonical;if(l.hasTranslucentParts=!1,_){for(let x=0;x<u1.length;x++){const S=u1[x];S.length&&(a.properties.part=S);const b=e.paint.get("model-color").evaluate(a,h,p).toRenderColor(null),T=e.paint.get("model-color-mix-intensity").evaluate(a,h,p);l.evaluatedColor[x]=[b.r,b.g,b.b,T],l.evaluatedRMEA[x][0]=e.paint.get("model-roughness").evaluate(a,h,p),l.evaluatedRMEA[x][2]=e.paint.get("model-emissive-strength").evaluate(a,h,p),l.evaluatedRMEA[x][3]=b.a,l.emissionHeightBasedParams[x]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(a,h,p),!l.hasTranslucentParts&&b.a<1&&(l.hasTranslucentParts=!0)}delete a.properties.part,fE(l,y!==l.evaluatedColor[2]||w!==l.evaluatedRMEA[2],this.modelTraits)}else l.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(a,h,p);l.evaluatedScale=e.paint.get("model-scale").evaluate(a,h,p),this.updatePbrBuffer(l.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,o,l){const a=e.findDEMTileFor(o);if(a&&(a.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(a.dem&&a.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=a.tileID.overscaledZ;const h=Yu.create(e,o,a);if(!h)return;this.modelTraits&Ku.HasMapboxMeshFeatures&&this.updateDEM(e,h,o,l);for(const _ of this.getNodesInfo()){const y=_.node;if(!y.footprint||!y.footprint.vertices||!y.footprint.vertices.length)continue;const w=y.footprint.vertices;let p=h.getElevationAt(w[0].x,w[0].y,!0,!0);for(let x=1;x<w.length;x++)p=Math.min(p,h.getElevationAt(w[x].x,w[x].y,!0,!0));y.elevation=p}}this.terrainTile=a.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,o,l){let a=i._dem._modifiedForSources[l];if(a===void 0&&(i._dem._modifiedForSources[l]=[],a=i._dem._modifiedForSources[l]),a.includes(o.canonical))return;const h=i._dem.dim;a.push(o.canonical);let _=!1;for(const y of this.getNodesInfo()){const w=y.node;if(!w.footprint||!w.footprint.grid)continue;const p=w.footprint.grid,x=i.tileCoordToPixel(p.min.x,p.min.y),S=i.tileCoordToPixel(p.max.x,p.max.y),b=Math.min(Math.min(h-S.y,x.x),Math.min(x.y,h-S.x));if(b<0)continue;const T=Dt(b,2,5);let M=Math.max(0,x.x-T),D=Math.max(0,x.y-T),z=Math.min(S.x+T,h-1),N=Math.min(S.y+T,h-1);for(let q=D;q<=N;++q)for(let Z=M;Z<=z;++Z)Ic[q*h+Z]=255;let B=0,F=0;for(let q=0;q<p.cellsY;++q)for(let Z=0;Z<p.cellsX;++Z){if(!p.cells[q*p.cellsX+Z])continue;const re=i.tileCoordToPixel(p.min.x+Z/p.xScale,p.min.y+q/p.yScale),ee=i.tileCoordToPixel(p.min.x+(Z+1)/p.xScale,p.min.y+(q+1)/p.yScale);for(let te=re.y;te<=Math.min(ee.y+1,h-1);++te)for(let pe=re.x;pe<=Math.min(ee.x+1,h-1);++pe)Ic[te*h+pe]===255&&(Ic[te*h+pe]=0,B+=i.getElevationAtPixel(pe,te),F++)}const U=B/F;M=Math.max(1,x.x-T),D=Math.max(1,x.y-T),z=Math.min(S.x+T,h-2),N=Math.min(S.y+T,h-2),_=!0;for(let q=D;q<=N;++q)for(let Z=M;Z<=z;++Z)Ic[q*h+Z]===0&&(sy[q*h+Z]=i._dem.set(Z,q,U));for(let q=1;q<T;++q){M=Math.max(1,x.x-q),D=Math.max(1,x.y-q),z=Math.min(S.x+q,h-2),N=Math.min(S.y+q,h-2);for(let Z=D;Z<=N;++Z)for(let re=M;re<=z;++re){const ee=Z*h+re;if(Ic[ee]===255){let te=0,pe=0,ne=-1,me=-1;for(let be=-1;be<=1;++be)for(let ve=-1;ve<=1;++ve){const Me=(Z+be)*h+re+ve;if(Ic[Me]>=q)continue;const Ee=sy[Me],Oe=Math.abs(Ee);Oe>pe&&(te=Ee,pe=Oe,ne=ve,me=be)}if(pe>.1){const be=1-(q+.5*Math.abs(ne*me))/T;let ve=i._dem.get(re,Z)+te*be;const Me=i._dem.get(re+ne,Z+me),Ee=i._dem.get(re-ne,Z-me,!0);(ve-Me)*(ve-Ee)>0&&(ve=(Me+Ee)/2),sy[ee]=i._dem.set(re,Z,ve),Ic[ee]=q}}}}}_&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=qe.now())}setFilter(e){this.filter=e?_d(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new ur(this.id.overscaledZ),e.feature,this.id.canonical)):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)Em(i.node),ny(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped()),l=this.getNodesInfo();for(let a=0;a<this.nodesInfo.length;a++){const h=l[a].node;l[a].hiddenByReplacement=!!h.footprint&&!o.find(_=>_.footprint===h.footprint)}}getHeightAtTileCoord(e,i){const o=this.getNodesInfo(),l=[],a=[0,0,0],h=J.mat4.identity([]);for(let _=0;_<this.nodesInfo.length;_++){const y=o[_],w=y.node.meshes[0],p=w.transformedAabb;if(e<p.min[0]||i<p.min[1]||e>p.max[0]||i>p.max[1])continue;if(y.node.hidden===!0)return{height:1/0,maxHeight:y.feature.properties.height,hidden:!1,verticalScale:y.evaluatedScale[2]};J.mat4.invert(h,y.node.matrix),a[0]=e,a[1]=i,J.vec3.transformMat4(a,a,h);const x=(a[0]-w.aabb.min[0])/(w.aabb.max[0]-w.aabb.min[0])*Ac|0,S=Math.min(63,(a[1]-w.aabb.min[1])/(w.aabb.max[1]-w.aabb.min[1])*Ac|0)*Ac+Math.min(63,x),b=w.heightmap[S];if(!(b<0&&y.node.footprint))return y.hiddenByReplacement?void 0:{height:b,maxHeight:y.feature.properties.height,hidden:!1,verticalScale:y.evaluatedScale[2]};if(y.node.footprint.grid.query(new we(e,i),new we(e,i),l),l.length>0)return{height:void 0,maxHeight:y.feature.properties.height,hidden:y.hiddenByReplacement,verticalScale:y.evaluatedScale[2]}}}}function af(n,e){return!n.isLightConstant&&e}function dE(n,e,i,o,l,a,h,_){let y=(61440&e|(61440&e)>>4)>>8,w=(3840&e|(3840&e)>>4)>>4,p=240&e|(240&e)>>4;i[3]>0&&(y=Xt(y,255*i[0],i[3]),w=Xt(w,255*i[1],i[3]),p=Xt(p,255*i[2],i[3]));const x=y<<8|w,S=p<<8|Math.floor(255*o[3]),b=function(q){const Z=Dt(q,0,2);return Math.min(Math.round(.5*Z*255),255)}(o[2])<<8|15*o[0]<<4|15*o[1],T=Dt(l[0],0,1),M=Dt(l[1],0,1),D=Dt(l[2],0,1),z=Dt(l[3],0,1);let N,B,F,U;if(T!==M&&h!==a&&M!==T){const q=h-a;B=1/(q*(M-T)),F=-(a+q*T)/(q*(M-T));const Z=Dt(l[4],-1,1);U=Math.pow(10,Z),N=255*D<<8|255*z}else N=65535,B=0,F=1,U=1;if(n.emplaceBack(x,S,b,N,B,F,U),_){const q=_.length;_.clear();for(let Z=0;Z<q;Z++)_.emplaceBack(x,S,b,N,B,F,U)}}function fE(n,e,i){const o=n.node;let l=0;const a=i&Ku.HasMeshoptCompression;for(const h of o.meshes){if(o.lights&&o.lightMeshIndex===l||!h.featureData)continue;h.featureArray=new ku,h.featureArray.reserve(h.featureData.length);let _=e;for(const y of h.featureData){const w=a?65535&y:y>>16&65535,p=a?y>>16&65535:65535&y,x=(15&p)<8?15&p:0,S=n.evaluatedRMEA[x],b=n.evaluatedColor[x],T=n.emissionHeightBasedParams[x];let M;if(_&&x===2&&o.lights&&(M=new ku,M.resize(10*o.lights.length)),dE(h.featureArray,w,b,S,T,h.aabb.min[2],h.aabb.max[2],M),M&&_){_=!1;const D=o.meshes[o.lightMeshIndex];D.featureArray=M,D.featureArray._trim()}}h.featureArray._trim(),l++}}function d1(n,e,i,o){const l=1<<n.z;e.lat=fn((o/ht+n.y)/l),e.lng=Kn((i/ht+n.x)/l)}It(Mm,"Tiled3dModelBucket",{omit:["layers"]}),It(h1,"Tiled3dModelFeature");const pE={circle:class extends un{constructor(n,e,i,o){super(n,{layout:De||(De=new Cr({"circle-sort-key":new At(Fe.layout_circle["circle-sort-key"]),"circle-elevation-reference":new ct(Fe.layout_circle["circle-elevation-reference"]),visibility:new ct(Fe.layout_circle.visibility)})),paint:Ke||(Ke=new Cr({"circle-radius":new At(Fe.paint_circle["circle-radius"]),"circle-color":new At(Fe.paint_circle["circle-color"]),"circle-blur":new At(Fe.paint_circle["circle-blur"]),"circle-opacity":new At(Fe.paint_circle["circle-opacity"]),"circle-translate":new ct(Fe.paint_circle["circle-translate"]),"circle-translate-anchor":new ct(Fe.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ct(Fe.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ct(Fe.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new At(Fe.paint_circle["circle-stroke-width"]),"circle-stroke-color":new At(Fe.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new At(Fe.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new ct(Fe.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}createBucket(n){return new V(n)}queryRadius(n){const e=n;return Le("circle-radius",this,e)+Le("circle-stroke-width",this,e)+Ye(this.paint.get("circle-translate"))}queryIntersectsFeature(n,e,i,o,l,a,h,_){const y=at(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),a.angle,n.pixelToTileUnitsFactor),w=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return ju(n,o,a,h,_,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",y,w)}getProgramIds(){return["circle"]}getDefaultProgramParams(n,e,i){const o=_l(this);return{config:new ga(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}},heatmap:class extends un{createBucket(n){return new Fv(n)}constructor(n,e,i,o){super(n,{layout:Bv||(Bv=new Cr({visibility:new ct(Fe.layout_heatmap.visibility)})),paint:Nv||(Nv=new Cr({"heatmap-radius":new At(Fe.paint_heatmap["heatmap-radius"]),"heatmap-weight":new At(Fe.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ct(Fe.paint_heatmap["heatmap-intensity"]),"heatmap-color":new al(Fe.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ct(Fe.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Vd({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(n){return Le("heatmap-radius",this,n)}queryIntersectsFeature(n,e,i,o,l,a,h,_){const y=this.paint.get("heatmap-radius").evaluate(e,i);return ju(n,o,a,h,_,!0,!0,new we(0,0),y)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(n,e,i){return n==="heatmap"?{config:new ga(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends un{constructor(n,e,i,o){super(n,{layout:Vv||(Vv=new Cr({visibility:new ct(Fe.layout_hillshade.visibility)})),paint:Uv||(Uv=new Cr({"hillshade-illumination-direction":new ct(Fe.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ct(Fe.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ct(Fe.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ct(Fe.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ct(Fe.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ct(Fe.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new ct(Fe.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(n,e,i){return{overrideFog:!1}}},fill:class extends un{constructor(n,e,i,o){super(n,{layout:o0||(o0=new Cr({"fill-sort-key":new At(Fe.layout_fill["fill-sort-key"]),visibility:new ct(Fe.layout_fill.visibility),"fill-elevation-reference":new ct(Fe.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new At(Fe.layout_fill["fill-construct-bridge-guard-rail"])})),paint:a0||(a0=new Cr({"fill-antialias":new ct(Fe.paint_fill["fill-antialias"]),"fill-opacity":new At(Fe.paint_fill["fill-opacity"]),"fill-color":new At(Fe.paint_fill["fill-color"]),"fill-outline-color":new At(Fe.paint_fill["fill-outline-color"]),"fill-translate":new ct(Fe.paint_fill["fill-translate"]),"fill-translate-anchor":new ct(Fe.paint_fill["fill-translate-anchor"]),"fill-pattern":new At(Fe.paint_fill["fill-pattern"]),"fill-emissive-strength":new ct(Fe.paint_fill["fill-emissive-strength"]),"fill-z-offset":new At(Fe.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new At(Fe.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new At(Fe.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){const n=this.paint.get("fill-pattern"),e=n&&n.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(n,e,i){return{config:new ga(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(n,e){super.recalculate(n,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(n){return new Sg(n)}queryRadius(){return Ye(this.paint.get("fill-translate"))}queryIntersectsFeature(n,e,i,o,l,a){return!n.queryGeometry.isAboveHorizon&&W(Je(n.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),a.angle,n.pixelToTileUnitsFactor),o)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(n){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return n!=null?e&&!n:e}},"fill-extrusion":class extends un{constructor(n,e,i,o){super(n,{layout:O0||(O0=new Cr({visibility:new ct(Fe["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new ct(Fe["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:k0||(k0=new Cr({"fill-extrusion-opacity":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new At(Fe["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new At(Fe["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new At(Fe["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new At(Fe["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new At(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new At(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new At(Fe["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new At(Fe["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new ct(Fe["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new im(n)}queryRadius(){return Ye(this.paint.get("fill-extrusion-translate"))}is3D(n){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(n,e,i,o,l,a,h,_,y){const w=at(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),a.angle,n.pixelToTileUnitsFactor),p=this.paint.get("fill-extrusion-height").evaluate(e,i),x=this.paint.get("fill-extrusion-base").evaluate(e,i),S=[0,0],b=_&&a.elevation,T=a.elevation?a.elevation.exaggeration():1,M=n.tile.getBucket(this);if(b&&M instanceof im){const F=M.centroidVertexArray,U=y+1;U<F.length&&(S[0]=F.geta_centroid_pos0(U),S[1]=F.geta_centroid_pos1(U))}if(S[0]===0&&S[1]===1)return!1;a.projection.name==="globe"&&(o=L0([o],[new we(0,0),new we(ht,ht)],n.tileID.canonical).map(F=>F.polygon).flat());const D=b?_:null,[z,N]=function(F,U,q,Z,re,ee,te,pe,ne,me,be){return F.projection.name==="globe"?function(ve,Me,Ee,Oe,Ce,ke,rt,tt,Ct,ot,ut){const nt=[],Ht=[],Et=ve.projection.upVectorScale(ut,ve.center.lat,ve.worldSize).metersToTile,Lt=[0,0,0,1],ei=[0,0,0,1],_i=(Ei,mi,Ai,Ni)=>{Ei[0]=mi,Ei[1]=Ai,Ei[2]=Ni,Ei[3]=1},ri=z0();Ee>0&&(Ee+=ri),Oe+=ri;for(const Ei of Me){const mi=[],Ai=[];for(const Ni of Ei){const hr=Ni.x+Ce.x,ti=Ni.y+Ce.y,Di=ve.projection.projectTilePoint(hr,ti,ut),vr=ve.projection.upVector(ut,Ni.x,Ni.y);let Mr=Ee,Pr=Oe;if(rt){const Dr=B0(hr,ti,Ee,Oe,rt,tt,Ct,ot);Mr+=Dr.base,Pr+=Dr.top}Ee!==0?_i(Lt,Di.x+vr[0]*Et*Mr,Di.y+vr[1]*Et*Mr,Di.z+vr[2]*Et*Mr):_i(Lt,Di.x,Di.y,Di.z),_i(ei,Di.x+vr[0]*Et*Pr,Di.y+vr[1]*Et*Pr,Di.z+vr[2]*Et*Pr),J.vec3.transformMat4(Lt,Lt,ke),J.vec3.transformMat4(ei,ei,ke),mi.push(new Ec(Lt[0],Lt[1],Lt[2])),Ai.push(new Ec(ei[0],ei[1],ei[2]))}nt.push(mi),Ht.push(Ai)}return[nt,Ht]}(F,U,q,Z,re,ee,te,pe,ne,me,be):te?function(ve,Me,Ee,Oe,Ce,ke,rt,tt,Ct){const ot=[],ut=[],nt=[0,0,0,1];for(const Ht of ve){const Et=[],Lt=[];for(const ei of Ht){const _i=ei.x+Oe.x,ri=ei.y+Oe.y,Ei=B0(_i,ri,Me,Ee,ke,rt,tt,Ct);nt[0]=_i,nt[1]=ri,nt[2]=Ei.base,nt[3]=1,J.vec4.transformMat4(nt,nt,Ce),nt[3]=Math.max(nt[3],1e-5);const mi=new Ec(nt[0]/nt[3],nt[1]/nt[3],nt[2]/nt[3]);nt[0]=_i,nt[1]=ri,nt[2]=Ei.top,nt[3]=1,J.vec4.transformMat4(nt,nt,Ce),nt[3]=Math.max(nt[3],1e-5);const Ai=new Ec(nt[0]/nt[3],nt[1]/nt[3],nt[2]/nt[3]);Et.push(mi),Lt.push(Ai)}ot.push(Et),ut.push(Lt)}return[ot,ut]}(U,q,Z,re,ee,te,pe,ne,me):function(ve,Me,Ee,Oe,Ce){const ke=[],rt=[],tt=Ce[8]*Me,Ct=Ce[9]*Me,ot=Ce[10]*Me,ut=Ce[11]*Me,nt=Ce[8]*Ee,Ht=Ce[9]*Ee,Et=Ce[10]*Ee,Lt=Ce[11]*Ee;for(const ei of ve){const _i=[],ri=[];for(const Ei of ei){const mi=Ei.x+Oe.x,Ai=Ei.y+Oe.y,Ni=Ce[0]*mi+Ce[4]*Ai+Ce[12],hr=Ce[1]*mi+Ce[5]*Ai+Ce[13],ti=Ce[2]*mi+Ce[6]*Ai+Ce[14],Di=Ce[3]*mi+Ce[7]*Ai+Ce[15],vr=Ni+tt,Mr=hr+Ct,Pr=ti+ot,Dr=Math.max(Di+ut,1e-5),cr=Ni+nt,on=hr+Ht,qn=ti+Et,Hr=Math.max(Di+Lt,1e-5);_i.push(new Ec(vr/Dr,Mr/Dr,Pr/Dr)),ri.push(new Ec(cr/Hr,on/Hr,qn/Hr))}ke.push(_i),rt.push(ri)}return[ke,rt]}(U,q,Z,re,ee)}(a,o,x,p,w,h,D,S,T,a.center.lat,n.tileID.canonical),B=n.queryGeometry;return function(F,U,q){let Z=1/0;W(q,U)&&(Z=F0(q,U[0]));for(let re=0;re<U.length;re++){const ee=U[re],te=F[re];for(let pe=0;pe<ee.length-1;pe++){const ne=ee[pe],me=[ne,ee[pe+1],te[pe+1],te[pe],ne];H(q,me)&&(Z=Math.min(Z,F0(q,me)))}}return Z!==1/0&&Z}(z,N,B.isPointQuery()?B.screenBounds:B.screenGeometry)}},line:class extends un{constructor(n,e,i,o){const l=W0();super(n,l,e,i,o),l.layout&&(this.layout=new ol(l.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(n){if(n==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Ws,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(n,e){super.recalculate(n,e),this.paint._values["line-floorwidth"]=(()=>{if(Xd)return Xd;const i=W0();return Xd=new pS(i.paint.properties["line-width"].specification),Xd.useIntegerZoom=!0,Xd})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,n)}createBucket(n){return new Rg(n)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(n,e,i){const o=H0(this);return{config:new ga(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}queryRadius(n){const e=n,i=X0(Le("line-width",this,e),Le("line-gap-width",this,e)),o=Le("line-offset",this,e);return i/2+Math.abs(o)+Ye(this.paint.get("line-translate"))}queryIntersectsFeature(n,e,i,o,l,a){if(n.queryGeometry.isAboveHorizon)return!1;const h=Je(n.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),a.angle,n.pixelToTileUnitsFactor),_=n.pixelToTileUnitsFactor/2*X0(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),y=this.paint.get("line-offset").evaluate(e,i);return y&&(o=function(w,p){const x=[],S=new we(0,0);for(let b=0;b<w.length;b++){const T=w[b],M=[];for(let D=0;D<T.length;D++){const z=T[D],N=T[D+1],B=D===0?S:z.sub(T[D-1])._unit()._perp(),F=D===T.length-1?S:N.sub(z)._unit()._perp(),U=B._add(F)._unit();U._mult(1/(U.x*F.x+U.y*F.y)),M.push(U._mult(p)._add(z))}x.push(M)}return x}(o,y*n.pixelToTileUnitsFactor)),function(w,p,x){for(let S=0;S<p.length;S++){const b=p[S];if(w.length>=3){for(let T=0;T<b.length;T++)if(ue(w,b[T]))return!0}if(K(w,b,x))return!0}return!1}(h,o,_)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(n){return!this.hasElevatedBuckets}},symbol:ym,background:class extends un{constructor(n,e,i,o){super(n,{layout:Fx||(Fx=new Cr({visibility:new ct(Fe.layout_background.visibility)})),paint:Bx||(Bx=new Cr({"background-pitch-alignment":new ct(Fe.paint_background["background-pitch-alignment"]),"background-color":new ct(Fe.paint_background["background-color"]),"background-pattern":new ct(Fe.paint_background["background-pattern"]),"background-opacity":new ct(Fe.paint_background["background-opacity"]),"background-emissive-strength":new ct(Fe.paint_background["background-emissive-strength"]),"background-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(n,e,i){return{overrideFog:!1}}is3D(n){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:Gx,"raster-particle":Xx,sky:class extends un{constructor(n,e,i,o){super(n,{layout:Hx||(Hx=new Cr({visibility:new ct(Fe.layout_sky.visibility)})),paint:Zx||(Zx=new Cr({"sky-type":new ct(Fe.paint_sky["sky-type"]),"sky-atmosphere-sun":new ct(Fe.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ct(Fe.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ct(Fe.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ct(Fe.paint_sky["sky-gradient-radius"]),"sky-gradient":new al(Fe.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ct(Fe.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ct(Fe.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ct(Fe.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="sky-gradient"?this._updateColorRamp():n!=="sky-atmosphere-sun"&&n!=="sky-atmosphere-halo-color"&&n!=="sky-atmosphere-color"&&n!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Vd({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(n){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=n.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(n,e){if(this.paint.get("sky-type")==="atmosphere"){const o=this.paint.get("sky-atmosphere-sun"),l=!o,a=n.style.light,h=a.properties.get("position");return l&&a.properties.get("anchor")==="viewport"&&br("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),l?Qg(h.azimuthal,90-h.polar,e):Qg(o[0],90-o[1],e)}const i=this.paint.get("sky-gradient-center");return Qg(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(n){this._skyboxInvalidated=!1,this._lightPosition=n.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const n=this.paint.get("sky-type");return n==="atmosphere"?["skyboxCapture","skybox"]:n==="gradient"?["skyboxGradient"]:null}},slot:class extends un{constructor(n,e,i,o){super(n,{paint:Wx||(Wx=new Cr({}))},e,null)}},model:class extends un{constructor(n,e,i,o){super(n,{layout:s1||(s1=new Cr({visibility:new ct(Fe.layout_model.visibility),"model-id":new At(Fe.layout_model["model-id"])})),paint:o1||(o1=new Cr({"model-opacity":new At(Fe.paint_model["model-opacity"]),"model-rotation":new At(Fe.paint_model["model-rotation"]),"model-scale":new At(Fe.paint_model["model-scale"]),"model-translation":new At(Fe.paint_model["model-translation"]),"model-color":new At(Fe.paint_model["model-color"]),"model-color-mix-intensity":new At(Fe.paint_model["model-color-mix-intensity"]),"model-type":new ct(Fe.paint_model["model-type"]),"model-cast-shadows":new ct(Fe.paint_model["model-cast-shadows"]),"model-receive-shadows":new ct(Fe.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new ct(Fe.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new At(Fe.paint_model["model-emissive-strength"]),"model-roughness":new At(Fe.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new At(Fe.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new ct(Fe.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new ct(Fe.paint_model["model-front-cutoff"]),"model-color-use-theme":new At({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new iy(n)}getProgramIds(){return["model"]}is3D(n){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(n){return n instanceof Mm?ht-1:0}queryIntersectsFeature(n,e,i,o,l,a){if(!this.modelManager)return!1;const h=this.modelManager,_=n.tile.getBucket(this);if(!(_&&_ instanceof iy))return!1;for(const y in _.instancesPerModel){const w=_.instancesPerModel[y],p=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(w.idToFeaturesIndex.hasOwnProperty(p)){const x=w.features[w.idToFeaturesIndex[p]],S=h.getModel(y,this.scope);if(!S)return!1;let b=J.mat4.create();const T=new Zi(0,0),M=_.canonical;let D=Number.MAX_VALUE;for(let z=0;z<x.instancedDataCount;++z){const N=16*(x.instancedDataOffset+z),B=w.instancedDataArray.float32,F=[B[N+4],B[N+5],B[N+6]];d1(M,T,B[N],0|B[N+1]),a1(b,S,a,T,x.rotation,x.scale,F,!1,!1,!1),a.projection.name==="globe"&&(b=ty(b,a));const U=J.mat4.multiply([],a.projMatrix,b),q=n.queryGeometry,Z=e1(q.isPointQuery()?q.screenBounds:q.screenGeometry,a,U,S.aabb);Z!=null&&(D=Math.min(Z,D))}return D!==Number.MAX_VALUE&&D}}return!1}_handleOverridablePaintPropertyUpdate(n,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||n!=="model-color"&&n!=="model-color-mix-intensity"&&n!=="model-rotation"&&n!=="model-scale"&&n!=="model-translation"&&n!=="model-emissive-strength")}_isPropertyZoomDependent(n){const e=this._transitionablePaint._values[n];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof el}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends un{constructor(n,e,i,o){super(n,{layout:l0||(l0=new Cr({"clip-layer-types":new ct(Fe.layout_clip["clip-layer-types"]),"clip-layer-scope":new ct(Fe.layout_clip["clip-layer-scope"])})),paint:c0||(c0=new Cr({}))},e,i,o)}recalculate(n,e){super.recalculate(n,e)}createBucket(n){return new u0(n)}is3D(n){return!0}}};class mE{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class _E{constructor(){this.tasks={},this.taskQueue=[],Ln(["process"],this),this.invoker=new mE(this.process),this.nextId=0}add(e,i){const o=this.nextId++,l=function({type:a,isSymbolTile:h,zoom:_}){return _=_||0,a==="message"?0:a!=="maybePrepare"||h?a!=="parseTile"||h?a==="parseTile"&&h?300-_:a==="maybePrepare"&&h?400-_:500:200-_:100-_}(i);if(l===0){try{e()}finally{}return null}return this.tasks[o]={fn:e,metadata:i,priority:l,id:o},this.taskQueue.push(o),this.invoker.trigger(),{cancel:()=>{delete this.tasks[o]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(o=>!!this.tasks[o]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let l=0;l<this.taskQueue.length;l++){const a=this.tasks[this.taskQueue[l]];a.priority<i&&(i=a.priority,e=l)}if(e===null)return null;const o=this.taskQueue[e];return this.taskQueue.splice(e,1),o}remove(){this.invoker.remove()}}class f1{constructor(e,i,o){this.target=e,this.parent=i,this.mapId=o,this.callbacks={},this.cancelCallbacks={},Ln(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new _E}send(e,i,o,l,a=!1,h){const _=Math.round(1e18*Math.random()).toString(36).substring(0,10);o&&(o.metadata=h,this.callbacks[_]=o);const y=new Set;return this.target.postMessage({id:_,type:e,hasCallback:!!o,targetMapId:l,mustQueue:a,sourceMapId:this.mapId,data:No(i,y)},y),{cancel:()=>{o&&delete this.callbacks[_],this.target.postMessage({id:_,type:"<cancel>",targetMapId:l,sourceMapId:this.mapId})}}}receive(e){const i=e.data;if(!i)return;const o=i.id;if(o&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const l=this.cancelCallbacks[o];delete this.cancelCallbacks[o],l&&l.cancel()}else if(i.mustQueue||Nn()){const l=this.callbacks[o],a=this.scheduler.add(()=>this.processTask(o,i),l&&l.metadata||{type:"message"});a&&(this.cancelCallbacks[o]=a)}else this.processTask(o,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const o=this.callbacks[e];delete this.callbacks[e],o&&(i.error?o(cs(i.error)):o(null,cs(i.data)))}else{const o=new Set,l=i.hasCallback?(h,_)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:h?No(h):null,data:No(_,o)},o)}:()=>{},a=cs(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,a,l);else if(this.parent.getWorkerSource){const h=i.type.split(".");this.parent.getWorkerSource(i.sourceMapId,h[0],a.source,a.scope)[h[1]](a,l)}else l(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var lf={workerUrl:"",workerClass:null,workerParams:void 0};const oy="mapboxgl_preloaded_worker_pool";class Cc{constructor(){this.active={}}acquire(e,i=Cc.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(lf.workerClass!=null?new lf.workerClass:new self.Worker(lf.workerUrl,lf.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[oy]}numActive(){return Object.keys(this.active).length}}Cc.workerCount=2;class Ju{constructor(e,i,o="Worker",l=Cc.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Vr();const a=this.workerPool.acquire(this.id,l);for(let h=0;h<a.length;h++){const _=new Ju.Actor(a[h],i,this.id);_.name=`${o} ${h}`,this.actors.push(_)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,o){gr(this.actors,(l,a)=>{l.send(e,i,a)},o=o||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let cf,ay;function Am(){return cf||(cf=new Cc),cf}Ju.Actor=f1;const ly=new tr(0,0,0);var cy=(n=>(n[n.PATH_RULE_UNSPECIFIED=0]="PATH_RULE_UNSPECIFIED",n[n.PATH_RULE_NON_ZERO=1]="PATH_RULE_NON_ZERO",n[n.PATH_RULE_EVEN_ODD=2]="PATH_RULE_EVEN_ODD",n))(cy||{}),Im=(n=>(n[n.LINE_CAP_UNSPECIFIED=0]="LINE_CAP_UNSPECIFIED",n[n.LINE_CAP_BUTT=1]="LINE_CAP_BUTT",n[n.LINE_CAP_ROUND=2]="LINE_CAP_ROUND",n[n.LINE_CAP_SQUARE=3]="LINE_CAP_SQUARE",n))(Im||{}),uf=(n=>(n[n.LINE_JOIN_UNSPECIFIED=0]="LINE_JOIN_UNSPECIFIED",n[n.LINE_JOIN_MITER=1]="LINE_JOIN_MITER",n[n.LINE_JOIN_MITER_CLIP=2]="LINE_JOIN_MITER_CLIP",n[n.LINE_JOIN_ROUND=3]="LINE_JOIN_ROUND",n[n.LINE_JOIN_BEVEL=4]="LINE_JOIN_BEVEL",n))(uf||{}),p1=(n=>(n[n.PAINT_ORDER_UNSPECIFIED=0]="PAINT_ORDER_UNSPECIFIED",n[n.PAINT_ORDER_FILL_AND_STROKE=1]="PAINT_ORDER_FILL_AND_STROKE",n[n.PAINT_ORDER_STROKE_AND_FILL=2]="PAINT_ORDER_STROKE_AND_FILL",n))(p1||{}),Qu=(n=>(n[n.PATH_COMMAND_UNSPECIFIED=0]="PATH_COMMAND_UNSPECIFIED",n[n.PATH_COMMAND_MOVE=1]="PATH_COMMAND_MOVE",n[n.PATH_COMMAND_LINE=2]="PATH_COMMAND_LINE",n[n.PATH_COMMAND_QUAD=3]="PATH_COMMAND_QUAD",n[n.PATH_COMMAND_CUBIC=4]="PATH_COMMAND_CUBIC",n[n.PATH_COMMAND_CLOSE=5]="PATH_COMMAND_CLOSE",n))(Qu||{}),m1=(n=>(n[n.MASK_TYPE_UNSPECIFIED=0]="MASK_TYPE_UNSPECIFIED",n[n.MASK_TYPE_LUMINANCE=1]="MASK_TYPE_LUMINANCE",n[n.MASK_TYPE_ALPHA=2]="MASK_TYPE_ALPHA",n))(m1||{});function gE(n,e,i){n===1&&e.icons.push(function(o,l){return function(a){if(a.usvg_tree.height||(a.usvg_tree.height=a.usvg_tree.width),!a.metadata)return a;const{metadata:h}=a;if(h.content_area){const{content_area:_}=h;_.top==null&&(_.top=_.left),_.width==null&&(_.width=a.usvg_tree.width),_.height==null&&(_.height=_.width)}return h.stretch_x&&h.stretch_x.length&&_1(h,"x"),h.stretch_y&&h.stretch_y.length&&_1(h,"y"),a}(o.readFields(yE,{name:void 0},l))}(i,i.readVarint()+i.pos))}function _1(n,e){const i=[],o=n[`stretch_${e}`];let l=null;for(let a=0;a<o.length;a++)l===null?l=i.length===0?o[0]:i[i.length-1][1]+o[a]:(i.push([l,l+o[a]]),l=null);n[`stretch_${e}_areas`]=i}function yE(n,e,i){n===1?e.name=i.readString():n===2?e.metadata=function(o,l){return o.readFields(vE,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},l)}(i,i.readVarint()+i.pos):n===3&&(e.usvg_tree=function(o,l){return o.readFields(wE,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},l)}(i,i.readVarint()+i.pos),e.data="usvg_tree")}function vE(n,e,i){n===1?e.stretch_x=i.readPackedVarint():n===2?e.stretch_y=i.readPackedVarint():n===3?e.content_area=function(o,l){return o.readFields(xE,{left:0},l)}(i,i.readVarint()+i.pos):n===4&&e.variables.push(function(o,l){return o.readFields(bE,{name:void 0},l)}(i,i.readVarint()+i.pos))}function xE(n,e,i){n===1?e.left=i.readVarint():n===2?e.width=i.readVarint():n===3?e.top=i.readVarint():n===4&&(e.height=i.readVarint())}function bE(n,e,i){n===1?e.name=i.readString():n===2&&(e.rgb_color=Rm(i.readVarint()),e.value="rgb_color")}function wE(n,e,i){n===1?e.width=e.height=i.readVarint():n===2?e.height=i.readVarint():n===3?e.children.push(Cm(i,i.readVarint()+i.pos)):n===4?e.linear_gradients.push(function(o,l){return o.readFields(CE,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},l)}(i,i.readVarint()+i.pos)):n===5?e.radial_gradients.push(function(o,l){return o.readFields(RE,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},l)}(i,i.readVarint()+i.pos)):n===7?e.clip_paths.push(function(o,l){return o.readFields(DE,{children:[]},l)}(i,i.readVarint()+i.pos)):n===8&&e.masks.push(function(o,l){const a=o.readFields(zE,{left:0,width:20,mask_type:1,children:[]},l);return a.height==null&&(a.height=a.width),a.top==null&&(a.top=a.left),a}(i,i.readVarint()+i.pos))}function Cm(n,e){return n.readFields(TE,{},e)}function TE(n,e,i){n===1?(e.group=function(o,l){return o.readFields(SE,{opacity:255,children:[]},l)}(i,i.readVarint()+i.pos),e.node="group"):n===2&&(e.path=function(o,l){return o.readFields(ME,{paint_order:1,commands:[],step:1,diffs:[],rule:1},l)}(i,i.readVarint()+i.pos),e.node="path")}function SE(n,e,i){n===1?e.transform=Pm(i,i.readVarint()+i.pos):n===2?e.opacity=i.readVarint():n===5?e.clip_path_idx=i.readVarint():n===6?e.mask_idx=i.readVarint():n===7&&e.children.push(Cm(i,i.readVarint()+i.pos))}function Pm(n,e){return n.readFields(EE,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function EE(n,e,i){n===1?e.sx=i.readFloat():n===2?e.ky=i.readFloat():n===3?e.kx=i.readFloat():n===4?e.sy=i.readFloat():n===5?e.tx=i.readFloat():n===6&&(e.ty=i.readFloat())}function ME(n,e,i){n===1?e.fill=function(o,l){return o.readFields(AE,{rgb_color:ly,paint:"rgb_color",opacity:255},l)}(i,i.readVarint()+i.pos):n===2?e.stroke=function(o,l){return o.readFields(IE,{rgb_color:ly,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},l)}(i,i.readVarint()+i.pos):n===3?e.paint_order=i.readVarint():n===5?i.readPackedVarint(e.commands):n===6?e.step=i.readFloat():n===7?i.readPackedSVarint(e.diffs):n===8&&(e.rule=i.readVarint())}function AE(n,e,i){n===1?(e.rgb_color=Rm(i.readVarint()),e.paint="rgb_color"):n===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):n===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):n===5&&(e.opacity=i.readVarint())}function Rm(n){return new tr((n>>16&255)/255,(n>>8&255)/255,(255&n)/255,1)}function IE(n,e,i){n===1?(e.rgb_color=Rm(i.readVarint()),e.paint="rgb_color"):n===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):n===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):n===5?i.readPackedFloat(e.dasharray):n===6?e.dashoffset=i.readFloat():n===7?e.miterlimit=i.readFloat():n===8?e.opacity=i.readVarint():n===9?e.width=i.readFloat():n===10?e.linecap=i.readVarint():n===11&&(e.linejoin=i.readVarint())}function CE(n,e,i){n===1?e.transform=Pm(i,i.readVarint()+i.pos):n===2?e.spread_method=i.readVarint():n===3?e.stops.push(g1(i,i.readVarint()+i.pos)):n===4?e.x1=i.readFloat():n===5?e.y1=i.readFloat():n===6?e.x2=i.readFloat():n===7&&(e.y2=i.readFloat())}function g1(n,e){return n.readFields(PE,{offset:0,opacity:255,rgb_color:ly},e)}function PE(n,e,i){n===1?e.offset=i.readFloat():n===2?e.opacity=i.readVarint():n===3&&(e.rgb_color=Rm(i.readVarint()))}function RE(n,e,i){n===1?e.transform=Pm(i,i.readVarint()+i.pos):n===2?e.spread_method=i.readVarint():n===3?e.stops.push(g1(i,i.readVarint()+i.pos)):n===4?e.cx=i.readFloat():n===5?e.cy=i.readFloat():n===6?e.r=i.readFloat():n===7?e.fx=i.readFloat():n===8?e.fy=i.readFloat():n===9&&(e.fr=i.readFloat())}function DE(n,e,i){n===1?e.transform=Pm(i,i.readVarint()+i.pos):n===2?e.clip_path_idx=i.readVarint():n===3&&e.children.push(Cm(i,i.readVarint()+i.pos))}function zE(n,e,i){n===1?e.left=e.top=i.readFloat():n===2?e.width=e.height=i.readFloat():n===3?e.top=i.readFloat():n===4?e.height=i.readFloat():n===5?e.mask_type=i.readVarint():n===6?e.mask_idx=i.readVarint():n===7&&e.children.push(Cm(i,i.readVarint()+i.pos))}class LE{static calculate(e={},i=[]){const o=new Map,l=new Map;if(Object.keys(e).length===0)return o;i.forEach(a=>{l.set(a.name,a.rgb_color||new tr(0,0,0))});for(const[a,h]of Object.entries(e))l.has(a)?o.set(l.get(a).toStringPremultipliedAlpha(),h):console.warn(`Ignoring unknown image variable "${a}"`);return o}}function eh(n,e=255,i){const o=e/255,l=n.toStringPremultipliedAlpha(),a=i.has(l)?i.get(l).clone():n.clone();return a.a*=o,a.toString()}function hf(n,e){if(!We()){const i=document.createElement("canvas");return i.width=n,i.height=e,i}return new OffscreenCanvas(n,e)}function OE(n,e){const i=LE.calculate(e.params,n.metadata?n.metadata.variables:[]),o=n.usvg_tree,l=o.width,a=o.height,h=e.transform?e.transform:new DOMMatrix,_=Math.max(1,Math.round(l*h.a)),y=Math.max(1,Math.round(a*h.d)),w=new DOMMatrix([_/l,0,0,y/a,0,0]),p=hf(_,y).getContext("2d");return uy(p,w,o,o,i),p.getImageData(0,0,_,y)}function uy(n,e,i,o,l){for(const a of o.children)y1(n,e,i,a,l)}function y1(n,e,i,o,l){o.group?(n.save(),function(a,h,_,y,w){const p=y.mask_idx!=null?_.masks[y.mask_idx]:null,x=y.clip_path_idx!=null?_.clip_paths[y.clip_path_idx]:null;if(y.transform&&(h=Dm(y.transform).preMultiplySelf(h)),!function(T,M,D){return T.opacity!==255||M||D}(y,x!=null,p!=null))return void uy(a,h,_,y,w);const S=hf(a.canvas.width,a.canvas.height),b=S.getContext("2d");uy(b,h,_,y,w),x&&E1(b,h,_,x),p&&M1(b,h,_,p,w),a.globalAlpha=y.opacity/255,a.drawImage(S,0,0)}(n,e,i,o.group,l),n.restore()):o.path&&(n.save(),function(a,h,_,y,w){const p=A1(y);a.setTransform(h),y.paint_order===p1.PAINT_ORDER_FILL_AND_STROKE?(v1(a,_,y,p,w),b1(a,_,y,p,w)):(b1(a,_,y,p,w),v1(a,_,y,p,w))}(n,e,i,o.path,l),n.restore())}function v1(n,e,i,o,l){const a=i.fill;if(!a)return;const h=a.opacity/255;switch(a.paint){case"rgb_color":n.fillStyle=eh(a.rgb_color,a.opacity,l);break;case"linear_gradient_idx":n.fillStyle=w1(n,e.linear_gradients[a.linear_gradient_idx],h,l);break;case"radial_gradient_idx":n.fillStyle=T1(n,e.radial_gradients[a.radial_gradient_idx],h,l)}n.fill(o,x1(i))}function x1(n){return n.rule===cy.PATH_RULE_NON_ZERO?"nonzero":n.rule===cy.PATH_RULE_EVEN_ODD?"evenodd":void 0}function b1(n,e,i,o,l){const a=i.stroke;if(!a)return;n.lineWidth=a.width,n.miterLimit=a.miterlimit,n.setLineDash(a.dasharray),n.lineDashOffset=a.dashoffset;const h=a.opacity/255;switch(a.paint){case"rgb_color":n.strokeStyle=eh(a.rgb_color,a.opacity,l);break;case"linear_gradient_idx":n.strokeStyle=w1(n,e.linear_gradients[a.linear_gradient_idx],h,l);break;case"radial_gradient_idx":n.strokeStyle=T1(n,e.radial_gradients[a.radial_gradient_idx],h,l)}switch(a.linejoin){case uf.LINE_JOIN_MITER_CLIP:case uf.LINE_JOIN_MITER:n.lineJoin="miter";break;case uf.LINE_JOIN_ROUND:n.lineJoin="round";break;case uf.LINE_JOIN_BEVEL:n.lineJoin="bevel"}switch(a.linecap){case Im.LINE_CAP_BUTT:n.lineCap="butt";break;case Im.LINE_CAP_ROUND:n.lineCap="round";break;case Im.LINE_CAP_SQUARE:n.lineCap="square"}n.stroke(o)}function w1(n,e,i,o){if(e.stops.length===1){const S=e.stops[0];return eh(S.rgb_color,S.opacity*i,o)}const l=Dm(e.transform),{x1:a,y1:h,x2:_,y2:y}=e,w=l.transformPoint(new DOMPoint(a,h)),p=l.transformPoint(new DOMPoint(_,y)),x=n.createLinearGradient(w.x,w.y,p.x,p.y);for(const S of e.stops)x.addColorStop(S.offset,eh(S.rgb_color,S.opacity*i,o));return x}function T1(n,e,i,o){if(e.stops.length===1){const S=e.stops[0];return eh(S.rgb_color,S.opacity*i,o)}const l=Dm(e.transform),{fx:a,fy:h,cx:_,cy:y}=e,w=l.transformPoint(new DOMPoint(a,h)),p=l.transformPoint(new DOMPoint(_,y)),x=n.createRadialGradient(w.x,w.y,0,p.x,p.y,e.r*((l.a+l.d)/2));for(const S of e.stops)x.addColorStop(S.offset,eh(S.rgb_color,S.opacity*i,o));return x}function S1(n,e,i,o){const l=o.transform?Dm(o.transform).preMultiplySelf(e):e,a=hf(n.canvas.width,n.canvas.height),h=a.getContext("2d");for(const y of o.children)if(y.group)S1(h,l,i,y.group);else if(y.path){const w=y.path,p=new Path2D;p.addPath(A1(w),l),h.fill(p,x1(w))}const _=o.clip_path_idx!=null?i.clip_paths[o.clip_path_idx]:null;_&&E1(h,l,i,_),n.globalCompositeOperation="source-over",n.drawImage(a,0,0)}function E1(n,e,i,o){const l=hf(n.canvas.width,n.canvas.height);S1(l.getContext("2d"),e,i,o),n.globalCompositeOperation="destination-in",n.drawImage(l,0,0)}function M1(n,e,i,o,l){if(o.children.length===0)return;const a=o.mask_idx!=null?i.masks[o.mask_idx]:null;a&&M1(n,e,i,a,l);const h=n.canvas.width,_=n.canvas.height,y=hf(h,_),w=y.getContext("2d"),p=o.width,x=o.height,S=o.left,b=o.top,T=new Path2D,M=new Path2D;M.rect(S,b,p,x),T.addPath(M,e),w.clip(T);for(const N of o.children)y1(w,e,i,N,l);const D=w.getImageData(0,0,h,_),z=D.data;if(o.mask_type===m1.MASK_TYPE_LUMINANCE)for(let N=0;N<z.length;N+=4)z[N+3]=z[N+3]/255*(.2126*z[N]+.7152*z[N+1]+.0722*z[N+2]);w.putImageData(D,0,0),n.globalCompositeOperation="destination-in",n.drawImage(y,0,0)}function Dm(n){return n?new DOMMatrix([n.sx,n.ky,n.kx,n.sy,n.tx,n.ty]):new DOMMatrix}function A1(n){const e=new Path2D,i=n.step;let o=n.diffs[0]*i,l=n.diffs[1]*i;e.moveTo(o,l);for(let a=0,h=2;a<n.commands.length;a++)switch(n.commands[a]){case Qu.PATH_COMMAND_MOVE:o+=n.diffs[h++]*i,l+=n.diffs[h++]*i,e.moveTo(o,l);break;case Qu.PATH_COMMAND_LINE:o+=n.diffs[h++]*i,l+=n.diffs[h++]*i,e.lineTo(o,l);break;case Qu.PATH_COMMAND_QUAD:{const _=o+n.diffs[h++]*i,y=l+n.diffs[h++]*i;o=_+n.diffs[h++]*i,l=y+n.diffs[h++]*i,e.quadraticCurveTo(_,y,o,l);break}case Qu.PATH_COMMAND_CUBIC:{const _=o+n.diffs[h++]*i,y=l+n.diffs[h++]*i,w=_+n.diffs[h++]*i,p=y+n.diffs[h++]*i;o=w+n.diffs[h++]*i,l=p+n.diffs[h++]*i,e.bezierCurveTo(_,y,w,p,o,l);break}case Qu.PATH_COMMAND_CLOSE:e.closePath()}return e}class zm{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}It(zm,"LRUCache");class hy{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new wn(e,e.data)}getFromCache(e,i,o){return this.cacheMap.has(o)||this.cacheMap.set(o,new zm(150)),this.cacheMap.get(o).get(cl(e.toString(),i))}setInCache(e,i,o,l){this.cacheDependenciesMap.has(l)||this.cacheDependenciesMap.set(l,new Map),this.cacheMap.has(l)||this.cacheMap.set(l,new zm(150));const a=this.cacheDependenciesMap.get(l),h=cl(e.id.toString(),o);a.get(h)||a.set(h,new Set);const _=this.cacheMap.get(l),y=e.toString();a.get(h).add(y),_.put(cl(e.toString(),o),i)}removeImagesFromCacheByIds(e,i,o=0){if(!this.cacheMap.has(o)||!this.cacheDependenciesMap.has(o))return;const l=this.cacheMap.get(o),a=this.cacheDependenciesMap.get(o);for(const h of e){const _=cl(h.toString(),i);if(a.has(_)){for(const y of a.get(_))l.delete(y);a.delete(_)}}}rasterize(e,i,o,l,a=OE){const h=this.getFromCache(e,o,l);if(h)return h.clone();const _=a(i.icon,e.options),y=hy._getImage(_);return this.setInCache(e,y,o,l),y.clone()}}class I1{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const o=this.toIdx(e,i);return{min:this.minimums[o],max:this.maximums[o]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function C1(n,e,i,o){let l=0,a=Number.MAX_VALUE;for(let h=0;h<3;h++)if(Math.abs(o[h])<1e-15){if(i[h]<n[h]||i[h]>e[h])return null}else{const _=1/o[h];let y=(n[h]-i[h])*_,w=(e[h]-i[h])*_;if(y>w){const p=y;y=w,w=p}if(y>l&&(l=y),w<a&&(a=w),l>a)return null}return l}function P1(n,e,i,o,l,a,h,_,y,w,p){const x=o-n,S=l-e,b=a-i,T=h-n,M=_-e,D=y-i,z=p[1]*D-p[2]*M,N=p[2]*T-p[0]*D,B=p[0]*M-p[1]*T,F=x*z+S*N+b*B;if(Math.abs(F)<1e-15)return null;const U=1/F,q=w[0]-n,Z=w[1]-e,re=w[2]-i,ee=(q*z+Z*N+re*B)*U;if(ee<0||ee>1)return null;const te=Z*b-re*S,pe=re*x-q*b,ne=q*S-Z*x,me=(p[0]*te+p[1]*pe+p[2]*ne)*U;return me<0||ee+me>1?null:(T*te+M*pe+D*ne)*U}function R1(n,e,i){return(n-e)/(i-e)}function D1(n,e,i,o,l,a,h,_,y){const w=1<<i,p=a-o,x=h-l,S=(n+1)/w*p+o,b=(e+0)/w*x+l,T=(e+1)/w*x+l;_[0]=(n+0)/w*p+o,_[1]=b,y[0]=S,y[1]=T}class z1{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=function(a){const h=Math.ceil(Math.log2(a.dim/8)),_=[];let y=Math.ceil(Math.pow(2,h));const w=1/y,p=(b,T,M,D,z)=>{const N=D?1:0,B=(b+1)*M-N,F=T*M,U=(T+1)*M-N;z[0]=b*M,z[1]=F,z[2]=B,z[3]=U};let x=new I1(y);const S=[];for(let b=0;b<y*y;b++){p(b%y,Math.floor(b/y),w,!1,S);const T=Tl(S[0],S[1],a),M=Tl(S[2],S[1],a),D=Tl(S[2],S[3],a),z=Tl(S[0],S[3],a);x.minimums.push(Math.min(T,M,D,z)),x.maximums.push(Math.max(T,M,D,z)),x.leaves.push(1)}for(_.push(x),y/=2;y>=1;y/=2){const b=_[_.length-1];x=new I1(y);for(let T=0;T<y*y;T++){p(T%y,Math.floor(T/y),2,!0,S);const M=b.getElevation(S[0],S[1]),D=b.getElevation(S[2],S[1]),z=b.getElevation(S[2],S[3]),N=b.getElevation(S[0],S[3]),B=b.isLeaf(S[0],S[1]),F=b.isLeaf(S[2],S[1]),U=b.isLeaf(S[2],S[3]),q=b.isLeaf(S[0],S[3]),Z=Math.min(M.min,D.min,z.min,N.min),re=Math.max(M.max,D.max,z.max,N.max),ee=B&&F&&U&&q;x.maximums.push(re),x.minimums.push(Z),x.leaves.push(re-Z<=5&&ee?1:0)}_.push(x)}return _}(this.dem),o=i.length-1,l=i[o];this._addNode(l.minimums[0],l.maximums[0],l.leaves[0]),this._construct(i,0,0,o,0)}raycastRoot(e,i,o,l,a,h,_=1){return C1([e,i,-100],[o,l,this.maximums[0]*_],a,h)}raycast(e,i,o,l,a,h,_=1){if(!this.nodeCount)return null;const y=this.raycastRoot(e,i,o,l,a,h,_);if(y==null)return null;const w=[],p=[],x=[],S=[],b=[{idx:0,t:y,nodex:0,nodey:0,depth:0}];for(;b.length>0;){const{idx:T,t:M,nodex:D,nodey:z,depth:N}=b.pop();if(this.leaves[T]){D1(D,z,N,e,i,o,l,x,S);const F=1<<N,U=(D+0)/F,q=(D+1)/F,Z=(z+0)/F,re=(z+1)/F,ee=Tl(U,Z,this.dem)*_,te=Tl(q,Z,this.dem)*_,pe=Tl(q,re,this.dem)*_,ne=Tl(U,re,this.dem)*_,me=P1(x[0],x[1],ee,S[0],x[1],te,S[0],S[1],pe,a,h),be=P1(S[0],S[1],pe,x[0],S[1],ne,x[0],x[1],ee,a,h),ve=Math.min(me!==null?me:Number.MAX_VALUE,be!==null?be:Number.MAX_VALUE);if(ve!==Number.MAX_VALUE)return ve;{const Me=J.vec3.scaleAndAdd([],a,h,M);if(L1(ee,te,ne,pe,R1(Me[0],x[0],S[0]),R1(Me[1],x[1],S[1]))>=Me[2])return M}continue}let B=0;for(let F=0;F<this._siblingOffset.length;F++){D1((D<<1)+this._siblingOffset[F][0],(z<<1)+this._siblingOffset[F][1],N+1,e,i,o,l,x,S),x[2]=-100,S[2]=this.maximums[this.childOffsets[T]+F]*_;const U=C1(x,S,a,h);if(U!=null){const q=U;w[F]=q;let Z=!1;for(let re=0;re<B&&!Z;re++)q>=w[p[re]]&&(p.splice(re,0,F),Z=!0);Z||(p[B]=F),B++}}for(let F=0;F<B;F++){const U=p[F];b.push({idx:this.childOffsets[T]+U,t:w[U],nodex:(D<<1)+this._siblingOffset[U][0],nodey:(z<<1)+this._siblingOffset[U][1],depth:N+1})}}return null}_addNode(e,i,o){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(o),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,o,l,a){if(e[l].isLeaf(i,o)===1)return;this.childOffsets[a]||(this.childOffsets[a]=this.nodeCount);const h=l-1,_=e[h];let y=0,w=0;for(let p=0;p<this._siblingOffset.length;p++){const x=2*i+this._siblingOffset[p][0],S=2*o+this._siblingOffset[p][1],b=_.getElevation(x,S),T=_.isLeaf(x,S),M=this._addNode(b.min,b.max,T);T&&(y|=1<<p),w||(w=M)}for(let p=0;p<this._siblingOffset.length;p++)y&1<<p||this._construct(e,2*i+this._siblingOffset[p][0],2*o+this._siblingOffset[p][1],h,w+p)}}function L1(n,e,i,o,l,a){return Xt(Xt(n,i,a),Xt(e,o,a),l)}function Tl(n,e,i){const o=i.dim,l=Dt(n*o-.5,0,o-1),a=Dt(e*o-.5,0,o-1),h=Math.floor(l),_=Math.floor(a),y=Math.min(h+1,o-1),w=Math.min(_+1,o-1);return L1(i.get(h,_),i.get(y,_),i.get(h,w),i.get(y,w),l-h,a-_)}const kE={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function FE(n,e,i){return(256*n*256+256*e+i)/10-1e4}function BE(n,e,i){return 256*n+e+i/256-32768}class Lm{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,o,l=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(o&&o!=="mapbox"&&o!=="terrarium")return void br(`"${o}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const a=this.dim=i.height-2,h=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=l,this._modifiedForSources={},!l){for(let y=0;y<a;y++)h[this._idx(-1,y)]=h[this._idx(0,y)],h[this._idx(a,y)]=h[this._idx(a-1,y)],h[this._idx(y,-1)]=h[this._idx(y,0)],h[this._idx(y,a)]=h[this._idx(y,a-1)];h[this._idx(-1,-1)]=h[this._idx(0,0)],h[this._idx(a,-1)]=h[this._idx(a-1,0)],h[this._idx(-1,a)]=h[this._idx(0,a-1)],h[this._idx(a,a)]=h[this._idx(a-1,a-1)]}const _=o==="terrarium"?BE:FE;for(let y=0;y<h.length;++y){const w=4*y;this.floatView[y]=_(this.pixels[w],this.pixels[w+1],this.pixels[w+2])}this._timestamp=qe.now()}_buildQuadTree(){this._tree=new z1(this)}get(e,i,o=!1){o&&(e=Dt(e,-1,this.dim),i=Dt(i,-1,this.dim));const l=this._idx(e,i);return this.floatView[l]}set(e,i,o){const l=this._idx(e,i),a=this.floatView[l];return this.floatView[l]=o,o-a}static getUnpackVector(e){return kE[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const o=[0,0,0,0],l=Lm.getUnpackVector(i);let a=Math.floor((e+l[3])/l[2]);return o[2]=a%256,a=Math.floor(a/256),o[1]=a%256,a=Math.floor(a/256),o[0]=a,o}getPixels(){return new qv({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,o){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let l=i*this.dim,a=i*this.dim+this.dim,h=o*this.dim,_=o*this.dim+this.dim;switch(i){case-1:l=a-1;break;case 1:a=l+1}switch(o){case-1:h=_-1;break;case 1:_=h+1}const y=-i*this.dim,w=-o*this.dim;for(let p=h;p<_;p++)for(let x=l;x<a;x++){const S=4*this._idx(x,p),b=4*this._idx(x+y,p+w);this.pixels[S+0]=e.pixels[b+0],this.pixels[S+1]=e.pixels[b+1],this.pixels[S+2]=e.pixels[b+2],this.pixels[S+3]=e.pixels[b+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function NE(n,e,i){n===1?e.headerLength=i.readFixed32():n===2?e.x=i.readVarint():n===3?e.y=i.readVarint():n===4?e.z=i.readVarint():n===5&&e.layers.push(function(o,l){return o.readFields(qE,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},l)}(i,i.readVarint()+i.pos))}function VE(n,e,i){n===1?(e.delta_filter=function(o,l){return o.readFields(UE,{blockSize:0},l)}(i,i.readVarint()+i.pos),e.filter="delta_filter"):n===2?(i.readVarint(),e.filter="zigzag_filter"):n===3?(i.readVarint(),e.filter="bitshuffle_filter"):n===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function UE(n,e,i){n===1&&(e.blockSize=i.readVarint())}function jE(n,e,i){n===1?(i.readVarint(),e.codec="gzip_data"):n===2?(i.readVarint(),e.codec="jpeg_image"):n===3?(i.readVarint(),e.codec="webp_image"):n===4&&(i.readVarint(),e.codec="png_image")}function GE(n,e,i){let o=0,l=0;n===1?e.firstByte=i.readFixed64():n===2?e.lastByte=i.readFixed64():n===3?e.filters.push(function(a,h){return a.readFields(VE,{},h)}(i,i.readVarint()+i.pos)):n===4?e.codec=function(a,h){return a.readFields(jE,{},h)}(i,i.readVarint()+i.pos):n===5?l=i.readFloat():n===6?o=i.readFloat():n===7?e.bands.push(i.readString()):n===8?e.offset=i.readDouble():n===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=l),e.scale===0&&(e.scale=o)}function qE(n,e,i){n===1?e.version=i.readVarint():n===2?e.name=i.readString():n===3?e.units=i.readString():n===4?e.tileSize=i.readVarint():n===5?e.buffer=i.readVarint():n===6?e.pixelFormat=i.readVarint():n===7&&e.dataIndex.push(function(o,l){return o.readFields(GE,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},l)}(i,i.readVarint()+i.pos))}function $E(n,e,i){if(n===2)(function(o,l,a){o.readFields(HE,a,l)})(i,i.readVarint()+i.pos,e);else if(n===3)throw new Error("Not implemented")}function HE(n,e,i){if(n===1){let o=0;const l=i.readVarint()+i.pos;for(;i.pos<l;)e[o++]=i.readVarint()}}function ZE(n,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let o=2;o>=1;o--){const l=o===1?1:0,a=o===2?1:0;for(let h=0;h<e[0];h++){const _=e[1]*h;for(let y=l;y<e[1];y++){const w=e[2]*(y+_);for(let p=a;p<e[2];p++){const x=e[3]*(p+w);for(let S=0;S<e[3];S++){const b=x+S;n[b]+=n[b-i]}}}}i*=e[o]}return n}function WE(n){for(let e=0,i=n.length;e<i;e++)n[e]=n[e]>>>1^-(1&n[e]);return n}function XE(n,e){switch(e){case"uint32":return n;case"uint16":for(let i=0;i<n.length;i+=2){const o=n[i],l=n[i+1];n[i]=(240&o)>>4|(61440&o)>>8|(240&l)<<4|61440&l,n[i+1]=15&o|(3840&o)>>4|(15&l)<<8|(3840&l)<<4}return n;case"uint8":for(let i=0;i<n.length;i+=4){const o=n[i],l=n[i+1],a=n[i+2],h=n[i+3];n[i+0]=(192&o)>>6|(192&l)>>4|(192&a)>>2|192&h,n[i+1]=(48&o)>>4|(48&l)>>2|48&a|(48&h)<<2,n[i+2]=(12&o)>>2|12&l|(12&a)<<2|(12&h)<<4,n[i+3]=3&o|(3&l)<<2|(3&a)<<4|(3&h)<<6}return n;default:throw new Error(`Invalid pixel format, "${e}"`)}}It(Lm,"DEMData"),It(z1,"DemMinMaxQuadTree",{omit:["dem"]});var Vs=Uint8Array,df=Uint16Array,KE=Int32Array,O1=new Vs([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),k1=new Vs([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),YE=new Vs([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),F1=function(n,e){for(var i=new df(31),o=0;o<31;++o)i[o]=e+=1<<n[o-1];var l=new KE(i[30]);for(o=1;o<30;++o)for(var a=i[o];a<i[o+1];++a)l[a]=a-i[o]<<5|o;return{b:i,r:l}},B1=F1(O1,2),N1=B1.b,JE=B1.r;N1[28]=258,JE[258]=28;for(var QE=F1(k1,0).b,V1=new df(32768),Jr=0;Jr<32768;++Jr){var th=(43690&Jr)>>1|(21845&Jr)<<1;V1[Jr]=((65280&(th=(61680&(th=(52428&th)>>2|(13107&th)<<2))>>4|(3855&th)<<4))>>8|(255&th)<<8)>>1}var ff=function(n,e,i){for(var o=n.length,l=0,a=new df(e);l<o;++l)n[l]&&++a[n[l]-1];var h,_=new df(e);for(l=1;l<e;++l)_[l]=_[l-1]+a[l-1]<<1;h=new df(1<<e);var y=15-e;for(l=0;l<o;++l)if(n[l])for(var w=l<<4|n[l],p=e-n[l],x=_[n[l]-1]++<<p,S=x|(1<<p)-1;x<=S;++x)h[V1[x]>>y]=w;return h},pf=new Vs(288);for(Jr=0;Jr<144;++Jr)pf[Jr]=8;for(Jr=144;Jr<256;++Jr)pf[Jr]=9;for(Jr=256;Jr<280;++Jr)pf[Jr]=7;for(Jr=280;Jr<288;++Jr)pf[Jr]=8;var U1=new Vs(32);for(Jr=0;Jr<32;++Jr)U1[Jr]=5;var eM=ff(pf,9),tM=ff(U1,5),dy=function(n){for(var e=n[0],i=1;i<n.length;++i)n[i]>e&&(e=n[i]);return e},Mo=function(n,e,i){var o=e/8|0;return(n[o]|n[o+1]<<8)>>(7&e)&i},fy=function(n,e){var i=e/8|0;return(n[i]|n[i+1]<<8|n[i+2]<<16)>>(7&e)},iM=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ao=function(n,e,i){var o=new Error(e||iM[n]);if(o.code=n,Error.captureStackTrace&&Error.captureStackTrace(o,Ao),!i)throw o;return o},rM=new Vs(0),nM=typeof TextDecoder<"u"&&new TextDecoder;try{nM.decode(rM,{stream:!0})}catch{}const sM={gzip_data:"gzip"};class eo extends Error{constructor(e){super(e),this.name="MRTError"}}const oM={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},j1={uint32:1,uint16:2,uint8:4},aM={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let py;class Om{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new eo(`Layer '${e}' not found`);return i}getHeaderLength(e){const i=new Uint8Array(e),o=new DataView(e);if(i[0]!==13)throw new eo("File is not a valid MRT.");return o.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),o=this.getHeaderLength(e);if(i.length<o)throw new eo(`Expected header with length >= ${o} but got buffer of length ${i.length}`);const l=function(a,h){return a.readFields(NE,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new py(i.subarray(0,o)));if(!isNaN(this.x)&&(this.x!==l.x||this.y!==l.y||this.z!==l.z))throw new eo(`Invalid attempt to parse header ${l.z}/${l.x}/${l.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=l.x,this.y=l.y,this.z=l.z;for(const a of l.layers)this.layers[a.name]=new G1(a,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],o=this.getLayer(e.layerName);for(let l of e.blockIndices){const a=o.dataIndex[l],h=a.firstByte-e.firstByte,_=a.lastByte-e.firstByte;if(o._blocksInProgress.has(l))continue;const y={layerName:o.name,firstByte:h,lastByte:_,pixelFormat:o.pixelFormat,blockIndex:l,blockShape:[a.bands.length].concat(o.bandShape),buffer:o.buffer,codec:a.codec.codec,filters:a.filters.map(w=>w.filter)};o._blocksInProgress.add(l),i.push(y)}return new q1(i,()=>{i.forEach(l=>o._blocksInProgress.delete(l.blockIndex))},(l,a)=>{if(i.forEach(h=>o._blocksInProgress.delete(h.blockIndex)),l)throw l;a.forEach(h=>{this.getLayer(h.layerName).processDecodedData(h)})})}}class G1{constructor({version:e,name:i,units:o,tileSize:l,pixelFormat:a,buffer:h,dataIndex:_},y){if(this.version=e,this.version!==1)throw new eo(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=o,this.tileSize=l,this.buffer=h,this.pixelFormat=oM[a],this.dataIndex=_,this.bandShape=[l+2*h,l+2*h,j1[this.pixelFormat]],this._decodedBlocks=new zm(y?y.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return j1[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[o,l]of this.dataIndex.entries()){for(const[a,h]of l.bands.entries())if(h===e)return{bandIndex:i+a,blockIndex:o,blockBandIndex:a};i+=l.bands.length}break;case"number":for(const[o,l]of this.dataIndex.entries()){if(e>=i&&e<i+l.bands.length)return{bandIndex:e,blockIndex:o,blockBandIndex:e-i};i+=l.bands.length}break;default:throw new eo(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}throw new eo(`Band not found: ${JSON.stringify(e)}`)}getDataRange(e){let i=1/0,o=-1/0;const l=[],a=new Set;for(const h of e){const{blockIndex:_}=this.getBlockForBand(h);if(_<0)throw new eo(`Invalid band: ${JSON.stringify(h)}`);const y=this.dataIndex[_];l.includes(_)||l.push(_),a.add(_),i=Math.min(i,y.firstByte),o=Math.max(o,y.lastByte)}if(a.size>this.cacheSize)throw new eo(`Number of blocks to decode (${a.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:o,blockIndices:l}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:o}=this.getBlockForBand(e),l=this._decodedBlocks.get(i.toString());if(!l)throw new eo(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const a=this.dataIndex[i],h=this.bandShape.reduce((w,p)=>w*p,1),_=o*h,y=l.subarray(_,_+h);return{data:y,bytes:new Uint8Array(y.buffer).subarray(y.byteOffset,y.byteOffset+y.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:a.offset,scale:a.scale}}}Om.setPbf=function(n){py=n};class q1{constructor(e,i,o){this.tasks=e,this._onCancel=i,this._onComplete=o,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}Om.performDecoding=function(n,e){const i=new Uint8Array(n);return Promise.all(e.tasks.map(o=>{const{layerName:l,firstByte:a,lastByte:h,pixelFormat:_,blockShape:y,blockIndex:w,filters:p,codec:x}=o,S=i.subarray(a,h+1),b=new Uint32Array(y[0]*y[1]*y[2]);let T;if(x!=="gzip_data")throw new eo(`Unhandled codec: ${x}`);return T=function(M,D){if(!globalThis.DecompressionStream&&D==="gzip_data")return Promise.resolve(((F=function(Z){Z[0]==31&&Z[1]==139&&Z[2]==8||Ao(6,"invalid gzip data");var re=Z[3],ee=10;4&re&&(ee+=2+(Z[10]|Z[11]<<8));for(var te=(re>>3&1)+(re>>4&1);te>0;te-=!Z[ee++]);return ee+(2&re)}(B=M))+8>B.length&&Ao(6,"invalid gzip data"),function(Z,re,ee,te){var pe=Z.length;if(!pe||re.f&&!re.l)return ee||new Vs(0);var ne=!ee,me=ne||re.i!=2,be=re.i;ne&&(ee=new Vs(3*pe));var ve,Me,Ee=function(El){var Ml=ee.length;if(El>Ml){var Rc=new Vs(Math.max(2*Ml,El));Rc.set(ee),ee=Rc}},Oe=re.f||0,Ce=re.p||0,ke=re.b||0,rt=re.l,tt=re.d,Ct=re.m,ot=re.n,ut=8*pe;do{if(!rt){Oe=Mo(Z,Ce,1);var nt=Mo(Z,Ce+1,3);if(Ce+=3,!nt){var Ht=Z[(ti=4+((Ce+7)/8|0))-4]|Z[ti-3]<<8,Et=ti+Ht;if(Et>pe){be&&Ao(0);break}me&&Ee(ke+Ht),ee.set(Z.subarray(ti,Et),ke),re.b=ke+=Ht,re.p=Ce=8*Et,re.f=Oe;continue}if(nt==1)rt=eM,tt=tM,Ct=9,ot=5;else if(nt==2){var Lt=Mo(Z,Ce,31)+257,ei=Mo(Z,Ce+10,15)+4,_i=Lt+Mo(Z,Ce+5,31)+1;Ce+=14;for(var ri=new Vs(_i),Ei=new Vs(19),mi=0;mi<ei;++mi)Ei[YE[mi]]=Mo(Z,Ce+3*mi,7);Ce+=3*ei;var Ai=dy(Ei),Ni=(1<<Ai)-1,hr=ff(Ei,Ai);for(mi=0;mi<_i;){var ti,Di=hr[Mo(Z,Ce,Ni)];if(Ce+=15&Di,(ti=Di>>4)<16)ri[mi++]=ti;else{var vr=0,Mr=0;for(ti==16?(Mr=3+Mo(Z,Ce,3),Ce+=2,vr=ri[mi-1]):ti==17?(Mr=3+Mo(Z,Ce,7),Ce+=3):ti==18&&(Mr=11+Mo(Z,Ce,127),Ce+=7);Mr--;)ri[mi++]=vr}}var Pr=ri.subarray(0,Lt),Dr=ri.subarray(Lt);Ct=dy(Pr),ot=dy(Dr),rt=ff(Pr,Ct),tt=ff(Dr,ot)}else Ao(1);if(Ce>ut){be&&Ao(0);break}}me&&Ee(ke+131072);for(var cr=(1<<Ct)-1,on=(1<<ot)-1,qn=Ce;;qn=Ce){var Hr=(vr=rt[fy(Z,Ce)&cr])>>4;if((Ce+=15&vr)>ut){be&&Ao(0);break}if(vr||Ao(2),Hr<256)ee[ke++]=Hr;else{if(Hr==256){qn=Ce,rt=null;break}var Qr=Hr-254;Hr>264&&(Qr=Mo(Z,Ce,(1<<(Us=O1[mi=Hr-257]))-1)+N1[mi],Ce+=Us);var Rn=tt[fy(Z,Ce)&on],mn=Rn>>4;if(Rn||Ao(3),Ce+=15&Rn,Dr=QE[mn],mn>3){var Us=k1[mn];Dr+=fy(Z,Ce)&(1<<Us)-1,Ce+=Us}if(Ce>ut){be&&Ao(0);break}me&&Ee(ke+131072);var Sl=ke+Qr;if(ke<Dr){var to=0-Dr,Co=Math.min(Dr,Sl);for(to+ke<0&&Ao(3);ke<Co;++ke)ee[ke]=(void 0)[to+ke]}for(;ke<Sl;++ke)ee[ke]=ee[ke-Dr]}}re.l=rt,re.p=qn,re.b=ke,re.f=Oe,rt&&(Oe=1,re.m=Ct,re.d=tt,re.n=ot)}while(!Oe);return ke!=ee.length&&ne?(ve=ee,((Me=ke)==null||Me>ve.length)&&(Me=ve.length),new Vs(ve.subarray(0,Me))):ee.subarray(0,ke)}(B.subarray(F,-8),{i:2},new Vs(((z=B)[(N=z.length)-4]|z[N-3]<<8|z[N-2]<<16|z[N-1]<<24)>>>0))));var z,N,B,F;const U=sM[D];if(!U)throw new Error(`Unhandled codec: ${D}`);const q=new globalThis.DecompressionStream(U);return new Response(new Blob([M]).stream().pipeThrough(q)).arrayBuffer().then(Z=>new Uint8Array(Z))}(S,x).then(M=>(function(D,z){D.readFields($E,z)}(new py(M),b),new aM[_](b.buffer))),T.then(M=>{for(let D=p.length-1;D>=0;D--)switch(p[D]){case"delta_filter":ZE(M,y);break;case"zigzag_filter":WE(M);break;case"bitshuffle_filter":XE(M,_);break;default:throw new eo(`Unhandled filter "${p[D]}"`)}return{layerName:l,blockIndex:w,data:M}}).catch(M=>{throw M})}))},It(q1,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),It(Om,"MapboxRasterTile"),It(G1,"MapboxRasterLayer",{omit:["_blocksInProgress"]});let mf,my,Io,ih,_y,rh=null;function $1(){return Nn()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:my||X.DRACO_URL}function H1(){if(Nn()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(ih)return ih;const n=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return ih=WebAssembly.validate(n)?X.MESHOPT_SIMD_URL:X.MESHOPT_URL,ih}const km={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},lM={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},_f={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Z1(n,e,i){const o=i.json.bufferViews.length,l=i.buffers.length;e.bufferView=o,i.json.bufferViews[o]={buffer:l,byteLength:n.byteLength},i.buffers[l]=n}const gy="KHR_draco_mesh_compression";function cM(n,e){const i=n.extensions&&n.extensions[gy];if(!i)return;const o=new Io.Decoder,l=Y1(e,i.bufferView),a=new Io.Mesh;if(!o.DecodeArrayToMesh(l,l.byteLength,a))throw new Error("Failed to decode Draco mesh");const h=e.json.accessors[n.indices],_=km[h.componentType],y=h.count*_.BYTES_PER_ELEMENT,w=Io._malloc(y);_===Uint16Array?o.GetTrianglesUInt16Array(a,y,w):o.GetTrianglesUInt32Array(a,y,w),Z1(Io.memory.buffer.slice(w,w+y),h,e),Io._free(w);for(const p of Object.keys(i.attributes)){const x=o.GetAttributeByUniqueId(a,i.attributes[p]),S=e.json.accessors[n.attributes[p]],b=lM[S.componentType],T=S.count*_f[S.type]*km[S.componentType].BYTES_PER_ELEMENT,M=Io._malloc(T);o.GetAttributeDataArrayForAllPoints(a,x,Io[b],T,M),Z1(Io.memory.buffer.slice(M,M+T),S,e),Io._free(M)}o.destroy(),a.destroy(),delete n.extensions[gy]}const Fm="EXT_meshopt_compression";function uM(n,e){if(!n.extensions||!n.extensions[Fm])return;const i=n.extensions[Fm],o=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),l=new Uint8Array(i.count*i.byteStride);_y.decodeGltfBuffer(l,i.count,i.byteStride,o,i.mode,i.filter),n.buffer=e.buffers.length,n.byteOffset=0,e.buffers[n.buffer]=l.buffer,delete n.extensions[Fm]}const W1=1179937895,X1=new TextDecoder("utf8");function K1(n,e){return new URL(n,e).href}function hM(n,e,i,o){return fetch(K1(n.uri,o)).then(l=>l.arrayBuffer()).then(l=>{e.buffers[i]=l})}function Y1(n,e){const i=n.json.bufferViews[e];return new Uint8Array(n.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function dM(n,e,i,o){if(n.uri){const l=K1(n.uri,o);return fetch(l).then(a=>a.blob()).then(a=>createImageBitmap(a)).then(a=>{e.images[i]=a})}if(n.bufferView!==void 0){const l=Y1(e,n.bufferView),a=new Blob([l],{type:n.mimeType});return createImageBitmap(a).then(h=>{e.images[i]=h})}}function J1(n,e=0,i){const o={json:null,images:[],buffers:[]};if(new Uint32Array(n,e,1)[0]===W1){const p=new Uint32Array(n,e);let x=2;const S=(p[x++]>>2)-3,b=p[x++]>>2;if(x++,o.json=JSON.parse(X1.decode(p.subarray(x,x+b))),x+=b,x<S){const T=p[x++];x++;const M=e+(x<<2);o.buffers[0]=n.slice(M,M+T)}}else o.json=JSON.parse(X1.decode(new Uint8Array(n,e)));const{buffers:l,images:a,meshes:h,extensionsUsed:_,bufferViews:y}=o.json;let w=Promise.resolve();if(l){const p=[];for(let x=0;x<l.length;x++){const S=l[x];S.uri?p.push(hM(S,o,x,i)):o.buffers[x]||(o.buffers[x]=null)}w=Promise.all(p)}return w.then(()=>{const p=[],x=_&&_.includes(gy),S=_&&_.includes(Fm);if(x&&p.push(function(){if(!Io)return mf??(mf=function(b){let T,M=null;function D(){T=new Uint8Array(M.buffer)}function z(){throw new Error("Unexpected Draco error.")}const N={a:{a:z,d:function(B,F,U){return T.copyWithin(B,F,F+U)},c:function(B){const F=T.length,U=Math.max(B>>>0,Math.ceil(1.2*F)),q=Math.ceil((U-F)/65536);try{return M.grow(q),D(),!0}catch{return!1}},b:z}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(b,N):b.then(B=>B.arrayBuffer()).then(B=>WebAssembly.instantiate(B,N))).then(B=>{const{Rb:F,Qb:U,P:q,T:Z,X:re,Ja:ee,La:te,Qa:pe,Va:ne,Wa:me,eb:be,jb:ve,f:Me,e:Ee,yb:Oe,zb:Ce,Ab:ke,Bb:rt,Db:tt,Gb:Ct}=B.instance.exports;M=Ee;const ot=(()=>{let ut=0,nt=0,Ht=0,Et=0;return Lt=>{Ht&&(F(Et),F(ut),nt+=Ht,Ht=ut=0),ut||(nt+=128,ut=U(nt));const ei=Lt.length+7&-8;let _i=ut;ei>=nt&&(Ht=ei,_i=Et=U(ei));for(let ri=0;ri<Lt.length;ri++)T[_i+ri]=Lt[ri];return _i}})();return D(),Me(),{memory:Ee,_free:F,_malloc:U,Mesh:class{constructor(){this.ptr=q()}destroy(){Z(this.ptr)}},Decoder:class{constructor(){this.ptr=ee()}destroy(){ve(this.ptr)}DecodeArrayToMesh(ut,nt,Ht){const Et=ot(ut),Lt=te(this.ptr,Et,nt,Ht.ptr);return!!re(Lt)}GetAttributeByUniqueId(ut,nt){return{ptr:pe(this.ptr,ut.ptr,nt)}}GetTrianglesUInt16Array(ut,nt,Ht){ne(this.ptr,ut.ptr,nt,Ht)}GetTrianglesUInt32Array(ut,nt,Ht){me(this.ptr,ut.ptr,nt,Ht)}GetAttributeDataArrayForAllPoints(ut,nt,Ht,Et,Lt){be(this.ptr,ut.ptr,nt.ptr,Ht,Et,Lt)}},DT_INT8:Oe(),DT_UINT8:Ce(),DT_INT16:ke(),DT_UINT16:rt(),DT_UINT32:tt(),DT_FLOAT32:Ct()}})}(fetch($1())),mf.then(b=>{Io=b,mf=void 0}))}()),S&&p.push(function(){if(_y)return;const b=function(T){let M;const D=WebAssembly.instantiateStreaming(T,{}).then(B=>{M=B.instance,M.exports.__wasm_call_ctors()}),z={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},N={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:D,supported:!0,decodeGltfBuffer(B,F,U,q,Z,re){(function(ee,te,pe,ne,me,be,ve){const Me=ee.exports.sbrk,Ee=ne+3&-4,Oe=Me(Ee*me),Ce=Me(be.length),ke=new Uint8Array(ee.exports.memory.buffer);ke.set(be,Ce);const rt=te(Oe,ne,me,Ce,be.length);if(rt===0&&ve&&ve(Oe,Ee,me),pe.set(ke.subarray(Oe,Oe+ne*me)),Me(Oe-Me(0)),rt!==0)throw new Error(`Malformed buffer data: ${rt}`)})(M,M.exports[N[Z]],B,F,U,q,M.exports[z[re]])}}}(fetch(H1()));return b.ready.then(()=>{_y=b})}()),a)for(let b=0;b<a.length;b++)p.push(dM(a[b],o,b,i));return(p.length?Promise.all(p):Promise.resolve()).then(()=>{if(x&&h)for(const{primitives:b}of h)for(const T of b)cM(T,o);if(S&&h&&y)for(const b of y)uM(b,o);return o})})}function Pc(n,e){const i=n.json.bufferViews[e.bufferView],o=km[e.componentType];return new o(n.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==_f[e.type]*o.BYTES_PER_ELEMENT?i.byteStride/o.BYTES_PER_ELEMENT:_f[e.type]))}function yy(n,e,i,o){const l=km[e.componentType],a=function(p){switch(p){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(l),h=n.json.bufferViews[e.bufferView],_=h.byteStride?h.byteStride/l.BYTES_PER_ELEMENT:_f[e.type],y=i.float32,w=y.length/i.capacity;for(let p=0,x=0;p<e.count*_;p+=_,x+=w)for(let S=0;S<w;S++)y[x+S]=o[p+S]*a;i._trim()}function fM(n,e,i){const o=n.indices,l=n.attributes,a={};a.indexArray=new dn;const h=e.json.accessors[o],_=h.count/3;a.indexArray.reserve(_);const y=Pc(e,h);for(let S=0;S<_;S++)a.indexArray.emplaceBack(y[3*S],y[3*S+1],y[3*S+2]);a.indexArray._trim(),a.vertexArray=new Bs;const w=e.json.accessors[l.POSITION];a.vertexArray.reserve(w.count);const p=Pc(e,w);for(let S=0;S<w.count;S++)a.vertexArray.emplaceBack(p[3*S],p[3*S+1],p[3*S+2]);if(a.vertexArray._trim(),a.aabb=new kt(w.min,w.max),a.centroid=function(S,b){const T=[0,0,0],M=S.length;if(M>0){for(let D=0;D<M;D++){const z=3*S[D];T[0]+=b[z],T[1]+=b[z+1],T[2]+=b[z+2]}T[0]/=M,T[1]/=M,T[2]/=M}return T}(y,p),l.COLOR_0!==void 0){const S=e.json.accessors[l.COLOR_0],b=_f[S.type],T=Pc(e,S);a.colorArray=b===3?new Bs:new ma,a.colorArray.resize(S.count),yy(e,S,a.colorArray,T)}if(l.NORMAL!==void 0){a.normalArray=new Bs;const S=e.json.accessors[l.NORMAL];a.normalArray.resize(S.count);const b=Pc(e,S);yy(e,S,a.normalArray,b)}if(l.TEXCOORD_0!==void 0&&i.length>0){a.texcoordArray=new hl;const S=e.json.accessors[l.TEXCOORD_0];a.texcoordArray.resize(S.count);const b=Pc(e,S);yy(e,S,a.texcoordArray,b)}if(l._FEATURE_ID_RGBA4444!==void 0){const S=e.json.accessors[l._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(a.featureData=Pc(e,S))}l._FEATURE_RGBA4444!==void 0&&(a.featureData=new Uint32Array(Pc(e,e.json.accessors[l._FEATURE_RGBA4444]).buffer));const x=n.material;return a.material=function(S,b){const{emissiveFactor:T=[0,0,0],alphaMode:M="OPAQUE",alphaCutoff:D=.5,normalTexture:z,occlusionTexture:N,emissiveTexture:B,doubleSided:F}=S,{baseColorFactor:U=[1,1,1,1],metallicFactor:q=1,roughnessFactor:Z=1,baseColorTexture:re,metallicRoughnessTexture:ee}=S.pbrMetallicRoughness||{},te=N?b[N.index]:void 0;if(N&&N.extensions&&N.extensions.KHR_texture_transform&&te){const pe=N.extensions.KHR_texture_transform;te.offsetScale=[pe.offset[0],pe.offset[1],pe.scale[0],pe.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new tr(...U),metallicFactor:q,roughnessFactor:Z,baseColorTexture:re?b[re.index]:void 0,metallicRoughnessTexture:ee?b[ee.index]:void 0},doubleSided:F,emissiveFactor:T,alphaMode:M,alphaCutoff:D,normalTexture:z?b[z.index]:void 0,occlusionTexture:te,emissionTexture:B?b[B.index]:void 0,defined:S.defined===void 0}}(x!==void 0?e.json.materials[x]:{defined:!1},i),a}function Q1(n,e,i){const{matrix:o,rotation:l,translation:a,scale:h,mesh:_,extras:y,children:w}=n,p={};if(p.matrix=o||J.mat4.fromRotationTranslationScale([],l||[0,0,0,1],a||[0,0,0],h||[1,1,1]),_!==void 0){p.meshes=i[_];const x=p.anchor=[0,0];for(const S of p.meshes){const{min:b,max:T}=S.aabb;x[0]+=b[0]+T[0],x[1]+=b[1]+T[1]}x[0]=Math.floor(x[0]/p.meshes.length/2),x[1]=Math.floor(x[1]/p.meshes.length/2)}if(y&&(y.id&&(p.id=y.id),y.lights&&(p.lights=function(x){if(!x.length)return[];const S=function(z){const N=atob(z),B=new Uint8Array(N.length);for(let F=0;F<N.length;F++)B[F]=N.codePointAt(F);return B}(x),b=[],T=S.length/24,M=new Uint16Array(S.buffer),D=new Float32Array(S.buffer);for(let z=0;z<T;z++){const N=M[2*z*6]/30,B=M[2*z*6+1]/30,F=M[2*z*6+10]/100,U=D[6*z+1],q=D[6*z+2],Z=D[6*z+3],re=D[6*z+4],ee=Z-U,te=re-q,pe=Math.hypot(ee,te);b.push({pos:[U+.5*ee,q+.5*te,B],normal:[te/pe,-ee/pe,0],width:pe,height:N,depth:F,points:[U,q,Z,re]})}return b}(y.lights))),w){const x=[];for(const S of w)x.push(Q1(e.json.nodes[S],e,i));p.children=x}return p}function pM(n){if(n.vertices.length===0||n.indices.length===0)return null;const e=new Eg(n.vertices,n.indices,8,256),[i,o]=[e.min.clone(),e.max.clone()];return{vertices:n.vertices,indices:n.indices,grid:e,min:i,max:o}}function mM(n){if(!n.extras||!n.extras.ground)return null;const e=n.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const o=[];for(const h of i){if(!Array.isArray(h)||h.length!==2)continue;const _=h[0],y=h[1];typeof _=="number"&&typeof y=="number"&&o.push(new we(_,y))}if(o.length<3)return null;o.length>1&&o[o.length-1].equals(o[0])&&o.pop();let l=0;for(let h=0;h<o.length;h++){const _=o[h],y=o[(h+1)%o.length],w=o[(h+2)%o.length];l+=(_.x-y.x)*(w.y-y.y)-(w.x-y.x)*(_.y-y.y)}l>0&&o.reverse();const a=Ud(o.flatMap(h=>[h.x,h.y]),[]);return a.length===0?null:{vertices:o,indices:a}}function _M(n,e){const i=[],o=[];let l=0;const a=[];for(const h of n){l=i.length;const _=h.vertexArray.float32,y=h.indexArray.uint16;for(let w=0;w<h.vertexArray.length;w++)a[0]=_[3*w+0],a[1]=_[3*w+1],a[2]=_[3*w+2],J.vec3.transformMat4(a,a,e),i.push(new we(a[0],a[1]));for(let w=0;w<3*h.indexArray.length;w++)o.push(y[w]+l)}if(o.length%3!=0)return null;for(let h=0;h<o.length;h+=3){const _=i[o[h+0]],y=i[o[h+1]],w=i[o[h+2]];(_.x-y.x)*(w.y-y.y)-(w.x-y.x)*(_.y-y.y)>0&&([o[h+1],o[h+2]]=[o[h+2],o[h+1]])}return{vertices:i,indices:o}}function eb(n){const e=function(y,w){const p=[],x=WebGL2RenderingContext;if(y.json.textures)for(const S of y.json.textures){const b={magFilter:x.LINEAR,minFilter:x.NEAREST,wrapS:x.REPEAT,wrapT:x.REPEAT};S.sampler!==void 0&&Object.assign(b,y.json.samplers[S.sampler]),p.push({image:w[S.source],sampler:b,uploaded:!1})}return p}(n,n.images),i=function(y,w){const p=[];for(const x of y.json.meshes){const S=[];for(const b of x.primitives)S.push(fM(b,y,w));p.push(S)}return p}(n,e),{scenes:o,scene:l,nodes:a}=n.json,h=o?o[l||0].nodes:a,_=[];for(const y of h)_.push(Q1(a[y],n,i));return function(y,w,p){const x={},S=new Set;for(let b=0;b<y.length;b++){const T=p[w[b]];if(!T.extras)continue;const M=T.extras["mapbox:footprint:version"],D=T.extras["mapbox:footprint:id"];(M||D)&&S.add(b),M==="1.0.0"&&D&&(x[D]=b)}for(let b=0;b<y.length;b++){if(S.has(b))continue;const T=y[b],M=p[w[b]];if(!M.extras)continue;let D=null;T.id in x&&(D=_M(y[x[T.id]].meshes,T.matrix)),D||(D=mM(M)),D&&(T.footprint=pM(D))}if(S.size>0){const b=Array.from(S.values()).sort((T,M)=>T-M);for(let T=b.length-1;T>=0;T--)y.splice(b[T],1)}}(_,h,n.json.nodes),_}function gM(n){n.heightmap=new Float32Array(4096),n.heightmap.fill(-1);const e=n.vertexArray.float32,i=n.aabb.min[0]-1,o=n.aabb.min[1]-1,l=Ac/(n.aabb.max[0]-i+2),a=Ac/(n.aabb.max[1]-o+2);for(let h=0;h<e.length;h+=3){const _=e[h+2],y=(e[h+0]-i)*l|0,w=(e[h+1]-o)*a|0;_>n.heightmap[w*Ac+y]&&(n.heightmap[w*Ac+y]=_)}}function yM(n,e){const i={};i.indexArray=new dn,i.indexArray.reserve(4*n.length),i.vertexArray=new Bs,i.vertexArray.reserve(10*n.length),i.colorArray=new ma,i.vertexArray.reserve(10*n.length);let o=0;for(const h of n){const _=Math.min(10,Math.max(4,1.3*h.height))*e,y=[-h.normal[1],h.normal[0],0],w=Math.min(.29,.1*h.width/h.depth),p=h.width-2*h.depth*e*(w+.01),x=J.vec3.scaleAndAdd([],h.pos,y,p/2),S=J.vec3.scaleAndAdd([],h.pos,y,-p/2),b=[x[0],x[1],x[2]+h.height],T=[S[0],S[1],S[2]+h.height],M=J.vec3.scaleAndAdd([],h.normal,y,w);J.vec3.scale(M,M,_);const D=J.vec3.scaleAndAdd([],h.normal,y,-w);J.vec3.scale(D,D,_),J.vec3.add(M,x,M),J.vec3.add(D,S,D),x[2]+=.1,S[2]+=.1,i.vertexArray.emplaceBack(M[0],M[1],M[2]),i.vertexArray.emplaceBack(D[0],D[1],D[2]),i.vertexArray.emplaceBack(x[0],x[1],x[2]),i.vertexArray.emplaceBack(S[0],S[1],S[2]),i.vertexArray.emplaceBack(b[0],b[1],b[2]),i.vertexArray.emplaceBack(T[0],T[1],T[2]),i.vertexArray.emplaceBack(x[0],x[1],x[2]),i.vertexArray.emplaceBack(S[0],S[1],S[2]),i.vertexArray.emplaceBack(M[0],M[1],M[2]),i.vertexArray.emplaceBack(D[0],D[1],D[2]);const z=p/_/2;i.colorArray.emplaceBack(-z-w,-1,z,.8),i.colorArray.emplaceBack(z+w,-1,z,.8),i.colorArray.emplaceBack(-z,0,z,1.3),i.colorArray.emplaceBack(z,0,z,1.3),i.colorArray.emplaceBack(z+w,-.8,z,.7),i.colorArray.emplaceBack(z+w,-.8,z,.7),i.colorArray.emplaceBack(0,0,z,1.3),i.colorArray.emplaceBack(0,0,z,1.3),i.colorArray.emplaceBack(z+w,-1.2,z,.8),i.colorArray.emplaceBack(z+w,-1.2,z,.8),i.indexArray.emplaceBack(6+o,4+o,8+o),i.indexArray.emplaceBack(7+o,9+o,5+o),i.indexArray.emplaceBack(0+o,1+o,2+o),i.indexArray.emplaceBack(1+o,3+o,2+o),o+=10}const l={defined:!0,emissiveFactor:[0,0,0]},a={};return a.baseColorFactor=tr.white,l.pbrMetallicRoughness=a,i.material=l,i.aabb=new kt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}class tb{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const o=e[i];this._stringToNumber[o]=i,this._numberToString[i]=o}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const vM=["id","tile","layer","source","sourceLayer","state"];class nh{constructor(e,i,o,l,a){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=o,this._y=l,this.properties=e.properties,this.id=a}clone(){const e=new nh(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of vM)this[i]!==void 0&&(e[i]=this[i]);return e}}class ib{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new tl(ht,16,0),this.featureIndexArray=new Wn,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,o,l,a,h=0,_=0){const y=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,l,a,h);const w=this.grid;for(let p=0;p<i.length;p++){const x=i[p],S=[1/0,1/0,-1/0,-1/0];for(let b=0;b<x.length;b++){const T=x[b];S[0]=Math.min(S[0],T.x),S[1]=Math.min(S[1],T.y),S[2]=Math.max(S[2],T.x),S[3]=Math.max(S[3],T.y)}_!==0&&(S[0]-=_,S[1]-=_,S[2]+=_,S[3]+=_),S[0]<ht&&S[1]<ht&&S[2]>=0&&S[3]>=0&&w.insert(y,S[0],S[1],S[2],S[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new yl.VectorTile(new nm(this.rawTileData)).layers,this.sourceLayerCoder=new tb(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:o,transform:l,tileTransform:a,pixelPosMatrix:h,availableImages:_}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const y=o.bufferedTilespaceBounds,w=this.grid.query(y.min.x,y.min.y,y.max.x,y.max.y,(b,T,M,D)=>he(o.bufferedTilespaceGeometry,b,T,M,D));w.sort(xM);let p=null;l.elevation&&w.length>0&&(p=Yu.create(l.elevation,this.tileID));const x={};let S;for(let b=0;b<w.length;b++){const T=w[b];if(T===S)continue;S=T;const M=this.featureIndexArray.get(T);let D=null;this.is3DTile?this.loadMatchingModelFeature(x,M,e,o,l):this.loadMatchingFeature(x,M,e,_,(z,N,B,F=0)=>(D||(D=C(z,this.tileID.canonical,a)),N.queryIntersectsFeature(o,z,B,D,this.z,l,h,p,F)))}return x}loadMatchingFeature(e,i,o,l,a){const{featureIndex:h,bucketIndex:_,sourceLayerIndex:y,layoutVertexArrayOffset:w}=i,p=this.bucketLayerIDs[_],x=o.layers,S=Object.keys(x);if(S.length&&!function(z,N){for(let B=0;B<z.length;B++)if(N.indexOf(z[B])>=0)return!0;return!1}(S,p))return;const b=o.sourceCache,T=this.sourceLayerCoder.decode(y),M=this.vtLayers[T].feature(h),D=this.getId(M,T);for(let z=0;z<p.length;z++){const N=p[z];if(!x[N])continue;const{styleLayer:B,targets:F}=x[N];let U={};D!==void 0&&(U=b.getFeatureState(B.sourceLayer,D));const q=!a||a(M,B,U,w);if(!q)continue;const Z=new nh(M,this.z,this.x,this.y,D);Z.tile=this.tileID.canonical,Z.state=U;let re=this.serializedLayersCache.get(N);re||(re=B.serialize(),re.id=N,this.serializedLayersCache.set(N,re)),Z.source=re.source,Z.sourceLayer=re["source-layer"],Z.layer=Gi({},re),Z.layer.paint=rb(re.paint,B.paint,M,U,l),Z.layer.layout=rb(re.layout,B.layout,M,U,l);let ee=!1;for(const te of F){this.updateFeatureProperties(Z,te);const{filter:pe}=te;if(pe){if(M.properties=Z.properties,pe.needGeometry){const ne=R(M,!0);if(!pe.filter(new ur(this.tileID.overscaledZ),ne,this.tileID.canonical))continue}else if(!pe.filter(new ur(this.tileID.overscaledZ),M))continue}ee=!0,te.targetId&&this.addFeatureVariant(Z,te)}ee&&this.appendToResult(e,N,h,Z,q)}}loadMatchingModelFeature(e,i,o,l,a){const h=this.bucketLayerIDs[0][0],_=o.layers;if(!_[h])return;const{styleLayer:y,targets:w}=_[h];if(y.type!=="model")return;const p=l.tile,x=i.featureIndex,S=p.getBucket(y);if(!(S&&S instanceof Mm))return;const b=function(re,ee,te,pe){const ne=re.getNodesInfo()[ee];if(ne.hiddenByReplacement||!ne.node.meshes)return;let me=Number.MAX_VALUE;const be=ne.node,ve=te.tile,Me=pe.calculatePosMatrix(ve.tileID.toUnwrapped(),pe.worldSize),Ee=ne.evaluatedScale;let Oe=0;pe.elevation&&be.elevation&&(Oe=be.elevation*pe.elevation.exaggeration()),J.mat4.translate(Me,Me,[(be.anchor?be.anchor[0]:0)*(Ee[0]-1),(be.anchor?be.anchor[1]:0)*(Ee[1]-1),Oe]),J.mat4.scale(Me,Me,Ee);const Ce=te.queryGeometry,ke=Ce.isPointQuery()?Ce.screenBounds:Ce.screenGeometry,rt=function(Ct){const ot=J.mat4.multiply([],Me,Ct.matrix);J.mat4.multiply(ot,pe.expandedFarZProjMatrix,ot);for(let ut=0;ut<Ct.meshes.length;++ut){const nt=Ct.meshes[ut];if(ut===Ct.lightMeshIndex)continue;const Ht=e1(ke,pe,ot,nt.aabb);Ht!=null&&(me=Math.min(Ht,me))}if(Ct.children)for(const ut of Ct.children)rt(ut)};if(rt(be),me===Number.MAX_VALUE)return;const tt=new Zi(0,0);return d1(ve.tileID.canonical,tt,ne.node.anchor[0],ne.node.anchor[1]),{intersectionZ:me,position:tt,feature:ne.feature}}(S,x,l,a);if(!b)return;const{z:T,x:M,y:D}=p.tileID.canonical,{feature:z,intersectionZ:N,position:B}=b;let F={};z.id!==void 0&&(F=o.sourceCache.getFeatureState(y.sourceLayer,z.id));const U=new nh({},T,M,D,z.id);U.tile=this.tileID.canonical,U.state=F,U.properties=z.properties,U.geometry={type:"Point",coordinates:[B.lng,B.lat]};let q=this.serializedLayersCache.get(h);q||(q=y.serialize(),q.id=h,this.serializedLayersCache.set(h,q)),U.source=q.source,U.sourceLayer=q["source-layer"],U.layer=Gi({},q);let Z=!1;for(const re of w){this.updateFeatureProperties(U,re);const{filter:ee}=re;if(ee){if(z.properties=U.properties,ee.needGeometry){if(!ee.filter(new ur(this.tileID.overscaledZ),z,this.tileID.canonical))continue}else if(!ee.filter(new ur(this.tileID.overscaledZ),z))continue}Z=!0,re.targetId&&this.addFeatureVariant(U,re)}Z&&this.appendToResult(e,h,x,U,N)}updateFeatureProperties(e,i,o){if(i.properties){const l={};for(const a in i.properties){const h=i.properties[a].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,o);h!=null&&(l[a]=h)}e.properties=l}}addFeatureVariant(e,i,o){const l={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(l.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(l)}appendToResult(e,i,o,l,a){let h=e[i];h===void 0&&(h=e[i]=[]),h.push({featureIndex:o,feature:l,intersectionZ:a})}lookupSymbolFeatures(e,i,o,l,a){const h={};this.loadVTLayers();for(const _ of e)this.loadMatchingFeature(h,{bucketIndex:i,sourceLayerIndex:o,featureIndex:_,layoutVertexArrayOffset:0},l,a);return h}loadFeature(e){const{featureIndex:i,sourceLayerIndex:o}=e;this.loadVTLayers();const l=this.sourceLayerCoder.decode(o),a=this.vtFeatures[l];if(a[i])return a[i];const h=this.vtLayers[l].feature(i);return a[i]=h,h}hasLayer(e){for(const i of this.bucketLayerIDs)for(const o of i)if(e===o)return!0;return!1}getId(e,i){let o=e.id;if(this.promoteId){const l=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(l!=null)if(Array.isArray(l)){if(!this.promoteIdExpression){const a=Qa(l);if(a.result!=="success"){const h=a.value.map(_=>`${_.key}: ${_.message}`).join(", ");return void br(`Failed to create expression for promoteId: ${h}`)}this.promoteIdExpression=a.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Jc),o=this.promoteIdExpression.evaluate({zoom:0},e)}else o=e.properties[l];typeof o=="boolean"&&(o=Number(o))}return o}}function rb(n,e,i,o,l){return ns(n,(a,h)=>{const _=e instanceof ol?e.get(h):null;return _&&_.evaluate?_.evaluate(i,o,l):_})}function xM(n,e){return e-n}It(ib,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const nb=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class vy{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,o]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const l=o>>4;if(l!==1)throw new Error(`Got v${l} data when expected v1.`);const a=nb[15&o];if(!a)throw new Error("Unrecognized array type.");const[h]=new Uint16Array(e,2,1),[_]=new Uint32Array(e,4,1);return new vy(_,h,a,e)}constructor(e,i=64,o=Float64Array,l){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=o,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const a=nb.indexOf(this.ArrayType),h=2*e*this.ArrayType.BYTES_PER_ELEMENT,_=e*this.IndexArrayType.BYTES_PER_ELEMENT,y=(8-_%8)%8;if(a<0)throw new Error(`Unexpected typed array class: ${o}.`);l&&l instanceof ArrayBuffer?(this.data=l,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+_+y,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+h+_+y),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+_+y,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+a]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=e,this.coords[this._pos++]=i,o}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return xy(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,o,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:h,nodeSize:_}=this,y=[0,a.length-1,0],w=[];for(;y.length;){const p=y.pop()||0,x=y.pop()||0,S=y.pop()||0;if(x-S<=_){for(let D=S;D<=x;D++){const z=h[2*D],N=h[2*D+1];z>=e&&z<=o&&N>=i&&N<=l&&w.push(a[D])}continue}const b=S+x>>1,T=h[2*b],M=h[2*b+1];T>=e&&T<=o&&M>=i&&M<=l&&w.push(a[b]),(p===0?e<=T:i<=M)&&(y.push(S),y.push(b-1),y.push(1-p)),(p===0?o>=T:l>=M)&&(y.push(b+1),y.push(x),y.push(1-p))}return w}within(e,i,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:l,coords:a,nodeSize:h}=this,_=[0,l.length-1,0],y=[],w=o*o;for(;_.length;){const p=_.pop()||0,x=_.pop()||0,S=_.pop()||0;if(x-S<=h){for(let D=S;D<=x;D++)ob(a[2*D],a[2*D+1],e,i)<=w&&y.push(l[D]);continue}const b=S+x>>1,T=a[2*b],M=a[2*b+1];ob(T,M,e,i)<=w&&y.push(l[b]),(p===0?e-o<=T:i-o<=M)&&(_.push(S),_.push(b-1),_.push(1-p)),(p===0?e+o>=T:i+o>=M)&&(_.push(b+1),_.push(x),_.push(1-p))}return y}}function xy(n,e,i,o,l,a){if(l-o<=i)return;const h=o+l>>1;sb(n,e,h,o,l,a),xy(n,e,i,o,h-1,1-a),xy(n,e,i,h+1,l,1-a)}function sb(n,e,i,o,l,a){for(;l>o;){if(l-o>600){const w=l-o+1,p=i-o+1,x=Math.log(w),S=.5*Math.exp(2*x/3),b=.5*Math.sqrt(x*S*(w-S)/w)*(p-w/2<0?-1:1);sb(n,e,i,Math.max(o,Math.floor(i-p*S/w+b)),Math.min(l,Math.floor(i+(w-p)*S/w+b)),a)}const h=e[2*i+a];let _=o,y=l;for(gf(n,e,o,i),e[2*l+a]>h&&gf(n,e,o,l);_<y;){for(gf(n,e,_,y),_++,y--;e[2*_+a]<h;)_++;for(;e[2*y+a]>h;)y--}e[2*o+a]===h?gf(n,e,o,y):(y++,gf(n,e,y,l)),y<=i&&(o=y+1),i<=y&&(l=y-1)}}function gf(n,e,i,o){by(n,i,o),by(e,2*i,2*o),by(e,2*i+1,2*o+1)}function by(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}function ob(n,e,i,o){const l=n-i,a=e-o;return l*l+a*a}s.$=kn,s.A=Hn,s.B=Zs,s.C=cl,s.D=Ju,s.E=Ls,s.F=2,s.G=Jd,s.H=fx,s.I=Vn,s.J=class extends Sm{},s.K=co,s.L=qi,s.M=Ap,s.N=ed,s.O=Ja,s.P=we,s.Q=gp,s.R=ln,s.S=gu,s.T=Jg,s.U=Mu,s.V=Sm,s.W=nd,s.X=Qa,s.Y=Jl,s.Z=mo,s._=Za,s.a=function(n){return X.API_CDN_URL_REGEX.test(n)},s.a$=R,s.a0=xs,s.a1=md,s.a2=mu,s.a3=pu,s.a4=function(n){const e=n.value;let i=[];if(!e)return i;const o=co(e);return o!=="string"?(i=i.concat([new Sm(n.key,e,`string expected, "${o}" found`)]),i):(i1(e,!0)||(i=i.concat([new Sm(n.key,e,`invalid url "${e}"`)])),i)},s.a5=Fe,s.a6=pd,s.a7=Cr,s.a8=ct,s.a9=class{constructor(n){this.specification=n}possiblyEvaluate(n,e){return Pa(n.expression.evaluate(e))}interpolate(n,e,i){return{x:Xt(n.x,e.x,i),y:Xt(n.y,e.y,i),z:Xt(n.z,e.z,i),azimuthal:Xt(n.azimuthal,e.azimuthal,i),polar:Xt(n.polar,e.polar,i)}}},s.aA=function(n,e){const i={};for(let o=0;o<e.length;o++){const l=e[o];l in n&&(i[l]=n[l])}return i},s.aB=Ho,s.aC=Xn,s.aD=class{constructor(n){this.entries={},this.scheduler=n}request(n,e,i,o){const l=this.entries[n]=this.entries[n]||{callbacks:[]};if(l.result){const[a,h]=l.result;return this.scheduler?this.scheduler.add(()=>{o(a,h)},e):o(a,h),()=>{}}return l.callbacks.push(o),l.cancel||(l.cancel=i((a,h)=>{l.result=[a,h];for(const _ of l.callbacks)this.scheduler?this.scheduler.add(()=>{_(a,h)},e):_(a,h);setTimeout(()=>delete this.entries[n],3e3)})),()=>{l.result||(l.callbacks=l.callbacks.filter(a=>a!==o),l.callbacks.length||(l.cancel(),delete this.entries[n]))}}},s.aE=function(n,e,i){const o=JSON.stringify(n.request);return n.data&&(this.deduped.entries[o]={result:[null,n.data]}),this.deduped.request(o,{type:"parseTile",isSymbolTile:n.isSymbolTile,zoom:n.tileZoom},l=>{const a=so(n.request,(h,_,y,w)=>{h?l(h):_&&l(null,{vectorTile:i?void 0:new yl.VectorTile(new nm(_)),rawData:_,cacheControl:y,expires:w})});return()=>{a.cancel(),l()}},e)},s.aF=function(n){Qi++,Qi>fi&&(n.getActor().send("enforceCacheSizeLimit",ai),Qi=0)},s.aG=function(n){return n<=1?1:Math.pow(2,Math.floor(Math.log(n)/Math.LN2))},s.aH=it,s.aI=Gx,s.aJ=Xx,s.aK=jx,s.aL=function(n,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let o=0;o<n.length;o++){const l=document.createElement("source");Th(n[o])||(i.crossOrigin="Anonymous"),l.src=n[o],i.appendChild(l)}return{cancel:()=>{}}},s.aM=vm,s.aN=function(n){return fetch(n).then(e=>e.arrayBuffer()).then(e=>J1(e,0,n))},s.aO=eb,s.aP=class{constructor(n,e,i,o){this.id=n,this.position=e!=null?new Zi(e[0],e[1]):new Zi(0,0),this.orientation=i??[0,0,0],this.nodes=o,this.uploaded=!1,this.aabb=new kt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(n,e){if(J.mat4.multiply(n.matrix,e,n.matrix),n.meshes)for(const i of n.meshes){const o=kt.applyTransformFast(i.aabb,n.matrix);this.aabb.encapsulate(o)}if(n.children)for(const i of n.children)this._applyTransformations(i,n.matrix)}computeBoundsAndApplyParent(){const n=J.mat4.identity([]);for(const e of this.nodes)this._applyTransformations(e,n)}computeModelMatrix(n,e,i,o,l,a,h=!1){a1(this.matrix,this,n.transform,this.position,e,i,o,l,a,h)}upload(n){if(!this.uploaded){for(const e of this.nodes)ry(e,n);for(const e of this.nodes)Em(e);this.uploaded=!0}}destroy(){for(const n of this.nodes)ny(n)}},s.aQ=Ln,s.aR=ef,s.aS=Kn,s.aT=fn,s.aU=vo,s.aV=dn,s.aW=Vr,s.aX=dc,s.aY=gm,s.aZ=function(){Ts.isLoading()||Ts.isLoaded()||Su()!=="deferred"||Mp()},s.a_=_d,s.aa=ur,s.ab=el,s.ac=t,s.ad=J,s.ae=yi,s.af=ol,s.ag=Gn,s.ah=Xt,s.ai=ht,s.aj=Qf,s.ak=xt,s.al=tr,s.am=class{constructor(n){this.specification=n}possiblyEvaluate(n,e){return function([i,o]){const l=Pa([1,i,o]);return{x:l.x,y:l.y,z:l.z}}(n.expression.evaluate(e))}interpolate(n,e,i){return{x:Xt(n.x,e.x,i),y:Xt(n.y,e.y,i),z:Xt(n.z,e.z,i)}}},s.an=function(n,e,i=0,o=!0){const l=new we(i,i),a=n.sub(l),h=e.add(l),_=[a,new we(h.x,a.y),h,new we(a.x,h.y)];return o&&_.push(a.clone()),_},s.ao=function(n,e){const i=[];for(let o=0;o<n.length;o++){const l=Ji(o-1,-1,n.length-1),a=Ji(o+1,-1,n.length-1),h=n[o],_=n[a],y=n[l].sub(h).unit(),w=_.sub(h).unit(),p=w.angleWithSep(y.x,y.y),x=y.add(w).unit().mult(-1*e/Math.sin(p/2));i.push(h.add(x))}return i},s.ap=Ix,s.aq=he,s.ar=function(n,e,i=0){return J.vec3.fromValues(((e.x-i)*n.scale-n.x)*ht,(e.y*n.scale-n.y)*ht,Fd(e.z,e.y))},s.as=Yt,s.at=j0,s.au=function(n){let e=1/0,i=1/0,o=-1/0,l=-1/0;for(const a of n)e=Math.min(e,a.x),i=Math.min(i,a.y),o=Math.max(o,a.x),l=Math.max(l,a.y);return{min:new we(e,i),max:new we(o,l)}},s.av=Ys,s.aw=ue,s.ax=c,s.ay=Dt,s.az=Fn,s.b=function(n){return X.API_FONTS_REGEX.test(n)},s.b$=wm,s.b0=nh,s.b1=sa,s.b2=Rg,s.b3=Sg,s.b4=C,s.b5=yo,s.b6=Lu,s.b7=Wt,s.b8=Tr,s.b9=Ud,s.bA=x0,s.bB=jg,s.bC=bx,s.bD=Ng,s.bE=vy,s.bF=Ji,s.bG=Ra,s.bH=bn,s.bI=function(n,e,i){n[4*e+0]=i[0],n[4*e+1]=i[1],n[4*e+2]=i[2],n[4*e+3]=i[3]},s.bJ=xc,s.bK=Es,s.bL=dl,s.bM=jr,s.bN=yc,s.bO=Zi,s.bP=zx,s.bQ=je,s.bR=ci,s.bS=Yx,s.bT=Qe,s.bU=Pn,s.bV=function(n,e,i,o,l,a,h,_,y){if(y.name==="globe")return Pn(n,e,new Qe(i,o,l),!1);const w=ef({z:i,x:o,y:l},y);return new kt([(a+w.x/w.scale)*e,e*(w.y/w.scale),h],[(a+w.x2/w.scale)*e,e*(w.y2/w.scale),_])},s.bW=function(n,e,i){let o=0;for(let l=0;l<2;++l)n[l]>0&&(o+=(n[l]-0)*(n[l]-0)),e[l]<0&&(o+=(0-e[l])*(0-e[l]));return o},s.bX=jn,s.bY=qp,s.bZ=function(n){const e=J.mat4.identity(new Float64Array(16));J.mat4.multiply(e,n.pixelMatrix,n.globeMatrix);const i=[0,us,0],o=[0,hs,0];return J.vec3.transformMat4(i,i,e),J.vec3.transformMat4(o,o,e),[i[0]>0&&i[0]<=n.width&&i[1]>0&&i[1]<=n.height&&!Jn(n,new Zi(n.center.lat,90)),o[0]>0&&o[0]<=n.width&&o[1]>0&&o[1]<=n.height&&!Jn(n,new Zi(n.center.lat,-90))]},s.b_=function(n,e){const{scale:i}=n.tileTransform,o=i*ht/(n.tileSize*Math.pow(2,e.zoom-n.tileID.overscaledZ+n.tileID.canonical.z));return J.mat2.scale(new Float32Array(4),e.inverseAdjustmentMatrix,[o,o])},s.ba=Xg,s.bb=function(n,e){const i=Gn(e.zoom);if(i===0)return tn(n);const o=Li(n),l=Er(o),a=Ys(o.getWest())*e.worldSize,h=Ys(o.getEast())*e.worldSize,_=Xn(o.getNorth())*e.worldSize,y=Xn(o.getSouth())*e.worldSize,w=[a,_,0],p=[h,_,0],x=[a,y,0],S=[h,y,0],b=J.mat4.invert([],e.globeMatrix);return J.vec3.transformMat4(w,w,b),J.vec3.transformMat4(p,p,b),J.vec3.transformMat4(x,x,b),J.vec3.transformMat4(S,S,b),l[0]=nn(l[0],x,i),l[1]=nn(l[1],S,i),l[2]=nn(l[2],p,i),l[3]=nn(l[3],w,i),kt.fromPoints(l)},s.bc=yr,s.bd=Xi,s.be=nn,s.bf=ul,s.bg=si,s.bh=Om,s.bi=nm,s.bj=so,s.bk=function(n,e){const i=[];for(const o in n)o in e||i.push(o);return i},s.bl=gr,s.bm=["type","source","source-layer","minzoom","maxzoom","filter","layout"],s.bn=bt,s.bo=function(n,e){const{x:i,y:o}=n.point,l=Ms(i,o,n.worldSize/n._pixelsPerMercatorPixel,0,0);return J.mat4.multiply(l,l,rn(tn(e)))},s.bp=qu,s.bq=fs,s.br=rm,s.bs=function(n,e,i,o,l){const a=5*e+2;n.float32[a+0]=i,n.float32[a+1]=o,n.float32[a+2]=l},s.bt=_m,s.bu=dx,s.bv=H,s.bw=Tn,s.bx=p0,s.by=t1,s.bz=v0,s.c=le,s.c$=H0,s.c0=Kx,s.c1=function(n){const e=Kx(n,!0);return J.mat2.invert([],[e[0],e[1],e[4],e[5]])},s.c2=Ii,s.c3=function(n){const{x:e,y:i}=n.point,{lng:o,lat:l}=n._center;return Ms(e,i,n.worldSize,o,l)},s.c4=Ut,s.c5=_t,s.c6=fl,s.c7=function(n){const e=Math.round((n+45+360)%360/90)%4;return Gt[e]},s.c8=45,s.c9=ep,s.cA=Up,s.cB=class extends Ks{constructor(n){super(n),this.current=zd}set(n,e,i){if(this.fetchUniformLocation(n,e)){for(let o=0;o<9;o++)if(i[o]!==this.current[o]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},s.cC=Nt,s.cD=function(n,e,i){const o=Gn(i.zoom),l=n.style.map._antialias,a=n.terrain&&n.terrain.exaggeration()>0;return o===0&&!l&&!a},s.cE=function(n){const e=n.pixelsPerMeter,i=e/bn(1,n.center.lat),o=J.mat4.identity(new Float64Array(16));return J.mat4.translate(o,o,[n.point.x,n.point.y,0]),J.mat4.scale(o,o,[i,i,e]),Float32Array.from(o)},s.cF=Li,s.cG=function(n){const e=jn-5;n=Dt(n,-80.051129,e)/e*90;const i=Math.pow(Math.abs(Math.sin(xt(n))),3);return Math.round(i*(Vu.length-1))},s.cH=function(n,e,i,o){const l=e.getNorth(),a=e.getSouth(),h=e.getWest(),_=e.getEast(),y=1<<n.z,w=_-h,p=l-a,x=w/pl,S=-p/Vu[i],b=[0,x,0,S,0,0,l,h,0];if(n.z>0){const T=180/o;J.mat3.multiply(b,b,[T/w+1,0,0,0,T/p+1,0,-.5*T/x,.5*T/S,1])}return b[2]=y,b[5]=n.x,b[8]=n.y,b},s.cI=tn,s.cJ=function(n,e,i){const o=J.mat4.identity(new Float64Array(16)),l=(e/(1<<n)-.5)*Math.PI*2;return J.mat4.rotateY(o,i.globeMatrix,l),Float32Array.from(o)},s.cK=class{isDataAvailableAtPoint(n){const e=this._source();if(this.isUsingMockSource()||!e||n.y<0||n.y>1)return!1;const i=e.getSource().maxzoom,o=1<<i,l=Math.floor(n.x),a=Math.floor((n.x-l)*o),h=Math.floor(n.y*o),_=this.findDEMTileFor(new it(i,l,i,a,h));return!(!_||!_.dem)}getAtPointOrZero(n,e=0){return this.getAtPoint(n,e)||0}getAtPoint(n,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const o=this._source();if(!o||n.y<0||n.y>1)return e;const l=o.getSource().maxzoom,a=1<<l,h=Math.floor(n.x),_=n.x-h,y=new it(l,h,l,Math.floor(_*a),Math.floor(n.y*a)),w=this.findDEMTileFor(y);if(!w||!w.dem)return e;const p=w.dem,x=1<<w.tileID.canonical.z,S=(_*x-w.tileID.canonical.x)*p.dim,b=(n.y*x-w.tileID.canonical.y)*p.dim,T=Math.floor(S),M=Math.floor(b);return(i?this.exaggeration():1)*Xt(Xt(p.get(T,M),p.get(T,M+1),b-M),Xt(p.get(T+1,M),p.get(T+1,M+1),b-M),S-T)}getAtTileOffset(n,e,i){const o=1<<n.canonical.z;return this.getAtPointOrZero(new t(n.wrap+(n.canonical.x+e/ht)/o,(n.canonical.y+i/ht)/o))}getAtTileOffsetFunc(n,e,i,o){return l=>{const a=this.getAtTileOffset(n,l.x,l.y),h=o.upVector(n.canonical,l.x,l.y),_=o.upVectorScale(n.canonical,e,i).metersToTile;return J.vec3.scale(h,h,a*_),h}}getForTilePoints(n,e,i,o){if(this.isUsingMockSource())return!1;const l=Yu.create(this,n,o);return!!l&&(e.forEach(a=>{a[2]=this.exaggeration()*l.getElevationAt(a[0],a[1],i)}),!0)}getMinMaxForTile(n){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(n);if(!e||!e.dem)return null;const i=e.dem.tree,o=e.tileID,l=1<<n.canonical.z-o.canonical.z;let a=n.canonical.x/l-o.canonical.x,h=n.canonical.y/l-o.canonical.y,_=0;for(let y=0;y<n.canonical.z-o.canonical.z&&!i.leaves[_];y++){a*=2,h*=2;const w=2*Math.floor(h)+Math.floor(a);_=i.childOffsets[_]+w,a%=1,h%=1}return{min:this.exaggeration()*i.minimums[_],max:this.exaggeration()*i.maximums[_]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(n,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(n){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(n){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const n=this.visibleDemTiles;if(n.length===0)return null;let e=!1,i=Number.MAX_VALUE,o=Number.MIN_VALUE;for(const l of n){const a=this.getMinMaxForTile(l.tileID);a&&(i=Math.min(i,a.min),o=Math.max(o,a.max),e=!0)}return e?{min:i,max:o}:null}},s.cL=qv,s.cM=Ri,s.cN=function(n,e){return[Math.pow(n[0],2.2)*e,Math.pow(n[1],2.2)*e,Math.pow(n[2],2.2)*e]},s.cO=Yn,s.cP=$e,s.cQ=Vl,s.cR=256,s.cS=function(n,e){const i=[0,0,0],o=yr(tn(e.canonical));return J.vec3.transformMat4(i,i,o),J.vec3.transformMat4(i,i,n),i},s.cT=n=>({u_camera_to_center_distance:new jr(n),u_extrude_scale:new Ld(n),u_device_pixel_ratio:new jr(n),u_matrix:new xc(n),u_inv_rot_matrix:new xc(n),u_merc_center:new Es(n),u_tile_id:new dl(n),u_zoom_transition:new jr(n),u_up_dir:new dl(n),u_emissive_strength:new jr(n)}),s.cU=n=>({u_matrix:new xc(n),u_pixels_to_tile_units:new Ld(n),u_device_pixel_ratio:new jr(n),u_width_scale:new jr(n),u_floor_width_scale:new jr(n),u_units_to_pixels:new Es(n),u_dash_image:new yc(n),u_gradient_image:new yc(n),u_image_height:new jr(n),u_texsize:new Es(n),u_tile_units_to_pixels:new jr(n),u_alpha_discard_threshold:new jr(n),u_trim_offset:new Es(n),u_trim_fade_range:new Es(n),u_trim_color:new vc(n),u_emissive_strength:new jr(n),u_zbias_factor:new jr(n),u_tile_to_meter:new jr(n)}),s.cV=n=>({u_matrix:new xc(n),u_texsize:new Es(n),u_pixels_to_tile_units:new Ld(n),u_device_pixel_ratio:new jr(n),u_width_scale:new jr(n),u_floor_width_scale:new jr(n),u_image:new yc(n),u_units_to_pixels:new Es(n),u_tile_units_to_pixels:new jr(n),u_alpha_discard_threshold:new jr(n),u_trim_offset:new Es(n),u_trim_fade_range:new Es(n),u_trim_color:new vc(n),u_emissive_strength:new jr(n),u_zbias_factor:new jr(n),u_tile_to_meter:new jr(n)}),s.cW=Ed,s.cX=wS,s.cY=TS,s.cZ=_l,s.c_=(n,e,i,o,l,a)=>{const h=n.transform,_=h.projection.name==="globe";let y;if(a.paint.get("circle-pitch-alignment")==="map")if(_){const p=Yn(h.zoom,e.canonical)*h._pixelsPerMercatorPixel;y=Float32Array.from([p,0,0,p])}else y=h.calculatePixelsToTileUnitsMatrix(i);else y=new Float32Array([h.pixelsToGLUnits[0],0,0,h.pixelsToGLUnits[1]]);const w={u_camera_to_center_distance:n.transform.getCameraToCenterDistance(h.projection),u_matrix:n.translatePosMatrix(e.projMatrix,i,a.paint.get("circle-translate"),a.paint.get("circle-translate-anchor")),u_device_pixel_ratio:qe.devicePixelRatio,u_extrude_scale:y,u_inv_rot_matrix:Bd,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:a.paint.get("circle-emissive-strength")};if(_){w.u_inv_rot_matrix=o,w.u_merc_center=l,w.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],w.u_zoom_transition=Gn(h.zoom);const p=l[0]*ht,x=l[1]*ht;w.u_up_dir=h.projection.upVector(new Qe(0,0,0),p,x)}return w},s.ca=Uu,s.cb=vc,s.cc=function(n,e,i){const o=Math.sqrt(n*n+e*e+i*i),l=o>0?Math.acos(i/o)*St:0;let a=n!==0||e!==0?Math.atan2(-e,-n)*St+90:0;return a<0&&(a+=360),[o,a,l]},s.cd=u,s.ce=kt,s.cf=Pa,s.cg=function(n){return[Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)]},s.ch=function(n,e){return n.readFields(gE,{icons:[]},e)},s.ci=function(n){return n({pluginStatus:Un,pluginURL:Vo}),il.on("pluginStateChange",n),n},s.cj=Am,s.ck=Zu,s.cl=Vg,s.cm=Da,s.cn=oc,s.co=Mt,s.cp=os,s.cq=Or,s.cr=function(n){const e=n.indexOf(Iu);return e>=0?n.slice(0,e):n},s.cs=function(n){return n.indexOf(Iu)>=0},s.ct=function(n){const e=n.indexOf(Iu);return e>=0?n.slice(e+1):""},s.cu=function(n){const e=[],i=n.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),n.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),n.renderingMode&&n.renderingMode!=="2d"&&n.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},s.cv=function(n,e,i,o){return n.type==="custom"?new rE(n,e):new pE[n.type](n,e,i,o)},s.cw=Hs,s.cx=class extends nh{constructor(n,e){super(n._vectorTileFeature,n._z,n._x,n._y,n.id),n.state&&(this.state=Object.assign({},n.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=n.source,this.sourceLayer=n.sourceLayer,this.layer=n.layer)}toJSON(){const n=super.toJSON();return n.target=this.target,n.namespace=this.namespace,n}},s.cy=il,s.cz=vs,s.d=function(n){return X.API_TILEJSON_REGEX.test(n)},s.d$=tb,s.d0=Cn,s.d1=(n,e,i,o,l,a,h,_)=>{const y=n.transform,w=y.pitch<15?G0(.07,.7,Dt((14-y.zoom)/5,0,1)):.07,p=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:$0(n,e,i,o),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:y.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:l,u_width_scale:a,u_floor_width_scale:h,u_image:0,u_tile_units_to_pixels:q0(e,y),u_units_to_pixels:[1/y.pixelsToGLUnits[0],1/y.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:_,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toRenderColor(p?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:w,u_tile_to_meter:u(e.tileID.canonical,0)}},s.d2=(n,e,i,o,l,a,h,_,y)=>{const w=n.transform,p=w.calculatePixelsToTileUnitsMatrix(e),x=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",S=w.pitch<15?G0(.07,.7,Dt((14-w.zoom)/5,0,1)):.07;return{u_matrix:$0(n,e,i,o),u_pixels_to_tile_units:p,u_device_pixel_ratio:a,u_width_scale:h,u_floor_width_scale:_,u_units_to_pixels:[1/w.pixelsToGLUnits[0],1/w.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:l,u_texsize:Z0(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:q0(e,n.transform),u_alpha_discard_threshold:0,u_trim_offset:y,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toRenderColor(x?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:S,u_tile_to_meter:u(e.tileID.canonical,0)}},s.d3=zn,s.d4=Vd,s.d5=Fd,s.d6=z0,s.d7=yt,s.d8=im,s.d9=vl,s.dA=Qp,s.dB=xi,s.dC=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},s.dD=Jt,s.dE=fg,s.dF=ya,s.dG=function([n,e,i]){const o=Math.hypot(n,e,i),l=Math.atan2(n,i),a=.5*Math.PI-Math.acos(-e/o);return new Zi(Ut(l),Ut(a))},s.dH=ey,s.dI=function(n){const e=n.navigator?n.navigator.userAgent:null;return!!function(i){if(Nl==null){const o=i.navigator?i.navigator.userAgent:null;Nl=!!i.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return Nl}(n)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},s.dJ=function(n,e){ai=n,fi=e},s.dK=Jn,s.dL=As,s.dM=function(n){const e=[0,0,0],i=J.mat4.identity(new Float64Array(16));return J.mat4.multiply(i,n.pixelMatrix,n.globeMatrix),J.vec3.transformMat4(e,e,i),new we(e[0],e[1])},s.dN=function(n,e,i=!1){if(Un===ud||Un===Xs||Un===hd)throw new Error("setRTLTextPlugin cannot be called multiple times.");Vo=qe.resolveURL(n),Un=ud,dd=e,Tu(),i||Mp()},s.dO=Su,s.dP=function(){Am().acquire(oy)},s.dQ=function(){const n=cf;n&&(n.isPreloaded()&&n.numActive()===1?(n.release(oy),cf=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},s.dR=Cc,s.dS=function(n){const e=Ar();if(!e)return;const i=e.delete(Rt);n&&i.catch(n).then(()=>n())},s.dT=lf,s.dU=$1,s.dV=function(n){my=qe.resolveURL(n),rh||(rh=new Ju(Am(),new Ls)),rh.broadcast("setDracoUrl",my)},s.dW=H1,s.dX=function(n){ih=qe.resolveURL(n),rh||(rh=new Ju(Am(),new Ls)),rh.broadcast("setMeshoptUrl",ih)},s.dY=It,s.dZ=gl,s.d_=Eo,s.da=450,s.db=7,s.dc=iE,s.dd=Hi,s.de=Fu,s.df=256,s.dg=rn,s.dh=Bs,s.di=Zn,s.dj=zu,s.dk=function(n,e,i,o,l){return Dt((n-e)/(i-e)*(l-o)+o,o,l)},s.dl=Kh,s.dm=Zo,s.dn=class{constructor(n,e,i,o){this.context=n,this.format=o,this.size=i,this.texture=n.gl.createTexture();const[l,a,h]=this.size,{gl:_}=n;_.bindTexture(_.TEXTURE_3D,this.texture),n.pixelStoreUnpackFlipY.set(!1),n.pixelStoreUnpack.set(1),n.pixelStoreUnpackPremultiplyAlpha.set(!1),_.texImage3D(_.TEXTURE_3D,0,this.format,l,a,h,0,Kg(this.format),Yg(this.format),e.data)}bind(n,e){const{context:i}=this,{gl:o}=i;o.bindTexture(o.TEXTURE_3D,this.texture),n!==this.minFilter&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MAG_FILTER,n),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MIN_FILTER,n),this.minFilter=n),e!==this.wrapS&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_S,e),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}},s.dp=ty,s.dq=[1,1,1],s.dr=Yu,s.ds=Ku,s.dt=Go,s.du=hl,s.dv=va,s.dw=Id,s.dx=Ad,s.dy=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new we(1/0,1/0),max:new we(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(n,e=!1){const i=_0(new we(0,0),new we(ht,ht),n),o=[];if(e&&!Mg(i,this._globalClipBounds))return o;for(const l of this._activeRegions){if(l.hiddenByOverlap||!Mg(i,l))continue;const a=XT(l.min,l.max,n);o.push({min:a.min,max:a.max,sourceId:this._sourceIds[l.priority],footprint:l.footprint,footprintTileId:l.tileId,order:l.order,clipMask:l.clipMask,clipScope:l.clipScope})}return o}setSources(n){this._setSources(n.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const o of e.cache.getVisibleCoordinates()){const l=e.cache.getTile(o).buckets[e.layer];l&&l.updateFootprints(o.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(n){const e=n.getFootprints();if(e.length===0)return;const i=n.getOrder(),o=n.getClipMask(),l=n.getClipScope();for(const a of e){if(!a.footprint)continue;const h=_0(a.footprint.min,a.footprint.max,a.id);this._activeRegions.push({min:h.min,max:h.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:a.id,footprint:a.footprint,order:i,clipMask:o,clipScope:l})}this._sourceIds.push(n.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||em(e.min,i.min)||em(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||function(o,l){const a=(h,_)=>h+_;return o.length-l.length||o.reduce(a,"").localeCompare(l.reduce(a,""))}(e.clipScope,i.clipScope));let n=this._activeRegions.length!==this._prevRegions.length;if(!n){let e=0;for(;!n&&e!==this._activeRegions.length;){const i=this._activeRegions[e],o=this._prevRegions[e];n=i.priority!==o.priority||!m0(i,o)||i.order!==o.order||i.clipMask!==o.clipMask||!bt(i.clipScope,o.clipScope),++e}}if(n){++this._updateTime;for(const i of this._activeRegions)i.order!==Qp&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const o=this._activeRegions;if(i>=o.length)return i;const l=o[i].priority;for(;i<o.length&&o[i].priority===l;)++i;return i};if(this._sourceIds.length>1){let i=0,o=e(i);for(;i!==o;){let l=i;const a=i;for(;l!==o;){const h=this._activeRegions[l];h.hiddenByOverlap=!1;for(let _=0;_<a;_++){const y=this._activeRegions[_];if(!y.hiddenByOverlap&&h.order===Qp&&Mg(h,y)&&(h.hiddenByOverlap=y0(h.footprint,h.tileId,y.footprint,y.tileId),h.hiddenByOverlap))break}++l}i=o,o=e(i)}}}}_setSources(n){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=n.length-1;e>=0;e--)this._addSource(n[e]);this._computeReplacement()}},s.dz=class{constructor(n){this._createGrid(n),this._createPoles(n)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const n of this._poleSegments)n.destroy();for(const n of this._gridSegments)n.withSkirts.destroy(),n.withoutSkirts.destroy()}_fillGridMeshWithLods(n,e){const i=new yo,o=new dn,l=[],a=n+1+2,h=e[0]+1,_=e[0]+1+(1+e.length),y=(w,p,x)=>{let S=w===a-1?w-2:w===0?w:w-1;return S+=x?24575:0,[S,p]};for(let w=0;w<a;++w)i.emplaceBack(...y(w,0,!0));for(let w=0;w<h;++w)for(let p=0;p<a;++p)i.emplaceBack(...y(p,w,(p===0||p===a-1)&&!0));for(let w=0;w<e.length;++w){const p=e[w];for(let x=0;x<a;++x)i.emplaceBack(...y(x,p,!0))}for(let w=0;w<e.length;++w){const p=o.length,x=e[w]+1+2,S=new dn;for(let M=0;M<x-1;M++){const D=M===x-2,z=D?a*(_-e.length+w-M):a;for(let N=0;N<a-1;N++){const B=M*a+N;M===0||D||N===0||N===a-2?(S.emplaceBack(B+1,B,B+z),S.emplaceBack(B+z,B+z+1,B+1)):(o.emplaceBack(B+1,B,B+z),o.emplaceBack(B+z,B+z+1,B+1))}}const b=Tr.simpleSegment(0,p,i.length,o.length-p);for(let M=0;M<S.uint16.length;M+=3)o.emplaceBack(S.uint16[M],S.uint16[M+1],S.uint16[M+2]);const T=Tr.simpleSegment(0,p,i.length,o.length-p);l.push({withoutSkirts:b,withSkirts:T})}return{vertices:i,indices:o,segments:l}}_createGrid(n){const e=this._fillGridMeshWithLods(pl,Vu);this._gridSegments=e.segments,this._gridBuffer=n.createVertexBuffer(e.vertices,Wt.members),this._gridIndexBuffer=n.createIndexBuffer(e.indices,!0)}_createPoles(n){const e=new dn;for(let h=0;h<=pl;h++)e.emplaceBack(0,h+1,h+2);this._poleIndexBuffer=n.createIndexBuffer(e,!0);const i=new Zn,o=new Zn,l=new Zn,a=new Zn;this._poleSegments=[];for(let h=0,_=0;h<fl;h++){const y=360/(1<<h);i.emplaceBack(0,-Fn,0,.5,0),o.emplaceBack(0,-Fn,0,.5,1),l.emplaceBack(0,-Fn,0,.5,.5),a.emplaceBack(0,-Fn,0,.5,.5);for(let w=0;w<=pl;w++){let p=w/pl,x=0;const S=Xt(0,y,p),[b,T,M]=ml(Qs,wo,S,Fn);i.emplaceBack(b,T,M,p,x),o.emplaceBack(b,T,M,p,1-x);const D=xt(S);p=.5+.5*Math.sin(D),x=.5+.5*Math.cos(D),l.emplaceBack(b,T,M,p,x),a.emplaceBack(b,T,M,p,1-x)}this._poleSegments.push(Tr.simpleSegment(_,0,66,64)),_+=66}this._poleNorthVertexBuffer=n.createVertexBuffer(i,Ot,!1),this._poleSouthVertexBuffer=n.createVertexBuffer(o,Ot,!1),this._texturedPoleNorthVertexBuffer=n.createVertexBuffer(l,Ot,!1),this._texturedPoleSouthVertexBuffer=n.createVertexBuffer(a,Ot,!1)}getGridBuffers(n,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[n].withSkirts:this._gridSegments[n].withoutSkirts]}getPoleBuffers(n,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[n]]}},s.e=X,s.e0=ib,s.e1=N0,s.e2=Tc,s.e3="hd_road_elevation",s.e4=class{static parseFrom(n,e){const i=xa.parse(n);if(!i)return[];let{vertices:o,features:l}=i;const a=1/u(e);l.sort((w,p)=>w.id-p.id),o.sort((w,p)=>w.id-p.id||w.idx-p.idx),o=o.filter((w,p,x)=>p===x.findIndex(S=>S.id===w.id&&S.idx===w.idx));const h=new Array;let _=0;const y=o.length;for(const w of l){if(w.constantHeight){h.push(new wg(w.id,w.bounds,w.constantHeight));continue}for(;_!==y&&o[_].id<w.id;)_++;if(_===y||o[_].id!==w.id)continue;const p=new Array,x=new Array,S=_;for(;_!==y&&o[_].id===w.id;){const b=o[_];if(p.push({position:b.position,height:b.height,extent:b.extent}),_!==S&&o[_-1].idx===b.idx-1){const T=_-S;x.push({a:T-1,b:T})}_++}h.push(new wg(w.id,w.bounds,void 0,p,x,a))}return h}},s.e5=ns,s.e6=Sc,s.e7=px,s.e8=Hu,s.e9=function(n,e,i,o,l,a,h,_=1,y){n.createArrays(),n.tilePixelRatio=ht/(512*n.overscaling),n.compareText={},n.iconsNeedLinear=!1;const w=n.layers[0].layout,p=n.layers[0]._unevaluatedLayout._values,x={};x.scaleFactor=_,x.textSizeScaleRange=w.get("text-size-scale-range"),x.iconSizeScaleRange=w.get("icon-size-scale-range");const[S,b]=x.textSizeScaleRange,[T,M]=x.iconSizeScaleRange;x.textScaleFactor=Dt(x.scaleFactor,S,b),x.iconScaleFactor=Dt(x.scaleFactor,T,M);const D=p["text-size"],z=p["icon-size"];if(n.textSizeData.kind==="composite"){const{minZoom:Z,maxZoom:re}=n.textSizeData;x.compositeTextSizes=[D.possiblyEvaluate(new ur(Z),a),D.possiblyEvaluate(new ur(re),a)]}if(n.iconSizeData.kind==="composite"){const{minZoom:Z,maxZoom:re}=n.iconSizeData;x.compositeIconSizes=[z.possiblyEvaluate(new ur(Z),a),z.possiblyEvaluate(new ur(re),a)]}x.layoutTextSize=D.possiblyEvaluate(new ur(h+1),a),x.layoutIconSize=z.possiblyEvaluate(new ur(h+1),a),x.textMaxSize=D.possiblyEvaluate(new ur(18),a);const N=w.get("symbol-placement"),B=w.get("text-rotation-alignment")==="map"&&N!=="point",F=w.get("text-size");let U=!1;const q=[];for(const Z of n.features){const re=w.get("text-font").evaluate(Z,{},a).join(","),ee=F.evaluate(Z,{},a)*x.textScaleFactor,te=x.layoutTextSize.evaluate(Z,{},a)*x.textScaleFactor,pe=x.layoutIconSize.evaluate(Z,{},a)*x.iconScaleFactor,ne={horizontal:{},vertical:void 0},me=Z.text;let be,ve=[0,0];if(me){const nt=me.toString(),Ht=w.get("text-letter-spacing").evaluate(Z,{},a)*Tn,Et=w.get("text-line-height").evaluate(Z,{},a)*Tn,Lt=eg(nt)?Ht:0,ei=w.get("text-anchor").evaluate(Z,{},a),_i=w.get("text-variable-anchor");if(!_i){const Ni=w.get("text-radial-offset").evaluate(Z,{},a);ve=Ni?bx(ei,[Ni*Tn,Ug]):w.get("text-offset").evaluate(Z,{},a).map(hr=>hr*Tn)}let ri=B?"center":w.get("text-justify").evaluate(Z,{},a);const Ei=N==="point",mi=Ei?w.get("text-max-width").evaluate(Z,{},a)*Tn:1/0,Ai=Ni=>{n.allowVerticalPlacement&&ad(nt)&&(ne.vertical=Bg(me,e,i,l,re,mi,Et,ei,Ni,Lt,ve,fs.vertical,!0,te,ee,y))};if(!B&&_i){const Ni=ri==="auto"?_i.map(ti=>jg(ti)):[ri];let hr=!1;for(let ti=0;ti<Ni.length;ti++){const Di=Ni[ti];if(!ne.horizontal[Di])if(hr)ne.horizontal[Di]=ne.horizontal[0];else{const vr=Bg(me,e,i,l,re,mi,Et,"center",Di,Lt,ve,fs.horizontal,!1,te,ee,y);vr&&(ne.horizontal[Di]=vr,hr=vr.positionedLines.length===1)}}Ai("left")}else{if(ri==="auto"&&(ri=jg(ei)),Ei||w.get("text-writing-mode").indexOf("horizontal")>=0||!ad(nt)){const Ni=Bg(me,e,i,l,re,mi,Et,ei,ri,Lt,ve,fs.horizontal,!1,te,ee,y);Ni&&(ne.horizontal[ri]=Ni)}Ai(Ei?"left":ri)}}let Me,Ee,Oe,Ce,ke,rt=!1;if(Z.icon&&Z.icon.hasPrimary()){const nt=Tx(Z.icon,n.iconSizeData,p["icon-size"],a,n.zoom,Z,y,x.iconScaleFactor);Me=nt.iconPrimary,Ee=nt.iconSecondary;const Ht=Me.toString(),Et=o.get(Ht);Et&&(Oe=w.get("icon-offset").evaluate(Z,{},a),Ce=w.get("icon-anchor").evaluate(Z,{},a),ke=w.get("icon-text-fit").evaluate(Z,{},a),be=LS(l.get(Ht),Ee?l.get(Ee.toString()):void 0,Oe,Ce),rt=Et.sdf,n.sdfIcons===void 0?n.sdfIcons=Et.sdf:n.sdfIcons!==Et.sdf&&br("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Et.pixelRatio!==n.pixelRatio||w.get("icon-rotate").constantOr(1)!==0)&&(n.iconsNeedLinear=!0))}U=U||!(!Z.icon||!Z.icon.hasSecondary());const tt=Gg(ne.horizontal)||ne.vertical;n.iconsInText||(n.iconsInText=!!tt&&tt.iconsInText);const Ct=te*x.textScaleFactor/Tn,{defaultShapedIcon:ot,verticallyShapedIcon:ut}=jS(n,be,w,Z,a,ne,Ct,Oe,ke);be=ot,q.push({feature:Z,shapedTextOrientations:ne,shapedText:tt,shapedIcon:be,iconPrimary:Me,iconSecondary:Ee,iconOffset:Oe,iconAnchor:Ce,verticallyShapedIcon:ut,layoutTextSize:te,layoutIconSize:pe,textOffset:ve,isSDFIcon:rt,iconTextFit:ke})}return{featureData:q,sizes:x,hasAnySecondaryIcon:U,textAlongLine:B,symbolPlacement:N}},s.ea=mx,s.eb=function(n,e,i,o,l,a,h,_,y,w){const{featureData:p,hasAnySecondaryIcon:x,sizes:S,textAlongLine:b,symbolPlacement:T}=e;for(const M of p){const{shapedIcon:D,verticallyShapedIcon:z,feature:N,shapedTextOrientations:B,shapedText:F,layoutTextSize:U,textOffset:q,isSDFIcon:Z,iconPrimary:re,iconSecondary:ee,iconTextFit:te,iconOffset:pe}=M;Sx(D,w.iconPositions,re,ee),Sx(z,w.iconPositions,re,ee),US(B,w.iconPositions),(F||D)&&GS(n,N,B,D,z,y,S,U,0,q,Z,o,l,h,_,x,te,pe,b,T)}i&&n.generateCollisionDebugBuffers(a,n.collisionBoxArray,S.textScaleFactor)},s.ec=yl,s.ed=Lm,s.ee=Be,s.ef=i0,s.eg=ex,s.eh=Q,s.ei=function(n){let e=0;if(new Uint32Array(n,0,1)[0]!==W1){const i=new Uint32Array(n,0,7),[,,o,l,a,h]=i;e=i.byteLength+l+a+h+a,(o!==n.byteLength||e>=n.byteLength)&&br("Invalid b3dm header information.")}return J1(n,e)},s.ej=function(n,e){const i=eb(n);for(const o of i){for(const l of o.meshes)gM(l);o.lights&&(o.lightMeshIndex=o.meshes.length,o.meshes.push(yM(o.lights,e)))}return i},s.ek=Mm,s.el=f1,s.em=Ts,s.en=function(n){Mi(),vi!=null&&vi.then(e=>{e.keys().then(i=>{for(let o=0;o<i.length-n;o++)e.delete(i[o])})})},s.f=function(n){return n.indexOf("mapbox:")===0},s.g=function(n,e){return vs(Gi(n,{method:"GET"}),e)},s.h=Y,s.i=function(n){return X.API_STYLE_REGEX.test(n)&&!le(n)},s.j=function(n){return decodeURIComponent(atob(n).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},s.k=function(n){return btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,(e,i)=>String.fromCharCode(+("0x"+i))))},s.l=Gi,s.m=er,s.n=function(n,e){return vs(Gi(n,{type:"json"}),e)},s.o=Sh,s.p=function(n,e){return vs(Gi(n,{method:"POST"}),e)},s.q=qe,s.r=wn,s.s=function(n){try{const e=self[n];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},s.t=We,s.u=function(){return function n(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,n)}()},s.v=function(n){return!!n&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n)},s.w=br,s.x=function(){return ay||(ay=new Cc),ay},s.y=hy,s.z=Oa}),j(["./shared"],function(s){function Q($e){const X=$e?$e.url.toString():void 0;return X?performance.getEntriesByName(X):[]}function de($e){if(typeof $e=="number"||typeof $e=="boolean"||typeof $e=="string"||$e==null)return JSON.stringify($e);if(Array.isArray($e)){let Y="[";for(const le of $e)Y+=`${de(le)},`;return`${Y}]`}let X="{";for(const Y of Object.keys($e).sort())X+=`${Y}:${de($e[Y])},`;return`${X}}`}function ae($e){let X="";for(const Y of s.bm)($e.type!=="model"||Y!=="minzoom"&&Y!=="maxzoom")&&(X+=`/${de($e[Y])}`);return X}class Te{constructor(X){this.keyCache={},this._layers={},this._layerConfigs={},X&&this.replace(X)}replace(X,Y){this._layerConfigs={},this._layers={},this.update(X,[],Y)}update(X,Y,le){this._options=le;for(const ye of X)this._layerConfigs[ye.id]=ye,(this._layers[ye.id]=s.cv(ye,this.scope,null,this._options)).compileFilter(le),this.keyCache[ye.id]&&delete this.keyCache[ye.id];for(const ye of Y)delete this.keyCache[ye],delete this._layerConfigs[ye],delete this._layers[ye];this.familiesBySource={};const ge=function(ye,Se){const Ve={};for(let Ge=0;Ge<ye.length;Ge++){const We=ye[Ge];let qe=Se&&Se[We.id];!qe&&(qe=ae(We),We.type==="line"&&We.paint)&&function Mt(Rt){return typeof Rt=="string"&&Rt==="line-progress"||(Array.isArray(Rt)?Rt.some(Mt):!(!Rt||typeof Rt!="object")&&Object.values(Rt).some(Mt))}(We.paint["line-width"])&&(qe+=`/${de(We.paint["line-width"])}`),Se&&(Se[We.id]=qe);let lt=Ve[qe];lt||(lt=Ve[qe]=[]),lt.push(We)}const Ae=[];for(const Ge in Ve)Ae.push(Ve[Ge]);return Ae}(Object.values(this._layerConfigs),this.keyCache);for(const ye of ge){const Se=ye.map(lt=>this._layers[lt.id]),Ve=Se[0];if(Ve.visibility==="none")continue;const Ae=Ve.source||"";let Ge=this.familiesBySource[Ae];Ge||(Ge=this.familiesBySource[Ae]={});const We=Ve.sourceLayer||"_geojsonTileLayer";let qe=Ge[We];qe||(qe=Ge[We]=[]),qe.push(Se)}}}const Ne=1*s.d_;class Re{constructor(X){const Y={},le=[];for(const Ve in X){const Ae=X[Ve],Ge=Y[Ve]={};for(const We in Ae.glyphs){const qe=Ae.glyphs[+We];if(!qe||qe.bitmap.width===0||qe.bitmap.height===0)continue;const lt=qe.metrics.localGlyph?Ne:1,Mt={x:0,y:0,w:qe.bitmap.width+2*lt,h:qe.bitmap.height+2*lt};le.push(Mt),Ge[We]=Mt}}const{w:ge,h:ye}=s.H(le),Se=new s.dZ({width:ge||1,height:ye||1});for(const Ve in X){const Ae=X[Ve];for(const Ge in Ae.glyphs){const We=Ae.glyphs[+Ge];if(!We||We.bitmap.width===0||We.bitmap.height===0)continue;const qe=Y[Ve][Ge],lt=We.metrics.localGlyph?Ne:1;s.dZ.copy(We.bitmap,Se,{x:0,y:0},{x:qe.x+lt,y:qe.y+lt},We.bitmap)}}this.image=Se,this.positions=Y}}s.dY(Re,"GlyphAtlas");class Ze{constructor(X){this.tileID=new s.aH(X.tileID.overscaledZ,X.tileID.wrap,X.tileID.canonical.z,X.tileID.canonical.x,X.tileID.canonical.y),this.tileZoom=X.tileZoom,this.uid=X.uid,this.zoom=X.zoom,this.lut=X.lut,this.canonical=X.tileID.canonical,this.pixelRatio=X.pixelRatio,this.tileSize=X.tileSize,this.source=X.source,this.scope=X.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=X.showCollisionBoxes,this.collectResourceTiming=!!X.request&&X.request.collectResourceTiming,this.promoteId=X.promoteId,this.isSymbolTile=X.isSymbolTile,this.tileTransform=s.aR(X.tileID.canonical,X.projection),this.projection=X.projection,this.worldview=X.worldview,this.localizableLayerIds=X.localizableLayerIds,this.brightness=X.brightness,this.extraShadowCaster=!!X.extraShadowCaster,this.tessellationStep=X.tessellationStep,this.scaleFactor=X.scaleFactor}parse(X,Y,le,ge,ye){this.status="parsing",this.data=X,this.collisionBoxArray=new s.aX;const Se=new s.d$(Object.keys(X.layers).sort()),Ve=new s.e0(this.tileID,this.promoteId);Ve.bucketLayerIDs=[];const Ae={},Ge=new s.e1(256,256),We={featureIndex:Ve,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:Ge,availableImages:le,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},qe=Y.familiesBySource[this.source];for(const Mi in qe){const Qi=X.layers[Mi];if(!Qi)continue;let er=!1,rr=!1,Br=!1;for(const On of qe[Mi])On[0].type==="symbol"?er=!0:rr=!0,On[0].is3D()&&On[0].type!=="model"&&(Br=!0);if(this.extraShadowCaster&&!Br||this.isSymbolTile===!0&&!er||this.isSymbolTile===!1&&!rr)continue;Qi.version===1&&s.w(`Vector tile source "${this.source}" layer "${Mi}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const an=Se.encode(Mi),Mn=[];let ys=!1;for(let On=0,ln=0;On<Qi.length;On++){const hn=Qi.feature(On),Da=Ve.getId(hn,Mi);if(this.localizableLayerIds&&this.localizableLayerIds.has(Mi)){const vs=hn.properties?hn.properties.worldview:null;if(this.worldview&&typeof vs=="string")if(vs==="all")hn.properties.$localized=!0;else{if(!vs.split(",").includes(this.worldview))continue;hn.properties.$localized=!0,hn.properties.worldview=this.worldview}}!ys&&hn.properties&&hn.properties.hasOwnProperty(s.e2)&&(ys=!0),Mn.push({feature:hn,id:Da,index:ln,sourceLayerIndex:an}),ln++}ys&&!We.elevationFeatures&&X.layers.hasOwnProperty(s.e3)&&(We.elevationFeatures=s.e4.parseFrom(X.layers[s.e3],this.canonical));for(const On of qe[Mi]){const ln=On[0];(!this.extraShadowCaster||ln.is3D()&&ln.type!=="model")&&(this.isSymbolTile!==void 0&&ln.type==="symbol"!==this.isSymbolTile||ln.minzoom&&this.zoom<Math.floor(ln.minzoom)||ln.maxzoom&&this.zoom>=ln.maxzoom||ln.visibility!=="none"&&(et(On,this.zoom,We.brightness,le),(Ae[ln.id]=ln.createBucket({index:Ve.bucketLayerIDs.length,layers:On,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:an,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(Mn,We,this.tileID.canonical,this.tileTransform),Ve.bucketLayerIDs.push(On.map(hn=>s.C(hn.id,hn.scope)))))}}let lt,Mt,Rt,ai,fi,pi;Ge.trim();const vi={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},mr=()=>{if(lt)return this.status="done",ye(lt);if(this.extraShadowCaster)this.status="done",ye(null,{buckets:Object.values(Ae).filter(Mi=>!Mi.isEmpty()),featureIndex:Ve,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:We.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Mt&&Rt&&ai){const Mi=new Re(Mt),Qi=new Map;for(const[Br,an]of Rt.entries()){const{imagePosition:Mn}=s.e7(Br,an,s.e8);Qi.set(Br,Mn)}const er={};for(const Br in Ae){const an=Ae[Br];an instanceof s.aY&&(et(an.layers,this.zoom,We.brightness,le),er[Br]=s.e9(an,Mt,Mi.positions,Rt,Qi,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio))}const rr={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(ge,Rt,fi,()=>{rr.iconsPending=!1,Ar(er,Mi,rr)}),this.rasterizeIfNeeded(ge,ai,pi,()=>{rr.patternsPending=!1,Ar(er,Mi,rr)})}},Ar=(Mi,Qi,er,rr)=>{if(er.iconsPending||er.patternsPending)return;const Br=new s.ea(Rt,ai,this.lut);for(const an in Ae){const Mn=Ae[an];if(an in Mi)s.eb(Mn,Mi[an],this.showCollisionBoxes,le,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,Rt,Br);else if(Mn.hasPattern&&(Mn instanceof s.b2||Mn instanceof s.b3||Mn instanceof s.d8)){et(Mn.layers,this.zoom,We.brightness,le);const ys=Object.fromEntries(Br.patternPositions);Mn.addFeatures(We,this.tileID.canonical,ys,le,this.tileTransform,this.brightness)}}this.status="done",ye(null,{buckets:Object.values(Ae).filter(an=>!an.isEmpty()),featureIndex:Ve,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Qi.image,lineAtlas:Ge,imageAtlas:Br,brightness:We.brightness})};if(!this.extraShadowCaster){const Mi=s.e5(We.glyphDependencies,rr=>Object.keys(rr).map(Number));Object.keys(Mi).length?ge.send("getGlyphs",{uid:this.uid,stacks:Mi,scope:this.scope},(rr,Br)=>{lt||(lt=rr,Mt=Br,mr())},void 0,!1,vi):Mt={};const Qi=Array.from(We.iconDependencies.keys()).map(rr=>s.I.parse(rr));Qi.length?ge.send("getImages",{images:Qi,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(rr,Br)=>{lt||(lt=rr,Rt=new Map,fi=this.updateImageMapAndGetImageTaskQueue(Rt,Br,We.iconDependencies),mr())},void 0,!1,vi):(Rt=new Map,fi=new Map);const er=Array.from(We.patternDependencies.keys()).map(rr=>s.I.parse(rr));er.length?ge.send("getImages",{images:er,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(rr,Br)=>{lt||(lt=rr,ai=new Map,pi=this.updateImageMapAndGetImageTaskQueue(ai,Br,We.patternDependencies),mr())},void 0,!1,vi):(ai=new Map,pi=new Map)}if(We.elevationFeatures&&We.elevationFeatures.length>0){const Mi=[];for(const er of Object.values(Ae))if(er instanceof s.b3){const rr=er.getUnevaluatedPortalGraph();rr&&Mi.push(rr)}const Qi=s.e6.evaluate(Mi);for(const er of Object.values(Ae))er instanceof s.b3&&er.setEvaluatedPortalGraph(Qi)}mr()}rasterizeIfNeeded(X,Y,le,ge){Array.from(Y.values()).some(ye=>ye.usvg)?this.rasterize(X,Y,le,ge):ge()}updateImageMapAndGetImageTaskQueue(X,Y,le){const ge=new Map;for(const ye of Y.keys()){const Se=le.get(ye)||[];for(const Ve of Se){const Ae=Ve.toString(),Ge=Y.get(Ve.id.toString());Ge.usvg?ge.has(Ae)||(ge.set(Ae,Ve),X.set(Ae,Object.assign({},Ge))):X.set(Ae,Ge)}}return ge}rasterize(X,Y,le,ge){this.rasterizeTask=X.send("rasterizeImages",{scope:this.scope,tasks:le},(ye,Se)=>{if(!ye)for(const[Ve,Ae]of Se.entries()){const Ge=Object.assign(Y.get(Ve),{data:Ae});Y.set(Ve,Ge)}ge()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function et($e,X,Y,le){const ge=new s.aa(X,{brightness:Y});for(const ye of $e)ye.recalculate(ge,le)}class ft extends s.E{constructor(X,Y,le,ge,ye,Se){super(),this.actor=X,this.layerIndex=Y,this.availableImages=le,this.loadVectorData=ye||s.aE,this.loading={},this.loaded={},this.deduped=new s.aD(X.scheduler),this.isSpriteLoaded=ge,this.scheduler=X.scheduler,this.brightness=Se}loadTile(X,Y){const le=X.uid,ge=X&&X.request,ye=ge&&ge.collectResourceTiming,Se=this.loading[le]=new Ze(X);Se.abort=this.loadVectorData(X,(Ve,Ae)=>{const Ge=!this.loading[le];if(delete this.loading[le],Se.cancelRasterize(),Ge||Ve||!Ae)return Se.status="done",Ge||(this.loaded[le]=Se),Y(Ve);const We=Ae.rawData,qe={};Ae.expires&&(qe.expires=Ae.expires),Ae.cacheControl&&(qe.cacheControl=Ae.cacheControl),Se.vectorTile=Ae.vectorTile||new s.ec.VectorTile(new s.bi(We));const lt=()=>{Se.parse(Se.vectorTile,this.layerIndex,this.availableImages,this.actor,(Mt,Rt)=>{if(Mt||!Rt)return Y(Mt);const ai={};if(ye){const fi=Q(ge);fi.length>0&&(ai.resourceTiming=JSON.parse(JSON.stringify(fi)))}Y(null,s.l({rawTileData:We.slice(0)},Rt,qe,ai))})};this.isSpriteLoaded?lt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(lt,{type:"parseTile",isSymbolTile:X.isSymbolTile,zoom:X.tileZoom}):lt()}),this.loaded=this.loaded||{},this.loaded[le]=Se})}reloadTile(X,Y){const le=this.loaded,ge=X.uid;if(le&&le[ge]){const ye=le[ge];ye.scaleFactor=X.scaleFactor,ye.showCollisionBoxes=X.showCollisionBoxes,ye.projection=X.projection,ye.brightness=X.brightness,ye.tileTransform=s.aR(X.tileID.canonical,X.projection),ye.extraShadowCaster=X.extraShadowCaster,ye.lut=X.lut;const Se=(Ve,Ae)=>{const Ge=ye.reloadCallback;Ge&&(delete ye.reloadCallback,ye.parse(ye.vectorTile,this.layerIndex,this.availableImages,this.actor,Ge)),Y(Ve,Ae)};ye.status==="parsing"?ye.reloadCallback=Se:ye.status==="done"&&(ye.vectorTile?ye.parse(ye.vectorTile,this.layerIndex,this.availableImages,this.actor,Se):Se())}else Y(null,void 0)}abortTile(X,Y){const le=X.uid,ge=this.loading[le];ge&&(ge.abort&&ge.abort(),delete this.loading[le]),Y()}removeTile(X,Y){const le=this.loaded,ge=X.uid;le&&le[ge]&&delete le[ge],Y()}}class vt{loadTile(X,Y){const{uid:le,encoding:ge,rawImageData:ye,padding:Se}=X,Ve=ImageBitmap&&ye instanceof ImageBitmap?this.getImageData(ye,Se):ye;Y(null,new s.ed(le,Ve,ge,Se<1))}reloadTile(X,Y){Y(null,null)}abortTile(X,Y){Y()}removeTile(X,Y){Y()}getImageData(X,Y){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(X.width,X.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=X.width,this.offscreenCanvas.height=X.height,this.offscreenCanvasContext.drawImage(X,0,0,X.width,X.height);const le=this.offscreenCanvasContext.getImageData(-Y,-Y,X.width+2*Y,X.height+2*Y);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),le}}s.bh.setPbf(s.bi);class gt{constructor(X){this._mrt=new s.bh(X.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=X.uid,this.tileID=X.tileID,this.source=X.source}parse(X,Y){const le=this._mrt;this.status="parsing",this._entireBuffer=X;try{le.parseHeader(X),this._isHeaderLoaded=!0;const ge=[];for(const ye in le.layers){const Se=le.getLayer(ye),Ve=Se.getDataRange(Se.getBandList()),Ae=le.createDecodingTask(Ve),Ge=X.slice(Ve.firstByte,Ve.lastByte+1),We=s.bh.performDecoding(Ge,Ae).then(qe=>Ae.complete(null,qe)).catch(qe=>Ae.complete(qe,null));ge.push(We)}Promise.allSettled(ge).then(()=>Y(null,le))}catch(ge){Y(ge)}}}class Vt{constructor(X){this.actor=X,this.loading={},this.loaded={}}loadTile(X,Y){const le=X.uid,ge=X.request,ye=this.loading[le]=new gt(X),{cancel:Se}=s.bj(ge,(Ve,Ae,Ge,We)=>{const qe=!this.loading[le];if(delete this.loading[le],qe||Ve||!Ae)return ye.status="done",qe||(this.loaded[le]=ye),Y(Ve);ye.parse(Ae,(lt,Mt)=>{if(lt||!Mt)return Y(lt);Y(null,Mt,Ge,We)}),this.loaded[le]=ye});ye.abort=Se}reloadTile(X,Y){Y(null,void 0)}abortTile(X,Y){const le=X.uid,ge=this.loading[le];ge&&(ge.abort&&ge.abort(),delete this.loading[le]),Y()}removeTile(X,Y){const le=X.uid;this.loaded[le]&&delete this.loaded[le],Y()}decodeRasterArray({task:X,buffer:Y},le){s.bh.performDecoding(Y,X).then(ge=>le(null,ge)).catch(ge=>le(ge))}}const pt=s.ec.VectorTileFeature.prototype.toGeoJSON;class ui{constructor(X){this._feature=X,this.extent=s.ai,this.type=X.type,this.properties=X.tags,"id"in X&&!isNaN(X.id)&&(this.id=parseInt(X.id,10))}loadGeometry(){if(this._feature.type===1){const X=[];for(const Y of this._feature.geometry)X.push([new s.P(Y[0],Y[1])]);return X}{const X=[];for(const Y of this._feature.geometry){const le=[];for(const ge of Y)le.push(new s.P(ge[0],ge[1]));X.push(le)}return X}}toGeoJSON(X,Y,le){return pt.call(this,X,Y,le)}}class zi{constructor(X){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=s.ai,this.length=X.length,this._features=X}feature(X){return new ui(this._features[X])}}const Pt=64/4096,di=128;class jt{constructor(){this.features=new Map}clear(){this.features.clear()}load(X=[],Y){for(const le of X){const ge=le.id;if(ge==null)continue;let ye=this.features.get(ge);ye&&this.updateCache(ye,Y),le.geometry?(ye=zt(le),this.updateCache(ye,Y),this.features.set(ge,ye)):this.features.delete(ge),this.updateCache(ye,Y)}}updateCache(X,Y){for(const{canonical:le,uid:ge}of Object.values(Y)){const{z:ye,x:Se,y:Ve}=le;st(X,Math.pow(2,ye),Se,Ve)&&delete Y[ge]}}getTile(X,Y,le){const ge=Math.pow(2,X),ye=[];for(const Se of this.features.values())st(Se,ge,Y,le)&&ye.push(oi(Se,ge,Y,le));return{features:ye}}getFeatures(){return[...this.features.values()]}}function st({minX:$e,minY:X,maxX:Y,maxY:le},ge,ye,Se){return $e<(ye+1+Pt)/ge&&X<(Se+1+Pt)/ge&&Y>(ye-Pt)/ge&&le>(Se-Pt)/ge}function zt($e){const{id:X,geometry:Y,properties:le}=$e;if(!Y)return;if(Y.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:ge,coordinates:ye}=Y,Se={id:X,type:1,geometry:[],tags:le,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Ve=Se.geometry;if(ge==="Point")ji(ye,Ve,Se);else if(ge==="MultiPoint")for(const Ae of ye)ji(Ae,Ve,Se);else if(ge==="LineString")Se.type=2,Ci(ye,Ve,Se);else if(ge==="MultiLineString")Se.type=2,Fr(ye,Ve,Se);else if(ge==="Polygon")Se.type=3,Fr(ye,Ve,Se,!0);else{if(ge!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");Se.type=3;for(const Ae of ye)Fr(Ae,Ve,Se,!0)}return Se}function ji([$e,X],Y,le){const ge=s.av($e);let ye=s.aC(X);ye=ye<0?0:ye>1?1:ye,Y.push(ge,ye),le.minX=Math.min(le.minX,ge),le.minY=Math.min(le.minY,ye),le.maxX=Math.max(le.maxX,ge),le.maxY=Math.max(le.maxY,ye)}function Ci($e,X,Y,le=!1,ge=!1){const ye=[];for(const Se of $e)ji(Se,ye,Y);X.push(ye),le&&function(Se,Ve){let Ae=0;for(let Ge=0,We=Se.length,qe=We-2;Ge<We;qe=Ge,Ge+=2)Ae+=(Se[Ge]-Se[qe])*(Se[Ge+1]+Se[qe+1]);if(Ae>0===Ve)for(let Ge=0,We=Se.length;Ge<We/2;Ge+=2){const qe=Se[Ge],lt=Se[Ge+1];Se[Ge]=Se[We-2-Ge],Se[Ge+1]=Se[We-1-Ge],Se[We-2-Ge]=qe,Se[We-1-Ge]=lt}}(ye,ge)}function Fr($e,X,Y,le=!1){for(let ge=0;ge<$e.length;ge++)Ci($e[ge],X,Y,le,ge===0)}function oi($e,X,Y,le){const{id:ge,type:ye,geometry:Se,tags:Ve}=$e,Ae=[];if(ye===1)(function(Ge,We,qe,lt,Mt){for(let Rt=0;Rt<Ge.length;Rt+=2){const ai=Math.round(s.ai*(Ge[Rt+0]*We-qe)),fi=Math.round(s.ai*(Ge[Rt+1]*We-lt));Mt.push([ai,fi])}})(Se,X,Y,le,Ae);else for(const Ge of Se)Yi(Ge,X,Y,le,Ae);return{id:ge,type:ye,geometry:Ae,tags:Ve}}function Yi($e,X,Y,le,ge){const Se=s.ai+di;let Ve;for(let Ae=0;Ae<$e.length-2;Ae+=2){let Ge=Math.round(s.ai*($e[Ae+0]*X-Y)),We=Math.round(s.ai*($e[Ae+1]*X-le)),qe=Math.round(s.ai*($e[Ae+2]*X-Y)),lt=Math.round(s.ai*($e[Ae+3]*X-le));const Mt=qe-Ge,Rt=lt-We;Ge<-128&&qe<-128||(Ge<-128?(We+=Math.round(Rt*((-128-Ge)/Mt)),Ge=-128):qe<-128&&(lt=We+Math.round(Rt*((-128-Ge)/Mt)),qe=-128),We<-128&&lt<-128||(We<-128?(Ge+=Math.round(Mt*((-128-We)/Rt)),We=-128):lt<-128&&(qe=Ge+Math.round(Mt*((-128-We)/Rt)),lt=-128),Ge>=Se&&qe>=Se||(Ge>=Se?(We+=Math.round(Rt*((Se-Ge)/Mt)),Ge=Se):qe>=Se&&(lt=We+Math.round(Rt*((Se-Ge)/Mt)),qe=Se),We>=Se&&lt>=Se||(We>=Se?(Ge+=Math.round(Mt*((Se-We)/Rt)),We=Se):lt>=Se&&(qe=Ge+Math.round(Mt*((Se-We)/Rt)),lt=Se),Ve&&Ge===Ve[Ve.length-1][0]&&We===Ve[Ve.length-1][1]||(Ve=[[Ge,We]],ge.push(Ve)),Ve.push([qe,lt])))))}}var bi,nr,hi,Ti={exports:{}},Bt=function(){if(hi)return Ti.exports;hi=1;var $e=s.eg(),X=function(){if(nr)return bi;nr=1;var We=s.ee(),qe=s.ef().VectorTileFeature;function lt(Rt,ai){this.options=ai||{},this.features=Rt,this.length=Rt.length}function Mt(Rt,ai){this.id=typeof Rt.id=="number"?Rt.id:void 0,this.type=Rt.type,this.rawGeometry=Rt.type===1?[Rt.geometry]:Rt.geometry,this.properties=Rt.tags,this.extent=ai||4096}return bi=lt,lt.prototype.feature=function(Rt){return new Mt(this.features[Rt],this.options.extent)},Mt.prototype.loadGeometry=function(){var Rt=this.rawGeometry;this.geometry=[];for(var ai=0;ai<Rt.length;ai++){for(var fi=Rt[ai],pi=[],vi=0;vi<fi.length;vi++)pi.push(new We(fi[vi][0],fi[vi][1]));this.geometry.push(pi)}return this.geometry},Mt.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Rt=this.geometry,ai=1/0,fi=-1/0,pi=1/0,vi=-1/0,mr=0;mr<Rt.length;mr++)for(var Ar=Rt[mr],Mi=0;Mi<Ar.length;Mi++){var Qi=Ar[Mi];ai=Math.min(ai,Qi.x),fi=Math.max(fi,Qi.x),pi=Math.min(pi,Qi.y),vi=Math.max(vi,Qi.y)}return[ai,pi,fi,vi]},Mt.prototype.toGeoJSON=qe.prototype.toGeoJSON,bi}();function Y(We){var qe=new $e;return function(lt,Mt){for(var Rt in lt.layers)Mt.writeMessage(3,le,lt.layers[Rt])}(We,qe),qe.finish()}function le(We,qe){var lt;qe.writeVarintField(15,We.version||1),qe.writeStringField(1,We.name||""),qe.writeVarintField(5,We.extent||4096);var Mt={keys:[],values:[],keycache:{},valuecache:{}};for(lt=0;lt<We.length;lt++)Mt.feature=We.feature(lt),qe.writeMessage(2,ge,Mt);var Rt=Mt.keys;for(lt=0;lt<Rt.length;lt++)qe.writeStringField(3,Rt[lt]);var ai=Mt.values;for(lt=0;lt<ai.length;lt++)qe.writeMessage(4,Ge,ai[lt])}function ge(We,qe){var lt=We.feature;lt.id!==void 0&&qe.writeVarintField(1,lt.id),qe.writeMessage(2,ye,We),qe.writeVarintField(3,lt.type),qe.writeMessage(4,Ae,lt)}function ye(We,qe){var lt=We.feature,Mt=We.keys,Rt=We.values,ai=We.keycache,fi=We.valuecache;for(var pi in lt.properties){var vi=lt.properties[pi],mr=ai[pi];if(vi!==null){mr===void 0&&(Mt.push(pi),ai[pi]=mr=Mt.length-1),qe.writeVarint(mr);var Ar=typeof vi;Ar!=="string"&&Ar!=="boolean"&&Ar!=="number"&&(vi=JSON.stringify(vi));var Mi=Ar+":"+vi,Qi=fi[Mi];Qi===void 0&&(Rt.push(vi),fi[Mi]=Qi=Rt.length-1),qe.writeVarint(Qi)}}}function Se(We,qe){return(qe<<3)+(7&We)}function Ve(We){return We<<1^We>>31}function Ae(We,qe){for(var lt=We.loadGeometry(),Mt=We.type,Rt=0,ai=0,fi=lt.length,pi=0;pi<fi;pi++){var vi=lt[pi],mr=1;Mt===1&&(mr=vi.length),qe.writeVarint(Se(1,mr));for(var Ar=Mt===3?vi.length-1:vi.length,Mi=0;Mi<Ar;Mi++){Mi===1&&Mt!==1&&qe.writeVarint(Se(2,Ar-1));var Qi=vi[Mi].x-Rt,er=vi[Mi].y-ai;qe.writeVarint(Ve(Qi)),qe.writeVarint(Ve(er)),Rt+=Qi,ai+=er}Mt===3&&qe.writeVarint(Se(7,1))}}function Ge(We,qe){var lt=typeof We;lt==="string"?qe.writeStringField(1,We):lt==="boolean"?qe.writeBooleanField(7,We):lt==="number"&&(We%1!=0?qe.writeDoubleField(3,We):We<0?qe.writeSVarintField(6,We):qe.writeVarintField(5,We))}return Ti.exports=Y,Ti.exports.fromVectorTileJs=Y,Ti.exports.fromGeojsonVt=function(We,qe){qe=qe||{};var lt={};for(var Mt in We)lt[Mt]=new X(We[Mt].features,qe),lt[Mt].name=Mt,lt[Mt].version=qe.version,lt[Mt].extent=qe.extent;return Y({layers:lt})},Ti.exports.GeoJSONWrapper=X,Ti.exports}(),gi=s.eh(Bt);const Zt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:$e=>$e},qr=Math.fround||(yn=new Float32Array(1),$e=>(yn[0]=+$e,yn[0]));var yn;const fr=3,mt=5,Qt=6;class Kt{constructor(X){this.options=Object.assign(Object.create(Zt),X),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(X){const{log:Y,minZoom:le,maxZoom:ge}=this.options;Y&&console.time("total time");const ye=`prepare ${X.length} points`;Y&&console.time(ye),this.points=X;const Se=[];for(let Ae=0;Ae<X.length;Ae++){const Ge=X[Ae];if(!Ge.geometry)continue;const[We,qe]=Ge.geometry.coordinates,lt=qr(ze(We)),Mt=qr(Be(qe));Se.push(lt,Mt,1/0,Ae,-1,1),this.options.reduce&&Se.push(0)}let Ve=this.trees[ge+1]=this._createTree(Se);Y&&console.timeEnd(ye);for(let Ae=ge;Ae>=le;Ae--){const Ge=+Date.now();Ve=this.trees[Ae]=this._createTree(this._cluster(Ve,Ae)),Y&&console.log("z%d: %d clusters in %dms",Ae,Ve.numItems,+Date.now()-Ge)}return Y&&console.timeEnd("total time"),this}getClusters(X,Y){let le=((X[0]+180)%360+360)%360-180;const ge=Math.max(-90,Math.min(90,X[1]));let ye=X[2]===180?180:((X[2]+180)%360+360)%360-180;const Se=Math.max(-90,Math.min(90,X[3]));if(X[2]-X[0]>=360)le=-180,ye=180;else if(le>ye){const qe=this.getClusters([le,ge,180,Se],Y),lt=this.getClusters([-180,ge,ye,Se],Y);return qe.concat(lt)}const Ve=this.trees[this._limitZoom(Y)],Ae=Ve.range(ze(le),Be(Se),ze(ye),Be(ge)),Ge=Ve.data,We=[];for(const qe of Ae){const lt=this.stride*qe;We.push(Ge[lt+mt]>1?J(Ge,lt,this.clusterProps):this.points[Ge[lt+fr]])}return We}getChildren(X){const Y=this._getOriginId(X),le=this._getOriginZoom(X),ge="No cluster with the specified id.",ye=this.trees[le];if(!ye)throw new Error(ge);const Se=ye.data;if(Y*this.stride>=Se.length)throw new Error(ge);const Ve=this.options.radius/(this.options.extent*Math.pow(2,le-1)),Ae=ye.within(Se[Y*this.stride],Se[Y*this.stride+1],Ve),Ge=[];for(const We of Ae){const qe=We*this.stride;Se[qe+4]===X&&Ge.push(Se[qe+mt]>1?J(Se,qe,this.clusterProps):this.points[Se[qe+fr]])}if(Ge.length===0)throw new Error(ge);return Ge}getLeaves(X,Y,le){const ge=[];return this._appendLeaves(ge,X,Y=Y||10,le=le||0,0),ge}getTile(X,Y,le){const ge=this.trees[this._limitZoom(X)],ye=Math.pow(2,X),{extent:Se,radius:Ve}=this.options,Ae=Ve/Se,Ge=(le-Ae)/ye,We=(le+1+Ae)/ye,qe={features:[]};return this._addTileFeatures(ge.range((Y-Ae)/ye,Ge,(Y+1+Ae)/ye,We),ge.data,Y,le,ye,qe),Y===0&&this._addTileFeatures(ge.range(1-Ae/ye,Ge,1,We),ge.data,ye,le,ye,qe),Y===ye-1&&this._addTileFeatures(ge.range(0,Ge,Ae/ye,We),ge.data,-1,le,ye,qe),qe.features.length?qe:null}getClusterExpansionZoom(X){let Y=this._getOriginZoom(X)-1;for(;Y<=this.options.maxZoom;){const le=this.getChildren(X);if(Y++,le.length!==1)break;X=le[0].properties.cluster_id}return Y}_appendLeaves(X,Y,le,ge,ye){const Se=this.getChildren(Y);for(const Ve of Se){const Ae=Ve.properties;if(Ae&&Ae.cluster?ye+Ae.point_count<=ge?ye+=Ae.point_count:ye=this._appendLeaves(X,Ae.cluster_id,le,ge,ye):ye<ge?ye++:X.push(Ve),X.length===le)break}return ye}_createTree(X){const Y=new s.bE(X.length/this.stride|0,this.options.nodeSize,Float32Array);for(let le=0;le<X.length;le+=this.stride)Y.add(X[le],X[le+1]);return Y.finish(),Y.data=X,Y}_addTileFeatures(X,Y,le,ge,ye,Se){for(const Ve of X){const Ae=Ve*this.stride,Ge=Y[Ae+mt]>1;let We,qe,lt;if(Ge)We=pr(Y,Ae,this.clusterProps),qe=Y[Ae],lt=Y[Ae+1];else{const ai=this.points[Y[Ae+fr]];We=ai.properties;const[fi,pi]=ai.geometry.coordinates;qe=ze(fi),lt=Be(pi)}const Mt={type:1,geometry:[[Math.round(this.options.extent*(qe*ye-le)),Math.round(this.options.extent*(lt*ye-ge))]],tags:We};let Rt;Rt=Ge||this.options.generateId?Y[Ae+fr]:this.points[Y[Ae+fr]].id,Rt!==void 0&&(Mt.id=Rt),Se.features.push(Mt)}}_limitZoom(X){return Math.max(this.options.minZoom,Math.min(Math.floor(+X),this.options.maxZoom+1))}_cluster(X,Y){const{radius:le,extent:ge,reduce:ye,minPoints:Se}=this.options,Ve=le/(ge*Math.pow(2,Y)),Ae=X.data,Ge=[],We=this.stride;for(let qe=0;qe<Ae.length;qe+=We){if(Ae[qe+2]<=Y)continue;Ae[qe+2]=Y;const lt=Ae[qe],Mt=Ae[qe+1],Rt=X.within(Ae[qe],Ae[qe+1],Ve),ai=Ae[qe+mt];let fi=ai;for(const pi of Rt){const vi=pi*We;Ae[vi+2]>Y&&(fi+=Ae[vi+mt])}if(fi>ai&&fi>=Se){let pi,vi=lt*ai,mr=Mt*ai,Ar=-1;const Mi=(qe/We<<5)+(Y+1)+this.points.length;for(const Qi of Rt){const er=Qi*We;if(Ae[er+2]<=Y)continue;Ae[er+2]=Y;const rr=Ae[er+mt];vi+=Ae[er]*rr,mr+=Ae[er+1]*rr,Ae[er+4]=Mi,ye&&(pi||(pi=this._map(Ae,qe,!0),Ar=this.clusterProps.length,this.clusterProps.push(pi)),ye(pi,this._map(Ae,er)))}Ae[qe+4]=Mi,Ge.push(vi/fi,mr/fi,1/0,Mi,-1,fi),ye&&Ge.push(Ar)}else{for(let pi=0;pi<We;pi++)Ge.push(Ae[qe+pi]);if(fi>1)for(const pi of Rt){const vi=pi*We;if(!(Ae[vi+2]<=Y)){Ae[vi+2]=Y;for(let mr=0;mr<We;mr++)Ge.push(Ae[vi+mr])}}}}return Ge}_getOriginId(X){return X-this.points.length>>5}_getOriginZoom(X){return(X-this.points.length)%32}_map(X,Y,le){if(X[Y+mt]>1){const Se=this.clusterProps[X[Y+Qt]];return le?Object.assign({},Se):Se}const ge=this.points[X[Y+fr]].properties,ye=this.options.map(ge);return le&&ye===ge?Object.assign({},ye):ye}}function J($e,X,Y){return{type:"Feature",id:$e[X+fr],properties:pr($e,X,Y),geometry:{type:"Point",coordinates:[(le=$e[X],360*(le-.5)),we($e[X+1])]}};var le}function pr($e,X,Y){const le=$e[X+mt],ge=le>=1e4?`${Math.round(le/1e3)}k`:le>=1e3?Math.round(le/100)/10+"k":le,ye=$e[X+Qt],Se=ye===-1?{}:Object.assign({},Y[ye]);return Object.assign(Se,{cluster:!0,cluster_id:$e[X+fr],point_count:le,point_count_abbreviated:ge})}function ze($e){return $e/360+.5}function Be($e){const X=Math.sin($e*Math.PI/180),Y=.5-.25*Math.log((1+X)/(1-X))/Math.PI;return Y<0?0:Y>1?1:Y}function we($e){const X=(180-360*$e)*Math.PI/180;return 360*Math.atan(Math.exp(X))/Math.PI-90}function bt($e,X,Y,le){let ge=le;const ye=X+(Y-X>>1);let Se,Ve=Y-X;const Ae=$e[X],Ge=$e[X+1],We=$e[Y],qe=$e[Y+1];for(let lt=X+3;lt<Y;lt+=3){const Mt=Tt($e[lt],$e[lt+1],Ae,Ge,We,qe);if(Mt>ge)Se=lt,ge=Mt;else if(Mt===ge){const Rt=Math.abs(lt-ye);Rt<Ve&&(Se=lt,Ve=Rt)}}ge>le&&(Se-X>3&&bt($e,X,Se,le),$e[Se+2]=ge,Y-Se>3&&bt($e,Se,Y,le))}function Tt($e,X,Y,le,ge,ye){let Se=ge-Y,Ve=ye-le;if(Se!==0||Ve!==0){const Ae=(($e-Y)*Se+(X-le)*Ve)/(Se*Se+Ve*Ve);Ae>1?(Y=ge,le=ye):Ae>0&&(Y+=Se*Ae,le+=Ve*Ae)}return Se=$e-Y,Ve=X-le,Se*Se+Ve*Ve}function St($e,X,Y,le){const ge={id:$e??null,type:X,geometry:Y,tags:le,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(X==="Point"||X==="MultiPoint"||X==="LineString")xt(ge,Y);else if(X==="Polygon")xt(ge,Y[0]);else if(X==="MultiLineString")for(const ye of Y)xt(ge,ye);else if(X==="MultiPolygon")for(const ye of Y)xt(ge,ye[0]);return ge}function xt($e,X){for(let Y=0;Y<X.length;Y+=3)$e.minX=Math.min($e.minX,X[Y]),$e.minY=Math.min($e.minY,X[Y+1]),$e.maxX=Math.max($e.maxX,X[Y]),$e.maxY=Math.max($e.maxY,X[Y+1])}function Ut($e,X,Y,le){if(!X.geometry)return;const ge=X.geometry.coordinates;if(ge&&ge.length===0)return;const ye=X.geometry.type,Se=Math.pow(Y.tolerance/((1<<Y.maxZoom)*Y.extent),2);let Ve=[],Ae=X.id;if(Y.promoteId?Ae=X.properties[Y.promoteId]:Y.generateId&&(Ae=le||0),ye==="Point")Gt(ge,Ve);else if(ye==="MultiPoint")for(const Ge of ge)Gt(Ge,Ve);else if(ye==="LineString")Nt(ge,Ve,Se,!1);else if(ye==="MultiLineString"){if(Y.lineMetrics){for(const Ge of ge)Ve=[],Nt(Ge,Ve,Se,!1),$e.push(St(Ae,"LineString",Ve,X.properties));return}xi(ge,Ve,Se,!1)}else if(ye==="Polygon")xi(ge,Ve,Se,!0);else{if(ye!=="MultiPolygon"){if(ye==="GeometryCollection"){for(const Ge of X.geometry.geometries)Ut($e,{id:Ae,geometry:Ge,properties:X.properties},Y,le);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Ge of ge){const We=[];xi(Ge,We,Se,!0),Ve.push(We)}}$e.push(St(Ae,ye,Ve,X.properties))}function Gt($e,X){X.push(Jt($e[0]),Dt($e[1]),0)}function Nt($e,X,Y,le){let ge,ye,Se=0;for(let Ae=0;Ae<$e.length;Ae++){const Ge=Jt($e[Ae][0]),We=Dt($e[Ae][1]);X.push(Ge,We,0),Ae>0&&(Se+=le?(ge*We-Ge*ye)/2:Math.sqrt(Math.pow(Ge-ge,2)+Math.pow(We-ye,2))),ge=Ge,ye=We}const Ve=X.length-3;X[2]=1,bt(X,0,Ve,Y),X[Ve+2]=1,X.size=Math.abs(Se),X.start=0,X.end=X.size}function xi($e,X,Y,le){for(let ge=0;ge<$e.length;ge++){const ye=[];Nt($e[ge],ye,Y,le),X.push(ye)}}function Jt($e){return $e/360+.5}function Dt($e){const X=Math.sin($e*Math.PI/180),Y=.5-.25*Math.log((1+X)/(1-X))/Math.PI;return Y<0?0:Y>1?1:Y}function yi($e,X,Y,le,ge,ye,Se,Ve){if(le/=X,ye>=(Y/=X)&&Se<le)return $e;if(Se<Y||ye>=le)return null;const Ae=[];for(const Ge of $e){const We=Ge.geometry;let qe=Ge.type;const lt=ge===0?Ge.minX:Ge.minY,Mt=ge===0?Ge.maxX:Ge.maxY;if(lt>=Y&&Mt<le){Ae.push(Ge);continue}if(Mt<Y||lt>=le)continue;let Rt=[];if(qe==="Point"||qe==="MultiPoint")Ji(We,Rt,Y,le,ge);else if(qe==="LineString")gr(We,Rt,Y,le,ge,!1,Ve.lineMetrics);else if(qe==="MultiLineString")Kr(We,Rt,Y,le,ge,!1);else if(qe==="Polygon")Kr(We,Rt,Y,le,ge,!0);else if(qe==="MultiPolygon")for(const ai of We){const fi=[];Kr(ai,fi,Y,le,ge,!0),fi.length&&Rt.push(fi)}if(Rt.length){if(Ve.lineMetrics&&qe==="LineString"){for(const ai of Rt)Ae.push(St(Ge.id,qe,ai,Ge.tags));continue}qe!=="LineString"&&qe!=="MultiLineString"||(Rt.length===1?(qe="LineString",Rt=Rt[0]):qe="MultiLineString"),qe!=="Point"&&qe!=="MultiPoint"||(qe=Rt.length===3?"Point":"MultiPoint"),Ae.push(St(Ge.id,qe,Rt,Ge.tags))}}return Ae.length?Ae:null}function Ji($e,X,Y,le,ge){for(let ye=0;ye<$e.length;ye+=3){const Se=$e[ye+ge];Se>=Y&&Se<=le&&Vr(X,$e[ye],$e[ye+1],$e[ye+2])}}function gr($e,X,Y,le,ge,ye,Se){let Ve=Gi($e);const Ae=ge===0?zn:Ln;let Ge,We,qe=$e.start;for(let fi=0;fi<$e.length-3;fi+=3){const pi=$e[fi],vi=$e[fi+1],mr=$e[fi+2],Ar=$e[fi+3],Mi=$e[fi+4],Qi=ge===0?pi:vi,er=ge===0?Ar:Mi;let rr=!1;Se&&(Ge=Math.sqrt(Math.pow(pi-Ar,2)+Math.pow(vi-Mi,2))),Qi<Y?er>Y&&(We=Ae(Ve,pi,vi,Ar,Mi,Y),Se&&(Ve.start=qe+Ge*We)):Qi>le?er<le&&(We=Ae(Ve,pi,vi,Ar,Mi,le),Se&&(Ve.start=qe+Ge*We)):Vr(Ve,pi,vi,mr),er<Y&&Qi>=Y&&(We=Ae(Ve,pi,vi,Ar,Mi,Y),rr=!0),er>le&&Qi<=le&&(We=Ae(Ve,pi,vi,Ar,Mi,le),rr=!0),!ye&&rr&&(Se&&(Ve.end=qe+Ge*We),X.push(Ve),Ve=Gi($e)),Se&&(qe+=Ge)}let lt=$e.length-3;const Mt=$e[lt],Rt=$e[lt+1],ai=ge===0?Mt:Rt;ai>=Y&&ai<=le&&Vr(Ve,Mt,Rt,$e[lt+2]),lt=Ve.length-3,ye&&lt>=3&&(Ve[lt]!==Ve[0]||Ve[lt+1]!==Ve[1])&&Vr(Ve,Ve[0],Ve[1],Ve[2]),Ve.length&&X.push(Ve)}function Gi($e){const X=[];return X.size=$e.size,X.start=$e.start,X.end=$e.end,X}function Kr($e,X,Y,le,ge,ye){for(const Se of $e)gr(Se,X,Y,le,ge,ye,!1)}function Vr($e,X,Y,le){$e.push(X,Y,le)}function zn($e,X,Y,le,ge,ye){const Se=(ye-X)/(le-X);return Vr($e,ye,Y+(ge-Y)*Se,1),Se}function Ln($e,X,Y,le,ge,ye){const Se=(ye-Y)/(ge-Y);return Vr($e,X+(le-X)*Se,ye,1),Se}function ns($e,X){const Y=[];for(let le=0;le<$e.length;le++){const ge=$e[le],ye=ge.type;let Se;if(ye==="Point"||ye==="MultiPoint"||ye==="LineString")Se=Hs(ge.geometry,X);else if(ye==="MultiLineString"||ye==="Polygon"){Se=[];for(const Ve of ge.geometry)Se.push(Hs(Ve,X))}else if(ye==="MultiPolygon"){Se=[];for(const Ve of ge.geometry){const Ae=[];for(const Ge of Ve)Ae.push(Hs(Ge,X));Se.push(Ae)}}Y.push(St(ge.id,ye,Se,ge.tags))}return Y}function Hs($e,X){const Y=[];Y.size=$e.size,$e.start!==void 0&&(Y.start=$e.start,Y.end=$e.end);for(let le=0;le<$e.length;le+=3)Y.push($e[le]+X,$e[le+1],$e[le+2]);return Y}function Or($e,X){if($e.transformed)return $e;const Y=1<<$e.z,le=$e.x,ge=$e.y;for(const ye of $e.features){const Se=ye.geometry,Ve=ye.type;if(ye.geometry=[],Ve===1)for(let Ae=0;Ae<Se.length;Ae+=2)ye.geometry.push(En(Se[Ae],Se[Ae+1],X,Y,le,ge));else for(let Ae=0;Ae<Se.length;Ae++){const Ge=[];for(let We=0;We<Se[Ae].length;We+=2)Ge.push(En(Se[Ae][We],Se[Ae][We+1],X,Y,le,ge));ye.geometry.push(Ge)}}return $e.transformed=!0,$e}function En($e,X,Y,le,ge,ye){return[Math.round(Y*($e*le-ge)),Math.round(Y*(X*le-ye))]}function br($e,X,Y,le,ge){const ye=X===ge.maxZoom?0:ge.tolerance/((1<<X)*ge.extent),Se={features:[],numPoints:0,numSimplified:0,numFeatures:$e.length,source:null,x:Y,y:le,z:X,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Ve of $e)ar(Se,Ve,ye,ge);return Se}function ar($e,X,Y,le){const ge=X.geometry,ye=X.type,Se=[];if($e.minX=Math.min($e.minX,X.minX),$e.minY=Math.min($e.minY,X.minY),$e.maxX=Math.max($e.maxX,X.maxX),$e.maxY=Math.max($e.maxY,X.maxY),ye==="Point"||ye==="MultiPoint")for(let Ve=0;Ve<ge.length;Ve+=3)Se.push(ge[Ve],ge[Ve+1]),$e.numPoints++,$e.numSimplified++;else if(ye==="LineString")Bl(Se,ge,$e,Y,!1,!1);else if(ye==="MultiLineString"||ye==="Polygon")for(let Ve=0;Ve<ge.length;Ve++)Bl(Se,ge[Ve],$e,Y,ye==="Polygon",Ve===0);else if(ye==="MultiPolygon")for(let Ve=0;Ve<ge.length;Ve++){const Ae=ge[Ve];for(let Ge=0;Ge<Ae.length;Ge++)Bl(Se,Ae[Ge],$e,Y,!0,Ge===0)}if(Se.length){let Ve=X.tags||null;if(ye==="LineString"&&le.lineMetrics){Ve={};for(const Ge in X.tags)Ve[Ge]=X.tags[Ge];Ve.mapbox_clip_start=ge.start/ge.size,Ve.mapbox_clip_end=ge.end/ge.size}const Ae={geometry:Se,type:ye==="Polygon"||ye==="MultiPolygon"?3:ye==="LineString"||ye==="MultiLineString"?2:1,tags:Ve};X.id!==null&&(Ae.id=X.id),$e.features.push(Ae)}}function Bl($e,X,Y,le,ge,ye){const Se=le*le;if(le>0&&X.size<(ge?Se:le))return void(Y.numPoints+=X.length/3);const Ve=[];for(let Ae=0;Ae<X.length;Ae+=3)(le===0||X[Ae+2]>Se)&&(Y.numSimplified++,Ve.push(X[Ae],X[Ae+1])),Y.numPoints++;ge&&function(Ae,Ge){let We=0;for(let qe=0,lt=Ae.length,Mt=lt-2;qe<lt;Mt=qe,qe+=2)We+=(Ae[qe]-Ae[Mt])*(Ae[qe+1]+Ae[Mt+1]);if(We>0===Ge)for(let qe=0,lt=Ae.length;qe<lt/2;qe+=2){const Mt=Ae[qe],Rt=Ae[qe+1];Ae[qe]=Ae[lt-2-qe],Ae[qe+1]=Ae[lt-1-qe],Ae[lt-2-qe]=Mt,Ae[lt-1-qe]=Rt}}(Ve,ye),$e.push(Ve)}const Pa={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Nn{constructor(X,Y){const le=(Y=this.options=function(ye,Se){for(const Ve in Se)ye[Ve]=Se[Ve];return ye}(Object.create(Pa),Y)).debug;if(le&&console.time("preprocess data"),Y.maxZoom<0||Y.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Y.promoteId&&Y.generateId)throw new Error("promoteId and generateId cannot be used together.");let ge=function(ye,Se){const Ve=[];if(ye.type==="FeatureCollection")for(let Ae=0;Ae<ye.features.length;Ae++)Ut(Ve,ye.features[Ae],Se,Ae);else Ut(Ve,ye.type==="Feature"?ye:{geometry:ye},Se);return Ve}(X,Y);this.tiles={},this.tileCoords=[],le&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Y.indexMaxZoom,Y.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ge=function(ye,Se){const Ve=Se.buffer/Se.extent;let Ae=ye;const Ge=yi(ye,1,-1-Ve,Ve,0,-1,2,Se),We=yi(ye,1,1-Ve,2+Ve,0,-1,2,Se);return(Ge||We)&&(Ae=yi(ye,1,-Ve,1+Ve,0,-1,2,Se)||[],Ge&&(Ae=ns(Ge,1).concat(Ae)),We&&(Ae=Ae.concat(ns(We,-1)))),Ae}(ge,Y),ge.length&&this.splitTile(ge,0,0,0),le&&(ge.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(X,Y,le,ge,ye,Se,Ve){const Ae=[X,Y,le,ge],Ge=this.options,We=Ge.debug;for(;Ae.length;){ge=Ae.pop(),le=Ae.pop(),Y=Ae.pop(),X=Ae.pop();const qe=1<<Y,lt=sa(Y,le,ge);let Mt=this.tiles[lt];if(!Mt&&(We>1&&console.time("creation"),Mt=this.tiles[lt]=br(X,Y,le,ge,Ge),this.tileCoords.push({z:Y,x:le,y:ge}),We)){We>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Y,le,ge,Mt.numFeatures,Mt.numPoints,Mt.numSimplified),console.timeEnd("creation"));const rr=`z${Y}`;this.stats[rr]=(this.stats[rr]||0)+1,this.total++}if(Mt.source=X,ye==null){if(Y===Ge.indexMaxZoom||Mt.numPoints<=Ge.indexMaxPoints)continue}else{if(Y===Ge.maxZoom||Y===ye)continue;if(ye!=null){const rr=ye-Y;if(le!==Se>>rr||ge!==Ve>>rr)continue}}if(Mt.source=null,X.length===0)continue;We>1&&console.time("clipping");const Rt=.5*Ge.buffer/Ge.extent,ai=.5-Rt,fi=.5+Rt,pi=1+Rt;let vi=null,mr=null,Ar=null,Mi=null,Qi=yi(X,qe,le-Rt,le+fi,0,Mt.minX,Mt.maxX,Ge),er=yi(X,qe,le+ai,le+pi,0,Mt.minX,Mt.maxX,Ge);X=null,Qi&&(vi=yi(Qi,qe,ge-Rt,ge+fi,1,Mt.minY,Mt.maxY,Ge),mr=yi(Qi,qe,ge+ai,ge+pi,1,Mt.minY,Mt.maxY,Ge),Qi=null),er&&(Ar=yi(er,qe,ge-Rt,ge+fi,1,Mt.minY,Mt.maxY,Ge),Mi=yi(er,qe,ge+ai,ge+pi,1,Mt.minY,Mt.maxY,Ge),er=null),We>1&&console.timeEnd("clipping"),Ae.push(vi||[],Y+1,2*le,2*ge),Ae.push(mr||[],Y+1,2*le,2*ge+1),Ae.push(Ar||[],Y+1,2*le+1,2*ge),Ae.push(Mi||[],Y+1,2*le+1,2*ge+1)}}getTile(X,Y,le){X=+X,Y=+Y,le=+le;const ge=this.options,{extent:ye,debug:Se}=ge;if(X<0||X>24)return null;const Ve=1<<X,Ae=sa(X,Y=Y+Ve&Ve-1,le);if(this.tiles[Ae])return Or(this.tiles[Ae],ye);Se>1&&console.log("drilling down to z%d-%d-%d",X,Y,le);let Ge,We=X,qe=Y,lt=le;for(;!Ge&&We>0;)We--,qe>>=1,lt>>=1,Ge=this.tiles[sa(We,qe,lt)];return Ge&&Ge.source?(Se>1&&(console.log("found parent tile z%d-%d-%d",We,qe,lt),console.time("drilling down")),this.splitTile(Ge.source,We,qe,lt,X,Y,le),Se>1&&console.timeEnd("drilling down"),this.tiles[Ae]?Or(this.tiles[Ae],ye):null):null}}function sa($e,X,Y){return 32*((1<<$e)*Y+X)+$e}function Nl($e,X){const Y=$e.tileID.canonical;if(!this._geoJSONIndex)return void X(null,null);const le=this._geoJSONIndex.getTile(Y.z,Y.x,Y.y);if(!le)return void X(null,null);const ge=new zi(le.features);let ye=gi(ge);ye.byteOffset===0&&ye.byteLength===ye.buffer.byteLength||(ye=new Uint8Array(ye)),X(null,{vectorTile:ge,rawData:ye.buffer})}class Ra extends ft{constructor(X,Y,le,ge,ye,Se){super(X,Y,le,ge,Nl,Se),ye&&(this.loadGeoJSON=ye),this._dynamicIndex=new jt}loadData(X,Y){const le=X&&X.request,ge=le&&le.collectResourceTiming;this.loadGeoJSON(X,(ye,Se)=>{if(ye||!Se)return Y(ye);if(typeof Se!="object")return Y(new Error(`Input data given to '${X.source}' is not a valid GeoJSON object.`));{try{if(X.filter){const Ae=s.X(X.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Ae.result==="error")throw new Error(Ae.value.map(Ge=>`${Ge.key}: ${Ge.message}`).join(", "));Se.features=Se.features.filter(Ge=>Ae.value.evaluate({zoom:0},Ge))}X.dynamic?(Se.type==="Feature"&&(Se={type:"FeatureCollection",features:[Se]}),X.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(Se.features,this.loaded),X.cluster&&(Se.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=X.cluster?new Kt(function({superclusterOptions:Ae,clusterProperties:Ge}){if(!Ge||!Ae)return Ae;const We={},qe={},lt={accumulated:null,zoom:0},Mt={properties:null},Rt=Object.keys(Ge);for(const ai of Rt){const[fi,pi]=Ge[ai],vi=s.X(pi),mr=s.X(typeof fi=="string"?[fi,["accumulated"],["get",ai]]:fi);We[ai]=vi.value,qe[ai]=mr.value}return Ae.map=ai=>{Mt.properties=ai;const fi={};for(const pi of Rt)fi[pi]=We[pi].evaluate(lt,Mt);return fi},Ae.reduce=(ai,fi)=>{Mt.properties=fi;for(const pi of Rt)lt.accumulated=ai[pi],ai[pi]=qe[pi].evaluate(lt,Mt)},Ae}(X)).load(Se.features):X.dynamic?this._dynamicIndex:function(Ae,Ge){return new Nn(Ae,Ge)}(Se,X.geojsonVtOptions)}catch(Ae){return Y(Ae)}const Ve={};if(ge){const Ae=Q(le);Ae&&(Ve.resourceTiming={},Ve.resourceTiming[X.source]=JSON.parse(JSON.stringify(Ae)))}Y(null,Ve)}})}reloadTile(X,Y){const le=this.loaded;return le&&le[X.uid]?X.partial?Y(null,void 0):super.reloadTile(X,Y):this.loadTile(X,Y)}loadGeoJSON(X,Y){if(X.request)s.n(X.request,Y);else{if(typeof X.data!="string")return Y(new Error(`Input data given to '${X.source}' is not a valid GeoJSON object.`));try{return Y(null,JSON.parse(X.data))}catch{return Y(new Error(`Input data given to '${X.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(X,Y){try{Y(null,this._geoJSONIndex.getClusterExpansionZoom(X.clusterId))}catch(le){Y(le)}}getClusterChildren(X,Y){try{Y(null,this._geoJSONIndex.getChildren(X.clusterId))}catch(le){Y(le)}}getClusterLeaves(X,Y){try{Y(null,this._geoJSONIndex.getLeaves(X.clusterId,X.limit,X.offset))}catch(le){Y(le)}}}class Hc{constructor(X,Y){this.tileID=new s.aH(X.tileID.overscaledZ,X.tileID.wrap,X.tileID.canonical.z,X.tileID.canonical.x,X.tileID.canonical.y),this.tileZoom=X.tileZoom,this.uid=X.uid,this.zoom=X.zoom,this.canonical=X.tileID.canonical,this.pixelRatio=X.pixelRatio,this.tileSize=X.tileSize,this.source=X.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=X.projection,this.brightness=Y}parse(X,Y,le,ge){this.status="parsing";const ye=new s.aH(le.tileID.overscaledZ,le.tileID.wrap,le.tileID.canonical.z,le.tileID.canonical.x,le.tileID.canonical.y),Se=[],Ve=Y.familiesBySource[le.source],Ae=new s.e0(ye,le.promoteId);return Ae.bucketLayerIDs=[],Ae.is3DTile=!0,s.ei(X).then(Ge=>{if(!Ge)return ge(new Error("Could not parse tile"));const We=s.ej(Ge,1/s.cd(le.tileID.canonical)),qe=Ge.json.extensionsUsed&&Ge.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ge.json.asset.extras&&Ge.json.asset.extras.MAPBOX_mesh_features,lt=Ge.json.extensionsUsed&&Ge.json.extensionsUsed.includes("EXT_meshopt_compression"),Mt=new s.aa(this.zoom,{brightness:this.brightness});for(const Rt in Ve)for(const ai of Ve[Rt]){const fi=ai[0];Ae.bucketLayerIDs.push(ai.map(vi=>s.C(vi.id,vi.scope))),fi.recalculate(Mt,[]);const pi=new s.ek(ai,We,ye,qe,lt,this.brightness,Ae);qe||(pi.needsUpload=!0),Se.push(pi),pi.evaluate(fi)}this.status="done",ge(null,{buckets:Se,featureIndex:Ae,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Ge=>ge(new Error(Ge.message)))}}class Zc{constructor(X,Y,le,ge,ye,Se){this.actor=X,this.layerIndex=Y,this.availableImages=le,this.brightness=Se,this.loading={},this.loaded={}}loadTile(X,Y){const le=X.uid,ge=this.loading[le]=new Hc(X,this.brightness);s.bj(X.request,(ye,Se)=>{const Ve=!this.loading[le];return delete this.loading[le],Ve||ye?(ge.status="done",Ve||(this.loaded[le]=ge),Y(ye)):Se&&Se.byteLength!==0?void ge.parse(Se,this.layerIndex,X,(Ae,Ge)=>{ge.status="done",this.loaded=this.loaded||{},this.loaded[le]=ge,Ae||!Ge?Y(Ae):Y(null,Ge)}):(ge.status="done",this.loaded[le]=ge,Y())})}reloadTile(X,Y){const le=this.loaded,ge=X.uid;if(le&&le[ge]){const ye=le[ge];ye.projection=X.projection,ye.brightness=X.brightness;const Se=(Ve,Ae)=>{ye.reloadCallback&&(delete ye.reloadCallback,this.loadTile(X,Y)),Y(Ve,Ae)};ye.status==="parsing"?ye.reloadCallback=Se:ye.status==="done"&&this.loadTile(X,Y)}}abortTile(X,Y){const le=X.uid;this.loading[le]&&delete this.loading[le],Y()}removeTile(X,Y){const le=this.loaded,ge=X.uid;le&&le[ge]&&delete le[ge],Y()}}class Vl{constructor(X){this.self=X,this.actor=new s.el(X,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.imageRasterizer=new s.y,this.projections={},this.defaultProjection=s.bP({name:"mercator"}),this.workerSourceTypes={vector:ft,geojson:Ra,"raster-dem":vt,"raster-array":Vt,"batched-model":Zc},this.workerSources={},this.self.registerWorkerSource=(Y,le)=>{if(this.workerSourceTypes[Y])throw new Error(`Worker source with name "${Y}" already registered.`);this.workerSourceTypes[Y]=le},this.self.registerRTLTextPlugin=Y=>{if(s.em.isParsed())throw new Error("RTL text plugin already registered.");s.em.applyArabicShaping=Y.applyArabicShaping,s.em.processBidirectionalText=Y.processBidirectionalText,s.em.processStyledBidirectionalText=Y.processStyledBidirectionalText}}clearCaches(X,Y,le){delete this.layerIndexes[X],delete this.availableImages[X],delete this.workerSources[X],le()}checkIfReady(X,Y,le){le()}setReferrer(X,Y){this.referrer=Y}spriteLoaded(X,{scope:Y,isLoaded:le}){if(this.isSpriteLoaded[X]||(this.isSpriteLoaded[X]={}),this.isSpriteLoaded[X][Y]=le,this.workerSources[X]&&this.workerSources[X][Y])for(const ge in this.workerSources[X][Y]){const ye=this.workerSources[X][Y][ge];for(const Se in ye){const Ve=ye[Se];Ve instanceof ft&&(Ve.isSpriteLoaded=le,Ve.fire(new s.A("isSpriteLoaded")))}}}setImages(X,{scope:Y,images:le},ge){if(this.availableImages[X]||(this.availableImages[X]={}),this.availableImages[X][Y]=le,this.workerSources[X]&&this.workerSources[X][Y]){for(const ye in this.workerSources[X][Y]){const Se=this.workerSources[X][Y][ye];for(const Ve in Se)Se[Ve].availableImages=le}ge()}else ge()}setProjection(X,Y){this.projections[X]=s.bP(Y)}setBrightness(X,Y,le){this.brightness=Y,le()}setLayers(X,Y,le){this.getLayerIndex(X,Y.scope).replace(Y.layers,Y.options),le()}updateLayers(X,Y,le){this.getLayerIndex(X,Y.scope).update(Y.layers,Y.removedIds,Y.options),le()}loadTile(X,Y,le){Y.projection=this.projections[X]||this.defaultProjection,this.getWorkerSource(X,Y.type,Y.source,Y.scope).loadTile(Y,le)}decodeRasterArray(X,Y,le){this.getWorkerSource(X,Y.type,Y.source,Y.scope).decodeRasterArray(Y,le)}reloadTile(X,Y,le){Y.projection=this.projections[X]||this.defaultProjection,this.getWorkerSource(X,Y.type,Y.source,Y.scope).reloadTile(Y,le)}abortTile(X,Y,le){this.getWorkerSource(X,Y.type,Y.source,Y.scope).abortTile(Y,le)}removeTile(X,Y,le){this.getWorkerSource(X,Y.type,Y.source,Y.scope).removeTile(Y,le)}removeSource(X,Y,le){if(!(this.workerSources[X]&&this.workerSources[X][Y.scope]&&this.workerSources[X][Y.scope][Y.type]&&this.workerSources[X][Y.scope][Y.type][Y.source]))return;const ge=this.workerSources[X][Y.scope][Y.type][Y.source];delete this.workerSources[X][Y.scope][Y.type][Y.source],ge.removeSource!==void 0?ge.removeSource(Y,le):le()}loadWorkerSource(X,Y,le){try{this.self.importScripts(Y.url),le()}catch(ge){le(ge.toString())}}syncRTLPluginState(X,Y,le){try{s.em.setState(Y);const ge=s.em.getPluginURL();if(s.em.isLoaded()&&!s.em.isParsed()&&ge!=null){this.self.importScripts(ge);const ye=s.em.isParsed();le(ye?void 0:new Error(`RTL Text Plugin failed to import scripts from ${ge}`),ye)}}catch(ge){le(ge.toString())}}setDracoUrl(X,Y){this.dracoUrl=Y}getAvailableImages(X,Y){this.availableImages[X]||(this.availableImages[X]={});let le=this.availableImages[X][Y];return le||(le=[]),le}getLayerIndex(X,Y){this.layerIndexes[X]||(this.layerIndexes[X]={});let le=this.layerIndexes[X][Y];return le||(le=this.layerIndexes[X][Y]=new Te,le.scope=Y),le}getWorkerSource(X,Y,le,ge){const ye=this.workerSources;return ye[X]||(ye[X]={}),ye[X][ge]||(ye[X][ge]={}),ye[X][ge][Y]||(ye[X][ge][Y]={}),this.isSpriteLoaded[X]||(this.isSpriteLoaded[X]={}),ye[X][ge][Y][le]||(ye[X][ge][Y][le]=new this.workerSourceTypes[Y]({send:(Se,Ve,Ae,Ge,We,qe)=>{this.actor.send(Se,Ve,Ae,X,We,qe)},scheduler:this.actor.scheduler},this.getLayerIndex(X,ge),this.getAvailableImages(X,ge),this.isSpriteLoaded[X][ge],void 0,this.brightness)),ye[X][ge][Y][le]}rasterizeImages(X,Y,le){const ge=new Map;for(const[ye,{image:Se,imageVariant:Ve}]of Y.tasks.entries()){const Ae=this.imageRasterizer.rasterize(Ve,Se,Y.scope,X);ge.set(ye,Ae)}le(void 0,ge)}removeRasterizedImages(X,Y,le){this.imageRasterizer.removeImagesFromCacheByIds(Y.imageIds,Y.scope,X),le()}enforceCacheSizeLimit(X,Y){s.en(Y)}getWorkerPerformanceMetrics(X,Y,le){le(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new Vl(self)),Vl}),j(["./shared"],function(s){var Q="3.11.0";const de={create:"create",load:"load",fullLoad:"fullLoad"},ae={mark(u){performance.mark(u)},measure(u,t,r){performance.measure(u,t,r)}};function Te(u){const t=u.name.split("?")[0];return s.a(t)&&t.includes("mapbox-gl.js")?"javascript":s.a(t)&&t.includes("mapbox-gl.css")?"css":s.b(t)?"fontRange":s.c(t)?"sprite":s.i(t)?"style":s.d(t)?"tilejson":"other"}var Ne,Re={},Ze=function(){if(Ne)return Re;function u(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var m,g,E=new Blob([""],{type:"text/javascript"}),A=URL.createObjectURL(E);try{g=new Worker(A),m=!0}catch{m=!1}return g&&g.terminate(),URL.revokeObjectURL(A),m}()?function(){var m=document.createElement("canvas");m.width=m.height=1;var g=m.getContext("2d");if(!g)return!1;var E=g.getImageData(0,0,1,1);return E&&E.width===m.width}()?(r[d=c&&c.failIfMajorPerformanceCaveat]===void 0&&(r[d]=function(m){var g,E=function(A){var C=document.createElement("canvas"),R=Object.create(u.webGLContextAttributes);return R.failIfMajorPerformanceCaveat=A,C.getContext("webgl2",R)}(m);if(!E)return!1;try{g=E.createShader(E.VERTEX_SHADER)}catch{return!1}return!(!g||E.isContextLost())&&(E.shaderSource(g,"void main() {}"),E.compileShader(g),E.getShaderParameter(g,E.COMPILE_STATUS)===!0)}(d)),r[d]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var d}Ne=1,Re.supported=u,Re.notSupportedReason=t;var r={};return u.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Re}();function et(u,t,r){const c=document.createElement(u);return t!=null&&(c.className=t),r&&r.appendChild(c),c}function ft(u,t,r){const c=document.createElementNS("http://www.w3.org/2000/svg",u);for(const d of Object.keys(t))c.setAttributeNS(null,d,String(t[d]));return r&&r.appendChild(c),c}const vt=typeof document<"u"?document.documentElement&&document.documentElement.style:null,gt=vt&&vt.userSelect!==void 0?"userSelect":"WebkitUserSelect";let Vt;function pt(){vt&&gt&&(Vt=vt[gt],vt[gt]="none")}function ui(){vt&&gt&&(vt[gt]=Vt)}function zi(u){u.preventDefault(),u.stopPropagation(),window.removeEventListener("click",zi,!0)}function Pt(){window.addEventListener("click",zi,!0),window.setTimeout(()=>{window.removeEventListener("click",zi,!0)},0)}function di(u,t){const r=u.getBoundingClientRect();return zt(u,r,t)}function jt(u,t){const r=u.getBoundingClientRect(),c=[];for(let d=0;d<t.length;d++)c.push(zt(u,r,t[d]));return c}function st(u){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&u.button===2&&u.ctrlKey?0:u.button}function zt(u,t,r){const c=u.offsetWidth===t.width?1:u.offsetWidth/t.width;return new s.P((r.clientX-t.left)*c,(r.clientY-t.top)*c)}const ji="01",Ci="NO_ACCESS_TOKEN";class Fr{constructor(t,r,c){this._transformRequestFn=t,this._customAccessToken=r,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){const t=function(){let r="";for(let c=0;c<10;c++)r+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",ji,r].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,r){return this._transformRequestFn&&this._transformRequestFn(t,r)||{url:t}}normalizeStyleURL(t,r){if(!s.f(t))return t;const c=Yi(t);return c.params.push(`sdk=js-${Q}`),c.path=`/styles/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||r)}normalizeGlyphsURL(t,r){if(!s.f(t))return t;const c=Yi(t);return c.path=`/fonts/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||r)}normalizeModelURL(t,r){if(!s.f(t))return t;const c=Yi(t);return c.path=`/models/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||r)}normalizeSourceURL(t,r,c,d){if(!s.f(t))return t;const m=Yi(t);return m.path=`/v4/${m.authority}.json`,m.params.push("secure"),c&&m.params.push(`language=${c}`),d&&m.params.push(`worldview=${d}`),this._makeAPIURL(m,this._customAccessToken||r)}normalizeIconsetURL(t,r){const c=Yi(t);return s.f(t)?(c.path=`/styles/v1${c.path}/iconset.pbf`,this._makeAPIURL(c,this._customAccessToken||r)):bi(c)}normalizeSpriteURL(t,r,c,d){const m=Yi(t);return s.f(t)?(m.path=`/styles/v1${m.path}/sprite${r}${c}`,this._makeAPIURL(m,this._customAccessToken||d)):(m.path+=`${r}${c}`,bi(m))}normalizeTileURL(t,r,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!s.f(t))return t;const d=Yi(t);d.path=d.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${r||c&&d.authority!=="raster"&&c===512?"@2x":""}${s.m.supported?".webp":"$1"}`),d.authority==="raster"?d.path=`/${s.e.RASTER_URL_PREFIX}${d.path}`:d.authority==="rasterarrays"?d.path=`/${s.e.RASTERARRAYS_URL_PREFIX}${d.path}`:d.authority==="3dtiles"?d.path=`/${s.e.TILES3D_URL_PREFIX}${d.path}`:(d.path=d.path.replace(/^.+\/v4\//,"/"),d.path=`/${s.e.TILE_URL_VERSION}${d.path}`);const m=this._customAccessToken||function(g){for(const E of g){const A=E.match(/^access_token=(.*)$/);if(A)return A[1]}return null}(d.params)||s.e.ACCESS_TOKEN;return s.e.REQUIRE_ACCESS_TOKEN&&m&&this._skuToken&&d.params.push(`sku=${this._skuToken}`),this._makeAPIURL(d,m)}canonicalizeTileURL(t,r){const c=Yi(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let d="mapbox://";c.path.match(/^\/raster\/v1\//)?d+=`raster/${c.path.replace(`/${s.e.RASTER_URL_PREFIX}/`,"")}`:c.path.match(/^\/rasterarrays\/v1\//)?d+=`rasterarrays/${c.path.replace(`/${s.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:d+=`tiles/${c.path.replace(`/${s.e.TILE_URL_VERSION}/`,"")}`;let m=c.params;return r&&(m=m.filter(g=>!g.match(/^access_token=/))),m.length&&(d+=`?${m.join("&")}`),d}canonicalizeTileset(t,r){const c=!!r&&s.f(r),d=[];for(const m of t.tiles||[])s.h(m)?d.push(this.canonicalizeTileURL(m,c)):d.push(m);return d}_makeAPIURL(t,r){const c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",d=Yi(s.e.API_URL);if(t.protocol=d.protocol,t.authority=d.authority,t.protocol==="http"){const m=t.params.indexOf("secure");m>=0&&t.params.splice(m,1)}if(d.path!=="/"&&(t.path=`${d.path}${t.path}`),!s.e.REQUIRE_ACCESS_TOKEN)return bi(t);if(r=r||s.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!r)throw new Error(`An API access token is required to use Mapbox GL. ${c}`);if(r[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${c}`)}return t.params=t.params.filter(m=>m.indexOf("access_token")===-1),t.params.push(`access_token=${r||""}`),bi(t)}}const oi=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Yi(u){const t=u.match(oi);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function bi(u){const t=u.params.length?`?${u.params.join("&")}`:"";return`${u.protocol}://${u.authority}${u.path}${t}`}const nr="mapbox.eventData";function hi(u){if(!u)return null;const t=u.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(s.j(t[1]))}catch{return null}}class Ti{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const r=hi(s.e.ACCESS_TOKEN);let c="";return c=r&&r.u?s.k(r.u):s.e.ACCESS_TOKEN||"",t?`${nr}.${t}:${c}`:`${nr}:${c}`}fetchEventData(){const t=s.s("localStorage"),r=this.getStorageKey(),c=this.getStorageKey("uuid");if(t)try{const d=localStorage.getItem(r);d&&(this.eventData=JSON.parse(d));const m=localStorage.getItem(c);m&&(this.anonId=m)}catch{s.w("Unable to read from LocalStorage")}}saveEventData(){const t=s.s("localStorage"),r=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.anonId;if(t&&d)try{localStorage.setItem(c,d),Object.keys(this.eventData).length>=1&&localStorage.setItem(r,JSON.stringify(this.eventData))}catch{s.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,r,c,d){if(!s.e.EVENTS_URL)return;const m=Yi(s.e.EVENTS_URL);m.params.push(`access_token=${d||s.e.ACCESS_TOKEN||""}`);const g={event:this.type,created:new Date(t).toISOString()},E=r?s.l(g,r):g,A={url:bi(m),headers:{"Content-Type":"text/plain"},body:JSON.stringify([E])};this.pendingRequest=s.p(A,C=>{this.pendingRequest=null,c(C),this.saveEventData(),this.processRequests(d)})}queueRequest(t,r){this.queue.push(t),this.processRequests(r)}}const Bt=new class extends Ti{constructor(u){super("appUserTurnstile"),this._customAccessToken=u}postTurnstileEvent(u,t){s.e.EVENTS_URL&&s.e.ACCESS_TOKEN&&Array.isArray(u)&&u.some(r=>s.f(r)||s.h(r))&&this.queueRequest(Date.now(),t)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=hi(s.e.ACCESS_TOKEN),r=t?t.u:s.e.ACCESS_TOKEN;let c=r!==this.eventData.tokenU;s.v(this.anonId)||(this.anonId=s.u(),c=!0);const d=this.queue.shift();if(this.eventData.lastSuccess){const m=new Date(this.eventData.lastSuccess),g=new Date(d),E=(d-this.eventData.lastSuccess)/864e5;c=c||E>=1||E<-1||m.getDate()!==g.getDate()}else c=!0;c?this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Q,skuId:ji,"enabled.telemetry":!1,userId:this.anonId},m=>{m||(this.eventData.lastSuccess=d,this.eventData.tokenU=r)},u):this.processRequests()}},gi=Bt.postTurnstileEvent.bind(Bt),Zt=new class extends Ti{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(u,t,r,c){this.skuToken=t,this.errorCb=c,s.e.EVENTS_URL&&(r||s.e.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},r):this.errorCb(new Error(Ci)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:r}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),s.v(this.anonId)||(this.anonId=s.u()),this.postEvent(r,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Q,skuId:ji,skuToken:this.skuToken,userId:this.anonId},c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},u))}remove(){this.errorCb=null}},qr=Zt.postMapLoadEvent.bind(Zt),yn=new class extends Ti{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(u){let t=this.mapInstanceIdMap.get(u);return t||(t=s.u(),this.mapInstanceIdMap.set(u,t)),t}getEventId(u){const t=this.eventIdPerMapInstanceMap.get(u)||0;return this.eventIdPerMapInstanceMap.set(u,t+1),t}postStyleLoadEvent(u,t){const{map:r,style:c,importedStyles:d}=t;if(!s.e.EVENTS_URL||!u&&!s.e.ACCESS_TOKEN)return;const m=this.getMapInstanceId(r),g={mapInstanceId:m,eventId:this.getEventId(m),style:c};d.length&&(g.importedStyles=d),this.queueRequest({timestamp:Date.now(),payload:g},u)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:r}=this.queue.shift();this.postEvent(t,r,()=>{},u)}},fr=yn.postStyleLoadEvent.bind(yn),mt=new class extends Ti{constructor(){super("gljs.performance")}postPerformanceEvent(u,t){s.e.EVENTS_URL&&(u||s.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},u)}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:r}=this.queue.shift(),c=function(d){const m=performance.getEntriesByType("resource"),g=performance.getEntriesByType("mark"),E=function(V){const H={};if(V){for(const G in V)if(G!=="other")for(const W of V[G]){const K=`${G}ResolveRangeMin`,ie=`${G}ResolveRangeMax`,oe=`${G}RequestCount`,se=`${G}RequestCachedCount`;H[K]=Math.min(H[K]||1/0,W.startTime),H[ie]=Math.max(H[ie]||-1/0,W.responseEnd);const fe=ce=>{H[ce]===void 0&&(H[ce]=0),++H[ce]};W.transferSize!==void 0&&W.transferSize===0&&fe(se),fe(oe)}}return H}(function(V,H){const G={};if(V)for(const W of V){const K=H(W);G[K]===void 0&&(G[K]=[]),G[K].push(W)}return G}(m,Te)),A=window.devicePixelRatio,C=navigator.connection||navigator.mozConnection||navigator.webkitConnection,R=C?C.effectiveType:void 0,L={counters:[],metadata:[],attributes:[]},O=(V,H,G)=>{G!=null&&V.push({name:H,value:G.toString()})};for(const V in E)O(L.counters,V,E[V]);if(d.interactionRange[0]!==1/0&&d.interactionRange[1]!==-1/0&&(O(L.counters,"interactionRangeMin",d.interactionRange[0]),O(L.counters,"interactionRangeMax",d.interactionRange[1])),g)for(const V of Object.keys(de)){const H=de[V],G=g.find(W=>W.name===H);G&&O(L.counters,H,G.startTime)}return O(L.counters,"visibilityHidden",d.visibilityHidden),O(L.attributes,"style",function(V){if(V)for(const H of V){const G=H.name.split("?")[0];if(s.i(G)){const W=G.split("/").slice(-2);if(W.length===2)return`mapbox://styles/${W[0]}/${W[1]}`}}}(m)),O(L.attributes,"terrainEnabled",d.terrainEnabled?"true":"false"),O(L.attributes,"fogEnabled",d.fogEnabled?"true":"false"),O(L.attributes,"projection",d.projection),O(L.attributes,"zoom",d.zoom),O(L.metadata,"devicePixelRatio",A),O(L.metadata,"connectionEffectiveType",R),O(L.metadata,"navigatorUserAgent",navigator.userAgent),O(L.metadata,"screenWidth",window.screen.width),O(L.metadata,"screenHeight",window.screen.height),O(L.metadata,"windowWidth",window.innerWidth),O(L.metadata,"windowHeight",window.innerHeight),O(L.metadata,"mapWidth",d.width/A),O(L.metadata,"mapHeight",d.height/A),O(L.metadata,"webglRenderer",d.renderer),O(L.metadata,"webglVendor",d.vendor),O(L.metadata,"sdkVersion",Q),O(L.metadata,"sdkIdentifier","mapbox-gl-js"),L}(r);for(const d of c.metadata);for(const d of c.counters);for(const d of c.attributes);this.postEvent(t,c,()=>{},u)}},Qt=mt.postPerformanceEvent.bind(mt),Kt=new class extends Ti{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(u,t,r,c){if(!s.e.API_URL||!s.e.SESSION_PATH)return;const d=Yi(s.e.API_URL+s.e.SESSION_PATH);d.params.push(`sku=${t||""}`),d.params.push(`access_token=${c||s.e.ACCESS_TOKEN||""}`);const m={url:bi(d),headers:{"Content-Type":"text/plain"}};this.pendingRequest=s.g(m,g=>{this.pendingRequest=null,r(g),this.saveEventData(),this.processRequests(c)})}getSessionAPI(u,t,r,c){this.skuToken=t,this.errorCb=c,s.e.SESSION_PATH&&s.e.API_URL&&(r||s.e.ACCESS_TOKEN?this.queueRequest({id:u,timestamp:Date.now()},r):this.errorCb(new Error(Ci)))}processRequests(u){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:r}=this.queue.shift();t&&this.success[t]||this.getSession(r,this.skuToken,c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},u)}remove(){this.errorCb=null}},J=Kt.getSessionAPI.bind(Kt),pr=new Set;function ze(u,t){t?pr.add(u):pr.delete(u)}class Be{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,r){this._updatedSourceCaches[t]=r,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const r=t.scope;this._updatedLayers[r]=this._updatedLayers[r]||new Set,this._updatedLayers[r].add(t.id),this.setDirty()}removeLayer(t){const r=t.scope;this._removedLayers[r]=this._removedLayers[r]||{},this._updatedLayers[r]=this._updatedLayers[r]||new Set,this._removedLayers[r][t.id]=t,this._updatedLayers[r].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const r in this._updatedLayers)t[r]=t[r]||{},t[r].updatedIds=Array.from(this._updatedLayers[r].values());for(const r in this._removedLayers)t[r]=t[r]||{},t[r].removedIds=Object.keys(this._removedLayers[r]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(t){this._updatedImages.add(s.I.toString(t)),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}function we(u){const{userImage:t}=u;return!!(t&&t.render&&t.render())&&(u.data.replace(new Uint8Array(t.data.buffer)),!0)}class bt extends s.E{constructor(t){super(),this._images={},this._iconsets={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.patternsInFlight=new Set,this.atlasImage={},this.atlasTexture={},this.dirty=!0,this.spriteFormat=t,t!=="raster"&&s.t()&&(this.imageRasterizerDispatcher=new s.D(s.x(),this,"Image Rasterizer Worker",1))}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new s.y),this._imageRasterizer}createScope(t){this._images[t]={},this._iconsets[t]={},this.loaded[t]=!1,this.updatedImages[t]=new Set,this.patterns[t]={},this.callbackDispatchedThisFrame[t]=new Set,this.atlasImage[t]=new s.r({width:1,height:1})}createIconset(t,r){this._iconsets[t][r]={}}isLoaded(){for(const t in this.loaded)if(!this.loaded[t])return!1;return!0}setLoaded(t,r){if(this.loaded[r]!==t&&(this.loaded[r]=t,t)){for(const{ids:c,callback:d}of this.requestors)this._notify(c,r,d);this.requestors=[]}}hasImage(t,r){return!!this.getImage(t,r)}getImage(t,r){return(t.iconsetId?this._iconsets[r][t.iconsetId]:this._images[r])[t.name]}addImage(t,r,c){const d=t.iconsetId?this._iconsets[r][t.iconsetId]:this._images[r];this._validate(t,c)&&(d[t.name]=c)}_validate(t,r){let c=!0;return this._validateStretch(r.stretchX,r.data&&r.data.width)||(this.fire(new s.z(new Error(`Image "${t.name}" has invalid "stretchX" value`))),c=!1),this._validateStretch(r.stretchY,r.data&&r.data.height)||(this.fire(new s.z(new Error(`Image "${t.name}" has invalid "stretchY" value`))),c=!1),this._validateContent(r.content,r)||(this.fire(new s.z(new Error(`Image "${t.name}" has invalid "content" value`))),c=!1),c}_validateStretch(t,r){if(!t)return!0;let c=0;for(const d of t){if(d[0]<c||d[1]<d[0]||r<d[1])return!1;c=d[1]}return!0}_validateContent(t,r){return t?t.length!==4||!r.usvg&&(t[0]<0||r.data.width<t[0]||t[1]<0||r.data.height<t[1]||t[2]<0||r.data.width<t[2]||t[3]<0||r.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,r,c){const d=t.iconsetId?this._iconsets[r][t.iconsetId]:this._images[r];c.version=d[t.name].version+1,d[t.name]=c,this.updatedImages[r].add(t),this.removeFromImageRasterizerCache(t,r)}clearUpdatedImages(t){this.updatedImages[t].clear()}removeFromImageRasterizerCache(t,r){if(this.spriteFormat!=="raster")if(s.t()){const c={imageIds:[t],scope:r};this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",c)}else this.imageRasterizer.removeImagesFromCacheByIds([t],r)}removeImage(t,r){const c=t.iconsetId?this._iconsets[r][t.iconsetId]:this._images[r],d=c[t.name];delete c[t.name],delete this.patterns[r][t.name],this.removeFromImageRasterizerCache(t,r),d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(t){const r=[];for(const c of Object.keys(this._images[t]))r.push(new s.I(c));for(const c in this._iconsets[t])for(const d of Object.keys(this._iconsets[t][c]))r.push(new s.I({name:d,iconsetId:c}));return r}getImages(t,r,c){let d=!0;const m=!!this.loaded[r];if(!m)for(const g of t)(g.iconsetId?this._iconsets[r][g.iconsetId]:this._images[r])[g.name]||(d=!1);m||d?this._notify(t,r,c):this.requestors.push({ids:t,scope:r,callback:c})}rasterizeImages({scope:t,tasks:r},c){const d=new Map;for(const[m,g]of r.entries()){const E=this.getImage(g.id,t);E&&d.set(m,{image:E,imageVariant:g})}this._rasterizeImages(t,d,c)}_rasterizeImages(t,r,c){if(s.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImages",{tasks:r,scope:t},c);else{const d=new Map;for(const[m,{image:g,imageVariant:E}]of r.entries())d.set(m,this.imageRasterizer.rasterize(E,g,t,0));c(void 0,d)}}getUpdatedImages(t){return this.updatedImages[t]||new Set}_notify(t,r,c){const d=new Map;for(const m of t){m.iconsetId&&(this._iconsets[r][m.iconsetId]=this._iconsets[r][m.iconsetId]||{});const g=(m.iconsetId?this._iconsets[r][m.iconsetId]:this._images[r])[m.name];if(!g){if(m.iconsetId)continue;s.w(`Image "${m.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`),this.fire(new s.A("styleimagemissing",{id:m.name}));continue}const E={data:g.usvg?null:g.data.clone(),pixelRatio:g.pixelRatio,sdf:g.sdf,usvg:g.usvg,version:g.version,stretchX:g.stretchX,stretchY:g.stretchY,content:g.content,hasRenderCallback:!!(g.userImage&&g.userImage.render)};g.usvg&&Object.assign(E,{width:g.icon.usvg_tree.width,height:g.icon.usvg_tree.height}),d.set(s.I.toString(m),E)}c(null,d)}getPixelSize(t){const{width:r,height:c}=this.atlasImage[t];return{width:r,height:c}}getPattern(t,r,c){const d=this.patterns[r][t.name],m=this.getImage(t,r);if(!m)return null;if(d){if(d.position.version===m.version)return d.position;d.position.version=m.version}else{if(m.usvg&&!m.data){const g=this.getPatternInFlightId(t.toString(),r);if(this.patternsInFlight.has(g))return null;this.patternsInFlight.add(g);const E=new s.B(t).scaleSelf(s.q.devicePixelRatio),A=new Map([[E.toString(),{image:m,imageVariant:E}]]);return this._rasterizeImages(r,A,(C,R)=>this.storePatternImage(E,r,m,c,R)),null}this.storePattern(t,r,m)}return this._updatePatternAtlas(r,c),this.patterns[r][t.name].position}getPatternInFlightId(t,r){return s.C(t,r)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,r,c,d,m){const g=t.toString(),E=m?m.get(g):void 0;E&&(c.data=E,this.storePattern(t.id,r,c),this._updatePatternAtlas(r,d),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),r)))}storePattern(t,r,c){const d={w:c.data.width+2*s.F,h:c.data.height+2*s.F,x:0,y:0},m=new s.G(d,c,s.F);this.patterns[r][t.name]={bin:d,position:m}}bind(t,r){const c=t.gl;let d=this.atlasTexture[r];d?this.dirty&&(d.update(this.atlasImage[r]),this.dirty=!1):(d=new s.T(t,this.atlasImage[r],c.RGBA8),this.atlasTexture[r]=d),d.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,r){const c=[];for(const E in this.patterns[t])c.push(this.patterns[t][E].bin);const{w:d,h:m}=s.H(c),g=this.atlasImage[t];g.resize({width:d||1,height:m||1});for(const E in this.patterns[t]){const{bin:A,position:C}=this.patterns[t][E];let R=C.padding;const L=A.x+R,O=A.y+R,V=this._images[t][E].data,H=V.width,G=V.height;R=R>1?R-1:R,s.r.copy(V,g,{x:0,y:0},{x:L,y:O},{width:H,height:G},r),s.r.copy(V,g,{x:0,y:G-R},{x:L,y:O-R},{width:H,height:R},r),s.r.copy(V,g,{x:0,y:0},{x:L,y:O+G},{width:H,height:R},r),s.r.copy(V,g,{x:H-R,y:0},{x:L-R,y:O},{width:R,height:G},r),s.r.copy(V,g,{x:0,y:0},{x:L+H,y:O},{width:R,height:G},r),s.r.copy(V,g,{x:H-R,y:G-R},{x:L-R,y:O-R},{width:R,height:R},r),s.r.copy(V,g,{x:0,y:G-R},{x:L+H,y:O-R},{width:R,height:R},r),s.r.copy(V,g,{x:0,y:0},{x:L+H,y:O+G},{width:R,height:R},r),s.r.copy(V,g,{x:H-R,y:0},{x:L-R,y:O+G},{width:R,height:R},r)}this.dirty=!0}beginFrame(){for(const t in this._images)this.callbackDispatchedThisFrame[t]=new Set}dispatchRenderCallbacks(t,r){for(const c of t){if(this.callbackDispatchedThisFrame[r].has(c.toString()))continue;this.callbackDispatchedThisFrame[r].add(c.toString());const d=(c.iconsetId?this._iconsets[r][c.iconsetId]:this._images[r])[c.name];we(d)&&this.updateImage(c,r,d)}}}function Tt(u){const t=u.key,r=u.value,c=u.valueSpec||{},d=u.objectElementValidators||{},m=u.style,g=u.styleSpec;let E=[];const A=s.K(r);if(A!=="object")return[new s.V(t,r,`object expected, ${A} found`)];for(const C in r){const R=C.split(".")[0];let L;d[R]?L=d[R]:c[R]?L=ar:d["*"]?L=d["*"]:c["*"]&&(L=ar),L?E=E.concat(L({key:(t&&`${t}.`)+C,value:r[C],valueSpec:c[R]||c["*"],style:m,styleSpec:g,object:r,objectKey:C},r)):E.push(new s.J(t,r[C],`unknown property "${C}"`))}for(const C in c)d[C]||c[C].required&&c[C].default===void 0&&r[C]===void 0&&E.push(new s.V(t,r,`missing required property "${C}"`));return E}function St(u){const t=u.value,r=u.valueSpec,c=u.style,d=u.styleSpec,m=u.key,g=u.arrayElementValidator||ar;if(s.K(t)!=="array")return[new s.V(m,t,`array expected, ${s.K(t)} found`)];if(r.length&&t.length!==r.length)return[new s.V(m,t,`array length ${r.length} expected, length ${t.length} found`)];if(r["min-length"]&&t.length<r["min-length"])return[new s.V(m,t,`array length at least ${r["min-length"]} expected, length ${t.length} found`)];let E={type:r.value,values:r.values,minimum:r.minimum,maximum:r.maximum,function:void 0};d.$version<7&&(E.function=r.function),s.K(r.value)==="object"&&(E=r.value);let A=[];for(let C=0;C<t.length;C++)A=A.concat(g({array:t,arrayIndex:C,value:t[C],valueSpec:E,style:c,styleSpec:d,key:`${m}[${C}]`},!0));return A}function xt(u){const t=u.key,r=u.value,c=u.valueSpec;let d=s.K(r);if(d==="number"&&r!=r&&(d="NaN"),d!=="number")return[new s.V(t,r,`number expected, ${d} found`)];if("minimum"in c){let m=c.minimum;if(s.K(c.minimum)==="array"&&(m=c.minimum[u.arrayIndex]),r<m)return[new s.V(t,r,`${r} is less than the minimum value ${m}`)]}if("maximum"in c){let m=c.maximum;if(s.K(c.maximum)==="array"&&(m=c.maximum[u.arrayIndex]),r>m)return[new s.V(t,r,`${r} is greater than the maximum value ${m}`)]}return[]}function Ut(u){const t=u.valueSpec,r=s.M(u.value.type);let c,d,m,g={};const E=r!=="categorical"&&u.value.property===void 0,A=!E,C=s.K(u.value.stops)==="array"&&s.K(u.value.stops[0])==="array"&&s.K(u.value.stops[0][0])==="object",R=Tt({key:u.key,value:u.value,valueSpec:u.styleSpec.function,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{stops:function(V){if(r==="identity")return[new s.V(V.key,V.value,'identity function may not have a "stops" property')];let H=[];const G=V.value;return H=H.concat(St({key:V.key,value:G,valueSpec:V.valueSpec,style:V.style,styleSpec:V.styleSpec,arrayElementValidator:L})),s.K(G)==="array"&&G.length===0&&H.push(new s.V(V.key,G,"array must have at least one stop")),H},default:function(V){return ar({key:V.key,value:V.value,valueSpec:t,style:V.style,styleSpec:V.styleSpec})}}});return r==="identity"&&E&&R.push(new s.V(u.key,u.value,'missing required property "property"')),r==="identity"||u.value.stops||R.push(new s.V(u.key,u.value,'missing required property "stops"')),r==="exponential"&&u.valueSpec.expression&&!s.N(u.valueSpec)&&R.push(new s.V(u.key,u.value,"exponential functions not supported")),u.styleSpec.$version>=8&&(A&&!s.O(u.valueSpec)?R.push(new s.V(u.key,u.value,"property functions not supported")):E&&!s.Q(u.valueSpec)&&R.push(new s.V(u.key,u.value,"zoom functions not supported"))),r!=="categorical"&&!C||u.value.property!==void 0||R.push(new s.V(u.key,u.value,'"property" property is required')),R;function L(V){let H=[];const G=V.value,W=V.key;if(s.K(G)!=="array")return[new s.V(W,G,`array expected, ${s.K(G)} found`)];if(G.length!==2)return[new s.V(W,G,`array length 2 expected, length ${G.length} found`)];if(C){if(s.K(G[0])!=="object")return[new s.V(W,G,`object expected, ${s.K(G[0])} found`)];if(G[0].zoom===void 0)return[new s.V(W,G,"object stop key must have zoom")];if(G[0].value===void 0)return[new s.V(W,G,"object stop key must have value")];const K=s.M(G[0].zoom);if(typeof K!="number")return[new s.V(W,G[0].zoom,"stop zoom values must be numbers")];if(m&&m>K)return[new s.V(W,G[0].zoom,"stop zoom values must appear in ascending order")];K!==m&&(m=K,d=void 0,g={}),H=H.concat(Tt({key:`${W}[0]`,value:G[0],valueSpec:{zoom:{}},style:V.style,styleSpec:V.styleSpec,objectElementValidators:{zoom:xt,value:O}}))}else H=H.concat(O({key:`${W}[0]`,value:G[0],style:V.style,styleSpec:V.styleSpec},G));return s.S(s.U(G[1]))?H.concat([new s.V(`${W}[1]`,G[1],"expressions are not allowed in function stops.")]):H.concat(ar({key:`${W}[1]`,value:G[1],valueSpec:t,style:V.style,styleSpec:V.styleSpec}))}function O(V,H){const G=s.K(V.value),W=s.M(V.value),K=V.value!==null?V.value:H;if(c){if(G!==c)return[new s.V(V.key,K,`${G} stop domain type must match previous stop domain type ${c}`)]}else c=G;if(G!=="number"&&G!=="string"&&G!=="boolean"&&typeof W!="number"&&typeof W!="string"&&typeof W!="boolean")return[new s.V(V.key,K,"stop domain value must be a number, string, or boolean")];if(G!=="number"&&r!=="categorical"){let ie=`number expected, ${G} found`;return s.O(t)&&r===void 0&&(ie+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new s.V(V.key,K,ie)]}return r!=="categorical"||G!=="number"||typeof W=="number"&&isFinite(W)&&Math.floor(W)===W?r!=="categorical"&&G==="number"&&typeof W=="number"&&typeof d=="number"&&d!==void 0&&W<d?[new s.V(V.key,K,"stop domain values must appear in ascending order")]:(d=W,r==="categorical"&&W in g?[new s.V(V.key,K,"stop domain values must be unique")]:(g[W]=!0,[])):[new s.V(V.key,K,`integer expected, found ${String(W)}`)]}}function Gt(u){const t=(u.expressionContext==="property"?s.W:s.X)(s.U(u.value),u.valueSpec);if(t.result==="error")return t.value.map(c=>new s.V(`${u.key}${c.key}`,u.value,c.message));const r=t.value.expression||t.value._styleExpression.expression;if(u.expressionContext==="property"&&u.propertyKey==="text-font"&&!r.outputDefined())return[new s.V(u.key,u.value,`Invalid data expression for "${u.propertyKey}". Output values must be contained as literals within the expression.`)];if(u.expressionContext==="property"&&u.propertyType==="layout"&&!s.Y(r))return[new s.V(u.key,u.value,'"feature-state" data expressions are not supported with layout properties.')];if(u.expressionContext==="filter")return Nt(r,u);if(u.expressionContext&&u.expressionContext.indexOf("cluster")===0){if(!s.Z(r,["zoom","feature-state"]))return[new s.V(u.key,u.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(u.expressionContext==="cluster-initial"&&!s._(r))return[new s.V(u.key,u.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Nt(u,t){const r=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)r.delete(d);if(r.size===0)return[];const c=[];return u instanceof s.$&&r.has(u.name)?[new s.V(t.key,t.value,`["${u.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(u.eachChild(d=>{c.push(...Nt(d,t))}),c)}function xi(u){const t=u.key,r=u.value,c=u.valueSpec,d=[];return Array.isArray(c.values)?c.values.indexOf(s.M(r))===-1&&d.push(new s.V(t,r,`expected one of [${c.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(c.values).indexOf(s.M(r))===-1&&d.push(new s.V(t,r,`expected one of [${Object.keys(c.values).join(", ")}], ${JSON.stringify(r)} found`)),d}function Jt(u){return s.a1(s.U(u.value))?Gt(s.L({},u,{expressionContext:"filter",valueSpec:u.styleSpec[`filter_${u.layerType||"fill"}`]})):Dt(u)}function Dt(u){const t=u.value,r=u.key;if(s.K(t)!=="array")return[new s.V(r,t,`array expected, ${s.K(t)} found`)];const c=u.styleSpec;let d,m=[];if(t.length<1)return[new s.V(r,t,"filter array must have at least 1 element")];switch(m=m.concat(xi({key:`${r}[0]`,value:t[0],valueSpec:c.filter_operator,style:u.style,styleSpec:u.styleSpec})),s.M(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&s.M(t[1])==="$type"&&m.push(new s.V(r,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&m.push(new s.V(r,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(d=s.K(t[1]),d!=="string"&&m.push(new s.V(`${r}[1]`,t[1],`string expected, ${d} found`)));for(let g=2;g<t.length;g++)d=s.K(t[g]),s.M(t[1])==="$type"?m=m.concat(xi({key:`${r}[${g}]`,value:t[g],valueSpec:c.geometry_type,style:u.style,styleSpec:u.styleSpec})):d!=="string"&&d!=="number"&&d!=="boolean"&&m.push(new s.V(`${r}[${g}]`,t[g],`string, number, or boolean expected, ${d} found`));break;case"any":case"all":case"none":for(let g=1;g<t.length;g++)m=m.concat(Dt({key:`${r}[${g}]`,value:t[g],style:u.style,styleSpec:u.styleSpec}));break;case"has":case"!has":d=s.K(t[1]),t.length!==2?m.push(new s.V(r,t,`filter array for "${t[0]}" operator must have 2 elements`)):d!=="string"&&m.push(new s.V(`${r}[1]`,t[1],`string expected, ${d} found`))}return m}function yi(u,t){const r=u.key,c=u.style,d=u.layer,m=u.styleSpec,g=u.value,E=u.objectKey,A=m[`${t}_${u.layerType}`];if(!A)return[];const C=E.match(/^(.*)-use-theme$/);if(t==="paint"&&C&&A[C[1]])return s.S(g)?[].concat(ar({key:u.key,value:g,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:m,expressionContext:"property",propertyType:t,propertyKey:E})):ar({key:r,value:g,valueSpec:{type:"string"},style:c,styleSpec:m});const R=E.match(/^(.*)-transition$/);if(t==="paint"&&R&&A[R[1]]&&A[R[1]].transition)return ar({key:r,value:g,valueSpec:m.transition,style:c,styleSpec:m});const L=u.valueSpec||A[E];if(!L)return[new s.J(r,g,`unknown property "${E}"`)];let O;if(s.K(g)==="string"&&s.O(L)&&!L.tokens&&(O=/^{([^}]+)}$/.exec(g))){const H=`\`{ "type": "identity", "property": ${O?JSON.stringify(O[1]):'"_"'} }\``;return[new s.V(r,g,`"${E}" does not support interpolation syntax
Use an identity property function instead: ${H}.`)]}const V=[];if(u.layerType==="symbol")E!=="text-field"||!c||c.glyphs||c.imports||V.push(new s.V(r,g,'use of "text-field" requires a style "glyphs" property')),E==="text-font"&&s.a2(s.U(g))&&s.M(g.type)==="identity"&&V.push(new s.V(r,g,'"text-font" does not support identity functions'));else if(u.layerType==="model"&&t==="paint"&&d&&d.layout&&d.layout.hasOwnProperty("model-id")&&s.O(L)&&(s.a3(L)||s.Q(L))){const H=s.W(s.U(g),L),G=H.value.expression||H.value._styleExpression.expression;G&&!s.Z(G,["measure-light"])&&(E==="model-emissive-strength"&&s._(G)&&s.Y(G)||V.push(new s.V(r,g,`${E} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return V.concat(ar({key:u.key,value:g,valueSpec:L,style:c,styleSpec:m,expressionContext:"property",propertyType:t,propertyKey:E}))}function Ji(u){return yi(u,"paint")}function gr(u){return yi(u,"layout")}function Gi(u){let t=[];const r=u.value,c=u.key,d=u.style,m=u.styleSpec;r.type||r.ref||t.push(new s.V(c,r,'either "type" or "ref" is required'));let g=s.M(r.type);const E=s.M(r.ref);if(r.id){const A=s.M(r.id);for(let C=0;C<u.arrayIndex;C++){const R=d.layers[C];s.M(R.id)===A&&t.push(new s.V(c,r.id,`duplicate layer id "${r.id}", previously used at line ${R.id.__line__}`))}}if("ref"in r){let A;["type","source","source-layer","filter","layout"].forEach(C=>{C in r&&t.push(new s.V(c,r[C],`"${C}" is prohibited for ref layers`))}),d.layers.forEach(C=>{s.M(C.id)===E&&(A=C)}),A?A.ref?t.push(new s.V(c,r.ref,"ref cannot reference another ref layer")):g=s.M(A.type):typeof E=="string"&&t.push(new s.V(c,r.ref,`ref layer "${E}" not found`))}else if(g!=="background"&&g!=="sky"&&g!=="slot")if(r.source){const A=d.sources&&d.sources[r.source],C=A&&s.M(A.type);A?C==="vector"&&g==="raster"?t.push(new s.V(c,r.source,`layer "${r.id}" requires a raster source`)):C==="raster"&&g!=="raster"?t.push(new s.V(c,r.source,`layer "${r.id}" requires a vector source`)):C!=="vector"||r["source-layer"]?C==="raster-dem"&&g!=="hillshade"?t.push(new s.V(c,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):C!=="raster-array"||["raster","raster-particle"].includes(g)?g!=="line"||!r.paint||!r.paint["line-gradient"]&&!r.paint["line-trim-offset"]||C==="geojson"&&A.lineMetrics?g==="raster-particle"&&C!=="raster-array"&&t.push(new s.V(c,r.source,`layer "${r.id}" requires a 'raster-array' source.`)):t.push(new s.V(c,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new s.V(c,r.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new s.V(c,r,`layer "${r.id}" must specify a "source-layer"`)):t.push(new s.V(c,r.source,`source "${r.source}" not found`))}else t.push(new s.V(c,r,'missing required property "source"'));return t=t.concat(Tt({key:c,value:r,valueSpec:m.layer,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ar({key:`${c}.type`,value:r.type,valueSpec:m.layer.type,style:u.style,styleSpec:u.styleSpec,object:r,objectKey:"type"}),filter:A=>Jt(s.L({layerType:g},A)),layout:A=>Tt({layer:r,key:A.key,value:A.value,valueSpec:{},style:A.style,styleSpec:A.styleSpec,objectElementValidators:{"*":C=>gr(s.L({layerType:g},C))}}),paint:A=>Tt({layer:r,key:A.key,value:A.value,valueSpec:{},style:A.style,styleSpec:A.styleSpec,objectElementValidators:{"*":C=>Ji(s.L({layerType:g,layer:r},C))}})}})),t}function Kr(u){const t=u.value,r=u.key,c=s.K(t);return c!=="string"?[new s.V(r,t,`string expected, ${c} found`)]:[]}const Vr={promoteId:function u({key:t,value:r}){if(s.K(r)==="string")return Kr({key:t,value:r});if(Array.isArray(r)){const c=[],d=s.U(r),m=s.X(d);return m.result==="error"&&m.value.forEach(g=>{c.push(new s.V(`${t}${g.key}`,null,`${g.message}`))}),s.Z(m.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||c.push(new s.V(`${t}`,null,"promoteId expression should be only feature dependent")),c}{const c=[];for(const d in r)c.push(...u({key:`${t}.${d}`,value:r[d]}));return c}}};function zn(u){const t=u.value,r=u.key,c=u.styleSpec,d=u.style;if(!t.type)return[new s.V(r,t,'"type" is required')];const m=s.M(t.type);let g=[];switch(["vector","raster","raster-dem","raster-array"].includes(m)&&(t.url||t.tiles||g.push(new s.J(r,t,'Either "url" or "tiles" is required.'))),m){case"vector":case"raster":case"raster-dem":case"raster-array":return g=g.concat(Tt({key:r,value:t,valueSpec:c[`source_${m.replace("-","_")}`],style:u.style,styleSpec:c,objectElementValidators:Vr})),g;case"geojson":if(g=Tt({key:r,value:t,valueSpec:c.source_geojson,style:d,styleSpec:c,objectElementValidators:Vr}),t.cluster)for(const E in t.clusterProperties){const[A,C]=t.clusterProperties[E],R=typeof A=="string"?[A,["accumulated"],["get",E]]:A;g.push(...Gt({key:`${r}.${E}.map`,value:C,expressionContext:"cluster-map"})),g.push(...Gt({key:`${r}.${E}.reduce`,value:R,expressionContext:"cluster-reduce"}))}return g;case"video":return Tt({key:r,value:t,valueSpec:c.source_video,style:d,styleSpec:c});case"image":return Tt({key:r,value:t,valueSpec:c.source_image,style:d,styleSpec:c});case"canvas":return[new s.V(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return xi({key:`${r}.type`,value:t.type,valueSpec:{values:Ln(c)}})}}function Ln(u){return u.source.reduce((t,r)=>{const c=u[r];return c.type.type==="enum"&&(t=t.concat(Object.keys(c.type.values))),t},[])}function ns(u){const t=u.value,r=u.styleSpec,c=r.light,d=u.style;let m=[];const g=s.K(t);if(t===void 0)return m;if(g!=="object")return m=m.concat([new s.V("light",t,`object expected, ${g} found`)]),m;for(const E in t){const A=E.match(/^(.*)-transition$/),C=E.match(/^(.*)-use-theme$/);m=m.concat(C&&c[C[1]]?ar({key:E,value:t[E],valueSpec:{type:"string"},style:d,styleSpec:r}):A&&c[A[1]]&&c[A[1]].transition?ar({key:E,value:t[E],valueSpec:r.transition,style:d,styleSpec:r}):c[E]?ar({key:E,value:t[E],valueSpec:c[E],style:d,styleSpec:r}):[new s.V(E,t[E],`unknown property "${E}"`)])}return m}function Hs(u){const t=u.value;let r=[];if(!t)return r;const c=s.K(t);if(c!=="object")return r=r.concat([new s.V("light-3d",t,`object expected, ${c} found`)]),r;const d=u.styleSpec,m=d["light-3d"],g=u.key,E=u.style,A=u.style.lights;for(const L of["type","id"])if(!(L in t))return r=r.concat([new s.V("light-3d",t,`missing property ${L} on light`)]),r;if(t.type&&A)for(let L=0;L<u.arrayIndex;L++){const O=s.M(t.type),V=A[L];s.M(V.type)===O&&r.push(new s.V(g,t.id,`duplicate light type "${t.type}", previously defined at line ${V.id.__line__}`))}const C=`properties_light_${t.type}`;if(!(C in d))return r=r.concat([new s.V("light-3d",t,`Invalid light type ${t.type}`)]),r;const R=d[C];for(const L in t)if(L==="properties"){const O=t[L],V=s.K(O);if(V!=="object")return r=r.concat([new s.V("properties",O,`object expected, ${V} found`)]),r;for(const H in O)r=r.concat(R[H]?ar({key:H,value:O[H],valueSpec:R[H],style:E,styleSpec:d}):[new s.J(u.key,O[H],`unknown property "${H}"`)])}else{const O=L.match(/^(.*)-transition$/),V=L.match(/^(.*)-use-theme$/);r=r.concat(V&&m[V[1]]?ar({key:L,value:t[L],valueSpec:{type:"string"},style:E,styleSpec:d}):O&&m[O[1]]&&m[O[1]].transition?ar({key:L,value:t[L],valueSpec:d.transition,style:E,styleSpec:d}):m[L]?ar({key:L,value:t[L],valueSpec:m[L],style:E,styleSpec:d}):[new s.J(L,t[L],`unknown property "${L}"`)])}return r}function Or(u){const t=u.value,r=u.key,c=u.style,d=u.styleSpec,m=d.terrain;let g=[];const E=s.K(t);if(t===void 0||E==="null")return g;if(E!=="object")return g=g.concat([new s.V("terrain",t,`object expected, ${E} found`)]),g;for(const A in t){const C=A.match(/^(.*)-transition$/),R=A.match(/^(.*)-use-theme$/);g=g.concat(R&&m[R[1]]?ar({key:A,value:t[A],valueSpec:{type:"string"},style:c,styleSpec:d}):C&&m[C[1]]&&m[C[1]].transition?ar({key:A,value:t[A],valueSpec:d.transition,style:c,styleSpec:d}):m[A]?ar({key:A,value:t[A],valueSpec:m[A],style:c,styleSpec:d}):[new s.J(A,t[A],`unknown property "${A}"`)])}if(t.source){const A=c.sources&&c.sources[t.source],C=A&&s.M(A.type);A?C!=="raster-dem"&&g.push(new s.V(r,t.source,`terrain cannot be used with a source of type ${String(C)}, it only be used with a "raster-dem" source type`)):g.push(new s.V(r,t.source,`source "${t.source}" not found`))}else g.push(new s.V(r,t,'terrain is missing required property "source"'));return g}function En(u){const t=u.value,r=u.style,c=u.styleSpec,d=c.fog;let m=[];const g=s.K(t);if(t===void 0)return m;if(g!=="object")return m=m.concat([new s.V("fog",t,`object expected, ${g} found`)]),m;for(const E in t){const A=E.match(/^(.*)-transition$/),C=E.match(/^(.*)-use-theme$/);m=m.concat(C&&d[C[1]]?ar({key:E,value:t[E],valueSpec:{type:"string"},style:r,styleSpec:c}):A&&d[A[1]]&&d[A[1]].transition?ar({key:E,value:t[E],valueSpec:c.transition,style:r,styleSpec:c}):d[E]?ar({key:E,value:t[E],valueSpec:d[E],style:r,styleSpec:c}):[new s.J(E,t[E],`unknown property "${E}"`)])}return m}const br={"*":()=>[],array:St,boolean:function(u){const t=u.value,r=u.key,c=s.K(t);return c!=="boolean"?[new s.V(r,t,`boolean expected, ${c} found`)]:[]},number:xt,color:function(u){const t=u.key,r=u.value,c=s.K(r);return c!=="string"?[new s.V(t,r,`color expected, ${c} found`)]:s.a0.parseCSSColor(r)===null?[new s.V(t,r,`color expected, "${r}" found`)]:[]},enum:xi,filter:Jt,function:Ut,layer:Gi,object:Tt,source:zn,model:s.a4,light:ns,"light-3d":Hs,terrain:Or,fog:En,string:Kr,formatted:function(u){return Kr(u).length===0?[]:Gt(u)},resolvedImage:function(u){return Kr(u).length===0?[]:Gt(u)},projection:function(u){const t=u.value,r=u.styleSpec,c=r.projection,d=u.style;let m=[];const g=s.K(t);if(g==="object")for(const E in t)m=m.concat(ar({key:E,value:t[E],valueSpec:c[E],style:d,styleSpec:r}));else g!=="string"&&(m=m.concat([new s.V("projection",t,`object or string expected, ${g} found`)]));return m},import:function(u){const{value:t,styleSpec:r}=u,{data:c,...d}=t;Object.defineProperty(d,"__line__",{value:t.__line__,enumerable:!1});let m=Tt(s.L({},u,{value:d,valueSpec:r.import}));return s.M(d.id)===""&&m.push(new s.V(`${u.key}.id`,d,"import id can't be an empty string")),c&&(m=m.concat(Pa(c,r,{key:`${u.key}.data`}))),m},iconset:function(u){const t=u.value,r=u.key,c=u.styleSpec,d=u.style;if(!t.type)return[new s.V(r,t,'"type" is required')];const m=s.M(t.type);let g=[];if(g=g.concat(Tt({key:r,value:t,valueSpec:c[`iconset_${m}`],style:d,styleSpec:c})),m==="source"&&t.source){const E=d.sources&&d.sources[t.source],A=E&&s.M(E.type);E?A!=="raster-array"&&g.push(new s.V(r,t.source,`iconset cannot be used with a source of type ${String(A)}, it only be used with a "raster-array" source type`)):g.push(new s.V(r,t.source,`source "${t.source}" not found`))}return g}};function ar(u,t=!1){const r=u.value,c=u.valueSpec,d=u.styleSpec;if(c.expression&&s.a2(s.M(r)))return Ut(u);if(c.expression&&s.S(s.U(r)))return Gt(u);if(c.type&&br[c.type]){const m=br[c.type](u);return t===!0&&m.length>0&&s.K(u.value)==="array"?Gt(u):m}return Tt(s.L({},u,{valueSpec:c.type?d[c.type]:c}))}function Bl(u){const t=u.value,r=u.key,c=Kr(u);return c.length||(t.indexOf("{fontstack}")===-1&&c.push(new s.V(r,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&c.push(new s.V(r,t,'"glyphs" url must include a "{range}" token'))),c}function Pa(u,t=s.a5,r={}){return ar({key:r.key||"",value:u,valueSpec:t.$root,styleSpec:t,style:u,objectElementValidators:{glyphs:Bl,"*":()=>[]}})}function Nn(u,t=s.a5){return Se(Pa(u,t))}const sa=u=>Se(zn(u)),Nl=u=>Se(ns(u)),Ra=u=>Se(Hs(u)),Hc=u=>Se(Or(u)),Zc=u=>Se(En(u)),Vl=u=>Se(function(t){const r=t.value,c=t.style,d=t.styleSpec,m=d.snow;let g=[];const E=s.K(r);if(r===void 0)return g;if(E!=="object")return g=g.concat([new s.V("snow",r,`object expected, ${E} found`)]),g;for(const A in r){const C=A.match(/^(.*)-transition$/);g=g.concat(C&&m[C[1]]&&m[C[1]].transition?ar({key:A,value:r[A],valueSpec:d.transition,style:c,styleSpec:d}):m[A]?ar({key:A,value:r[A],valueSpec:m[A],style:c,styleSpec:d}):[new s.J(A,r[A],`unknown property "${A}"`)])}return g}(u)),$e=u=>Se(function(t){const r=t.value,c=t.style,d=t.styleSpec,m=d.rain;let g=[];const E=s.K(r);if(r===void 0)return g;if(E!=="object")return g=g.concat([new s.V("rain",r,`object expected, ${E} found`)]),g;for(const A in r){const C=A.match(/^(.*)-transition$/);g=g.concat(C&&m[C[1]]&&m[C[1]].transition?ar({key:A,value:r[A],valueSpec:d.transition,style:c,styleSpec:d}):m[A]?ar({key:A,value:r[A],valueSpec:m[A],style:c,styleSpec:d}):[new s.J(A,r[A],`unknown property "${A}"`)])}return g}(u)),X=u=>Se(Gi(u)),Y=u=>Se(Jt(u)),le=u=>Se(Ji(u)),ge=u=>Se(gr(u)),ye=u=>Se(s.a4(u));function Se(u){return u.slice().sort((t,r)=>t.line&&r.line?t.line-r.line:0)}function Ve(u,t){let r=!1;if(t&&t.length)for(const c of t)c instanceof s.J?s.w(c.message):(u.fire(new s.z(new Error(c.message))),r=!0);return r}let Ae;class Ge extends s.E{constructor(t,r="flat"){super(),this._transitionable=new s.a6(Ae||(Ae=new s.a7({anchor:new s.a8(s.a5.light.anchor),position:new s.a9(s.a5.light.position),color:new s.a8(s.a5.light.color),intensity:new s.a8(s.a5.light.intensity)}))),this.setLight(t,r),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,r,c={}){this._validate(Nl,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=r)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,r,c){return(!c||c.validate!==!1)&&Ve(this,t.call(Nn,s.l({value:r,style:{glyphs:!0,sprite:!0},styleSpec:s.a5})))}}let We=class extends s.E{constructor(u,t,r,c){super(),this.scope=r,this._transitionable=new s.a6(new s.a7({source:new s.a8(s.a5.terrain.source),exaggeration:new s.a8(s.a5.terrain.exaggeration)}),r,c),this._transitionable.setTransitionOrValue(u,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t}get(){return this._transitionable.serialize()}set(u,t){this._transitionable.setTransitionOrValue(u,t)}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}getExaggeration(u){return this._transitioning.possiblyEvaluate(new s.aa(u)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const u=this._transitionable._values.exaggeration;if(!u)return null;const t=u.value.expression;if(!t)return null;let r=-1,c=-1,d=1;for(const m of t.zoomStops)d=t.evaluate(new s.aa(m)),d>.01?(r=m,c=-1):c=m;return d<.01&&r>0&&c>r?[r,c]:null}isZoomDependent(){const u=this._transitionable._values.exaggeration;return u!=null&&u.value!=null&&u.value.expression!=null&&u.value.expression instanceof s.ab}};const qe=45,lt=65,Mt=.05;function Rt(u,t,r,c){const d=s.ae(qe,lt,r),[m,g]=ai(u,c);let E=1-Math.min(1,Math.exp((t-m)/(g-m)*-6));return E*=E*E,E=Math.min(1,1.00747*E),E*d*u.alpha}function ai(u,t){const r=.5/Math.tan(.5*t);return[u.range[0]+r,u.range[1]+r]}function fi(u,t,r,c,d){const m=s.ad.vec3.transformMat4([],[t,r,c],d.mercatorFogMatrix);return Rt(u,s.ad.vec3.length(m),d.pitch,d._fov)}function pi(u,t,r,c,d,m,g){const E=[[r,c,0],[d,c,0],[d,m,0],[r,m,0]];let A=Number.MAX_VALUE,C=-Number.MAX_VALUE;for(const R of E){const L=s.ad.vec3.transformMat4([],R,t),O=s.ad.vec3.length(L);A=Math.min(A,O),C=Math.max(C,O)}return[Rt(u,A,g.pitch,g._fov),Rt(u,C,g.pitch,g._fov)]}class vi extends s.E{constructor(t,r,c,d){super();const m=new s.a7({range:new s.a8(s.a5.fog.range),color:new s.a8(s.a5.fog.color),"color-use-theme":new s.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new s.a8(s.a5.fog["high-color"]),"high-color-use-theme":new s.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new s.a8(s.a5.fog["space-color"]),"space-color-use-theme":new s.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new s.a8(s.a5.fog["horizon-blend"]),"star-intensity":new s.a8(s.a5.fog["star-intensity"]),"vertical-range":new s.a8(s.a5.fog["vertical-range"])});this._transitionable=new s.a6(m,c,new Map(d)),this.set(t,d),this._transitioning=this._transitionable.untransitioned(),this._transform=r,this.properties=new s.af(m),this.scope=c}get state(){const t=this._transform,r=t.projection.name==="globe",c=s.ag(t.zoom),d=this.properties.get("range"),m=[.5,3];return{range:r?[s.ah(m[0],d[0],c),s.ah(m[1],d[1],c)]:d,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,r,c={}){if(this._validate(Zc,t,c))return;const d=s.l({},t);for(const m of Object.keys(s.a5.fog))d[m]===void 0&&(d[m]=s.a5.fog[m].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,r)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const r=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:s.ae(qe,lt,t))*r.a}getOpacityAtLatLng(t,r){return this._transform.projection.supportsFog?function(c,d,m){const g=s.ac.fromLngLat(d),E=m.elevation?m.elevation.getAtPointOrZero(g):0;return fi(c,g.x,g.y,E,m)}(this.state,t,r):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const r=this._transform.calculateFogTileMatrix(t.toUnwrapped());return pi(this.state,r,0,0,s.ai,s.ai,this._transform)}getOpacityForBounds(t,r,c,d,m){return this._transform.projection.supportsFog?pi(this.state,t,r,c,d,m,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?ai(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const r=[4,5,6,7];for(const c of r){const d=t.points[c];let m;if(d[2]>=0)m=d;else{const g=t.points[c-4];m=s.aj(g,d,g[2]/(g[2]-d[2]))}if(fi(this.state,m[0],m[1],0,this._transform)>=Mt)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,r,c){return(!c||c.validate!==!1)&&Ve(this,t.call(Nn,s.l({value:r,style:{glyphs:!0,sprite:!0},styleSpec:s.a5})))}}let mr,Ar,Mi,Qi,er=class extends s.E{constructor(u,t,r,c){super();const d=mr||(mr=new s.a7({density:new s.a8(s.a5.snow.density),intensity:new s.a8(s.a5.snow.intensity),color:new s.a8(s.a5.snow.color),opacity:new s.a8(s.a5.snow.opacity),vignette:new s.a8(s.a5.snow.vignette),"vignette-color":new s.a8(s.a5.snow["vignette-color"]),"center-thinning":new s.a8(s.a5.snow["center-thinning"]),direction:new s.a8(s.a5.snow.direction),"flake-size":new s.a8(s.a5.snow["flake-size"])}));this._transitionable=new s.a6(d,r,new Map(c)),this.set(u,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.af(d),this.scope=r}get state(){const u=this.properties.get("opacity"),t=this.properties.get("color"),r=this.properties.get("direction"),c=s.ak(r[0]),d=-Math.max(s.ak(r[1]),.01),m=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],g=this.properties.get("vignette"),E=this.properties.get("vignette-color");return E.a=g,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.al(t.r,t.g,t.b,t.a*u),direction:m,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:E}}get(){return this._transitionable.serialize()}set(u,t,r={}){if(this._validate(Vl,u,r))return;const c=s.l({},u);for(const d of Object.keys(s.a5.snow))c[d]===void 0&&(c[d]=s.a5.snow[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(u){this._transitionable.setTransitionOrValue(this._options,new Map(u))}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,t,r){return(!r||r.validate!==!1)&&Ve(this,u.call(Nn,s.l({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a5})))}},rr=class extends s.E{constructor(u,t,r,c){super();const d=Ar||(Ar=new s.a7({density:new s.a8(s.a5.rain.density),intensity:new s.a8(s.a5.rain.intensity),color:new s.a8(s.a5.rain.color),opacity:new s.a8(s.a5.rain.opacity),vignette:new s.a8(s.a5.rain.vignette),"vignette-color":new s.a8(s.a5.rain["vignette-color"]),"center-thinning":new s.a8(s.a5.rain["center-thinning"]),direction:new s.a8(s.a5.rain.direction),"droplet-size":new s.a8(s.a5.rain["droplet-size"]),"distortion-strength":new s.a8(s.a5.rain["distortion-strength"])}));this._transitionable=new s.a6(d,r,new Map(c)),this.set(u,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.af(d),this.scope=r}get state(){const u=this.properties.get("opacity"),t=this.properties.get("color"),r=this.properties.get("direction"),c=s.ak(r[0]),d=-Math.max(s.ak(r[1]),.01),m=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],g=this.properties.get("vignette-color");return g.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.al(t.r,t.g,t.b,t.a*u),direction:m,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:g}}get(){return this._transitionable.serialize()}set(u,t,r={}){if(this._validate($e,u,r))return;const c=s.l({},u);for(const d of Object.keys(s.a5.rain))c[d]===void 0&&(c[d]=s.a5.rain[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(u){this._transitionable.setTransitionOrValue(this._options,new Map(u))}updateTransitions(u){this._transitioning=this._transitionable.transitioned(u,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(u){this.properties=this._transitioning.possiblyEvaluate(u)}_validate(u,t,r){return(!r||r.validate!==!1)&&Ve(this,u.call(Nn,s.l({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a5})))}};class Br extends s.E{constructor(t,r,c,d){super(),this.scope=c,this._options=t,this.properties=new s.af(r),this._transitionable=new s.a6(r,c,new Map(d)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,r){this._options=t,this._transitionable.setTransitionOrValue(t.properties,r)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class an{constructor(t,r,c,d){this.screenBounds=t,this.cameraPoint=r,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=c,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,d)}static createFromScreenPoints(t,r){let c,d;if(t instanceof s.P||typeof t[0]=="number"){const m=s.P.convert(t);c=[m],d=r.isPointAboveHorizon(m)}else{const m=s.P.convert(t[0]),g=s.P.convert(t[1]);c=[m,g],d=s.an(m,g).every(E=>r.isPointAboveHorizon(E))}return new an(c,r.getCameraPoint(),d,r)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return s.an(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const r=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],d=s.an(r,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>r.x&&this.cameraPoint.x<c.x?d.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?d[2]=this.cameraPoint:this.cameraPoint.x<=r.x&&(d[3]=this.cameraPoint)),s.ao(d,t)}bufferedCameraGeometryGlobe(t){const r=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],d=s.an(r,c,t),m=this.cameraPoint.clone();switch(3*((m.y>r.y)+(m.y>c.y))+((m.x>r.x)+(m.x>c.x))){case 0:d[0]=m,d[4]=m.clone();break;case 1:d.splice(1,0,m);break;case 2:d[1]=m;break;case 3:d.splice(4,0,m);break;case 5:d.splice(2,0,m);break;case 6:d[3]=m;break;case 7:d.splice(3,0,m);break;case 8:d[2]=m}return d}containsTile(t,r,c,d=0){const m=t.queryPadding/r._pixelsPerMercatorPixel+1,g=c?this._bufferedCameraMercator(m,r):this._bufferedScreenMercator(m,r);let E=t.tileID.wrap+(g.unwrapped?d:0);const A=g.polygon.map(W=>s.ap(t.tileTransform,W,E));if(!s.aq(A,0,0,s.ai,s.ai))return;E=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?d:0);const C=this.screenGeometryMercator.polygon.map(W=>s.ar(t.tileTransform,W,E)),R=C.map(W=>new s.P(W[0],W[1])),L=r.getFreeCameraOptions().position||new s.ac(0,0,0),O=s.ar(t.tileTransform,L,E),V=C.map(W=>{const K=s.ad.vec3.sub(W,W,O);return s.ad.vec3.normalize(K,K),new s.as(O,K)}),H=s.at(t,1,r.zoom)*r._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:R,tilespaceRays:V,bufferedTilespaceGeometry:A,bufferedTilespaceBounds:(G=s.au(A),G.min.x=s.ay(G.min.x,0,s.ai),G.min.y=s.ay(G.min.y,0,s.ai),G.max.x=s.ay(G.max.x,0,s.ai),G.max.y=s.ay(G.max.y,0,s.ai),G),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:H};var G}_bufferedScreenMercator(t,r){const c=On(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let d;return d=r.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),r):{polygon:this.bufferedScreenGeometry(t).map(m=>r.pointCoordinate3D(m)),unwrapped:!0},this._screenRaycastCache[c]=d,d}}_bufferedCameraMercator(t,r){const c=On(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let d;return d=r.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),r):{polygon:this.bufferedCameraGeometry(t).map(m=>r.pointCoordinate3D(m)),unwrapped:!0},this._cameraRaycastCache[c]=d,d}}_projectAndResample(t,r){const c=function(m,g){const E=s.ad.mat4.multiply([],g.pixelMatrix,g.globeMatrix),A=[0,-s.az,0,1],C=[0,s.az,0,1],R=[0,0,0,1];s.ad.vec4.transformMat4(A,A,E),s.ad.vec4.transformMat4(C,C,E),s.ad.vec4.transformMat4(R,R,E);const L=new s.P(A[0]/A[3],A[1]/A[3]),O=new s.P(C[0]/C[3],C[1]/C[3]),V=s.aw(m,L)&&A[3]<R[3],H=s.aw(m,O)&&C[3]<R[3];if(!V&&!H)return null;const G=function(ue,he,_e){for(let xe=1;xe<ue.length;xe++){const Ue=ys(he.pointCoordinate3D(ue[xe-1]).x),Le=ys(he.pointCoordinate3D(ue[xe]).x);if(_e<0){if(Ue<Le)return{idx:xe,t:-Ue/(Le-1-Ue)}}else if(Le<Ue)return{idx:xe,t:(1-Ue)/(Le+1-Ue)}}return null}(m,g,V?-1:1);if(!G)return null;const{idx:W,t:K}=G;let ie=W>1?Mn(m.slice(0,W),g):[],oe=W<m.length?Mn(m.slice(W),g):[];ie=ie.map(ue=>new s.P(ys(ue.x),ue.y)),oe=oe.map(ue=>new s.P(ys(ue.x),ue.y));const se=[...ie];se.length===0&&se.push(oe[oe.length-1]);const fe=s.ah(se[se.length-1].y,(oe.length===0?ie[0]:oe[0]).y,K);let ce;return ce=V?[new s.P(0,fe),new s.P(0,0),new s.P(1,0),new s.P(1,fe)]:[new s.P(1,fe),new s.P(1,1),new s.P(0,1),new s.P(0,fe)],se.push(...ce),oe.length===0?se.push(ie[0]):se.push(...oe),{polygon:se.map(ue=>new s.ac(ue.x,ue.y)),unwrapped:!1}}(t,r);if(c)return c;const d=function(m,g){let E=!1,A=-1/0,C=0;for(let L=0;L<m.length-1;L++)m[L].x>A&&(A=m[L].x,C=L);for(let L=0;L<m.length-1;L++){const O=(C+L)%(m.length-1),V=m[O],H=m[O+1];Math.abs(V.x-H.x)>.5&&(V.x<H.x?(V.x+=1,O===0&&(m[m.length-1].x+=1)):(H.x+=1,O+1===m.length-1&&(m[0].x+=1)),E=!0)}const R=s.av(g.center.lng);return E&&R<Math.abs(R-1)&&m.forEach(L=>{L.x-=1}),{polygon:m,unwrapped:E}}(Mn(t,r).map(m=>new s.P(ys(m.x),m.y)),r);return{polygon:d.polygon.map(m=>new s.ac(m.x,m.y)),unwrapped:d.unwrapped}}}function Mn(u,t){return s.ax(u,r=>{const c=t.pointCoordinate3D(r);r.x=c.x,r.y=c.y},1/256)}function ys(u){return u<0?1+u%1:u%1}function On(u){return 100*u|0}function ln(u,t,r,c,d){const m=function(E,A){if(E)return d(E);if(A){if(u.url&&A.tiles&&u.tiles&&delete u.tiles,A.variants){if(!Array.isArray(A.variants))return d(new Error("variants must be an array"));for(const R of A.variants){if(R==null||typeof R!="object"||R.constructor!==Object)return d(new Error("variant must be an object"));if(!Array.isArray(R.capabilities))return d(new Error("capabilities must be an array"));if(R.capabilities.length===1&&R.capabilities[0]==="meshopt"){A=s.l(A,R);break}}}const C=s.aA(s.l({},A,u),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);C.tiles=t.canonicalizeTileset(C,u.url),d(null,C)}},g=function(E,A,C){if(!E)return null;if(!A&&!C)return E;C=C||E.worldview_default;const R=Object.values(E.language||{});if(R.length===0)return null;const L=Object.values(E.worldview||{});if(L.length===0)return null;const O=R.every(H=>H===A),V=L.every(H=>H===C);return O&&V?E:A in(E.language_options||{})||C in(E.worldview_options||{})?null:E.language_options&&E.worldview_options?E:null}(u.data,r,c);return g?s.q.frame(()=>m(null,g)):u.url?s.n(t.transformRequest(t.normalizeSourceURL(u.url,null,r,c),s.R.Source),m):s.q.frame(()=>{const{data:E,...A}=u;m(null,A)})}class hn{constructor(t,r,c){this.bounds=s.aB.convert(this.validateBounds(t)),this.minzoom=r||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const r=Math.pow(2,t.z),c=Math.floor(s.av(this.bounds.getWest())*r),d=Math.floor(s.aC(this.bounds.getNorth())*r),m=Math.ceil(s.av(this.bounds.getEast())*r),g=Math.ceil(s.aC(this.bounds.getSouth())*r);return t.x>=c&&t.x<m&&t.y>=d&&t.y<g}}class Da extends s.E{constructor(t,r,c,d){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.l(this,s.aA(r,["url","scheme","tileSize","promoteId"])),this._options=s.l({type:"vector"},r),this._collectResourceTiming=!!r.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d),this._tileWorkers={},this._deduped=new s.aD}load(t){this._loaded=!1,this.fire(new s.A("dataloading",{dataType:"source"}));const r=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=ln(this._options,this.map._requestManager,r,c,(d,m)=>{if(this._tileJSONRequest=null,this._loaded=!0,d)r&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${r}`),c&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${c}`),this.fire(new s.z(d));else if(m){if(s.l(this,m),this.hasWorldviews=!!m.worldview_options,m.worldview_default&&(this.worldviewDefault=m.worldview_default),m.vector_layers){this.vectorLayers=m.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const g of m.vector_layers)this.vectorLayerIds.push(g.id),m.worldview&&m.worldview[g.source]&&this.localizableLayerIds.add(g.id)}m.bounds&&(this.tileBounds=new hn(m.bounds,this.minzoom,this.maxzoom)),gi(m.tiles,this.map._requestManager._customAccessToken),this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))}t&&t(d)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return s.l({},this._options)}loadTile(t,r){const c=t.tileID.canonical.url(this.tiles,this.scheme),d=this.map._requestManager.normalizeTileURL(c),m=this.map._requestManager.transformRequest(d,s.R.Tile),g=this.map.style?this.map.style.getLut(this.scope):null,E=g?{image:g.image.clone()}:null,A={request:m,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:E,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:s.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&s.f(c)&&(A.worldview=this.map.getWorldview()||this.worldviewDefault,A.localizableLayerIds=this.localizableLayerIds),A.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=r:t.request=t.actor.send("reloadTile",A,C.bind(this));else if(t.actor=this._tileWorkers[d]=this._tileWorkers[d]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",A,C.bind(this),void 0,!0);else{const R=s.aE.call({deduped:this._deduped},A,(L,O)=>{L||!O?C.call(this,L):(A.data={cacheControl:O.cacheControl,expires:O.expires,rawData:O.rawData.slice(0)},t.actor&&t.actor.send("loadTile",A,C.bind(this),void 0,!0))},!0);t.request={cancel:R}}function C(R,L){return delete t.request,t.aborted?r(null):R&&R.status!==404?r(R):(L&&L.resourceTiming&&(t.resourceTiming=L.resourceTiming),this.map._refreshExpiredTiles&&L&&t.setExpiryData(L),t.loadVectorData(L,this.map.painter),s.aF(this.dispatcher),r(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,r){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class vs extends s.E{constructor(t,r,c,d){super(),this.id=t,this.dispatcher=c,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.l({type:"raster"},r),s.l(this,s.aA(r,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new s.A("dataloading",{dataType:"source"})),this._tileJSONRequest=ln(this._options,this.map._requestManager,null,null,(r,c)=>{this._tileJSONRequest=null,this._loaded=!0,r?this.fire(new s.z(r)):c&&(s.l(this,c),c.raster_layers&&(this.rasterLayers=c.raster_layers,this.rasterLayerIds=this.rasterLayers.map(d=>d.id)),c.bounds&&(this.tileBounds=new hn(c.bounds,this.minzoom,this.maxzoom)),gi(c.tiles),this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))),t&&t(r)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return s.l({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,r){const c=s.q.devicePixelRatio>=2,d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=s.o(this.map._requestManager.transformRequest(d,s.R.Tile),(m,g,E,A)=>(delete t.request,t.aborted?(t.state="unloaded",r(null)):m?(t.state="errored",r(m)):g?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:E,expires:A}),t.setTexture(g,this.map.painter),t.state="loaded",s.aF(this.dispatcher),void r(null)):r(null)))}abortTile(t,r){t.request&&(t.request.cancel(),delete t.request),r&&r()}unloadTile(t,r){t.texture&&t.texture instanceof s.T?(t.destroy(!0),t.texture&&t.texture instanceof s.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),r&&r()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class so extends vs{constructor(t,r,c,d){super(t,r,c,d),this.type="raster-array",this.maxzoom=22,this.partial=!0,this.iconsets={},this._options=s.l({type:"raster-array"},r)}triggerRepaint(t){const r=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);r&&r.enabled&&c&&r._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,r){const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,s.R.Tile),m={request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=d,t.actor||(t.actor=this.dispatcher.getActor());const g=(E,A,C,R)=>{if(delete t.request,t.aborted)return t.state="unloaded",r(null);if(E)return E.name==="AbortError"?void 0:(t.state="errored",r(E));if(this.map._refreshExpiredTiles&&A&&t.setExpiryData({cacheControl:C,expires:R}),this.partial)t.state="empty";else{if(!A)return r(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=A;const L=new Map;for(const O in t._mrt.layers){const V=t.getLayer(O);if(V)for(const H of V.getBandList()){const{bytes:G,tileSize:W,buffer:K}=V.getBandView(H),ie=W+2*K,oe={data:new s.r({width:ie,height:ie},G),pixelRatio:2,sdf:!1,usvg:!1,version:0};L.set(`${O}/${H}`,oe)}}for(const O in this.iconsets)this.iconsets[O].addIcons(L)}r(null)};t.request=this.partial?t.fetchHeader(void 0,g.bind(this)):t.actor.send("loadTile",m,g.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,r){const c=t.texture;c&&c instanceof s.T?(t.destroy(!0),this.map.painter.saveTileTexture(c)):(t.destroy(),t.flushQueues(),t._isHeaderLoaded=!1,delete t._mrt,delete t.textureDescriptor),t.fbo&&(t.fbo.destroy(),delete t.fbo),delete t.request,delete t.requestParams,delete t.neighboringTiles,t.state="unloaded"}prepareTile(t,r,c){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(r,c,(d,m)=>{if(d)return t.state="errored",this.fire(new s.z(d)),void this.triggerRepaint(t);m&&(t._isHeaderLoaded=!0,t.setTexture(m,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;const r=this.rasterLayers.find(({id:m})=>m===t),c=r&&r.fields,d=c&&c.bands&&c.bands;return d?d[0]:0}getTextureDescriptor(t,r,c){if(!t)return;const d=r.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!d)return;let m=null;r instanceof s.aI?m=r.paint.get("raster-array-band"):r instanceof s.aJ&&(m=r.paint.get("raster-particle-array-band"));const g=m||this.getInitialBand(d);if(g!=null)if(t.textureDescriptor){if(!t.updateNeeded(d,g)||c)return Object.assign({},t.textureDescriptor,{texture:t.texture})}else this.prepareTile(t,d,g)}addIconset(t,r){this.iconsets[t]=r,this.partial=!1}}const Th={vector:Da,raster:vs,"raster-dem":class extends vs{constructor(u,t,r,c){super(u,t,r,c),this.type="raster-dem",this.maxzoom=22,this._options=s.l({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(u,t){const r=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(d,m){d&&(u.state="errored",t(d)),m&&(u.dem=m,u.dem.onDeserialize(),u.needsHillshadePrepare=!0,u.needsDEMTextureUpload=!0,u.state="loaded",t(null))}u.request=s.o(this.map._requestManager.transformRequest(r,s.R.Tile),(function(d,m,g,E){if(delete u.request,u.aborted)u.state="unloaded",t(null);else if(d)u.state="errored",t(d);else if(m){this.map._refreshExpiredTiles&&u.setExpiryData({cacheControl:g,expires:E});const A=ImageBitmap&&m instanceof ImageBitmap&&s.t(),C=1-(m.width-s.aG(m.width))/2;C<1||u.neighboringTiles||(u.neighboringTiles=this._getNeighboringTiles(u.tileID));const R=A?m:s.q.getImageData(m,C),L={uid:u.uid,tileID:u.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:R,encoding:this.encoding,padding:C};u.actor&&u.state!=="expired"||(u.actor=this.dispatcher.getActor(),u.actor.send("loadTile",L,c.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(u){const t=u.canonical,r=Math.pow(2,t.z),c=(t.x-1+r)%r,d=t.x===0?u.wrap-1:u.wrap,m=(t.x+1+r)%r,g=t.x+1===r?u.wrap+1:u.wrap,E={};return E[new s.aH(u.overscaledZ,d,t.z,c,t.y).key]={backfilled:!1},E[new s.aH(u.overscaledZ,g,t.z,m,t.y).key]={backfilled:!1},t.y>0&&(E[new s.aH(u.overscaledZ,d,t.z,c,t.y-1).key]={backfilled:!1},E[new s.aH(u.overscaledZ,u.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},E[new s.aH(u.overscaledZ,g,t.z,m,t.y-1).key]={backfilled:!1}),t.y+1<r&&(E[new s.aH(u.overscaledZ,d,t.z,c,t.y+1).key]={backfilled:!1},E[new s.aH(u.overscaledZ,u.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},E[new s.aH(u.overscaledZ,g,t.z,m,t.y+1).key]={backfilled:!1}),E}},"raster-array":so,geojson:class extends s.E{constructor(u,t,r,c){super(),this.id=u,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=r.getActor(),this.setEventedParent(c),this._data=t.data,this._options=s.l({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const d=s.ai/this.tileSize;this.workerOptions=s.l({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*d,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*d,extent:s.ai,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:s.ai,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*d,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(u){this.map=u,this.setData(this._data)}setData(u){return this._data=u,this._updateWorkerData(),this}updateData(u){if(!this._options.dynamic)return this.fire(new s.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof u!="string"&&(u.type==="Feature"&&(u={type:"FeatureCollection",features:[u]}),u.type!=="FeatureCollection"))return this.fire(new s.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof u!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const r of this._data.features)t.set(r.id,r);for(const r of u.features)t.set(r.id,r);this._data.features=[...t.values()]}else this._data=u;return this._updateWorkerData(!0),this}getClusterExpansionZoom(u,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:u,source:this.id,scope:this.scope},t),this}getClusterChildren(u,t){return this.actor.send("geojson.getClusterChildren",{clusterId:u,source:this.id,scope:this.scope},t),this}getClusterLeaves(u,t,r,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:u,limit:t,offset:r},c),this}_updateWorkerData(u=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new s.A("dataloading",{dataType:"source"})),this._loaded=!1;const t=s.l({append:u},this.workerOptions);t.scope=this.scope;const r=this._data;typeof r=="string"?(t.request=this.map._requestManager.transformRequest(s.q.resolveURL(r),s.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(r),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(c,d)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new s.z(c));else{const m={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&d&&d.resourceTiming&&d.resourceTiming[this.id]&&(m.resourceTiming=d.resourceTiming[this.id]),u&&(this._partialReload=!0),this.fire(new s.A("data",m)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(u),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const u=s.C(this.id,this.scope);this.map.style.clearSource(u),this._updateWorkerData()}loadTile(u,t){const r=u.actor?"reloadTile":"loadTile";u.actor=this.actor;const c=this.map.style?this.map.style.getLut(this.scope):null,d=c?{image:c.image.clone()}:null,m=this._partialReload,g={type:this.type,uid:u.uid,tileID:u.tileID,tileZoom:u.tileZoom,zoom:u.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:d,scope:this.scope,pixelRatio:s.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,scaleFactor:this.map.getScaleFactor(),partial:m};u.request=this.actor.send(r,g,(E,A)=>m&&!A?(u.state="loaded",t(null)):(delete u.request,u.destroy(),u.aborted?t(null):E?t(E):(u.loadVectorData(A,this.map.painter,r==="reloadTile"),t(null))),void 0,r==="loadTile")}abortTile(u){u.request&&(u.request.cancel(),delete u.request),u.aborted=!0}unloadTile(u,t){this.actor.send("removeTile",{uid:u.uid,type:this.type,source:this.id,scope:this.scope}),u.destroy()}onRemove(u){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return s.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends s.aK{constructor(u,t,r,c){super(u,t,r,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const u=this.options;this.urls=[];for(const t of u.urls)this.urls.push(this.map._requestManager.transformRequest(t,s.R.Source).url);s.aL(this.urls,(t,r)=>{this._loaded=!0,t?this.fire(new s.z(t)):r&&(this.video=r,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(u){if(this.video){const t=this.video.seekable;u<t.start(0)||u>t.end(0)?this.fire(new s.z(new s.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=u}}getVideo(){return this.video}onAdd(u){this.map||(this.map=u,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const u=this.map.painter.context,t=u.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new s.T(u,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(u)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:s.aK,model:class extends s.E{constructor(u,t,r,c){super(),this.id=u,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const u=[];for(const t in this._options.models){const r=this._options.models[t],c=s.aN(this.map._requestManager.transformRequest(r.uri,s.R.Model).url).then(d=>{if(!d)return;const m=s.aO(d),g=new s.aP(t,r.position,r.orientation,m);g.computeBoundsAndApplyParent(),this.models.push(g)}).catch(d=>{this.fire(new s.z(new Error(`Could not load model ${t} from ${r.uri}: ${d.message}`)))});u.push(c)}return Promise.allSettled(u).then(()=>{this._loaded=!0,this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this.fire(new s.z(new Error(`Could not load models: ${t.message}`)))})}onAdd(u){this.map=u,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(u,t){}serialize(){return{type:"model"}}},"batched-model":class extends s.E{constructor(u,t,r,c){super(),this.type="batched-model",this.id=u,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=r,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(u){this.map=u,this.load()}reload(){this.cancelTileJSONRequest();const u=s.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(u))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(u){this._loaded=!1,this.fire(new s.A("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,r=this.map.getWorldview();this._tileJSONRequest=ln(this._options,this.map._requestManager,t,r,(c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),r&&r.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${r}`),this.fire(new s.z(c))):d&&(s.l(this,d),d.bounds&&(this.tileBounds=new hn(d.bounds,this.minzoom,this.maxzoom)),gi(d.tiles,this.map._requestManager._customAccessToken),this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))),u&&u(c)})}hasTransition(){return!1}hasTile(u){return!this.tileBounds||this.tileBounds.contains(u.canonical)}loaded(){return this._loaded}loadTile(u,t){const r=this.map._requestManager.normalizeTileURL(u.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(r,s.R.Tile),data:void 0,uid:u.uid,tileID:u.tileID,tileZoom:u.tileZoom,zoom:u.tileID.overscaledZ,tileSize:this.tileSize*u.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:u.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:s.q.devicePixelRatio,promoteId:this.promoteId};if(u.actor&&u.state!=="expired")if(u.state==="loading")u.reloadCallback=t;else{if(u.buckets){const m=Object.values(u.buckets);for(const g of m)g.dirty=!0;return void(u.state="loaded")}u.request=u.actor.send("reloadTile",c,d.bind(this))}else u.actor=this.dispatcher.getActor(),u.request=u.actor.send("loadTile",c,d.bind(this),void 0,!0);function d(m,g){return u.aborted?t(null):m&&m.status!==404?t(m):(this.map._refreshExpiredTiles&&g&&u.setExpiryData(g),u.loadModelData(g,this.map.painter),u.state="loaded",void t(null))}}serialize(){return s.l({},this._options)}},canvas:class extends s.aK{constructor(u,t,r,c){super(u,t,r,c),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(d=>!Array.isArray(d)||d.length!==2||d.some(m=>typeof m!="number"))||this.fire(new s.z(new s.V(`sources.${u}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.z(new s.V(`sources.${u}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new s.z(new s.V(`sources.${u}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new s.z(new s.V(`sources.${u}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.z(new s.V(`sources.${u}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(u){this.map=u,this.load(),this.canvas&&this.animate&&this.play()}onRemove(u){this.pause()}prepare(){let u=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,u=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,u=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!u&&!this._playing||this.texture instanceof s.aM||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new s.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const u of[this.canvas.width,this.canvas.height])if(isNaN(u)||u<=0)return!0;return!1}},custom:class extends s.E{constructor(u,t,r,c){super(),this.id=u,this.type="custom",this._dataType="raster",this._dispatcher=r,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new s.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new s.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new hn(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),s.l(this,s.aA(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return s.aA(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(u){this.map=u,this._loaded=!1,this.fire(new s.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(u),this.load()}onRemove(u){this._implementation.onRemove&&this._implementation.onRemove(u)}hasTile(u){if(this._implementation.hasTile){const{x:t,y:r,z:c}=u.canonical;return this._implementation.hasTile({x:t,y:r,z:c})}return!this.tileBounds||this.tileBounds.contains(u.canonical)}loadTile(u,t){const{x:r,y:c,z:d}=u.tileID.canonical,m=new AbortController;u.request=Promise.resolve(this._implementation.loadTile({x:r,y:c,z:d},{signal:m.signal})).then((function(g){return delete u.request,u.aborted?(u.state="unloaded",t(null)):g===void 0?(u.state="errored",t(null)):g===null?(this.loadTileData(u,{width:this.tileSize,height:this.tileSize,data:null}),u.state="loaded",t(null)):function(E){return E instanceof ImageData||E instanceof HTMLCanvasElement||E instanceof ImageBitmap||E instanceof HTMLImageElement}(g)?(this.loadTileData(u,g),u.state="loaded",void t(null)):(u.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(g=>{g.name!=="AbortError"&&(u.state="errored",t(g))}),u.request.cancel=()=>m.abort()}loadTileData(u,t){u.setTexture(t,this.map.painter)}unloadTile(u,t){if(u.texture&&u.texture instanceof s.T?(u.destroy(!0),u.texture&&u.texture instanceof s.T&&this.map.painter.saveTileTexture(u.texture)):u.destroy(),this._implementation.unloadTile){const{x:r,y:c,z:d}=u.tileID.canonical;this._implementation.unloadTile({x:r,y:c,z:d})}t&&t()}abortTile(u,t){u.request&&u.request.cancel&&(u.request.cancel(),delete u.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(u=>({x:u.canonical.x,y:u.canonical.y,z:u.canonical.z}))}_clearTiles(){const u=s.C(this.id,this.scope);this.map.style.clearSource(u)}_update(){this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))}}},Wc=function(u,t,r,c){const d=new Th[t.type](u,t,r,c);if(d.id!==u)throw new Error(`Expected Source id to be ${u} instead of ${d.id}`);return s.aQ(["load","abort","unload","serialize","prepare"],d),d};function Ul(u,t,r=""){return`${r}:${t.id||""}:${t.layer.id}:${function(c){if("layerId"in c)return`layer:${c.layerId}`;{const{featuresetId:d,importId:m}=c;return`featureset:${d}${m?`:import:${m}`:""}`}}(u.target)}`}function za(u,t,r,c=""){if(u.uniqueFeatureID){const d=Ul(u,t,c);if(r.has(d))return!0;r.add(d)}return!1}function Sh(u,t,r,c,d=!1){const m=t.sourceCache.transform,g=t.sourceCache.tilesIn(u,t.has3DLayers,d);g.sort(Eh);const E=[];for(const A of g){const C=A.tile.queryRenderedFeatures(t,A,r,c,m,d);Object.keys(C).length&&E.push({wrappedTileID:A.tile.tileID.wrapped().key,queryResults:C})}return E.length===0?{}:function(A){const C={},R={};for(const L of A){const O=L.queryResults,V=L.wrappedTileID,H=R[V]=R[V]||{};for(const G in O){const W=O[G],K=H[G]=H[G]||{},ie=C[G]=C[G]||[];for(const oe of W)K[oe.featureIndex]||(K[oe.featureIndex]=!0,ie.push(oe))}}return C}(E)}function Kf(u,t,r,c,d){const m={},g=c.queryRenderedSymbols(u),E=[];for(const A of Object.keys(g).map(Number))E.push(d[A]);E.sort(Eh);for(const A of E){const C=A.featureIndex.lookupSymbolFeatures(g[A.bucketInstanceId],A.bucketIndex,A.sourceLayerIndex,t,r);for(const R in C){const L=m[R]=m[R]||[],O=C[R];O.sort((V,H)=>{const G=A.featureSortOrder;if(G){const W=G.indexOf(V.featureIndex);return G.indexOf(H.featureIndex)-W}return H.featureIndex-V.featureIndex});for(const V of O)L.push(V)}}return m}function Yf(u,t){const r=u.getRenderableIds().map(m=>u.getTileByID(m)),c=[],d={};for(let m=0;m<r.length;m++){const g=r[m],E=g.tileID.canonical.key;d[E]||(d[E]=!0,g.querySourceFeatures(c,t))}return c}function Eh(u,t){const r=u.tileID,c=t.tileID;return r.overscaledZ-c.overscaledZ||r.canonical.y-c.canonical.y||r.wrap-c.wrap||r.canonical.x-c.canonical.x}function La(u,t){const r={};if(!t)return r;for(const c of u){const d=c.layerIds.map(m=>t.getLayer(m)).filter(Boolean);if(d.length!==0){c.layers=d,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map(m=>d.filter(g=>g.id===m)[0]));for(const m of d)r[m.fqid]=c}}return r}const ss=32,zs=33,zo=new Uint16Array(8184);for(let u=0;u<2046;u++){let t=u+2,r=0,c=0,d=0,m=0,g=0,E=0;for(1&t?d=m=g=ss:r=c=E=ss;(t>>=1)>1;){const C=r+d>>1,R=c+m>>1;1&t?(d=r,m=c,r=g,c=E):(r=d,c=m,d=g,m=E),g=C,E=R}const A=4*u;zo[A+0]=r,zo[A+1]=c,zo[A+2]=d,zo[A+3]=m}const os=new Uint16Array(2178),Hn=new Uint8Array(1089),Oa=new Uint16Array(1089);function Mh(u){return u===0?-.03125:u===32?.03125:0}const Xc={type:2,extent:s.ai,loadGeometry:()=>[[new s.P(0,0),new s.P(s.ai+1,0),new s.P(s.ai+1,s.ai+1),new s.P(0,s.ai+1),new s.P(0,0)]]};class Ls{constructor(t,r,c,d,m){this.tileID=t,this.uid=s.aW(),this.uses=0,this.tileSize=r,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=m,d&&d.style&&(this._lastUpdatedBrightness=d.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection)}registerFadeDuration(t){const r=t+this.timeAdded;r<s.q.now()||this.fadeEndTime&&r<this.fadeEndTime||(this.fadeEndTime=r)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=s.aR(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,r,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=La(t.buckets,r.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const m=this.buckets[d];if(m instanceof s.aY){if(this.hasSymbolBuckets=!0,!c)break;m.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const m=this.buckets[d];if(m instanceof s.aY&&m.hasRTLText){this.hasRTLText=!0,s.aZ();break}}this.queryPadding=0;for(const d in this.buckets){const m=this.buckets[d],g=r.style.getOwnLayer(d);if(!g)continue;const E=g.queryRadius(m);this.queryPadding=Math.max(this.queryPadding,E)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new s.aX}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,r,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,La(t.buckets,r.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const d in this.buckets){const m=this.buckets[d];m.uploadPending()&&m.upload(t)}const r=t.gl,c=this.imageAtlas;c&&!c.uploaded&&(this.imageAtlasTexture=new s.T(t,c.image,r.RGBA8,{useMipmap:!!c.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new s.T(t,this.glyphAtlasImage,r.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new s.T(t,this.lineAtlas.image,r.R8),this.lineAtlas.uploaded=!0)}prepare(t,r,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!r||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const d=r.style.getBrightness();(this._lastUpdatedBrightness||d)&&(this._lastUpdatedBrightness&&d&&Math.abs(this._lastUpdatedBrightness-d)<.001||(this.updateBuckets(r,this._lastUpdatedBrightness!==d),this._lastUpdatedBrightness=d))}queryRenderedFeatures(t,r,c,d,m,g){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const E=function(A,C){const R=s.ad.mat4.fromScaling([],[.5*A.width,.5*-A.height,1]);return s.ad.mat4.translate(R,R,[1,-1,0]),s.ad.mat4.multiply(R,R,A.calculateProjMatrix(C.toUnwrapped())),Float32Array.from(R)}(m,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:r,pixelPosMatrix:E,transform:d,availableImages:c,tileTransform:this.tileTransform})}querySourceFeatures(t,r){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const d=c.loadVTLayers(),m=r?r.sourceLayer:"",g=d._geojsonTileLayer||d[m];if(!g)return;const E=s.a_(r&&r.filter),{z:A,x:C,y:R}=this.tileID.canonical,L={z:A,x:C,y:R};for(let O=0;O<g.length;O++){const V=g.feature(O);if(E.needGeometry){const W=s.a$(V,!0);if(!E.filter(new s.aa(this.tileID.overscaledZ),W,this.tileID.canonical))continue}else if(!E.filter(new s.aa(this.tileID.overscaledZ),V))continue;const H=c.getId(V,m),G=new s.b0(V,A,C,R,H);G.tile=L,t.push(G)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const r=this.expirationTime;if(t.cacheControl){const c=s.b1(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let d=!1;if(this.expirationTime>c)d=!1;else if(r)if(this.expirationTime<r)d=!0;else{const m=this.expirationTime-r;m?this.expirationTime=c+Math.max(m,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,r){if(!this.latestFeatureIndex||!t.style)return;const c=this.latestFeatureIndex.loadVTLayers(),d=t.style.listImages(),m=t.style.getBrightness();for(const g in this.buckets){if(!t.style.hasLayer(g))continue;const E=this.buckets[g],A=E.layers[0],C=A.sourceLayer||"_geojsonTileLayer",R=c[C],L=t.style.getLayerSourceCache(A);let O={};L&&(O=L._state.getState(C,void 0));const V=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},H=Object.keys(O).length>0&&!r;H&&!E.stateDependentLayers.length&&!r||E.update(O,R,d,V,H?E.stateDependentLayers:E.layers,r,m),(E instanceof s.b2||E instanceof s.b3)&&t._terrain&&t._terrain.enabled&&L&&E.uploadPending()&&t._terrain._clearRenderCacheForTile(L.id,this.tileID);const G=t&&t.style&&t.style.getOwnLayer(g);G&&(this.queryPadding=Math.max(this.queryPadding,G.queryRadius(E)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<s.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=s.q.now()+t}setTexture(t,r){const c=r.context,d=c.gl;this.texture=this.texture||r.getTileTexture(t.width),this.texture&&this.texture instanceof s.T?this.texture.update(t):(this.texture=new s.T(c,t,d.RGBA8,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE))}setDependencies(t,r){const c={};for(const d of r)c[d]=!0;this.dependencies[t]=c}hasDependency(t,r){for(const c of t){const d=this.dependencies[c];if(d){for(const m of r)if(d[m])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,r){if(!r||r.name==="mercator"||this._tileDebugBuffer)return;const c=s.b4(Xc,this.tileID.canonical,this.tileTransform)[0],d=new s.b5,m=new s.b6;for(let g=0;g<c.length;g++){const{x:E,y:A}=c[g];d.emplaceBack(E,A),m.emplaceBack(g)}m.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(m),this._tileDebugBuffer=t.createVertexBuffer(d,s.b7.members),this._tileDebugSegments=s.b8.simpleSegment(0,0,d.length,m.length)}_makeTileBoundsBuffers(t,r){if(this._tileBoundsBuffer||!r||r.name==="mercator")return;const c=s.b4(Xc,this.tileID.canonical,this.tileTransform)[0];let d,m;if(this.isRaster){const g=function(E,A){const C=s.aR(E,A),R=Math.pow(2,E.z);for(let W=0;W<zs;W++)for(let K=0;K<zs;K++){const ie=s.aS((E.x+(K+Mh(K))/ss)/R),oe=s.aT((E.y+(W+Mh(W))/ss)/R),se=A.project(ie,oe),fe=W*zs+K;os[2*fe+0]=Math.round((se.x*C.scale-C.x)*s.ai),os[2*fe+1]=Math.round((se.y*C.scale-C.y)*s.ai)}Hn.fill(0),Oa.fill(0);for(let W=2045;W>=0;W--){const K=4*W,ie=zo[K+0],oe=zo[K+1],se=zo[K+2],fe=zo[K+3],ce=ie+se>>1,ue=oe+fe>>1,he=ce+ue-oe,_e=ue+ie-ce,xe=oe*zs+ie,Ue=fe*zs+se,Le=ue*zs+ce,Ye=Math.hypot((os[2*xe+0]+os[2*Ue+0])/2-os[2*Le+0],(os[2*xe+1]+os[2*Ue+1])/2-os[2*Le+1])>=16;Hn[Le]=Hn[Le]||(Ye?1:0),W<1022&&(Hn[Le]=Hn[Le]||Hn[(oe+_e>>1)*zs+(ie+he>>1)]||Hn[(fe+_e>>1)*zs+(se+he>>1)])}const L=new s.aU,O=new s.aV;let V=0;function H(W,K){const ie=K*zs+W;return Oa[ie]===0&&(L.emplaceBack(os[2*ie+0],os[2*ie+1],W*s.ai/ss,K*s.ai/ss),Oa[ie]=++V),Oa[ie]-1}function G(W,K,ie,oe,se,fe){const ce=W+ie>>1,ue=K+oe>>1;if(Math.abs(W-se)+Math.abs(K-fe)>1&&Hn[ue*zs+ce])G(se,fe,W,K,ce,ue),G(ie,oe,se,fe,ce,ue);else{const he=H(W,K),_e=H(ie,oe),xe=H(se,fe);O.emplaceBack(he,_e,xe)}}return G(0,0,ss,ss,ss,0),G(ss,ss,0,0,0,ss),{vertices:L,indices:O}}(this.tileID.canonical,r);d=g.vertices,m=g.indices}else{d=new s.aU,m=new s.aV;for(const{x:E,y:A}of c)d.emplaceBack(E,A,0,0);const g=s.b9(d.int16,void 0,4);for(let E=0;E<g.length;E+=3)m.emplaceBack(g[E],g[E+1],g[E+2])}this._tileBoundsBuffer=t.createVertexBuffer(d,s.ba.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(m),this._tileBoundsSegments=s.b8.simpleSegment(0,0,d.length,m.length)}_makeGlobeTileDebugBuffers(t,r){const c=r.projection;if(!c||c.name!=="globe"||r.freezeTileCoverage)return;const d=this.tileID.canonical,m=s.bb(d,r),g=s.bc(m),E=s.ag(r.zoom);let A;E>0&&(A=s.ad.mat4.invert(new Float64Array(16),r.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,d,r,g,A,E),this._makeGlobeTileDebugTextBuffer(t,d,r,g,A,E)}_globePoint(t,r,c,d,m,g,E){let A=s.bd(t,r,c);if(g){const C=1<<c.z,R=s.av(d.center.lng),L=s.aC(d.center.lat),O=(c.x+.5)/C-R;let V=0;O>.5?V=-1:O<-.5&&(V=1);let H=(t/s.ai+c.x)/C+V,G=(r/s.ai+c.y)/C;H=(H-R)*d._pixelsPerMercatorPixel+R,G=(G-L)*d._pixelsPerMercatorPixel+L;const W=[H*d.worldSize,G*d.worldSize,0];s.ad.vec3.transformMat4(W,W,g),A=s.be(A,W,E)}return s.ad.vec3.transformMat4(A,A,m)}_makeGlobeTileDebugBorderBuffer(t,r,c,d,m,g){const E=new s.b5,A=new s.b6,C=new s.bf,R=(O,V,H,G,W)=>{const K=(H-O)/(W-1),ie=(G-V)/(W-1),oe=E.length;for(let se=0;se<W;se++){const fe=O+se*K,ce=V+se*ie;E.emplaceBack(fe,ce);const ue=this._globePoint(fe,ce,r,c,d,m,g);C.emplaceBack(ue[0],ue[1],ue[2]),A.emplaceBack(oe+se)}},L=s.ai;R(0,0,L,0,16),R(L,0,L,L,16),R(L,L,0,L,16),R(0,L,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(A),this._tileDebugBuffer=t.createVertexBuffer(E,s.b7.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(C,s.bg.members),this._tileDebugSegments=s.b8.simpleSegment(0,0,E.length,A.length)}_makeGlobeTileDebugTextBuffer(t,r,c,d,m,g){const E=s.ai/4,A=new s.b5,C=new s.aV,R=new s.bf,L=25;C.reserve(32),A.reserve(L),R.reserve(L);const O=(V,H)=>L*V+H;for(let V=0;V<L;V++){const H=V*E;for(let G=0;G<L;G++){const W=G*E;A.emplaceBack(W,H);const K=this._globePoint(W,H,r,c,d,m,g);R.emplaceBack(K[0],K[1],K[2])}}for(let V=0;V<4;V++)for(let H=0;H<4;H++){const G=O(V,H),W=O(V,H+1),K=O(V+1,H),ie=O(V+1,H+1);C.emplaceBack(G,W,K),C.emplaceBack(K,W,ie)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(C),this._tileDebugTextBuffer=t.createVertexBuffer(A,s.b7.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(R,s.bg.members),this._tileDebugTextSegments=s.b8.simpleSegment(0,0,L,32)}destroy(t=!1){for(const r in this.buckets)this.buckets[r].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof s.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}s.bh.setPbf(s.bi);class Vn extends Ls{constructor(t,r,c,d,m){super(t,r,c,d,m),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexture(t,r){const c=r.context,d=c.gl;this.texture=this.texture||r.getTileTexture(t.width),this.texture&&this.texture instanceof s.T?this.texture.update(t,{premultiply:!1}):this.texture=new s.T(c,t,d.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(t=16384,r){const c=this._mrt=new s.bh(30),d=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=s.bj(d,(m,g,E,A)=>{if(m)r(m);else try{const C=c.getHeaderLength(g);if(C>t)return void(this.request=this.fetchHeader(C,r));c.parseHeader(g),this._isHeaderLoaded=!0;let R=0;for(const L of Object.values(c.layers))R=Math.max(R,L.dataIndex[L.dataIndex.length-1].lastByte);g.byteLength>=R&&(this.entireBuffer=g),r(null,this.entireBuffer||g,E,A)}catch(C){r(C)}}),this.request}fetchBand(t,r,c){const d=this._mrt;if(!this._isHeaderLoaded||!d)return void c(new Error("Tile header is not ready"));const m=this.actor;if(!m)return void c(new Error("Can't fetch tile band without an actor"));let g;const E=(L,O)=>{g.complete(L,O),L?c(L):(this.updateTextureDescriptor(t,r),c(null,this.textureDescriptor&&this.textureDescriptor.img))},A=(L,O)=>{if(L)return c(L);const V=m.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:O,task:g},E,void 0,!0);this._workQueue.push(()=>{V&&V.cancel(),g.cancel()})},C=d.getLayer(t);if(!C)return void c(new Error(`Unknown sourceLayer "${t}"`));if(C.hasDataForBand(r))return this.updateTextureDescriptor(t,r),void c(null,this.textureDescriptor?this.textureDescriptor.img:null);const R=C.getDataRange([r]);if(g=d.createDecodingTask(R),!g||g.tasks.length)if(this.flushQueues(),this.entireBuffer)A(null,this.entireBuffer.slice(R.firstByte,R.lastByte+1));else{const L=Object.assign({},this.requestParams,{headers:{Range:`bytes=${R.firstByte}-${R.lastByte}`}}),O=s.bj(L,A);this._fetchQueue.push(()=>{O.cancel(),g.cancel()})}else c(null)}updateNeeded(t,r){return(!this.textureDescriptor||this.textureDescriptor.band!==r||this.textureDescriptor.layer!==t)&&this.state!=="errored"}updateTextureDescriptor(t,r){if(!this._mrt)return;const c=this._mrt.getLayer(t);if(!c||!c.hasBand(r)||!c.hasDataForBand(r))return;const{bytes:d,tileSize:m,buffer:g,offset:E,scale:A}=c.getBandView(r),C=m+2*g,R=new s.r({width:C,height:C},d),L=this.texture;L&&L instanceof s.T&&L.update(R,{premultiply:!1}),this.textureDescriptor={layer:t,band:r,img:R,buffer:g,offset:E,tileSize:m,format:c.pixelFormat,mix:[A,256*A,65536*A,16777216*A]}}}class Jf{constructor(t,r){this.max=t,this.onRemove=r,this.reset()}reset(){for(const t in this.data)for(const r of this.data[t])r.timeout&&clearTimeout(r.timeout),this.onRemove(r.value);return this.data={},this.order=[],this}add(t,r,c){const d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const m={value:r,timeout:void 0};if(c!==void 0&&(m.timeout=setTimeout(()=>{this.remove(t,m)},c)),this.data[d].push(m),this.order.push(d),this.order.length>this.max){const g=this._getAndRemoveByKey(this.order[0]);g&&this.onRemove(g)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const r=this.data[t].shift();return r.timeout&&clearTimeout(r.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),r.value}getByKey(t){const r=this.data[t];return r?r[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,r){if(!this.has(t))return this;const c=t.wrapped().key,d=r===void 0?0:this.data[c].indexOf(r),m=this.data[c][d];return this.data[c].splice(d,1),m.timeout&&clearTimeout(m.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(m.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const r=this._getAndRemoveByKey(this.order[0]);r&&this.onRemove(r)}return this}filter(t){const r=[];for(const c in this.data)for(const d of this.data[c])t(d.value)||r.push(d);for(const c of r)this.remove(c.value.tileID,c)}}class Ah{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,r,c){const d=String(r);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},s.l(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(const m in this.state[t])m!==d&&(this.deletedStates[t][m]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(const m in this.state[t][d])c[m]||(this.deletedStates[t][d][m]=null)}else for(const m in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][m]===null&&delete this.deletedStates[t][d][m]}removeFeatureState(t,r,c){if(this.deletedStates[t]===null)return;const d=String(r);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&r!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(r!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,r){const c=this.state[t]||{},d=this.stateChanges[t]||{},m=this.deletedStates[t];if(m===null)return{};if(r!==void 0){const E=String(r),A=s.l({},c[E],d[E]);if(m){const C=m[r];if(C===null)return{};for(const R in C)delete A[R]}return A}const g=s.l({},c,d);if(m)for(const E in m)delete g[E];return g}initializeTileState(t,r){t.refreshFeatureState(r)}coalesceChanges(t,r){const c={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const m={};for(const g in this.stateChanges[d])this.state[d][g]||(this.state[d][g]={}),s.l(this.state[d][g],this.stateChanges[d][g]),m[g]=this.state[d][g];c[d]=m}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const m={};if(this.deletedStates[d]===null)for(const g in this.state[d])m[g]={},this.state[d][g]={};else for(const g in this.deletedStates[d]){if(this.deletedStates[d][g]===null)this.state[d][g]={};else if(this.state[d][g])for(const E of Object.keys(this.deletedStates[d][g]))delete this.state[d][g][E];m[g]=this.state[d][g]}c[d]=c[d]||{},s.l(c[d],m)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(const d in t)t[d].refreshFeatureState(r)}}class xs extends s.E{constructor(t,r,c){super(),this.id=t,this._onlySymbols=c,r.on("data",d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),r.on("error",()=>{this._sourceErrored=!0}),this._source=r,this._tiles={},this._cache=new Jf(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=r.minTileCacheSize,this._maxTileCacheSize=r.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Ah,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,r){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,r)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const r in this._tiles){const c=this._tiles[r];c.upload(t),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(tr).map(t=>t.key)}getRenderableIds(t,r){const c=[];for(const d in this._tiles)this._isIdRenderable(+d,t,r)&&c.push(this._tiles[d]);return t?c.sort((d,m)=>{const g=d.tileID,E=m.tileID,A=new s.P(g.canonical.x,g.canonical.y)._rotate(this.transform.angle),C=new s.P(E.canonical.x,E.canonical.y)._rotate(this.transform.angle);return g.overscaledZ-E.overscaledZ||C.y-A.y||C.x-A.x}).map(d=>d.tileID.key):c.map(d=>d.tileID).sort(tr).map(d=>d.key)}hasRenderableParent(t){const r=this.findLoadedParent(t,0);return!!r&&this._isIdRenderable(r.tileID.key)}_isIdRenderable(t,r,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(r||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,r){const c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=r),this._loadTile(c,this._tileLoaded.bind(this,c,t,r)))}_tileLoaded(t,r,c,d){if(d)if(t.state="errored",d.status!==404)this._source.fire(new s.z(d,{tile:t}));else{if(this._source.fire(new s.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const m=this.map.painter.terrain;this.update(this.transform,m.getScaledDemTileSize(),!0),m.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=s.q.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(r,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new s.A("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const r=this.getRenderableIds();for(let d=0;d<r.length;d++){const m=r[d];if(t.neighboringTiles&&t.neighboringTiles[m]){const g=this.getTileByID(m);c(t,g),c(g,t)}}function c(d,m){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let g=m.tileID.canonical.x-d.tileID.canonical.x;const E=m.tileID.canonical.y-d.tileID.canonical.y,A=Math.pow(2,d.tileID.canonical.z),C=m.tileID.key;g===0&&E===0||Math.abs(E)>1||(Math.abs(g)>1&&(Math.abs(g+A)===1?g+=A:Math.abs(g-A)===1&&(g-=A)),m.dem&&d.dem&&(d.dem.backfillBorder(m.dem,g,E),d.neighboringTiles&&d.neighboringTiles[C]&&(d.neighboringTiles[C].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,r,c,d){for(const m in this._tiles){let g=this._tiles[m];if(d[m]||!g.hasData()||g.tileID.overscaledZ<=r||g.tileID.overscaledZ>c)continue;let E=g.tileID;for(;g&&g.tileID.overscaledZ>r+1;){const C=g.tileID.scaledTo(g.tileID.overscaledZ-1);g=this._tiles[C.key],g&&g.hasData()&&(E=C)}let A=E;for(;A.overscaledZ>r;)if(A=A.scaledTo(A.overscaledZ-1),t[A.key]){d[E.key]=E;break}}}findLoadedParent(t,r){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=r?c:null}for(let c=t.overscaledZ-1;c>=r;c--){const d=t.scaledTo(c),m=this._getLoadedTile(d);if(m)return m}}_getLoadedTile(t){const r=this._tiles[t.key];return r&&r.hasData()?r:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,r){r=r||this._source.tileSize;const c=Math.ceil(t.width/r)+1,d=Math.ceil(t.height/r)+1,m=Math.floor(c*d*5),g=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,m):m,E=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,g):g;this._cache.setMaxSize(E)}handleWrapJump(t){const r=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,r){const c={};for(const d in this._tiles){const m=this._tiles[d];m.tileID=m.tileID.unwrapTo(m.tileID.wrap+r),c[m.tileID.key]=m}this._tiles=c;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(t,r,c,d){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,r),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const m=this._source.type==="batched-model";let g,E=this._source.maxzoom;const A=this.map&&this.map.painter?this.map.painter._terrain:null;if(A&&A.sourceCache===this&&A.attenuationRange()){const L=A.attenuationRange()[0],O=Math.floor(L)-Math.log2(A.getDemUpscale());E>O&&(E=O)}if(this.used||this.usedForTerrain){if(this._source.tileID)g=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(L=>new s.aH(L.canonical.z,L.wrap,L.canonical.z,L.canonical.x,L.canonical.y));else if(this.tileCoverLift!==0){const L=t.clone();L.tileCoverLift=this.tileCoverLift,g=L.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:E,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:m}),this._source.minzoom<=1&&t.projection.name==="globe"&&(g.push(new s.aH(1,0,1,0,0)),g.push(new s.aH(1,0,1,1,0)),g.push(new s.aH(1,0,1,0,1)),g.push(new s.aH(1,0,1,1,1)))}else if(g=t.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:E,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:m}),this._source.hasTile){const L=this._source.hasTile.bind(this._source);g=g.filter(O=>L(O))}}else g=[];if(g.length>0&&this.castsShadows&&d&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Ih(this._source.type)){const L=t.coveringZoomLevel({tileSize:r||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),O=Math.min(L,this._source.maxzoom);if(m){const V=t.extendTileCover(g,O);for(const H of V)g.push(H)}else{const V=t.extendTileCover(g,O,d);for(const H of V)this._shadowCasterTiles[H.key]=!0,g.push(H)}}const C=this._updateRetainedTiles(g);if(Ih(this._source.type)&&g.length!==0){const L={},O={},V=Object.keys(C);for(const G of V){const W=C[G],K=this._tiles[G];if(!K||K.fadeEndTime&&K.fadeEndTime<=s.q.now())continue;const ie=this.findLoadedParent(W,Math.max(W.overscaledZ-xs.maxOverzooming,this._source.minzoom));ie&&(this._addTile(ie.tileID),L[ie.tileID.key]=ie.tileID),O[G]=W}const H=g[g.length-1].overscaledZ;for(const G in this._tiles){const W=this._tiles[G];if(C[G]||!W.hasData())continue;let K=W.tileID;for(;K.overscaledZ>H;){K=K.scaledTo(K.overscaledZ-1);const ie=this._tiles[K.key];if(ie&&ie.hasData()&&O[K.key]){C[G]=W.tileID;break}}}for(const G in L)C[G]||(this._coveredTiles[G]=!0,C[G]=L[G])}for(const L in C)this._tiles[L].clearFadeHold();const R=s.bk(this._tiles,C);for(const L of R){const O=this._tiles[L];O.hasSymbolBuckets&&!O.holdingForFade()?O.setHoldDuration(this.map._fadeDuration):O.hasSymbolBuckets&&!O.symbolFadeFinished()||this._removeTile(+L)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const r={};if(t.length===0)return r;const c={},d=t.reduce((C,R)=>Math.min(C,R.overscaledZ),1/0),m=t[0].overscaledZ,g=Math.max(m-xs.maxOverzooming,this._source.minzoom),E=Math.max(m+xs.maxUnderzooming,this._source.minzoom),A={};for(const C of t){const R=this._addTile(C);r[C.key]=C,R.hasData()||d<this._source.maxzoom&&(A[C.key]=C)}this._retainLoadedChildren(A,d,E,r);for(const C of t){let R=this._tiles[C.key];if(R.hasData())continue;if(C.canonical.z>=this._source.maxzoom){const O=C.children(this._source.maxzoom)[0],V=this.getTile(O);if(V&&V.hasData()){r[O.key]=O;continue}}else{const O=C.children(this._source.maxzoom);if(r[O[0].key]&&r[O[1].key]&&r[O[2].key]&&r[O[3].key])continue}let L=R.wasRequested();for(let O=C.overscaledZ-1;O>=g;--O){const V=C.scaledTo(O);if(c[V.key]||(c[V.key]=!0,R=this.getTile(V),!R&&L&&(R=this._addTile(V)),R&&(r[V.key]=V,L=R.wasRequested(),R.hasData())))break}}return r}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const r=[];let c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}r.push(d.key);const m=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(m),c)break;d=m}for(const m of r)this._loadedParentTiles[m]=c}}_addTile(t){let r=this._tiles[t.key];if(r)return r.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),r;r=this._cache.getAndRemove(t),r&&(this._setTileReloadTimer(t.key,r),r.tileID=t,this._state.initializeTileState(r,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,r)));const c=!!r;if(!c){const d=this.map?this.map.painter:null,m=this._source.tileSize*t.overscaleFactor();r=this._source.type==="raster-array"?new Vn(t,m,this.transform.tileZoom,d,this._isRaster):new Ls(t,m,this.transform.tileZoom,d,this._isRaster),this._loadTile(r,this._tileLoaded.bind(this,r,t.key,r.state))}return r?(r.uses++,this._tiles[t.key]=r,c||this._source.fire(new s.A("dataloading",{tile:r,coord:r.tileID,dataType:"source"})),r):null}_setTileReloadTimer(t,r){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=r.getExpiryTimeout();c&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},c))}_removeTile(t){const r=this._tiles[t];r&&(r.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),r.uses>0||(r.hasData()&&r.state!=="reloading"||r.state==="empty"?this._cache.add(r.tileID,r,r.getExpiryTimeout()):(r.aborted=!0,this._abortTile(r),this._unloadTile(r))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,r,c){const d=[],m=this.transform;if(!m)return d;const g=m.projection.name==="globe",E=s.av(m.center.lng);for(const A in this._tiles){const C=this._tiles[A];if(c&&C.clearQueryDebugViz(),C.holdingForFade())continue;let R;if(g){const L=C.tileID.canonical;if(L.z===0){const O=[Math.abs(s.ay(E,...Xt(L,-1))-E),Math.abs(s.ay(E,...Xt(L,1))-E)];R=[0,2*O.indexOf(Math.min(...O))-1]}else{const O=[Math.abs(s.ay(E,...Xt(L,-1))-E),Math.abs(s.ay(E,...Xt(L,0))-E),Math.abs(s.ay(E,...Xt(L,1))-E)];R=[O.indexOf(Math.min(...O))-1]}}else R=[0];for(const L of R){const O=t.containsTile(C,m,r,L);O&&d.push(O)}}return d}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,r){const c=this.getRenderableIds(t,r).map(m=>this._tiles[m].tileID),d=this.transform.projection.name==="globe";for(const m of c)m.projMatrix=this.transform.calculateProjMatrix(m.toUnwrapped()),m.expandedProjMatrix=d?this.transform.calculateProjMatrix(m.toUnwrapped(),!1,!0):m.projMatrix;return c}sortCoordinatesByDistance(t){const r=t.slice(),c=this.transform._camera.position,d=this.transform._camera.forward(),m={};for(const g of r){const E=1/(1<<g.canonical.z);m[g.key]=((g.canonical.x+.5)*E+g.wrap-c[0])*d[0]+((g.canonical.y+.5)*E-c[1])*d[1]-c[2]*d[2]}return r.sort((g,E)=>m[g.key]-m[E.key]),r}hasTransition(){if(this._source.hasTransition())return!0;if(Ih(this._source.type))for(const t in this._tiles){const r=this._tiles[t];if(r.fadeEndTime!==void 0&&r.fadeEndTime>=s.q.now())return!0}return!1}setFeatureState(t,r,c){this._state.updateState(t=t||"_geojsonTileLayer",r,c)}removeFeatureState(t,r,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",r,c)}getFeatureState(t,r){return this._state.getState(t=t||"_geojsonTileLayer",r)}setDependencies(t,r,c){const d=this._tiles[t];d&&d.setDependencies(r,c)}reloadTilesForDependencies(t,r){for(const c in this._tiles)this._tiles[c].hasDependency(t,r)&&this._reloadTile(+c,"reloading");this._cache.filter(c=>!c.hasDependency(t,r))}_preloadTiles(t,r){if(!this._sourceLoaded){const A=()=>{this._sourceLoaded&&(this._source.off("data",A),this._preloadTiles(t,r))};return void this._source.on("data",A)}const c=new Map,d=Array.isArray(t)?t:[t],m=this.map.painter.terrain,g=this.usedForTerrain&&m?m.getScaledDemTileSize():this._source.tileSize;for(const A of d){const C=A.coveringTiles({tileSize:g,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const R of C)c.set(R.key,R);this.usedForTerrain&&A.updateElevation(!1)}const E=Array.from(c.values());s.bl(E,(A,C)=>{const R=new Ls(A,this._source.tileSize*A.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(R,L=>{this._source.type==="raster-dem"&&R.dem&&this._backfillDEM(R),C(L,R)})},r)}}function tr(u,t){const r=Math.abs(2*u.wrap)-+(u.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return u.overscaledZ-t.overscaledZ||c-r||t.canonical.y-u.canonical.y||t.canonical.x-u.canonical.x}function Ih(u){return u==="raster"||u==="image"||u==="video"||u==="custom"}function Xt(u,t){const r=1<<u.z;return[u.x/r+t,(u.x+1)/r+t]}xs.maxOverzooming=10,xs.maxUnderzooming=3;class Qf{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,r=!1;for(const c in this.style._mergedLayers){const d=this.style._mergedLayers[c];if(d.type==="fill-extrusion")this.layers.push({layer:d,visible:t,visibilityChanged:r});else if(d.type==="model"){const m=this.style.getLayerSource(d);m&&m.type==="batched-model"&&this.layers.push({layer:d,visible:t,visibilityChanged:r})}}}onNewFrame(t){this.layersGotHidden=!1;for(const r of this.layers){const c=r.layer;let d=!1;c.type==="fill-extrusion"?d=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:c.type==="model"&&(d=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!d&&r.visible,r.visible=d}}updateZOffset(t,r){this.currentBuildingBuckets=[];for(const d of this.layers){const m=d.layer,g=this.style.getLayerSourceCache(m);let E=1;m.type==="fill-extrusion"&&(E=d.visible?m.paint.get("fill-extrusion-vertical-scale"):0);let A=g?g.getTile(r):null;if(!A&&g&&r.canonical.z>g.getSource().minzoom){let C=r.scaledTo(Math.min(g.getSource().maxzoom,r.overscaledZ-1));for(;C.overscaledZ>=g.getSource().minzoom&&(A=g.getTile(C),!A&&C.overscaledZ!==0);)C=C.scaledTo(C.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:A?A.getBucket(m):null,tileID:A?A.tileID:r,verticalScale:E})}t.hasAnyZOffset=!1;let c=!1;for(let d=0;d<t.symbolInstances.length;d++){const m=t.symbolInstances.get(d),g=m.zOffset,E=this._getHeightAtTileOffset(r,m.tileAnchorX,m.tileAnchorY);m.zOffset=E!==Number.NEGATIVE_INFINITY?E:g,c||g===m.zOffset||(c=!0),t.hasAnyZOffset||m.zOffset===0||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,r,c,d){let m=r,g=c;if(t.canonical.z!==d.canonical.z){const E=d.canonical,A=1/(1<<t.canonical.z-E.z);m=(r+t.canonical.x*s.ai)*A-E.x*s.ai|0,g=(c+t.canonical.y*s.ai)*A-E.y*s.ai|0}return{tileX:m,tileY:g}}_getHeightAtTileOffset(t,r,c){let d,m;for(let g=0;g<this.layers.length;++g){if(this.layers[g].layer.type!=="fill-extrusion")continue;const{bucket:E,tileID:A,verticalScale:C}=this.currentBuildingBuckets[g];if(!E)continue;const{tileX:R,tileY:L}=this._mapCoordToOverlappingTile(t,r,c,A),O=E.getHeightAtTileCoord(R,L);O&&O.height!==void 0&&(O.hidden?d=O.height:m=Math.max(O.height*C,m||0))}if(m!==void 0)return m;for(let g=0;g<this.layers.length;++g){const E=this.layers[g];if(E.layer.type!=="model"||!E.visible)continue;const{bucket:A,tileID:C}=this.currentBuildingBuckets[g];if(!A)continue;const{tileX:R,tileY:L}=this._mapCoordToOverlappingTile(t,r,c,C),O=A.getHeightAtTileCoord(R,L);if(O&&!O.hidden)return O.height===void 0&&d!==void 0?Math.min(O.maxHeight,d)*O.verticalScale:O.height?O.height*O.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function ep(u,t){const r={};for(const c in u)c!=="ref"&&(r[c]=u[c]);return s.bm.forEach(c=>{c in t&&(r[c]=t[c])}),r}function jl(u){u=u.slice();const t=Object.create(null);for(let r=0;r<u.length;r++)t[u[r].id]=u[r];for(let r=0;r<u.length;r++)"ref"in u[r]&&(u[r]=ep(u[r],t[u[r].ref]));return u}const qi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function bs(u,t,r){r.push({command:qi.addSource,args:[u,t[u]]})}function Kc(u,t,r){t.push({command:qi.removeSource,args:[u]}),r[u]=!0}function ka(u,t,r,c){Kc(u,r,c),bs(u,t,r)}function Ft(u,t,r){let c;for(c in u[r])if(u[r].hasOwnProperty(c)&&c!=="data"&&!s.bn(u[r][c],t[r][c]))return!1;for(c in t[r])if(t[r].hasOwnProperty(c)&&c!=="data"&&!s.bn(u[r][c],t[r][c]))return!1;return!0}function Ki(u,t,r,c,d,m){let g;for(g in t=t||{},u=u||{})u.hasOwnProperty(g)&&(s.bn(u[g],t[g])||r.push({command:m,args:[c,g,t[g],d]}));for(g in t)t.hasOwnProperty(g)&&!u.hasOwnProperty(g)&&(s.bn(u[g],t[g])||r.push({command:m,args:[c,g,t[g],d]}))}function Fi(u){return u.id}function An(u,t){return u[t.id]=t,u}class Fa{constructor(t,r){this.reset(t,r)}reset(t,r){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(r||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=s.ay(t,0,1);let r=1,c=this._distances[r];const d=t*this.paddedLength+this.padding;for(;c<d&&r<this._distances.length;)c=this._distances[++r];const m=r-1,g=this._distances[m],E=c-g,A=E>0?(d-g)/E:0;return this.points[m].mult(1-A).add(this.points[r].mult(A))}}class $i{constructor(t,r,c){const d=this.boxCells=[],m=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(r/c);for(let g=0;g<this.xCellCount*this.yCellCount;g++)d.push([]),m.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=r,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/r,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,r,c,d,m){this._forEachCell(r,c,d,m,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(r),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(m)}insertCircle(t,r,c,d){this._forEachCell(r-d,c-d,r+d,c+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(r),this.circles.push(c),this.circles.push(d)}_insertBoxCell(t,r,c,d,m,g){this.boxCells[m].push(g)}_insertCircleCell(t,r,c,d,m,g){this.circleCells[m].push(g)}_query(t,r,c,d,m,g){if(c<0||t>this.width||d<0||r>this.height)return!m&&[];const E=[];if(t<=0&&r<=0&&this.width<=c&&this.height<=d){if(m)return!0;for(let A=0;A<this.boxKeys.length;A++)E.push({key:this.boxKeys[A],x1:this.bboxes[4*A],y1:this.bboxes[4*A+1],x2:this.bboxes[4*A+2],y2:this.bboxes[4*A+3]});for(let A=0;A<this.circleKeys.length;A++){const C=this.circles[3*A],R=this.circles[3*A+1],L=this.circles[3*A+2];E.push({key:this.circleKeys[A],x1:C-L,y1:R-L,x2:C+L,y2:R+L})}return g?E.filter(g):E}return this._forEachCell(t,r,c,d,this._queryCell,E,{hitTest:m,seenUids:{box:{},circle:{}}},g),m?E.length>0:E}_queryCircle(t,r,c,d,m){const g=t-c,E=t+c,A=r-c,C=r+c;if(E<0||g>this.width||C<0||A>this.height)return!d&&[];const R=[];return this._forEachCell(g,A,E,C,this._queryCellCircle,R,{hitTest:d,circle:{x:t,y:r,radius:c},seenUids:{box:{},circle:{}}},m),d?R.length>0:R}query(t,r,c,d,m){return this._query(t,r,c,d,!1,m)}hitTest(t,r,c,d,m){return this._query(t,r,c,d,!0,m)}hitTestCircle(t,r,c,d){return this._queryCircle(t,r,c,!0,d)}_queryCell(t,r,c,d,m,g,E,A){const C=E.seenUids,R=this.boxCells[m];if(R!==null){const O=this.bboxes;for(const V of R)if(!C.box[V]){C.box[V]=!0;const H=4*V;if(t<=O[H+2]&&r<=O[H+3]&&c>=O[H+0]&&d>=O[H+1]&&(!A||A(this.boxKeys[V]))){if(E.hitTest)return g.push(!0),!0;g.push({key:this.boxKeys[V],x1:O[H],y1:O[H+1],x2:O[H+2],y2:O[H+3]})}}}const L=this.circleCells[m];if(L!==null){const O=this.circles;for(const V of L)if(!C.circle[V]){C.circle[V]=!0;const H=3*V;if(this._circleAndRectCollide(O[H],O[H+1],O[H+2],t,r,c,d)&&(!A||A(this.circleKeys[V]))){if(E.hitTest)return g.push(!0),!0;{const G=O[H],W=O[H+1],K=O[H+2];g.push({key:this.circleKeys[V],x1:G-K,y1:W-K,x2:G+K,y2:W+K})}}}}}_queryCellCircle(t,r,c,d,m,g,E,A){const C=E.circle,R=E.seenUids,L=this.boxCells[m];if(L!==null){const V=this.bboxes;for(const H of L)if(!R.box[H]){R.box[H]=!0;const G=4*H;if(this._circleAndRectCollide(C.x,C.y,C.radius,V[G+0],V[G+1],V[G+2],V[G+3])&&(!A||A(this.boxKeys[H])))return g.push(!0),!0}}const O=this.circleCells[m];if(O!==null){const V=this.circles;for(const H of O)if(!R.circle[H]){R.circle[H]=!0;const G=3*H;if(this._circlesCollide(V[G],V[G+1],V[G+2],C.x,C.y,C.radius)&&(!A||A(this.circleKeys[H])))return g.push(!0),!0}}}_forEachCell(t,r,c,d,m,g,E,A){const C=this._convertToXCellCoord(t),R=this._convertToYCellCoord(r),L=this._convertToXCellCoord(c),O=this._convertToYCellCoord(d);for(let V=C;V<=L;V++)for(let H=R;H<=O;H++)if(m.call(this,t,r,c,d,this.xCellCount*H+V,g,E,A))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,r,c,d,m,g){const E=d-t,A=m-r,C=c+g;return C*C>E*E+A*A}_circleAndRectCollide(t,r,c,d,m,g,E){const A=(g-d)/2,C=Math.abs(t-(d+A));if(C>A+c)return!1;const R=(E-m)/2,L=Math.abs(r-(m+R));if(L>R+c)return!1;if(C<=A||L<=R)return!0;const O=C-A,V=L-R;return O*O+V*V<=c*c}}const oo={unknown:0,flipRequired:1,flipNotRequired:2},Gl=Math.tan(85*Math.PI/180);function ao(u,t,r,c,d,m,g){const E=s.ad.mat4.create();if(r)if(m.name==="globe"){const A=s.bo(d,t);s.ad.mat4.multiply(E,E,A)}else{const A=s.ad.mat2.invert([],g);E[0]=A[0],E[1]=A[1],E[4]=A[2],E[5]=A[3],c||s.ad.mat4.rotateZ(E,E,d.angle)}else s.ad.mat4.multiply(E,d.labelPlaneMatrix,u);return E}function vn(u,t,r,c,d,m,g){const E=ao(u,t,r,c,d,m,g);return m.name==="globe"&&r||(E[2]=E[6]=E[10]=E[14]=0),E}function Nr(u,t,r,c,d,m,g){if(r){if(m.name==="globe"){const E=ao(u,t,r,c,d,m,g);return s.ad.mat4.invert(E,E),s.ad.mat4.multiply(E,u,E),E}{const E=s.ad.mat4.clone(u),A=s.ad.mat4.identity([]);return A[0]=g[0],A[1]=g[1],A[4]=g[2],A[5]=g[3],s.ad.mat4.multiply(E,E,A),c||s.ad.mat4.rotateZ(E,E,-d.angle),E}}return d.glCoordMatrix}function Os(u,t,r,c){const d=[u,t,r,1];r?s.ad.vec4.transformMat4(d,d,c):Yr(d,d,c);const m=d[3];return d[0]/=m,d[1]/=m,d[2]/=m,d}function Ba(u,t){return Math.min(.5+u/t*.5,1.5)}function Ch(u,t){const r=u[0]/u[3],c=u[1]/u[3];return r>=-t[0]&&r<=t[0]&&c>=-t[1]&&c<=t[1]}function Na(u,t,r,c,d,m,g,E,A,C){const R=r.transform,L=c?u.textSizeData:u.iconSizeData,O=s.bp(L,r.transform.zoom),V=R.projection.name==="globe",H=[256/r.width*2+1,256/r.height*2+1],G=c?u.text.dynamicLayoutVertexArray:u.icon.dynamicLayoutVertexArray;G.clear();let W=null;V&&(W=c?u.text.globeExtVertexArray:u.icon.globeExtVertexArray);const K=u.lineVertexArray,ie=c?u.text.placedSymbolArray:u.icon.placedSymbolArray,oe=r.transform.width/r.transform.height;let se,fe=!1;for(let ce=0;ce<ie.length;ce++){const ue=ie.get(ce),{numGlyphs:he,writingMode:_e}=ue;if(_e!==s.bq.vertical||fe||se===s.bq.horizontal||(fe=!0),se=_e,(ue.hidden||_e===s.bq.vertical)&&!fe){ks(he,G);continue}fe=!1;const xe=new s.P(ue.tileAnchorX,ue.tileAnchorY);let{x:Ue,y:Le,z:Ye}=R.projection.projectTilePoint(xe.x,xe.y,C.canonical);if(A){const[yt,wt,Ot]=A(xe);Ue+=yt,Le+=wt,Ye+=Ot}const Je=[Ue,Le,Ye,1];if(s.ad.vec4.transformMat4(Je,Je,t),!Ch(Je,H)){ks(he,G);continue}const at=Je[3],De=Ba(r.transform.getCameraToCenterDistance(R.projection),at),Ke=s.br(L,O,ue),Ie=g?Ke/De:Ke*De,Xe=Os(Ue,Le,Ye,d);if(Xe[3]<=0){ks(he,G);continue}let He={};const Qe=s.ak(u.layers[0].layout.get("text-max-angle")),je=Math.cos(Qe),it=g?null:A,_t=In(ue,Ie,!1,E,t,d,m,u.glyphOffsetArray,K,G,W,Xe,xe,He,oe,it,R.projection,C,g,je);fe=_t.useVertical,it&&_t.needsFlipping&&(He={}),(_t.notEnoughRoom||fe||_t.needsFlipping&&In(ue,Ie,!0,E,t,d,m,u.glyphOffsetArray,K,G,W,Xe,xe,He,oe,it,R.projection,C,g,je).notEnoughRoom)&&ks(he,G)}c?(u.text.dynamicLayoutVertexBuffer.updateData(G),W&&u.text.globeExtVertexBuffer&&u.text.globeExtVertexBuffer.updateData(W)):(u.icon.dynamicLayoutVertexBuffer.updateData(G),W&&u.icon.globeExtVertexBuffer&&u.icon.globeExtVertexBuffer.updateData(W))}function Yc(u,t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W){const{lineStartIndex:K,glyphStartIndex:ie,segment:oe}=E,se=ie+E.numGlyphs,fe=K+E.lineLength,ce=t.getoffsetX(ie),ue=t.getoffsetX(se-1),he=$l(u*ce,r,c,d,m,g,oe,K,fe,A,C,R,L,O,!0,V,H,G,W);if(!he)return null;const _e=$l(u*ue,r,c,d,m,g,oe,K,fe,A,C,R,L,O,!0,V,H,G,W);return _e?{first:he,last:_e}:null}function ql(u,t,r,c){return u===s.bq.horizontal&&Math.abs(c)>Math.abs(r)?{useVertical:!0}:u===s.bq.vertical?c>0?{needsFlipping:!0}:null:t!==oo.unknown&&function(d,m){return d===0||Math.abs(m/d)>Gl}(r,c)?t===oo.flipRequired?{needsFlipping:!0}:null:r<0?{needsFlipping:!0}:null}function In(u,t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W,K,ie,oe){const se=t/24,fe=u.lineOffsetX*se,ce=u.lineOffsetY*se,{lineStartIndex:ue,glyphStartIndex:he,numGlyphs:_e,segment:xe,writingMode:Ue,flipState:Le}=u,Ye=ue+u.lineLength,Je=at=>{if(R){const[Xe,He,Qe]=at.up,je=C.length;s.bs(R,je+0,Xe,He,Qe),s.bs(R,je+1,Xe,He,Qe),s.bs(R,je+2,Xe,He,Qe),s.bs(R,je+3,Xe,He,Qe)}const[De,Ke,Ie]=at.point;s.bt(C,De,Ke,Ie,at.angle)};if(_e>1){const at=Yc(se,E,fe,ce,r,L,O,u,A,m,V,G,!1,W,K,ie,oe);if(!at)return{notEnoughRoom:!0};if(c&&!r){let[De,Ke,Ie]=at.first.point,[Xe,He,Qe]=at.last.point;[De,Ke]=Os(De,Ke,Ie,g),[Xe,He]=Os(Xe,He,Qe,g);const je=ql(Ue,Le,(Xe-De)*H,He-Ke);if(u.flipState=je&&je.needsFlipping?oo.flipRequired:oo.flipNotRequired,je)return je}Je(at.first);for(let De=he+1;De<he+_e-1;De++){const Ke=$l(se*E.getoffsetX(De),fe,ce,r,L,O,xe,ue,Ye,A,m,V,G,!1,!1,W,K,ie,oe);if(!Ke)return C.length-=4*(De-he),{notEnoughRoom:!0};Je(Ke)}Je(at.last)}else{if(c&&!r){const De=Os(O.x,O.y,0,d),Ke=ue+xe+1,Ie=new s.P(A.getx(Ke),A.gety(Ke)),Xe=Os(Ie.x,Ie.y,0,d),He=Xe[3]>0?Xe:Cn(O,Ie,De,1,d,void 0,W,K.canonical),Qe=ql(Ue,Le,(He[0]-De[0])*H,He[1]-De[1]);if(u.flipState=Qe&&Qe.needsFlipping?oo.flipRequired:oo.flipNotRequired,Qe)return Qe}const at=$l(se*E.getoffsetX(he),fe,ce,r,L,O,xe,ue,Ye,A,m,V,G,!1,!1,W,K,ie,oe);if(!at)return{notEnoughRoom:!0};Je(at)}return{}}function Zs(u,t,r,c,d){const{x:m,y:g,z:E}=c.projectTilePoint(u.x,u.y,t);if(!d)return Os(m,g,E,r);const[A,C,R]=d(u);return Os(m+A,g+C,E+R,r)}function Cn(u,t,r,c,d,m,g,E){const A=Zs(u.sub(t)._unit()._add(u),E,d,g,m);return s.ad.vec3.sub(A,r,A),s.ad.vec3.normalize(A,A),s.ad.vec3.scaleAndAdd(A,r,A,c)}function $l(u,t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W,K,ie){const oe=c?u-t:u+t;let se=oe>0?1:-1,fe=0;c&&(se*=-1,fe=Math.PI),se<0&&(fe+=Math.PI);let ce=E+g+(se>0?0:1)|0,ue=d,he=d,_e=0,xe=0;const Ue=Math.abs(oe),Le=[],Ye=[];let Je=m,at=Je,De=s.ad.vec3.zero([]);const Ke=()=>Cn(at,Je,he,Ue-_e+1,R,O,G,W.canonical);for(;_e+xe<=Ue;){if(ce+=se,ce<E||ce>=A)return null;if(he=ue,at=Je,Le.push(he),V&&Ye.push(at),Je=new s.P(C.getx(ce),C.gety(ce)),ue=L[ce],!ue){const Ot=Zs(Je,W.canonical,R,G,O);ue=Ot[3]>0?L[ce]=Ot:Ke()}_e+=xe;const yt=s.ad.vec3.sub([],ue,he),wt=s.ad.vec3.distance(he,ue);if(r&&wt>0&&xe>0&&s.ad.vec3.dot(De,yt)/(xe*wt)<ie)return null;xe=wt,De=yt}H&&O&&(L[ce]&&(ue=Ke(),xe=s.ad.vec3.distance(he,ue),De=s.ad.vec3.sub([],ue,he)),L[ce]=ue);const Ie=(Ue-_e)/xe,Xe=Je.sub(at)._mult(Ie)._add(at),He=s.ad.vec3.scaleAndAdd([],he,De,Ie);let Qe=[0,0,1],je=De[0],it=De[1];if(K&&(Qe=G.upVector(W.canonical,Xe.x,Xe.y),Qe[0]!==0||Qe[1]!==0||Qe[2]!==1)){const yt=[Qe[2],0,-Qe[0]],wt=s.ad.vec3.cross([],Qe,yt);s.ad.vec3.normalize(yt,yt),s.ad.vec3.normalize(wt,wt),je=s.ad.vec3.dot(De,yt),it=s.ad.vec3.dot(De,wt)}if(r){const yt=s.ad.vec3.cross([],Qe,De);s.ad.vec3.normalize(yt,yt),s.ad.vec3.scaleAndAdd(He,He,yt,r*se)}const _t=fe+Math.atan2(it,je);return Le.push(He),V&&Ye.push(Xe),{point:He,angle:_t,path:Le,tilePath:Ye,up:Qe}}function ks(u,t){const r=t.length,c=r+4*u;t.resize(c),t.float32.fill(-1/0,4*r,4*c)}function Yr(u,t,r){const c=t[0],d=t[1];return u[0]=r[0]*c+r[4]*d+r[12],u[1]=r[1]*c+r[5]*d+r[13],u[3]=r[3]*c+r[7]*d+r[15],u}const cn=100;class lo{constructor(t,r,c=new $i(t.width+200,t.height+200,25),d=new $i(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=d,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+cn,this.screenBottomBoundary=t.height+cn,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=r}placeCollisionBox(t,r,c,d,m,g,E,A){let C=c.projectedAnchorX,R=c.projectedAnchorY,L=c.projectedAnchorZ;const O=c.elevation,V=c.tileID,H=t.getProjection();if(O&&V){const[ce,ue,he]=H.upVector(V.canonical,c.tileAnchorX,c.tileAnchorY),_e=H.upVectorScale(V.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;C+=ce*O*_e,R+=ue*O*_e,L+=he*O*_e}const G=this.projectAndGetPerspectiveRatio(E,C,R,L,c.tileID,H.name==="globe"||!!O||this.transform.pitch>0,H),W=g*G.perspectiveRatio,K=(c.x1*r+d.x-c.padding)*W+G.point.x,ie=(c.y1*r+d.y-c.padding)*W+G.point.y,oe=(c.x2*r+d.x+c.padding)*W+G.point.x,se=(c.y2*r+d.y+c.padding)*W+G.point.y,fe=G.perspectiveRatio<=.55||G.occluded;return!this.isInsideGrid(K,ie,oe,se)||!m&&this.grid.hitTest(K,ie,oe,se,A)||fe?{box:[],offscreen:!1,occluded:G.occluded}:{box:[K,ie,oe,se],offscreen:this.isOffscreen(K,ie,oe,se),occluded:!1}}placeCollisionCircles(t,r,c,d,m,g,E,A,C,R,L,O,V,H,G){const W=[],K=this.transform.elevation,ie=t.getProjection(),oe=K?K.getAtTileOffsetFunc(G,this.transform.center.lat,this.transform.worldSize,ie):null,se=new s.P(c.tileAnchorX,c.tileAnchorY);let{x:fe,y:ce,z:ue}=ie.projectTilePoint(se.x,se.y,G.canonical);if(oe){const[Qe,je,it]=oe(se);fe+=Qe,ce+=je,ue+=it}const he=ie.name==="globe",_e=this.projectAndGetPerspectiveRatio(E,fe,ce,ue,G,he||!!K||this.transform.pitch>0,ie),{perspectiveRatio:xe}=_e,Ue=(L?g/xe:g*xe)/s.bw,Le=Os(fe,ce,ue,A),Ye=c.lineOffsetX*Ue,Je=c.lineOffsetY*Ue,at=s.ak(t.layers[0].layout.get("text-max-angle")),De=Math.cos(at),Ke=_e.signedDistanceFromCamera>0?Yc(Ue,m,Ye,Je,!1,Le,se,c,d,A,{},K&&!L?oe:null,L&&!!K,ie,G,L,De):null;let Ie=!1,Xe=!1,He=!0;if(Ke&&!_e.occluded){const Qe=.5*V*xe+H,je=new s.P(-100,-100),it=new s.P(this.screenRightBoundary,this.screenBottomBoundary),_t=new Fa,{first:yt,last:wt}=Ke,Ot=yt.path.length;let si=[];for(let Yt=Ot-1;Yt>=1;Yt--)si.push(yt.path[Yt]);for(let Yt=1;Yt<wt.path.length;Yt++)si.push(wt.path[Yt]);const Wt=2.5*Qe;C&&(si=si.map(([Yt,Ii,Wi],dr)=>(oe&&!he&&(Wi=oe(dr<Ot-1?yt.tilePath[Ot-1-dr]:wt.tilePath[dr-Ot+2])[2]),Os(Yt,Ii,Wi,C))),si.some(Yt=>Yt[3]<=0)&&(si=[]));let ii=[];if(si.length>0){let Yt=1/0,Ii=-1/0,Wi=1/0,dr=-1/0;for(const wi of si)Yt=Math.min(Yt,wi[0]),Wi=Math.min(Wi,wi[1]),Ii=Math.max(Ii,wi[0]),dr=Math.max(dr,wi[1]);Ii>=je.x&&Yt<=it.x&&dr>=je.y&&Wi<=it.y&&(ii=[si.map(wi=>new s.P(wi[0],wi[1]))],(Yt<je.x||Ii>it.x||Wi<je.y||dr>it.y)&&(ii=s.bu(ii,je.x,je.y,it.x,it.y)))}for(const Yt of ii){_t.reset(Yt,.25*Qe);let Ii=0;Ii=_t.length<=.5*Qe?1:Math.ceil(_t.paddedLength/Wt)+1;for(let Wi=0;Wi<Ii;Wi++){const dr=Wi/Math.max(Ii-1,1),wi=_t.lerp(dr),Sr=wi.x+cn,ci=wi.y+cn;W.push(Sr,ci,Qe,0);const kt=Sr-Qe,Ri=ci-Qe,ir=Sr+Qe,Bi=ci+Qe;if(He=He&&this.isOffscreen(kt,Ri,ir,Bi),Xe=Xe||this.isInsideGrid(kt,Ri,ir,Bi),!r&&this.grid.hitTestCircle(Sr,ci,Qe,O)&&(Ie=!0,!R))return{circles:[],offscreen:!1,collisionDetected:Ie,occluded:!1}}}}return{circles:!R&&Ie||!Xe?[]:W,offscreen:He,collisionDetected:Ie,occluded:_e.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const r=[];let c=1/0,d=1/0,m=-1/0,g=-1/0;for(const R of t){const L=new s.P(R.x+cn,R.y+cn);c=Math.min(c,L.x),d=Math.min(d,L.y),m=Math.max(m,L.x),g=Math.max(g,L.y),r.push(L)}const E=this.grid.query(c,d,m,g).concat(this.ignoredGrid.query(c,d,m,g)),A={},C={};for(const R of E){const L=R.key;if(A[L.bucketInstanceId]===void 0&&(A[L.bucketInstanceId]={}),A[L.bucketInstanceId][L.featureIndex])continue;const O=[new s.P(R.x1,R.y1),new s.P(R.x2,R.y1),new s.P(R.x2,R.y2),new s.P(R.x1,R.y2)];s.bv(r,O)&&(A[L.bucketInstanceId][L.featureIndex]=!0,C[L.bucketInstanceId]===void 0&&(C[L.bucketInstanceId]=[]),C[L.bucketInstanceId].push(L.featureIndex))}return C}insertCollisionBox(t,r,c,d,m){(r?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:d,collisionGroupID:m},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,r,c,d,m){const g=r?this.ignoredGrid:this.grid,E={bucketInstanceId:c,featureIndex:d,collisionGroupID:m};for(let A=0;A<t.length;A+=4)g.insertCircle(E,t[A],t[A+1],t[A+2])}projectAndGetPerspectiveRatio(t,r,c,d,m,g,E){const A=[r,c,d,1];let C=!1;d||this.transform.pitch>0?(s.ad.vec4.transformMat4(A,A,t),this.fogState&&m&&E.name!=="globe"&&(C=function(O,V,H,G,W,K){const ie=K.calculateFogTileMatrix(W),oe=[V,H,G];return s.ad.vec3.transformMat4(oe,oe,ie),Rt(O,s.ad.vec3.length(oe),K.pitch,K._fov)}(this.fogState,r,c,d,m.toUnwrapped(),this.transform)>.9)):Yr(A,A,t);const R=A[3];return{point:new s.P((A[0]/R+1)/2*this.transform.width+cn,(-A[1]/R+1)/2*this.transform.height+cn),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(E)/R*.5,1.5),signedDistanceFromCamera:R,occluded:g&&A[2]>R||C}}isOffscreen(t,r,c,d){return c<cn||t>=this.screenRightBoundary||d<cn||r>this.screenBottomBoundary}isInsideGrid(t,r,c,d){return c>=0&&t<this.gridRightBoundary&&d>=0&&r<this.gridBottomBoundary}getViewportMatrix(){const t=s.ad.mat4.identity([]);return s.ad.mat4.translate(t,t,[-100,-100,0]),t}}function Ur(u,t,r){const c=t.createTileMatrix(u,u.worldSize,r.toUnwrapped());return s.ad.mat4.multiply(new Float32Array(16),u.projMatrix,c)}function Ph(u,t,r){if(t.projection.name===r.projection.name)return u.projMatrix;const c=r.clone();return c.setProjection(t.projection),Ur(c,t.getProjection(),u)}function as(u,t,r){return t.name===r.projection.name?u.projMatrix:Ur(r,t,u)}class Va{constructor(t,r,c,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?r:-r))):d&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Lo{constructor(t,r,c,d,m,g=!1){this.text=new Va(t?t.text:null,r,c,m),this.icon=new Va(t?t.icon:null,r,d,m),this.clipped=g}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class co{constructor(t,r,c,d=!1){this.text=t,this.icon=r,this.skipFade=c,this.clipped=d}}class P_{constructor(){this.invProjMatrix=s.ad.mat4.create(),this.viewportMatrix=s.ad.mat4.create(),this.circles=[]}}class uo{constructor(t,r,c,d,m){this.bucketInstanceId=t,this.featureIndex=r,this.sourceLayerIndex=c,this.bucketIndex=d,this.tileID=m}}class R_{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const r=++this.maxGroupID;this.collisionGroups[t]={ID:r,predicate:c=>c.collisionGroupID===r}}return this.collisionGroups[t]}}function Jc(u,t,r,c,d){const{horizontalAlign:m,verticalAlign:g}=s.bD(u),E=-(m-.5)*t,A=-(g-.5)*r,C=s.bC(u,c);return new s.P(E+C[0]*d,A+C[1]*d)}function kn(u,t,r,c,d){const m=new s.P(u,t);return r&&m._rotate(c?d:-d),m}class D_{constructor(t,r,c,d,m,g){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new lo(this.transform,m),this.buildingIndex=g,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=r,this.retainedQueryData={},this.collisionGroups=new R_(c),this.collisionCircleArrays={},this.prevPlacement=d,d&&(d.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,r,c,d,m=1){const g=c.getBucket(r),E=c.latestFeatureIndex;if(!g||!E||r.fqid!==g.layerIds[0])return;const A=g.layers[0].layout,C=g.layers[0].paint,R=c.collisionBoxArray,L=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),O=c.tileSize/s.ai,V=c.tileID.toUnwrapped();this.transform.setProjection(g.projection);const H=(G=c.tileID,W=g.getProjection(),K=this.transform,W.name===this.projection?K.calculateProjMatrix(G.toUnwrapped()):Ur(K,W,G));var G,W,K;const ie=A.get("text-pitch-alignment")==="map",oe=A.get("text-rotation-alignment")==="map";r.compileFilter(r.options);const se=r.dynamicFilter(),fe=r.dynamicFilterNeedsFeature(),ce=this.transform.calculatePixelsToTileUnitsMatrix(c),ue=vn(H,c.tileID.canonical,ie,oe,this.transform,g.getProjection(),ce);let he=null;if(ie){const Ke=Nr(H,c.tileID.canonical,ie,oe,this.transform,g.getProjection(),ce);he=s.ad.mat4.multiply([],this.transform.labelPlaneMatrix,Ke)}let _e=null;se&&c.latestFeatureIndex&&(_e={unwrappedTileID:V,dynamicFilter:se,dynamicFilterNeedsFeature:fe}),this.retainedQueryData[g.bucketInstanceId]=new uo(g.bucketInstanceId,E,g.sourceLayerIndex,g.index,c.tileID);const[xe,Ue]=g.layers[0].layout.get("text-size-scale-range"),Le=s.ay(m,xe,Ue),[Ye,Je]=A.get("icon-size-scale-range"),at=s.ay(m,Ye,Je),De={bucket:g,layout:A,paint:C,posMatrix:H,textLabelPlaneMatrix:ue,labelToScreenMatrix:he,clippingData:_e,scale:L,textPixelRatio:O,holdingForFade:c.holdingForFade(),collisionBoxArray:R,partiallyEvaluatedTextSize:s.bp(g.textSizeData,this.transform.zoom,Le),partiallyEvaluatedIconSize:s.bp(g.iconSizeData,this.transform.zoom,at),collisionGroup:this.collisionGroups.get(g.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(d)for(const Ke of g.sortKeyRanges){const{sortKey:Ie,symbolInstanceStart:Xe,symbolInstanceEnd:He}=Ke;t.push({sortKey:Ie,symbolInstanceStart:Xe,symbolInstanceEnd:He,parameters:De})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:g.symbolInstances.length,parameters:De})}attemptAnchorPlacement(t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W,K,ie){const{textOffset0:oe,textOffset1:se,crossTileID:fe}=O,ce=[oe,se],ue=Jc(t,c,d,ce,m),he=this.collisionIndex.placeCollisionBox(H,m,r,kn(ue.x,ue.y,g,E,this.transform.angle),L,A,C,R.predicate);if(W){const _e=H.getSymbolInstanceIconSize(ie,this.transform.zoom,O.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(H,_e,W,kn(ue.x,ue.y,g,E,this.transform.angle),L,A,C,R.predicate).box.length===0)return}if(he.box.length>0){let _e;return this.prevPlacement&&this.prevPlacement.variableOffsets[fe]&&this.prevPlacement.placements[fe]&&this.prevPlacement.placements[fe].text&&(_e=this.prevPlacement.variableOffsets[fe].anchor),this.variableOffsets[fe]={textOffset:ce,width:c,height:d,anchor:t,textScale:m,prevAnchor:_e},this.markUsedJustification(H,t,O,G),H.allowVerticalPlacement&&(this.markUsedOrientation(H,G,O),this.placedOrientations[fe]=G),{shift:ue,placedGlyphBoxes:he}}}placeLayerBucketPart(t,r,c,d,m=1){const{bucket:g,layout:E,paint:A,posMatrix:C,textLabelPlaneMatrix:R,labelToScreenMatrix:L,clippingData:O,textPixelRatio:V,holdingForFade:H,collisionBoxArray:G,partiallyEvaluatedTextSize:W,partiallyEvaluatedIconSize:K,collisionGroup:ie,latestFeatureIndex:oe}=t.parameters,se=E.get("text-optional"),fe=E.get("icon-optional"),ce=E.get("text-allow-overlap"),ue=E.get("icon-allow-overlap"),he=E.get("text-rotation-alignment")==="map",_e=E.get("text-pitch-alignment")==="map",xe=A.get("symbol-z-offset"),Ue=E.get("symbol-elevation-reference")==="sea",[Le,Ye]=E.get("text-size-scale-range"),[Je,at]=E.get("icon-size-scale-range"),De=s.ay(m,Le,Ye),Ke=s.ay(m,Je,at);this.transform.setProjection(g.projection);let Ie=ce&&(ue||!g.hasIconData()||fe),Xe=ue&&(ce||!g.hasTextData()||se);const He=!xe.isConstant();!g.collisionArrays&&G&&g.deserializeCollisionBoxes(G),c&&d&&g.updateCollisionDebugBuffers(this.transform.zoom,G,De,Ke);const Qe=(je,it,_t)=>{const{crossTileID:yt,numVerticalGlyphVertices:wt}=je;let Ot=null;if(O&&O.dynamicFilterNeedsFeature||He){const Li=this.retainedQueryData[g.bucketInstanceId];Ot=oe.loadFeature({featureIndex:je.featureIndex,bucketIndex:Li.bucketIndex,sourceLayerIndex:Li.sourceLayerIndex,layoutVertexArrayOffset:0})}if(O&&!(0,O.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Ot,this.retainedQueryData[g.bucketInstanceId].tileID.canonical,new s.P(je.tileAnchorX,je.tileAnchorY),this.transform.calculateDistanceTileData(O.unwrappedTileID)))return this.placements[yt]=new co(!1,!1,!1,!0),void r.add(yt);const si=xe.evaluate(Ot,{});if(r.has(yt))return;if(H)return void(this.placements[yt]=new co(!1,!1,!1));let Wt=!1,ii=!1,Yt=!0,Ii=!1,Wi=!1,dr=null,wi={box:null,offscreen:null,occluded:null},Sr={box:null},ci=null,kt=null,Ri=null,ir=0,Bi=0,Rr=0;_t.textFeatureIndex?ir=_t.textFeatureIndex:je.useRuntimeCollisionCircles&&(ir=je.featureIndex),_t.verticalTextFeatureIndex&&(Bi=_t.verticalTextFeatureIndex);const $r=Li=>{Li.tileID=this.retainedQueryData[g.bucketInstanceId].tileID;const Er=this.transform.elevation;Li.elevation=Ue?si:si+(Er?Er.getAtTileOffset(Li.tileID,Li.tileAnchorX,Li.tileAnchorY):0),Li.elevation+=je.zOffset},tn=_t.textBox;if(tn){$r(tn);const Li=Xi=>{let lr=s.bq.horizontal;if(g.allowVerticalPlacement&&!Xi&&this.prevPlacement){const pn=this.prevPlacement.placedOrientations[yt];pn&&(this.placedOrientations[yt]=pn,lr=pn,this.markUsedOrientation(g,lr,je))}return lr},Er=(Xi,lr)=>{if(g.allowVerticalPlacement&&wt>0&&_t.verticalTextBox){for(const pn of g.writingModes)if(pn===s.bq.vertical?(wi=lr(),Sr=wi):wi=Xi(),wi&&wi.box&&wi.box.length)break}else wi=Xi()};if(E.get("text-variable-anchor")){let Xi=E.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[yt]){const yr=this.prevPlacement.variableOffsets[yt];Xi.indexOf(yr.anchor)>0&&(Xi=Xi.filter(rn=>rn!==yr.anchor),Xi.unshift(yr.anchor))}const lr=(yr,rn,Js)=>{const Yn=g.getSymbolInstanceTextSize(W,je,this.transform.zoom,it),Ms=(yr.x2-yr.x1)*Yn+2*yr.padding,Gn=(yr.y2-yr.y1)*Yn+2*yr.padding,As=je.hasIconTextFit&&!ue?rn:null;As&&$r(As);let Jn={box:[],offscreen:!1,occluded:!1};const bo=ce?2*Xi.length:Xi.length;for(let Qs=0;Qs<bo;++Qs){const wo=this.attemptAnchorPlacement(Xi[Qs%Xi.length],yr,Ms,Gn,Yn,he,_e,V,C,ie,Qs>=Xi.length,je,it,g,Js,As,W,K);if(wo&&(Jn=wo.placedGlyphBoxes,Jn&&Jn.box&&Jn.box.length)){Wt=!0,dr=wo.shift;break}}return Jn};Er(()=>lr(tn,_t.iconBox,s.bq.horizontal),()=>{const yr=_t.verticalTextBox;return yr&&$r(yr),g.allowVerticalPlacement&&!(wi&&wi.box&&wi.box.length)&&wt>0&&yr?lr(yr,_t.verticalIconBox,s.bq.vertical):{box:null,offscreen:null,occluded:null}}),wi&&(Wt=wi.box,Yt=wi.offscreen,Ii=wi.occluded);const pn=Li(!(!wi||!wi.box));if(!Wt&&this.prevPlacement){const yr=this.prevPlacement.variableOffsets[yt];yr&&(this.variableOffsets[yt]=yr,this.markUsedJustification(g,yr.anchor,je,pn))}}else{const Xi=(lr,pn)=>{const yr=g.getSymbolInstanceTextSize(W,je,this.transform.zoom,it,m),rn=this.collisionIndex.placeCollisionBox(g,yr,lr,new s.P(0,0),ce,V,C,ie.predicate);return rn&&rn.box&&rn.box.length&&(this.markUsedOrientation(g,pn,je),this.placedOrientations[yt]=pn),rn};Er(()=>Xi(tn,s.bq.horizontal),()=>{const lr=_t.verticalTextBox;return g.allowVerticalPlacement&&wt>0&&lr?($r(lr),Xi(lr,s.bq.vertical)):{box:null,offscreen:null,occluded:null}}),Li(!!(wi&&wi.box&&wi.box.length))}}if(ci=wi,Wt=ci&&ci.box&&ci.box.length>0,Yt=ci&&ci.offscreen,Ii=ci&&ci.occluded,je.useRuntimeCollisionCircles){const Li=g.text.placedSymbolArray.get(je.centerJustifiedTextSymbolIndex>=0?je.centerJustifiedTextSymbolIndex:je.verticalPlacedTextSymbolIndex),Er=s.br(g.textSizeData,W,Li),Xi=E.get("text-padding");kt=this.collisionIndex.placeCollisionCircles(g,ce,Li,g.lineVertexArray,g.glyphOffsetArray,Er,C,R,L,c,_e,ie.predicate,je.collisionCircleDiameter*Er/s.bw,Xi,this.retainedQueryData[g.bucketInstanceId].tileID),Wt=ce||kt.circles.length>0&&!kt.collisionDetected,Yt=Yt&&kt.offscreen,Ii=kt.occluded}if(_t.iconFeatureIndex&&(Rr=_t.iconFeatureIndex),_t.iconBox){const Li=Er=>{$r(Er);const Xi=je.hasIconTextFit&&dr?kn(dr.x,dr.y,he,_e,this.transform.angle):new s.P(0,0),lr=g.getSymbolInstanceIconSize(K,this.transform.zoom,je.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(g,lr,Er,Xi,ue,V,C,ie.predicate)};Sr&&Sr.box&&Sr.box.length&&_t.verticalIconBox?(Ri=Li(_t.verticalIconBox),ii=Ri.box.length>0):(Ri=Li(_t.iconBox),ii=Ri.box.length>0),Yt=Yt&&Ri.offscreen,Wi=Ri.occluded}const nn=se||je.numHorizontalGlyphVertices===0&&wt===0,ds=fe||je.numIconVertices===0;if(nn||ds?ds?nn||(ii=ii&&Wt):Wt=ii&&Wt:ii=Wt=ii&&Wt,Wt&&ci&&ci.box&&this.collisionIndex.insertCollisionBox(ci.box,E.get("text-ignore-placement"),g.bucketInstanceId,Sr&&Sr.box&&Bi?Bi:ir,ie.ID),ii&&Ri&&this.collisionIndex.insertCollisionBox(Ri.box,E.get("icon-ignore-placement"),g.bucketInstanceId,Rr,ie.ID),kt&&(Wt&&this.collisionIndex.insertCollisionCircles(kt.circles,E.get("text-ignore-placement"),g.bucketInstanceId,ir,ie.ID),c)){const Li=g.bucketInstanceId;let Er=this.collisionCircleArrays[Li];Er===void 0&&(Er=this.collisionCircleArrays[Li]=new P_);for(let Xi=0;Xi<kt.circles.length;Xi+=4)Er.circles.push(kt.circles[Xi+0]),Er.circles.push(kt.circles[Xi+1]),Er.circles.push(kt.circles[Xi+2]),Er.circles.push(kt.collisionDetected?1:0)}const Pn=g.projection.name!=="globe";Ie=Ie&&(Pn||!Ii),Xe=Xe&&(Pn||!Wi),this.placements[yt]=new co(Wt||Ie,ii||Xe,Yt||g.justReloaded),r.add(yt)};if(g.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(g,this.retainedQueryData[g.bucketInstanceId].tileID),g.elevationType==="road"&&g.updateRoadElevation(),g.updateZOffset(),g.sortFeaturesByY){const je=g.getSortedSymbolIndexes(this.transform.angle);for(let it=je.length-1;it>=0;--it){const _t=je[it];Qe(g.symbolInstances.get(_t),_t,g.collisionArrays[_t])}g.hasAnyZOffset&&s.w(`${g.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(g.hasAnyZOffset){const je=g.getSortedIndexesByZOffset();for(let it=0;it<je.length;++it){const _t=je[it];Qe(g.symbolInstances.get(_t),_t,g.collisionArrays[_t])}}else for(let je=t.symbolInstanceStart;je<t.symbolInstanceEnd;je++)Qe(g.symbolInstances.get(je),je,g.collisionArrays[je]);if(c&&g.bucketInstanceId in this.collisionCircleArrays){const je=this.collisionCircleArrays[g.bucketInstanceId];s.ad.mat4.invert(je.invProjMatrix,C),je.viewportMatrix=this.collisionIndex.getViewportMatrix()}g.justReloaded=!1}markUsedJustification(t,r,c,d){const{leftJustifiedTextSymbolIndex:m,centerJustifiedTextSymbolIndex:g,rightJustifiedTextSymbolIndex:E,verticalPlacedTextSymbolIndex:A,crossTileID:C}=c,R=s.bB(r),L=d===s.bq.vertical?A:R==="left"?m:R==="center"?g:R==="right"?E:-1;m>=0&&(t.text.placedSymbolArray.get(m).crossTileID=L>=0&&m!==L?0:C),g>=0&&(t.text.placedSymbolArray.get(g).crossTileID=L>=0&&g!==L?0:C),E>=0&&(t.text.placedSymbolArray.get(E).crossTileID=L>=0&&E!==L?0:C),A>=0&&(t.text.placedSymbolArray.get(A).crossTileID=L>=0&&A!==L?0:C)}markUsedOrientation(t,r,c){const d=r===s.bq.horizontal||r===s.bq.horizontalOnly?r:0,m=r===s.bq.vertical?r:0,{leftJustifiedTextSymbolIndex:g,centerJustifiedTextSymbolIndex:E,rightJustifiedTextSymbolIndex:A,verticalPlacedTextSymbolIndex:C}=c,R=t.text.placedSymbolArray;g>=0&&(R.get(g).placedOrientation=d),E>=0&&(R.get(E).placedOrientation=d),A>=0&&(R.get(A).placedOrientation=d),C>=0&&(R.get(C).placedOrientation=m)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const r=this.prevPlacement;let c=!1;this.prevZoomAdjustment=r?r.zoomAdjustment(this.transform.zoom):0;const d=r?r.symbolFadeChange(t):1,m=r?r.opacities:{},g=r?r.variableOffsets:{},E=r?r.placedOrientations:{};for(const A in this.placements){const C=this.placements[A],R=m[A];R?(this.opacities[A]=new Lo(R,d,C.text,C.icon,null,C.clipped),c=c||C.text!==R.text.placed||C.icon!==R.icon.placed):(this.opacities[A]=new Lo(null,d,C.text,C.icon,C.skipFade,C.clipped),c=c||C.text||C.icon)}for(const A in m){const C=m[A];if(!this.opacities[A]){const R=new Lo(C,d,!1,!1);R.isHidden()||(this.opacities[A]=R,c=c||C.text.placed||C.icon.placed)}}for(const A in g)this.variableOffsets[A]||!this.opacities[A]||this.opacities[A].isHidden()||(this.variableOffsets[A]=g[A]);for(const A in E)this.placedOrientations[A]||!this.opacities[A]||this.opacities[A].isHidden()||(this.placedOrientations[A]=E[A]);c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=r?r.lastPlacementChangeTime:t)}updateLayerOpacities(t,r,c,d){const m=new Set;for(const g of r){const E=g.getBucket(t);E&&g.latestFeatureIndex&&t.fqid===E.layerIds[0]&&(this.updateBucketOpacities(E,m,g,g.collisionBoxArray,c,d,g.tileID,t.scope),E.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(E,g.tileID),E.elevationType==="road"&&E.updateRoadElevation(),E.updateZOffset())}}updateBucketOpacities(t,r,c,d,m,g,E,A){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const C=t.layers[0].layout,R=t.layers[0].paint,L=!!t.layers[0].dynamicFilter(),O=new Lo(null,0,!1,!1,!0),V=C.get("text-allow-overlap"),H=C.get("icon-allow-overlap"),G=C.get("text-variable-anchor"),W=C.get("text-rotation-alignment")==="map",K=C.get("text-pitch-alignment")==="map",ie=R.get("symbol-z-offset"),oe=C.get("symbol-elevation-reference")==="sea",se=!ie.isConstant(),fe=new Lo(null,0,V&&(H||!t.hasIconData()||C.get("icon-optional")),H&&(V||!t.hasTextData()||C.get("text-optional")),!0);!t.collisionArrays&&d&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(d);const ce=(he,_e,xe)=>{for(let Ue=0;Ue<_e/4;Ue++)he.opacityVertexArray.emplaceBack(xe)};let ue=0;g&&t.updateReplacement(E,g);for(let he=0;he<t.symbolInstances.length;he++){const _e=t.symbolInstances.get(he),{numHorizontalGlyphVertices:xe,numVerticalGlyphVertices:Ue,crossTileID:Le,numIconVertices:Ye,tileAnchorX:Je,tileAnchorY:at}=_e;let De=null;const Ke=this.retainedQueryData[t.bucketInstanceId];se&&_e&&Ke&&(De=c.latestFeatureIndex.loadFeature({featureIndex:_e.featureIndex,bucketIndex:Ke.bucketIndex,sourceLayerIndex:Ke.sourceLayerIndex,layoutVertexArrayOffset:0}));const Ie=ie.evaluate(De,{}),Xe=r.has(Le);let He=this.opacities[Le];Xe?He=O:He||(He=fe,this.opacities[Le]=He),r.add(Le);const Qe=xe>0||Ue>0,je=Ye>0,it=this.placedOrientations[Le],_t=it===s.bq.vertical,yt=it===s.bq.horizontal||it===s.bq.horizontalOnly;!Qe&&!je||He.isHidden()||ue++;let wt=!1;if((Qe||je)&&g)for(const Ot of t.activeReplacements){if(s.bx(Ot,m,s.by.Symbol,A)||Ot.min.x>Je||Je>Ot.max.x||Ot.min.y>at||at>Ot.max.y)continue;const si=s.bz(Je,at,E.canonical,Ot.footprintTileId.canonical);if(wt=s.bA(si,Ot.footprint),wt)break}if(Qe){const Ot=wt?la:aa(He.text);ce(t.text,xe,_t?la:Ot),ce(t.text,Ue,yt?la:Ot);const si=He.text.isHidden(),{leftJustifiedTextSymbolIndex:Wt,centerJustifiedTextSymbolIndex:ii,rightJustifiedTextSymbolIndex:Yt,verticalPlacedTextSymbolIndex:Ii}=_e,Wi=t.text.placedSymbolArray,dr=si||_t?1:0;Wt>=0&&(Wi.get(Wt).hidden=dr),ii>=0&&(Wi.get(ii).hidden=dr),Yt>=0&&(Wi.get(Yt).hidden=dr),Ii>=0&&(Wi.get(Ii).hidden=si||yt?1:0);const wi=this.variableOffsets[Le];wi&&this.markUsedJustification(t,wi.anchor,_e,it);const Sr=this.placedOrientations[Le];Sr&&(this.markUsedJustification(t,"left",_e,Sr),this.markUsedOrientation(t,Sr,_e))}if(je){const Ot=wt?la:aa(He.icon),{placedIconSymbolIndex:si,verticalPlacedIconSymbolIndex:Wt}=_e,ii=t.icon.placedSymbolArray,Yt=He.icon.isHidden()?1:0;si>=0&&(ce(t.icon,Ye,_t?la:Ot),ii.get(si).hidden=Yt),Wt>=0&&(ce(t.icon,_e.numVerticalIconVertices,yt?la:Ot),ii.get(Wt).hidden=Yt)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const Ot=t.collisionArrays[he];if(Ot){let si=new s.P(0,0),Wt=!0;if(Ot.textBox||Ot.verticalTextBox){if(G){const Yt=this.variableOffsets[Le];Yt?(si=Jc(Yt.anchor,Yt.width,Yt.height,Yt.textOffset,Yt.textScale),W&&si._rotate(K?this.transform.angle:-this.transform.angle)):Wt=!1}L&&(Wt=!He.clipped),Ot.textBox&&oa(t.textCollisionBox.collisionVertexArray,He.text.placed,!Wt||_t,Ie,oe,si.x,si.y),Ot.verticalTextBox&&oa(t.textCollisionBox.collisionVertexArray,He.text.placed,!Wt||yt,Ie,oe,si.x,si.y)}const ii=Wt&&!!(!yt&&Ot.verticalIconBox);Ot.iconBox&&oa(t.iconCollisionBox.collisionVertexArray,He.icon.placed,ii,Ie,oe,_e.hasIconTextFit?si.x:0,_e.hasIconTextFit?si.y:0),Ot.verticalIconBox&&oa(t.iconCollisionBox.collisionVertexArray,He.icon.placed,!ii,Ie,oe,_e.hasIconTextFit?si.x:0,_e.hasIconTextFit?si.y:0)}}}if(t.fullyClipped=ue===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const he=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=he.invProjMatrix,t.placementViewportMatrix=he.viewportMatrix,t.collisionCircleArray=he.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,r){const c=this.zoomAtLastRecencyCheck===r?1-this.zoomAdjustment(r):1;return this.zoomAtLastRecencyCheck=r,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function oa(u,t,r,c,d,m,g){u.emplaceBack(t?1:0,r?1:0,m||0,g||0,c,d?1:0),u.emplaceBack(t?1:0,r?1:0,m||0,g||0,c,d?1:0),u.emplaceBack(t?1:0,r?1:0,m||0,g||0,c,d?1:0),u.emplaceBack(t?1:0,r?1:0,m||0,g||0,c,d?1:0)}const tp=Math.pow(2,25),Hl=Math.pow(2,24),z_=Math.pow(2,17),L_=Math.pow(2,16),Zl=Math.pow(2,9),Wl=Math.pow(2,8),O_=Math.pow(2,1);function aa(u){if(u.opacity===0&&!u.placed)return 0;if(u.opacity===1&&u.placed)return 4294967295;const t=u.placed?1:0,r=Math.floor(127*u.opacity);return r*tp+t*Hl+r*z_+t*L_+r*Zl+t*Wl+r*O_+t}const la=0;class Qc{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,r,c,d,m,g){const E=this._bucketParts;for(;this._currentTileIndex<t.length;)if(r.getBucketParts(E,d,t[this._currentTileIndex],this._sortAcrossTiles,g),this._currentTileIndex++,m())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,E.sort((A,C)=>A.sortKey-C.sortKey));this._currentPartIndex<E.length;){const A=E[this._currentPartIndex];if(r.placeLayerBucketPart(A,this._seenCrossTileIDs,c,A.symbolInstanceStart===0,g),this._currentPartIndex++,m())return!0}return!1}}class Oo{constructor(t,r,c,d,m,g,E,A,C){this.placement=new D_(t,m,g,E,A,C),this._currentPlacementIndex=r.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(t,r,c,d,m){const g=s.q.now(),E=()=>{const A=s.q.now()-g;return!this._forceFullPlacement&&A>2};for(;this._currentPlacementIndex>=0;){const A=r[t[this._currentPlacementIndex]],C=this.placement.collisionIndex.transform.zoom;if(A.type==="symbol"&&(!A.minzoom||A.minzoom<=C)&&(!A.maxzoom||A.maxzoom>C)){const R=A,L=R.layout.get("symbol-z-elevate"),O=R.layout.get("symbol-sort-key").constantOr(1)!==void 0,V=R.layout.get("symbol-z-order"),H=V==="viewport-y"||V==="auto"&&!(V!=="viewport-y"&&O),G=R.layout.get("text-allow-overlap")||R.layout.get("icon-allow-overlap")||R.layout.get("text-ignore-placement")||R.layout.get("icon-ignore-placement"),W=H&&G,K=this._inProgressLayer=this._inProgressLayer||new Qc(R),ie=s.C(A.source,A.scope);if(K.continuePlacement(L||W?d[ie]:c[ie],this.placement,this._showCollisionBoxes,A,E,m))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Rh=512/s.ai/2;class k_{constructor(t,r,c){this.tileID=t,this.bucketInstanceId=c,this.index=new s.bE(r.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const d=t.canonical.x*s.ai,m=t.canonical.y*s.ai;for(let g=0;g<r.length;g++){const{key:E,crossTileID:A,tileAnchorX:C,tileAnchorY:R}=r.get(g),L=Math.floor((d+C)*Rh),O=Math.floor((m+R)*Rh);this.index.add(L,O),this.keys.push(E),this.crossTileIDs.push(A)}this.index.finish()}findMatches(t,r,c){const d=this.tileID.canonical.z<r.canonical.z?1:Math.pow(2,this.tileID.canonical.z-r.canonical.z),m=Rh/Math.pow(2,r.canonical.z-this.tileID.canonical.z),g=r.canonical.x*s.ai,E=r.canonical.y*s.ai;for(let A=0;A<t.length;A++){const C=t.get(A);if(C.crossTileID)continue;const{key:R,tileAnchorX:L,tileAnchorY:O}=C,V=Math.floor((g+L)*m),H=Math.floor((E+O)*m),G=this.index.range(V-d,H-d,V+d,H+d);for(const W of G){const K=this.crossTileIDs[W];if(this.keys[W]===R&&!c.has(K)){c.add(K),C.crossTileID=K;break}}}}}class F_{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class ip{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const r=Math.round((t-this.lng)/360);if(r!==0)for(const c in this.indexes){const d=this.indexes[c],m={};for(const g in d){const E=d[g];E.tileID=E.tileID.unwrapTo(E.tileID.wrap+r),m[E.tileID.key]=E}this.indexes[c]=m}this.lng=t}addBucket(t,r,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===r.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let m=0;m<r.symbolInstances.length;m++)r.symbolInstances.get(m).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const d=this.usedCrossTileIDs[t.overscaledZ];for(const m in this.indexes){const g=this.indexes[m];if(Number(m)>t.overscaledZ)for(const E in g){const A=g[E];A.tileID.isChildOf(t)&&A.findMatches(r.symbolInstances,t,d)}else{const E=g[t.scaledTo(Number(m)).key];E&&E.findMatches(r.symbolInstances,t,d)}}for(let m=0;m<r.symbolInstances.length;m++){const g=r.symbolInstances.get(m);g.crossTileID||(g.crossTileID=c.generate(),d.add(g.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new k_(t,r.symbolInstances,r.bucketInstanceId),!0}removeBucketCrossTileIDs(t,r){for(const c of r.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let r=!1;for(const c in this.indexes){const d=this.indexes[c];for(const m in d)t[d[m].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,d[m]),delete d[m],r=!0)}return r}}class B_{constructor(){this.layerIndexes={},this.crossTileIDs=new F_,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,r,c,d){let m=this.layerIndexes[t.fqid];m===void 0&&(m=this.layerIndexes[t.fqid]=new ip);let g=!1;const E={};d.name!=="globe"&&m.handleWrapJump(c);for(const A of r){const C=A.getBucket(t);C&&t.fqid===C.layerIds[0]&&(C.bucketInstanceId||(C.bucketInstanceId=++this.maxBucketInstanceId),m.addBucket(A.tileID,C,this.crossTileIDs)&&(g=!0),E[C.bucketInstanceId]=!0)}return m.removeStaleBuckets(E)&&(g=!0),g}pruneUnusedLayers(t){const r={};t.forEach(c=>{r[c]=!0});for(const c in this.layerIndexes)r[c]||delete this.layerIndexes[c]}}const ko=771;class Si{constructor(t,r,c,d){this.blendFunction=t,this.blendColor=r,this.mask=c,this.blendEquation=d}}Si.Replace=[1,0,1,0],Si.disabled=new Si(Si.Replace,s.al.transparent,[!1,!1,!1,!1]),Si.unblended=new Si(Si.Replace,s.al.transparent,[!0,!0,!0,!0]),Si.alphaBlended=new Si([1,ko,1,ko],s.al.transparent,[!0,!0,!0,!0]),Si.alphaBlendedNonPremultiplied=new Si([770,ko,770,ko],s.al.transparent,[!0,!0,!0,!0]),Si.multiply=new Si([774,0,774,0],s.al.transparent,[!0,!0,!0,!0]);class qt{constructor(t,r,c){this.func=t,this.mask=r,this.range=c}}qt.ReadOnly=!1,qt.ReadWrite=!0,qt.disabled=new qt(519,qt.ReadOnly,[0,1]);const eu=7680;class li{constructor(t,r,c,d,m,g){this.test=t,this.ref=r,this.mask=c,this.fail=d,this.depthFail=m,this.pass=g}}li.disabled=new li({func:519,mask:0},0,0,eu,eu,eu);const ho=1029,Ua=2305;class ni{constructor(t,r,c){this.enable=t,this.mode=r,this.frontFace=c}}function Dh(u,t){const r=s.bG(u,3);s.ad.mat4.fromQuat(u,t),s.bI(u,3,r)}function ca(u,t){const r=s.ad.quat.identity([]);return s.ad.quat.rotateZ(r,r,-t),s.ad.quat.rotateX(r,r,-u),r}function ja(u,t){const r=[u[0],u[1],0],c=[t[0],t[1],0];if(s.ad.vec3.length(r)>=1e-15){const g=s.ad.vec3.normalize([],r);s.ad.vec3.scale(c,g,s.ad.vec3.dot(c,g)),t[0]=c[0],t[1]=c[1]}const d=s.ad.vec3.cross([],t,u);if(s.ad.vec3.len(d)<1e-15)return null;const m=Math.atan2(-d[1],d[0]);return ca(Math.atan2(Math.sqrt(u[0]*u[0]+u[1]*u[1]),-u[2]),m)}ni.disabled=new ni(!1,ho,Ua),ni.backCCW=new ni(!0,ho,Ua),ni.backCW=new ni(!0,ho,2304),ni.frontCW=new ni(!0,1028,2304),ni.frontCCW=new ni(!0,1028,Ua);class zh{constructor(t,r){this.position=t,this.orientation=r}get position(){return this._position}set position(t){if(t){const r=t instanceof s.ac?t:new s.ac(t[0],t[1],t[2]);this._renderWorldCopies&&(r.x=s.bF(r.x,0,1)),this._position=r}else this._position=null}lookAtPoint(t,r){if(this.orientation=null,!this.position)return;const c=this.position,d=this._elevation?this._elevation.getAtPointOrZero(s.ac.fromLngLat(t)):0,m=s.ac.fromLngLat(t,d),g=[m.x-c.x,m.y-c.y,m.z-c.z];r||(r=[0,0,1]),r[2]=Math.abs(r[2]),this.orientation=ja(g,r)}setPitchBearing(t,r){this.orientation=ca(s.ak(t),s.ak(-r))}}class Ga{constructor(t,r){this._transform=s.ad.mat4.identity([]),this.orientation=r,this.position=t}get mercatorPosition(){const t=this.position;return new s.ac(t[0],t[1],t[2])}get position(){const t=s.bG(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var r;t&&s.bI(this._transform,3,[(r=t)[0],r[1],r[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||s.ad.quat.identity([]),t&&Dh(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),r=this.right();return{bearing:Math.atan2(-r[1],r[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,r){this._orientation=ca(t,r),Dh(this._transform,this._orientation)}forward(){const t=s.bG(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=s.bG(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=s.bG(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,r){const c=new Float64Array(16);return s.ad.mat4.invert(c,this.getWorldToCamera(t,r)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,r,c){const d=this.position;s.ad.vec3.scale(d,d,-t);const m=new Float64Array(16);return s.ad.mat4.fromScaling(m,[c,c,c]),s.ad.mat4.translate(m,m,d),m[10]*=r,m}getWorldToCamera(t,r){const c=new Float64Array(16),d=new Float64Array(4),m=this.position;return s.ad.quat.conjugate(d,this._orientation),s.ad.vec3.scale(m,m,-t),s.ad.mat4.fromQuat(c,d),s.ad.mat4.translate(c,c,m),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=r,c[9]*=r,c[10]*=r,c[11]*=r,c}getCameraToClipPerspective(t,r,c,d){const m=new Float64Array(16);return s.ad.mat4.perspective(m,t,r,c,d),m}getCameraToClipOrthographic(t,r,c,d,m,g){const E=new Float64Array(16);return s.ad.mat4.ortho(E,t,r,c,d,m,g),E}getDistanceToElevation(t,r=!1){const c=t===0?0:s.bH(t,r?s.aT(this.position[1]):this.position[1]),d=this.forward();return(c-this.position[2])/d[2]}clone(){return new Ga([...this.position],[...this.orientation])}}const kr={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Xl{constructor(t=0,r=0,c=0,d=0){if(isNaN(t)||t<0||isNaN(r)||r<0||isNaN(c)||c<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=r,this.left=c,this.right=d}interpolate(t,r,c){return r.top!=null&&t.top!=null&&(this.top=s.ah(t.top,r.top,c)),r.bottom!=null&&t.bottom!=null&&(this.bottom=s.ah(t.bottom,r.bottom,c)),r.left!=null&&t.left!=null&&(this.left=s.ah(t.left,r.left,c)),r.right!=null&&t.right!=null&&(this.right=s.ah(t.right,r.right,c)),this}getCenter(t,r){const c=s.ay((this.left+t-this.right)/2,0,t),d=s.ay((this.top+r-this.bottom)/2,0,r);return new s.P(c,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Xl(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const ht=15;class tu{constructor(t,r,c,d,m,g,E){this.tileSize=512,this._renderWorldCopies=m===void 0||m,this._minZoom=t||0,this._maxZoom=r||22,this._minPitch=c??0,this._maxPitch=d??60,this.setProjection(g),this.setMaxBounds(E),this.width=0,this.height=0,this._center=new s.bO(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Xl,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Ga,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const t=new tu(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<ht}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,r=!1){const c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(r),this._calcMatrices()}getProjection(){return s.aA(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const r=this.projection?this.getProjection():void 0;this.projection=s.bP(this.projectionOptions);const c=this.getProjection(),d=!s.bn(r,c);return d&&this._calcMatrices(),this.mercatorFromTransition=!1,d}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=s.bP({name:"mercator"});const r=t!==this.projection.name;return r&&this._calcMatrices(),r}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return s.bH(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return s.bF(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const r=-t*Math.PI/180;this.angle!==r&&(this._unmodified=!1,this.angle=r,this._calcMatrices(),this.rotationMatrix=s.ad.mat2.create(),s.ad.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const r=s.ay(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==r&&(this._unmodified=!1,this._pitch=r,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=s.ak(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const r=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==r&&(this._unmodified=!1,this._setZoom(r),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,r=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!r||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const c=this._elevation;r||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,r=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop();let d=0,m=0;for(let g=0;g<r.length;g++){const E=new s.P(r[g][0]*this.width,c+r[g][1]*(this.height-c)),A=t.pointCoordinate(E);if(!A)continue;const C=1/Math.hypot(A[0]-this._camera.position[0],A[1]-this._camera.position[1]);d+=A[3]*C,m+=C}return m===0?NaN:d/m}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,r=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*r,d=this._mercatorZfromZoom(t),m=this._mercatorZfromZoom(this._maxZoom),g=Math.max(d-c,m);this._setZoom(this._zoomFromMercatorZ(g))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const r=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let c;c=t.z<this._camera.position[2]?[r.x,r.y,r.z]:[t.x,t.y,t.z];const d=s.ad.vec3.length(s.ad.vec3.sub([],this._camera.position,c));return s.ay(this._zoomFromMercatorZ(d),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let r=!1;if(t.orientation&&!s.ad.quat.exactEquals(t.orientation,this._camera.orientation)&&(r=this._setCameraOrientation(t.orientation)),t.position){const c=[t.position.x,t.position.y,t.position.z];s.ad.vec3.exactEquals(c,this._camera.position)||(this._setCameraPosition(c),r=!0)}r&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,r=new zh;return r.position=new s.ac(t[0],t[1],t[2]),r.orientation=this._camera.orientation,r._elevation=this.elevation,r._renderWorldCopies=this.renderWorldCopies,r}_setCameraOrientation(t){if(!s.ad.quat.length(t))return!1;s.ad.quat.normalize(t,t);const r=s.ad.vec3.transformQuat([],[0,0,-1],t),c=s.ad.vec3.transformQuat([],[0,-1,0],t);if(c[2]<0)return!1;const d=ja(r,c);return!!d&&(this._camera.orientation=d,!0)}_setCameraPosition(t){const r=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,d=this.cameraToCenterDistance;t[2]=s.ay(t[2],d/c,d/r),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,r,c){this._unmodified=!1,this._edgeInsets.interpolate(t,r,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const r=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,r)}getVisibleUnwrappedCoordinates(t){const r=[new s.bQ(0,t)];if(this.renderWorldCopies){const c=this.pointCoordinate(new s.P(0,0)),d=this.pointCoordinate(new s.P(this.width,0)),m=this.pointCoordinate(new s.P(this.width,this.height)),g=this.pointCoordinate(new s.P(0,this.height)),E=Math.floor(Math.min(c.x,d.x,m.x,g.x)),A=Math.floor(Math.max(c.x,d.x,m.x,g.x)),C=1;for(let R=E-C;R<=A+C;R++)R!==0&&r.push(new s.bQ(R,t))}return r}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,r,c){let d=[];const m=c!==void 0,g=!m;if(g&&this.zoom<r||m&&c[0]===0&&c[1]===0)return d;const E=new Set,A=(R,L,O,V,H)=>{const G=s.c5(L,R,O,V,H);E.has(G)||(d.push(new s.aH(R,L,O,V,H)),E.add(G))};for(let R=0;R<t.length;R++){const L=t[R];if(g&&L.canonical.z!==r)continue;const O=L.canonical,V=L.overscaledZ,H=L.wrap,G=1<<O.z,W=O.x+1<G,K=O.x>0,ie=O.y+1<G,oe=O.y>0,se=L.wrap-(K?0:1),fe=L.wrap+(W?0:1),ce=K?O.x-1:G-1,ue=W?O.x+1:0;if(m)c[0]<0?(A(V,fe,O.z,ue,O.y),c[1]<0&&ie&&(A(V,H,O.z,O.x,O.y+1),A(V,fe,O.z,ue,O.y+1)),c[1]>0&&oe&&(A(V,H,O.z,O.x,O.y-1),A(V,fe,O.z,ue,O.y-1))):c[0]>0?(A(V,se,O.z,ce,O.y),c[1]<0&&ie&&(A(V,H,O.z,O.x,O.y+1),A(V,se,O.z,ce,O.y+1)),c[1]>0&&oe&&(A(V,H,O.z,O.x,O.y-1),A(V,se,O.z,ce,O.y-1))):c[1]<0&&ie?A(V,H,O.z,O.x,O.y+1):oe&&A(V,H,O.z,O.x,O.y-1);else{const he=L.visibleQuadrants;1&he&&(A(V,se,O.z,ce,O.y),oe&&(A(V,H,O.z,O.x,O.y-1),A(V,se,O.z,ce,O.y-1))),2&he&&(A(V,fe,O.z,ue,O.y),oe&&(A(V,H,O.z,O.x,O.y-1),A(V,fe,O.z,ue,O.y-1))),4&he&&(A(V,se,O.z,ce,O.y),ie&&(A(V,H,O.z,O.x,O.y+1),A(V,se,O.z,ce,O.y+1))),8&he&&(A(V,fe,O.z,ue,O.y),ie&&(A(V,H,O.z,O.x,O.y+1),A(V,fe,O.z,ue,O.y+1)))}}const C=[];for(const R of d)d.some(L=>R.isChildOf(L))||C.push(R);if(d=C.filter(R=>!t.some(L=>!!(R.overscaledZ<r&&L.isChildOf(R))||R.equals(L)||R.isChildOf(L))),g){const R=1<<r,L=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),O=[R*L.x,R*L.y],V=4,H=V*V;d=d.filter(G=>{const W=G.canonical.x+.5-O[0],K=G.canonical.y+.5-O[1];return W*W+K*K<H})}return d}coveringTiles(t){let r=this.coveringZoomLevel(t);const c=r,d=this.elevation&&this.elevation.exaggeration(),m=d&&!t.isTerrainDEM,g=this.projection.name==="mercator";if(t.minzoom!==void 0&&r<t.minzoom)return[];t.maxzoom!==void 0&&r>t.maxzoom&&(r=t.maxzoom);const E=this.locationCoordinate(this.center),A=this.center.lat,C=1<<r,R=[C*E.x,C*E.y,0],L=this.projection.name==="globe",O=!L,V=s.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,r,O),H=L?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),G=C*s.bH(1,this.center.lat),W=this._camera.position[2]/s.bH(1,this.center.lat),K=[C*H.x,C*H.y,W*(O?1:G)],ie=L||d,oe=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),se=this.isLODDisabled(!0)?r:0;let fe;if(this._elevation&&t.isTerrainDEM)fe=1e4*this._elevation.exaggeration();else if(this._elevation){const Ie=this._elevation.getMinMaxForVisibleTiles();fe=Ie?Ie.max:this._centerAltitude}else fe=this._centerAltitude;const ce=t.isTerrainDEM?-fe:this._elevation?this._elevation.getMinElevationBelowMSL():0,ue=this.projection.isReprojectedInTileSpace?s.bS(this):1,he=Ie=>{const He=new s.ac(Ie.x+25e-6,Ie.y,Ie.z),Qe=new s.ac(Ie.x,Ie.y+25e-6,Ie.z),je=Ie.toLngLat(),it=He.toLngLat(),_t=Qe.toLngLat(),yt=this.locationCoordinate(je),wt=this.locationCoordinate(it),Ot=this.locationCoordinate(_t),si=Math.hypot(wt.x-yt.x,wt.y-yt.y),Wt=Math.hypot(Ot.x-yt.x,Ot.y-yt.y);return Math.sqrt(si*Wt)*ue/25e-6},_e=Ie=>{const Xe=fe,He=ce;return{aabb:s.bV(this,C,0,0,0,Ie,He,Xe,this.projection),zoom:0,x:0,y:0,minZ:He,maxZ:Xe,wrap:Ie,fullyVisible:!1}},xe=[];let Ue=[];const Le=r,Ye=t.reparseOverscaled?c:r,Je=(W-this._centerAltitude)*G,at=Ie=>{if(!this._elevation||!Ie.tileID||!g)return;const Xe=this._elevation.getMinMaxForTile(Ie.tileID),He=Ie.aabb;Xe?(He.min[2]=Xe.min,He.max[2]=Xe.max,He.center[2]=(He.min[2]+He.max[2])/2):(Ie.shouldSplit=Ke(Ie),Ie.shouldSplit||(He.min[2]=He.max[2]=He.center[2]=this._centerAltitude))},De=(Ie,Xe)=>{if(.707*Xe<Ie)return 1;const He=Xe/Ie;return He/(1.4144271570014144+(Math.pow(1.1,He-1.4144271570014144+1)-1)/(1.1-1)-1)},Ke=Ie=>{if(Ie.zoom<se)return!0;if(Ie.zoom===Le)return!1;if(Ie.shouldSplit!=null)return Ie.shouldSplit;const Xe=Ie.aabb.distanceX(K),He=Ie.aabb.distanceY(K);let Qe=Je,je=1;if(L){Qe=Ie.aabb.distanceZ(K);const Wt=Math.pow(2,Ie.zoom),ii=s.aT((Ie.y+1)/Wt),Yt=s.aT(Ie.y/Wt),Ii=Math.min(Math.max(A,ii),Yt),Wi=s.ca(Ii)/s.ca(A);if(je=Ii===A?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Wi/this._mercatorScaleRatio),this.zoom<=s.c6&&Ie.zoom===Le-1&&Wi>=.9)return!0}else if(m&&(Qe=Ie.aabb.distanceZ(K)*G),this.projection.isReprojectedInTileSpace&&c<=5){const Wt=Math.pow(2,Ie.zoom),ii=he(new s.ac((Ie.x+.5)/Wt,(Ie.y+.5)/Wt));je=ii>.85?1:ii}if(!g){const Wt=Math.sqrt(Xe*Xe+He*He+Qe*Qe);let ii=(1<<Le-Ie.zoom)*oe*je;return ii*=De(Math.max(Qe,Je),Wt),Wt<ii}let it=Number.MAX_VALUE,_t=0;const yt=Ie.aabb.getCorners(),wt=[];for(const Wt of yt){s.ad.vec3.sub(wt,Wt,K),L||(m?wt[2]*=G:wt[2]=Je);const ii=s.ad.vec3.dot(wt,this._camera.forward());ii<it&&(it=ii,_t=Math.abs(wt[2]))}let Ot=(1<<Le-Ie.zoom)*oe*je;if(Ot*=De(Math.max(_t,Je),it),it<Ot)return!0;const si=Ie.aabb.closestPoint(R);return si[0]===R[0]&&si[1]===R[1]};if(this.renderWorldCopies)for(let Ie=1;Ie<=3;Ie++)xe.push(_e(-Ie)),xe.push(_e(Ie));for(xe.push(_e(0));xe.length>0;){const Ie=xe.pop(),Xe=Ie.x,He=Ie.y;let Qe=Ie.fullyVisible;const je=()=>this.projection.name==="globe"&&(Ie.y===0||Ie.y===(1<<Ie.zoom)-1);if(!Qe){let it=ie?Ie.aabb.intersects(V):Ie.aabb.intersectsFlat(V);if(it===0&&je()){const _t=new s.bT(Ie.zoom,Xe,He);it=s.bU(this,C,_t,!0).intersects(V)}if(it===0)continue;Qe=it===2}if(Ie.zoom!==Le&&Ke(Ie))for(let it=0;it<4;it++){const _t=(Xe<<1)+it%2,yt=(He<<1)+(it>>1),wt={aabb:g?Ie.aabb.quadrant(it):s.bV(this,C,Ie.zoom+1,_t,yt,Ie.wrap,Ie.minZ,Ie.maxZ,this.projection),zoom:Ie.zoom+1,x:_t,y:yt,wrap:Ie.wrap,fullyVisible:Qe,tileID:void 0,shouldSplit:void 0,minZ:Ie.minZ,maxZ:Ie.maxZ};m&&!L&&(wt.tileID=new s.aH(Ie.zoom+1===Le?Ye:Ie.zoom+1,Ie.wrap,Ie.zoom+1,_t,yt),at(wt)),xe.push(wt)}else{const it=Ie.zoom===Le?Ye:Ie.zoom;if(t.minzoom&&t.minzoom>it)continue;let _t=0;if(!Qe){let si=ie?Ie.aabb.intersectsPrecise(V):Ie.aabb.intersectsPreciseFlat(V);if(si===0&&je()){const Wt=new s.bT(Ie.zoom,Xe,He);si=s.bU(this,C,Wt,!0).intersectsPrecise(V)}if(si===0)continue;if(t.calculateQuadrantVisibility)if(V.containsPoint(Ie.aabb.center))_t=15;else for(let Wt=0;Wt<4;Wt++)Ie.aabb.quadrant(Wt).intersects(V)!==0&&(_t|=1<<Wt)}const yt=R[0]-(.5+Xe+(Ie.wrap<<Ie.zoom))*(1<<r-Ie.zoom),wt=R[1]-.5-He,Ot=Ie.tileID?Ie.tileID:new s.aH(it,Ie.wrap,Ie.zoom,Xe,He);t.calculateQuadrantVisibility&&(Ot.visibleQuadrants=_t),Ue.push({tileID:Ot,distanceSq:yt*yt+wt*wt})}}if(this.fogCullDistSq){const Ie=this.fogCullDistSq,Xe=this.horizonLineFromTop();Ue=Ue.filter(He=>{const Qe=[0,0,0,1],je=[s.ai,s.ai,0,1],it=this.calculateFogTileMatrix(He.tileID.toUnwrapped());s.ad.vec4.transformMat4(Qe,Qe,it),s.ad.vec4.transformMat4(je,je,it);const _t=s.ad.vec4.min([],Qe,je),yt=s.ad.vec4.max([],Qe,je),wt=s.bW(_t,yt);if(wt===0)return!0;let Ot=!1;const si=this._elevation;if(si&&wt>Ie&&Xe!==0){const Wt=this.calculateProjMatrix(He.tileID.toUnwrapped());let ii;t.isTerrainDEM||(ii=si.getMinMaxForTile(He.tileID)),ii||(ii={min:ce,max:fe});const Yt=s.c7(this.rotation),Ii=[Yt[0]*s.ai,Yt[1]*s.ai,ii.max];s.ad.vec3.transformMat4(Ii,Ii,Wt),Ot=(1-Ii[1])*this.height*.5<Xe}return wt<Ie||Ot})}return Ue.sort((Ie,Xe)=>Ie.distanceSq-Xe.distanceSq).map(Ie=>Ie.tileID)}resize(t,r){this.width=t,this.height=r,this.pixelsToGLUnits=[2/t,-2/r],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const r=s.ay(t.lat,-s.bX,s.bX),c=this.projection.project(t.lng,r);return new s.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/s.bH(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,r){let c,d;const m=this.centerPoint;if(this.projection.name==="globe"){const E=this.worldSize;c=(r.x-m.x)/E,d=(r.y-m.y)/E}else{const E=this.pointCoordinate(r),A=this.pointCoordinate(m);c=E.x-A.x,d=E.y-A.y}const g=this.locationCoordinate(t);this.setLocation(new s.ac(g.x-c,g.y-d))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,r){return this.projection.locationPoint(this,t,r)}locationPoint3D(t,r){return this.projection.locationPoint(this,t,r,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,r){return this.coordinateLocation(this.pointCoordinate3D(t,r))}locationCoordinate(t,r){const c=r?s.bH(r,t.lat):void 0,d=this.projection.project(t.lng,t.lat);return new s.ac(d.x,d.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,r){const c=r??this._centerAltitude,d=[t.x,t.y,0,1],m=[t.x,t.y,1,1];s.ad.vec4.transformMat4(d,d,this.pixelMatrixInverse),s.ad.vec4.transformMat4(m,m,this.pixelMatrixInverse);const g=m[3];s.ad.vec4.scale(d,d,1/d[3]),s.ad.vec4.scale(m,m,1/g);const E=d[2],A=m[2];return{p0:d,p1:m,t:E===A?0:(c-E)/(A-E)}}screenPointToMercatorRay(t){const r=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return s.ad.vec4.transformMat4(r,r,this.pixelMatrixInverse),s.ad.vec4.transformMat4(c,c,this.pixelMatrixInverse),s.ad.vec4.scale(r,r,1/r[3]),s.ad.vec4.scale(c,c,1/c[3]),r[2]=s.bH(r[2],this._center.lat)*this.worldSize,c[2]=s.bH(c[2],this._center.lat)*this.worldSize,s.ad.vec4.scale(r,r,1/this.worldSize),s.ad.vec4.scale(c,c,1/this.worldSize),new s.as([r[0],r[1],r[2]],s.ad.vec3.normalize([],s.ad.vec3.sub([],c,r)))}rayIntersectionCoordinate(t){const{p0:r,p1:c,t:d}=t,m=s.bH(r[2],this._center.lat),g=s.bH(c[2],this._center.lat);return new s.ac(s.ah(r[0],c[0],d)/this.worldSize,s.ah(r[1],c[1],d)/this.worldSize,s.ah(m,g,d))}pointCoordinate(t,r=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,r)}pointCoordinate3D(t,r){if(!this.elevation)return this.pointCoordinate(t,r);let c=this.projection.pointCoordinate3D(this,t.x,t.y);if(c)return new s.ac(c[0],c[1],c[2]);let d=0,m=this.horizonLineFromTop();if(t.y>m)return this.pointCoordinate(t,r);const g=.02*m,E=t.clone();for(let A=0;A<10&&m-d>g;A++){E.y=s.ah(d,m,.66);const C=this.projection.pointCoordinate3D(this,E.x,E.y);C?(m=E.y,c=C):d=E.y}return c?new s.ac(c[0],c[1],c[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=s.bY)return!this.isPointAboveHorizon(t);const r=this.pointCoordinate(t);return r.y>=0&&r.y<=1}_coordinatePoint(t,r){const c=r&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,d=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return s.ad.vec4.transformMat4(d,d,this.pixelMatrix),d[3]>0?new s.P(d[0]/d[3],d[1]/d[3]):new s.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:r}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,d=this.width-this._edgeInsets.right,m=this.pointLocation3D(new s.P(r,t)),g=this.pointLocation3D(new s.P(d,t)),E=this.pointLocation3D(new s.P(d,c)),A=this.pointLocation3D(new s.P(r,c));let C=Math.min(m.lng,g.lng,E.lng,A.lng),R=Math.max(m.lng,g.lng,E.lng,A.lng),L=Math.min(m.lat,g.lat,E.lat,A.lat),O=Math.max(m.lat,g.lat,E.lat,A.lat);const V=Math.pow(2,-this.zoom)/16*270,H=this.projection.name==="globe"?1:4,G=(W,K,ie,oe,se)=>{const fe=(W+ie)/2,ce=(K+oe)/2,ue=new s.P(fe,ce),{lng:he,lat:_e}=this.pointLocation3D(ue),xe=Math.max(0,C-he,L-_e,he-R,_e-O);C=Math.min(C,he),R=Math.max(R,he),L=Math.min(L,_e),O=Math.max(O,_e),(se<H||xe>V)&&(G(W,K,fe,ce,se+1),G(fe,ce,ie,oe,se+1))};if(G(r,t,d,t,1),G(d,t,d,c,1),G(d,c,r,c,1),G(r,c,r,t,1),this.projection.name==="globe"){const[W,K]=s.bZ(this);W?(O=90,R=180,C=-180):K&&(L=-90,R=180,C=-180)}return new s.aB(new s.bO(C,L),new s.bO(R,O))}_getBoundsRectangular(t,r){const{top:c,left:d}=this._edgeInsets,m=this.height-this._edgeInsets.bottom,g=this.width-this._edgeInsets.right,E=new s.P(d,c),A=new s.P(g,c),C=new s.P(g,m),R=new s.P(d,m);let L=this.pointCoordinate(E,t),O=this.pointCoordinate(A,t);const V=this.pointCoordinate(C,r),H=this.pointCoordinate(R,r),G=(W,K)=>(K.y-W.y)/(K.x-W.x);return L.y>1&&O.y>=0?L=new s.ac((1-H.y)/G(H,L)+H.x,1):L.y<0&&O.y<=1&&(L=new s.ac(-H.y/G(H,L)+H.x,0)),O.y>1&&L.y>=0?O=new s.ac((1-V.y)/G(V,O)+V.x,1):O.y<0&&L.y<=1&&(O=new s.ac(-V.y/G(V,O)+V.x,0)),new s.aB().extend(this.coordinateLocation(L)).extend(this.coordinateLocation(O)).extend(this.coordinateLocation(H)).extend(this.coordinateLocation(V))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const r=t.visibleDemTiles.reduce((c,d)=>{if(d.dem){const m=d.dem.tree;c.min=Math.min(c.min,m.minimums[0]),c.max=Math.max(c.max,m.maximums[0])}return c},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(r.min*t.exaggeration(),r.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const r=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-r*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-s.bX,this.maxLat=s.bX,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=s.av(this.minLng)*this.tileSize,this.worldMaxX=s.av(this.maxLng)*this.tileSize,this.worldMinY=s.aC(this.maxLat)*this.tileSize,this.worldMaxY=s.aC(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,r){return this.projection.createTileMatrix(this,r,t)}calculateDistanceTileData(t){const r=t.key,c=this._distanceTileDataCache;if(c[r])return c[r];const d=t.canonical,m=1/this.height,g=this.cameraWorldSize,E=g/this.zoomScale(d.z),A=(d.x+Math.pow(2,d.z)*t.wrap)*E,C=d.y*E,R=this.point;R.x*=g/this.worldSize,R.y*=g/this.worldSize;const L=this.angle,O=Math.sin(-L),V=-Math.cos(-L);return c[r]={bearing:[O,V],center:[(R.x-A)*m,(R.y-C)*m],scale:E/s.ai*m},c[r]}calculateFogTileMatrix(t){const r=t.key,c=this._fogTileMatrixCache;if(c[r])return c[r];const d=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return s.ad.mat4.multiply(d,this.worldToFogMatrix,d),c[r]=new Float32Array(d),c[r]}calculateProjMatrix(t,r=!1,c=!1){const d=t.key;let m;if(m=c?this._expandedProjMatrixCache:r?this._alignedProjMatrixCache:this._projMatrixCache,m[d])return m[d];const g=this.calculatePosMatrix(t,this.worldSize);let E;return E=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:r?this.alignedProjMatrix:this.projMatrix,s.ad.mat4.multiply(g,E,g),m[d]=new Float32Array(g),m[d]}calculatePixelsToTileUnitsMatrix(t){const r=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[r])return c[r];const d=s.b_(t,this);return c[r]=d,c[r]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,r=s.ad.mat4.fromScaling([],[t,t,t]);return s.ad.mat4.multiply(r,r,this.globeMatrix),r}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const r=s.bH(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(r),d=this._camera.forward(),m=s.bH(1,this._center.lat);c[2]/=m,d[2]/=m,s.ad.vec3.normalize(d,d);const g=t.raycast(c,d,t.exaggeration());if(g){const E=s.ad.vec3.scaleAndAdd([],c,d,g),A=new s.ac(E[0],E[1],s.bH(E[2],s.aT(E[1]))),C=(A.z+s.ad.vec3.length([A.x-c[0],A.y-c[1],A.z-c[2]*m]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(C),this._centerAltitude=A.toAltitude(),this._center=this.coordinateLocation(A),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const r=this._elevation,c=s.bH(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(c),m=r.getAtPointOrZero(new s.ac(...d)),g=this.pixelsPerMeter/this.worldSize*m,E=this._minimumHeightOverTerrain(),A=d[2]-g;if(A<=E)if(A<0||t){const C=this.locationCoordinate(this._center,this._centerAltitude),R=[d[0],d[1],C.z-d[2]],L=s.ad.vec3.length(R);R[2]-=(E-A)/this._pixelsPerMercatorPixel;const O=s.ad.vec3.length(R);if(O===0)return;s.ad.vec3.scale(R,R,L/O*this._pixelsPerMercatorPixel),this._camera.position=[d[0],d[1],C.z*this._pixelsPerMercatorPixel-R[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const O=this.center;return O.lat=s.ay(O.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(O.lng=s.ay(O.lng,this.minLng,this.maxLng)),this.center=O,void(this._constraining=!1)}const r=this._unmodified,{x:c,y:d}=this.point;let m=0,g=c,E=d;const A=this.width/2,C=this.height/2,R=this.worldMinY*this.scale,L=this.worldMaxY*this.scale;if(d-C<R&&(E=R+C),d+C>L&&(E=L-C),L-R<this.height&&(m=Math.max(m,this.height/(L-R)),E=(L+R)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const O=this.worldMinX*this.scale,V=this.worldMaxX*this.scale,H=this.worldSize/2-(O+V)/2;g=(c+H+this.worldSize)%this.worldSize-H,g-A<O&&(g=O+A),g+A>V&&(g=V-A),V-O<this.width&&(m=Math.max(m,this.width/(V-O)),g=(V+O)/2)}g===c&&E===d||this._allowWorldUnderZoom||(this.center=this.unproject(new s.P(g,E))),m&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(m)),this._constrainCamera(),this._unmodified=r,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,r=this.projection.name==="globe",c=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=s.bH(1,this.center.lat)/s.bH(1,s.c8));const d=s.b$(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,d),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const m=this.projection.zAxisUnit==="meters"?c:1,g=this._camera.getWorldToCamera(this.worldSize,m);let E;const A=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(A[8]=2*-t.x/this.width,A[9]=2*t.y/this.height,this.isOrthographic){let _e=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),xe=_e*this.aspect,Ue=-xe,Le=-_e;xe-=t.x,Ue-=t.x,_e+=t.y,Le+=t.y,E=this._camera.getCameraToClipOrthographic(Ue,xe,Le,_e,this._nearZ,this._farZ),((Ye,Je,at,De)=>{for(let Ke=0;Ke<16;Ke++)Ye[Ke]=s.ah(Je[Ke],at[Ke],De)})(E,E,A,s.c9(this.pitch>=ht?1:this.pitch/ht))}else E=A;const C=s.ad.mat4.mul([],A,g);let R=s.ad.mat4.mul([],E,g);if(this.projection.isReprojectedInTileSpace){const _e=this.locationCoordinate(this.center),xe=s.ad.mat4.identity([]);s.ad.mat4.translate(xe,xe,[_e.x*this.worldSize,_e.y*this.worldSize,0]),s.ad.mat4.multiply(xe,xe,s.c0(this)),s.ad.mat4.translate(xe,xe,[-_e.x*this.worldSize,-_e.y*this.worldSize,0]),s.ad.mat4.multiply(R,R,xe),s.ad.mat4.multiply(C,C,xe),this.inverseAdjustmentMatrix=s.c1(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=s.ad.mat4.scale([],R,[this.worldSize,this.worldSize,this.worldSize/m,1]),this.projMatrix=R,this.invProjMatrix=s.ad.mat4.invert(new Float64Array(16),this.projMatrix),r){const _e=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);_e[8]=2*-t.x/this.width,_e[9]=2*t.y/this.height,this.expandedFarZProjMatrix=s.ad.mat4.mul([],_e,g)}else this.expandedFarZProjMatrix=this.projMatrix;const L=s.ad.mat4.invert([],E);this.frustumCorners=s.c2.fromInvProjectionMatrix(L,this.horizonLineFromTop(),this.height),this.cameraFrustum=s.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!r);const O=new Float32Array(16);s.ad.mat4.identity(O),s.ad.mat4.scale(O,O,[1,-1,1]),s.ad.mat4.rotateX(O,O,this._pitch),s.ad.mat4.rotateZ(O,O,this.angle);const V=s.ad.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=s.ad.mat4.clone(V);const H=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;V[8]=2*-t.x/this.width,V[9]=2*(t.y+H)/this.height,this.skyboxMatrix=s.ad.mat4.multiply(O,V,O);const G=this.point,W=G.x,K=G.y,ie=this.width%2/2,oe=this.height%2/2,se=Math.cos(this.angle),fe=Math.sin(this.angle),ce=W-Math.round(W)+se*ie+fe*oe,ue=K-Math.round(K)+se*oe+fe*ie,he=new Float64Array(R);if(s.ad.mat4.translate(he,he,[ce>.5?ce-1:ce,ue>.5?ue-1:ue,0]),this.alignedProjMatrix=he,R=s.ad.mat4.create(),s.ad.mat4.scale(R,R,[this.width/2,-this.height/2,1]),s.ad.mat4.translate(R,R,[1,-1,0]),this.labelPlaneMatrix=R,R=s.ad.mat4.create(),s.ad.mat4.scale(R,R,[1,-1,1]),s.ad.mat4.translate(R,R,[-1,-1,0]),s.ad.mat4.scale(R,R,[2/this.width,2/this.height,1]),this.glCoordMatrix=R,this.pixelMatrix=s.ad.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,C),this._calcFogMatrices(),this._distanceTileDataCache={},R=s.ad.mat4.invert(new Float64Array(16),this.pixelMatrix),!R)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=R,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=s.c3(this);const _e=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=s.ad.vec3.transformMat4(_e,_e,g),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=R;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,r=this.cameraPixelsPerMeter,c=this._camera.position,d=1/this.height/this._pixelsPerMercatorPixel,m=[t,t,r];s.ad.vec3.scale(m,m,d),s.ad.vec3.scale(c,c,-1),s.ad.vec3.multiply(c,c,m);const g=s.ad.mat4.create();s.ad.mat4.translate(g,g,c),s.ad.mat4.scale(g,g,m),this.mercatorFogMatrix=g,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,r,d)}_computeCameraPosition(t){const r=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),d=this.point,m=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*r-t/this.worldSize*this._centerAltitude;return[d.x/this.worldSize-c[0]*m,d.y/this.worldSize-c[1]*m,t/this.worldSize*this._centerAltitude-c[2]*m]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const r=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],d=t[2];let m=1;this.projection.wrap&&(this.center=this.center.wrap()),d>0&&(m=Math.min((r-c)/d,1)),this._camera.position=s.ad.vec3.scaleAndAdd([],this._camera.position,t,m),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,r=this._camera.forward(),{pitch:c,bearing:d}=this._camera.getPitchBearing(),m=s.bH(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,g=this._mercatorZfromZoom(this._maxZoom)*Math.cos(s.ak(this._maxPitch)),E=Math.max((t[2]-m)/Math.cos(c),g),A=this._zoomFromMercatorZ(E);s.ad.vec3.scaleAndAdd(t,t,r,E),this._pitch=s.ay(c,s.ak(this.minPitch),s.ak(this.maxPitch)),this.angle=s.bF(d,-Math.PI,Math.PI),this._setZoom(s.ay(A,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new s.ac(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}zoomFromMercatorZAdjusted(t){let r=0,c=s.bY,d=0,m=1/0;for(;c-r>1e-6&&c>r;){const g=r+.5*(c-r),E=this.tileSize*Math.pow(2,g),A=this.getCameraToCenterDistance(this.projection,g,E),C=this.scaleZoom(A/(t*this.tileSize)),R=Math.abs(g-C);R<m&&(m=R,d=g),g<C?r=g:c=g}return d}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(s.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,r){const c=Math.min(t.x,r.x),d=Math.max(t.x,r.x),m=Math.min(t.y,r.y),g=Math.max(t.y,r.y);if(m<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const E=[new s.P(c,m),new s.P(d,g),new s.P(c,g),new s.P(d,m)],A=this.renderWorldCopies?-3:0,C=this.renderWorldCopies?4:1;for(const R of E){const L=this.pointRayIntersection(R);if(L.t<0)return!0;const O=this.rayIntersectionCoordinate(L);if(O.x<A||O.y<0||O.x>C||O.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+s.c4(this.fovAboveCenter)>88||this.anyCornerOffEdge(new s.P(0,0),new s.P(this.width,this.height))}zoomDeltaToMovement(t,r){const c=s.ad.vec3.length(s.ad.vec3.sub([],this._camera.position,t)),d=this._zoomFromMercatorZ(c)+r;return c-this._mercatorZfromZoom(d)}getCameraPoint(){if(this.projection.name==="globe"){const t=function([r,c,d],m){const g=[r,c,d,1];s.ad.vec4.transformMat4(g,g,m);const E=g[3]=Math.max(g[3],1e-6);return g[0]/=E,g[1]/=E,g[2]/=E,g}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new s.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,t))}}getCameraToCenterDistance(t,r=this.zoom,c=this.worldSize){const d=s.b$(t,r,this.width,this.height,1024),m=t.pixelSpaceConversion(this.center.lat,c,d);let g=.5/Math.tan(.5*this._fov)*this.height*m;return this.isOrthographic&&(g=s.ah(1,g,s.c9(this.pitch>=ht?1:this.pitch/ht))),g}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&s.ad.mat4.multiply(t,t,this.globeMatrix),t}getFrustum(t){return s.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const fo=(u,t)=>{if(t>0&&u.terrain&&s.w("Cutoff is currently disabled on terrain"),t<=0||u.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const r=u.transform,c=Math.max(Math.abs(r._zoom-(u.minCutoffZoom-1)),1),d=r.isLODDisabled(!1)?s.ae(60,45,r.pitch):s.ae(30,15,r.pitch),m=r._farZ-r._nearZ,g=t*r.height,E=((1-(A=d))*r.cameraToCenterDistance+A*(r._farZ+g))*c;var A;return{shouldRenderCutoff:d<1,uniformValues:{u_cutoff_params:[r._nearZ,r._farZ,(E-r._nearZ)/m,(E-g-r._nearZ)/m]}}},xn={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class rp{constructor(t,r){this.aabb=t,this.lastCascade=r}}class iu{add(t,r){const c=this.receivers[t.key];c!==void 0?(c.aabb.min[0]=Math.min(c.aabb.min[0],r.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],r.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],r.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],r.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],r.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],r.max[2])):this.receivers[t.key]=new rp(r,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,r,c){const d=s.ce.fromPoints(t.points);let m=0;for(const g in this.receivers){const E=this.receivers[g];if(!E||!d.intersectsAabb(E.aabb))continue;E.aabb.min=d.closestPoint(E.aabb.min),E.aabb.max=d.closestPoint(E.aabb.max);const A=E.aabb.getCorners();for(let C=0;C<c.length;C++){let R=!0;for(const L of A){const O=[L[0]*r,L[1]*r,L[2]];if(s.ad.vec3.transformMat4(O,O,c[C].matrix),O[0]<-1||O[0]>1||O[1]<-1||O[1]>1){R=!1;break}}if(E.lastCascade=C,m=Math.max(m,C),R)break}}return m+1}}class po{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new iu,this._depthMode=new qt(t.context.gl.LEQUAL,qt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(xn,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(xn,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(xn,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,r){const c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!r||!r.properties)return;const d=r.properties.get("shadow-intensity");if(!r.shadowsEnabled()||d<=0||(this._shadowLayerCount=c.style.order.reduce((H,G)=>{const W=c.style._mergedLayers[G];return H+(W.hasShadowPass()&&!W.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const m=c.context,g=xn.shadowMapResolution,E=xn.shadowMapResolution;if(this._cascades.length===0||xn.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let H=0;H<xn.cascadeCount;++H){const G=c._shadowMapDebug,W=m.gl,K=m.createFramebuffer(g,E,G,"texture"),ie=new s.T(m,{width:g,height:E,data:null},W.DEPTH_COMPONENT16);if(K.depthAttachment.set(ie.texture),G){const oe=new s.T(m,{width:g,height:E,data:null},W.RGBA8);K.colorAttachment.set(oe.texture)}this._cascades.push({framebuffer:K,texture:ie,matrix:[],far:0,boundingSphereRadius:0,frustum:new s.bR,scale:0})}}this.shadowDirection=Fo(r);let A=0;if(t.elevation){const H=t.elevation,G=[1e4,-1e4];H.visibleDemTiles.filter(W=>W.dem).forEach(W=>{const K=W.dem.tree;G[0]=Math.min(G[0],K.minimums[0]),G[1]=Math.max(G[1],K.maximums[0])}),G[0]!==1e4&&(A=(G[1]-G[0])*H.exaggeration())}const C=1.5*t.cameraToCenterDistance,R=3*C,L=new Float64Array(16);for(let H=0;H<this._cascades.length;++H){const G=this._cascades[H];let W=t.height/50,K=1;xn.cascadeCount===1?K=R:H===0?K=C:(W=C,K=R);const[ie,oe]=Ha(t,this.shadowDirection,W,K,xn.shadowMapResolution,A);G.scale=t.scale,G.matrix=ie,G.boundingSphereRadius=oe,s.ad.mat4.invert(L,G.matrix),G.frustum=s.bR.fromInvProjectionMatrix(L,1,0,!0),G.far=K}const O=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[O].far,this._cascades[O].far],this._uniformValues.u_shadow_intensity=d,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/xn.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=xn.shadowMapResolution,this._uniformValues.u_shadowmap_0=kr.ShadowMap0,this._uniformValues.u_shadowmap_1=kr.ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const V=c.transform.elevation;for(const H of this._groundShadowTiles){let G={min:0,max:0};if(V){const W=V.getMinMaxForTile(H);W&&(G=W)}this.addShadowReceiver(H.toUnwrapped(),G.min,G.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,r){if(!this.enabled)return;const c=this.painter,d=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),d.viewport.set([0,0,xn.shadowMapResolution,xn.shadowMapResolution]);for(let m=0;m<this._numCascadesToRender;++m){c.currentShadowCascade=m,d.bindFramebuffer.set(this._cascades[m].framebuffer.framebuffer),d.clear({color:s.al.white,depth:1});for(const g of t.order){const E=t._mergedLayers[g];if(!E.hasShadowPass()||E.isHidden(c.transform.zoom))continue;const A=t.getLayerSourceCache(E),C=A?r[A.id]:void 0;(E.type==="model"||C&&C.length)&&c.renderLayer(c,A,E,C)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,r=t.style,c=t.context,d=r.directionalLight,m=r.ambientLight;if(!d||!m)return;const g=[],E=fo(t,t.longestCutoffRange);E.shouldRenderCutoff&&g.push("RENDER_CUTOFF"),g.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&g.push("NORMAL_OFFSET");const A=$a(r,d,m),C=new qt(c.gl.LEQUAL,qt.ReadOnly,t.depthRangeFor3D);for(const R of this._groundShadowTiles){const L=R.toUnwrapped(),O=t.isTileAffectedByFog(R),V=t.getOrCreateProgram("groundShadow",{defines:g,overrideFog:O});this.setupShadows(L,V),t.uploadCommonUniforms(c,V,L,null,E);const H={u_matrix:t.transform.calculateProjMatrix(L),u_ground_shadow_factor:A};V.draw(t,c.gl.TRIANGLES,C,li.disabled,Si.multiply,ni.disabled,H,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Si.unblended:Si.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const r=this.painter.transform,c=r.calculatePosMatrix(t,r.worldSize);return s.ad.mat4.multiply(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){return s.ad.mat4.multiply(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,r,c,d=0){if(!this.enabled)return;const m=this.painter.transform,g=this.painter.context,E=g.gl,A=this._uniformValues,C=new Float64Array(16),R=m.calculatePosMatrix(t,m.worldSize);for(let L=0;L<this._cascades.length;L++)s.ad.mat4.multiply(C,this._cascades[L].matrix,R),A[L===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(C),g.activeTexture.set(E.TEXTURE0+kr.ShadowMap0+L),this._cascades[L].texture.bind(E.NEAREST,E.CLAMP_TO_EDGE);if(this.useNormalOffset=!!c,this.useNormalOffset){const L=s.cd(t.canonical),O=2/m.tileSize*s.ai/xn.shadowMapResolution,V=O*this._cascades[0].boundingSphereRadius,H=O*this._cascades[this._cascades.length-1].boundingSphereRadius,G=(c==="vector-tile"?1:3)/Math.pow(2,d-t.canonical.z-(1-m.zoom+Math.floor(m.zoom)));A.u_shadow_normal_offset=[L,V*G,H*G],A.u_shadow_bias=[6e-5,.0012,.012]}else A.u_shadow_bias=[36e-5,.0012,.012];r.setShadowUniformValues(g,A)}setupShadowsFromMatrix(t,r,c=!1){if(!this.enabled)return;const d=this.painter.context,m=d.gl,g=this._uniformValues,E=new Float64Array(16);for(let A=0;A<xn.cascadeCount;A++)s.ad.mat4.multiply(E,this._cascades[A].matrix,t),g[A===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(E),d.activeTexture.set(m.TEXTURE0+kr.ShadowMap0+A),this._cascades[A].texture.bind(m.NEAREST,m.CLAMP_TO_EDGE);if(this.useNormalOffset=c,c){const A=xn.normalOffset;g.u_shadow_normal_offset=[1,A,A],g.u_shadow_bias=[6e-5,.0012,.012]}else g.u_shadow_bias=[36e-5,.0012,.012];r.setShadowUniformValues(d,g)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,r,c,d){if(d[2]>=0)return{};const m=function(A,C,R){const L=R/(1<<A.canonical.z);return new s.ce([A.canonical.x*L+A.wrap*R,A.canonical.y*L+A.wrap*R,0],[(A.canonical.x+1)*L+A.wrap*R,(A.canonical.y+1)*L+A.wrap*R,C])}(t,r,c).getCorners(),g=r/-d[2];d[0]<0?(s.ad.vec3.add(m[0],m[0],[d[0]*g,0,0]),s.ad.vec3.add(m[3],m[3],[d[0]*g,0,0])):d[0]>0&&(s.ad.vec3.add(m[1],m[1],[d[0]*g,0,0]),s.ad.vec3.add(m[2],m[2],[d[0]*g,0,0])),d[1]<0?(s.ad.vec3.add(m[0],m[0],[0,d[1]*g,0]),s.ad.vec3.add(m[1],m[1],[0,d[1]*g,0])):d[1]>0&&(s.ad.vec3.add(m[2],m[2],[0,d[1]*g,0]),s.ad.vec3.add(m[3],m[3],[0,d[1]*g,0]));const E={};return E.vertices=m,E.planes=[qa(m[1],m[0],m[4]),qa(m[2],m[1],m[5]),qa(m[3],m[2],m[6]),qa(m[0],m[3],m[7])],E}addShadowReceiver(t,r,c){this._receivers.add(t,s.ce.fromTileIdAndHeight(t,r,c))}getMaxCascadeForTile(t){const r=this._receivers.get(t);return r&&r.lastCascade?r.lastCascade:0}}function qa(u,t,r){const c=s.ad.vec3.sub([],r,t),d=s.ad.vec3.sub([],u,t),m=s.ad.vec3.cross([],c,d),g=s.ad.vec3.length(m);return g===0?[0,0,1,0]:(s.ad.vec3.scale(m,m,1/g),[m[0],m[1],m[2],-s.ad.vec3.dot(m,t)])}function Fo(u){const t=u.properties.get("direction"),r=s.cc(t.x,t.y,t.z);r[2]=s.ay(r[2],0,75);const c=s.cf([r[0],r[1],r[2]]);return s.ad.vec3.fromValues(c.x,c.y,c.z)}function $a(u,t,r){const c=t.properties.get("color-use-theme")==="none",d=t.properties.get("color"),m=t.properties.get("intensity"),g=t.properties.get("direction"),E=[g.x,g.y,g.z],A=r.properties.get("color-use-theme")==="none",C=r.properties.get("color"),R=r.properties.get("intensity"),L=Math.max(s.ad.vec3.dot([0,0,1],E),0),O=[0,0,0];s.ad.vec3.scale(O,C.toRenderColor(A?null:u.getLut(t.scope)).toArray01Linear().slice(0,3),R);const V=[0,0,0];return s.ad.vec3.scale(V,d.toRenderColor(c?null:u.getLut(r.scope)).toArray01Linear().slice(0,3),L*m),s.cg([O[0]>0?O[0]/(O[0]+V[0]):0,O[1]>0?O[1]/(O[1]+V[1]):0,O[2]>0?O[2]/(O[2]+V[2]):0])}function Ha(u,t,r,c,d,m){const g=u.zoom,E=u.scale,A=u.worldSize,C=1/A,R=u.aspect,L=Math.sqrt(1+R*R)*Math.tan(.5*u.fovX),O=L*L,V=c-r,H=c+r;let G,W;O>V/H?(G=c,W=c*L):(G=.5*H*(1+O),W=.5*Math.sqrt(V*V+2*(c*c+r*r)*O+H*H*O*O));const K=u.projection.pixelsPerMeter(u.center.lat,A),ie=u._camera.getCameraToWorldMercator(),oe=[0,0,-G*C];s.ad.vec3.transformMat4(oe,oe,ie);let se=W*C;const fe=u._edgeInsets;if(!(fe.left===0&&fe.top===0&&fe.right===0&&fe.bottom===0||fe.left===fe.right&&fe.top===fe.bottom)){const Qe=u._camera.getWorldToCamera(u.worldSize,u.projection.zAxisUnit==="meters"?K:1),je=u._camera.getCameraToClipPerspective(u._fov,u.width/u.height,r,c);je[8]=2*-u.centerOffset.x/u.width,je[9]=2*u.centerOffset.y/u.height;const it=new Float64Array(16);s.ad.mat4.mul(it,je,Qe);const _t=new Float64Array(16);s.ad.mat4.invert(_t,it);const yt=s.bR.fromInvProjectionMatrix(_t,A,g,!0);for(const wt of yt.points){const Ot=((ce=wt)[0]/=E,ce[1]/=E,ce[2]=s.bH(ce[2],u._center.lat),ce);se=Math.max(se,s.ad.vec3.len(s.ad.vec3.subtract([],oe,Ot)))}}var ce;se*=d/(d-1);const ue=Math.acos(t[2]),he=Math.atan2(-t[0],-t[1]),_e=new Ga;_e.position=oe,_e.setPitchBearing(ue,he);const xe=_e.getWorldToCamera(A,K),Ue=se*A,Le=Math.min(u._mercatorZfromZoom(17)*A*-2,-2*Ue),Ye=_e.getCameraToClipOrthographic(-Ue,Ue,-Ue,Ue,Le,(Ue+m*K)/t[2]),Je=new Float64Array(16);s.ad.mat4.multiply(Je,Ye,xe);const at=s.ad.vec3.fromValues(Math.floor(1e6*oe[0])/1e6*A,Math.floor(1e6*oe[1])/1e6*A,0),De=.5*d,Ke=[0,0,0];s.ad.vec3.transformMat4(Ke,at,Je),s.ad.vec3.scale(Ke,Ke,De);const Ie=[Math.floor(Ke[0]),Math.floor(Ke[1]),Math.floor(Ke[2])],Xe=[0,0,0];s.ad.vec3.sub(Xe,Ke,Ie),s.ad.vec3.scale(Xe,Xe,-1/De);const He=new Float64Array(16);return s.ad.mat4.identity(He),s.ad.mat4.translate(He,He,Xe),s.ad.mat4.multiply(Je,He,Je),[Je,Ue]}class N_ extends s.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.numModelsLoading={}}loadModel(t,r){return s.aN(this.requestManager.transformRequest(r,s.R.Model).url).then(c=>{if(!c)return;const d=s.aO(c),m=new s.aP(t,void 0,void 0,d);return m.computeBoundsAndApplyParent(),m}).catch(c=>{if(c&&c.status===404)return null;this.fire(new s.z(new Error(`Could not load model ${t} from ${r}: ${c.message}`)))})}load(t,r,c={keepNumReferences:!1}){this.models[r]||(this.models[r]={});const d=Object.keys(t);this.numModelsLoading[r]=(this.numModelsLoading[r]||0)+d.length;const m=[];for(const g of d)m.push(this.loadModel(g,t[g]));Promise.allSettled(m).then(g=>{for(let E=0;E<g.length;E++){const{status:A,value:C}=g[E];if(A==="fulfilled"&&C){const R=this.models[r][d[E]];this.models[r][d[E]]={model:C,numReferences:c.keepNumReferences&&R?R.numReferences:1}}}this.numModelsLoading[r]-=d.length,this.fire(new s.A("data",{dataType:"style"}))}).catch(g=>{this.fire(new s.z(new Error(`Could not load models: ${g.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,r){return!!this.getModel(t,r)}getModel(t,r){return this.models[r]||(this.models[r]={}),this.models[r][t]?this.models[r][t].model:void 0}addModel(t,r,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={}),this.hasModel(t,c)&&this.models[c][t].numReferences++,this.modelUris[c][t]=this.requestManager.normalizeModelURL(r),this.load({[t]:this.modelUris[c][t]},c)}addModels(t,r){this.models[r]||(this.models[r]={}),this.modelUris[r]||(this.modelUris[r]={});const c=this.modelUris[r];for(const d in t)this.models[r][d]={},c[d]=this.requestManager.normalizeModelURL(t[d]);this.load(c,r,{keepNumReferences:!0})}reloadModels(t){this.load(this.modelUris[t],t)}addModelsFromBucket(t,r){this.models[r]||(this.models[r]={}),this.modelUris[r]||(this.modelUris[r]={});const c={};for(const d of t)this.hasModel(d,r)?this.models[r][d].numReferences++:(this.modelUris[r][d]=this.requestManager.normalizeModelURL(d),c[d]=this.modelUris[r][d]);this.load(c,r)}removeModel(t,r){if(this.models[r]&&this.models[r][t]&&(this.models[r][t].numReferences--,this.models[r][t].numReferences===0)){const c=this.models[r][t].model;delete this.models[r][t],delete this.modelUris[r][t],c.destroy()}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,r){this.models[r]||(this.models[r]={});for(const c in this.models[r])this.models[r][c].model&&this.models[r][c].model.upload(t.context)}}const V_=new s.a7({data:new s.a8(s.a5.colorTheme.data)}),Lh={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function np(u){return u=u||{},Object.assign(u,Lh)}class sp extends s.E{constructor(t){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},s.aQ(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=t,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new s.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=t.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=t.stylesheet.indoor.buildingFeaturesetId,this._scope=t.scope))}),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:t=>(t.feature&&t.feature.properties.floorplan&&this.selectFloorplan(t.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(t){if(!this._queryFeatureSetId||!this._map.isStyleLoaded()||this._map.transform.zoom<13)return;this._indoorData&&!function(g,E){const[A,C]=g,{center:R,radius:L}=E,[O,V]=R,H=Math.abs(A-O);return Math.sqrt((H>180?360-H:H)**2+(C-V)**2)<=L}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new s.A("floorplangone")));const r={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},c=new s.P(this._map.transform.width/2,this._map.transform.height/2),d=[new s.P(0,0),new s.P(this._map.transform.width,this._map.transform.height)],m=this._map.queryRenderedFeatures(t?d:c,r);m.length>0&&(this._selectedFloorplan&&m[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=m[0],this._floorplanSelected(!1)))}_floorplanSelected(t){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(m){const[[g,E],[A,C]]=m,R=(A-g+360)%360,L=R>180?360-R:R;return{center:[(g+L/2+360)%360,(E+C)/2],radius:Math.sqrt(L**2+(C-E)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});const r=this._floorplanStates[this._indoorData.id].selectedBuilding,c=this._floorplanStates[this._indoorData.id].selectedLevel;let d;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(const m of this._indoorData.levels)m.id===this._selectedLevel.id&&(d=m.id);if(this.fire(new s.A("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:d})),r){const m=this._indoorData.buildings.find(g=>g.id===r);this._buildingSelected(m,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(c){const m=this._indoorData.levels.find(g=>g.id===c);this._updateLevels(m,t)}else t&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(t,r){r&&t&&t.extent&&this._map.fitBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=t?t.id:void 0;const c=this._indoorData.levels.filter(d=>t.levels.includes(d.id));this.fire(new s.A("buildingselected",{buildingId:t.id,levels:c}))}_levelSelected(t){if(t==="overview")this._updateLevels(void 0,!0);else{const r=this._indoorData.levels.find(c=>c.id===t);this._updateLevels(r,!0)}this.fire(new s.A("levelselected",{levelId:t==="overview"?void 0:t}))}_updateLevels(t,r){if(!t)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(r&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function c(C){const R=C.indexOf("/floor/");if(R===-1)return C;const L=R+7,O=C.indexOf("/",L);return O===-1?C.slice(L):C.slice(L,O)}this._selectedLevel=t,this._floorplanStates[this._indoorData.id].selectedLevel=t?t.id:void 0;const d=[],m={},g={},E={},A={};for(const C of this._indoorData.levels)if(d.push(C.id),m[C.id]=C.height,g[C.id]=C.base,t){if(this.mergeFloors){const R=c(t.id),L=c(C.id);E[C.id]=L===R?"true":"false"}else E[C.id]=C.id===t.id?"true":"false";A[C.id]=C.base<t.base?"true":"false"}else A[C.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",d]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",m]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",g]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",E]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",A]),t&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!t.isUnderground),r&&t.extent)){const C=this._map.cameraForBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),R=this._map.getZoom(),L=C.zoom?Math.abs(R-C.zoom):0;this._map.fitBounds(t.extent,L>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:R})}}selectFloorplan(t){const r={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},c=[new s.P(0,0),new s.P(this._map.transform.width,this._map.transform.height)],d=this._map.queryRenderedFeatures(c,r);if(d.length>0){for(const m of d)if(JSON.parse(m.properties["indoor-data"]).floorplanIDs.includes(t)){this._selectedFloorplan=m,this._floorplanSelected(!0);break}}}selectBuilding(t){const r=this._indoorData.buildings.find(c=>c.id===t);this._buildingSelected(r,!0)}selectLevel(t){this._levelSelected(t)}}function op(u){if(!u.metadata||!u.metadata.content_area)return;const t=s.q.devicePixelRatio,{left:r,top:c,width:d,height:m}=u.metadata.content_area,g=r*t,E=c*t;return[g,E,g+d*t,E+m*t]}function ru(u){if(u)return u.map(([t,r])=>[t*s.q.devicePixelRatio,r*s.q.devicePixelRatio])}class U_{constructor(t,r){this.id=t,this.style=r}addIcons(t){const r=new Map;for(const[c,d]of t.entries()){const m=s.I.from({name:c,iconsetId:this.id});r.set(m,d)}this.style.addImages(r)}}const ua=(u,t)=>Ve(u,t&&t.filter(r=>r.identifier!=="source.canvas")),j_=s.aA(qi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport"]),G_=s.aA(qi,["setCenter","setZoom","setBearing","setPitch"]),nu=new Set(["background","sky","slot","custom"]),ap={version:8,layers:[],sources:{}},Kl={duration:300,delay:0};class Fs extends s.E{constructor(t,r={}){super(),this.map=t,this.scope=r.scope||"",this.globalId=null,this.fragments=[],this.importDepth=r.importDepth||0,this.importsCache=r.importsCache||new Map,this.resolvedImports=r.resolvedImports||new Set,this.transition=s.l({},Kl),this._buildingIndex=new Qf(this),this.crossTileSymbolIndex=new B_,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=r.styleChanges||new Be,this.dispatcher=r.dispatcher?r.dispatcher:new s.D(s.cj(),this),r.imageManager?this.imageManager=r.imageManager:(this.imageManager=new bt(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=r.glyphManager?r.glyphManager:new s.ck(t._requestManager,r.localFontFamily?s.cl.all:r.localIdeographFontFamily?s.cl.ideographs:s.cl.none,r.localFontFamily||r.localIdeographFontFamily),r.modelManager?this.modelManager=r.modelManager:(this.modelManager=new N_(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=r.configOptions?r.configOptions:new Map,this._configDependentLayers=r.configDependentLayers?r.configDependentLayers:new Set,this._config=r.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:r.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=r.initialConfig,this.dispatcher.broadcast("setReferrer",s.cm());const c=this;this._rtlTextPluginCallback=Fs.registerForPluginStateChange(d=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:d.pluginStatus,pluginURL:d.pluginURL},(m,g)=>{if(s.cn(m),g&&g.every(E=>E))for(const E in c._sourceCaches){const A=c._sourceCaches[E],C=A.getSource().type;C!=="vector"&&C!=="geojson"||A.reload()}})}),this.on("data",d=>{if(d.dataType!=="source"||d.sourceDataType!=="metadata")return;const m=this.getOwnSource(d.sourceId);if(m&&m.vectorLayerIds)for(const g in this._layers){const E=this._layers[g];E.source===m.id&&this._validateLayer(E)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(s.f(t))return t;const r=s.co(t);if(!r.startsWith("http"))try{return new URL(r,location.href).toString()}catch{return r}return r}return`json://${s.cp(JSON.stringify(t))}`}_diffStyle(t,r,c){this.globalId=this._getGlobalId(t);const d=(m,g)=>{try{g(null,this.setState(m,c))}catch(E){g(E,!1)}};if(typeof t=="string"){const m=this.map._requestManager.normalizeStyleURL(t),g=this.map._requestManager.transformRequest(m,s.R.Style);s.n(g,(E,A)=>{E?this.fire(new s.z(E)):A&&d(A,r)})}else typeof t=="object"&&d(t,r)}loadURL(t,r={}){this.fire(new s.A("dataloading",{dataType:"style"}));const c=typeof r.validate=="boolean"?r.validate:!s.f(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,r.accessToken),this.resolvedImports.add(t);const d=this.importsCache.get(t);if(d)return this._load(d,c);const m=this.map._requestManager.transformRequest(t,s.R.Style);this._request=s.n(m,(g,E)=>{if(this._request=null,g)this.fire(new s.z(g));else if(E)return this.importsCache.set(t,E),this._load(E,c)})}loadJSON(t,r={}){this.fire(new s.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=s.q.frame(()=>{this._request=null,this._load(t,r.validate!==!1)})}loadEmpty(){this.fire(new s.A("dataloading",{dataType:"style"})),this._load(ap,!1)}_loadImports(t,r,c){if(this.importDepth>=4)return s.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const d=[];for(const m of t){const g=this._createFragmentStyle(m),E=new Promise(R=>{g.once("style.import.load",R),g.once("error",R)}).then(()=>this.mergeAll());if(d.push(E),this.resolvedImports.has(m.url)){g.loadEmpty();continue}const A=m.data||this.importsCache.get(m.url);A?(g.loadJSON(A,{validate:r}),this._isInternalStyle(A)&&(g.globalId=null)):m.url?g.loadURL(m.url,{validate:r}):g.loadEmpty();const C={style:g,id:m.id,config:m.config};if(c){const R=this.fragments.findIndex(({id:L})=>L===c);this.fragments=this.fragments.slice(0,R).concat(C).concat(this.fragments.slice(R))}else this.fragments.push(C)}return Promise.allSettled(d)}getImportGlobalIds(t=this,r=new Set){for(const c of t.fragments)c.style.globalId&&r.add(c.style.globalId),this.getImportGlobalIds(c.style,r);return[...r.values()]}_createFragmentStyle(t){const r=this.scope?s.C(t.id,this.scope):t.id;let c;const d=this._initialConfig&&this._initialConfig[r];(t.config||d)&&(c=s.l({},t.config,d));const m=new Fs(this.map,{scope:r,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return m.setEventedParent(this.map,{style:m}),m}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,r){const c=t.indoor?np(t.schema):t.schema;if(this._isInternalStyle(t)){const g=s.l({},ap,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(g,r)}if(this.updateConfig(this._config,c),r&&ua(this,Nn(t)))return;this._loaded=!0,this.stylesheet=s.cq(t);const d=()=>{for(const C in t.sources)this.addSource(C,t.sources[C],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const C in t.iconsets)this.addIconset(C,t.iconsets[C]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.setGlyphsUrl(t.glyphs);const g=jl(this.stylesheet.layers);if(this._order=g.map(C=>C.id),this.stylesheet.light&&s.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const C=this.stylesheet.lights[0];this.light=new Ge(C.properties,C.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Ge(this.stylesheet.light)),this._layers={};for(const C of g){const R=s.cv(C,this.scope,this._styleColorTheme.lut,this.options);R.configDependencies.size!==0&&this._configDependentLayers.add(R.fqid),R.setEventedParent(this,{layer:{id:R.id}}),this._layers[R.id]=R;const L=this.getOwnLayerSourceCache(R),O=!!this.directionalLight&&this.directionalLight.shadowsEnabled();L&&R.canCastShadows()&&O&&(L.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const E=this.stylesheet.terrain;E&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(E,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new s.A("data",{dataType:"style"}));const A=this.isRootStyle();t.imports?this._loadImports(t.imports,r).then(()=>{this._reloadImports(),this.fire(new s.A(A?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new s.A(A?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const m=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(m){const g=this._evaluateColorThemeData(m);this._loadColorTheme(g).then(()=>{d()}).catch(E=>{s.w(`Couldn't load color theme from the stylesheet: ${E}`),d()})}else this._styleColorTheme.lut=null,d()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,r,c,d,m,g,E,A,C,R;const L={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(O=>{if(O.stylesheet){if(O.light!=null&&(t=O.light),O.stylesheet.lights)for(const V of O.stylesheet.lights)V.type==="ambient"&&O.ambientLight!=null&&(r=O.ambientLight),V.type==="directional"&&O.directionalLight!=null&&(c=O.directionalLight);d=this._prioritizeTerrain(d,O.terrain,O.stylesheet.terrain),O.stylesheet.fog&&O.fog!=null&&(m=O.fog),O.stylesheet.snow&&O.snow!=null&&(g=O.snow),O.stylesheet.rain&&O.rain!=null&&(E=O.rain),O.stylesheet.camera!=null&&(R=O.stylesheet.camera),O.stylesheet.projection!=null&&(A=O.stylesheet.projection),O.stylesheet.transition!=null&&(C=O.stylesheet.transition),L[O.scope]=O._styleColorTheme}}),this.light=t,this.ambientLight=r,this.directionalLight=c,this.fog=m,this.snow=g,this.rain=E,this._styleColorThemeForScope=L,d===null?delete this.terrain:this.terrain=d,this.camera=R||{"camera-projection":"perspective"},this.projection=A||{name:"mercator"},this.transition=s.l({},Kl,C),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const r=c=>{for(const d of c.fragments)r(d.style);t(c)};r(this)}_prioritizeTerrain(t,r,c){const d=t&&t.drapeRenderMode===0;return c===null?r&&r.drapeRenderMode===0?r:d?t:null:r!=null&&(!t||d||r&&r.drapeRenderMode===1)?r:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(r=>{t=this._prioritizeTerrain(t,r.terrain,r.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(r=>{r.stylesheet.projection!=null&&(t=r.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},r={},c={};this.forEachFragmentStyle(d=>{for(const m in d._sourceCaches){const g=s.C(m,d.scope);t[g]=d._sourceCaches[m]}for(const m in d._otherSourceCaches){const g=s.C(m,d.scope);r[g]=d._otherSourceCaches[m]}for(const m in d._symbolSourceCaches){const g=s.C(m,d.scope);c[g]=d._symbolSourceCaches[m]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=r,this._mergedSymbolSourceCaches=c}mergeLayers(){const t={},r=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(m=>{for(const g of m._order){const E=m._layers[g];if(E.type==="slot"){const A=s.cr(g);if(t[A])continue;t[A]=[]}E.slot&&t[E.slot]?t[E.slot].push(E):r.push(E)}}),this._mergedOrder=[];const d=(m=[])=>{for(const g of m)if(g.type==="slot"){const E=s.cr(g.id);t[E]&&d(t[E]),this._mergedSlots.push(E)}else{const E=s.C(g.id,g.scope);this._mergedOrder.push(E),c[E]=g,g.is3D(!!this.terrain)&&(this._has3DLayers=!0),g.type==="circle"&&(this._hasCircleLayers=!0),g.type==="symbol"&&(this._hasSymbolLayers=!0),g.type==="clip"&&(this._clipLayerPresent=!0)}};d(r),this._mergedOrder.sort((m,g)=>{const E=c[m],A=c[g];return E.hasInitialOcclusionOpacityProperties?A.is3D(!!this.terrain)?1:0:E.is3D(!!this.terrain)&&A.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=s.l({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(r,c,d){const m=s.l({},c);for(const E of Object.keys(s.a5.colorTheme))m[E]===void 0&&(m[E]=s.a5.colorTheme[E].default);const g=new s.a6(V_,r,new Map(d));return g.setTransitionOrValue(m,d),g.untransitioned().possiblyEvaluate(new s.aa(0))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const r=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((c,d)=>{const m="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let g=t;g.startsWith(m)||(g=m+g);const E=s.I.from("mapbox-reserved-lut"),A=new Image;A.src=g,A.onerror=()=>{this._styleColorTheme.lutLoading=!1,d(new Error("Failed to load image data"))},A.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==r)return void c();this._styleColorTheme.lutLoading=!1;const{width:C,height:R,data:L}=s.q.getImageData(A);if(R>32)return void d(new Error("The height of the image must be less than or equal to 32 pixels."));if(C!==R*R)return void d(new Error("The width of the image must be equal to the height squared."));this.getImage(E)&&this.removeImage(E),this.addImage(E,{data:new s.r({width:C,height:R},L),pixelRatio:1,sdf:!1,usvg:!1,version:0});const O=this.imageManager.getImage(E,this.scope);O?(this._styleColorTheme.lut={image:O.data,data:t},c()):d(new Error("Missing LUT image."))}})}getLut(t){const r=this._styleColorThemeForScope[t];return r?r.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(r,c,d){let m,g,E;const A=s.q.devicePixelRatio>1?"@2x":"";let C=s.n(c.transformRequest(c.normalizeSpriteURL(r,A,".json"),s.R.SpriteJSON),(O,V)=>{C=null,E||(E=O,m=V,L())}),R=s.o(c.transformRequest(c.normalizeSpriteURL(r,A,".png"),s.R.SpriteImage),(O,V)=>{R=null,E||(E=O,g=V,L())});function L(){if(E)d(E);else if(m&&g){const O=s.q.getImageData(g),V={};for(const H in m){const{width:G,height:W,x:K,y:ie,sdf:oe,pixelRatio:se,stretchX:fe,stretchY:ce,content:ue}=m[H],he=new s.r({width:G,height:W});s.r.copy(O,he,{x:K,y:ie},{x:0,y:0},{width:G,height:W},null),V[H]={data:he,pixelRatio:se,sdf:oe,stretchX:fe,stretchY:ce,content:ue,usvg:!1}}d(null,V)}}return{cancel(){C&&(C.cancel(),C=null),R&&(R.cancel(),R=null)}}}(t,this.map._requestManager,(r,c)=>{if(this._spriteRequest=null,r)this.fire(new s.z(r));else if(c){const d=new Map;for(const m in c)d.set(s.I.from(m),c[m]);this.addImages(d)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.A("data",{dataType:"style"}))})}addIconset(t,r){if(r.type==="sprite")return void this._loadSprite(r.url);const c=this.getOwnSource(r.source);if(!c)return void this.fire(new s.z(new Error(`Source "${r.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));if(c.type!=="raster-array")return void this.fire(new s.z(new Error(`Source "${r.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));this.imageManager.createIconset(this.scope,t);const d=new U_(t,this);c.addIconset(t,d)}_loadIconset(t){if(!s.f(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const r=this.map._spriteFormat==="auto";var c,d;this._spriteRequest=(d=(m,g)=>{if(this._spriteRequest=null,m)r?this._loadSprite(t):this.fire(new s.z(m));else if(g){const E=new Map;for(const A in g)E.set(s.I.from(A),g[A]);this.addImages(E)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.A("data",{dataType:"style"}))},s.bj((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),s.R.Iconset),(m,g)=>{if(m)return void d(m);const E={},A=s.ch(new s.bi(g));for(const C of A.icons){const R={version:1,pixelRatio:s.q.devicePixelRatio,content:op(C),stretchX:C.metadata?ru(C.metadata.stretch_x_areas):void 0,stretchY:C.metadata?ru(C.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:C};E[C.name]=R}d(null,E)}))}_validateLayer(t){const r=this.getOwnSource(t.source);if(!r)return;const c=t.sourceLayer;c&&(r.type==="geojson"||r.vectorLayerIds&&r.vectorLayerIds.indexOf(c)===-1)&&this.fire(new s.z(new Error(`Source layer "${c}" does not exist on source "${r.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,r)=>{const c=this.fragments[r];return c&&c.style&&(t.data=c.style.serialize()),t})}_serializeSources(){const t={};for(const r in this._sourceCaches){const c=this._sourceCaches[r].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){const r=[];for(const c of t){const d=this._layers[c];d&&d.type!=="custom"&&r.push(d.serialize())}return r}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const r=this.getOwnLayer(t);if(r)return r;this.fire(new s.z(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const r=this.getOwnSource(t);if(r)return r;this.fire(new s.z(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,r){const c=this.map.painter;if(c)for(let d=t.minzoom||0;d<(t.maxzoom||25.5);d++){const m=t.getProgramIds();if(m)for(const g of m){const E=t.getDefaultProgramParams(g,r.zoom,this._styleColorTheme.lut);E&&(c.style=this,this.fog&&(c._fogVisible=!0,E.overrideFog=!0,c.getOrCreateProgram(g,E)),c._fogVisible=!1,E.overrideFog=!1,c.getOrCreateProgram(g,E),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(E.overrideRtt=!0,c.getOrCreateProgram(g,E)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const r=this.calculateLightsBrightness();t.brightness=r||0,r!==this._brightness&&(this._brightness=r,this.dispatcher.broadcast("setBrightness",r));const c=this._changes.isDirty();let d=!1;if(this._changes.isDirty()){const g=this._changes.getLayerUpdatesByScope();for(const E in g){const{updatedIds:A,removedIds:C}=g[E];(A||C)&&(this._updateWorkerLayers(E,A,C),d=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const m={};for(const g in this._mergedSourceCaches){const E=this._mergedSourceCaches[g];m[g]=E.used,E.used=!1,E.tileCoverLift=0}for(const g of this._mergedOrder){const E=this._mergedLayers[g];if(E.recalculate(t,this._availableImages),!E.isHidden(t.zoom)){const A=this.getLayerSourceCache(E);A&&(A.used=!0,A.tileCoverLift=Math.max(A.tileCoverLift,E.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(E,t)}):this.precompilePrograms(E,t))}for(const g in this._mergedSourceCaches){const E=this._mergedSourceCaches[g];if(!E)continue;const A=E._source;A.type==="raster-array"&&A.iconsets&&(E.used=!0)}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&d&&this.mergeLayers();for(const g in m){const E=this._mergedSourceCaches[g];m[g]!==E.used&&E.getSource().fire(new s.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:E.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),c&&this.fire(new s.A("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=this._changes.getUpdatedImages();if(t.length){for(const r in this._mergedSourceCaches)this._mergedSourceCaches[r].reloadTilesForDependencies(["icons","patterns"],t);this._changes.resetUpdatedImages()}}_updateWorkerLayers(t,r,c){const d=this.getFragmentStyle(t);d&&this.dispatcher.broadcast("updateLayers",{layers:r?d._serializeLayers(r):[],scope:t,removedIds:c||[],options:d.options})}setState(t,r){if(this._checkLoaded(),ua(this,Nn(t)))return!1;(t=s.cq(t)).layers=jl(t.layers);const c=function(g,E){if(!g)return[{command:qi.setStyle,args:[E]}];let A=[];try{if(!s.bn(g.version,E.version))return[{command:qi.setStyle,args:[E]}];if(s.bn(g.center,E.center)||A.push({command:qi.setCenter,args:[E.center]}),s.bn(g.zoom,E.zoom)||A.push({command:qi.setZoom,args:[E.zoom]}),s.bn(g.bearing,E.bearing)||A.push({command:qi.setBearing,args:[E.bearing]}),s.bn(g.pitch,E.pitch)||A.push({command:qi.setPitch,args:[E.pitch]}),s.bn(g.sprite,E.sprite)||A.push({command:qi.setSprite,args:[E.sprite]}),s.bn(g.glyphs,E.glyphs)||A.push({command:qi.setGlyphs,args:[E.glyphs]}),s.bn(g.imports,E.imports)||function(V=[],H=[],G){H=H||[];const W=(V=V||[]).map(Fi),K=H.map(Fi),ie=V.reduce(An,{}),oe=H.reduce(An,{}),se=W.slice();let fe,ce,ue,he;for(fe=0,ce=0;fe<W.length;fe++)ue=W[fe],oe.hasOwnProperty(ue)?ce++:(G.push({command:qi.removeImport,args:[ue]}),se.splice(se.indexOf(ue,ce),1));for(fe=0,ce=0;fe<K.length;fe++)ue=K[K.length-1-fe],se[se.length-1-fe]!==ue&&(ie.hasOwnProperty(ue)?(G.push({command:qi.removeImport,args:[ue]}),se.splice(se.lastIndexOf(ue,se.length-ce),1)):ce++,he=se[se.length-fe],G.push({command:qi.addImport,args:[oe[ue],he]}),se.splice(se.length-fe,0,ue));for(const _e of H){const xe=ie[_e.id];xe&&!s.bn(xe,_e)&&G.push({command:qi.updateImport,args:[_e.id,_e]})}}(g.imports,E.imports,A),s.bn(g.transition,E.transition)||A.push({command:qi.setTransition,args:[E.transition]}),s.bn(g.light,E.light)||A.push({command:qi.setLight,args:[E.light]}),s.bn(g.fog,E.fog)||A.push({command:qi.setFog,args:[E.fog]}),s.bn(g.snow,E.snow)||A.push({command:qi.setSnow,args:[E.snow]}),s.bn(g.rain,E.rain)||A.push({command:qi.setRain,args:[E.rain]}),s.bn(g.projection,E.projection)||A.push({command:qi.setProjection,args:[E.projection]}),s.bn(g.lights,E.lights)||A.push({command:qi.setLights,args:[E.lights]}),s.bn(g.camera,E.camera)||A.push({command:qi.setCamera,args:[E.camera]}),!s.bn(g["color-theme"],E["color-theme"]))return[{command:qi.setStyle,args:[E]}];const C={},R=[];(function(V,H,G,W){let K;for(K in H=H||{},V=V||{})V.hasOwnProperty(K)&&(H.hasOwnProperty(K)||Kc(K,G,W));for(K in H){if(!H.hasOwnProperty(K))continue;const ie=H[K];V.hasOwnProperty(K)?s.bn(V[K],ie)||(V[K].type==="geojson"&&ie.type==="geojson"&&Ft(V,H,K)?G.push({command:qi.setGeoJSONSourceData,args:[K,ie.data]}):ka(K,H,G,W)):bs(K,H,G)}})(g.sources,E.sources,R,C);const L=[];g.layers&&g.layers.forEach(V=>{V.source&&C[V.source]?A.push({command:qi.removeLayer,args:[V.id]}):L.push(V)});let O=g.terrain;O&&C[O.source]&&(A.push({command:qi.setTerrain,args:[void 0]}),O=void 0),A=A.concat(R),s.bn(O,E.terrain)||A.push({command:qi.setTerrain,args:[E.terrain]}),function(V,H,G){H=H||[];const W=(V=V||[]).map(Fi),K=H.map(Fi),ie=V.reduce(An,{}),oe=H.reduce(An,{}),se=W.slice(),fe=Object.create(null);let ce,ue,he,_e,xe,Ue,Le;for(ce=0,ue=0;ce<W.length;ce++)he=W[ce],oe.hasOwnProperty(he)?ue++:(G.push({command:qi.removeLayer,args:[he]}),se.splice(se.indexOf(he,ue),1));for(ce=0,ue=0;ce<K.length;ce++)he=K[K.length-1-ce],se[se.length-1-ce]!==he&&(ie.hasOwnProperty(he)?(G.push({command:qi.removeLayer,args:[he]}),se.splice(se.lastIndexOf(he,se.length-ue),1)):ue++,Ue=se[se.length-ce],G.push({command:qi.addLayer,args:[oe[he],Ue]}),se.splice(se.length-ce,0,he),fe[he]=!0);for(ce=0;ce<K.length;ce++)if(he=K[ce],_e=ie[he],xe=oe[he],!fe[he]&&!s.bn(_e,xe))if(s.bn(_e.source,xe.source)&&s.bn(_e["source-layer"],xe["source-layer"])&&s.bn(_e.type,xe.type)){for(Le in Ki(_e.layout,xe.layout,G,he,null,qi.setLayoutProperty),Ki(_e.paint,xe.paint,G,he,null,qi.setPaintProperty),s.bn(_e.slot,xe.slot)||G.push({command:qi.setSlot,args:[he,xe.slot]}),s.bn(_e.filter,xe.filter)||G.push({command:qi.setFilter,args:[he,xe.filter]}),s.bn(_e.minzoom,xe.minzoom)&&s.bn(_e.maxzoom,xe.maxzoom)||G.push({command:qi.setLayerZoomRange,args:[he,xe.minzoom,xe.maxzoom]}),_e)_e.hasOwnProperty(Le)&&Le!=="layout"&&Le!=="paint"&&Le!=="filter"&&Le!=="metadata"&&Le!=="minzoom"&&Le!=="maxzoom"&&Le!=="slot"&&(Le.indexOf("paint.")===0?Ki(_e[Le],xe[Le],G,he,Le.slice(6),qi.setPaintProperty):s.bn(_e[Le],xe[Le])||G.push({command:qi.setLayerProperty,args:[he,Le,xe[Le]]}));for(Le in xe)xe.hasOwnProperty(Le)&&!_e.hasOwnProperty(Le)&&Le!=="layout"&&Le!=="paint"&&Le!=="filter"&&Le!=="metadata"&&Le!=="minzoom"&&Le!=="maxzoom"&&Le!=="slot"&&(Le.indexOf("paint.")===0?Ki(_e[Le],xe[Le],G,he,Le.slice(6),qi.setPaintProperty):s.bn(_e[Le],xe[Le])||G.push({command:qi.setLayerProperty,args:[he,Le,xe[Le]]}))}else G.push({command:qi.removeLayer,args:[he]}),Ue=se[se.lastIndexOf(he)+1],G.push({command:qi.addLayer,args:[xe,Ue]})}(L,E.layers,A)}catch(C){console.warn("Unable to compute style diff:",C),A=[{command:qi.setStyle,args:[E]}]}return A}(this.serialize(),t).filter(g=>!(g.command in G_));if(c.length===0)return!1;const d=c.filter(g=>!(g.command in j_));if(d.length>0)throw new Error(`Unimplemented: ${d.map(g=>g.command).join(", ")}.`);const m=[];return c.forEach(g=>{m.push(this[g.command].apply(this,g.args))}),r&&Promise.all(m).then(r),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}addImages(t){for(const[r,c]of t.entries()){if(this.getImage(r)&&!r.iconsetId)return this.fire(new s.z(new Error(`An image with the name "${r.name}" already exists.`)));this.imageManager.addImage(r,this.scope,c),this._changes.updateImage(r)}return this._updateWorkerImages(),this.fire(new s.A("data",{dataType:"style"})),this}addImage(t,r){return this.getImage(t)&&!t.iconsetId?this.fire(new s.z(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,r),this._changes.updateImage(t),this._updateWorkerImages(),this.fire(new s.A("data",{dataType:"style"})),this)}updateImage(t,r,c=!1){this.imageManager.updateImage(t,this.scope,r),c&&(this._changes.updateImage(t),this._updateWorkerImages(),this.fire(new s.A("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t),this._updateWorkerImages(),this.fire(new s.A("data",{dataType:"style"})),this):this.fire(new s.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(t,r,c={}){return this._checkLoaded(),this._validate(ye,`models.${t}`,r,null,c)||(this.modelManager.addModel(t,r,this.scope),this._changes.setDirty()),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this):this.fire(new s.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,r,c={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!r.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(r).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(r.type)>=0&&this._validate(sa,`sources.${t}`,r,null,c))return;this.map&&this.map._collectResourceTiming&&(r.collectResourceTiming=!0);const d=Wc(t,r,this.dispatcher,this);d.scope=this.scope,d.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(d.id),source:d.serialize(),sourceId:d.id}));const m=g=>{const E=(g?"symbol:":"other:")+d.id,A=s.C(E,this.scope),C=this._sourceCaches[E]=new xs(A,d,g);(g?this._symbolSourceCaches:this._otherSourceCaches)[d.id]=C,C.onAdd(this.map)};m(!1),r.type!=="vector"&&r.type!=="geojson"||m(!0),d.onAdd&&d.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const r=this.getOwnSource(t);if(!r)throw new Error("There is no source with this ID");for(const d in this._layers)if(this._layers[d].source===t)return this.fire(new s.z(new Error(`Source "${t}" cannot be removed while layer "${d}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new s.z(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));const c=this.getOwnSourceCaches(t);for(const d of c){const m=s.cr(d.id);delete this._sourceCaches[m],this._changes.discardSourceCacheUpdate(d.id),d.fire(new s.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:d.getSource().id})),d.setEventedParent(null),d.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),r.setEventedParent(null),r.onRemove&&r.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,r){this._checkLoaded(),this.getOwnSource(t).setData(r),this._changes.setDirty()}getOwnSource(t){const r=this.getOwnSourceCache(t);return r&&r.getSource()}getOwnSources(){const t=[];for(const r in this._otherSourceCaches){const c=this.getOwnSourceCache(r);c&&t.push(c.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const r in t){const c=t[r]._tiles;for(const d in c){const m=c[d];if(m.state!=="loaded"&&m.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const r=this._getTransitionParameters();for(const d of t){if(this._validate(Ra,"lights",d))return;switch(d.type){case"ambient":if(this.ambientLight){const m=this.ambientLight;m.set(d),m.updateTransitions(r)}else this.ambientLight=new Br(d,Mi||(Mi=new s.a7({color:new s.a8(s.a5.properties_light_ambient.color),"color-use-theme":new s.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.a8(s.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const m=this.directionalLight;m.set(d),m.updateTransitions(r)}else this.directionalLight=new Br(d,Qi||(Qi=new s.a7({direction:new s.am(s.a5.properties_light_directional.direction),color:new s.a8(s.a5.properties_light_directional.color),"color-use-theme":new s.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.a8(s.a5.properties_light_directional.intensity),"cast-shadows":new s.a8(s.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new s.a8(s.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new s.a8(s.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const c=new s.aa(this.z||0,r);this.ambientLight&&this.ambientLight.recalculate(c),this.directionalLight&&this.directionalLight.recalculate(c),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,r=this.ambientLight;if(!t||!r)return;const c=O=>.2126*(O[0]<=.03928?O[0]/12.92:Math.pow((O[0]+.055)/1.055,2.4))+.7152*(O[1]<=.03928?O[1]/12.92:Math.pow((O[1]+.055)/1.055,2.4))+.0722*(O[2]<=.03928?O[2]/12.92:Math.pow((O[2]+.055)/1.055,2.4)),d=t.properties.get("color").toRenderColor(null).toArray01(),m=t.properties.get("intensity"),g=t.properties.get("direction"),E=1-s.cc(g.x,g.y,g.z)[2]/90,A=c(d)*m*E,C=r.properties.get("color").toRenderColor(null).toArray01(),R=r.properties.get("intensity"),L=c(C)*R;return Number(((A+L)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(!t)return this;if(s.cs(t)){const r=s.ct(t),c=this.fragments.find(({id:m})=>m===r);if(!c)throw new Error(`Style import '${t}' not found`);const d=s.cr(t);return c.style.getFragmentStyle(d)}{const r=this.fragments.find(({id:c})=>c===t);return r?r.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const r={},c=(d,m="")=>`${d}::${m}`;this._featuresetSelectors={};for(const d in t){const m=this._featuresetSelectors[d]=[];for(const g of t[d].selectors){if(g.featureNamespace){const A=this.getOwnLayer(g.layer);if(!A){s.w(`Layer is undefined for selector: ${g.layer}`);continue}const C=c(A.source,A.sourceLayer);if(C in r&&r[C]!==g.featureNamespace){s.w(`"featureNamespace ${g.featureNamespace} of featureset ${d}'s selector is not associated to the same source, skip this selector`);continue}r[C]=g.featureNamespace}let E;if(g.properties)for(const A in g.properties){const C=s.X(g.properties[A]);C.result==="success"&&(E=E||{},E[A]=C.value)}m.push({layerId:g.layer,namespace:g.featureNamespace,properties:E,uniqueFeatureID:g._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const r=this.getFragmentStyle(t);if(!r||!r.stylesheet.featuresets)return[];const c=[];for(const d in r.stylesheet.featuresets)c.push({featuresetId:d,importId:r.scope?r.scope:void 0});return c}getFeaturesetLayers(t,r){const c=this.getFragmentStyle(r),d=c.stylesheet.featuresets;if(!d||!d[t])return this.fire(new s.z(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const m=[];for(const g of d[t].selectors){const E=c.getOwnLayer(g.layer);E&&m.push(E)}return m}getConfigProperty(t,r){const c=this.getFragmentStyle(t);if(!c)return null;const d=s.C(r,c.scope),m=c.options.get(d),g=m?m.value||m.default:null;return g?g.serialize():null}setConfigProperty(t,r,c){const d=this.getFragmentStyle(t);if(!d)return;const m=d.stylesheet.indoor?np(d.stylesheet.schema):d.stylesheet.schema;if(!m||!m[r])return;const g=s.X(c);if(g.result!=="success")return void ua(this,g.value);const E=g.value.expression,A=s.C(r,d.scope),C=d.options.get(A);if(!C)return;let R;const{minValue:L,maxValue:O,stepValue:V,type:H,values:G}=m[r],W=s.X(m[r].default);W.result==="success"&&(R=W.value.expression),R?(this.options.set(A,Object.assign({},C,{value:E,default:R,minValue:L,maxValue:O,stepValue:V,type:H,values:G})),this.updateConfigDependencies(r)):this.fire(new s.z(new Error(`No schema defined for the config option "${r}" in the "${t}" fragment.`)))}getConfig(t){const r=this.getFragmentStyle(t);if(!r)return null;const c=r.stylesheet.schema;if(!c)return null;const d={};for(const m in c){const g=s.C(m,r.scope),E=r.options.get(g),A=E?E.value||E.default:null;d[m]=A?A.serialize():null}return d}setConfig(t,r){const c=this.getFragmentStyle(t);c&&(c.updateConfig(r,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const r=this.getFragmentStyle(t);return r?r.stylesheet.schema:null}setSchema(t,r){const c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=r,c.updateConfig(c._config,r),this.updateConfigDependencies())}updateConfig(t,r){if(this._config=t,t||r)if(r)for(const c in r){let d,m;const g=s.X(r[c].default);if(g.result==="success"&&(d=g.value.expression),t&&t[c]!==void 0){const O=s.X(t[c]);O.result==="success"&&(m=O.value.expression)}const{minValue:E,maxValue:A,stepValue:C,type:R,values:L}=r[c];if(d){const O=s.C(c,this.scope);this.options.set(O,{default:d,value:m,minValue:E,maxValue:A,stepValue:C,type:R,values:L})}else this.fire(new s.z(new Error(`No schema defined for config option "${c}".`)))}else this.fire(new s.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(const r of this._configDependentLayers){const c=this.getLayer(r);if(c){if(t&&!c.configDependencies.has(t))continue;c.possiblyEvaluateVisibility(),this._updateLayer(c)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(r=>{const c=r._styleColorTheme.colorThemeOverride?r._styleColorTheme.colorThemeOverride:r._styleColorTheme.colorTheme;if(c){const d=r._evaluateColorThemeData(c);(!r._styleColorTheme.lut&&d!==""||r._styleColorTheme.lut&&d!==r._styleColorTheme.lut.data)&&r.setColorTheme(c)}}),this._changes.setDirty()}addLayer(t,r,c={}){this._checkLoaded();const d=t.id;if(this._layers[d])return void this.fire(new s.z(new Error(`Layer with id "${d}" already exists on this map`)));let m;if(t.type==="custom"){if(ua(this,s.cu(t)))return;m=s.cv(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(d,t.source),t=s.cq(t),t=s.l(t,{source:d})),this._validate(X,`layers.${d}`,t,{arrayIndex:-1},c))return;m=s.cv(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(m),m.setEventedParent(this,{layer:{id:d}})}m.configDependencies.size!==0&&this._configDependentLayers.add(m.fqid);let g=this._order.length;if(r){const R=this._order.indexOf(r);if(R===-1)return void this.fire(new s.z(new Error(`Layer with id "${r}" does not exist on this map.`)));m.slot===this._layers[r].slot?g=R:s.w(`Layer with id "${r}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(g,0,d),this._layerOrderChanged=!0,this._layers[d]=m;const E=this.getOwnLayerSourceCache(m),A=!!this.directionalLight&&this.directionalLight.shadowsEnabled();E&&m.canCastShadows()&&A&&(E.castsShadows=!0);const C=this._changes.getRemovedLayer(m);if(C&&m.source&&E&&m.type!=="custom"){this._changes.discardLayerRemoval(m);const R=s.C(m.source,m.scope);C.type!==m.type?this._changes.updateSourceCache(R,"clear"):(this._changes.updateSourceCache(R,"reload"),E.pause())}this._updateLayer(m),m.onAdd&&m.onAdd(this.map),m.scope=this.scope,this.mergeLayers()}moveLayer(t,r){this._checkLoaded();const c=this._checkLayer(t);if(!c||t===r)return;const d=this._order.indexOf(t);this._order.splice(d,1);let m=this._order.length;if(r){const g=this._order.indexOf(r);if(g===-1)return void this.fire(new s.z(new Error(`Layer with id "${r}" does not exist on this map.`)));c.slot===this._layers[r].slot?m=g:s.w(`Layer with id "${r}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(m,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const r=this._checkLayer(t);if(!r)return;r.setEventedParent(null);const c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(r.fqid),this._changes.removeLayer(r);const d=this.getOwnLayerSourceCache(r);if(d&&d.castsShadows){let m=!1;for(const g in this._layers)if(this._layers[g].source===r.source&&this._layers[g].canCastShadows()){m=!0;break}d.castsShadows=m}r.onRemove&&r.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const r in this._layers)if(this._layers[r].type===t)return!0;return!1}setLayerZoomRange(t,r,c){this._checkLoaded();const d=this._checkLayer(t);d&&(d.minzoom===r&&d.maxzoom===c||(r!=null&&(d.minzoom=r),c!=null&&(d.maxzoom=c),this._updateLayer(d)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,r){this._checkLoaded();const c=this._checkLayer(t);c&&c.slot!==r&&(c.slot=r,this._updateLayer(c))}setFilter(t,r,c={}){this._checkLoaded();const d=this._checkLayer(t);if(d&&!s.bn(d.filter,r))return r==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(Y,`layers.${d.id}.filter`,r,{layerType:d.type},c)||(d.filter=s.cq(r),this._updateLayer(d)))}getFilter(t){const r=this._checkLayer(t);if(r)return s.cq(r.filter)}setLayoutProperty(t,r,c,d={}){this._checkLoaded();const m=this._checkLayer(t);if(m&&!s.bn(m.getLayoutProperty(r),c)){if(c!=null&&(!d||d.validate!==!1)&&ua(m,ge.call(Nn,{key:`layers.${t}.layout.${r}`,layerType:m.type,objectKey:r,value:c,styleSpec:s.a5,style:{glyphs:!0,sprite:!0}})))return;m.setLayoutProperty(r,c),m.configDependencies.size!==0&&this._configDependentLayers.add(m.fqid),this._updateLayer(m)}}getLayoutProperty(t,r){const c=this._checkLayer(t);if(c)return c.getLayoutProperty(r)}setPaintProperty(t,r,c,d={}){this._checkLoaded();const m=this._checkLayer(t);if(!m||s.bn(m.getPaintProperty(r),c)||c!=null&&(!d||d.validate!==!1)&&ua(m,le.call(Nn,{key:`layers.${t}.paint.${r}`,layerType:m.type,objectKey:r,value:c,styleSpec:s.a5})))return;const g=m.setPaintProperty(r,c);m.configDependencies.size!==0&&this._configDependentLayers.add(m.fqid),g&&this._updateLayer(m),this._changes.updatePaintProperties(m)}getPaintProperty(t,r){const c=this._checkLayer(t);if(c)return c.getPaintProperty(r)}setFeatureState(t,r){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:A,importId:C}=t.target,R=this.getFragmentStyle(C),L=R.getFeaturesetLayers(A);for(const{source:O,sourceLayer:V}of L)R.setFeatureState({id:t.id,source:O,sourceLayer:V},r)}else if("layerId"in t.target){const{layerId:A}=t.target,C=this.getLayer(A);this.setFeatureState({id:t.id,source:C.source,sourceLayer:C.sourceLayer},r)}return}const c=t.source,d=t.sourceLayer,m=this._checkSource(c);if(!m)return;const g=m.type;if(g==="geojson"&&d)return void this.fire(new s.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(g==="vector"&&!d)return void this.fire(new s.z(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new s.z(new Error("The feature id parameter must be provided.")));const E=this.getOwnSourceCaches(c);for(const A of E)A.setFeatureState(d,t.id,r)}removeFeatureState(t,r){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:A,importId:C}=t.target,R=this.getFragmentStyle(C),L=R.getFeaturesetLayers(A);for(const{source:O,sourceLayer:V}of L)R.removeFeatureState({id:t.id,source:O,sourceLayer:V},r)}else if("layerId"in t.target){const{layerId:A}=t.target,C=this.getLayer(A);this.removeFeatureState({id:t.id,source:C.source,sourceLayer:C.sourceLayer},r)}return}const c=t.source,d=this._checkSource(c);if(!d)return;const m=d.type,g=m==="vector"?t.sourceLayer:void 0;if(m==="vector"&&!g)return void this.fire(new s.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(r&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new s.z(new Error("A feature id is required to remove its specific state property.")));const E=this.getOwnSourceCaches(c);for(const A of E)A.removeFeatureState(g,t.id,r)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let m;if("featuresetId"in t.target){const{featuresetId:g,importId:E}=t.target,A=this.getFragmentStyle(E),C=A.getFeaturesetLayers(g);for(const{source:R,sourceLayer:L}of C){const O=A.getFeatureState({id:t.id,source:R,sourceLayer:L});if(O&&!m)m=O;else if(!s.bn(m,O))return void this.fire(new s.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:g}=t.target,E=this.getLayer(g);m=this.getFeatureState({id:t.id,source:E.source,sourceLayer:E.sourceLayer})}return m}const r=t.source,c=t.sourceLayer,d=this._checkSource(r);if(d){if(d.type!=="vector"||c)return t.id===void 0&&this.fire(new s.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(r)[0].getFeatureState(c,t.id);this.fire(new s.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=s.l({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return s.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),r=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return s.cw({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:r,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},c=>c!==void 0)}_updateFilteredLayers(t){for(const r of Object.values(this._mergedLayers))t(r)&&this._updateLayer(r)}_updateLayer(t){this._changes.updateLayer(t);const r=this.getLayerSourceCache(t),c=s.C(t.source,t.scope),d=this._changes.getUpdatedSourceCaches();t.source&&!d[c]&&r&&r.getSource().type!=="raster"&&(this._changes.updateSourceCache(c,"reload"),r.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const r=E=>this._mergedLayers[E].is3D(!!this.terrain),c=this.order,d={},m=[];for(let E=c.length-1;E>=0;E--){const A=c[E];if(r(A)){d[A]=E;for(const C of t){const R=C[A];if(R)for(const L of R)m.push(L)}}}m.sort((E,A)=>A.intersectionZ-E.intersectionZ);const g=[];for(let E=c.length-1;E>=0;E--){const A=c[E];if(r(A))for(let C=m.length-1;C>=0;C--){const R=m[C].feature;if(R.layer&&d[R.layer.id]<E)break;g.push(R),m.pop()}else for(const C of t){const R=C[A];if(R)for(const L of R)g.push(L.feature)}}return g}queryRenderedFeatures(t,r,c){let d;r&&!Array.isArray(r)&&r.filter&&(this._validate(Y,"queryRenderedFeatures.filter",r.filter,null,r),d=s.a_(r.filter));const m={},g=R=>{if(nu.has(R.type))return;const L=this.getOwnLayerSourceCache(R),O=m[L.id]=m[L.id]||{sourceCache:L,layers:{},has3DLayers:!1};R.is3D(!!this.terrain)&&(O.has3DLayers=!0),O.layers[R.fqid]=O.layers[R.fqid]||{styleLayer:R,targets:[]},O.layers[R.fqid].targets.push({filter:d})};if(r&&r.layers){if(!Array.isArray(r.layers))return this.fire(new s.z(new Error("parameters.layers must be an Array."))),[];for(const R of r.layers){const L=this._layers[R];if(!L)return this.fire(new s.z(new Error(`The layer '${R}' does not exist in the map's style and cannot be queried for features.`))),[];g(L)}}else for(const R in this._layers)g(this._layers[R]);const E=this._queryRenderedFeatures(t,m,c),A=this._flattenAndSortRenderedFeatures(E),C=[];for(const R of A)s.ct(R.layer.id)===this.scope&&C.push(R);return C}queryRenderedFeatureset(t,r,c){let d;r&&!Array.isArray(r)&&r.filter&&(this._validate(Y,"queryRenderedFeatures.filter",r.filter,null,r),d=s.a_(r.filter));const m="mock",g=[];if(r&&r.target)g.push(Object.assign({},r,{targetId:m,filter:d}));else{const R=this.getFeaturesetDescriptors();for(const L of R)g.push({targetId:m,filter:d,target:L});for(const{style:L}of this.fragments){const O=L.getFeaturesetDescriptors();for(const V of O)g.push({targetId:m,filter:d,target:V})}}const E=this.queryRenderedTargets(t,g,c),A=[],C=new Set;for(const R of E)for(const L of R.variants[m])za(L,R,C)||A.push(new s.cx(R,L));return A}queryRenderedTargets(t,r,c){const d={},m=(E,A,C,R)=>{const L=d[A.id]=d[A.id]||{sourceCache:A,layers:{},has3DLayers:!1};if(L.layers[E.fqid]=L.layers[E.fqid]||{styleLayer:E,targets:[]},E.is3D(!!this.terrain)&&(L.has3DLayers=!0),!R)return C.uniqueFeatureID=!1,void L.layers[E.fqid].targets.push(C);L.layers[E.fqid].targets.push(Object.assign({},C,{namespace:R.namespace,properties:R.properties,uniqueFeatureID:R.uniqueFeatureID}))};for(const E of r)if("featuresetId"in E.target){const{featuresetId:A,importId:C}=E.target,R=this.getFragmentStyle(C);if(!R||!R._featuresetSelectors)continue;const L=R._featuresetSelectors[A];if(!L){this.fire(new s.z(new Error(`The featureset '${A}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const O of L){const V=R.getOwnLayer(O.layerId);V&&!nu.has(V.type)&&m(V,R.getOwnLayerSourceCache(V),E,O)}}else if("layerId"in E.target){const{layerId:A}=E.target,C=this.getLayer(A);if(!C||nu.has(C.type))continue;m(C,this.getLayerSourceCache(C),E)}const g=this._queryRenderedFeatures(t,d,c);return this._flattenAndSortRenderedFeatures(g)}_queryRenderedFeatures(t,r,c){const d=[],m=!!this.map._showQueryGeometry,g=an.createFromScreenPoints(t,c);for(const E in r){const A=Sh(g,r[E],this._availableImages,c,m);Object.keys(A).length&&d.push(A)}if(this.placement)for(const E in r){if(!r[E].sourceCache._onlySymbols)continue;const A=Kf(g.screenGeometry,r[E],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(A).length&&d.push(A)}return d}querySourceFeatures(t,r){const c=r&&r.filter;c&&this._validate(Y,"querySourceFeatures.filter",c,null,r);let d=[];const m=this.getOwnSourceCaches(t);for(const g of m)d=d.concat(Yf(g,r));return d}addSourceType(t,r,c){return Fs.getSourceType(t)?c(new Error(`A source type called "${t}" already exists.`)):(Fs.setSourceType(t,r),r.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:r.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,r,c={}){this._checkLoaded();const d=this.light.getLight();let m=!1;for(const E in t)if(!s.bn(t[E],d[E])){m=!0;break}if(!m)return;const g=this._getTransitionParameters();this.light.setLight(t,r,c),this.light.updateTransitions(g)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=s.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&s.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,r=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),r===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t;const d=t.source==null;if(r===1){if(this.disableElevatedTerrain)return;if(typeof c.source=="object"){const E="terrain-dem-src";this.addSource(E,c.source),c=s.cq(c),c=s.l(c,{source:E})}const m=s.l({},c),g={};if(this.terrain&&d){m.source=this.terrain.get().source;const E=this.terrain?this.getFragmentStyle(this.terrain.scope):null;E&&(g.style=E.serialize())}if(this._validate(Hc,"terrain",m,g))return}if(!this.terrain||this.terrain.scope!==this.scope&&!d||this.terrain&&r!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,r),this.fire(new s.A("data",{dataType:"style"}))}else{const m=this.terrain,g=m.get();for(const E of Object.keys(s.a5.terrain))!c.hasOwnProperty(E)&&s.a5.terrain[E].default&&(c[E]=s.a5.terrain[E].default);for(const E in t)if(!s.bn(t[E],g[E])){m.set(t,this.options),this.stylesheet.terrain=t;const A=this._getTransitionParameters({duration:0});m.updateTransitions(A),this.fire(new s.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const r=this.fog=new vi(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}_createSnow(t){const r=this.snow=new er(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}_createRain(t){const r=this.rain=new rr(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const r=this.fog;if(!s.bn(r.get(),t)){r.set(t,this.options),this.stylesheet.fog=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const r=this.snow;if(!s.bn(r.get(),t)){r.set(t,this.options),this.stylesheet.snow=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const r=this.rain;if(!s.bn(r.get(),t)){r.set(t,this.options),this.stylesheet.rain=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const d in this._layers)this._layers[d].lut=this._styleColorTheme.lut;for(const d in this._sourceCaches)this._sourceCaches[d].clearTiles()},r=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!r)return this._styleColorTheme.lut=null,void t();const c=this._evaluateColorThemeData(r);this._loadColorTheme(c).then(()=>{this.fire(new s.A("colorthemeset")),t()}).catch(d=>{s.w(`Couldn't set color theme: ${d}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&s.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,r){const c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=r,c._reloadColorTheme())}_getTransitionParameters(t){return{now:s.q.now(),transition:s.l(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],r=[];for(const c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):r.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...r)}_createTerrain(t,r){const c=this.terrain=new We(t,r,this.scope,this.options);r===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const d=this._getTransitionParameters({duration:0});c.updateTransitions(d)}_force3DLayerUpdate(){for(const t in this._layers){const r=this._layers[t];r.type==="fill-extrusion"&&this._updateLayer(r)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const r=this._layers[t];r.type==="symbol"&&this._updateLayer(r)}}_validate(t,r,c,d,m={}){if(m&&m.validate===!1)return!1;const g=s.l({},this.serialize());return ua(this,t.call(Nn,s.l({key:r,style:g,value:c,styleSpec:s.a5},d)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),s.cy.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(t){const r=this.getSourceCaches(t);for(const c of r)c.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}reloadSource(t){const r=this.getSourceCaches(t);for(const c of r)c.resume(),c.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let r;this.directionalLight&&(r=Fo(this.directionalLight));for(const c in this._mergedSourceCaches)this._mergedSourceCaches[c].update(t,void 0,void 0,r)}_generateCollisionBoxes(){for(const t in this._sourceCaches){const r=this._sourceCaches[t];r.resume(),r.reload()}}_updatePlacement(t,r,c,d,m,g,E=!1){let A=!1,C=!1;const R={},L={};for(const O of this._mergedOrder){const V=this._mergedLayers[O];if(V.type!=="symbol")continue;const H=s.C(V.source,V.scope);let G=R[H];if(!G){const K=this.getLayerSourceCache(V);if(!K)continue;const ie=K.getRenderableIds(!0).map(oe=>K.getTileByID(oe));L[H]=ie.slice(),G=R[H]=ie.sort((oe,se)=>se.tileID.overscaledZ-oe.tileID.overscaledZ||(oe.tileID.isLessThan(se.tileID)?-1:1))}const W=this.crossTileSymbolIndex.addLayer(V,G,r.center.lng,r.projection);A=A||W}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),E=E||this._layerOrderChanged||d===0,this._layerOrderChanged&&this.fire(new s.A("neworder")),(E||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(s.q.now(),r.zoom))&&(this.pauseablePlacement=new Oo(r,this._mergedOrder,E,c,d,m,this.placement,this.fog&&r.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,R,L,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(s.q.now()),C=!0),A&&this.pauseablePlacement.placement.setStale()),C||A){this._buildingIndex.onNewFrame(r.zoom);for(let O=0;O<this._mergedOrder.length;O++){const V=this._mergedLayers[this._mergedOrder[O]];if(V.type!=="symbol")continue;const H=this.isLayerClipped(V);this.placement.updateLayerOpacities(V,R[s.C(V.source,V.scope)],O,H?g:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(s.q.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,r){this._checkLoaded();const c=this.stylesheet.imports=this.stylesheet.imports||[];if(c.findIndex(({id:m})=>m===t.id)!==-1)return void this.fire(new s.z(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!r)return c.push(t),this._loadImports([t],!0);const d=c.findIndex(({id:m})=>m===r);return d===-1&&this.fire(new s.z(new Error(`Import with id "${r}" does not exist on this map.`))),this.stylesheet.imports=c.slice(0,d).concat(t).concat(c.slice(d)),this._loadImports([t],!0,r)}updateImport(t,r){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);return d===-1?this:typeof r=="string"?(this.setImportUrl(t,r),this):(r.url&&r.url!==c[d].url&&this.setImportUrl(t,r.url),s.bn(r.config,c[d].config)||this.setImportConfig(t,r.config,r.data.schema),s.bn(r.data,c[d].data)||this.setImportData(t,r.data),this)}moveImport(t,r){this._checkLoaded();let c=this.stylesheet.imports||[];const d=this.getImportIndex(t);if(d===-1)return this;const m=this.getImportIndex(r);if(m===-1)return this;const g=c[d],E=this.fragments[d];return c=c.filter(({id:A})=>A!==t),this.fragments=this.fragments.filter(({id:A})=>A!==t),this.stylesheet.imports=c.slice(0,m).concat(g).concat(c.slice(m)),this.fragments=this.fragments.slice(0,m).concat(E).concat(this.fragments.slice(m)),this.mergeLayers(),this}setImportUrl(t,r){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;c[d].url=r;const m=this.fragments[d];return m.style=this._createFragmentStyle(c[d]),m.style.on("style.import.load",()=>this.mergeAll()),m.style.loadURL(r),this}setImportData(t,r){this._checkLoaded();const c=this.getImportIndex(t),d=this.stylesheet.imports||[];return c===-1?this:r?(this.fragments[c].style.setState(r),this._reloadImports(),this):(delete d[c].data,this.setImportUrl(t,d[c].url))}setImportConfig(t,r,c){this._checkLoaded();const d=this.getImportIndex(t),m=this.stylesheet.imports||[];if(d===-1)return this;r?m[d].config=r:delete m[d].config;const g=this.fragments[d];c&&g.style.stylesheet&&(g.style.stylesheet.schema=c);const E=g.style.stylesheet&&g.style.stylesheet.schema;return g.config=r,g.style.updateConfig(r,E),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const r=this.stylesheet.imports||[],c=this.getImportIndex(t);c!==-1&&(r.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){const r=(this.stylesheet.imports||[]).findIndex(c=>c.id===t);return r===-1&&this.fire(new s.z(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),r}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const r in this._mergedOtherSourceCaches){const c=this._mergedOtherSourceCaches[r];c&&t.push(c.getSource())}return t}getSource(t,r){const c=this.getSourceCache(t,r);return c&&c.getSource()}getLayerSource(t){const r=this.getLayerSourceCache(t);return r&&r.getSource()}getSourceCache(t,r){const c=s.C(t,r);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){const r=s.C(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[r]:this._mergedOtherSourceCaches[r]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const r=[];return this._mergedOtherSourceCaches[t]&&r.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&r.push(this._mergedSymbolSourceCaches[t]),r}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const r in t){const c=t[r];c==="reload"?this.reloadSource(r):c==="clear"&&this.clearSource(r)}}updateLayers(t){const r=this._changes.getUpdatedPaintProperties();for(const c of r){const d=this.getLayer(c);d&&d.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t,this.scope)}getImages(t,r,c){this.imageManager.getImages(r.images,r.scope,c),this._updateTilesForChangedImages();const d=g=>{if(g){const E=r.images.map(A=>s.I.toString(A));g.setDependencies(r.tileID.key,r.type,E)}},m=s.C(r.source,r.scope);d(this._mergedOtherSourceCaches[m]),d(this._mergedSymbolSourceCaches[m])}rasterizeImages(t,r,c){this.imageManager.rasterizeImages(r,c)}getGlyphs(t,r,c){this.glyphManager.getGlyphs(r.stacks,r.scope,c)}getResource(t,r,c){return s.cz(r,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const r=[];return this._otherSourceCaches[t]&&r.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&r.push(this._symbolSourceCaches[t]),r}_isSourceCacheLoaded(t){const r=this.getOwnSourceCaches(t);return r.length===0?(this.fire(new s.z(new Error(`There is no source with ID '${t}'`))),!1):r.every(c=>c.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,r){if(!this._clipLayerPresent&&t.type!=="fill-extrusion")return!1;const c=t.type==="fill-extrusion"&&t.sourceLayer==="building";if(t.is3D(!!this.terrain)){if(c||r&&r.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Fs.getSourceType=function(u){return Th[u]},Fs.setSourceType=function(u,t){Th[u]=t},Fs.registerForPluginStateChange=s.ci;var Oh=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,su=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Yl=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,ou="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Bo=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,au=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,kh=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,ha=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Za=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,Jl=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Ql=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef TEXTURE_GATHER
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return clamp(mix(lerpx.x,lerpx.y,f.y),0.0,1.0);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const mo=[];Ws(Oh,mo),Ws(Yl,mo),Ws(su,mo);const da={"_prelude_fog.vertex.glsl":au,"_prelude_terrain.vertex.glsl":Bo,"_prelude_shadow.vertex.glsl":Jl,"_prelude_fog.fragment.glsl":kh,"_prelude_shadow.fragment.glsl":Ql,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":ha,"_prelude_raster_particle.glsl":Za},Wa={};Pi("",Bo),Pi(kh,au),Pi(Ql,Jl),Pi(ha,""),Pi(Za,"");const Fh=Pi(su,Yl),lu=Oh;var ec={background:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Pi("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Pi(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Pi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Pi("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Pi("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Pi("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:Pi(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:Pi(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
void main() {vec3 color=vec3(241.0/255.0,236.0/255.0,225.0/255.0);
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,normal);
#endif
if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(v_normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:Pi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:Pi(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:Pi(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:Pi(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),0.001);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:Pi("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:Pi("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Pi(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Pi(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;
#else
z+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#endif
}`),terrainRaster:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:Pi("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:Pi(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,ou),skyboxGradient:Pi(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,ou),skyboxCapture:Pi(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:Pi(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:Pi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:Pi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:Pi(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:Pi("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:Pi("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:Pi("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Pi("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Ws(u,t){const r=u.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let c of r)if(c=c.trim(),c[0]==="#"&&c.includes("if")&&!c.includes("endif")){c=c.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const d=c.split(" ");for(const m of d)t.includes(m)||t.push(m)}}function Pi(u,t){const r=/#include\s+"([^"]+)"/g,c=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let d=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);d&&(d=d.map(C=>{const R=C.split(" ");return R[R.length-1]}),d=[...new Set(d)]);const m={},g=[],E=[];if(u=u.replace(r,(C,R)=>(E.push(R),"")),(t=t.replace(r,(C,R)=>(g.push(R),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let A=[...mo];Ws(u,A),Ws(t,A);for(const C of[...g,...E])da[C]||console.error(`Undefined include: ${C}`),Wa[C]||(Wa[C]=[],Ws(da[C],Wa[C])),A=[...A,...Wa[C]];return{fragmentSource:u=u.replace(c,(C,R,L,O,V)=>(m[V]=!0,R==="define"?`
#ifndef HAS_UNIFORM_u_${V}
in ${L} ${O} ${V};
#else
uniform ${L} ${O} u_${V};
#endif
`:R==="initialize"?`
#ifdef HAS_UNIFORM_u_${V}
    ${L} ${O} ${V} = u_${V};
#endif
`:R==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${V}
    in ${L} ${O} ${V};
#endif
`:R==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(c,(C,R,L,O,V)=>{const H=O==="float"?"vec2":O,G=V.match(/color/)?"color":H;return R==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${V}
in ${L} ${O} a_${V};
#endif
`:m[V]?R==="define"?`
#ifndef HAS_UNIFORM_u_${V}
uniform lowp float u_${V}_t;
in ${L} ${H} a_${V};
out ${L} ${O} ${V};
#else
uniform ${L} ${O} u_${V};
#endif
`:R==="initialize"?G==="vec4"?`
#ifndef HAS_UNIFORM_u_${V}
    ${V} = a_${V};
#else
    ${L} ${O} ${V} = u_${V};
#endif
`:`
#ifndef HAS_UNIFORM_u_${V}
    ${V} = unpack_mix_${G}(a_${V}, u_${V}_t);
#else
    ${L} ${O} ${V} = u_${V};
#endif
`:R==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${V}
    in ${L} ${O} a_${V};
    out ${L} ${O} ${V};
#endif
`:R==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${V}
    ${V} = a_${V};
#endif
`:void 0:R==="define"?`
#ifndef HAS_UNIFORM_u_${V}
uniform lowp float u_${V}_t;
in ${L} ${H} a_${V};
#else
uniform ${L} ${O} u_${V};
#endif
`:R==="define-instanced"?G==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${V}0;
in vec4 a_${V}1;
in vec4 a_${V}2;
in vec4 a_${V}3;
#else
uniform ${L} ${O} u_${V};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${L} ${H} a_${V};
#else
uniform ${L} ${O} u_${V};
#endif
`:R==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${V}
    ${L} ${O} ${V} = a_${V};
#endif
`:G==="vec4"?`
#ifndef HAS_UNIFORM_u_${V}
    ${L} ${O} ${V} = a_${V};
#else
    ${L} ${O} ${V} = u_${V};
#endif
`:`
#ifndef HAS_UNIFORM_u_${V}
    ${L} ${O} ${V} = unpack_mix_${G}(a_${V}, u_${V}_t);
#else
    ${L} ${O} ${V} = u_${V};
#endif
`}),staticAttributes:d,usedDefines:A,vertexIncludes:g,fragmentIncludes:E}}class lp{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,r,c,d,m,g,E,A){this.context=t;let C=this.boundPaintVertexBuffers.length!==d.length;for(let L=0;!C&&L<d.length;L++)this.boundPaintVertexBuffers[L]!==d[L]&&(C=!0);let R=this.boundDynamicVertexBuffers.length!==E.length;for(let L=0;!R&&L<E.length;L++)this.boundDynamicVertexBuffers[L]!==E[L]&&(R=!0);if(!this.vao||this.boundProgram!==r||this.boundLayoutVertexBuffer!==c||C||R||this.boundIndexBuffer!==m||this.boundVertexOffset!==g)this.freshBind(r,c,d,m,g,E,A);else{t.bindVertexArrayOES.set(this.vao);for(const L of E)L&&(L.bind(),A&&L.instanceCount&&L.setVertexAttribDivisor(t.gl,r,A));m&&m.dynamicDraw&&m.bind()}}freshBind(t,r,c,d,m,g,E){const A=t.numAttributes,C=this.context,R=C.gl;this.vao&&this.destroy(),this.vao=C.gl.createVertexArray(),C.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=r,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=d,this.boundVertexOffset=m,this.boundDynamicVertexBuffers=g,r.enableAttributes(R,t),r.bind(),r.setVertexAttribPointers(R,t,m);for(const L of c)L.enableAttributes(R,t),L.bind(),L.setVertexAttribPointers(R,t,m);for(const L of g)L&&(L.enableAttributes(R,t),L.bind(),L.setVertexAttribPointers(R,t,m),E&&L.instanceCount&&L.setVertexAttribDivisor(R,t,E));d&&d.bind(),C.currentNumAttributes=A}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function cp(u,t){const r=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new s.ac(0,c/r).toLngLat().lat,new s.ac(0,(c+1)/r).toLngLat().lat]}function Xa(u,t,r,c,d,m,g){const E=u.context,A=E.gl,C=r.hillshadeFBO;if(!C)return;u.prepareDrawTile();const R=u.isTileAffectedByFog(t),L=u.getOrCreateProgram("hillshade",{overrideFog:R});E.activeTexture.set(A.TEXTURE0),A.bindTexture(A.TEXTURE_2D,C.colorAttachment.get());const O=((W,K,ie,oe)=>{const se=ie.paint.get("hillshade-shadow-color"),fe=ie.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",ce=ie.paint.get("hillshade-highlight-color"),ue=ie.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",he=ie.paint.get("hillshade-accent-color"),_e=ie.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",xe=ie.paint.get("hillshade-emissive-strength");let Ue=s.ak(ie.paint.get("hillshade-illumination-direction"));if(ie.paint.get("hillshade-illumination-anchor")==="viewport")Ue-=W.transform.angle;else if(W.style&&W.style.enable3dLights()&&W.style.directionalLight){const Ye=W.style.directionalLight.properties.get("direction"),Je=s.cc(Ye.x,Ye.y,Ye.z);Ue=s.ak(Je[1])}const Le=!W.options.moving;return{u_matrix:oe||W.transform.calculateProjMatrix(K.tileID.toUnwrapped(),Le),u_image:0,u_latrange:cp(0,K.tileID),u_light:[ie.paint.get("hillshade-exaggeration"),Ue],u_shadow:se.toRenderColor(fe?null:ie.lut),u_highlight:ce.toRenderColor(ue?null:ie.lut),u_emissive_strength:xe,u_accent:he.toRenderColor(_e?null:ie.lut)}})(u,r,c,u.terrain?t.projMatrix:null);u.uploadCommonUniforms(E,L,t.toUnwrapped());const{tileBoundsBuffer:V,tileBoundsIndexBuffer:H,tileBoundsSegments:G}=u.getTileBoundsBuffers(r);L.draw(u,A.TRIANGLES,d,m,g,ni.disabled,O,c.id,V,H,G)}function Bh(u,t,r){if(!t.needsDEMTextureUpload)return;const c=u.context,d=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||u.getTileTexture(r.stride);const m=r.getPixels();t.demTexture?t.demTexture.update(m,{premultiply:!1}):t.demTexture=new s.T(c,m,d.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function q_(u,t,r){const c=u.context,d=c.gl;if(!t.dem)return;const m=t.dem;if(c.activeTexture.set(d.TEXTURE1),Bh(u,t,m),!t.demTexture)return;t.demTexture.bind(d.NEAREST,d.CLAMP_TO_EDGE);const g=m.dim;c.activeTexture.set(d.TEXTURE0);let E=t.hillshadeFBO;if(!E){const O=new s.T(c,{width:g,height:g,data:null},d.RGBA8);O.bind(d.LINEAR,d.CLAMP_TO_EDGE),E=t.hillshadeFBO=c.createFramebuffer(g,g,!0,"renderbuffer"),E.colorAttachment.set(O.texture)}c.bindFramebuffer.set(E.framebuffer),c.viewport.set([0,0,g,g]);const{tileBoundsBuffer:A,tileBoundsIndexBuffer:C,tileBoundsSegments:R}=u.getMercatorTileBoundsBuffers(),L=[];u.linearFloatFilteringSupported()&&L.push("TERRAIN_DEM_FLOAT_FORMAT"),u.getOrCreateProgram("hillshadePrepare",{defines:L}).draw(u,d.TRIANGLES,qt.disabled,li.disabled,Si.unblended,ni.disabled,((O,V)=>{const H=V.stride,G=s.ad.mat4.create();return s.ad.mat4.ortho(G,0,s.ai,-s.ai,0,0,1),s.ad.mat4.translate(G,G,[0,-s.ai,0]),{u_matrix:G,u_image:1,u_dimension:[H,H],u_zoom:O.overscaledZ}})(t.tileID,m),r.id,A,C,R),t.needsHillshadePrepare=!1}class wr{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class $_ extends wr{getDefault(){return s.al.transparent}set(t){const r=this.current;(t.r!==r.r||t.g!==r.g||t.b!==r.b||t.a!==r.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Nh extends wr{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Vh extends wr{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Uh extends wr{getDefault(){return[!0,!0,!0,!0]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class jh extends wr{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class up extends wr{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class hp extends wr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const r=this.current;(t.func!==r.func||t.ref!==r.ref||t.mask!==r.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class H_ extends wr{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class tc extends wr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),this.current=t,this.dirty=!1}}class ic extends wr{getDefault(){return[0,1]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class dp extends wr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),this.current=t,this.dirty=!1}}class ls extends wr{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Gh extends wr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.BLEND):r.disable(r.BLEND),this.current=t,this.dirty=!1}}class cu extends wr{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class uu extends wr{getDefault(){return s.al.transparent}set(t){const r=this.current;(t.r!==r.r||t.g!==r.g||t.b!==r.b||t.a!==r.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class qh extends wr{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class $h extends wr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),this.current=t,this.dirty=!1}}class Hh extends wr{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class hu extends wr{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Zh=class extends wr{getDefault(){return null}set(u){(u!==this.current||this.dirty)&&(this.gl.useProgram(u),this.current=u,this.dirty=!1)}};class Wh extends wr{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class du extends wr{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class fp extends wr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class pp extends wr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindRenderbuffer(r.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Ka extends wr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindTexture(r.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Z_ extends wr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindBuffer(r.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class W_ extends wr{getDefault(){return null}set(t){const r=this.gl;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class X_ extends wr{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class K_ extends wr{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Y_ extends wr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class J_ extends wr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class rc extends wr{constructor(t,r){super(t),this.context=t,this.parent=r}getDefault(){return null}}class Xh extends rc{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Kh extends rc{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferRenderbuffer(r.FRAMEBUFFER,this.attachment(),r.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Ya extends rc{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferTexture2D(r.FRAMEBUFFER,this.attachment(),r.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class mp extends Kh{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const _p=(u,t,r)=>({u_matrix:u,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:r}),Yh=(u,t,r,c,d,m,g,E,A,C,R,L,O,V,H,G)=>({u_proj_matrix:Float32Array.from(u),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:r,u_zoom_transition:d,u_merc_center:m,u_image0:0,u_frustum_tl:g,u_frustum_tr:E,u_frustum_br:A,u_frustum_bl:C,u_globe_pos:R,u_globe_radius:L,u_viewport:O,u_grid_matrix:G?Float32Array.from(G):new Float32Array(9),u_skirt_height:V,u_far_z_cutoff:H});function fu(u,t){return u!=null&&t!=null&&!(!u.hasData()||!t.hasData())&&u.demTexture!=null&&t.demTexture!=null&&u.tileID.key!==t.tileID.key}const ws=new class{constructor(){this.operations={}}newMorphing(u,t,r,c,d){if(u in this.operations){const m=this.operations[u];m.to.tileID.key!==r.tileID.key&&(m.queued=r)}else this.operations[u]={startTime:c,phase:0,duration:d,from:t,to:r,queued:null}}getMorphValuesForProxy(u){if(!(u in this.operations))return null;const t=this.operations[u];return{from:t.from,to:t.to,phase:t.phase}}update(u){for(const t in this.operations){const r=this.operations[t];for(r.phase=(u-r.startTime)/r.duration;r.phase>=1||!this._validOp(r);)if(!this._nextOp(r,u)){delete this.operations[t];break}}}_nextOp(u,t){return!!u.queued&&(u.from=u.to,u.to=u.queued,u.queued=null,u.phase=0,u.startTime=t,!0)}_validOp(u){return u.from.hasData()&&u.to.hasData()}},Jh={0:null,1:"TERRAIN_VERTEX_MORPHING"};function _o(u,t,r){if(t===0)return 0;const c=t<1&&r===514?.25/t:1;return 6*Math.pow(1.5,22-u)*Math.max(t,1)*c}function Qh(u,t){const r=1<<u.z;return!t&&(u.x===0||u.x===r-1)||u.y===0||u.y===r-1}const Ja=u=>({u_matrix:u});function pu(u,t,r,c,d){if(d>0){const m=s.q.now(),g=(m-u.timeAdded)/d,E=t?(m-t.timeAdded)/d:-1,A=r.getSource(),C=c.coveringZoomLevel({tileSize:A.tileSize,roundZoom:A.roundZoom}),R=!t||Math.abs(t.tileID.overscaledZ-C)>Math.abs(u.tileID.overscaledZ-C),L=R&&u.refreshedUponExpiration?1:s.ay(R?g:1-E,0,1);return u.refreshedUponExpiration&&g>=1&&(u.refreshedUponExpiration=!1),t?{opacity:1,mix:1-L}:{opacity:L,mix:0}}return{opacity:1,mix:0}}class gp extends xs{constructor(t){const r={type:"raster-dem",maxzoom:t.transform.maxZoom},c=new s.D(s.cj(),null),d=Wc("mock-dem",r,c,t.style);super("mock-dem",d,!1),d.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,r){t.state="loaded",r(null)}}class ed extends xs{constructor(t){const r=Wc("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new s.D(s.cj(),null),t.style);super("proxy",r,!1),r.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,r,c){if(t.freezeTileCoverage)return;this.transform=t;const d=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((m,g)=>{if(m[g.key]="",!this._tiles[g.key]){const E=new Ls(g,this._source.tileSize*g.overscaleFactor(),t.tileZoom);E.state="loaded",this._tiles[g.key]=E}return m},{});for(const m in this._tiles)m in d||(this.freeFBO(m),this._tiles[m].unloadVectorData(),delete this._tiles[m])}freeFBO(t){const r=this.proxyCachedFBO[t];if(r!==void 0){const c=Object.values(r);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class mu extends s.aH{constructor(t,r,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=r,this.projMatrix=c}}class yp extends s.cK{constructor(t,r){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[c,d,m]=function(A){const C=new s.b5,R=new s.aV,L=131;C.reserve(17161),R.reserve(33800);const O=s.ai/128,V=s.ai+O/2,H=V+O;for(let W=-O;W<H;W+=O)for(let K=-O;K<H;K+=O){const ie=K<0||K>V||W<0||W>V?24575:0,oe=s.ay(Math.round(K),0,s.ai),se=s.ay(Math.round(W),0,s.ai);C.emplaceBack(oe+ie,se)}const G=(W,K)=>{const ie=K*L+W;R.emplaceBack(ie+1,ie,ie+L),R.emplaceBack(ie+L,ie+L+1,ie+1)};for(let W=1;W<129;W++)for(let K=1;K<129;K++)G(K,W);return[0,129].forEach(W=>{for(let K=0;K<130;K++)G(K,W),G(W,K)}),[C,R,32768]}(),g=t.context;this.gridBuffer=g.createVertexBuffer(c,s.b7.members),this.gridIndexBuffer=g.createIndexBuffer(d),this.gridSegments=s.b8.simpleSegment(0,0,c.length,d.length),this.gridNoSkirtSegments=s.b8.simpleSegment(0,0,c.length,m),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new ed(r.map),this.orthoMatrix=s.ad.mat4.create(),s.ad.mat4.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,s.ai,0,s.ai,0,1);const E=g.gl;this._overlapStencilMode=new li({func:E.GEQUAL,mask:255},0,255,E.KEEP,E.KEEP,E.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=r,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new gp(r.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,r,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const d=t.terrain.properties,m=t.terrain.drapeRenderMode===0,g=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=s.q.now();const E=t.terrain&&t.terrain.scope,A=d.get("source"),C=m?this._mockSourceCache:t.getSourceCache(A,E);if(!C)return void s.w(`Couldn't find terrain source "${A}".`);if(this.sourceCache=C,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=g?this.calculateExaggeration(r):d.get("exaggeration"),!r.projection.requiresDraping&&g&&this._exaggeration===0)return void this._disable();this.enabled=!0;const R=()=>{this.sourceCache.used&&s.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const L=this.getScaledDemTileSize();this.sourceCache.update(r,L,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,R(),this._initializing=!0),R(),r.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(r),this._emptyDEMTextureDirty=!0,this._previousZoom=r.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const r=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;const d=r!=null?c-r:Number.MAX_VALUE;if(Math.abs(d)<2)return this._exaggeration;const m=t.zoom,g=this._style.terrain;if(!this._previousUpdateTimestamp)return g.getExaggeration(m);let E=m-this._previousZoom;const A=this._previousUpdateTimestamp;let C=m;this._evaluationZoom!=null&&(C=this._evaluationZoom,Math.abs(m-C)>.5&&(E=.5*(m-C+E)),E*d<0&&(C+=E)),this._evaluationZoom=C;const R=g.getExaggeration(C),L=R===g.getExaggeration(Math.max(0,C-.1));if(L&&Math.abs(R-this._exaggeration)<.01)return R;let O=Math.min(.1,.00375*(this._updateTimestamp-A));return(L||R<.1||Math.abs(E)<1e-4)&&(O=Math.min(.2,4*O)),s.ah(this._exaggeration,R,O)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const r=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=c._centerAltitude===0&&this.getAtPointOrZero(s.ac.fromLngLat(c.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const d=this.proxyCoords=r.getIds().map(A=>{const C=r.getTileByID(A).tileID;return C.projMatrix=c.calculateProjMatrix(C.toUnwrapped()),C});(function(A,C){const R=C.transform.pointCoordinate(C.transform.getCameraPoint()),L=new s.P(R.x,R.y);A.sort((O,V)=>{if(V.overscaledZ-O.overscaledZ)return V.overscaledZ-O.overscaledZ;const H=new s.P(O.canonical.x+(1<<O.canonical.z)*O.wrap,O.canonical.y),G=new s.P(V.canonical.x+(1<<V.canonical.z)*V.wrap,V.canonical.y),W=L.mult(1<<O.canonical.z);return W.x-=.5,W.y-=.5,W.distSqr(H)-W.distSqr(G)})})(d,this.painter);const m=this.proxyToSource||{};this.proxyToSource={},d.forEach(A=>{this.proxyToSource[A.key]={}}),this.terrainTileForTile={};const g=this._style._mergedSourceCaches;for(const A in g){const C=g[A];if(!C.used||(C!==this.sourceCache&&this.resetTileLookupCache(C.id),this._setupProxiedCoordsForOrtho(C,t[A],m),C.usedForTerrain))continue;const R=t[A];C.getSource().reparseOverscaled&&this._assignTerrainTiles(R)}this.proxiedCoords[r.id]=d.map(A=>new mu(A,A.key,this.orthoMatrix)),this._assignTerrainTiles(d),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(m),this.renderingToTexture=!1;const E={};this._visibleDemTiles=[];for(const A of this.proxyCoords){const C=this.terrainTileForTile[A.key];if(!C)continue;const R=C.tileID.key;R in E||(this._visibleDemTiles.push(C),E[R]=R)}}_assignTerrainTiles(t){this._initializing||t.forEach(r=>{if(this.terrainTileForTile[r.key])return;const c=this._findTileCoveringTileID(r,this.sourceCache);c&&(this.terrainTileForTile[r.key]=c)})}_prepareDEMTextures(){const t=this.painter.context,r=t.gl;for(const c in this.terrainTileForTile){const d=this.terrainTileForTile[c],m=d.dem;!m||d.demTexture&&!d.needsDEMTextureUpload||(t.activeTexture.set(r.TEXTURE1),Bh(this.painter,d,m))}}_prepareDemTileUniforms(t,r,c,d){if(!r||r.demTexture==null)return!1;const m=t.tileID.canonical,g=Math.pow(2,r.tileID.canonical.z-m.z),E=d||"";return c[`u_dem_tl${E}`]=[m.x*g%1,m.y*g%1],c[`u_dem_scale${E}`]=g,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const r=this._visibleDemTiles.reduce((c,d)=>{if(!d.dem)return c;const m=d.dem.tree.minimums[0];return m>0&&t++,c+m},0);return t?r/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,r=t.gl;t.activeTexture.set(r.TEXTURE2);const c=this._getLoadedAreaMinimum(),d=new s.cL({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let m=this._emptyDEMTexture;return m?m.update(d,{premultiply:!1}):m=this._emptyDEMTexture=new s.T(t,d,r.R32F,{premultiply:!1}),m}setupElevationDraw(t,r,c){const d=this.painter.context,m=d.gl,g={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};g.u_exaggeration=this.exaggeration();let E=null,A=null,C=1;if(c&&c.morphing&&this._useVertexMorphing){const V=c.morphing.srcDemTile,H=c.morphing.dstDemTile;C=c.morphing.phase,V&&H&&(this._prepareDemTileUniforms(t,V,g,"_prev")&&(A=V),this._prepareDemTileUniforms(t,H,g)&&(E=H))}const R=V=>V&&V.demTexture&&this.painter.linearFloatFilteringSupported()?m.LINEAR:m.NEAREST;let L=null;var O;if(this.enabled?A&&E?(L=E.demTexture,d.activeTexture.set(m.TEXTURE4),A.demTexture.bind(R(A),m.CLAMP_TO_EDGE),g.u_dem_lerp=C):(E=this.terrainTileForTile[t.tileID.key],L=this._prepareDemTileUniforms(t,E,g)?E.demTexture:this.emptyDEMTexture):L=this.emptyDEMTexture,d.activeTexture.set(m.TEXTURE2),L&&(g.u_dem_size=(O=L).size[0]===1?1:O.size[0]-2,L.bind(R(E),m.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,r,g),c&&c.useMeterToDem&&E){const V=(1<<E.tileID.canonical.z)*s.bH(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;g.u_meter_to_dem=V}if(c&&c.labelPlaneMatrixInv&&(g.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),r.setTerrainUniformValues(d,g),this.painter.transform.projection.name==="globe"){const V=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);r.setGlobeUniformValues(d,V)}}globeUniformValues(t,r,c){const d=t.projection;return{u_tile_tl_up:d.upVector(r,0,0),u_tile_tr_up:d.upVector(r,s.ai,0),u_tile_br_up:d.upVector(r,s.ai,s.ai),u_tile_bl_up:d.upVector(r,0,s.ai),u_tile_up_scale:c?s.cM(1):d.upVectorScale(r,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const r=this.painter,c=this.painter.context;t.length!==0&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,r.width,r.height]),r.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(d,m,g,E,A){if(d.transform.projection.name==="globe")(function(C,R,L,O,V){const H=C.context,G=H.gl;let W,K;const ie=C.transform,oe=s.cD(C,H,ie),se=(Ye,Je)=>{if(K===Je)return;const at=[Jh[Je],"PROJECTION_GLOBE_VIEW"];oe&&at.push("CUSTOM_ANTIALIASING");const De=C.isTileAffectedByFog(Ye);W=C.getOrCreateProgram("globeRaster",{defines:at,overrideFog:De}),K=Je},fe=C.colorModeForRenderPass(),ce=new qt(G.LEQUAL,qt.ReadWrite,C.depthRangeFor3D);ws.update(V);const ue=s.cE(ie),he=[s.av(ie.center.lng),s.aC(ie.center.lat)],_e=C.globeSharedBuffers,xe=[ie.width*s.q.devicePixelRatio,ie.height*s.q.devicePixelRatio],Ue=Float32Array.from(ie.globeMatrix),Le={useDenormalizedUpVectorScale:!0};{const Ye=C.transform,Je=_o(Ye.zoom,R.exaggeration(),R.sourceCache._source.tileSize);K=-1;const at=G.TRIANGLES;for(const De of O){const Ke=L.getTile(De),Ie=li.disabled,Xe=R.prevTerrainTileForTile[De.key],He=R.terrainTileForTile[De.key];fu(Xe,He)&&ws.newMorphing(De.key,Xe,He,V,250),H.activeTexture.set(G.TEXTURE0),Ke.texture&&Ke.texture.bind(G.LINEAR,G.CLAMP_TO_EDGE);const Qe=ws.getMorphValuesForProxy(De.key),je=Qe?1:0;Qe&&s.L(Le,{morphing:{srcDemTile:Qe.from,dstDemTile:Qe.to,phase:s.cC(Qe.phase)}});const it=s.cF(De.canonical),_t=s.cG(it.getCenter().lat),yt=s.cH(De.canonical,it,_t,Ye.worldSize/Ye._pixelsPerMercatorPixel),wt=s.bc(s.cI(De.canonical)),Ot=Yh(Ye.expandedFarZProjMatrix,Ue,ue,wt,s.ag(Ye.zoom),he,Ye.frustumCorners.TL,Ye.frustumCorners.TR,Ye.frustumCorners.BR,Ye.frustumCorners.BL,Ye.globeCenterInViewSpace,Ye.globeRadius,xe,Je,Ye._farZ,yt);if(se(De,je),W&&(R.setupElevationDraw(Ke,W,Le),C.uploadCommonUniforms(H,W,De.toUnwrapped()),_e)){const[si,Wt,ii]=_e.getGridBuffers(_t,Je!==0);W.draw(C,at,ce,Ie,fe,ni.backCCW,Ot,"globe_raster",si,Wt,ii)}}}if(_e&&(C.renderDefaultNorthPole||C.renderDefaultSouthPole)){const Ye=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];oe&&Ye.push("CUSTOM_ANTIALIASING"),W=C.getOrCreateProgram("globeRaster",{defines:Ye});for(const Je of O){const{x:at,y:De,z:Ke}=Je.canonical,Ie=De===0,Xe=De===(1<<Ke)-1,[He,Qe,je,it]=_e.getPoleBuffers(Ke,!1);if(it&&(Ie||Xe)){const _t=L.getTile(Je);H.activeTexture.set(G.TEXTURE0),_t.texture&&_t.texture.bind(G.LINEAR,G.CLAMP_TO_EDGE);let yt=s.cJ(Ke,at,ie);const wt=s.bc(s.cI(Je.canonical)),Ot=(si,Wt)=>si.draw(C,G.TRIANGLES,ce,li.disabled,fe,ni.disabled,Yh(ie.expandedFarZProjMatrix,yt,yt,wt,0,he,ie.frustumCorners.TL,ie.frustumCorners.TR,ie.frustumCorners.BR,ie.frustumCorners.BL,ie.globeCenterInViewSpace,ie.globeRadius,xe,0,ie._farZ),"globe_pole_raster",Wt,je,it);R.setupElevationDraw(_t,W,Le),C.uploadCommonUniforms(H,W,Je.toUnwrapped()),Ie&&C.renderDefaultNorthPole&&Ot(W,He),Xe&&C.renderDefaultSouthPole&&(yt=s.ad.mat4.scale(s.ad.mat4.create(),yt,[1,-1,1]),Ot(W,Qe))}}}})(d,m,g,E,A);else{const C=d.context,R=C.gl;let L,O;const V=d.shadowRenderer,H=fo(d,d.longestCutoffRange),G=fe=>{if(O===fe)return;const ce=[];ce.push(Jh[fe]),H.shouldRenderCutoff&&ce.push("RENDER_CUTOFF"),V&&(ce.push("RENDER_SHADOWS","DEPTH_TEXTURE"),V.useNormalOffset&&ce.push("NORMAL_OFFSET")),L=d.getOrCreateProgram("terrainRaster",{defines:ce}),O=fe},W=d.colorModeForRenderPass(),K=new qt(R.LEQUAL,qt.ReadWrite,d.depthRangeFor3D);ws.update(A);const ie=d.transform,oe=_o(ie.zoom,m.exaggeration(),m.sourceCache._source.tileSize);let se=[0,0,0];if(V){const fe=d.style.directionalLight,ce=d.style.ambientLight;fe&&ce&&(se=$a(d.style,fe,ce))}{O=-1;const fe=R.TRIANGLES,[ce,ue]=[m.gridIndexBuffer,m.gridSegments];for(const he of E){const _e=g.getTile(he),xe=li.disabled,Ue=m.prevTerrainTileForTile[he.key],Le=m.terrainTileForTile[he.key];fu(Ue,Le)&&ws.newMorphing(he.key,Ue,Le,A,250),C.activeTexture.set(R.TEXTURE0),_e.texture&&_e.texture.bind(R.LINEAR,R.CLAMP_TO_EDGE);const Ye=ws.getMorphValuesForProxy(he.key),Je=Ye?1:0;let at;Ye&&(at={morphing:{srcDemTile:Ye.from,dstDemTile:Ye.to,phase:s.cC(Ye.phase)}});const De=_p(he.projMatrix,Qh(he.canonical,ie.renderWorldCopies)?oe/10:oe,se);if(G(Je),!L)continue;m.setupElevationDraw(_e,L,at);const Ke=he.toUnwrapped();V&&V.setupShadows(Ke,L),d.uploadCommonUniforms(C,L,Ke,null,H),L.draw(d,fe,K,xe,W,ni.backCCW,De,"terrain_raster",m.gridBuffer,ce,ue)}}}}(r,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,r.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const r=this.painter,c=this.painter.context,d=this.proxySourceCache,m=this.proxiedCoords[d.id],g=this._drapedRenderBatches.shift(),E=r.style.order,A=[];let C=0;for(const R of m){const L=d.getTileByID(R.proxyTileKey),O=d.proxyCachedFBO[R.key]?d.proxyCachedFBO[R.key][t]:void 0,V=O!==void 0?d.renderCache[O]:this.pool[C++],H=O!==void 0;if(L.texture=V.tex,H&&!V.dirty){A.push(L.tileID);continue}let G;c.bindFramebuffer.set(V.fb.framebuffer),this.renderedToTile=!1,V.dirty&&(c.clear({color:s.al.transparent,stencil:0}),V.dirty=!1);for(let W=g.start;W<=g.end;++W){const K=r.style._mergedLayers[E[W]];if(K.isHidden(r.transform.zoom))continue;const ie=r.style.getLayerSourceCache(K),oe=ie?this.proxyToSource[R.key][ie.id]:[R];if(!oe)continue;const se=oe;c.viewport.set([0,0,V.fb.width,V.fb.height]),G!==(ie?ie.id:null)&&(this._setupStencil(V,oe,K,ie),G=ie?ie.id:null),r.renderLayer(r,ie,K,se)}if(this._drapedRenderBatches.length===0)for(const W of this._pendingGroundEffectLayers){const K=r.style._mergedLayers[E[W]];if(K.isHidden(r.transform.zoom))continue;const ie=r.style.getLayerSourceCache(K),oe=ie?this.proxyToSource[R.key][ie.id]:[R];if(!oe)continue;const se=oe;c.viewport.set([0,0,V.fb.width,V.fb.height]),G!==(ie?ie.id:null)&&(this._setupStencil(V,oe,K,ie),G=ie?ie.id:null),r.renderLayer(r,ie,K,se)}this.renderedToTile?(V.dirty=!0,A.push(L.tileID)):H||--C,C===5&&(C=0,this.renderToBackBuffer(A))}return this.renderToBackBuffer(A),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,r.width,r.height]),g.end+1}postRender(){}isLayerOrderingCorrect(t){const r=t.order.length;let c=-1,d=r;for(let m=0;m<r;++m)this._style.isLayerDraped(t._mergedLayers[t.order[m]])?c=Math.max(c,m):d=Math.min(d,m);return d>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(r=>r.dem).forEach(r=>{t=Math.min(t,r.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,r,c){if(!this._visibleDemTiles)return null;const d=this._visibleDemTiles.filter(m=>m.dem).map(m=>{const g=m.tileID,E=1<<g.overscaledZ,{x:A,y:C}=g.canonical,R=A/E,L=(A+1)/E,O=C/E,V=(C+1)/E;return{minx:R,miny:O,maxx:L,maxy:V,t:m.dem.tree.raycastRoot(R,O,L,V,t,r,c),tile:m}});d.sort((m,g)=>(m.t!==null?m.t:Number.MAX_VALUE)-(g.t!==null?g.t:Number.MAX_VALUE));for(const m of d){if(m.t==null)return null;const g=m.tile.dem.tree.raycast(m.minx,m.miny,m.maxx,m.maxy,t,r,c);if(g!=null)return g}return null}_createFBO(){const t=this.painter.context,r=t.gl,c=this.drapeBufferSize;t.activeTexture.set(r.TEXTURE0);const d=new s.T(t,{width:c[0],height:c[1],data:null},r.RGBA8);d.bind(r.LINEAR,r.CLAMP_TO_EDGE);const m=t.createFramebuffer(c[0],c[1],!0,null);return m.colorAttachment.set(d.texture),m.depthAttachment=new mp(t,m.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,m.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):m.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&r.texParameterf(r.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:m,tex:d,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const r=this._style._mergedLayers[t],c=r.isHidden(this.painter.transform.zoom);return r.type==="hillshade"||r.type==="custom"?!c&&r.shouldRedrape():!c&&r.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const c of this._style.getSources())if(c instanceof Da){t=!0;break}if(!t)return;const r={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],m=this._style.getLayerSourceCache(d);if(m&&!r[m.id]&&!d.isHidden(this.painter.transform.zoom)&&d.type==="line"&&d.widthExpression()instanceof s.ab){r[m.id]=!0;for(const g of this.proxyCoords){const E=this.proxyToSource[g.key][m.id];if(E)for(const A of E)this._clearRenderCacheForTile(m.id,A)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof vs){t=!0;break}if(!t)return;const r={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],m=this._style.getLayerSourceCache(d);if(!m||r[m.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="raster")continue;const g=d.paint.get("raster-fade-duration");for(const E of this.proxyCoords){const A=this.proxyToSource[E.key][m.id];if(A)for(const C of A){const R=pu(m.getTile(C),m.findLoadedParent(C,0),m,this.painter.transform,g);(R.opacity!==1||R.mix!==0)&&this._clearRenderCacheForTile(m.id,C)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,r=t.length;if(r===0)return;const c=[];this._pendingGroundEffectLayers=[];let d,m=0,g=this._style._mergedLayers[t[m]];for(;!this._style.isLayerDraped(g)&&g.isHidden(this.painter.transform.zoom)&&++m<r;)g=this._style._mergedLayers[t[m]];for(;m<r;++m){const E=this._style._mergedLayers[t[m]];E.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(E)?d===void 0&&(d=m):(E.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(m),d!==void 0&&(c.push({start:d,end:m-1}),d=void 0)))}if(d!==void 0&&c.push({start:d,end:m-1}),c.length!==0){const E=c[c.length-1];this._pendingGroundEffectLayers.every(A=>A>E.end)||s.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){const r=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,r.renderCache.length>r.renderCachePool.length){const g=Object.values(r.proxyCachedFBO);r.proxyCachedFBO={};for(let E=0;E<g.length;++E){const A=Object.values(g[E]);r.renderCachePool.push(...A)}}return}this._clearRasterLayersFromRenderCache();const c=this.proxyCoords,d=this._tilesDirty;for(let g=c.length-1;g>=0;g--){const E=c[g];if(r.getTileByID(E.key),r.proxyCachedFBO[E.key]!==void 0){const A=t[E.key],C=this.proxyToSource[E.key];let R=0;for(const L in C){const O=C[L],V=A[L];if(!V||V.length!==O.length||O.some((H,G)=>H!==V[G]||d[L]&&d[L].hasOwnProperty(H.key))){R=-1;break}++R}for(const L in r.proxyCachedFBO[E.key])r.renderCache[r.proxyCachedFBO[E.key][L]].dirty=R<0||R!==Object.values(A).length}}const m=[...this._drapedRenderBatches];m.sort((g,E)=>E.end-E.start-(g.end-g.start));for(const g of m)for(const E of c){if(r.proxyCachedFBO[E.key])continue;let A=r.renderCachePool.pop();A===void 0&&r.renderCache.length<50&&(A=r.renderCache.length,r.renderCache.push(this._createFBO())),A!==void 0&&(r.proxyCachedFBO[E.key]={},r.proxyCachedFBO[E.key][g.start]=A,r.renderCache[A].dirty=!0)}this._tilesDirty={}}_setupStencil(t,r,c,d){if(!d||!this._sourceTilesOverlap[d.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const m=this.painter.context,g=m.gl;if(r.length<=1)return void(this._overlapStencilType=!1);let E;if(c.isTileClipped())E=r.length,this._overlapStencilMode.test={func:g.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(r[0].overscaledZ>r[r.length-1].overscaledZ))return void(this._overlapStencilType=!1);E=1,this._overlapStencilMode.test={func:g.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+E>255&&(m.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=E,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(r,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):li.disabled}_renderTileClippingMasks(t,r){const c=this.painter,d=this.painter.context,m=d.gl;c._tileClippingMaskIDs={},d.setColorMode(Si.disabled),d.setDepthMode(qt.disabled);const g=c.getOrCreateProgram("clippingMask");for(const E of t){const A=c._tileClippingMaskIDs[E.key]=--r;g.draw(c,m.TRIANGLES,qt.disabled,new li({func:m.ALWAYS,mask:0},A,255,m.KEEP,m.KEEP,m.REPLACE),Si.disabled,ni.disabled,Ja(E.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){const r=this.painter.transform;if(t.x<0||t.x>r.width||t.y<0||t.y>r.height)return null;const c=[t.x,t.y,1,1];s.ad.vec4.transformMat4(c,c,r.pixelMatrixInverse),s.ad.vec4.scale(c,c,1/c[3]),c[0]/=r.worldSize,c[1]/=r.worldSize;const d=r._camera.position,m=s.bH(1,r.center.lat),g=[d[0],d[1],d[2]/m,0],E=s.ad.vec3.subtract([],c.slice(0,3),g);s.ad.vec3.normalize(E,E);const A=this.raycast(g,E,this._exaggeration);return A!==null&&A?(s.ad.vec3.scaleAndAdd(g,g,E,A),g[3]=g[2],g[2]*=m,g):null}_setupProxiedCoordsForOrtho(t,r,c){if(t.getSource()instanceof s.aK)return this._setupProxiedCoordsForImageSource(t,r,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const d=this.proxiedCoords[t.id]=[],m=this.proxyCoords;for(let A=0;A<m.length;A++){const C=m[A],R=this._findTileCoveringTileID(C,t);if(R){const L=this._createProxiedId(C,R,c[C.key]&&c[C.key][t.id]);d.push(L),this.proxyToSource[C.key][t.id]=[L]}}let g=!1;const E=new Set;for(let A=0;A<r.length;A++){const C=t.getTile(r[A]);if(!C||!C.hasData())continue;const R=this._findTileCoveringTileID(C.tileID,this.proxySourceCache);if(R&&R.tileID.canonical.z!==C.tileID.canonical.z){const L=this.proxyToSource[R.tileID.key][t.id],O=this._createProxiedId(R.tileID,C,c[R.tileID.key]&&c[R.tileID.key][t.id]);L?L.splice(L.length-1,0,O):this.proxyToSource[R.tileID.key][t.id]=[O];const V=this.proxyToSource[R.tileID.key][t.id];E.has(V)||E.add(V),d.push(O),g=!0}}if(this._sourceTilesOverlap[t.id]=g,g&&this._debugParams.sortTilesHiZFirst)for(const A of E)A.sort((C,R)=>R.overscaledZ-C.overscaledZ)}_setupProxiedCoordsForImageSource(t,r,c){if(!t.getSource().loaded())return;const d=this.proxiedCoords[t.id]=[],m=this.proxyCoords,g=t.getSource(),E=g.tileID;if(!E)return;const A=new s.P(E.x,E.y)._div(1<<E.z),C=g.coordinates.map(s.ac.fromLngLat).reduce((L,O)=>(L.min.x=Math.min(L.min.x,O.x-A.x),L.min.y=Math.min(L.min.y,O.y-A.y),L.max.x=Math.max(L.max.x,O.x-A.x),L.max.y=Math.max(L.max.y,O.y-A.y),L),{min:new s.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new s.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),R=(L,O)=>{const V=L.wrap+L.canonical.x/(1<<L.canonical.z),H=L.canonical.y/(1<<L.canonical.z),G=s.ai/(1<<L.canonical.z),W=O.wrap+O.canonical.x/(1<<O.canonical.z),K=O.canonical.y/(1<<O.canonical.z);return V+G<W+C.min.x||V>W+C.max.x||H+G<K+C.min.y||H>K+C.max.y};for(let L=0;L<m.length;L++){const O=m[L];for(let V=0;V<r.length;V++){const H=t.getTile(r[V]);if(!H||!H.hasData()||R(O,H.tileID))continue;const G=this._createProxiedId(O,H,c[O.key]&&c[O.key][t.id]),W=this.proxyToSource[O.key][t.id];W?W.push(G):this.proxyToSource[O.key][t.id]=[G],d.push(G)}}}_createProxiedId(t,r,c){let d=this.orthoMatrix;if(c){const m=c.find(g=>g.key===r.tileID.key);if(m)return m}if(r.tileID.key!==t.key){const m=t.canonical.z-r.tileID.canonical.z;let g,E,A;d=s.ad.mat4.create();const C=r.tileID.wrap-t.wrap<<t.overscaledZ;m>0?(g=s.ai>>m,E=g*((r.tileID.canonical.x<<m)-t.canonical.x+C),A=g*((r.tileID.canonical.y<<m)-t.canonical.y)):(g=s.ai<<-m,E=s.ai*(r.tileID.canonical.x-(t.canonical.x+C<<-m)),A=s.ai*(r.tileID.canonical.y-(t.canonical.y<<-m))),s.ad.mat4.ortho(d,0,g,0,g,0,1),s.ad.mat4.translate(d,d,[E,A,0])}return new mu(r.tileID,t.key,d)}_findTileCoveringTileID(t,r){let c=r.getTile(t);if(c&&c.hasData())return c;const d=this._findCoveringTileCache[r.id],m=d[t.key];if(c=m?r.getTileByID(m):null,c&&c.hasData()||m===null)return c;let g=c?c.tileID:t,E=g.overscaledZ;const A=r.getSource().minzoom,C=[];if(!m){const L=r.getSource().maxzoom;if(t.canonical.z>=L){const O=t.canonical.z-L;r.getSource().reparseOverscaled?(E=Math.max(t.canonical.z+2,r.transform.tileZoom),g=new s.aH(E,t.wrap,L,t.canonical.x>>O,t.canonical.y>>O)):O!==0&&(E=L,g=new s.aH(E,t.wrap,L,t.canonical.x>>O,t.canonical.y>>O))}g.key!==t.key&&(C.push(g.key),c=r.getTile(g))}const R=L=>{C.forEach(O=>{d[O]=L}),C.length=0};for(E-=1;E>=A&&(!c||!c.hasData());E--){c&&R(c.tileID.key);const L=g.calculateScaledKey(E);if(c=r.getTileByID(L),c&&c.hasData())break;const O=d[L];if(O===null)break;O===void 0?C.push(L):c=r.getTileByID(O)}return R(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,r){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[r.key]=!0}}function vp(u,t,r){const c=function(E,A,C){const R=s.ad.vec3.dot(A,E),L=s.ad.vec3.dot(C,[.2126,.7152,.0722]),O=(H,G,W)=>(1-W)*H+W*G,V=O(1-.3*Math.min(L,1),1,Math.min(R+1,1));return O(.92,1,Math.asin(s.ay(A[2],-1,1))/Math.PI+.5)*V}(u,[0,0,1],t),d=[0,0,0];s.ad.vec3.scale(d,r.slice(0,3),c);const m=[0,0,0];s.ad.vec3.scale(m,t.slice(0,3),u[2]);const g=[0,0,0];return s.ad.vec3.add(g,d,m),s.cg(g)}const nc=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Q_=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class xp{static cacheKey(t,r,c,d){let m=`${r}${d?d.cacheKey:""}`;for(const g of c)t.usedDefines.includes(g)&&(m+=`/${g}`);return m}constructor(t,r,c,d,m,g){const E=t.gl;this.program=E.createProgram(),this.configuration=d,this.name=r,this.fixedDefines=[...g];const A=d?d.getBinderAttributes():[],C=(c.staticAttributes||[]).concat(A);let R=d?d.defines():[];R=R.concat(g.map(W=>`#define ${W}`));const L=`#version 300 es
`;let O=L+R.concat("precision mediump float;",lu,Fh.fragmentSource).join(`
`);for(const W of c.fragmentIncludes)O+=`
${da[W]}`;O+=`
${c.fragmentSource}`;let V=L+R.concat("precision highp float;",lu,Fh.vertexSource).join(`
`);for(const W of c.vertexIncludes)V+=`
${da[W]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&c.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(V+=`
uniform int u_instanceID;
`),V+=`
${c.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(V=V.replaceAll("gl_InstanceID","u_instanceID"));const H=E.createShader(E.FRAGMENT_SHADER);if(E.isContextLost())return void(this.failedToCreate=!0);E.shaderSource(H,O),E.compileShader(H),E.attachShader(this.program,H);const G=E.createShader(E.VERTEX_SHADER);if(E.isContextLost())this.failedToCreate=!0;else{E.shaderSource(G,V),E.compileShader(G),E.attachShader(this.program,G),this.attributes={},this.numAttributes=C.length;for(let W=0;W<this.numAttributes;W++)if(C[W]){const K=C[W].startsWith("a_")?C[W]:`a_${C[W]}`;E.bindAttribLocation(this.program,W,K),this.attributes[K]=W}E.linkProgram(this.program),E.deleteShader(G),E.deleteShader(H),this.fixedUniforms=m(t),this.binderUniforms=d?d.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(W=>({u_instanceID:new s.bN(W)}))(t)),(g.includes("TERRAIN")||r.indexOf("symbol")!==-1||r.indexOf("circle")!==-1)&&(this.terrainUniforms=(W=>({u_dem:new s.bN(W),u_dem_prev:new s.bN(W),u_dem_tl:new s.bK(W),u_dem_scale:new s.bM(W),u_dem_tl_prev:new s.bK(W),u_dem_scale_prev:new s.bM(W),u_dem_size:new s.bM(W),u_dem_lerp:new s.bM(W),u_exaggeration:new s.bM(W),u_depth:new s.bN(W),u_depth_size_inv:new s.bK(W),u_depth_range_unpack:new s.bK(W),u_occluder_half_size:new s.bM(W),u_occlusion_depth_offset:new s.bM(W),u_meter_to_dem:new s.bM(W),u_label_plane_matrix_inv:new s.bJ(W)}))(t)),g.includes("GLOBE")&&(this.globeUniforms=(W=>({u_tile_tl_up:new s.bL(W),u_tile_tr_up:new s.bL(W),u_tile_br_up:new s.bL(W),u_tile_bl_up:new s.bL(W),u_tile_up_scale:new s.bM(W)}))(t)),g.includes("FOG")&&(this.fogUniforms=(W=>({u_fog_matrix:new s.bJ(W),u_fog_range:new s.bK(W),u_fog_color:new s.cb(W),u_fog_horizon_blend:new s.bM(W),u_fog_vertical_limit:new s.bK(W),u_fog_temporal_offset:new s.bM(W),u_frustum_tl:new s.bL(W),u_frustum_tr:new s.bL(W),u_frustum_br:new s.bL(W),u_frustum_bl:new s.bL(W),u_globe_pos:new s.bL(W),u_globe_radius:new s.bM(W),u_globe_transition:new s.bM(W),u_is_globe:new s.bN(W),u_viewport:new s.bK(W)}))(t)),g.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(W=>({u_cutoff_params:new s.cb(W)}))(t)),g.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(W=>({u_lighting_ambient_color:new s.bL(W),u_lighting_directional_dir:new s.bL(W),u_lighting_directional_color:new s.bL(W),u_ground_radiance:new s.bL(W)}))(t)),g.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(W=>({u_light_matrix_0:new s.bJ(W),u_light_matrix_1:new s.bJ(W),u_fade_range:new s.bK(W),u_shadow_normal_offset:new s.bL(W),u_shadow_intensity:new s.bM(W),u_shadow_texel_size:new s.bM(W),u_shadow_map_resolution:new s.bM(W),u_shadow_direction:new s.bL(W),u_shadow_bias:new s.bL(W),u_shadowmap_0:new s.bN(W),u_shadowmap_1:new s.bN(W)}))(t))}}setTerrainUniformValues(t,r){if(!this.terrainUniforms)return;const c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in r)c[d]&&c[d].set(this.program,d,r[d])}}setGlobeUniformValues(t,r){if(!this.globeUniforms)return;const c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in r)c[d]&&c[d].set(this.program,d,r[d])}}setFogUniformValues(t,r){if(!this.fogUniforms)return;const c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in r)c[d].set(this.program,d,r[d])}}setCutoffUniformValues(t,r){if(!this.cutoffUniforms)return;const c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in r)c[d].set(this.program,d,r[d])}}setLightsUniformValues(t,r){if(!this.lightsUniforms)return;const c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in r)c[d].set(this.program,d,r[d])}}setShadowUniformValues(t,r){if(this.failedToCreate||!this.shadowUniforms)return;const c=this.shadowUniforms;t.program.set(this.program);for(const d in r)c[d].set(this.program,d,r[d])}_drawDebugWireframe(t,r,c,d,m,g,E,A,C,R){const L=t.options.wireframe;if(L.terrain===!1&&L.layers2D===!1&&L.layers3D===!1)return;const O=t.context;if(!(!(!L.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!L.layers2D||t._terrain&&t._terrain.renderingToTexture||!nc.includes(this.name))||!(!L.layers3D||!Q_.includes(this.name))))return;const V=O.gl,H=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,m,O);if(!H)return;const G=[...this.fixedDefines];G.push("DEBUG_WIREFRAME");const W=t.getOrCreateProgram(this.name,{config:this.configuration,defines:G});O.program.set(W.program);const K=(se,fe,ce)=>{if(fe[se]&&ce[se])for(const ue in fe[se])ce[se][ue]&&ce[se][ue].set(ce.program,ue,fe[se][ue].current)};C&&C.setUniforms(W.program,O,W.binderUniforms,E,{zoom:A}),K("fixedUniforms",this,W),K("terrainUniforms",this,W),K("globeUniforms",this,W),K("fogUniforms",this,W),K("lightsUniforms",this,W),K("shadowUniforms",this,W),H.bind(),O.setColorMode(new Si([V.ONE,V.ONE_MINUS_SRC_ALPHA,V.ZERO,V.ONE],s.al.transparent,[!0,!0,!0,!1])),O.setDepthMode(new qt(r.func===V.LESS?V.LEQUAL:r.func,qt.ReadOnly,r.range)),O.setStencilMode(li.disabled);const ie=3*g.primitiveLength*2,oe=3*g.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const se=R||1;for(let fe=0;fe<se;++fe)W.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",fe),V.drawElements(V.LINES,ie,V.UNSIGNED_SHORT,oe)}else R&&R>1?V.drawElementsInstanced(V.LINES,ie,V.UNSIGNED_SHORT,oe,R):V.drawElements(V.LINES,ie,V.UNSIGNED_SHORT,oe);m.bind(),O.program.set(this.program),O.setDepthMode(r),O.setStencilMode(c),O.setColorMode(d)}checkUniforms(t,r,c){if(this.fixedDefines.includes(r)){for(const d of Object.keys(c))if(!c[d].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${d} not set but required by ${r} being defined`)}}draw(t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W){const K=t.context,ie=K.gl;if(this.failedToCreate)return;K.program.set(this.program),K.setDepthMode(c),K.setStencilMode(d),K.setColorMode(m),K.setCullFace(g);for(const fe of Object.keys(this.fixedUniforms))this.fixedUniforms[fe].set(this.program,fe,E[fe]);H&&H.setUniforms(this.program,K,this.binderUniforms,O,{zoom:V});const oe={[ie.POINTS]:1,[ie.LINES]:2,[ie.TRIANGLES]:3,[ie.LINE_STRIP]:1}[r];this.checkUniforms(A,"RENDER_SHADOWS",this.shadowUniforms);const se=W&&W>0?1:void 0;for(const fe of L.get()){const ce=fe.vaos||(fe.vaos={});if((ce[A]||(ce[A]=new lp)).bind(K,this,C,H?H.getPaintVertexBuffers():[],R,fe.vertexOffset,G||[],se),this.forceManualRenderingForInstanceIDShaders){const ue=W||1;for(let he=0;he<ue;++he)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",he),R?ie.drawElements(r,fe.primitiveLength*oe,ie.UNSIGNED_SHORT,fe.primitiveOffset*oe*2):ie.drawArrays(r,fe.vertexOffset,fe.vertexLength)}else W&&W>1?ie.drawElementsInstanced(r,fe.primitiveLength*oe,ie.UNSIGNED_SHORT,fe.primitiveOffset*oe*2,W):R?ie.drawElements(r,fe.primitiveLength*oe,ie.UNSIGNED_SHORT,fe.primitiveOffset*oe*2):ie.drawArrays(r,fe.vertexOffset,fe.vertexLength);r===ie.TRIANGLES&&R&&this._drawDebugWireframe(t,c,d,m,R,fe,O,V,H,W)}}}function td(u,t){const r=Math.pow(2,t.tileID.overscaledZ),c=t.tileSize*Math.pow(2,u.transform.tileZoom)/r,d=c*(t.tileID.canonical.x+t.tileID.wrap*r),m=c*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/s.at(t,1,u.transform.tileZoom),u_pixel_coord_upper:[d>>16,m>>16],u_pixel_coord_lower:[65535&d,65535&m]}}const _u={terrain:0,flat:1},id=s.ad.mat4.create(),gu=(u,t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W,K)=>{const ie=t.style.light,oe=ie.properties.get("position"),se=[oe.x,oe.y,oe.z],fe=s.ad.mat3.create();ie.properties.get("anchor")==="viewport"&&(s.ad.mat3.fromRotation(fe,-t.transform.angle),s.ad.vec3.transformMat3(se,se,fe));const ce=ie.properties.get("color"),ue=t.transform,he={u_matrix:u,u_lightpos:se,u_lightintensity:ie.properties.get("intensity"),u_lightcolor:[ce.r,ce.g,ce.b],u_vertical_gradient:+r,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:id,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:_u[C],u_base_type:_u[R],u_ao:d,u_edge_radius:m,u_width_scale:g,u_flood_light_color:H,u_vertical_scale:G,u_flood_light_intensity:W,u_ground_shadow_factor:K};return ue.projection.name==="globe"&&(he.u_tile_id=[E.canonical.x,E.canonical.y,1<<E.canonical.z],he.u_zoom_transition=L,he.u_inv_rot_matrix=V,he.u_merc_center=O,he.u_up_dir=ue.projection.upVector(new s.bT(0,0,0),O[0]*s.ai,O[1]*s.ai),he.u_height_lift=A),he},Qa=(u,t,r,c,d,m)=>({u_matrix:u,u_edge_radius:t,u_width_scale:r,u_vertical_scale:c,u_height_type:_u[d],u_base_type:_u[m]}),rd=(u,t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W)=>{const K=gu(u,t,r,c,d,m,g,E,C,R,L,O,V,H,G,W,1,[0,0,0]),ie={u_height_factor:-Math.pow(2,E.overscaledZ)/A.tileSize/8};return s.l(K,td(t,A),ie)},el=(u,t)=>({u_matrix:u,u_emissive_strength:t}),nd=(u,t,r,c)=>s.l(el(u,t),td(r,c)),yu=(u,t,r)=>({u_matrix:u,u_world:r,u_emissive_strength:t}),vu=(u,t,r,c,d)=>s.l(nd(u,t,r,c),{u_world:d}),sc=(u,t,r,c,d)=>({u_matrix:u,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:r,u_height_scale:c,u_reset_depth:d}),bp=(u,t,r,c)=>{const d=s.ai/r.tileSize;return{u_matrix:u,u_camera_to_center_distance:t.getCameraToCenterDistance(c),u_extrude_scale:[t.pixelsToGLUnits[0]/d,t.pixelsToGLUnits[1]/d]}},wp=(u,t,r=1)=>({u_matrix:u,u_color:t.toRenderColor(null),u_overlay:0,u_overlay_scale:r}),tl=s.ad.mat4.create(),xu=(u,t,r,c,d,m,g)=>{const E=u.transform,A=E.projection.name==="globe",C=A?s.cO(E.zoom,t.canonical)*E._pixelsPerMercatorPixel:s.at(r,1,m),R={u_matrix:t.projMatrix,u_extrude_scale:C,u_intensity:g,u_inv_rot_matrix:tl,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(A){R.u_inv_rot_matrix=c,R.u_merc_center=d,R.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],R.u_zoom_transition=s.ag(E.zoom);const L=d[0]*s.ai,O=d[1]*s.ai;R.u_up_dir=E.projection.upVector(new s.bT(0,0,0),L,O)}return R};function It(u,[t,r,c,d],[m,g]){if(m===g)return[0,0,0,0];const E=255*(u-1)/(u*(g-m));return[t*E,r*E,c*E,d*E]}function sd(u,t,[r,c]){return r===c?0:.5/u+(t-r)*(u-1)/(u*(c-r))}const od=(u,t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W,K,ie,oe,se)=>({u_matrix:u,u_normalize_matrix:t,u_globe_matrix:r,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:m,u_scale_parent:C,u_fade_t:R.mix,u_opacity:R.opacity*L.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:L.paint.get("raster-brightness-min"),u_brightness_high:L.paint.get("raster-brightness-max"),u_saturation_factor:s.cP(L.paint.get("raster-saturation")),u_contrast_factor:s.cQ(L.paint.get("raster-contrast")),u_spin_weights:No(L.paint.get("raster-hue-rotate")),u_perspective_transform:O,u_raster_elevation:V,u_zoom_transition:g,u_merc_center:E,u_cutoff_params:A,u_colorization_mix:It(s.cR,G,K),u_colorization_offset:sd(s.cR,W,K),u_color_ramp:H,u_texture_offset:[oe/(ie+2*oe),ie/(ie+2*oe)],u_texture_res:[ie+2*oe,ie+2*oe],u_emissive_strength:se});function No(u){u*=Math.PI/180;const t=Math.sin(u),r=Math.cos(u);return[(2*r+1)/3,(-Math.sqrt(3)*t-r+1)/3,(Math.sqrt(3)*t-r+1)/3]}const cs=.05,$t=(u,t,r,c,d,m,g,E,A,C,R,L)=>({u_matrix:u,u_normalize_matrix:t,u_globe_matrix:r,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:m,u_scale_parent:C,u_fade_t:R.mix,u_opacity:R.opacity,u_image0:0,u_image1:1,u_raster_elevation:L,u_zoom_transition:g,u_merc_center:E,u_cutoff_params:A}),ad=(u,t,r,c,d,m,g,E,A,C)=>({u_particle_texture:u,u_particle_texture_side_len:t,u_tile_offset:r,u_velocity:c,u_color_ramp:m,u_velocity_res:d,u_max_speed:g,u_uv_offset:E,u_data_scale:[255*A[0],255*A[1]],u_data_offset:C,u_particle_pos_scale:1.1,u_particle_pos_offset:[cs,cs]}),eg=(u,t,r,c,d,m,g,E,A,C)=>({u_particle_texture:u,u_particle_texture_side_len:t,u_velocity:r,u_velocity_res:c,u_max_speed:d,u_speed_factor:m,u_reset_rate:g,u_rand_seed:Math.random(),u_uv_offset:E,u_data_scale:[255*A[0],255*A[1]],u_data_offset:C,u_particle_pos_scale:1.1,u_particle_pos_offset:[cs,cs]}),Tp=s.ad.mat4.create(),bu=(u,t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W,K,ie,oe,se,fe)=>{const ce=d.transform,ue={u_is_size_zoom_constant:+(u==="constant"||u==="source"),u_is_size_feature_constant:+(u==="constant"||u==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:ce.getCameraToCenterDistance(ie),u_rotate_symbol:+r,u_aspect_ratio:ce.width/ce.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:m,u_label_plane_matrix:g,u_coord_matrix:E,u_is_text:+C,u_elevation_from_sea:A?1:0,u_pitch_with_map:+c,u_texsize:R,u_texsize_icon:L,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Tp,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Tp,u_up_vector:[0,-1,0],u_color_adj_mat:oe,u_icon_transition:se||0,u_gamma_scale:c?d.transform.getCameraToCenterDistance(ie)*Math.cos(d.terrain?0:d.transform._pitch):1,u_device_pixel_ratio:s.q.devicePixelRatio,u_is_halo:1,u_scale_factor:fe||1};return ie.name==="globe"&&(ue.u_tile_id=[V.canonical.x,V.canonical.y,1<<V.canonical.z],ue.u_zoom_transition=H,ue.u_inv_rot_matrix=W,ue.u_merc_center=G,ue.u_camera_forward=ce._camera.forward(),ue.u_ecef_origin=s.cS(ce.globeMatrix,V.toUnwrapped()),ue.u_tile_matrix=Float32Array.from(ce.globeMatrix),ue.u_up_vector=K),ue},ld=(u,t,r,c)=>({u_matrix:u,u_emissive_strength:t,u_opacity:r,u_color:c}),Sp=(u,t,r,c,d,m,g,E,A)=>s.l(function(C,R,L,O,V,H){const{width:G,height:W}=O.imageManager.getPixelSize(R),K=Math.pow(2,H.tileID.overscaledZ),ie=H.tileSize*Math.pow(2,O.transform.tileZoom)/K,oe=ie*(H.tileID.canonical.x+H.tileID.wrap*K),se=ie*H.tileID.canonical.y;return{u_image:0,u_pattern_tl:L.tl,u_pattern_br:L.br,u_texsize:[G,W],u_pattern_size:L.displaySize,u_pattern_units_to_pixels:V?[O.transform.width,-1*O.transform.height]:[1/s.at(H,1,O.transform.tileZoom),1/s.at(H,1,O.transform.tileZoom)],u_pixel_coord_upper:[oe>>16,se>>16],u_pixel_coord_lower:[65535&oe,65535&se]}}(0,m,g,c,E,A),{u_matrix:u,u_emissive_strength:t,u_opacity:r}),wu=new Float32Array(s.ad.mat4.identity([])),cd=(u,t,r,c,d,m,g,E,A,C,R,L,O,V=[0,0,0],H)=>{const G=d.style.light,W=G.properties.get("position"),K=[-W.x,-W.y,W.z],ie=s.ad.mat3.create();G.properties.get("anchor")==="viewport"&&(s.ad.mat3.fromRotation(ie,-d.transform.angle),s.ad.vec3.transformMat3(K,K,ie));const oe=R.alphaMode==="MASK",se=G.properties.get("color").toRenderColor(null),fe=O.paint.get("model-ambient-occlusion-intensity"),ce=O.paint.get("model-color").constantOr(s.al.white).toRenderColor(null),ue=O.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:u,u_lighting_matrix:t,u_normal_matrix:r,u_node_matrix:c||wu,u_lightpos:K,u_lightintensity:G.properties.get("intensity"),u_lightcolor:[se.r,se.g,se.b],u_camera_pos:V,u_opacity:m,u_baseTextureIsAlpha:0,u_alphaMask:+oe,u_alphaCutoff:R.alphaCutoff,u_baseColorFactor:[g.r,g.g,g.b,g.a],u_emissiveFactor:[E[0],E[1],E[2],1],u_metallicFactor:A,u_roughnessFactor:C,u_baseColorTexture:kr.BaseColor,u_metallicRoughnessTexture:kr.MetallicRoughness,u_normalTexture:kr.Normal,u_occlusionTexture:kr.Occlusion,u_emissionTexture:kr.Emission,u_lutTexture:kr.LUT,u_color_mix:[ce.r,ce.g,ce.b,ue],u_aoIntensity:fe,u_emissive_strength:L,u_occlusionTextureTransform:H||[0,0,0,0]}},Ep=(u,t=wu,r=wu)=>({u_matrix:u,u_instance:t,u_node_matrix:r}),ud={fillExtrusion:u=>({u_matrix:new s.bJ(u),u_lightpos:new s.bL(u),u_lightintensity:new s.bM(u),u_lightcolor:new s.bL(u),u_vertical_gradient:new s.bM(u),u_opacity:new s.bM(u),u_edge_radius:new s.bM(u),u_width_scale:new s.bM(u),u_ao:new s.bK(u),u_height_type:new s.bN(u),u_base_type:new s.bN(u),u_tile_id:new s.bL(u),u_zoom_transition:new s.bM(u),u_inv_rot_matrix:new s.bJ(u),u_merc_center:new s.bK(u),u_up_dir:new s.bL(u),u_height_lift:new s.bM(u),u_flood_light_color:new s.bL(u),u_vertical_scale:new s.bM(u),u_flood_light_intensity:new s.bM(u),u_ground_shadow_factor:new s.bL(u)}),fillExtrusionDepth:u=>({u_matrix:new s.bJ(u),u_edge_radius:new s.bM(u),u_width_scale:new s.bM(u),u_vertical_scale:new s.bM(u),u_height_type:new s.bN(u),u_base_type:new s.bN(u)}),fillExtrusionPattern:u=>({u_matrix:new s.bJ(u),u_lightpos:new s.bL(u),u_lightintensity:new s.bM(u),u_lightcolor:new s.bL(u),u_vertical_gradient:new s.bM(u),u_height_factor:new s.bM(u),u_edge_radius:new s.bM(u),u_width_scale:new s.bM(u),u_ao:new s.bK(u),u_height_type:new s.bN(u),u_base_type:new s.bN(u),u_tile_id:new s.bL(u),u_zoom_transition:new s.bM(u),u_inv_rot_matrix:new s.bJ(u),u_merc_center:new s.bK(u),u_up_dir:new s.bL(u),u_height_lift:new s.bM(u),u_image:new s.bN(u),u_texsize:new s.bK(u),u_pixel_coord_upper:new s.bK(u),u_pixel_coord_lower:new s.bK(u),u_tile_units_to_pixels:new s.bM(u),u_opacity:new s.bM(u)}),fillExtrusionGroundEffect:u=>({u_matrix:new s.bJ(u),u_opacity:new s.bM(u),u_ao_pass:new s.bM(u),u_meter_to_tile:new s.bM(u),u_ao:new s.bK(u),u_flood_light_intensity:new s.bM(u),u_flood_light_color:new s.bL(u),u_attenuation:new s.bM(u),u_edge_radius:new s.bM(u),u_fb:new s.bN(u),u_fb_size:new s.bM(u),u_dynamic_offset:new s.bM(u)}),fill:u=>({u_matrix:new s.bJ(u),u_emissive_strength:new s.bM(u)}),fillPattern:u=>({u_matrix:new s.bJ(u),u_emissive_strength:new s.bM(u),u_image:new s.bN(u),u_texsize:new s.bK(u),u_pixel_coord_upper:new s.bK(u),u_pixel_coord_lower:new s.bK(u),u_tile_units_to_pixels:new s.bM(u)}),fillOutline:u=>({u_matrix:new s.bJ(u),u_emissive_strength:new s.bM(u),u_world:new s.bK(u)}),fillOutlinePattern:u=>({u_matrix:new s.bJ(u),u_emissive_strength:new s.bM(u),u_world:new s.bK(u),u_image:new s.bN(u),u_texsize:new s.bK(u),u_pixel_coord_upper:new s.bK(u),u_pixel_coord_lower:new s.bK(u),u_tile_units_to_pixels:new s.bM(u)}),elevatedStructures:u=>({u_matrix:new s.bJ(u)}),elevatedStructuresDepthReconstruct:u=>({u_matrix:new s.bJ(u),u_camera_pos:new s.bL(u),u_depth_bias:new s.bM(u),u_height_scale:new s.bM(u),u_reset_depth:new s.bM(u)}),circle:s.cT,collisionBox:u=>({u_matrix:new s.bJ(u),u_camera_to_center_distance:new s.bM(u),u_extrude_scale:new s.bK(u)}),collisionCircle:u=>({u_matrix:new s.bJ(u),u_inv_matrix:new s.bJ(u),u_camera_to_center_distance:new s.bM(u),u_viewport_size:new s.bK(u)}),debug:u=>({u_color:new s.cA(u),u_matrix:new s.bJ(u),u_overlay:new s.bN(u),u_overlay_scale:new s.bM(u)}),clippingMask:u=>({u_matrix:new s.bJ(u)}),heatmap:u=>({u_extrude_scale:new s.bM(u),u_intensity:new s.bM(u),u_matrix:new s.bJ(u),u_inv_rot_matrix:new s.bJ(u),u_merc_center:new s.bK(u),u_tile_id:new s.bL(u),u_zoom_transition:new s.bM(u),u_up_dir:new s.bL(u)}),heatmapTexture:u=>({u_image:new s.bN(u),u_color_ramp:new s.bN(u),u_opacity:new s.bM(u)}),hillshade:u=>({u_matrix:new s.bJ(u),u_image:new s.bN(u),u_latrange:new s.bK(u),u_light:new s.bK(u),u_shadow:new s.cA(u),u_highlight:new s.cA(u),u_emissive_strength:new s.bM(u),u_accent:new s.cA(u)}),hillshadePrepare:u=>({u_matrix:new s.bJ(u),u_image:new s.bN(u),u_dimension:new s.bK(u),u_zoom:new s.bM(u)}),line:s.cU,linePattern:s.cV,raster:u=>({u_matrix:new s.bJ(u),u_normalize_matrix:new s.bJ(u),u_globe_matrix:new s.bJ(u),u_merc_matrix:new s.bJ(u),u_grid_matrix:new s.cB(u),u_tl_parent:new s.bK(u),u_scale_parent:new s.bM(u),u_fade_t:new s.bM(u),u_opacity:new s.bM(u),u_image0:new s.bN(u),u_image1:new s.bN(u),u_brightness_low:new s.bM(u),u_brightness_high:new s.bM(u),u_saturation_factor:new s.bM(u),u_contrast_factor:new s.bM(u),u_spin_weights:new s.bL(u),u_perspective_transform:new s.bK(u),u_raster_elevation:new s.bM(u),u_zoom_transition:new s.bM(u),u_merc_center:new s.bK(u),u_cutoff_params:new s.cb(u),u_colorization_mix:new s.cb(u),u_colorization_offset:new s.bM(u),u_color_ramp:new s.bN(u),u_texture_offset:new s.bK(u),u_texture_res:new s.bK(u),u_emissive_strength:new s.bM(u)}),rasterParticle:u=>({u_matrix:new s.bJ(u),u_normalize_matrix:new s.bJ(u),u_globe_matrix:new s.bJ(u),u_merc_matrix:new s.bJ(u),u_grid_matrix:new s.cB(u),u_tl_parent:new s.bK(u),u_scale_parent:new s.bM(u),u_fade_t:new s.bM(u),u_opacity:new s.bM(u),u_image0:new s.bN(u),u_image1:new s.bN(u),u_raster_elevation:new s.bM(u),u_zoom_transition:new s.bM(u),u_merc_center:new s.bK(u),u_cutoff_params:new s.cb(u)}),rasterParticleTexture:u=>({u_texture:new s.bN(u),u_opacity:new s.bM(u)}),rasterParticleDraw:u=>({u_particle_texture:new s.bN(u),u_particle_texture_side_len:new s.bM(u),u_tile_offset:new s.bK(u),u_velocity:new s.bN(u),u_color_ramp:new s.bN(u),u_velocity_res:new s.bK(u),u_max_speed:new s.bM(u),u_uv_offset:new s.bK(u),u_data_scale:new s.bK(u),u_data_offset:new s.bM(u),u_particle_pos_scale:new s.bM(u),u_particle_pos_offset:new s.bK(u)}),rasterParticleUpdate:u=>({u_particle_texture:new s.bN(u),u_particle_texture_side_len:new s.bM(u),u_velocity:new s.bN(u),u_velocity_res:new s.bK(u),u_max_speed:new s.bM(u),u_speed_factor:new s.bM(u),u_reset_rate:new s.bM(u),u_rand_seed:new s.bM(u),u_uv_offset:new s.bK(u),u_data_scale:new s.bK(u),u_data_offset:new s.bM(u),u_particle_pos_scale:new s.bM(u),u_particle_pos_offset:new s.bK(u)}),symbol:u=>({u_is_size_zoom_constant:new s.bN(u),u_is_size_feature_constant:new s.bN(u),u_size_t:new s.bM(u),u_size:new s.bM(u),u_camera_to_center_distance:new s.bM(u),u_rotate_symbol:new s.bN(u),u_aspect_ratio:new s.bM(u),u_fade_change:new s.bM(u),u_matrix:new s.bJ(u),u_label_plane_matrix:new s.bJ(u),u_coord_matrix:new s.bJ(u),u_is_text:new s.bN(u),u_elevation_from_sea:new s.bN(u),u_pitch_with_map:new s.bN(u),u_texsize:new s.bK(u),u_texsize_icon:new s.bK(u),u_texture:new s.bN(u),u_texture_icon:new s.bN(u),u_gamma_scale:new s.bM(u),u_device_pixel_ratio:new s.bM(u),u_tile_id:new s.bL(u),u_zoom_transition:new s.bM(u),u_inv_rot_matrix:new s.bJ(u),u_merc_center:new s.bK(u),u_camera_forward:new s.bL(u),u_tile_matrix:new s.bJ(u),u_up_vector:new s.bL(u),u_ecef_origin:new s.bL(u),u_is_halo:new s.bN(u),u_icon_transition:new s.bM(u),u_color_adj_mat:new s.bJ(u),u_scale_factor:new s.bM(u)}),background:u=>({u_matrix:new s.bJ(u),u_emissive_strength:new s.bM(u),u_opacity:new s.bM(u),u_color:new s.cA(u)}),backgroundPattern:u=>({u_matrix:new s.bJ(u),u_emissive_strength:new s.bM(u),u_opacity:new s.bM(u),u_image:new s.bN(u),u_pattern_tl:new s.bK(u),u_pattern_br:new s.bK(u),u_texsize:new s.bK(u),u_pattern_size:new s.bK(u),u_pixel_coord_upper:new s.bK(u),u_pixel_coord_lower:new s.bK(u),u_pattern_units_to_pixels:new s.bK(u)}),terrainRaster:u=>({u_matrix:new s.bJ(u),u_image0:new s.bN(u),u_skirt_height:new s.bM(u),u_ground_shadow_factor:new s.bL(u)}),skybox:u=>({u_matrix:new s.bJ(u),u_sun_direction:new s.bL(u),u_cubemap:new s.bN(u),u_opacity:new s.bM(u),u_temporal_offset:new s.bM(u)}),skyboxGradient:u=>({u_matrix:new s.bJ(u),u_color_ramp:new s.bN(u),u_center_direction:new s.bL(u),u_radius:new s.bM(u),u_opacity:new s.bM(u),u_temporal_offset:new s.bM(u)}),skyboxCapture:u=>({u_matrix_3f:new s.cB(u),u_sun_direction:new s.bL(u),u_sun_intensity:new s.bM(u),u_color_tint_r:new s.cb(u),u_color_tint_m:new s.cb(u),u_luminance:new s.bM(u)}),globeRaster:u=>({u_proj_matrix:new s.bJ(u),u_globe_matrix:new s.bJ(u),u_normalize_matrix:new s.bJ(u),u_merc_matrix:new s.bJ(u),u_zoom_transition:new s.bM(u),u_merc_center:new s.bK(u),u_image0:new s.bN(u),u_grid_matrix:new s.cB(u),u_skirt_height:new s.bM(u),u_far_z_cutoff:new s.bM(u),u_frustum_tl:new s.bL(u),u_frustum_tr:new s.bL(u),u_frustum_br:new s.bL(u),u_frustum_bl:new s.bL(u),u_globe_pos:new s.bL(u),u_globe_radius:new s.bM(u),u_viewport:new s.bK(u)}),globeAtmosphere:u=>({u_frustum_tl:new s.bL(u),u_frustum_tr:new s.bL(u),u_frustum_br:new s.bL(u),u_frustum_bl:new s.bL(u),u_horizon:new s.bM(u),u_transition:new s.bM(u),u_fadeout_range:new s.bM(u),u_color:new s.cb(u),u_high_color:new s.cb(u),u_space_color:new s.cb(u),u_temporal_offset:new s.bM(u),u_horizon_angle:new s.bM(u)}),model:u=>({u_matrix:new s.bJ(u),u_lighting_matrix:new s.bJ(u),u_normal_matrix:new s.bJ(u),u_node_matrix:new s.bJ(u),u_lightpos:new s.bL(u),u_lightintensity:new s.bM(u),u_lightcolor:new s.bL(u),u_camera_pos:new s.bL(u),u_opacity:new s.bM(u),u_baseColorFactor:new s.cb(u),u_emissiveFactor:new s.cb(u),u_metallicFactor:new s.bM(u),u_roughnessFactor:new s.bM(u),u_baseTextureIsAlpha:new s.bN(u),u_alphaMask:new s.bN(u),u_alphaCutoff:new s.bM(u),u_baseColorTexture:new s.bN(u),u_metallicRoughnessTexture:new s.bN(u),u_normalTexture:new s.bN(u),u_occlusionTexture:new s.bN(u),u_emissionTexture:new s.bN(u),u_lutTexture:new s.bN(u),u_color_mix:new s.cb(u),u_aoIntensity:new s.bM(u),u_emissive_strength:new s.bM(u),u_occlusionTextureTransform:new s.cb(u)}),modelDepth:u=>({u_matrix:new s.bJ(u),u_instance:new s.bJ(u),u_node_matrix:new s.bJ(u)}),groundShadow:u=>({u_matrix:new s.bJ(u),u_ground_shadow_factor:new s.bL(u)}),stars:u=>({u_matrix:new s.bJ(u),u_up:new s.bL(u),u_right:new s.bL(u),u_intensity_multiplier:new s.bM(u)}),snowParticle:u=>({u_modelview:new s.bJ(u),u_projection:new s.bJ(u),u_time:new s.bM(u),u_cam_pos:new s.bL(u),u_velocityConeAperture:new s.bM(u),u_velocity:new s.bM(u),u_horizontalOscillationRadius:new s.bM(u),u_horizontalOscillationRate:new s.bM(u),u_boxSize:new s.bM(u),u_billboardSize:new s.bM(u),u_simpleShapeParameters:new s.bK(u),u_screenSize:new s.bK(u),u_thinningCenterPos:new s.bK(u),u_thinningShape:new s.bL(u),u_thinningAffectedRatio:new s.bM(u),u_thinningParticleOffset:new s.bM(u),u_particleColor:new s.cb(u),u_direction:new s.bL(u)}),rainParticle:u=>({u_modelview:new s.bJ(u),u_projection:new s.bJ(u),u_time:new s.bM(u),u_cam_pos:new s.bL(u),u_texScreen:new s.bN(u),u_velocityConeAperture:new s.bM(u),u_velocity:new s.bM(u),u_boxSize:new s.bM(u),u_rainDropletSize:new s.bK(u),u_distortionStrength:new s.bM(u),u_rainDirection:new s.bL(u),u_color:new s.cb(u),u_screenSize:new s.bK(u),u_thinningCenterPos:new s.bK(u),u_thinningShape:new s.bL(u),u_thinningAffectedRatio:new s.bM(u),u_thinningParticleOffset:new s.bM(u),u_shapeDirectionalPower:new s.bM(u),u_shapeNormalPower:new s.bM(u),u_mode:new s.bM(u)}),vignette:u=>({u_vignetteShape:new s.bL(u),u_vignetteColor:new s.cb(u)}),occlusion:u=>({u_matrix:new s.bJ(u),u_anchorPos:new s.bL(u),u_screenSizePx:new s.bK(u),u_occluderSizePx:new s.bK(u),u_color:new s.cb(u)})};class Xs{constructor(t,r,c,d){this.id=Xs.uniqueIdxCounter,Xs.uniqueIdxCounter++,this.context=t;const m=t.gl;this.buffer=m.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),m.bufferData(m.ELEMENT_ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?m.DYNAMIC_DRAW:m.STATIC_DRAW),this.dynamicDraw||d||r.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=Xs.uniqueIdxCounter,Xs.uniqueIdxCounter++;const r=this.context.gl;this.context.unbindVAO(),this.bind(),r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Xs.uniqueIdxCounter=0;const hd={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class dd{constructor(t,r,c,d,m,g){this.length=r.length,this.attributes=c,this.itemSize=r.bytesPerElement,this.dynamicDraw=d,this.instanceCount=g,this.context=t;const E=t.gl;this.buffer=E.createBuffer(),t.bindVertexBuffer.set(this.buffer),E.bufferData(E.ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?E.DYNAMIC_DRAW:E.STATIC_DRAW),this.dynamicDraw||m||r.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const r=this.context.gl;this.bind(),r.bufferSubData(r.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,r){for(let c=0;c<this.attributes.length;c++){const d=r.attributes[this.attributes[c].name];d!==void 0&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,r,c){for(let d=0;d<this.attributes.length;d++){const m=this.attributes[d],g=r.attributes[m.name];g!==void 0&&t.vertexAttribPointer(g,m.components,t[hd[m.type]],!1,this.itemSize,m.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,r,c){for(let d=0;d<this.attributes.length;d++){const m=r.attributes[this.attributes[d].name];m!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(m,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Un{constructor(t,r,c,d,m){this.context=t,this.width=r,this.height=c;const g=this.framebuffer=t.gl.createFramebuffer();d&&(this.colorAttachment=new Xh(t,g)),m&&(this.depthAttachmentType=m,this.depthAttachment=m==="renderbuffer"?new Kh(t,g):new Ya(t,g))}destroy(){const t=this.context.gl;if(this.colorAttachment){const r=this.colorAttachment.get();r&&t.deleteTexture(r)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const r=this.depthAttachment.get();r&&t.deleteRenderbuffer(r)}else{const r=this.depthAttachment.get();r&&t.deleteTexture(r)}t.deleteFramebuffer(this.framebuffer)}}class Vo{constructor(t,r){this.gl=t,this.clearColor=new $_(this),this.clearDepth=new Nh(this),this.clearStencil=new Vh(this),this.colorMask=new Uh(this),this.depthMask=new jh(this),this.stencilMask=new up(this),this.stencilFunc=new hp(this),this.stencilOp=new H_(this),this.stencilTest=new tc(this),this.depthRange=new ic(this),this.depthTest=new dp(this),this.depthFunc=new ls(this),this.blend=new Gh(this),this.blendFunc=new cu(this),this.blendColor=new uu(this),this.blendEquation=new qh(this),this.cullFace=new $h(this),this.cullFaceSide=new Hh(this),this.frontFace=new hu(this),this.program=new Zh(this),this.activeTexture=new Wh(this),this.viewport=new du(this),this.bindFramebuffer=new fp(this),this.bindRenderbuffer=new pp(this),this.bindTexture=new Ka(this),this.bindVertexBuffer=new Z_(this),this.bindElementBuffer=new W_(this),this.bindVertexArrayOES=new X_(this),this.pixelStoreUnpack=new K_(this),this.pixelStoreUnpackPremultiplyAlpha=new Y_(this),this.pixelStoreUnpackFlipY=new J_(this),this.options=r?Object.assign({},r):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=r&&!!r.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,r,c){return new Xs(this,t,r,c)}createVertexBuffer(t,r,c,d,m){return new dd(this,t,r,c,d,m)}createRenderbuffer(t,r,c){const d=this.gl,m=d.createRenderbuffer();return this.bindRenderbuffer.set(m),d.renderbufferStorage(d.RENDERBUFFER,t,r,c),this.bindRenderbuffer.set(null),m}createFramebuffer(t,r,c,d){return new Un(this,t,r,c,d)}clear({color:t,depth:r,stencil:c,colorMask:d}){const m=this.gl;let g=0;t&&(g|=m.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set(d||[!0,!0,!0,!0])),r!==void 0&&(g|=m.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(r),this.depthMask.set(!0)),c!==void 0&&(g|=m.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),m.clear(g)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){s.bn(t.blendFunction,Si.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let oc;function Tu(u,t,r,c,d,m,g){const E=u.context,A=E.gl,C=u.transform,R=u.getOrCreateProgram("collisionBox"),L=[];let O=0,V=0;for(let se=0;se<c.length;se++){const fe=c[se],ce=t.getTile(fe),ue=ce.getBucket(r);if(!ue)continue;const he=Ph(fe,ue,C);let _e=he;d[0]===0&&d[1]===0||(_e=u.translatePosMatrix(he,ce,d,m));const xe=g?ue.textCollisionBox:ue.iconCollisionBox,Ue=ue.collisionCircleArray;if(Ue.length>0){const Le=s.ad.mat4.create(),Ye=_e;s.ad.mat4.mul(Le,ue.placementInvProjMatrix,C.glCoordMatrix),s.ad.mat4.mul(Le,Le,ue.placementViewportMatrix),L.push({circleArray:Ue,circleOffset:V,transform:Ye,invTransform:Le,projection:ue.getProjection()}),O+=Ue.length/4,V=O}xe&&(u.terrain&&u.terrain.setupElevationDraw(ce,R),R.draw(u,A.LINES,qt.disabled,li.disabled,u.colorModeForRenderPass(),ni.disabled,bp(_e,C,ce,ue.getProjection()),r.id,xe.layoutVertexBuffer,xe.indexBuffer,xe.segments,null,C.zoom,null,[xe.collisionVertexBuffer,xe.collisionVertexBufferExt]))}if(!g||!L.length)return;const H=u.getOrCreateProgram("collisionCircle"),G=new s.cW;G.resize(4*O),G._trim();let W=0;for(const se of L)for(let fe=0;fe<se.circleArray.length/4;fe++){const ce=4*fe,ue=se.circleArray[ce+0],he=se.circleArray[ce+1],_e=se.circleArray[ce+2],xe=se.circleArray[ce+3];G.emplace(W++,ue,he,_e,xe,0),G.emplace(W++,ue,he,_e,xe,1),G.emplace(W++,ue,he,_e,xe,2),G.emplace(W++,ue,he,_e,xe,3)}(!oc||oc.length<2*O)&&(oc=function(se){const fe=2*se,ce=new s.aV;ce.resize(fe),ce._trim();for(let ue=0;ue<fe;ue++){const he=6*ue;ce.uint16[he+0]=4*ue+0,ce.uint16[he+1]=4*ue+1,ce.uint16[he+2]=4*ue+2,ce.uint16[he+3]=4*ue+2,ce.uint16[he+4]=4*ue+3,ce.uint16[he+5]=4*ue+0}return ce}(O));const K=E.createIndexBuffer(oc,!0),ie=E.createVertexBuffer(G,s.cX.members,!0);for(const se of L){const fe={u_matrix:se.transform,u_inv_matrix:se.invTransform,u_camera_to_center_distance:(oe=C).getCameraToCenterDistance(se.projection),u_viewport_size:[oe.width,oe.height]};H.draw(u,A.TRIANGLES,qt.disabled,li.disabled,u.colorModeForRenderPass(),ni.disabled,fe,r.id,ie,K,s.b8.simpleSegment(0,2*se.circleOffset,se.circleArray.length,se.circleArray.length/2),null,C.zoom)}var oe;ie.destroy(),K.destroy()}const il=s.ad.mat4.create();function Su(u){const t=u._camera.getWorldToCamera(u.worldSize,1),r=s.ad.mat4.multiply([],t,u.globeMatrix);s.ad.mat4.invert(r,r);const c=[0,0,0],d=[0,1,0,0];return s.ad.vec4.transformMat4(d,d,r),c[0]=d[0],c[1]=d[1],c[2]=d[2],s.ad.vec3.normalize(c,c),c}function Mp({width:u,height:t,anchor:r,textOffset:c,textScale:d},m){const{horizontalAlign:g,verticalAlign:E}=s.bD(r),A=-(g-.5)*u,C=-(E-.5)*t,R=s.bC(r,c);return new s.P((A/d+R[0])*m,(C/d+R[1])*m)}function Ts(u,t,r,c,d,m,g,E,A,C,R){const L=u.text.placedSymbolArray,O=u.text.dynamicLayoutVertexArray,V=u.icon.dynamicLayoutVertexArray,H={},G=u.getProjection(),W=as(E,G,m),K=m.elevation,ie=G.upVectorScale(E.canonical,m.center.lat,m.worldSize).metersToTile;O.clear();for(let oe=0;oe<L.length;oe++){const se=L.get(oe),{tileAnchorX:fe,tileAnchorY:ce,numGlyphs:ue}=se,he=se.hidden||!se.crossTileID||u.allowVerticalPlacement&&!se.placedOrientation?null:c[se.crossTileID];if(he){let _e=0,xe=0,Ue=0;if(K){const He=K?K.getAtTileOffset(E,fe,ce):0,[Qe,je,it]=G.upVector(E.canonical,fe,ce);_e=He*Qe*ie,xe=He*je*ie,Ue=He*it*ie}let[Le,Ye,Je,at]=Os(se.projectedAnchorX+_e,se.projectedAnchorY+xe,se.projectedAnchorZ+Ue,r?W:g);const De=Ba(m.getCameraToCenterDistance(G),at);let Ke=d.evaluateSizeForFeature(u.textSizeData,C,se)*De/s.bw;r&&(Ke*=u.tilePixelRatio/A);const Ie=Mp(he,Ke);r?({x:Le,y:Ye,z:Je}=G.projectTilePoint(fe+Ie.x,ce+Ie.y,E.canonical),[Le,Ye,Je]=Os(Le+_e,Ye+xe,Je+Ue,g)):(t&&Ie._rotate(-m.angle),Le+=Ie.x,Ye+=Ie.y,Je=0);const Xe=u.allowVerticalPlacement&&se.placedOrientation===s.bq.vertical?Math.PI/2:0;for(let He=0;He<ue;He++)s.bt(O,Le,Ye,Je,Xe);R&&se.associatedIconIndex>=0&&(H[se.associatedIconIndex]={x:Le,y:Ye,z:Je,angle:Xe})}else ks(ue,O)}if(R){V.clear();const oe=u.icon.placedSymbolArray;for(let se=0;se<oe.length;se++){const fe=oe.get(se),{numGlyphs:ce}=fe,ue=H[se];if(fe.hidden||!ue)ks(ce,V);else{const{x:he,y:_e,z:xe,angle:Ue}=ue;for(let Le=0;Le<ce;Le++)s.bt(V,he,_e,xe,Ue)}}u.icon.dynamicLayoutVertexBuffer.updateData(V)}u.text.dynamicLayoutVertexBuffer.updateData(O)}function ur(u,t,r,c,d,m,g={}){const E=r.paint.get("icon-translate"),A=r.paint.get("text-translate"),C=r.paint.get("icon-translate-anchor"),R=r.paint.get("text-translate-anchor"),L=r.layout.get("icon-rotation-alignment"),O=r.layout.get("text-rotation-alignment"),V=r.layout.get("icon-pitch-alignment"),H=r.layout.get("text-pitch-alignment"),G=r.layout.get("icon-keep-upright"),W=r.layout.get("text-keep-upright"),K=r.paint.get("icon-color-saturation"),ie=r.paint.get("icon-color-contrast"),oe=r.paint.get("icon-color-brightness-min"),se=r.paint.get("icon-color-brightness-max"),fe=r.layout.get("symbol-elevation-reference")==="sea",ce=u.context,ue=ce.gl,he=u.transform,_e=L==="map",xe=O==="map",Ue=V==="map",Le=H==="map",Ye=r.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Je=!1;const at=u.depthModeForSublayer(0,qt.ReadOnly),De=[s.av(he.center.lng),s.aC(he.center.lat)],Ke=r.layout.get("text-variable-anchor"),Ie=he.projection.name==="globe",Xe=[],He=[0,-1,0];for(const Qe of c){const je=t.getTile(Qe),it=je.getBucket(r);if(!it||it.projection.name==="mercator"&&Ie||it.fullyClipped)continue;const _t=it.projection.name==="globe",yt=_t?s.ag(he.zoom):0,wt=as(Qe,it.getProjection(),he),Ot=he.calculatePixelsToTileUnitsMatrix(je),si=Ke&&it.hasTextData(),Wt=it.hasIconTextFit()&&si&&it.hasIconData(),ii=it.getProjection().createInversionMatrix(he,Qe.canonical),Yt=ir=>{he.depthOcclusionForSymbolsAndCircles&&(r.hasInitialOcclusionOpacityProperties||u.terrain)&&(ir.push("DEPTH_D24"),ir.push("DEPTH_OCCLUSION"))},Ii=()=>{const ir=_e&&r.layout.get("symbol-placement")!=="point",Bi=[];Yt(Bi);const Rr=ir||Wt,$r=r.paint.get("icon-image-cross-fade").constantOr(0);u.terrainRenderModeElevated()&&Ue&&Bi.push("PITCH_WITH_MAP_TERRAIN"),_t&&(Bi.push("PROJECTION_GLOBE_VIEW"),Rr&&Bi.push("PROJECTED_POS_ON_VIEWPORT")),$r>0&&Bi.push("ICON_TRANSITION"),it.icon.zOffsetVertexBuffer&&Bi.push("Z_OFFSET"),K===0&&ie===0&&oe===0&&se===1||Bi.push("COLOR_ADJUSTMENT"),it.sdfIcons&&Bi.push("RENDER_SDF");const tn=it.icon.programConfigurations.get(r.id),nn=u.getOrCreateProgram("symbol",{config:tn,defines:Bi}),ds=je.imageAtlasTexture?je.imageAtlasTexture.size:[0,0],Pn=it.iconSizeData,Li=s.bp(Pn,he.zoom),Er=Ue||he.pitch!==0,Xi=ao(wt,je.tileID.canonical,Ue,_e,he,it.getProjection(),Ot),lr=Nr(wt,je.tileID.canonical,Ue,_e,he,it.getProjection(),Ot),pn=u.translatePosMatrix(lr,je,E,C,!0),yr=u.translatePosMatrix(wt,je,E,C),rn=Rr?il:Xi,Js=_e&&!Ue&&!ir;let Yn=He;!Ie&&!he.mercatorFromTransition||_e||(Yn=Su(he));const Ms=_t?Yn:He,Gn=r.getColorAdjustmentMatrix(K,ie,oe,se),As=bu(Pn.kind,Li,Js,Ue,u,yr,rn,pn,fe,!1,ds,[0,0],!0,Qe,yt,De,ii,Ms,it.getProjection(),Gn,$r),Jn=je.imageAtlasTexture?je.imageAtlasTexture:null,bo=r.layout.get("icon-size").constantOr(0)!==1||it.iconsNeedLinear,Qs=it.sdfIcons||u.options.rotating||u.options.zooming||bo||Er?ue.LINEAR:ue.NEAREST,wo=it.sdfIcons&&r.paint.get("icon-halo-width").constantOr(1)!==0,Bd=u.terrain&&Ue&&ir?s.ad.mat4.invert(s.ad.mat4.create(),Xi):il;if(ir&&it.icon){const _l=he.elevation,ju=_l?_l.getAtTileOffsetFunc(Qe,he.center.lat,he.worldSize,it.getProjection()):null,Nd=vn(wt,je.tileID.canonical,Ue,_e,he,it.getProjection(),Ot);Na(it,wt,u,!1,Nd,lr,Ue,G,ju,Qe)}return{program:nn,buffers:it.icon,uniformValues:As,atlasTexture:Jn,atlasTextureIcon:null,atlasInterpolation:Qs,atlasInterpolationIcon:null,isSDF:it.sdfIcons,hasHalo:wo,tile:je,labelPlaneMatrixInv:Bd}},Wi=()=>{const ir=xe&&r.layout.get("symbol-placement")!=="point",Bi=[],Rr=ir||Ke||Wt;u.terrainRenderModeElevated()&&Le&&Bi.push("PITCH_WITH_MAP_TERRAIN"),_t&&(Bi.push("PROJECTION_GLOBE_VIEW"),Rr&&Bi.push("PROJECTED_POS_ON_VIEWPORT")),it.text.zOffsetVertexBuffer&&Bi.push("Z_OFFSET"),it.iconsInText&&Bi.push("RENDER_TEXT_AND_SYMBOL"),Bi.push("RENDER_SDF"),Yt(Bi);const $r=it.text.programConfigurations.get(r.id),tn=u.getOrCreateProgram("symbol",{config:$r,defines:Bi});let nn,ds=[0,0],Pn=null;const Li=it.textSizeData;it.iconsInText&&(ds=je.imageAtlasTexture?je.imageAtlasTexture.size:[0,0],Pn=je.imageAtlasTexture?je.imageAtlasTexture:null,nn=Le||he.pitch!==0||u.options.rotating||u.options.zooming||Li.kind==="composite"||Li.kind==="camera"?ue.LINEAR:ue.NEAREST);const Er=je.glyphAtlasTexture?je.glyphAtlasTexture.size:[0,0],Xi=r.layout.get("text-size-scale-range"),lr=s.ay(u.scaleFactor,Xi[0],Xi[1]),pn=s.bp(Li,he.zoom,lr),yr=ao(wt,je.tileID.canonical,Le,xe,he,it.getProjection(),Ot),rn=Nr(wt,je.tileID.canonical,Le,xe,he,it.getProjection(),Ot),Js=u.translatePosMatrix(rn,je,A,R,!0),Yn=u.translatePosMatrix(wt,je,A,R),Ms=Rr?il:yr,Gn=xe&&!Le&&!ir;let As=He;!Ie&&!he.mercatorFromTransition||xe||(As=Su(he));const Jn=bu(Li.kind,pn,Gn,Le,u,Yn,Ms,Js,fe,!0,Er,ds,!0,Qe,yt,De,ii,_t?As:He,it.getProjection(),null,null,lr),bo=je.glyphAtlasTexture?je.glyphAtlasTexture:null,Qs=ue.LINEAR,wo=r.paint.get("text-halo-width").constantOr(1)!==0,Bd=u.terrain&&Le&&ir?s.ad.mat4.invert(s.ad.mat4.create(),yr):il;if(ir&&it.text){const _l=he.elevation,ju=_l?_l.getAtTileOffsetFunc(Qe,he.center.lat,he.worldSize,it.getProjection()):null,Nd=vn(wt,je.tileID.canonical,Le,xe,he,it.getProjection(),Ot);Na(it,wt,u,!0,Nd,rn,Le,W,ju,Qe)}return{program:tn,buffers:it.text,uniformValues:Jn,atlasTexture:bo,atlasTextureIcon:Pn,atlasInterpolation:Qs,atlasInterpolationIcon:nn,isSDF:!0,hasHalo:wo,tile:je,labelPlaneMatrixInv:Bd}},dr=it.icon.segments.get().length,wi=it.text.segments.get().length,Sr=dr&&!g.onlyText?Ii():null,ci=wi&&!g.onlyIcons?Wi():null,kt=r.paint.get("icon-opacity").constantOr(1),Ri=r.paint.get("text-opacity").constantOr(1);if(Ye&&it.canOverlap){Je=!0;const ir=kt&&!g.onlyText?it.icon.segments.get():[],Bi=Ri&&!g.onlyIcons?it.text.segments.get():[];for(const Rr of ir)Xe.push({segments:new s.b8([Rr]),sortKey:Rr.sortKey,state:Sr});for(const Rr of Bi)Xe.push({segments:new s.b8([Rr]),sortKey:Rr.sortKey,state:ci})}else g.onlyText||Xe.push({segments:kt?it.icon.segments:new s.b8([]),sortKey:0,state:Sr}),g.onlyIcons||Xe.push({segments:Ri?it.text.segments:new s.b8([]),sortKey:0,state:ci})}Je&&Xe.sort((Qe,je)=>Qe.sortKey-je.sortKey);for(const Qe of Xe){const je=Qe.state;if(je)if(u.terrain?u.terrain.setupElevationDraw(je.tile,je.program,{useDepthForOcclusion:he.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:je.labelPlaneMatrixInv}):u.setupDepthForOcclusion(he.depthOcclusionForSymbolsAndCircles,je.program),ce.activeTexture.set(ue.TEXTURE0),je.atlasTexture&&je.atlasTexture.bind(je.atlasInterpolation,ue.CLAMP_TO_EDGE,!0),je.atlasTextureIcon&&(ce.activeTexture.set(ue.TEXTURE1),je.atlasTextureIcon&&je.atlasTextureIcon.bind(je.atlasInterpolationIcon,ue.CLAMP_TO_EDGE,!0)),u.uploadCommonLightUniforms(u.context,je.program),je.hasHalo){const it=je.uniformValues;it.u_is_halo=1,rl(je.buffers,Qe.segments,r,u,je.program,at,d,m,it,2),it.u_is_halo=0}else{if(je.isSDF){const it=je.uniformValues;je.hasHalo&&(it.u_is_halo=1,rl(je.buffers,Qe.segments,r,u,je.program,at,d,m,it,1)),it.u_is_halo=0}rl(je.buffers,Qe.segments,r,u,je.program,at,d,m,je.uniformValues,1)}}}function rl(u,t,r,c,d,m,g,E,A,C){const R=[u.dynamicLayoutVertexBuffer,u.opacityVertexBuffer,u.iconTransitioningVertexBuffer,u.globeExtVertexBuffer,u.zOffsetVertexBuffer];d.draw(c,c.context.gl.TRIANGLES,m,g,E,ni.disabled,A,r.id,u.layoutVertexBuffer,u.indexBuffer,t,r.paint,c.transform.zoom,u.programConfigurations.get(r.id),R,C)}function fd(u,t){const r=1<<u.canonical.z,c=(t.x*r-u.canonical.x-u.wrap*r)*s.ai,d=(t.y*r-u.canonical.y)*s.ai,m=s.d5(t.z,t.y);return s.ad.vec3.fromValues(c,d,m)}function pd(u,t,r,c,d){if(!r.layout||r.layout.get("fill-elevation-reference")==="none")return;const m=u.context.gl,g=new qt(u.context.gl.LEQUAL,qt.ReadWrite,u.depthRangeFor3D),E=new qt(u.context.gl.GREATER,qt.ReadWrite,u.depthRangeFor3D),A=function(V){const H=s.c4(V.pitch);let G=.01;return V.isOrthographic&&(G=s.ah(1e-4,G,s.c9(H>=ht?1:H/ht))),2*G}(u.transform),C=u.transform.getFreeCameraOptions().position,R="elevatedStructuresDepthReconstruct",L=u.getOrCreateProgram(R,{defines:["DEPTH_RECONSTRUCTION"]}),O=u.getOrCreateProgram(R);for(const V of c){const H=t.getTile(V),G=H.getBucket(r);if(!G)continue;const W=G.elevatedStructures;if(!W)continue;const K=G.elevationBufferData.heightRange,ie=fd(V.toUnwrapped(),C),oe=u.translatePosMatrix(V.projMatrix,H,r.paint.get("fill-translate"),r.paint.get("fill-translate-anchor"));let se,fe,ce,ue;if(d==="initialize"){if(!K||K.min>=1||W.depthSegments.segments[0].primitiveLength===0)continue;se=sc(oe,ie,A,1,0),fe=g,ce=W.depthSegments,ue=L}else if(d==="reset"){if(!K||K.min>=0||W.maskSegments.segments[0].primitiveLength===0)continue;se=sc(oe,ie,0,0,1),fe=E,ce=W.maskSegments,ue=L}else if(d==="geometry"){if(W.depthSegments.segments[0].primitiveLength===0)continue;se=sc(oe,ie,A,1,0),fe=g,ce=W.depthSegments,ue=O}ue.draw(u,m.TRIANGLES,fe,li.disabled,Si.disabled,ni.disabled,se,r.id,W.vertexBuffer,W.indexBuffer,ce,r.paint,u.transform.zoom)}}function Eu(u,t,r){const{painter:c,sourceCache:d,layer:m,coords:g,colorMode:E,elevationType:A,terrainEnabled:C,pass:R}=u,L=c.context.gl,O=m.paint.get("fill-pattern");let V=A;A!=="road"||t&&!C||(V="none");const H=V==="road",G=new qt(c.context.gl.LEQUAL,qt.ReadWrite,c.depthRangeFor3D),W=O&&O.constantOr(1),K=(ie,oe)=>{let se,fe,ce,ue,he;oe?(fe=W&&!m.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",se=L.LINES):(fe=W?"fillPattern":"fill",se=L.TRIANGLES);for(const _e of g){const xe=d.getTile(_e);if(W&&!xe.patternsLoaded())continue;const Ue=xe.getBucket(m);if(!Ue)continue;const Le=t?Ue.elevationBufferData:Ue.bufferData;if(Le.isEmpty())continue;c.prepareDrawTile();const Ye=Le.programConfigurations.get(m.id),Je=c.isTileAffectedByFog(_e),at=[],De=[];H&&(at.push("ELEVATED_ROADS"),De.push(Le.elevatedLayoutVertexBuffer));const Ke=c.getOrCreateProgram(fe,{config:Ye,overrideFog:Je,defines:at});W&&(c.context.activeTexture.set(L.TEXTURE0),xe.imageAtlasTexture&&xe.imageAtlasTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),Ye.updatePaintBuffers());const Ie=O.constantOr(null);if(Ie&&xe.imageAtlas){const Qe=xe.imageAtlas,je=s.d0.from(Ie).getPrimary().scaleSelf(s.q.devicePixelRatio).toString(),it=Qe.patternPositions.get(je);it&&Ye.setConstantPatternPositions(it)}const Xe=c.translatePosMatrix(_e.projMatrix,xe,m.paint.get("fill-translate"),m.paint.get("fill-translate-anchor")),He=m.paint.get("fill-emissive-strength");if(oe){ue=Le.lineIndexBuffer,he=Le.lineSegments;const Qe=c.terrain&&c.terrain.renderingToTexture?c.terrain.drapeBufferSize:[L.drawingBufferWidth,L.drawingBufferHeight];ce=fe==="fillOutlinePattern"&&W?vu(Xe,He,c,xe,Qe):yu(Xe,He,Qe)}else ue=Le.indexBuffer,he=Le.triangleSegments,ce=W?nd(Xe,He,c,xe):el(Xe,He);c.uploadCommonUniforms(c.context,Ke,_e.toUnwrapped()),Ke.draw(c,se,V!=="none"?G:ie,r||c.stencilModeForClipping(_e),E,ni.disabled,ce,m.id,Le.layoutVertexBuffer,ue,he,m.paint,c.transform.zoom,Ye,De)}};c.renderPass===R&&K(c.depthModeForSublayer(1,c.renderPass==="opaque"?qt.ReadWrite:qt.ReadOnly),!1),V==="none"&&c.renderPass==="translucent"&&m.paint.get("fill-antialias")&&K(c.depthModeForSublayer(m.getPaintProperty("fill-outline-color")?2:0,qt.ReadOnly),!0)}function ac(u,t,r,c,d,m,g,E){r.resetLayerRenderingStats(u);const A=u.context,C=A.gl,R=u.transform,L=r.paint.get("fill-extrusion-pattern"),O=L.constantOr(1),V=r.paint.get("fill-extrusion-opacity"),H=u.style.enable3dLights(),G=r.paint.get(H&&!O?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),W=[r.paint.get("fill-extrusion-ambient-occlusion-intensity"),G],K=r.layout.get("fill-extrusion-edge-radius"),ie=K>0&&!r.paint.get("fill-extrusion-rounded-roof"),oe=ie?0:K,se=R.projection.name==="globe"?s.d6():0,fe=R.projection.name==="globe",ce=fe?s.ag(R.zoom):0,ue=[s.av(R.center.lng),s.aC(R.center.lat)],he=r.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",_e=r.paint.get("fill-extrusion-flood-light-color").toRenderColor(he?null:r.lut).toArray01().slice(0,3),xe=r.paint.get("fill-extrusion-flood-light-intensity"),Ue=r.paint.get("fill-extrusion-vertical-scale"),Le=r.paint.get("fill-extrusion-line-width").constantOr(1)!==0,Ye=r.paint.get("fill-extrusion-height-alignment"),Je=r.paint.get("fill-extrusion-base-alignment"),at=fo(u,r.paint.get("fill-extrusion-cutoff-fade-range")),De=[];let Ke;fe&&De.push("PROJECTION_GLOBE_VIEW"),W[0]>0&&De.push("FAUX_AO"),ie&&De.push("ZERO_ROOF_RADIUS"),E&&De.push("HAS_CENTROID"),xe>0&&De.push("FLOOD_LIGHT"),at.shouldRenderCutoff&&De.push("RENDER_CUTOFF"),Le&&De.push("RENDER_WALL_MODE");const Ie=u.renderPass==="shadow",Xe=u.shadowRenderer,He=Ie&&!!Xe;u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!0);let Qe=[0,0,0];if(Xe){const _t=u.style.directionalLight,yt=u.style.ambientLight;_t&&yt&&(Qe=$a(u.style,_t,yt)),Ie||(De.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Xe.useNormalOffset&&De.push("NORMAL_OFFSET")),Ke=De.concat(["SHADOWS_SINGLE_CASCADE"])}const je=He?"fillExtrusionDepth":O?"fillExtrusionPattern":"fillExtrusion",it=r.getLayerRenderingStats();for(const _t of c){const yt=t.getTile(_t),wt=yt.getBucket(r);if(!wt||wt.projection.name!==R.projection.name)continue;let Ot=!1;Xe&&(Ot=Xe.getMaxCascadeForTile(_t.toUnwrapped())===0);const si=u.isTileAffectedByFog(_t),Wt=wt.programConfigurations.get(r.id),ii=u.getOrCreateProgram(je,{config:Wt,defines:Ot?Ke:De,overrideFog:si});if(u.terrain&&u.terrain.setupElevationDraw(yt,ii,{useMeterToDem:!0}),!wt.centroidVertexBuffer){const ci=ii.attributes.a_centroid_pos;ci!==void 0&&C.vertexAttrib2f(ci,0,0)}!Ie&&Xe&&Xe.setupShadows(yt.tileID.toUnwrapped(),ii,"vector-tile",yt.tileID.overscaledZ),O&&(u.context.activeTexture.set(C.TEXTURE0),yt.imageAtlasTexture&&yt.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),Wt.updatePaintBuffers());const Yt=L.constantOr(null);if(Yt&&yt.imageAtlas){const ci=yt.imageAtlas,kt=s.d0.from(Yt).getPrimary().scaleSelf(s.q.devicePixelRatio),Ri=ci.patternPositions.get(kt.toString());Ri&&Wt.setConstantPatternPositions(Ri)}const Ii=r.paint.get("fill-extrusion-vertical-gradient"),Wi=1/wt.tileToMeter;let dr;if(Ie&&Xe){if(al(yt.tileID,wt,u))continue;const ci=Xe.calculateShadowPassMatrixFromTile(yt.tileID.toUnwrapped());dr=Qa(ci,oe,Wi,Ue,Ye,Je)}else{const ci=u.translatePosMatrix(_t.expandedProjMatrix,yt,r.paint.get("fill-extrusion-translate"),r.paint.get("fill-extrusion-translate-anchor")),kt=R.projection.createInversionMatrix(R,_t.canonical);dr=O?rd(ci,u,Ii,V,W,oe,Wi,_t,yt,se,Ye,Je,ce,ue,kt,_e,Ue):gu(ci,u,Ii,V,W,oe,Wi,_t,se,Ye,Je,ce,ue,kt,_e,Ue,xe,Qe)}u.uploadCommonUniforms(A,ii,_t.toUnwrapped(),null,at);let wi=wt.segments;if(R.projection.name==="mercator"&&!Ie&&(wi=wt.getVisibleSegments(yt.tileID,u.terrain,u.transform.getFrustum(0)),!wi.get().length))continue;if(it)if(Ie)for(const ci of wi.get())it.numRenderedVerticesInShadowPass+=ci.primitiveLength;else for(const ci of wi.get())it.numRenderedVerticesInTransparentPass+=ci.primitiveLength;const Sr=[];(u.terrain||E)&&Sr.push(wt.centroidVertexBuffer),fe&&Sr.push(wt.layoutVertexExtBuffer),Le&&Sr.push(wt.wallVertexBuffer),ii.draw(u,A.gl.TRIANGLES,d,m,g,ni.backCCW,dr,r.id,wt.layoutVertexBuffer,wt.indexBuffer,wi,r.paint,u.transform.zoom,Wt,Sr)}u.shadowRenderer&&(u.shadowRenderer.useNormalOffset=!1)}function nl(u,t,r,c,d,m,g,E,A,C,R,L,O,V,H,G,W,K,ie){const oe=u.context,se=oe.gl,fe=u.transform,ce=u.transform.zoom,ue=[],he=fo(u,r.paint.get("fill-extrusion-cutoff-fade-range"));C==="clear"?(ue.push("CLEAR_SUBPASS"),ie&&(ue.push("CLEAR_FROM_TEXTURE"),oe.activeTexture.set(se.TEXTURE0),ie.bind(se.LINEAR,se.CLAMP_TO_EDGE))):C==="sdf"&&ue.push("SDF_SUBPASS"),W&&ue.push("HAS_CENTROID"),he.shouldRenderCutoff&&ue.push("RENDER_CUTOFF");const _e=r.layout.get("fill-extrusion-edge-radius"),xe=(Ue,Le,Ye,Je,at)=>{const De=Le.programConfigurations.get(r.id),Ke=u.isTileAffectedByFog(Ue),Ie=u.getOrCreateProgram("fillExtrusionGroundEffect",{config:De,defines:ue,overrideFog:Ke}),Xe=((Qe,je,it,_t,yt,wt,Ot,si,Wt,ii,Yt)=>({u_matrix:je,u_opacity:it,u_ao_pass:_t?1:0,u_meter_to_tile:yt,u_ao:wt,u_flood_light_intensity:Ot,u_flood_light_color:si,u_attenuation:Wt,u_edge_radius:ii,u_fb:0,u_fb_size:Yt,u_dynamic_offset:1}))(0,Je,R,A,at,[L,O*at],V,H,G,ce>=17?0:_e*at,ie?ie.size[0]:0),He=[];W&&He.push(Le.hiddenByLandmarkVertexBuffer),u.uploadCommonUniforms(oe,Ie,Ue.toUnwrapped(),null,he),Ie.draw(u,oe.gl.TRIANGLES,d,m,g,E,Xe,r.id,Le.vertexBuffer,Le.indexBuffer,Ye,r.paint,ce,De,He)};for(const Ue of c){const Le=t.getTile(Ue),Ye=Le.getBucket(r);if(!Ye||Ye.projection.name!==fe.projection.name||!Ye.groundEffect||Ye.groundEffect&&!Ye.groundEffect.hasData())continue;const Je=Ye.groundEffect,at=1/Ye.tileToMeter;{const De=u.translatePosMatrix(Ue.projMatrix,Le,r.paint.get("fill-extrusion-translate"),r.paint.get("fill-extrusion-translate-anchor")),Ke=Je.getDefaultSegment();xe(Ue,Je,Ke,De,at)}if(K)for(let De=0;De<4;De++){const Ke=s.d7[De](Ue),Ie=t.getTile(Ke);if(!Ie)continue;const Xe=Ie.getBucket(r);if(!Xe||Xe.projection.name!==fe.projection.name||!Xe.groundEffect||Xe.groundEffect&&!Xe.groundEffect.hasData())continue;const He=Xe.groundEffect;let Qe,je;De===0?(Qe=[-s.ai,0,0],je=1):De===1?(Qe=[s.ai,0,0],je=0):De===2?(Qe=[0,-s.ai,0],je=3):(Qe=[0,s.ai,0],je=2);const it=He.regionSegments[je];if(!it)continue;const _t=new Float32Array(16);s.ad.mat4.translate(_t,Ue.projMatrix,Qe),xe(Ue,He,it,u.translatePosMatrix(_t,Le,r.paint.get("fill-extrusion-translate"),r.paint.get("fill-extrusion-translate-anchor")),at)}}}function sl(u,t,r,c,d,m,g){c.centroidVertexArray.length===0&&c.createCentroidsBuffer();const E=m?m.findDEMTileFor(r):null;if(!(E&&E.dem||g))return;m&&E&&E.dem&&c.selfDEMTileTimestamp!==E.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=E.dem._timestamp);const A=K=>new s.P(Math.ceil((K+s.da)*s.db),0),C=K=>{const ie=t.getSource().minzoom,oe=fe=>{const ce=t.getTileByID(fe);if(ce&&ce.hasData())return ce.getBucket(d)},se=[0,-1,1];for(const fe of se){if(K.overscaledZ+fe<ie)continue;const ce=oe(K.calculateScaledKey(K.overscaledZ+fe));if(ce)return ce}},R=[0,0,0],L=(K,ie)=>(R[0]=Math.min(K.min.y,ie.min.y),R[1]=Math.max(K.max.y,ie.max.y),R[2]=s.ai-ie.min.x>K.max.x?ie.min.x-s.ai:K.max.x,R),O=(K,ie)=>(R[0]=Math.min(K.min.x,ie.min.x),R[1]=Math.max(K.max.x,ie.max.x),R[2]=s.ai-ie.min.y>K.max.y?ie.min.y-s.ai:K.max.y,R),V=[(K,ie)=>L(K,ie),(K,ie)=>L(ie,K),(K,ie)=>O(K,ie),(K,ie)=>O(ie,K)],H=(K,ie,oe,se,fe,ce,ue)=>{if(!m)return 0;const he=[[ce?oe:K,ce?K:oe,0],[ce?oe:ie,ce?ie:oe,0]],_e=ue<0?s.ai+ue:ue,xe=[ce?_e:(K+ie)/2,ce?(K+ie)/2:_e,0];return oe===0&&ue<0||oe!==0&&ue>0?m.getForTilePoints(fe,[xe],!0,se):he.push(xe),m.getForTilePoints(r,he,!0,E),Math.max(he[0][2],he[1][2],xe[2])/m.exaggeration()};for(let K=0;K<4;K++){const ie=c.borderFeatureIndices[K];if(ie.length===0)continue;const oe=s.d7[K](r),se=C(oe);if(!(se&&se instanceof s.d8))continue;const fe=m?m.findDEMTileFor(oe):null;if(!(fe&&fe.dem||g)||(m&&fe&&fe.dem&&c.borderDEMTileTimestamp[K]!==fe.dem._timestamp&&(c.borderDoneWithNeighborZ[K]=-1,c.borderDEMTileTimestamp[K]=fe.dem._timestamp),c.borderDoneWithNeighborZ[K]===se.canonical.z))continue;se.centroidVertexArray.length===0&&se.createCentroidsBuffer();const ce=(K<2?1:5)-K,ue=se.borderDoneWithNeighborZ[ce]!==c.canonical.z,he=se.borderFeatureIndices[ce];let _e=0;if(c.canonical.z!==se.canonical.z){for(const xe of ie)c.showCentroid(c.featuresOnBorder[xe]);if(ue)for(const xe of he)se.showCentroid(se.featuresOnBorder[xe]);c.borderDoneWithNeighborZ[K]=se.canonical.z,se.borderDoneWithNeighborZ[ce]=c.canonical.z}for(const xe of ie){const Ue=c.featuresOnBorder[xe],Le=c.centroidData[Ue.centroidDataIndex],Ye=Ue.borders[K];let Je;for(;_e<he.length;){Je=se.featuresOnBorder[he[_e]];const at=Je.borders[ce];if(at[1]>Ye[0]+3||at[0]>Ye[0]-3)break;se.showCentroid(Je),_e++}if(Je&&_e<he.length){const at=_e;let De=0;for(;!(Je.borders[ce][0]>Ye[1]-3)&&(De++,++_e!==he.length);)Je=se.featuresOnBorder[he[_e]];Je=se.featuresOnBorder[he[at]];let Ke=!1;if(De>=1){const He=Je.borders[ce];Math.abs(Ye[0]-He[0])<3&&Math.abs(Ye[1]-He[1])<3&&(De=1,Ke=!0,_e=at+1)}else if(De===0){c.showCentroid(Ue);continue}const Ie=se.centroidData[Je.centroidDataIndex];g&&Ke&&(((G=Le).flags|(W=Ie).flags)&s.d9?(G.flags|=s.d9,W.flags|=s.d9):(G.flags&=~s.d9,W.flags&=~s.d9));const Xe=Ue.intersectsCount()>1||Je.intersectsCount()>1;if(De>1)_e=at,Le.centroidXY=Ie.centroidXY=new s.P(0,0);else if(fe&&fe.dem&&!Xe){const He=V[K](Le,Ie),Qe=K%2?s.ai-1:0,je=H(He[0],Math.min(s.ai-1,He[1]),Qe,fe,oe,K<2,He[2]);Le.centroidXY=Ie.centroidXY=A(je)}else Xe?Le.centroidXY=Ie.centroidXY=new s.P(0,0):(Le.centroidXY=c.encodeBorderCentroid(Ue),Ie.centroidXY=se.encodeBorderCentroid(Je));c.writeCentroidToBuffer(Le),se.writeCentroidToBuffer(Ie)}else c.showCentroid(Ue)}c.borderDoneWithNeighborZ[K]=se.canonical.z,se.borderDoneWithNeighborZ[ce]=c.canonical.z}var G,W;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&c.centroidVertexArray.length!==0)&&c.uploadCentroid(u)}const ol=[1,0,0],ct=[0,1,0],At=[0,0,1];function al(u,t,r){const c=r.transform,d=r.shadowRenderer;if(!d)return!0;const m=u.toUnwrapped(),g=c.tileSize*d._cascades[r.currentShadowCascade].scale;let E=t.maxHeight;if(c.elevation){const G=c.elevation.getMinMaxForTile(u);G&&(E+=G.max)}const A=[...d.shadowDirection];A[2]=-A[2];const C=d.computeSimplifiedTileShadowVolume(m,E,g,A);if(!C)return!1;const R=[ol,ct,At,A,[A[0],0,A[2]],[0,A[1],A[2]]],L=c.projection.name==="globe",O=c.scaleZoom(g),V=s.bR.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,O,!L),H=d.getCurrentCascadeFrustum();return V.intersectsPrecise(C.vertices,C.planes,R)===0||H.intersectsPrecise(C.vertices,C.planes,R)===0}function Cr(u){return[u[0]*s.dc,u[1]*s.dc,u[2]*s.dc,0]}function Fe(u,t,r,c,d,m,g,E,A){const C=c.getSource(),R=r.globeSharedBuffers;if(!R)return;let L,O,V;if(t&&(L=c.getTile(t)),C instanceof s.aK?(O=C.texture,V=s.cJ(0,0,r.transform)):L&&t&&(O=L.texture,V=s.cJ(t.canonical.z,t.canonical.x,r.transform)),!O||!V)return;u||(V=s.ad.mat4.scale(s.ad.mat4.create(),V,[1,-1,1]));const H=r.context,G=H.gl,W=d.paint.get("raster-resampling")==="nearest"?G.NEAREST:G.LINEAR,K=r.colorModeForDrapableLayerRenderPass(m),ie=g.defines;ie.push("GLOBE_POLES");const oe=new qt(G.LEQUAL,qt.ReadWrite,r.depthRangeFor3D),se=Float32Array.from(r.transform.expandedFarZProjMatrix),fe=Float32Array.from(s.bc(s.cI(new s.bT(0,0,0))));r.terrain&&r.terrain.prepareDrawTile(),H.activeTexture.set(G.TEXTURE0),O.bind(W,G.CLAMP_TO_EDGE),H.activeTexture.set(G.TEXTURE1),O.bind(W,G.CLAMP_TO_EDGE),"useMipmap"in O&&H.extTextureFilterAnisotropic&&r.transform.pitch>20&&G.texParameterf(G.TEXTURE_2D,H.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,H.extTextureFilterAnisotropicMax);const[ce,ue,he,_e]=t?R.getPoleBuffers(t.canonical.z,!1):R.getPoleBuffers(0,!0),xe=d.paint.get("raster-elevation");let Ue;u?(Ue=ce,r.renderDefaultNorthPole=xe!==0):(Ue=ue,r.renderDefaultSouthPole=xe!==0);const Le=Cr(g.mix),Ye=((at,De,Ke,Ie,Xe,He,Qe,je,it,_t,yt,wt,Ot)=>od(at,De,Ke,new Float32Array(16),new Float32Array(9),[0,0],Ie,[0,0],[0,0,0,0],1,{opacity:1,mix:0},He,[0,0],je,2,_t,yt,wt,1,0,Ot))(se,fe,V,s.ag(r.transform.zoom),0,d,0,xe,0,Le,g.offset,g.range,m),Je=r.getOrCreateProgram("raster",{defines:ie});r.uploadCommonUniforms(H,Je,null),Je.draw(r,G.TRIANGLES,oe,A,K,E,Ye,d.id,Ue,he,_e)}function Ap(u){const t=u._nearZ,r=u.projection.farthestPixelDistance(u),c=r-t,d=.2*u.height,m=t+d;return[t,r,(m-d-t)/c,(m-t)/c]}function Mu(u,t,r,c){if(u)return t instanceof so&&u instanceof Vn?t.getTextureDescriptor(u,r,!0):{texture:u.texture,mix:Cr(c.mix),offset:c.offset,buffer:0,tileSize:1}}var md=s.dd([{name:"a_index",type:"Int16",components:1}]);class _d{constructor(t,r,c,d){const m={width:c[0],height:c[1],data:null},g=t.gl;this.targetColorTexture=new s.T(t,m,g.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new s.T(t,m,g.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(r,d),this.lastInvalidatedAt=0}updateParticleTexture(t,r){if(this.particleTextureDimension===r.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const c=this.context.gl,d=r.width*r.height;this.particleTexture0=new s.T(this.context,r,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new s.T(this.context,r,c.RGBA8,{premultiply:!1,useMipmap:!1});const m=new s.de;m.reserve(d);for(let g=0;g<d;g++)m.emplaceBack(g);this.particleIndexBuffer=this.context.createVertexBuffer(m,md.members,!0),this.particleSegment=s.b8.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=r.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=s.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Ip(u,t,r){if(!u)return null;const c=t.getTextureDescriptor(u,r,!0);if(!c)return null;let{texture:d,mix:m,offset:g,tileSize:E,buffer:A,format:C}=c;if(!d||!C)return null;let R=!1;return C==="uint32"&&(R=!0,m[3]=0,m=It(s.df,m,[0,r.paint.get("raster-particle-max-speed")]),g=sd(s.df,g,[0,r.paint.get("raster-particle-max-speed")])),{texture:d,textureOffset:[A/(E+2*A),E/(E+2*A)],tileSize:E,scalarData:R,scale:m,offset:g,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[C]]}}function Cp(u){const t=u._nearZ,r=u.projection.farthestPixelDistance(u),c=r-t,d=.2*u.height,m=t+d;return[t,r,(m-d-t)/c,(m-t)/c]}const ll=new s.al(1,0,0,1),tg=new s.al(0,1,0,1),ig=new s.al(0,0,1,1),Pp=new s.al(1,0,1,1),Au=new s.al(0,1,1,1);function Uo(u,t,r,c,d,m,g){const E=u.context,A=u.transform,C=E.gl,R=A.projection.name==="globe",L=R?["PROJECTION_GLOBE_VIEW"]:[];let O=s.ad.mat4.clone(r.projMatrix);if(R&&s.ag(A.zoom)>0){const Le=s.bb(r.canonical,A),Ye=s.dg(Le);O=s.ad.mat4.multiply(new Float32Array(16),A.globeMatrix,Ye),s.ad.mat4.multiply(O,A.projMatrix,O)}const V=s.ad.mat4.create();V[12]+=2*d/(s.q.devicePixelRatio*A.width),V[13]+=2*m/(s.q.devicePixelRatio*A.height),s.ad.mat4.multiply(O,V,O);const H=u.getOrCreateProgram("debug",{defines:L}),G=t.getTileByID(r.key);u.terrain&&u.terrain.setupElevationDraw(G,H);const W=qt.disabled,K=li.disabled,ie=u.colorModeForRenderPass(),oe="$debug";E.activeTexture.set(C.TEXTURE0),u.emptyTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),R?G._makeGlobeTileDebugBuffers(u.context,A):G._makeDebugTileBoundsBuffers(u.context,A.projection);const se=G._tileDebugBuffer||u.debugBuffer,fe=G._tileDebugIndexBuffer||u.debugIndexBuffer,ce=G._tileDebugSegments||u.debugSegments;if(H.draw(u,C.LINE_STRIP,W,K,ie,ni.disabled,wp(O,c),oe,se,fe,ce,null,null,null,[G._globeTileDebugBorderBuffer]),g){const Le=G.latestRawTileData,Ye=Math.floor((Le&&Le.byteLength||0)/1024);let Je=r.canonical.toString();r.overscaledZ!==r.canonical.z&&(Je+=` => ${r.overscaledZ}`),Je+=` ${G.state}`,Je+=` ${Ye}kb`,function(at,De){at.initDebugOverlayCanvas();const Ke=at.debugOverlayCanvas,Ie=at.context.gl,Xe=at.debugOverlayCanvas.getContext("2d");Xe.clearRect(0,0,Ke.width,Ke.height),Xe.shadowColor="white",Xe.shadowBlur=2,Xe.lineWidth=1.5,Xe.strokeStyle="white",Xe.textBaseline="top",Xe.font="bold 36px Open Sans, sans-serif",Xe.fillText(De,5,5),Xe.strokeText(De,5,5),at.debugOverlayTexture.update(Ke),at.debugOverlayTexture.bind(Ie.LINEAR,Ie.CLAMP_TO_EDGE)}(u,Je)}const ue=t.getTile(r).tileSize,he=512/Math.min(ue,512)*(r.overscaledZ/A.zoom)*.5,_e=G._tileDebugTextBuffer||u.debugBuffer,xe=G._tileDebugTextIndexBuffer||u.quadTriangleIndexBuffer,Ue=G._tileDebugTextSegments||u.debugSegments;H.draw(u,C.TRIANGLES,W,K,Si.alphaBlended,ni.disabled,wp(O,s.al.transparent,he),oe,_e,xe,Ue,null,null,null,[G._globeTileDebugTextBuffer])}function gd(u,t,r,c){fa(u,0,t+r/2,u.transform.width,r,c)}function yd(u,t,r,c){fa(u,t-r/2,0,r,u.transform.height,c)}function fa(u,t,r,c,d,m){const g=u.context,E=g.gl;E.enable(E.SCISSOR_TEST),E.scissor(t*s.q.devicePixelRatio,r*s.q.devicePixelRatio,c*s.q.devicePixelRatio,d*s.q.devicePixelRatio),g.clear({color:m}),E.disable(E.SCISSOR_TEST)}const Iu=s.dd([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:cl}=Iu;function go(u,t,r,c){u.emplaceBack(t,r,c)}class Rp{constructor(t){this.vertexArray=new s.dh,this.indices=new s.aV,go(this.vertexArray,-1,-1,1),go(this.vertexArray,1,-1,1),go(this.vertexArray,-1,1,1),go(this.vertexArray,1,1,1),go(this.vertexArray,-1,-1,-1),go(this.vertexArray,1,-1,-1),go(this.vertexArray,-1,1,-1),go(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,cl),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=s.b8.simpleSegment(0,0,36,12)}}function un(u,t,r,c,d,m){const g=u.context.gl,E=t.paint.get("sky-atmosphere-color"),A=t.paint.get("sky-atmosphere-halo-color"),C=t.paint.get("sky-atmosphere-sun-intensity"),R=((L,O,V,H,G)=>({u_matrix_3f:L,u_sun_direction:O,u_sun_intensity:V,u_color_tint_r:[H.r,H.g,H.b,H.a],u_color_tint_m:[G.r,G.g,G.b,G.a],u_luminance:5e-5}))(s.ad.mat3.fromMat4(s.ad.mat3.create(),c),d,C,E,A);g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_CUBE_MAP_POSITIVE_X+m,t.skyboxTexture,0),r.draw(u,g.TRIANGLES,qt.disabled,li.disabled,Si.unblended,ni.frontCW,R,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const rg=s.dd([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class lc{constructor(t){const r=new s.di;r.emplaceBack(-1,1,1,0,0),r.emplaceBack(1,1,1,1,0),r.emplaceBack(1,-1,1,1,1),r.emplaceBack(-1,-1,1,0,1);const c=new s.aV;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(r,rg.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=s.b8.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const _r=s.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Hi{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Dp{constructor(t){this.colorModeAlphaBlendedWriteRGB=new Si([1,ko,1,ko],s.al.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Si([1,0,1,0],s.al.transparent,[!1,!1,!1,!0]),this.params=new Hi,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){const r=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new lc(r);const c=this.params.sizeRange,d=this.params.intensityRange,m=function(R){const L=s.dl(30),O=[];for(let V=0;V<R;++V){const H=2*Math.PI*L(),G=Math.acos(1-2*L())-.5*Math.PI;O.push(s.ad.vec3.fromValues(Math.cos(G)*Math.cos(H),Math.cos(G)*Math.sin(H),Math.sin(G)))}return O}(this.params.starsCount),g=s.dl(300),E=new s.dj,A=new s.aV;let C=0;for(let R=0;R<m.length;++R){const L=s.ad.vec3.scale([],m[R],200),O=Math.max(0,1+.01*c*(1*g()-.5)),V=Math.max(0,1+.01*d*(1*g()-.5));E.emplaceBack(L[0],L[1],L[2],-1,-1,O,V),E.emplaceBack(L[0],L[1],L[2],1,-1,O,V),E.emplaceBack(L[0],L[1],L[2],1,1,O,V),E.emplaceBack(L[0],L[1],L[2],-1,1,O,V),A.emplaceBack(C+0,C+1,C+2),A.emplaceBack(C+0,C+2,C+3),C+=4}this.starsVx=r.createVertexBuffer(E,_r.members),this.starsIdx=r.createIndexBuffer(A),this.starsSegments=s.b8.simpleSegment(0,0,E.length,A.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,r){const c=t.context,d=c.gl,m=t.transform,g=new qt(d.LEQUAL,qt.ReadOnly,[0,1]),E=s.ag(m.zoom),A=t.style.getLut(r.scope),C=r.properties.get("color-use-theme")==="none",R=r.properties.get("color").toRenderColor(C?null:A).toArray01(),L=r.properties.get("high-color-use-theme")==="none",O=r.properties.get("high-color").toRenderColor(L?null:A).toArray01(),V=r.properties.get("space-color-use-theme")==="none",H=r.properties.get("space-color").toRenderColor(V?null:A).toArray01PremultipliedAlpha(),G=5e-4,W=s.dk(r.properties.get("horizon-blend"),0,1,G,.25),K=s.cD(t,c,m)&&W===G?m.worldSize/(2*Math.PI*1.025)-1:m.globeRadius,ie=t.frameCounter/1e3%1,oe=s.ad.vec3.length(m.globeCenterInViewSpace),se=Math.sqrt(Math.pow(oe,2)-Math.pow(K,2)),fe=Math.acos(se/oe),ce=ue=>{const he=m.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];ue&&he.push("ALPHA_PASS");const _e=t.getOrCreateProgram("globeAtmosphere",{defines:he}),xe=((Le,Ye,Je,at,De,Ke,Ie,Xe,He,Qe,je,it)=>({u_frustum_tl:Le,u_frustum_tr:Ye,u_frustum_br:Je,u_frustum_bl:at,u_horizon:De,u_transition:Ke,u_fadeout_range:Ie,u_color:Xe,u_high_color:He,u_space_color:Qe,u_temporal_offset:je,u_horizon_angle:it}))(m.frustumCorners.TL,m.frustumCorners.TR,m.frustumCorners.BR,m.frustumCorners.BL,m.frustumCorners.horizon,E,W,R,O,H,ie,fe);t.uploadCommonUniforms(c,_e);const Ue=this.atmosphereBuffer;Ue&&_e.draw(t,d.TRIANGLES,g,li.disabled,ue?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ni.backCW,xe,ue?"atmosphere_glow_alpha":"atmosphere_glow",Ue.vertexBuffer,Ue.indexBuffer,Ue.segments)};ce(!1),ce(!0)}drawStars(t,r){const c=s.ay(r.properties.get("star-intensity"),0,1);if(c===0)return;const d=t.context,m=d.gl,g=t.transform,E=t.getOrCreateProgram("stars"),A=s.ad.quat.identity([]);s.ad.quat.rotateX(A,A,-g._pitch),s.ad.quat.rotateZ(A,A,-g.angle),s.ad.quat.rotateX(A,A,s.ak(g._center.lat)),s.ad.quat.rotateY(A,A,-s.ak(g._center.lng));const C=s.ad.mat4.fromQuat(new Float32Array(16),A),R=s.ad.mat4.multiply([],g.starsProjMatrix,C),L=s.ad.mat3.fromMat4([],C),O=s.ad.mat3.invert([],L),V=[0,1,0];s.ad.vec3.transformMat3(V,V,O),s.ad.vec3.scale(V,V,this.params.sizeMultiplier);const H=[1,0,0];s.ad.vec3.transformMat3(H,H,O),s.ad.vec3.scale(H,H,this.params.sizeMultiplier);const G=(W=V,K=H,ie=c,{u_matrix:Float32Array.from(R),u_up:W,u_right:K,u_intensity_multiplier:ie});var W,K,ie;t.uploadCommonUniforms(d,E),this.starsVx&&this.starsIdx&&E.draw(t,m.TRIANGLES,qt.disabled,li.disabled,this.colorModeAlphaBlendedWriteRGB,ni.disabled,G,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function yo(u,t){const r=[...u],c=t.cameraWorldSizeForFog/t.worldSize,d=s.ad.mat4.identity([]);return s.ad.mat4.scale(d,d,[c,c,1]),s.ad.mat4.multiply(r,d,r),s.ad.mat4.multiply(r,t.worldToFogMatrix,r),r}function ul(u,t,r,c,d){const m=r.material,g=c.context,{baseColorTexture:E,metallicRoughnessTexture:A}=m.pbrMetallicRoughness,{normalTexture:C,occlusionTexture:R,emissionTexture:L}=m;function O(H,G,W){if(H&&(u.push(G),g.activeTexture.set(g.gl.TEXTURE0+W),H.gfxTexture)){const{minFilter:K,magFilter:ie,wrapS:oe,wrapT:se}=H.sampler;H.gfxTexture.bindExtraParam(K,ie,oe,se)}}O(E,"HAS_TEXTURE_u_baseColorTexture",kr.BaseColor),O(A,"HAS_TEXTURE_u_metallicRoughnessTexture",kr.MetallicRoughness),O(C,"HAS_TEXTURE_u_normalTexture",kr.Normal),O(R,"HAS_TEXTURE_u_occlusionTexture",kr.Occlusion),O(L,"HAS_TEXTURE_u_emissionTexture",kr.Emission),d&&(d.texture||(d.texture=new s.dn(c.context,d.image,[d.image.height,d.image.height,d.image.height],g.gl.RGBA8)),g.activeTexture.set(g.gl.TEXTURE0+kr.LUT),d.texture&&d.texture.bind(g.gl.LINEAR,g.gl.CLAMP_TO_EDGE),u.push("APPLY_LUT_ON_GPU")),r.texcoordBuffer&&(u.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(r.texcoordBuffer)),r.colorBuffer&&(u.push(r.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(r.colorBuffer)),r.normalBuffer&&(u.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(r.normalBuffer)),r.pbrBuffer&&(u.push("HAS_ATTRIBUTE_a_pbr"),u.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(r.pbrBuffer)),m.alphaMode!=="OPAQUE"&&m.alphaMode!=="MASK"||u.push("UNPREMULT_TEXTURE_IN_SHADER"),m.defined||u.push("DIFFUSE_SHADED");const V=c.shadowRenderer;V&&(u.push("RENDER_SHADOWS","DEPTH_TEXTURE"),V.useNormalOffset&&u.push("NORMAL_OFFSET"))}function vo(u,t,r,c,d,m){const g=r.paint.get("model-opacity").constantOr(1),E=t.context,A=new qt(t.context.gl.LEQUAL,qt.ReadWrite,t.depthRangeFor3D),C=t.transform,R=u.mesh,L=R.material,O=L.pbrMetallicRoughness,V=t.style.fog;let H;H=t.transform.projection.zAxisUnit==="pixels"?[...u.nodeModelMatrix]:s.ad.mat4.multiply([],c.zScaleMatrix,u.nodeModelMatrix),s.ad.mat4.multiply(H,c.negCameraPosMatrix,H);const G=s.ad.mat4.invert([],H);s.ad.mat4.transpose(G,G);const W=r.paint.get("model-color-use-theme").constantOr("default")==="none",K=r.paint.get("model-emissive-strength").constantOr(0),ie=cd(new Float32Array(u.worldViewProjection),new Float32Array(H),new Float32Array(G),null,t,g,O.baseColorFactor.toRenderColor(null),L.emissiveFactor,O.metallicFactor,O.roughnessFactor,L,K,r),oe={defines:[]},se=[],fe=t.shadowRenderer;fe&&(fe.useNormalOffset=!1),ul(oe.defines,se,R,t,W?null:r.lut);let ce=null;if(V){const _e=yo(u.nodeModelMatrix,t.transform);if(ce=new Float32Array(_e),C.projection.name!=="globe"){const xe=R.aabb.min,Ue=R.aabb.max,[Le,Ye]=V.getOpacityForBounds(_e,xe[0],xe[1],Ue[0],Ue[1]);oe.overrideFog=Le>=Mt||Ye>=Mt}}const ue=fo(t,r.paint.get("model-cutoff-fade-range"));ue.shouldRenderCutoff&&oe.defines.push("RENDER_CUTOFF");const he=t.getOrCreateProgram("model",oe);t.uploadCommonUniforms(E,he,null,ce,ue),t.renderPass!=="shadow"&&fe&&fe.setupShadowsFromMatrix(u.nodeModelMatrix,he),he.draw(t,E.gl.TRIANGLES,A,d,m,R.material.doubleSided?ni.disabled:ni.backCCW,ie,r.id,R.vertexBuffer,R.indexBuffer,R.segments,r.paint,t.transform.zoom,void 0,se)}function pa(u,t,r,c,d,m,g){let E;E=u.projection.name==="globe"?s.dp(r,u):[...r],s.ad.mat4.multiply(E,E,t.matrix);const A=s.ad.mat4.multiply([],c,E);if(t.meshes)for(const C of t.meshes){if(C.material.alphaMode!=="BLEND"){g.push({mesh:C,depth:0,modelIndex:d,worldViewProjection:A,nodeModelMatrix:E});continue}const R=s.ad.vec3.transformMat4([],C.centroid,A);!u.isOrthographic&&R[2]<=0||m.push({mesh:C,depth:R[2],modelIndex:d,worldViewProjection:A,nodeModelMatrix:E})}if(t.children)for(const C of t.children)pa(u,C,r,c,d,m,g)}function cc(u,t,r,c){const d=r.shadowRenderer;if(!d)return;const m=d.getShadowPassDepthMode(),g=d.getShadowPassColorMode(),E=d.calculateShadowPassMatrixFromMatrix(t),A=Ep(E);r.getOrCreateProgram("modelDepth",{defines:r._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(r,r.context.gl.TRIANGLES,m,li.disabled,g,ni.backCCW,A,c.id,u.vertexBuffer,u.indexBuffer,u.segments,c.paint,r.transform.zoom,void 0,void 0)}function vd(u,t,r){const c=t.updateZoomBasedPaintProperties(),d=function(m,g,E){let A,C,R,L=m.terrain?m.terrain.exaggeration():0;if(m.terrain&&L>0){const O=m.terrain,V=O.findDEMTileFor(E);V&&V.dem?A=s.dr.create(O,E,V):L=0}if(L===0&&(g.terrainElevationMin=0,g.terrainElevationMax=0),L===g.validForExaggeration&&(L===0||A&&A._demTile&&A._demTile.tileID===g.validForDEMTile.id&&A._dem._timestamp===g.validForDEMTile.timestamp))return!1;for(const O in g.instancesPerModel){const V=g.instancesPerModel[O];for(let H=0;H<V.instancedDataArray.length;++H){const G=(A?L*A.getElevationAt(0|V.instancedDataArray.float32[16*H],0|V.instancedDataArray.float32[16*H+1],!0,!0):0)+V.instancesEvaluatedElevation[H];V.instancedDataArray.float32[16*H+6]=G,C=C?Math.min(g.terrainElevationMin,G):G,R=R?Math.max(g.terrainElevationMax,G):G}}return g.terrainElevationMin=C||0,g.terrainElevationMax=R||0,g.validForExaggeration=L,g.validForDEMTile=A&&A._demTile?{id:A._demTile.tileID,timestamp:A._dem._timestamp}:{id:void 0,timestamp:0},!0}(u,t,r);(c||d)&&(t.uploaded=!1,t.upload(u.context))}const Ss={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new s.ce([0,0,0],[s.ai,s.ai,0])};function xd(u,t){const r=1<<u.canonical.z,c=t.getFreeCameraOptions().position,d=t.elevation,m=u.canonical.x/r,g=(u.canonical.x+1)/r,E=u.canonical.y/r,A=(u.canonical.y+1)/r;let C=t._centerAltitude;if(d){const V=d.getMinMaxForTile(u);V&&V.max>C&&(C=V.max)}const R=s.ay(c.x,m,g)-c.x,L=s.ay(c.y,E,A)-c.y,O=s.bH(C,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(R*R+L*L+O*O))}function Bs(u,t,r,c,d,m,g){const E=u.context,A=u.renderPass==="shadow",C=u.shadowRenderer,R=A&&C?C.getShadowPassDepthMode():new qt(E.gl.LEQUAL,qt.ReadWrite,u.depthRangeFor3D),L=u.isTileAffectedByFog(m);if(r.meshes)for(const O of r.meshes){const V=["MODEL_POSITION_ON_GPU"],H=[];let G,W,K;c.instancedDataArray.length>20&&V.push("INSTANCED_ARRAYS");const ie=fo(u,t.paint.get("model-cutoff-fade-range"));if(ie.shouldRenderCutoff&&V.push("RENDER_CUTOFF"),A&&C)G=u.getOrCreateProgram("modelDepth",{defines:V}),W=Ep(g.shadowTileMatrix,g.shadowTileMatrix,Float32Array.from(r.matrix)),K=C.getShadowPassColorMode();else{ul(V,H,O,u,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),G=u.getOrCreateProgram("model",{defines:V,overrideFog:L});const se=O.material,fe=se.pbrMetallicRoughness,ce=t.paint.get("model-opacity").constantOr(1),ue=t.paint.get("model-emissive-strength").constantOr(0);W=cd(m.expandedProjMatrix,Float32Array.from(r.matrix),new Float32Array(16),null,u,ce,fe.baseColorFactor.toRenderColor(null),se.emissiveFactor,fe.metallicFactor,fe.roughnessFactor,se,ue,t,d),C&&(g.shadowUniformsInitialized?G.setShadowUniformValues(E,C.getShadowUniformValues()):(C.setupShadows(m.toUnwrapped(),G,"model-tile",m.overscaledZ),g.shadowUniformsInitialized=!0)),K=ie.shouldRenderCutoff||ce<1||se.alphaMode!=="OPAQUE"?Si.alphaBlended:Si.unblended}u.uploadCommonUniforms(E,G,m.toUnwrapped(),null,ie);const oe=O.material.doubleSided?ni.disabled:ni.backCCW;if(c.instancedDataArray.length>20)H.push(c.instancedDataBuffer),G.draw(u,E.gl.TRIANGLES,R,li.disabled,K,oe,W,t.id,O.vertexBuffer,O.indexBuffer,O.segments,t.paint,u.transform.zoom,void 0,H,c.instancedDataArray.length);else{const se=A?"u_instance":"u_normal_matrix";for(let fe=0;fe<c.instancedDataArray.length;++fe)W[se]=new Float32Array(c.instancedDataArray.arrayBuffer,64*fe,16),G.draw(u,E.gl.TRIANGLES,R,li.disabled,K,oe,W,t.id,O.vertexBuffer,O.indexBuffer,O.segments,t.paint,u.transform.zoom,void 0,H)}}if(r.children)for(const O of r.children)Bs(u,t,O,c,d,m,g)}const jo=[1,-1,1];function Cu(u,t,r,c){if(!r.modelManager)return!0;const d=r.modelManager;if(!r.shadowRenderer)return!0;const m=r.shadowRenderer,g=t.aabb;let E=!0,A=u.maxHeight;if(A===0){let R=0;for(const L in u.instancesPerModel){const O=d.getModel(L,c);O?R=Math.max(R,Math.max(Math.max(O.aabb.max[0],O.aabb.max[1]),O.aabb.max[2])):E=!1}A=u.maxScale*R*1.41+u.maxVerticalOffset,E&&(u.maxHeight=A)}g.max[2]=A,g.min[2]+=u.terrainElevationMin,g.max[2]+=u.terrainElevationMax,s.ad.vec3.transformMat4(g.min,g.min,t.tileMatrix),s.ad.vec3.transformMat4(g.max,g.max,t.tileMatrix);const C=g.intersects(m.getCurrentCascadeFrustum());return r.currentShadowCascade===0&&(u.isInsideFirstShadowMapFrustum=C===2),C===0}function Pu(u,t){const r=u.uniformValues.u_cutoff_params[0],c=u.uniformValues.u_cutoff_params[1],d=u.uniformValues.u_cutoff_params[2],m=u.uniformValues.u_cutoff_params[3];return c===r||m===d?1:s.ay(((t-r)/(c-r)-d)/(m-d),0,1)}function bd(u,t,r,c){if(t.pitch<20)return 1;const d=t.getWorldToCameraMatrix();s.ad.mat4.multiply(d,d,u);const m=s.ad.vec4.fromValues(r.min[0],r.min[1],r.min[2],1);let g=s.ad.vec4.transformMat4(s.ad.vec4.create(),m,d),E=g,A=g;m[1]=r.max[1],g=s.ad.vec4.transformMat4(s.ad.vec4.create(),m,d),E=g[1]<E[1]?g:E,A=g[1]>A[1]?g:A,m[0]=r.max[0],g=s.ad.vec4.transformMat4(s.ad.vec4.create(),m,d),E=g[1]<E[1]?g:E,A=g[1]>A[1]?g:A,m[1]=r.min[1],g=s.ad.vec4.transformMat4(s.ad.vec4.create(),m,d),E=g[1]<E[1]?g:E,A=g[1]>A[1]?g:A;const C=s.ay(c[0],0,1),R=100*t.pixelsPerMeter*s.ay(c[1],0,1),L=s.ay(c[2],0,1),O=s.ad.vec4.lerp(s.ad.vec4.create(),E,A,C),V=Math.tan(.5*t.fovX),H=-O[2]*V;if(R===0)return O[1]<-Math.abs(H)?L:1;const G=(-Math.abs(H)-O[1])/R,W=(ie,oe,se)=>(1-se)*ie+se*oe,K=s.ay(W(1,L,G),L,1);return W(1,K,s.ay((t.pitch-20)/20,0,1))}class wd{}class ma{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,r,c){{const L=this._storage.get(r.id);if(L)return L.lastUsedFrameIdx=t,L.buf}const d=c.gl,m=d.getBufferParameter(d.ELEMENT_ARRAY_BUFFER,d.BUFFER_SIZE),g=new ArrayBuffer(m),E=new Int16Array(g);d.getBufferSubData(d.ELEMENT_ARRAY_BUFFER,0,new Int16Array(g));const A=new s.dt;for(let L=0;L<m/2;L+=3){const O=E[L],V=E[L+1],H=E[L+2];A.emplaceBack(O,V),A.emplaceBack(V,H),A.emplaceBack(H,O)}const C=c.bindVertexArrayOES.current,R=new wd;return R.buf=new Xs(c,A),R.lastUsedFrameIdx=t,this._storage.set(r.id,R),c.bindVertexArrayOES.set(C),R.buf}update(t){for(const[r,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(r))}destroy(){for(const[t,r]of this._storage)r.buf.destroy(),this._storage.delete(t)}}class Td{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const Go=s.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Sd{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class uc{constructor(t,r){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...r,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...r,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const Ed=s.dd([{type:"Float32",name:"a_pos_2f",components:2}]);class Md{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,r){const c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const g=new s.du,E=new s.aV;g.emplaceBack(-1,-1),g.emplaceBack(1,-1),g.emplaceBack(1,1),g.emplaceBack(-1,1),E.emplaceBack(0,1,2),E.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(g,Ed.members),this.vignetteIdx=t.context.createIndexBuffer(E)}const d=s.b8.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);const g={u_vignetteShape:(m={vignetteShape:[r.start,r.range,Math.pow(10,r.fadePower)],vignetteColor:[r.color.r,r.color.g,r.color.b,r.color.a*r.strength]}).vignetteShape,u_vignetteColor:m.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,qt.disabled,li.disabled,Si.alphaBlended,ni.disabled,g,"vignette",this.vignetteVx,this.vignetteIdx,d)}var m}}class dn{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,r){const c=t.getFreeCameraOptions().position,d=c.toAltitude(),m=c.toLngLat(),g=s.ak(m.lng),E=s.ak(m.lat),A=t.pixelsPerMeter/r,C=g*s.dv,R=s.dv*Math.log(Math.tan(Math.PI/4+E/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const L=-this._offsetYPrev+R,O=-this._elevationPrev+d;this._accumulatedOffsetX+=(-this._offsetXPrev+C)*A,this._accumulatedOffsetY+=L*A,this._accumulatedElevation+=O*A,this._offsetXPrev=C,this._offsetYPrev=R,this._elevationPrev=d}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Ru(u,t){return[-(u[0]-Math.floor(u[0]/t)*t),-(u[1]-Math.floor(u[1]/t)*t),-(u[2]-Math.floor(u[2]/t)*t)]}function Du(u){const t=s.dl(1323123451230),r=[];for(let c=0;c<u;++c){const d=2*t()-1,m=2*t()-1,g=2*t()-1;r.push(s.ad.vec3.fromValues(d,m,g))}return r}function Zn(u,t,r,c,d){const m=s.ay((d-r)/(c-r),0,1);return(1-m)*u+m*t}class zu{constructor(t){this._movement=new dn,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Md,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,r){const c=t.transform;this._movement.update(c,this._ppmScaleFactor);const d=c.starsProjMatrix,m=s.ad.quat.identity([]);s.ad.quat.rotateX(m,m,s.ak(90)-c._pitch),s.ad.quat.rotateZ(m,m,-c.angle);const g=s.ad.mat4.fromQuat(new Float32Array(16),m),E=s.ad.mat4.fromValues(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),A=s.ad.mat4.transpose([],E),C=s.ad.mat4.multiply([],A,g),R=Date.now()/1e3;return this._accumulatedTimeFromStart+=(R-this._prevTime)*r,this._prevTime=R,{projectionMatrix:d,modelviewMatrix:C}}}class Ad extends zu{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new uc(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const r=t.context;if(!this.particlesVx){const c=Du(this.particlesCount),d=new s.dw,m=new s.aV;let g=0;const E=s.dl(1323123451230);for(let A=0;A<c.length;++A){const C=c[A],R=[2*E()-1,E(),E(),E()];d.emplaceBack(C[0],C[1],C[2],-1,-1,...R),d.emplaceBack(C[0],C[1],C[2],1,-1,...R),d.emplaceBack(C[0],C[1],C[2],1,1,...R),d.emplaceBack(C[0],C[1],C[2],-1,1,...R),m.emplaceBack(g+0,g+1,g+2),m.emplaceBack(g+0,g+2,g+3),g+=4}this.particlesVx=r.createVertexBuffer(d,Go.members),this.particlesIdx=r.createIndexBuffer(m)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const r=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(r.revealStart>c)return;const d=Zn(0,1,r.revealStart,r.revealStart+r.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;const m=structuredClone(this._params);let g=[-m.direction.x,m.direction.y,-100];s.ad.vec3.normalize(g,g);const E=structuredClone(this._vignetteParams);E.strength*=d,m.overrideStyleParameters||(m.intensity=t.style.rain.state.density,m.timeFactor=t.style.rain.state.intensity,m.color=structuredClone(t.style.rain.state.color),g=structuredClone(t.style.rain.state.direction),m.screenThinning.intensity=t.style.rain.state.centerThinning,m.dropletSizeX=t.style.rain.state.dropletSize[0],m.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],m.distortionStrength=100*t.style.rain.state.distortionStrength,E.strength=1,E.color=structuredClone(t.style.rain.state.vignetteColor));const A=this.updateOnRender(t,m.timeFactor),C=t.context,R=C.gl,L=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new s.T(C,{width:t.width,height:t.height,data:null},R.RGBA8)),m.distortionStrength>0&&(C.activeTexture.set(R.TEXTURE0),this.screenTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),R.copyTexSubImage2D(R.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const O=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(C,O),C.activeTexture.set(R.TEXTURE0),this.screenTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE);const V=[m.color.r,m.color.g,m.color.b,m.color.a],H=(G,W)=>{const K=Ru(this._movement.getPosition(),G),ie=m.dropletSizeX,oe=m.dropletSizeX*m.dropletSizeYScale,se=t.width/2,fe=t.height/2,ce=Zn(0,m.screenThinning.start,0,1,m.screenThinning.intensity),ue=Zn(.001,m.screenThinning.range,0,1,m.screenThinning.intensity),he=Zn(0,m.screenThinning.particleOffset,0,1,m.screenThinning.intensity),_e=(xe={modelview:A.modelviewMatrix,projection:A.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:K,velocityConeAperture:m.velocityConeAperture,velocity:m.velocity,boxSize:G,rainDropletSize:[ie,oe],distortionStrength:m.distortionStrength,rainDirection:g,color:V,screenSize:[L.width,L.height],thinningCenterPos:[se,fe],thinningShape:[ce,ue,Math.pow(10,m.screenThinning.fadePower)],thinningAffectedRatio:m.screenThinning.affectedRatio,thinningParticleOffset:he,shapeDirectionalPower:m.shapeDirPower,shapeNormalPower:m.shapeNormalPower,mode:W?0:1},{u_modelview:Float32Array.from(xe.modelview),u_projection:Float32Array.from(xe.projection),u_time:xe.time,u_cam_pos:xe.camPos,u_texScreen:0,u_velocityConeAperture:xe.velocityConeAperture,u_velocity:xe.velocity,u_boxSize:xe.boxSize,u_rainDropletSize:xe.rainDropletSize,u_distortionStrength:xe.distortionStrength,u_rainDirection:xe.rainDirection,u_color:xe.color,u_screenSize:xe.screenSize,u_thinningCenterPos:xe.thinningCenterPos,u_thinningShape:xe.thinningShape,u_thinningAffectedRatio:xe.thinningAffectedRatio,u_thinningParticleOffset:xe.thinningParticleOffset,u_shapeDirectionalPower:xe.shapeDirectionalPower,u_shapeNormalPower:xe.shapeNormalPower,u_mode:xe.mode});var xe;const Ue=Math.round(m.intensity*this.particlesCount),Le=s.b8.simpleSegment(0,0,4*Ue,2*Ue);O.draw(t,R.TRIANGLES,qt.disabled,li.disabled,Si.alphaBlended,ni.disabled,_e,"rain_particles",this.particlesVx,this.particlesIdx,Le)};m.distortionStrength>0&&H(m.boxSize,!0),H(m.boxSize,!1),this._vignette.draw(t,E)}}const Id=s.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class hl extends zu{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new uc(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const r=t.context;if(!this.particlesVx){const c=Du(this.particlesCount),d=new s.dx,m=new s.aV;let g=0;const E=s.dl(1323123451230);for(let A=0;A<c.length;++A){const C=c[A],R=E(),L=E(),O=E(),V=[A/c.length,R,L,O],H=[E(),E()];d.emplaceBack(C[0],C[1],C[2],-1,-1,...V,...H),d.emplaceBack(C[0],C[1],C[2],1,-1,...V,...H),d.emplaceBack(C[0],C[1],C[2],1,1,...V,...H),d.emplaceBack(C[0],C[1],C[2],-1,1,...V,...H),m.emplaceBack(g+0,g+1,g+2),m.emplaceBack(g+0,g+2,g+3),g+=4}this.particlesVx=r.createVertexBuffer(d,Id.members),this.particlesIdx=r.createIndexBuffer(m)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const r=structuredClone(this._params);let c=[-r.direction.x,r.direction.y,-100];s.ad.vec3.normalize(c,c);const d=structuredClone(this._vignetteParams),m=r.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},g=t.transform.zoom;if(m.revealStart>g)return;const E=Zn(0,1,m.revealStart,m.revealStart+m.revealRange,g);d.strength*=E,r.overrideStyleParameters||(r.intensity=t.style.snow.state.density,r.timeFactor=t.style.snow.state.intensity,r.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),r.screenThinning.intensity=t.style.snow.state.centerThinning,r.billboardSize=2.79*t.style.snow.state.flakeSize,d.strength=1,d.color=structuredClone(t.style.snow.state.vignetteColor));const A=this.updateOnRender(t,r.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const C=t.context,R=C.gl,L=t.transform,O=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(C,O),((V,H,G)=>{const W=Ru(this._movement.getPosition(),V),K=L.width/2,ie=L.height/2,oe=Zn(0,G.screenThinning.start,0,1,G.screenThinning.intensity),se=Zn(.001,G.screenThinning.range,0,1,G.screenThinning.intensity),fe=Zn(0,G.screenThinning.particleOffset,0,1,G.screenThinning.intensity),ce=(ue={modelview:A.modelviewMatrix,projection:A.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:W,velocityConeAperture:G.velocityConeAperture,velocity:G.velocity,horizontalOscillationRadius:G.horizontalOscillationRadius,horizontalOscillationRate:G.horizontalOscillationRate,boxSize:V,billboardSize:1*G.billboardSize,simpleShapeParameters:[G.shapeFadeStart,G.shapeFadePower],screenSize:[L.width,L.height],thinningCenterPos:[K,ie],thinningShape:[oe,se,Math.pow(10,G.screenThinning.fadePower)],thinningAffectedRatio:G.screenThinning.affectedRatio,thinningParticleOffset:fe,color:[G.color.r,G.color.g,G.color.b,G.color.a],direction:c},{u_modelview:Float32Array.from(ue.modelview),u_projection:Float32Array.from(ue.projection),u_time:ue.time,u_cam_pos:ue.camPos,u_velocityConeAperture:ue.velocityConeAperture,u_velocity:ue.velocity,u_horizontalOscillationRadius:ue.horizontalOscillationRadius,u_horizontalOscillationRate:ue.horizontalOscillationRate,u_boxSize:ue.boxSize,u_billboardSize:ue.billboardSize,u_simpleShapeParameters:ue.simpleShapeParameters,u_screenSize:ue.screenSize,u_thinningCenterPos:ue.thinningCenterPos,u_thinningShape:ue.thinningShape,u_thinningAffectedRatio:ue.thinningAffectedRatio,u_thinningParticleOffset:ue.thinningParticleOffset,u_particleColor:ue.color,u_direction:ue.direction});var ue;const he=Math.round(G.intensity*this.particlesCount),_e=s.b8.simpleSegment(0,0,4*he,2*he);this.particlesVx&&this.particlesIdx&&O.draw(t,R.TRIANGLES,qt.disabled,li.disabled,Si.alphaBlended,ni.disabled,ce,"snow_particles",this.particlesVx,this.particlesIdx,_e)})(r.boxSize,0,r),this._vignette.draw(t,d)}}const hc={symbol:function(u,t,r,c,d){if(u.renderPass!=="translucent")return;const m=li.disabled,g=u.colorModeForRenderPass(),E=r.layout.get("text-variable-anchor"),A=r.layout.get("text-size-scale-range"),C=s.ay(u.scaleFactor,A[0],A[1]);E&&function(O,V,H,G,W,K,ie,oe){const se=V.transform,fe=W==="map",ce=K==="map";for(const ue of O){const he=G.getTile(ue),_e=he.getBucket(H);if(!_e||!_e.text||!_e.text.segments.get().length)continue;const xe=s.bp(_e.textSizeData,se.zoom,oe),Ue=as(ue,_e.getProjection(),se),Le=se.calculatePixelsToTileUnitsMatrix(he),Ye=ao(Ue,he.tileID.canonical,ce,fe,se,_e.getProjection(),Le),Je=_e.hasIconTextFit()&&_e.hasIconData();if(xe){const at=Math.pow(2,se.zoom-he.tileID.overscaledZ);Ts(_e,fe,ce,ie,s.cY,se,Ye,ue,at,xe,Je)}}}(c,u,r,t,r.layout.get("text-rotation-alignment"),r.layout.get("text-pitch-alignment"),d,C);const R=r.paint.get("icon-opacity").constantOr(1)!==0,L=r.paint.get("text-opacity").constantOr(1)!==0;r.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(R||L)?ur(u,t,r,c,m,g):(R&&ur(u,t,r,c,m,g,{onlyIcons:!0}),L&&ur(u,t,r,c,m,g,{onlyText:!0})),t.map.showCollisionBoxes&&(Tu(u,t,r,c,r.paint.get("text-translate"),r.paint.get("text-translate-anchor"),!0),Tu(u,t,r,c,r.paint.get("icon-translate"),r.paint.get("icon-translate-anchor"),!1))},circle:function(u,t,r,c){if(u.renderPass!=="translucent")return;const d=r.paint.get("circle-opacity"),m=r.paint.get("circle-stroke-width"),g=r.paint.get("circle-stroke-opacity"),E=r.layout.get("circle-sort-key").constantOr(1)!==void 0,A=r.paint.get("circle-emissive-strength");if(d.constantOr(1)===0&&(m.constantOr(1)===0||g.constantOr(1)===0))return;const C=u.context,R=C.gl,L=u.transform,O=u.depthModeForSublayer(0,qt.ReadOnly),V=li.disabled,H=u.colorModeForDrapableLayerRenderPass(A),G=L.projection.name==="globe",W=[s.av(L.center.lng),s.aC(L.center.lat)],K=[];for(let oe=0;oe<c.length;oe++){const se=c[oe],fe=t.getTile(se),ce=fe.getBucket(r);if(!ce||ce.projection.name!==L.projection.name)continue;const ue=ce.programConfigurations.get(r.id),he=s.cZ(r),_e=u.isTileAffectedByFog(se);G&&he.push("PROJECTION_GLOBE_VIEW"),he.push("DEPTH_D24"),u.terrain&&L.depthOcclusionForSymbolsAndCircles&&he.push("DEPTH_OCCLUSION");const xe=u.getOrCreateProgram("circle",{config:ue,defines:he,overrideFog:_e}),Ue=ce.layoutVertexBuffer,Le=ce.globeExtVertexBuffer,Ye=ce.indexBuffer,Je=L.projection.createInversionMatrix(L,se.canonical),at={programConfiguration:ue,program:xe,layoutVertexBuffer:Ue,globeExtVertexBuffer:Le,indexBuffer:Ye,uniformValues:s.c_(u,se,fe,Je,W,r),tile:fe};if(E){const De=ce.segments.get();for(const Ke of De)K.push({segments:new s.b8([Ke]),sortKey:Ke.sortKey,state:at})}else K.push({segments:ce.segments,sortKey:0,state:at})}E&&K.sort((oe,se)=>oe.sortKey-se.sortKey);const ie={useDepthForOcclusion:L.depthOcclusionForSymbolsAndCircles};for(const oe of K){const{programConfiguration:se,program:fe,layoutVertexBuffer:ce,globeExtVertexBuffer:ue,indexBuffer:he,uniformValues:_e,tile:xe}=oe.state,Ue=oe.segments;u.terrain&&u.terrain.setupElevationDraw(xe,fe,ie),u.uploadCommonUniforms(C,fe,xe.tileID.toUnwrapped()),fe.draw(u,R.TRIANGLES,O,V,H,ni.disabled,_e,r.id,ce,he,Ue,r.paint,L.zoom,se,[ue])}},heatmap:function(u,t,r,c){if(r.paint.get("heatmap-opacity")!==0)if(u.renderPass==="offscreen"){const d=u.context,m=d.gl,g=li.disabled,E=new Si([m.ONE,m.ONE,m.ONE,m.ONE],s.al.transparent,[!0,!0,!0,!0]);(function(V,H,G,W){const K=V.gl,ie=H.width*W,oe=H.height*W;V.activeTexture.set(K.TEXTURE1),V.viewport.set([0,0,ie,oe]);let se=G.heatmapFbo;if(!se||se&&(se.width!==ie||se.height!==oe)){se&&se.destroy();const fe=K.createTexture();K.bindTexture(K.TEXTURE_2D,fe),K.texParameteri(K.TEXTURE_2D,K.TEXTURE_WRAP_S,K.CLAMP_TO_EDGE),K.texParameteri(K.TEXTURE_2D,K.TEXTURE_WRAP_T,K.CLAMP_TO_EDGE),K.texParameteri(K.TEXTURE_2D,K.TEXTURE_MIN_FILTER,K.LINEAR),K.texParameteri(K.TEXTURE_2D,K.TEXTURE_MAG_FILTER,K.LINEAR),se=G.heatmapFbo=V.createFramebuffer(ie,oe,!0,null),function(ce,ue,he,_e,xe,Ue){const Le=ce.gl;Le.texImage2D(Le.TEXTURE_2D,0,ce.extRenderToTextureHalfFloat?Le.RGBA16F:Le.RGBA,xe,Ue,0,Le.RGBA,ce.extRenderToTextureHalfFloat?Le.HALF_FLOAT:Le.UNSIGNED_BYTE,null),_e.colorAttachment.set(he)}(V,0,fe,se,ie,oe)}else K.bindTexture(K.TEXTURE_2D,se.colorAttachment.get()),V.bindFramebuffer.set(se.framebuffer)})(d,u,r,u.transform.projection.name==="globe"?.5:.25),d.clear({color:s.al.transparent});const A=u.transform,C=A.projection.name==="globe",R=C?["PROJECTION_GLOBE_VIEW"]:[],L=C?ni.frontCCW:ni.disabled,O=[s.av(A.center.lng),s.aC(A.center.lat)];for(let V=0;V<c.length;V++){const H=c[V];if(t.hasRenderableParent(H))continue;const G=t.getTile(H),W=G.getBucket(r);if(!W||W.projection.name!==A.projection.name)continue;const K=u.isTileAffectedByFog(H),ie=W.programConfigurations.get(r.id),oe=u.getOrCreateProgram("heatmap",{config:ie,defines:R,overrideFog:K}),{zoom:se}=u.transform;u.terrain&&u.terrain.setupElevationDraw(G,oe),u.uploadCommonUniforms(d,oe,H.toUnwrapped());const fe=A.projection.createInversionMatrix(A,H.canonical);oe.draw(u,m.TRIANGLES,qt.disabled,g,E,L,xu(u,H,G,fe,O,se,r.paint.get("heatmap-intensity")),r.id,W.layoutVertexBuffer,W.indexBuffer,W.segments,r.paint,u.transform.zoom,ie,C?[W.globeExtVertexBuffer]:null)}d.viewport.set([0,0,u.width,u.height])}else u.renderPass==="translucent"&&(u.context.setColorMode(u.colorModeForRenderPass()),function(d,m){const g=d.context,E=g.gl,A=m.heatmapFbo;if(!A)return;g.activeTexture.set(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,A.colorAttachment.get()),g.activeTexture.set(E.TEXTURE1);let C=m.colorRampTexture;C||(C=m.colorRampTexture=new s.T(g,m.colorRamp,E.RGBA8)),C.bind(E.LINEAR,E.CLAMP_TO_EDGE),d.getOrCreateProgram("heatmapTexture").draw(d,E.TRIANGLES,qt.disabled,li.disabled,d.colorModeForRenderPass(),ni.disabled,((R,L,O,V)=>({u_image:0,u_color_ramp:1,u_opacity:L.paint.get("heatmap-opacity")}))(0,m),m.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments,m.paint,d.transform.zoom)}(u,r))},line:function(u,t,r,c){if(u.renderPass!=="translucent")return;const d=r.paint.get("line-opacity"),m=r.paint.get("line-width");if(d.constantOr(1)===0||m.constantOr(1)===0)return;const g=r.paint.get("line-emissive-strength"),E=r.paint.get("line-occlusion-opacity"),A=r.layout.get("line-elevation-reference"),C=r.layout.get("line-width-unit")==="meters",R=A==="sea",L=u.context,O=L.gl;if(r.hasElevatedBuckets&&u.transform.projection.name==="globe")return;const V=r.layout.get("line-cross-slope"),H=V!==void 0,G=V<1,W=u.colorModeForDrapableLayerRenderPass(g),K=u.terrain&&u.terrain.renderingToTexture,ie=K?1:s.q.devicePixelRatio,oe=r.paint.get("line-dasharray"),se=oe.constantOr(1),fe=r.layout.get("line-cap"),ce=oe.constantOr(null),ue=fe.constantOr(null),he=r.paint.get("line-pattern"),_e=he.constantOr(1),xe=he.constantOr(null),Ue=r.paint.get("line-opacity").constantOr(1);let Le=!_e&&Ue!==1||u.depthOcclusion&&E>0&&E<1;const Ye=r.paint.get("line-gradient"),Je=_e?"linePattern":"line",at=s.c$(r);let De;if(K&&u.terrain&&u.terrain.clipOrMaskOverlapStencilType()&&(Le=!1),E!==0&&u.depthOcclusion){const Ie=r.paint._values["line-opacity"];Ie&&Ie.value&&Ie.value.kind==="constant"?De=Ie.value:s.w(`Occlusion opacity for layer ${r.id} is supported only when line-opacity isn't data-driven.`)}m.value.kind!=="constant"&&m.value.isLineProgressConstant===!1&&at.push("VARIABLE_LINE_WIDTH");const Ke=(Ie,Xe,He,Qe,je,it)=>{for(const _t of Ie){const yt=t.getTile(_t);if(_e&&!yt.patternsLoaded())continue;const wt=yt.getBucket(r);if(!wt||wt.hasZOffset&&!je||!wt.hasZOffset&&je)continue;u.prepareDrawTile();const Ot=wt.programConfigurations.get(r.id),si=u.isTileAffectedByFog(_t),Wt=u.getOrCreateProgram(Je,{config:Ot,defines:Xe,overrideFog:si,overrideRtt:!je&&void 0});if(xe&&yt.imageAtlas){const ci=s.d0.from(xe).getPrimary().scaleSelf(ie).toString(),kt=yt.imageAtlas.patternPositions.get(ci);kt&&Ot.setConstantPatternPositions(kt)}if(!_e&&ce&&ue&&yt.lineAtlas){const ci=yt.lineAtlas.getDash(ce,ue);ci&&Ot.setConstantPatternPositions(ci)}let[ii,Yt]=r.paint.get("line-trim-offset");(ue==="round"||ue==="square")&&ii!==Yt&&(ii===0&&(ii-=1),Yt===1&&(Yt+=1));const Ii=K?_t.projMatrix:null,Wi=C?1/wt.tileToMeter/s.at(yt,1,u.transform.zoom):1,dr=C?1/wt.tileToMeter/s.at(yt,1,Math.floor(u.transform.zoom)):1,wi=_e?s.d1(u,yt,r,Ii,ie,Wi,dr,[ii,Yt]):s.d2(u,yt,r,Ii,wt.lineClipsArray.length,ie,Wi,dr,[ii,Yt]);if(Ye){const ci=wt.gradients[r.id];let kt=ci.texture;if(r.gradientVersion!==ci.version){let Ri=256;if(r.stepInterpolant){const ir=t.getSource().maxzoom,Bi=_t.canonical.z===ir?Math.ceil(1<<u.transform.maxZoom-_t.canonical.z):1;Ri=s.ay(s.d3(wt.maxLineLength/s.ai*1024*Bi),256,L.maxTextureSize)}ci.gradient=s.d4({expression:r.gradientExpression(),evaluationKey:"lineProgress",resolution:Ri,image:ci.gradient||void 0,clips:wt.lineClipsArray}),ci.texture?ci.texture.update(ci.gradient):ci.texture=new s.T(L,ci.gradient,O.RGBA8),ci.version=r.gradientVersion,kt=ci.texture}L.activeTexture.set(O.TEXTURE1),kt.bind(r.stepInterpolant?O.NEAREST:O.LINEAR,O.CLAMP_TO_EDGE)}se&&(L.activeTexture.set(O.TEXTURE0),yt.lineAtlasTexture&&yt.lineAtlasTexture.bind(O.LINEAR,O.REPEAT),Ot.updatePaintBuffers()),_e&&(L.activeTexture.set(O.TEXTURE0),yt.imageAtlasTexture&&yt.imageAtlasTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE),Ot.updatePaintBuffers()),je&&!R&&u.terrain.setupElevationDraw(yt,Wt),u.uploadCommonUniforms(L,Wt,_t.toUnwrapped());const Sr=ci=>{De!=null&&(De.value=Ue*E),Wt.draw(u,O.TRIANGLES,He,ci,W,ni.disabled,wi,r.id,wt.layoutVertexBuffer,wt.indexBuffer,wt.segments,r.paint,u.transform.zoom,Ot,[wt.layoutVertexBuffer2,wt.patternVertexBuffer,wt.zOffsetVertexBuffer]),De!=null&&(De.value=Ue)};if(Le&&!je){const ci=u.stencilModeForClipping(_t).ref;ci===0&&K&&L.clear({stencil:0});const kt={func:O.EQUAL,mask:255};wi.u_alpha_discard_threshold=.8,Sr(new li(kt,ci,255,O.KEEP,O.KEEP,O.INVERT)),wi.u_alpha_discard_threshold=0,Sr(new li(kt,ci,255,O.KEEP,O.KEEP,O.KEEP))}else wi.u_alpha_discard_threshold=Le&&je&&it?.8:0,Sr(je?Qe:u.stencilModeForClipping(_t))}};if(r.hasNonElevatedBuckets){const Ie=!K&&u.terrain;E!==0&&Ie?s.w(`Occlusion opacity for layer ${r.id} is supported on terrain only if the layer has line-z-offset enabled.`):Ie?s.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${r.id}.`):Ke(c,at,u.depthModeForSublayer(0,qt.ReadOnly),li.disabled,!1,!0)}if(r.hasElevatedBuckets){at.push("ELEVATED"),H&&at.push(G?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),R&&at.push("ELEVATION_REFERENCE_SEA");const Ie=Le?u.stencilModeFor3D():li.disabled,Xe=new qt(u.depthOcclusion?O.GREATER:O.LEQUAL,qt.ReadOnly,u.depthRangeFor3D);u.forceTerrainMode=!0,Ke(c,at,Xe,Ie,!0,!0),Le&&Ke(c,at,Xe,Ie,!0,!1),u.forceTerrainMode=!1}Le&&(u.resetStencilClippingMasks(),K&&L.clear({stencil:0})),E===0||u.depthOcclusion||K||u.layersWithOcclusionOpacity.push(u.currentLayer)},fill:function(u,t,r,c){const d=r.paint.get("fill-color"),m=r.paint.get("fill-opacity");if(m.constantOr(1)===0)return;const g=r.paint.get("fill-emissive-strength"),E=u.colorModeForDrapableLayerRenderPass(g),A=r.paint.get("fill-pattern"),C=u.opaquePassEnabledForLayer()&&!A.constantOr(1)&&d.constantOr(s.al.transparent).a===1&&m.constantOr(0)===1?"opaque":"translucent";let R="none";r.layout.get("fill-elevation-reference")!=="none"?R="road":r.paint.get("fill-z-offset").constantOr(1)!==0&&(R="offset");const L=!(!u.terrain||!u.terrain.enabled),O={painter:u,sourceCache:t,layer:r,coords:c,colorMode:E,elevationType:R,terrainEnabled:L,pass:C};if(R!=="offset"){if(Eu(O,!1),R==="road"){const V=!L&&u.renderPass==="translucent";V&&pd(u,t,r,c,"geometry"),Eu(O,!0,li.disabled),V&&function(H){const{painter:G,sourceCache:W,layer:K,coords:ie,colorMode:oe}=H,se=G.context.gl,fe=new qt(G.context.gl.LEQUAL,qt.ReadOnly,G.depthRangeFor3D);for(const ce of ie){const ue=W.getTile(ce),he=ue.getBucket(K);if(!he)continue;const _e=he.elevatedStructures;if(!_e||!_e.renderableSegments||_e.renderableSegments.segments[0].primitiveLength===0)continue;G.prepareDrawTile();const xe=he.bufferData.programConfigurations.get(K.id),Ue=G.isTileAffectedByFog(ce),Le=G.getOrCreateProgram("elevatedStructures",{config:xe,overrideFog:Ue,defines:["NORMAL_OFFSET"]}),Ye={u_matrix:G.translatePosMatrix(ce.projMatrix,ue,K.paint.get("fill-translate"),K.paint.get("fill-translate-anchor"))};G.uploadCommonUniforms(G.context,Le,ce.toUnwrapped()),Le.draw(G,se.TRIANGLES,fe,li.disabled,oe,ni.backCCW,Ye,K.id,_e.vertexBuffer,_e.indexBuffer,_e.renderableSegments,K.paint,G.transform.zoom,xe,[_e.vertexBufferNormal])}}(O)}}else Eu(O,!1,u.stencilModeFor3D())},"fill-extrusion":function(u,t,r,c){const d=r.paint.get("fill-extrusion-opacity"),m=u.context,g=m.gl,E=u.terrain,A=E&&E.renderingToTexture;if(d===0)return;const C=u.conflationActive&&u.style.isLayerClipped(r,t.getSource()),R=u.style.order.indexOf(r.fqid);if(C&&function(L,O,V,H,G){for(const W of H){const K=O.getTile(W).getBucket(V);K&&(K.updateReplacement(W,L.replacementSource,G),K.uploadCentroid(L.context))}}(u,t,r,c,R),E||C)for(const L of c){const O=t.getTile(L).getBucket(r);O&&sl(u.context,t,L,O,r,E,C)}if(u.renderPass==="shadow"&&u.shadowRenderer){const L=u.shadowRenderer;if(E&&d<.65&&r._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof s.ab)return;const O=L.getShadowPassDepthMode(),V=L.getShadowPassColorMode();ac(u,t,r,c,O,li.disabled,V,C)}else if(u.renderPass==="translucent"){const L=!r.paint.get("fill-extrusion-pattern").constantOr(1),O=r.paint.get("fill-extrusion-color").constantOr(s.al.white);if(!A&&O.a!==0){const V=new qt(u.context.gl.LEQUAL,qt.ReadWrite,u.depthRangeFor3D);d===1&&L?ac(u,t,r,c,V,li.disabled,Si.unblended,C):(ac(u,t,r,c,V,li.disabled,Si.disabled,C),ac(u,t,r,c,V,u.stencilModeFor3D(),u.colorModeForRenderPass(),C),u.resetStencilClippingMasks())}if(u.style.enable3dLights()&&L&&(!E&&u.transform.projection.name!=="globe"||A)){const V=r.paint.get("fill-extrusion-opacity"),H=r.paint.get("fill-extrusion-ambient-occlusion-intensity"),G=r.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),W=r.paint.get("fill-extrusion-flood-light-intensity"),K=r.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",ie=r.paint.get("fill-extrusion-flood-light-color").toRenderColor(K?null:r.lut).toArray01().slice(0,3),oe=H>0&&G>0,se=W>0,fe=(ue,he,_e)=>(1-_e)*ue+_e*he,ce=ue=>{const he=u.depthModeForSublayer(1,qt.ReadOnly,g.LEQUAL,!0),_e=r.paint.get(ue?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),xe=fe(.1,3,_e),Ue=u._showOverdrawInspector;if(!Ue){const Le=new li({func:g.ALWAYS,mask:255},255,255,g.KEEP,g.KEEP,g.REPLACE),Ye=new Si([g.ONE,g.ONE,g.ONE,g.ONE],s.al.transparent,[!1,!1,!1,!0],g.MIN);nl(u,t,r,c,he,Le,Ye,ni.disabled,ue,"sdf",V,H,G,W,ie,xe,C,!1)}{const Le=Ue?li.disabled:new li({func:g.EQUAL,mask:255},255,255,g.KEEP,g.DECR,g.DECR),Ye=Ue?u.colorModeForRenderPass():new Si([g.ONE_MINUS_DST_ALPHA,g.DST_ALPHA,g.ONE,g.ONE],s.al.transparent,[!0,!0,!0,!0]);nl(u,t,r,c,he,Le,Ye,ni.disabled,ue,"color",V,H,G,W,ie,xe,C,!1)}};if(A){const ue=(he,_e,xe)=>{const Ue=u.depthModeForSublayer(1,qt.ReadOnly,g.LEQUAL,!1),Le=r.paint.get(he?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ye=fe(.1,3,Le);{const Je=new Si([g.ONE,g.ONE,g.ONE,g.ONE],s.al.transparent,[!1,!1,!1,!0]);nl(u,t,r,c,Ue,li.disabled,Je,ni.disabled,he,"clear",V,H,G,W,ie,Ye,C,_e)}{const Je=new li({func:g.ALWAYS,mask:255},255,255,g.KEEP,g.KEEP,g.REPLACE),at=new Si([g.ONE,g.ONE,g.ONE,g.ONE],s.al.transparent,[!1,!1,!1,!0],g.MIN);nl(u,t,r,c,Ue,Je,at,ni.disabled,he,"sdf",V,H,G,W,ie,Ye,C,_e)}{const Je=he?g.ZERO:g.ONE_MINUS_DST_ALPHA,at=new li({func:g.EQUAL,mask:255},255,255,g.KEEP,g.DECR,g.DECR),De=new Si([Je,g.DST_ALPHA,g.ONE_MINUS_DST_ALPHA,g.ZERO],s.al.transparent,[!0,!0,!0,!0]);nl(u,t,r,c,Ue,at,De,ni.disabled,he,"color",V,H,G,W,ie,Ye,C,_e)}{const Je=new Si([g.ONE,g.ONE,g.ONE,he?g.ZERO:g.ONE],s.al.transparent,[!1,!1,!1,!0],he?g.FUNC_ADD:g.MAX);nl(u,t,r,c,Ue,li.disabled,Je,ni.disabled,he,"clear",V,H,G,W,ie,Ye,C,_e,xe)}};if(oe||se){let he;if(u.prepareDrawTile(),E){const _e=E.drapeBufferSize[0],xe=E.drapeBufferSize[1];he=E.framebufferCopyTexture,he&&(!he||he.size[0]===_e&&he.size[1]===xe)||(he&&he.destroy(),he=E.framebufferCopyTexture=new s.T(m,new s.r({width:_e,height:xe}),g.RGBA8)),he.bind(g.LINEAR,g.CLAMP_TO_EDGE),g.copyTexSubImage2D(g.TEXTURE_2D,0,0,0,0,0,_e,xe)}oe&&ue(!0,!1,he),se&&ue(!1,!0,he)}}else oe&&ce(!0),se&&ce(!1),(oe||se)&&u.resetStencilClippingMasks()}}},hillshade:function(u,t,r,c){if(u.renderPass!=="offscreen"&&u.renderPass!=="translucent"||u.style.disableElevatedTerrain)return;const d=u.context,m=u.terrain&&u.terrain.renderingToTexture,[g,E]=u.renderPass!=="translucent"||m?[{},c]:u.stencilConfigForOverlap(c);for(const A of E){const C=t.getTile(A);if(C.needsHillshadePrepare&&u.renderPass==="offscreen")q_(u,C,r);else if(u.renderPass==="translucent"){const R=u.depthModeForSublayer(0,qt.ReadOnly),L=r.paint.get("hillshade-emissive-strength"),O=u.colorModeForDrapableLayerRenderPass(L),V=m&&u.terrain?u.terrain.stencilModeForRTTOverlap(A):g[A.overscaledZ];Xa(u,A,C,r,R,V,O)}}d.viewport.set([0,0,u.width,u.height]),u.resetStencilClippingMasks()},raster:function(u,t,r,c,d,m){if(u.renderPass!=="translucent"||r.paint.get("raster-opacity")===0)return;const g=u.transform.projection.name==="globe",E=r.paint.get("raster-elevation")!==0,A=E&&g;if(u.renderElevatedRasterBackface&&!A)return;const C=u.context,R=C.gl,L=t.getSource(),O=function(ce,ue,he,_e){const xe=ue.paint.get("raster-color"),Ue=ce.type==="raster-array",Le=[],Ye=ue.paint.get("raster-resampling"),Je=ue.paint.get("raster-color-mix");let at=ue.paint.get("raster-color-range");const De=[Je[0],Je[1],Je[2],0],Ke=Je[3];let Ie=Ye==="nearest"?_e.NEAREST:_e.LINEAR;if(Ue&&(Le.push("RASTER_ARRAY"),xe||Le.push("RASTER_COLOR"),Ye==="linear"&&Le.push("RASTER_ARRAY_LINEAR"),Ie=_e.NEAREST,!at&&ce.rasterLayers)){const Xe=ce.rasterLayers.find(({id:He})=>He===ue.sourceLayer);Xe&&Xe.fields&&Xe.fields.range&&(at=Xe.fields.range)}if(at=at||[0,1],xe){Le.push("RASTER_COLOR"),he.activeTexture.set(_e.TEXTURE2),ue.updateColorRamp(at);let Xe=ue.colorRampTexture;Xe||(Xe=ue.colorRampTexture=new s.T(he,ue.colorRamp,_e.RGBA8)),Xe.bind(_e.LINEAR,_e.CLAMP_TO_EDGE)}return{mix:De,range:at,offset:Ke,defines:Le,resampling:Ie}}(L,r,C,R);if(L instanceof s.aK&&!c.length&&!g)return;const V=r.paint.get("raster-emissive-strength"),H=u.colorModeForDrapableLayerRenderPass(V),G=u.terrain&&u.terrain.renderingToTexture,W=!u.options.moving,K=r.paint.get("raster-resampling")==="nearest"?R.NEAREST:R.LINEAR;if(L instanceof s.aK&&!c.length&&(L.onNorthPole||L.onSouthPole)){const ce=E?u.stencilModeFor3D():li.disabled;return void Fe(!!L.onNorthPole,null,u,t,r,V,O,ni.disabled,ce)}if(!c.length)return;const[ie,oe]=L instanceof s.aK||G?[{},c]:u.stencilConfigForOverlap(c),se=oe[oe.length-1].overscaledZ;A&&O.defines.push("PROJECTION_GLOBE_VIEW"),E&&O.defines.push("RENDER_CUTOFF");const fe=(ce,ue,he)=>{for(const _e of ce){const xe=_e.toUnwrapped(),Ue=t.getTile(_e);if(G&&(!Ue||!Ue.hasData()))continue;C.activeTexture.set(R.TEXTURE0);const Le=Mu(Ue,L,r,O);if(!Le||!Le.texture)continue;const{texture:Ye,mix:Je,offset:at,tileSize:De,buffer:Ke}=Le;let Ie,Xe;G?(Ie=qt.disabled,Xe=_e.projMatrix):E?(Ie=new qt(R.LEQUAL,qt.ReadWrite,u.depthRangeFor3D),Xe=g?Float32Array.from(u.transform.expandedFarZProjMatrix):u.transform.calculateProjMatrix(xe,W)):(Ie=u.depthModeForSublayer(_e.overscaledZ-se,r.paint.get("raster-opacity")===1?qt.ReadWrite:qt.ReadOnly,R.LESS),Xe=u.transform.calculateProjMatrix(xe,W));const He=u.terrain&&G?u.terrain.stencilModeForRTTOverlap(_e):ie[_e.overscaledZ],Qe=m?0:r.paint.get("raster-fade-duration");Ue.registerFadeDuration(Qe);const je=t.findLoadedParent(_e,0),it=pu(Ue,je,t,u.transform,Qe);let _t,yt;u.terrain&&u.terrain.prepareDrawTile(),C.activeTexture.set(R.TEXTURE0),Ye.bind(K,R.CLAMP_TO_EDGE),C.activeTexture.set(R.TEXTURE1),je?(je.texture&&je.texture.bind(K,R.CLAMP_TO_EDGE),_t=Math.pow(2,je.tileID.overscaledZ-Ue.tileID.overscaledZ),yt=[Ue.tileID.canonical.x*_t%1,Ue.tileID.canonical.y*_t%1]):Ye.bind(K,R.CLAMP_TO_EDGE),"useMipmap"in Ye&&C.extTextureFilterAnisotropic&&u.transform.pitch>20&&R.texParameterf(R.TEXTURE_2D,C.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,C.extTextureFilterAnisotropicMax);const wt=u.transform;let Ot;const si=E?Ap(wt):[0,0,0,0];let Wt,ii,Yt,Ii,Wi,dr=0;if(A&&L instanceof s.aK&&L.coordinates.length>3)Wt=Float32Array.from(s.bc(s.cI(new s.bT(0,0,0)))),ii=Float32Array.from(wt.globeMatrix),Yt=Float32Array.from(s.cE(wt)),Ii=[s.av(wt.center.lng),s.aC(wt.center.lat)],Ot=L.elevatedGlobePerspectiveTransform,Wi=L.elevatedGlobeGridMatrix||new Float32Array(9);else if(A){const kt=s.cF(_e.canonical);dr=s.cG(kt.getCenter().lat),Wt=Float32Array.from(s.bc(s.cI(_e.canonical))),ii=Float32Array.from(wt.globeMatrix),Yt=Float32Array.from(s.cE(wt)),Ii=[s.av(wt.center.lng),s.aC(wt.center.lat)],Ot=[0,0],Wi=Float32Array.from(s.cH(_e.canonical,kt,dr,wt.worldSize/wt._pixelsPerMercatorPixel))}else Ot=L instanceof s.aK?L.perspectiveTransform:[0,0],Wt=new Float32Array(16),ii=new Float32Array(9),Yt=new Float32Array(16),Ii=[0,0],Wi=new Float32Array(9);const wi=od(Xe,Wt,ii,Yt,Wi,yt||[0,0],s.ag(u.transform.zoom),Ii,si,_t||1,it,r,Ot,E?r.paint.get("raster-elevation"):0,2,Je,at,O.range,De,Ke,V),Sr=u.isTileAffectedByFog(_e),ci=u.getOrCreateProgram("raster",{defines:O.defines,overrideFog:Sr});if(u.uploadCommonUniforms(C,ci,xe),L instanceof s.aK){const kt=L.elevatedGlobeVertexBuffer,Ri=L.elevatedGlobeIndexBuffer;if(G||!g)L.boundsBuffer&&L.boundsSegments&&ci.draw(u,R.TRIANGLES,Ie,li.disabled,H,ni.disabled,wi,r.id,L.boundsBuffer,u.quadTriangleIndexBuffer,L.boundsSegments);else if(kt&&Ri){const ir=wt.zoom<=s.c6?L.elevatedGlobeSegments:L.getSegmentsForLongitude(wt.center.lng);ir&&ci.draw(u,R.TRIANGLES,Ie,li.disabled,H,ue,wi,r.id,kt,Ri,ir)}}else if(A){Ie=new qt(R.LEQUAL,qt.ReadOnly,u.depthRangeFor3D);const kt=u.globeSharedBuffers;if(kt){const[Ri,ir,Bi]=kt.getGridBuffers(dr,!1);ci.draw(u,R.TRIANGLES,Ie,he||He,u.colorModeForRenderPass(),ue,wi,r.id,Ri,ir,Bi)}}else{const{tileBoundsBuffer:kt,tileBoundsIndexBuffer:Ri,tileBoundsSegments:ir}=u.getTileBoundsBuffers(Ue);ci.draw(u,R.TRIANGLES,Ie,He,H,ni.disabled,wi,r.id,kt,Ri,ir)}}if(!(L instanceof s.aK)&&A)for(const _e of ce){const xe=_e.canonical.y===(1<<_e.canonical.z)-1;_e.canonical.y===0&&Fe(!0,_e,u,t,r,V,O,ue,he||li.disabled),xe&&Fe(!1,_e,u,t,r,V,O,ue===ni.frontCW?ni.backCW:ni.frontCW,he||li.disabled)}};A?fe(oe,u.renderElevatedRasterBackface?ni.backCW:ni.frontCW,u.stencilModeFor3D()):fe(oe,ni.disabled,void 0),u.resetStencilClippingMasks()},"raster-particle":function(u,t,r,c,d,m){u.renderPass==="offscreen"&&function(g,E,A,C){if(!C.length)return;const R=g.context,L=R.gl,O=E.getSource();if(!(O instanceof so))return;const V=Math.ceil(Math.sqrt(A.paint.get("raster-particle-count")));let H=A.particlePositionRGBAImage;if(!H||H.width!==V){const oe=function(se){const fe=se*se,ce=new Uint8Array(4*fe),ue=function(_e){return _e|=0,_e=Math.imul(2747636419^_e,2654435769),_e=Math.imul(_e^_e>>>16,2654435769),((_e=Math.imul(_e^_e>>>16,2654435769))>>>0)/4294967296},he=1/1.1;for(let _e=0;_e<fe;_e++){const xe=he*(ue(2*_e+0)+cs),Ue=he*(ue(2*_e+1)+cs),Le=255*xe%1,Ye=255*Ue%1,Je=Le,at=Ue-Ye/255,De=Ye;ce[4*_e+0]=255*(xe-Le/255),ce[4*_e+1]=255*Je,ce[4*_e+2]=255*at,ce[4*_e+3]=255*De}return ce}(V);H=A.particlePositionRGBAImage=new s.r({width:V,height:V},oe)}let G=A.particleFramebuffer;G?G.width!==V&&(G.destroy(),G=A.particleFramebuffer=R.createFramebuffer(V,V,!0,null)):G=A.particleFramebuffer=R.createFramebuffer(V,V,!0,null);const W=[];for(const oe of C){const se=E.getTile(oe);if(!(se instanceof Vn))continue;const fe=Ip(se,O,A);if(!fe)continue;const ce=[se.tileSize,se.tileSize];let ue=A.tileFramebuffer;ue||(ue=A.tileFramebuffer=R.createFramebuffer(ce[0],ce[1],!0,null));let he=se.rasterParticleState;he||(he=se.rasterParticleState=new _d(R,oe,ce,H));const _e=he.update(A.lastInvalidatedAt);he.particleTextureDimension!==V&&he.updateParticleTexture(oe,H);const xe=he.targetColorTexture;he.targetColorTexture=he.backgroundColorTexture,he.backgroundColorTexture=xe;const Ue=he.particleTexture0;he.particleTexture0=he.particleTexture1,he.particleTexture1=Ue,W.push([oe,fe,he,_e])}if(W.length===0)return;const K=s.q.now(),ie=A.previousDrawTimestamp?.001*(K-A.previousDrawTimestamp):.0167;if(A.previousDrawTimestamp=K,A.hasColorMap()){R.activeTexture.set(L.TEXTURE0+2);let oe=A.colorRampTexture;oe||(oe=A.colorRampTexture=new s.T(R,A.colorRamp,L.RGBA8)),oe.bind(L.LINEAR,L.CLAMP_TO_EDGE)}R.bindFramebuffer.set(A.tileFramebuffer.framebuffer),function(oe,se,fe){const ce=oe.context,ue=ce.gl,he=se.tileFramebuffer;ce.activeTexture.set(ue.TEXTURE0);const _e={u_texture:0,u_opacity:1.05*(Ue=se.paint.get("raster-particle-fade-opacity-factor"))/(Ue+.05)},xe=oe.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Ue;for(const Le of fe){const[,,Ye,Je]=Le;he.colorAttachment.set(Ye.targetColorTexture.texture),ce.viewport.set([0,0,he.width,he.height]),ce.clear({color:s.al.transparent}),Je&&(Ye.backgroundColorTexture.bind(ue.NEAREST,ue.CLAMP_TO_EDGE),xe.draw(oe,ue.TRIANGLES,qt.disabled,li.disabled,Si.alphaBlended,ni.disabled,_e,se.id,oe.viewportBuffer,oe.quadTriangleIndexBuffer,oe.viewportSegments))}}(g,A,W),function(oe,se,fe,ce){const ue=oe.context,he=ue.gl,_e=fe.tileFramebuffer,xe=oe.transform.projection.name==="globe",Ue=fe.paint.get("raster-particle-max-speed");for(const Le of ce){const[Ye,Je,at]=Le;ue.activeTexture.set(he.TEXTURE0+0),Je.texture.bind(he.LINEAR,he.CLAMP_TO_EDGE),_e.colorAttachment.set(at.targetColorTexture.texture);const De=oe.getOrCreateProgram("rasterParticleDraw",{defines:Je.defines,overrideFog:!1});ue.activeTexture.set(he.TEXTURE0+1);const Ke=Je.scalarData?[]:[0,1,2,3].map(He=>s.d7[He](Ye));Ke.push(Ye);const Ie=Ye.canonical.x,Xe=Ye.canonical.y;for(const He of Ke){const Qe=se.getTile(xe?He.wrapped():He);if(!Qe)continue;const je=Qe.rasterParticleState;if(!je)continue;const it=He.canonical.x+(1<<He.canonical.z)*(He.wrap-Ye.wrap),_t=He.canonical.y;je.particleTexture0.bind(he.NEAREST,he.CLAMP_TO_EDGE);const yt=ad(1,je.particleTexture0.size[0],[it-Ie,_t-Xe],0,Je.texture.size,2,Ue,Je.textureOffset,Je.scale,Je.offset);De.draw(oe,he.POINTS,qt.disabled,li.disabled,Si.alphaBlended,ni.disabled,yt,fe.id,je.particleIndexBuffer,void 0,je.particleSegment)}}}(g,E,A,W),R.bindFramebuffer.set(A.particleFramebuffer.framebuffer),function(oe,se,fe,ce){const ue=oe.context,he=ue.gl,_e=se.paint.get("raster-particle-max-speed"),xe=ce*se.paint.get("raster-particle-speed-factor")*.15,Ue=function(Ye){return Math.pow(Ye,6)}(.01+1*se.paint.get("raster-particle-reset-rate-factor")),Le=se.particleFramebuffer;ue.viewport.set([0,0,Le.width,Le.height]);for(const Ye of fe){const[,Je,at]=Ye;ue.activeTexture.set(he.TEXTURE0+0),Je.texture.bind(he.LINEAR,he.CLAMP_TO_EDGE),ue.activeTexture.set(he.TEXTURE0+1);const De=at.particleTexture0;De.bind(he.NEAREST,he.CLAMP_TO_EDGE);const Ke=eg(1,De.size[0],0,Je.texture.size,_e,xe,Ue,Je.textureOffset,Je.scale,Je.offset);Le.colorAttachment.set(at.particleTexture1.texture),ue.clear({color:s.al.transparent}),oe.getOrCreateProgram("rasterParticleUpdate",{defines:Je.defines}).draw(oe,he.TRIANGLES,qt.disabled,li.disabled,Si.unblended,ni.disabled,Ke,se.id,oe.viewportBuffer,oe.quadTriangleIndexBuffer,oe.viewportSegments)}}(g,A,W,ie)}(u,t,r,c),u.renderPass==="translucent"&&(function(g,E,A,C,R){const L=g.context,O=L.gl,V=E.getSource().tileSize,H=5*(1-s.ae(s.bY,s.bY+1,g.transform.zoom))*V+A.paint.get("raster-particle-elevation"),G=!g.options.moving,W=g.transform.projection.name==="globe";if(!C.length)return;const[K,ie]=g.stencilConfigForOverlap(C),oe=[];W&&oe.push("PROJECTION_GLOBE_VIEW");const se=g.stencilModeFor3D();for(const fe of ie){const ce=fe.toUnwrapped(),ue=E.getTile(fe);if(!ue.rasterParticleState)continue;const he=ue.rasterParticleState,_e=100;ue.registerFadeDuration(_e);const xe=E.findLoadedParent(fe,0),Ue=pu(ue,xe,E,g.transform,_e);let Le,Ye;g.terrain&&g.terrain.prepareDrawTile(),L.activeTexture.set(O.TEXTURE0),he.targetColorTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE),L.activeTexture.set(O.TEXTURE1),xe&&xe.rasterParticleState?(xe.rasterParticleState.targetColorTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE),Le=Math.pow(2,xe.tileID.overscaledZ-ue.tileID.overscaledZ),Ye=[ue.tileID.canonical.x*Le%1,ue.tileID.canonical.y*Le%1]):he.targetColorTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE);const Je=W?Float32Array.from(g.transform.expandedFarZProjMatrix):g.transform.calculateProjMatrix(ce,G),at=g.transform,De=Cp(at),Ke=s.cF(fe.canonical),Ie=s.cG(Ke.getCenter().lat);let Xe,He,Qe,je,it;W?(Xe=Float32Array.from(s.bc(s.cI(fe.canonical))),He=Float32Array.from(at.globeMatrix),Qe=Float32Array.from(s.cE(at)),je=[s.av(at.center.lng),s.aC(at.center.lat)],it=Float32Array.from(s.cH(fe.canonical,Ke,Ie,at.worldSize/at._pixelsPerMercatorPixel))):(Xe=new Float32Array(16),He=new Float32Array(9),Qe=new Float32Array(16),je=[0,0],it=new Float32Array(9));const _t=$t(Je,Xe,He,Qe,it,Ye||[0,0],s.ag(g.transform.zoom),je,De,Le||1,Ue,H),yt=g.isTileAffectedByFog(fe),wt=g.getOrCreateProgram("rasterParticle",{defines:oe,overrideFog:yt});if(g.uploadCommonUniforms(L,wt,ce),W){const Ot=new qt(O.LEQUAL,qt.ReadOnly,g.depthRangeFor3D),si=0,Wt=g.globeSharedBuffers;if(Wt){const[ii,Yt,Ii]=Wt.getGridBuffers(Ie,si!==0);wt.draw(g,O.TRIANGLES,Ot,se,Si.alphaBlended,g.renderElevatedRasterBackface?ni.frontCCW:ni.backCCW,_t,A.id,ii,Yt,Ii)}}else{const Ot=g.depthModeForSublayer(0,qt.ReadOnly),si=K[fe.overscaledZ],{tileBoundsBuffer:Wt,tileBoundsIndexBuffer:ii,tileBoundsSegments:Yt}=g.getTileBoundsBuffers(ue);wt.draw(g,O.TRIANGLES,Ot,si,Si.alphaBlended,ni.disabled,_t,A.id,Wt,ii,Yt)}}g.resetStencilClippingMasks()}(u,t,r,c),u.style.map.triggerRepaint())},background:function(u,t,r,c){const d=r.paint.get("background-color"),m=r.paint.get("background-color-use-theme").constantOr("default")==="none",g=r.paint.get("background-opacity"),E=r.paint.get("background-emissive-strength"),A=r.paint.get("background-pitch-alignment")==="viewport";if(g===0)return;const C=u.context,R=C.gl,L=u.transform,O=L.tileSize,V=r.paint.get("background-pattern");let H;if(V!==void 0&&(V===null||(H=u.imageManager.getPattern(s.I.from(V.toString()),r.scope,u.style.getLut(r.scope)),!H)))return;const G=!V&&d.a===1&&g===1&&u.opaquePassEnabledForLayer()?"opaque":"translucent";if(u.renderPass!==G)return;const W=li.disabled,K=u.depthModeForSublayer(0,G==="opaque"?qt.ReadWrite:qt.ReadOnly),ie=u.colorModeForDrapableLayerRenderPass(E),oe=V?"backgroundPattern":"background";let se,fe=c;if(fe||(se=u.getBackgroundTiles(),fe=Object.values(se).map(ce=>ce.tileID)),V&&(C.activeTexture.set(R.TEXTURE0),u.imageManager.bind(u.context,r.scope)),A){const ce=u.getOrCreateProgram(oe,{overrideFog:!1,overrideRtt:!0}),ue=new Float32Array(s.ad.mat4.identity([])),he=new s.aH(0,0,0,0,0),_e=V?Sp(ue,E,g,u,0,r.scope,H,A,{tileID:he,tileSize:O}):ld(ue,E,g,d.toRenderColor(m?null:r.lut));ce.draw(u,R.TRIANGLES,K,W,ie,ni.disabled,_e,r.id,u.viewportBuffer,u.quadTriangleIndexBuffer,u.viewportSegments)}else for(const ce of fe){const ue=u.isTileAffectedByFog(ce),he=u.getOrCreateProgram(oe,{overrideFog:ue}),_e=ce.toUnwrapped(),xe=c?ce.projMatrix:u.transform.calculateProjMatrix(_e);u.prepareDrawTile();const Ue=t?t.getTile(ce):se?se[ce.key]:new Ls(ce,O,L.zoom,u),Le=V?Sp(xe,E,g,u,0,r.scope,H,A,{tileID:ce,tileSize:O}):ld(xe,E,g,d.toRenderColor(m?null:r.lut));u.uploadCommonUniforms(C,he,_e);const{tileBoundsBuffer:Ye,tileBoundsIndexBuffer:Je,tileBoundsSegments:at}=u.getTileBoundsBuffers(Ue);he.draw(u,R.TRIANGLES,K,W,ie,ni.disabled,Le,r.id,Ye,Je,at)}},sky:function(u,t,r){const c=u._atmosphere?s.ag(u.transform.zoom):1,d=r.paint.get("sky-opacity")*c;if(d===0)return;const m=u.context,g=r.paint.get("sky-type"),E=new qt(m.gl.LEQUAL,qt.ReadOnly,[0,1]),A=u.frameCounter/1e3%1;g==="atmosphere"?u.renderPass==="offscreen"?r.needsSkyboxCapture(u)&&(function(C,R,L,O){const V=C.context,H=V.gl;let G=R.skyboxFbo;if(!G){G=R.skyboxFbo=V.createFramebuffer(32,32,!0,null),R.skyboxGeometry=new Rp(V),R.skyboxTexture=V.gl.createTexture(),H.bindTexture(H.TEXTURE_CUBE_MAP,R.skyboxTexture),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_S,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_T,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MIN_FILTER,H.LINEAR),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MAG_FILTER,H.LINEAR);for(let oe=0;oe<6;++oe)H.texImage2D(H.TEXTURE_CUBE_MAP_POSITIVE_X+oe,0,H.RGBA,32,32,0,H.RGBA,H.UNSIGNED_BYTE,null)}V.bindFramebuffer.set(G.framebuffer),V.viewport.set([0,0,32,32]);const W=R.getCenter(C,!0),K=C.getOrCreateProgram("skyboxCapture"),ie=new Float64Array(16);s.ad.mat4.identity(ie),s.ad.mat4.rotateY(ie,ie,.5*-Math.PI),un(C,R,K,ie,W,0),s.ad.mat4.identity(ie),s.ad.mat4.rotateY(ie,ie,.5*Math.PI),un(C,R,K,ie,W,1),s.ad.mat4.identity(ie),s.ad.mat4.rotateX(ie,ie,.5*-Math.PI),un(C,R,K,ie,W,2),s.ad.mat4.identity(ie),s.ad.mat4.rotateX(ie,ie,.5*Math.PI),un(C,R,K,ie,W,3),s.ad.mat4.identity(ie),un(C,R,K,ie,W,4),s.ad.mat4.identity(ie),s.ad.mat4.rotateY(ie,ie,Math.PI),un(C,R,K,ie,W,5),V.viewport.set([0,0,C.width,C.height])}(u,r),r.markSkyboxValid(u)):u.renderPass==="sky"&&function(C,R,L,O,V){const H=C.context,G=H.gl,W=C.transform,K=C.getOrCreateProgram("skybox");H.activeTexture.set(G.TEXTURE0),G.bindTexture(G.TEXTURE_CUBE_MAP,R.skyboxTexture);const ie=((oe,se,fe,ce,ue)=>({u_matrix:oe,u_sun_direction:se,u_cubemap:0,u_opacity:ce,u_temporal_offset:ue}))(W.skyboxMatrix,R.getCenter(C,!1),0,O,V);C.uploadCommonUniforms(H,K),K.draw(C,G.TRIANGLES,L,li.disabled,C.colorModeForRenderPass(),ni.backCW,ie,"skybox",R.skyboxGeometry.vertexBuffer,R.skyboxGeometry.indexBuffer,R.skyboxGeometry.segment)}(u,r,E,d,A):g==="gradient"&&u.renderPass==="sky"&&function(C,R,L,O,V){const H=C.context,G=H.gl,W=C.transform,K=C.getOrCreateProgram("skyboxGradient");R.skyboxGeometry||(R.skyboxGeometry=new Rp(H)),H.activeTexture.set(G.TEXTURE0);let ie=R.colorRampTexture;ie||(ie=R.colorRampTexture=new s.T(H,R.colorRamp,G.RGBA8)),ie.bind(G.LINEAR,G.CLAMP_TO_EDGE);const oe=((se,fe,ce,ue,he)=>({u_matrix:se,u_color_ramp:0,u_center_direction:fe,u_radius:s.ak(ce),u_opacity:ue,u_temporal_offset:he}))(W.skyboxMatrix,R.getCenter(C,!1),R.paint.get("sky-gradient-radius"),O,V);C.uploadCommonUniforms(H,K),K.draw(C,G.TRIANGLES,L,li.disabled,C.colorModeForRenderPass(),ni.backCW,oe,"skyboxGradient",R.skyboxGeometry.vertexBuffer,R.skyboxGeometry.indexBuffer,R.skyboxGeometry.segment)}(u,r,E,d,A)},debug:function(u,t,r,c,d,m){for(let g=0;g<r.length;g++)if(d){const C=new s.al(c.r*.8,c.g*.8,c.b*.8,1);Uo(u,t,r[g],c,-1,-1,m),Uo(u,t,r[g],c,-1,1,m),Uo(u,t,r[g],c,1,1,m),Uo(u,t,r[g],c,1,-1,m),Uo(u,t,r[g],C,0,0,m)}else Uo(u,t,r[g],c,0,0,m)},custom:function(u,t,r,c){const d=u.context,m=r.implementation;if(!u.transform.projection.unsupportedLayers||!u.transform.projection.unsupportedLayers.includes("custom")||u.terrain&&(u.terrain.renderingToTexture||u.renderPass==="offscreen")&&r.isDraped(t)){if(u.renderPass==="offscreen"){const g=m.prerender;if(g){if(u.setCustomLayerDefaults(),d.setColorMode(u.colorModeForRenderPass()),u.transform.projection.name==="globe"){const E=u.transform.pointMerc;g.call(m,d.gl,u.transform.customLayerMatrix(),u.transform.getProjection(),u.transform.globeToMercatorMatrix(),s.ag(u.transform.zoom),[E.x,E.y],u.transform.pixelsPerMeterRatio)}else g.call(m,d.gl,u.transform.customLayerMatrix());d.setDirty(),u.setBaseState()}}else if(u.renderPass==="translucent"){if(u.terrain&&u.terrain.renderingToTexture){const E=m.renderToTile;if(E){const A=c[0].canonical,C=new s.ac(A.x+c[0].wrap*(1<<A.z),A.y,A.z);d.setDepthMode(qt.disabled),d.setStencilMode(li.disabled),d.setColorMode(u.colorModeForRenderPass()),u.setCustomLayerDefaults(),E.call(m,d.gl,C),d.setDirty(),u.setBaseState()}return}u.setCustomLayerDefaults(),d.setColorMode(u.colorModeForRenderPass()),d.setStencilMode(li.disabled);const g=m.renderingMode==="3d"?new qt(u.context.gl.LEQUAL,qt.ReadWrite,u.depthRangeFor3D):u.depthModeForSublayer(0,qt.ReadOnly);if(d.setDepthMode(g),u.transform.projection.name==="globe"){const E=u.transform.pointMerc;m.render(d.gl,u.transform.customLayerMatrix(),u.transform.getProjection(),u.transform.globeToMercatorMatrix(),s.ag(u.transform.zoom),[E.x,E.y],u.transform.pixelsPerMeterRatio)}else m.render(d.gl,u.transform.customLayerMatrix());d.setDirty(),u.setBaseState(),d.bindFramebuffer.set(null)}}else s.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(u,t,r,c){if(u.renderPass==="opaque")return;const d=r.paint.get("model-opacity").constantOr(1);if(d===0)return;const m=r.paint.get("model-cast-shadows");if(u.renderPass==="shadow"&&(!m||u.terrain&&d<.65&&r._transitionablePaint._values["model-opacity"].value.expression instanceof s.ab))return;const g=u.shadowRenderer,E=r.paint.get("model-receive-shadows");g&&(g.useNormalOffset=!0,E||(g.enabled=!1));const A=()=>{g&&(g.useNormalOffset=!0,E||(g.enabled=!0))},C=t.getSource();if(u.renderPass==="light-beam"&&C.type!=="batched-model")return;if(C.type==="vector"||C.type==="geojson")return function(K,ie,oe,se,fe){const ce=K.transform;if(ce.projection.name!=="mercator")return void s.w(`Drawing 3D models for ${ce.projection.name} projection is not yet implemented`);const ue=ce.getFreeCameraOptions().position;if(!K.modelManager)return;const he=K.modelManager;oe.modelManager=he;const _e=K.shadowRenderer;if(!oe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const xe=oe._unevaluatedLayout._values["model-id"],Ue=Object.assign({},oe.layout.get("model-id").parameters),Le=K.style.order.indexOf(oe.fqid);for(const Ye of se){const Je=ie.getTile(Ye).getBucket(oe);if(!Je||Je.projection.name!==ce.projection.name)continue;const at=Je.getModelUris();at&&!Je.modelsRequested&&(he.addModelsFromBucket(at,fe),Je.modelsRequested=!0);const De=xd(Ye,ce);Ue.zoom=De;const Ke=xe.possiblyEvaluate(Ue);if(vd(K,Je,Ye),Ss.shadowUniformsInitialized=!1,Ss.useSingleShadowCascade=!!_e&&_e.getMaxCascadeForTile(Ye.toUnwrapped())===0,K.renderPass==="shadow"&&_e){if(K.currentShadowCascade===1&&Je.isInsideFirstShadowMapFrustum)continue;const He=ce.calculatePosMatrix(Ye.toUnwrapped(),ce.worldSize);if(Ss.tileMatrix.set(He),Ss.shadowTileMatrix=Float32Array.from(_e.calculateShadowPassMatrixFromMatrix(He)),Ss.aabb.min.fill(0),Ss.aabb.max[0]=Ss.aabb.max[1]=s.ai,Ss.aabb.max[2]=0,Cu(Je,Ss,K,oe.scope))continue}const Ie=1<<Ye.canonical.z,Xe=[((ue.x-Ye.wrap)*Ie-Ye.canonical.x)*s.ai,(ue.y*Ie-Ye.canonical.y)*s.ai,ue.z*Ie*s.ai];K.conflationActive&&Object.keys(Je.instancesPerModel).length>0&&K.style.isLayerClipped(oe,ie.getSource())&&Je.updateReplacement(Ye,K.replacementSource,Le,fe)&&(Je.uploaded=!1,Je.upload(K.context));for(let He in Je.instancesPerModel){const Qe=Je.instancesPerModel[He];Qe.features.length>0&&(He=Ke.evaluate(Qe.features[0].feature,{}));const je=he.getModel(He,fe);if(je&&je.uploaded)for(const it of je.nodes)Bs(K,oe,it,Qe,Xe,Ye,Ss)}}}(u,t,r,c,C.type==="vector"?r.scope:""),void A();if(!C.loaded())return;if(C.type==="batched-model")return function(K,ie,oe,se){oe.resetLayerRenderingStats(K);const fe=K.context,ce=K.transform,ue=K.style.fog,he=K.shadowRenderer;if(ce.projection.name!=="mercator")return void s.w(`Drawing 3D landmark models for ${ce.projection.name} projection is not yet implemented`);const _e=K.transform.getFreeCameraOptions().position,xe=s.ad.vec3.scale([],[_e.x,_e.y,_e.z],K.transform.worldSize),Ue=s.ad.vec3.negate([],xe),Le=s.ad.mat4.identity([]),Ye=s.dm(ce.center.lat,ce.zoom),Je=s.ad.mat4.fromScaling([],[1,1,1/Ye]);s.ad.mat4.translate(Le,Le,Ue);const at=oe.paint.get("model-opacity").constantOr(1),De=new qt(fe.gl.LEQUAL,qt.ReadWrite,K.depthRangeFor3D),Ke=new qt(fe.gl.LEQUAL,qt.ReadOnly,K.depthRangeFor3D),Ie=new s.ce([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Xe=K.renderPass==="shadow",He=Xe&&he?he.getCurrentCascadeFrustum():ce.getFrustum(ce.scaleZoom(ce.worldSize)),Qe=oe.paint.get("model-front-cutoff"),je=Qe[2]<1,it=fo(K,oe.paint.get("model-cutoff-fade-range")),_t=oe.getLayerRenderingStats();(function(yt,wt,Ot,si){const Wt=yt.terrain?yt.terrain.exaggeration():0,ii=yt.transform.zoom;for(const Yt of si){const Ii=wt.getTile(Yt).getBucket(Ot);Ii&&(Ii.setFilter(Ot.filter),yt.conflationActive&&Ii.updateReplacement(Yt,yt.replacementSource),Ii.evaluateScale(yt,Ot),yt.terrain&&Wt>0&&Ii.elevationUpdate(yt.terrain,Wt,Yt,Ot.source),Ii.needsReEvaluation(yt,ii,Ot)&&Ii.evaluate(Ot))}})(K,ie,oe,se),function(){let yt,wt,Ot;je?(yt=se.length-1,wt=-1,Ot=-1):(yt=0,wt=se.length,Ot=1);const si=new Float64Array(16),Wt=s.ad.vec3.create(),ii=new s.P(0,0);for(let Yt=yt;Yt!==wt;Yt+=Ot){const Ii=se[Yt],Wi=ie.getTile(Ii).getBucket(oe);if(!Wi||!Wi.uploaded)continue;let dr=!1;he&&(dr=he.getMaxCascadeForTile(Ii.toUnwrapped())===0);const wi=ce.calculatePosMatrix(Ii.toUnwrapped(),ce.worldSize),Sr=Wi.modelTraits;!Xe&&je&&(s.ad.mat4.invert(si,wi),s.ad.vec3.transformMat4(Wt,xe,si),ii.x=Wt[0],ii.y=Wt[1]);const ci=[];Wi.setFilter(oe.filter);for(const kt of Wi.getNodesInfo()){if(kt.hiddenByReplacement||!kt.node.meshes)continue;const Ri=kt.node;let ir=0;K.terrain&&Ri.elevation&&(ir=Ri.elevation*K.terrain.exaggeration());const Bi=(()=>{const lr=kt.aabb;return Ie.min=[...lr.min],Ie.max=[...lr.max],Ie.min[2]+=ir,Ie.max[2]+=ir,s.ad.vec3.transformMat4(Ie.min,Ie.min,wi),s.ad.vec3.transformMat4(Ie.max,Ie.max,wi),Ie})(),Rr=kt.evaluatedScale;if(Rr[0]<=1&&Rr[1]<=1&&Rr[2]<=1&&Bi.intersects(He)===0)continue;if(!Xe&&je){const lr=.16666666666666666;kt.cameraCollisionOpacity=xe[0]>Bi.min[0]&&xe[0]<Bi.max[0]&&xe[1]>Bi.min[1]&&xe[1]<Bi.max[1]&&xe[2]*Ye<Bi.max[2]&&Ri.footprint&&s.bA(ii,Ri.footprint)?Math.max(kt.cameraCollisionOpacity-lr,0):Math.min(1,kt.cameraCollisionOpacity+lr)}const $r=[...wi],tn=Ri.anchor?Ri.anchor[0]:0,nn=Ri.anchor?Ri.anchor[1]:0;s.ad.mat4.translate($r,$r,[tn*(Rr[0]-1),nn*(Rr[1]-1),ir]),s.ad.vec3.exactEquals(Rr,s.dq)||s.ad.mat4.scale($r,$r,Rr);const ds=s.ad.mat4.multiply([],$r,Ri.matrix),Pn=s.ad.mat4.multiply([],ce.expandedFarZProjMatrix,ds),Li=s.ad.mat4.multiply([],ce.expandedFarZProjMatrix,$r),Er=s.ad.vec4.transformMat4([],[tn,nn,ir,1],Pn)[2];Ri.hidden=!1;let Xi=at;Xe||(je&&(Xi*=kt.cameraCollisionOpacity,Xi*=bd($r,ce,kt.aabb,Qe)),Xi*=Pu(it,Er)),Xi!==0?ci.push({nodeInfo:kt,depth:Er,opacity:Xi,wvpForNode:Pn,wvpForTile:Li,nodeModelMatrix:ds,tileModelMatrix:$r}):Ri.hidden=!0}Xe||ci.sort((kt,Ri)=>!je||kt.opacity===1&&Ri.opacity===1?kt.depth<Ri.depth?-1:1:kt.opacity===1?-1:Ri.opacity===1?1:kt.depth>Ri.depth?-1:1);for(const kt of ci){const Ri=kt.nodeInfo,ir=Ri.node;let Bi=s.ad.mat4.multiply([],Je,kt.tileModelMatrix);s.ad.mat4.multiply(Bi,Le,Bi);const Rr=s.ad.mat4.invert([],Bi);s.ad.mat4.transpose(Rr,Rr),s.ad.mat4.scale(Rr,Rr,jo),Bi=s.ad.mat4.multiply(Bi,Bi,ir.matrix);const $r=K.renderPass==="light-beam",tn=oe.paint.get("model-color-use-theme").constantOr("default")==="none",nn=Sr&s.ds.HasMapboxMeshFeatures,ds=nn?0:Ri.evaluatedRMEA[0][2];for(let Pn=0;Pn<ir.meshes.length;++Pn){const Li=ir.meshes[Pn],Er=Pn===ir.lightMeshIndex;let Xi=kt.wvpForNode;if(Er){if(!$r&&!K.terrain&&K.shadowRenderer){K.currentLayer<K.firstLightBeamLayer&&(K.firstLightBeamLayer=K.currentLayer);continue}Xi=kt.wvpForTile}else if($r)continue;const lr={defines:[]},pn=[];if(!Xe&&he&&(he.useNormalOffset=!!Li.normalBuffer),ul(lr.defines,pn,Li,K,tn?null:oe.lut),nn||lr.defines.push("DIFFUSE_SHADED"),dr&&lr.defines.push("SHADOWS_SINGLE_CASCADE"),_t&&(Xe?_t.numRenderedVerticesInShadowPass+=Li.vertexArray.length:_t.numRenderedVerticesInTransparentPass+=Li.vertexArray.length),Xe){cc(Li,kt.nodeModelMatrix,K,oe);continue}let yr=null;if(ue){const As=yo(kt.nodeModelMatrix,K.transform);if(yr=new Float32Array(As),ce.projection.name!=="globe"){const Jn=Li.aabb.min,bo=Li.aabb.max,[Qs,wo]=ue.getOpacityForBounds(As,Jn[0],Jn[1],bo[0],bo[1]);lr.overrideFog=Qs>=Mt||wo>=Mt}}const rn=Li.material;let Js;rn.occlusionTexture&&rn.occlusionTexture.offsetScale&&(Js=rn.occlusionTexture.offsetScale,lr.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const Yn=K.getOrCreateProgram("model",lr);!Xe&&he&&he.setupShadowsFromMatrix(kt.tileModelMatrix,Yn,he.useNormalOffset),K.uploadCommonUniforms(fe,Yn,null,yr);const Ms=rn.pbrMetallicRoughness;Ms.metallicFactor=.9,Ms.roughnessFactor=.5;const Gn=cd(new Float32Array(Xi),new Float32Array(Bi),new Float32Array(Rr),new Float32Array(ir.matrix),K,kt.opacity,Ms.baseColorFactor.toRenderColor(null),rn.emissiveFactor,Ms.metallicFactor,Ms.roughnessFactor,rn,ds,oe,[0,0,0],Js);!Er&&(Ri.hasTranslucentParts||kt.opacity<1)&&Yn.draw(K,fe.gl.TRIANGLES,De,li.disabled,Si.disabled,ni.backCCW,Gn,oe.id,Li.vertexBuffer,Li.indexBuffer,Li.segments,oe.paint,K.transform.zoom,void 0,pn),Yn.draw(K,fe.gl.TRIANGLES,Er?Ke:De,li.disabled,Er||kt.opacity<1||Ri.hasTranslucentParts?Si.alphaBlended:Si.unblended,ni.backCCW,Gn,oe.id,Li.vertexBuffer,Li.indexBuffer,Li.segments,oe.paint,K.transform.zoom,void 0,pn)}}}}()}(u,t,r,c),void A();if(C.type!=="model")return;const R=C.getModels(),L=[],O=u.transform.getFreeCameraOptions().position,V=s.ad.vec3.scale([],[O.x,O.y,O.z],u.transform.worldSize);s.ad.vec3.negate(V,V);const H=[],G=[];let W=0;for(const K of R){const ie=r.paint.get("model-rotation").constantOr(null),oe=r.paint.get("model-scale").constantOr(null),se=r.paint.get("model-translation").constantOr(null);K.computeModelMatrix(u,ie,oe,se,!0,!0,!1);const fe=s.ad.mat4.identity([]),ce=s.dm(K.position.lat,u.transform.zoom),ue=s.ad.mat4.fromScaling([],[1,1,1/ce]);s.ad.mat4.translate(fe,fe,V),L.push({zScaleMatrix:ue,negCameraPosMatrix:fe});for(const he of K.nodes)pa(u.transform,he,K.matrix,u.transform.expandedFarZProjMatrix,W,H,G);W++}if(H.sort((K,ie)=>ie.depth-K.depth),u.renderPass!=="shadow"){if(d===1)for(const K of G)vo(K,u,r,L[K.modelIndex],li.disabled,u.colorModeForRenderPass());else{for(const K of G)vo(K,u,r,L[K.modelIndex],li.disabled,Si.disabled);for(const K of G)vo(K,u,r,L[K.modelIndex],u.stencilModeFor3D(),u.colorModeForRenderPass());u.resetStencilClippingMasks()}for(const K of H)vo(K,u,r,L[K.modelIndex],li.disabled,u.colorModeForRenderPass());A()}else{for(const K of G)cc(K.mesh,K.nodeModelMatrix,u,r);for(const K of H)cc(K.mesh,K.nodeModelMatrix,u,r);A()}}},Lu={line:function(u,t,r){if(u.hasElevatedBuckets=!1,u.hasNonElevatedBuckets=!1,u._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||u._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const c=t.getVisibleCoordinates();for(const d of c){const m=t.getTile(d).getBucket(u);if(m&&(m.hasZOffset?u.hasElevatedBuckets=!0:u.hasNonElevatedBuckets=!0,u.hasElevatedBuckets&&u.hasNonElevatedBuckets))break}}}else u.hasNonElevatedBuckets=!0},model:function(u,t,r){const c=t.getSource();if(!c.loaded())return;if(c.type==="vector"||c.type==="geojson")return void(r.modelManager&&r.modelManager.upload(r,c.type==="vector"?u.scope:""));if(c.type==="batched-model"||c.type!=="model")return;const d=c.getModels();for(const m of d)m.upload(r.context)},raster:function(u,t,r){const c=t.getSource();if(!(c instanceof so&&c.loaded()))return;const d=u.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const m=u.paint.get("raster-array-band")||c.getInitialBand(d);if(m==null)return;const g=t.getIds().map(E=>t.getTileByID(E));for(const E of g)E.updateNeeded(d,m)&&c.prepareTile(E,d,m)},"raster-particle":function(u,t,r){const c=t.getSource();if(!(c instanceof so&&c.loaded()))return;const d=u.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const m=u.paint.get("raster-particle-array-band")||c.getInitialBand(d);if(m==null)return;const g=t.getIds().map(E=>t.getTileByID(E));for(const E of g)E.updateNeeded(d,m)&&c.prepareTile(E,d,m)}},Ou={fill:pd};class ku{constructor(t,r,c,d,m){this.context=new Vo(t,r),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=m,this._timeStamp=s.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const g=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const A of g)this._debugParams.enabledLayers[A]=!0;m.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),m.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),m.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),m.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),m.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),m.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const A of g)m.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],A);this.occlusionParams=new Td(m),this.setup(),this.numSublayers=xs.maxUnderzooming+xs.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new s.dy,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new po(this),this._wireframeDebugCache=new ma,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const E=new s.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new s.T(this.context,E,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=d}updateTerrain(t,r){const c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new yp(this,t));const d=this._terrain;this.transform.elevation=c?d:null,d.update(t,this.transform,r),this.transform.elevation&&!d.enabled&&(this.transform.elevation=null)}_updateFog(t){const r=t.fog;if(!r||this.transform.projection.name==="globe"||r.getOpacity(this.transform.pitch)<1||r.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[c,d]=r.getFovAdjustedRange(this.transform._fov);if(c>d)return void(this.transform.fogCullDistSq=null);const m=c+.78*(d-c);this.transform.fogCullDistSq=m*m}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new yp(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,r){if(this.width=t*s.q.devicePixelRatio,this.height=r*s.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const c of this.style.order)this.style._mergedLayers[c].resize()}setup(){const t=this.context,r=new s.b5;r.emplaceBack(0,0),r.emplaceBack(s.ai,0),r.emplaceBack(0,s.ai),r.emplaceBack(s.ai,s.ai),this.tileExtentBuffer=t.createVertexBuffer(r,s.b7.members),this.tileExtentSegments=s.b8.simpleSegment(0,0,4,2);const c=new s.b5;c.emplaceBack(0,0),c.emplaceBack(s.ai,0),c.emplaceBack(0,s.ai),c.emplaceBack(s.ai,s.ai),this.debugBuffer=t.createVertexBuffer(c,s.b7.members),this.debugSegments=s.b8.simpleSegment(0,0,4,5);const d=new s.b5;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(-1,1),d.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(d,s.b7.members),this.viewportSegments=s.b8.simpleSegment(0,0,4,2);const m=new s.aU;m.emplaceBack(0,0,0,0),m.emplaceBack(s.ai,0,s.ai,0),m.emplaceBack(0,s.ai,0,s.ai),m.emplaceBack(s.ai,s.ai,s.ai,s.ai),this.mercatorBoundsBuffer=t.createVertexBuffer(m,s.ba.members),this.mercatorBoundsSegments=s.b8.simpleSegment(0,0,4,2);const g=new s.aV;g.emplaceBack(0,1,2),g.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(g);const E=new s.b6;for(const C of[0,1,3,2,0])E.emplaceBack(C);this.debugIndexBuffer=t.createIndexBuffer(E),this.emptyTexture=new s.T(t,new s.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=s.ad.mat4.create();const A=this.context.gl;this.stencilClearMode=new li({func:A.ALWAYS,mask:0},0,255,A.ZERO,A.ZERO,A.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,qt.disabled,this.stencilClearMode,Si.disabled,ni.disabled,Ja(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,r,c){if(!r||this.currentStencilSource===r.id||!t.isTileClipped()||!c||c.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let E=!1;for(const A of c)if(this._tileClippingMaskIDs[A.key]===void 0){E=!0;break}if(!E)return}this.currentStencilSource=r.id;const d=this.context,m=d.gl;this.nextStencilID+c.length>256&&this.clearStencil(),d.setColorMode(Si.disabled),d.setDepthMode(qt.disabled);const g=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const E of c){const A=r.getTile(E),C=this._tileClippingMaskIDs[E.key]=this.nextStencilID++,{tileBoundsBuffer:R,tileBoundsIndexBuffer:L,tileBoundsSegments:O}=this.getTileBoundsBuffers(A);g.draw(this,m.TRIANGLES,qt.disabled,new li({func:m.ALWAYS,mask:0},C,255,m.KEEP,m.KEEP,m.REPLACE),Si.disabled,ni.disabled,Ja(E.projMatrix),"$clipping",R,L,O)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,r=this.context.gl;return new li({func:r.NOTEQUAL,mask:255},t,255,r.KEEP,r.KEEP,r.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const r=this.context.gl;return new li({func:r.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,r.KEEP,r.KEEP,r.REPLACE)}stencilConfigForOverlap(t){const r=this.context.gl,c=t.sort((g,E)=>E.overscaledZ-g.overscaledZ),d=c[c.length-1].overscaledZ,m=c[0].overscaledZ-d+1;if(m>1){this.currentStencilSource=void 0,this.nextStencilID+m>256&&this.clearStencil();const g={};for(let E=0;E<m;E++)g[E+d]=new li({func:r.GEQUAL,mask:255},E+this.nextStencilID,255,r.KEEP,r.KEEP,r.REPLACE);return this.nextStencilID+=m,[g,c]}return[{[d]:li.disabled},c]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new Si([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new s.al(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Si.unblended:Si.alphaBlended}colorModeForDrapableLayerRenderPass(t){const r=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new Si([r.ONE,r.ONE_MINUS_SRC_ALPHA,r.CONSTANT_ALPHA,r.ONE_MINUS_SRC_ALPHA],new s.al(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,r,c,d=!1){if(this.depthOcclusion)return new qt(this.context.gl.GREATER,qt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!d)return qt.disabled;const m=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new qt(c||this.context.gl.LEQUAL,r,[m,m])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,r=Math.ceil(this.width),c=Math.ceil(this.height),d=this.context.bindFramebuffer.get(),m=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===r&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),r!==0&&c!==0&&(this.depthFBO=new Un(this.context,r,c,!1,"texture"),this.depthTexture=new s.T(this.context,{width:r,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(d),t.bindTexture(t.TEXTURE_2D,m),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,r,c,0,0,r,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,r)=>t+r/this._fpsHistory.length,0))}render(t,r){const c=s.q.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=r;const d=this.style._mergedLayers,m=!(!this.terrain||!this.terrain.enabled),g=()=>this.style._getOrder(m).filter(De=>{const Ke=d[De];return!(Ke.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Ke.type]});let E=g(),A=!1,C=!1;for(const De of E){const Ke=d[De];Ke.type==="circle"&&(A=!0),Ke.type==="symbol"&&(Ke.hasInitialOcclusionOpacityProperties?C=!0:A=!0)}let R=E.map(De=>d[De]);const L=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(s.q.now()),this.imageManager.beginFrame();let O=0,V=!1;for(const De in L){const Ke=L[De];Ke.used&&(Ke.prepare(this.context),Ke.getSource().usedInConflation&&++O)}let H=!1;for(const De of R)De.isHidden(this.transform.zoom)||(De.type==="clip"&&(H=!0),this.prepareLayer(De));const G={},W={},K={},ie={},oe={};for(const De in L){const Ke=L[De];G[De]=Ke.getVisibleCoordinates(),W[De]=G[De].slice().reverse(),K[De]=Ke.getVisibleCoordinates(!0).reverse(),ie[De]=Ke.getShadowCasterCoordinates(),oe[De]=Ke.sortCoordinatesByDistance(G[De])}const se=De=>{const Ke=this.style.getLayerSourceCache(De);return Ke&&Ke.used?Ke.getSource():null};if(O||H||this._clippingActiveLastFrame){const De=[],Ke=[];let Ie=0;for(const Xe of R)this.isSourceForClippingOrConflation(Xe,se(Xe))&&(De.push(Xe),Ke.push(Ie)),Ie++;if(De&&(H||De.length>1)||this._clippingActiveLastFrame){H=!1;const Xe=[];for(let He=0;He<De.length;He++){const Qe=De[He],je=Ke[He],it=this.style.getLayerSourceCache(Qe);if(!it||!it.used||!it.getSource().usedInConflation&&Qe.type!=="clip")continue;let _t=s.dA,yt=s.by.None;const wt=[];let Ot=!0;if(Qe.type==="clip"){_t=je;for(const si of Qe.layout.get("clip-layer-types"))yt|=si==="model"?s.by.Model:si==="symbol"?s.by.Symbol:s.by.FillExtrusion;for(const si of Qe.layout.get("clip-layer-scope"))wt.push(si);Qe.isHidden(this.transform.zoom)?Ot=!1:H=!0}Ot&&Xe.push({layer:Qe.fqid,cache:it,order:_t,clipMask:yt,clipScope:wt})}this.replacementSource.setSources(Xe),V=!0}}this._clippingActiveLastFrame=H,V||this.replacementSource.clear(),this.conflationActive=V,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let De=0;De<R.length;De++){const Ke=R[De],Ie=Ke.cutoffRange();if(this.longestCutoffRange=Math.max(Ie,this.longestCutoffRange),Ie>0){const Xe=se(Ke);Xe&&(this.minCutoffZoom=Math.max(Xe.minzoom,this.minCutoffZoom)),Ke.minzoom&&(this.minCutoffZoom=Math.max(Ke.minzoom,this.minCutoffZoom))}Ke.is3D(m)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=De),this._lastOcclusionLayer=De)}const fe=this.style&&this.style.fog;fe?(this._fogVisible=fe.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=fe.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(K),this.opaquePassCutoff=0,E=g(),R=E.map(De=>d[De]));const ce=this._shadowRenderer;if(ce){ce.updateShadowParameters(this.transform,this.style.directionalLight);for(const De in L)for(const Ke of G[De]){let Ie={min:0,max:0};this.terrain&&(Ie=this.terrain.getMinMaxForTile(Ke)||Ie),ce.addShadowReceiver(Ke.toUnwrapped(),Ie.min,Ie.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new s.dz(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Dp(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const ue=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),he=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(ue&&!this._snow&&(this._snow=new hl(this)),!ue&&this._snow&&(this._snow.destroy(),delete this._snow),he&&!this._rain&&(this._rain=new Ad(this)),!he&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!pr.has(this.context.gl))return;this.renderPass="offscreen";for(const De of R){const Ke=t.getLayerSourceCache(De);if(!De.hasOffscreenPass()||De.isHidden(this.transform.zoom))continue;const Ie=Ke?W[Ke.id]:void 0;(De.type==="custom"||De.type==="raster"||De.type==="raster-particle"||De.isSky()||Ie&&Ie.length)&&this.renderLayer(this,Ke,De,Ie)}this.depthRangeFor3D=[0,1-(R.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,ie)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const _e=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),xe=(()=>{if(r.showOverdrawInspector)return s.al.black;const De=this.style.fog;if(De&&this.transform.projection.supportsFog){const Ke=this.style.getLut(De.scope);if(!_e){const Ie=De.properties.get("color-use-theme")==="none",Xe=De.properties.get("color").toRenderColor(Ie?null:Ke).toArray01();return new s.al(...Xe)}if(_e){const Ie=De.properties.get("space-color-use-theme")==="none",Xe=De.properties.get("space-color").toRenderColor(Ie?null:Ke).toArray01();return new s.al(...Xe)}}return s.al.transparent})();if(this.context.clear({color:xe,depth:1}),this.clearStencil(),this._showOverdrawInspector=r.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&_e&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=E.length-1;this.currentLayer>=0;this.currentLayer--){const De=R[this.currentLayer],Ke=t.getLayerSourceCache(De);if(De.isSky())continue;const Ie=Ke?(De.is3D(m)?oe:W)[Ke.id]:void 0;this._renderTileClippingMasks(De,Ke,Ie),this.renderLayer(this,Ke,De,Ie)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&_e&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||s.ag(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<E.length;this.currentLayer++){const De=R[this.currentLayer],Ke=t.getLayerSourceCache(De);De.isSky()&&this.renderLayer(this,Ke,De,Ke?W[Ke.id]:void 0)}function Ue(De,Ke){let Ie;return Ke&&(Ie=(De.type==="symbol"?K:De.is3D(m)?oe:W)[Ke.id]),Ie}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<E.length;){const De=R[this.currentLayer];if(De.type==="raster"||De.type==="raster-particle"){const Ke=t.getLayerSourceCache(De);this.renderLayer(this,Ke,De,Ue(De,Ke))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Le=0;ce&&(Le=ce.getShadowCastingLayerCount());let Ye=!1,Je=-1;for(let De=0;De<E.length;++De){const Ke=R[De];Ke.isHidden(this.transform.zoom)||Ke.is3D(m)&&(Je=De)}C&&Je===-1&&(A=!0);let at=!1;for(;this.currentLayer<E.length;){const De=R[this.currentLayer],Ke=t.getLayerSourceCache(De);if(De.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(De)){if(De.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!at&&De.is3D(m)&&!m){const Ie=this.currentLayer,Xe=He=>{for(this.currentLayer=0;this.currentLayer<R.length;this.currentLayer++){const Qe=R[this.currentLayer];if(Ou[Qe.type]){const je=this.style.getLayerSourceCache(Qe);Ou[Qe.type](this,je,Qe,Ue(Qe,je),He)}}};Xe("initialize"),Xe("reset"),this.currentLayer=Ie,at=!0}if(A&&!Ye&&this.terrain&&!this.transform.isOrthographic&&(Ye=!0,this.blitDepth()),C&&Je!==-1&&this.currentLayer===Je+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(De,Ke,Ke?G[Ke.id]:void 0),this.renderLayer(this,Ke,De,Ue(De,Ke)),!this.terrain&&ce&&Le>0&&De.hasShadowPass()&&--Le==0&&(ce.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const Ie=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Ie;this.currentLayer++){const Xe=R[this.currentLayer];if(!Xe.hasLightBeamPass())continue;const He=t.getLayerSourceCache(Xe);this.renderLayer(this,He,Xe,He?W[He.id]:void 0)}this.currentLayer=Ie,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Ie=this.currentLayer;this.depthOcclusion=!0;for(const Xe of this.layersWithOcclusionOpacity){this.currentLayer=Xe;const He=R[this.currentLayer],Qe=t.getLayerSourceCache(He),je=Qe?W[Qe.id]:void 0;this.terrain||this._renderTileClippingMasks(He,Qe,Qe?G[Qe.id]:void 0),this.renderLayer(this,Qe,He,je)}this.depthOcclusion=!1,this.currentLayer=Ie,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let De=null;R.forEach(Ke=>{const Ie=t.getLayerSourceCache(Ke);Ie&&!Ke.isHidden(this.transform.zoom)&&Ie.getVisibleCoordinates().length&&(!De||De.getSource().maxzoom<Ie.getSource().maxzoom)&&(De=Ie)}),De&&this.options.showTileBoundaries&&hc.debug(this,De,De.getVisibleCoordinates(),s.al.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&hc.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new s.al(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(De){const Ke=De.transform.padding;gd(De,De.transform.height-(Ke.top||0),3,ll),gd(De,Ke.bottom||0,3,tg),yd(De,Ke.left||0,3,ig),yd(De,De.transform.width-(Ke.right||0),3,Pp);const Ie=De.transform.centerPoint;(function(Xe,He,Qe,je){fa(Xe,He-1,Qe-10,2,20,je),fa(Xe,He-10,Qe-1,20,2,je)})(De,Ie.x,De.transform.height-Ie.y,Au)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),V||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:r}=this.transform.projection,c=!r||!r.includes(t.type);if(Lu[t.type]&&(c||this.terrain&&t.type==="custom")){const d=this.style.getLayerSourceCache(t);Lu[t.type](t,d,this)}this.gpuTimingEnd()}renderLayer(t,r,c,d){c.isHidden(this.transform.zoom)||(c.type==="background"||c.type==="sky"||c.type==="custom"||c.type==="model"||c.type==="raster"||c.type==="raster-particle"||d&&d.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||c.type!=="custom")||c.type==="clip"||hc[c.type](t,r,c,d,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const r=this.context.extTimerQuery,c=this.context.gl;let d=this.gpuTimers[t.id];d||(d=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),d.calls++,c.beginQuery(r.TIME_ELAPSED_EXT,d.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,r=this.context.gl,c=r.createQuery();this.deferredRenderGpuTimeQueries.push(c),r.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const r={};for(const c in t){const d=t[c],m=this.context.extTimerQuery,g=m.getQueryParameter(d.query,this.context.gl.QUERY_RESULT)/1e6;m.deleteQueryEXT(d.query),r[c]=g}return r}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const r=this.context.gl;let c=0;for(const d of t)c+=r.getQueryParameter(d,r.QUERY_RESULT)/1e6,r.deleteQuery(d);return c}translatePosMatrix(t,r,c,d,m){if(!c[0]&&!c[1])return t;const g=m?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(g){const C=Math.sin(g),R=Math.cos(g);c=[c[0]*R-c[1]*C,c[0]*C+c[1]*R]}const E=[m?c[0]:s.at(r,c[0],this.transform.zoom),m?c[1]:s.at(r,c[1],this.transform.zoom),0],A=new Float32Array(16);return s.ad.mat4.translate(A,t,E),A}saveTileTexture(t){const r=t.size[0],c=this._tileTextures[r];c?c.push(t):this._tileTextures[r]=[t]}getTileTexture(t){const r=this._tileTextures[t];return r&&r.length>0?r.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,r,c){const d=c===void 0?this.terrain&&this.terrain.renderingToTexture:c,m=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(m.push("LIGHTING_3D_MODE"),m.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):d||m.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||m.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(m.push("TERRAIN"),this.linearFloatFilteringSupported()&&m.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&m.push("GLOBE"),!this._fogVisible||d||r!==void 0&&!r||m.push("FOG","FOG_DITHERING"),d&&m.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&m.push("OVERDRAW_INSPECTOR"),m}getOrCreateProgram(t,r){this.cache=this.cache||{};const c=r&&r.defines||[],d=r&&r.config,m=this.currentGlobalDefines(t,r&&r.overrideFog,r&&r.overrideRtt).concat(c),g=xp.cacheKey(ec[t],t,m,d);return this.cache[g]||(this.cache[g]=new xp(this.context,t,ec[t],d,ud[t],m)),this.cache[g]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new s.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,r){if(this.style.enable3dLights()){const c=this.style.directionalLight,d=this.style.ambientLight;if(c&&d){const m=((g,E,A)=>{const C=g.properties.get("direction"),R=g.properties.get("color-use-theme")==="none",L=g.properties.get("color").toRenderColor(R?null:A.getLut(g.scope)).toArray01(),O=g.properties.get("intensity"),V=E.properties.get("color-use-theme")==="none",H=E.properties.get("color").toRenderColor(V?null:A.getLut(E.scope)).toArray01(),G=E.properties.get("intensity"),W=[C.x,C.y,C.z],K=s.cN(H,G),ie=s.cN(L,O);return{u_lighting_ambient_color:K,u_lighting_directional_dir:W,u_lighting_directional_color:ie,u_ground_radiance:vp(W,ie,K)}})(c,d,this.style);r.setLightsUniformValues(t,m)}}}uploadCommonUniforms(t,r,c,d,m){if(this.uploadCommonLightUniforms(t,r),this.terrain&&this.terrain.renderingToTexture)return;const g=this.style.fog;if(g){const E=g.getOpacity(this.transform.pitch),A=((C,R,L,O,V,H,G,W,K,ie,oe,se)=>{const fe=C.transform,ce=R.properties.get("color-use-theme")==="none",ue=R.properties.get("color").toRenderColor(ce?null:C.style.getLut(R.scope)).toArray01();ue[3]=O;const he=C.frameCounter/1e3%1,[_e,xe]=R.properties.get("vertical-range");return{u_fog_matrix:L?fe.calculateFogTileMatrix(L):se||C.identityMat,u_fog_range:R.getFovAdjustedRange(fe._fov),u_fog_color:ue,u_fog_horizon_blend:R.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(_e,xe),xe],u_fog_temporal_offset:he,u_frustum_tl:V,u_frustum_tr:H,u_frustum_br:G,u_frustum_bl:W,u_globe_pos:K,u_globe_radius:ie,u_viewport:oe,u_globe_transition:s.ag(fe.zoom),u_is_globe:+(fe.projection.name==="globe")}})(this,g,c,E,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*s.q.devicePixelRatio,this.transform.height*s.q.devicePixelRatio],d);r.setFogUniformValues(t,A)}m&&r.setCutoffUniformValues(t,m.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),r}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,r=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(const d of c)r[d.key]=t[d.key]||new Ls(d,512,this.transform.tileZoom,this);return r}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,r){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building")&&(!r||r.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let r=this._cachedTileFogOpacities[t.key];return r||(this._cachedTileFogOpacities[t.key]=r=this.style.fog.getOpacityForTile(t)),r[0]>=Mt||r[1]>=Mt}setupDepthForOcclusion(t,r,c){const d=this.context,m=d.gl,g=!!c;var E;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),d.activeTexture.set(m.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(m.NEAREST,m.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((E=this.depthRangeFor3D)[1]-E[0]),-1-2*E[0]/(E[1]-E[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(m.NEAREST,m.CLAMP_TO_EDGE),d.activeTexture.set(m.TEXTURE0),g||r.setTerrainUniformValues(d,c)}}function Fu(u,t){let r=!1,c=null;const d=()=>{c=null,r&&(u(),c=setTimeout(d,t),r=!1)};return()=>(r=!0,c||d(),c)}class Cd{constructor(t){this._hashName=t&&encodeURIComponent(t),s.aQ(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Fu(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const r=Pd(t);if(this._hashName){const c=this._hashName;let d=!1;const m=location.hash.slice(1).split("&").map(g=>{const E=g.split("=")[0];return E===c?(d=!0,`${E}=${r}`):g}).filter(g=>g);return d||m.push(`${c}=${r}`),`#${m.join("&")}`}return`#${r}`}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let r;return t.split("&").map(c=>c.split("=")).forEach(c=>{c[0]===this._hashName&&(r=c)}),(r&&r[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const r=this._getCurrentHash();if(r.length>=3&&!r.some(c=>isNaN(c))){const c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(r[3]||0):t.getBearing();return t.jumpTo({center:[+r[2],+r[1]],zoom:+r[0],bearing:c,pitch:+(r[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Pd(u,t){const r=u.getCenter(),c=Math.round(100*u.getZoom())/100,d=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),m=Math.pow(10,d),g=Math.round(r.lng*m)/m,E=Math.round(r.lat*m)/m,A=u.getBearing(),C=u.getPitch();let R=t?`/${g}/${E}/${c}`:`${c}/${E}/${g}`;return(A||C)&&(R+="/"+Math.round(10*A)/10),C&&(R+=`/${Math.round(C)}`),R}const dc={linearity:.3,easing:s.dB(0,0,.3,1)},zp=s.l({deceleration:2500,maxSpeed:1400},dc),Lp=s.l({deceleration:20,maxSpeed:1400},dc),Op=s.l({deceleration:1e3,maxSpeed:360},dc),kp=s.l({deceleration:1e3,maxSpeed:90},dc);class Fp{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:s.q.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,r=s.q.now();for(;t.length>0&&r-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const r={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:m}of this._inertiaBuffer)r.zoom+=m.zoomDelta||0,r.bearing+=m.bearingDelta||0,r.pitch+=m.pitchDelta||0,m.panDelta&&r.pan._add(m.panDelta),m.around&&(r.around=m.around),m.pinchAround&&(r.pinchAround=m.pinchAround);const c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(r.pan.mag()){const m=pc(r.pan.mag(),c,s.l({},zp,t||{}));d.offset=r.pan.mult(m.amount/r.pan.mag()),d.center=this._map.transform.center,fc(d,m)}if(r.zoom){const m=pc(r.zoom,c,Lp);d.zoom=this._map.transform.zoom+m.amount,fc(d,m)}if(r.bearing){const m=pc(r.bearing,c,Op);d.bearing=this._map.transform.bearing+s.ay(m.amount,-179,179),fc(d,m)}if(r.pitch){const m=pc(r.pitch,c,kp);d.pitch=this._map.transform.pitch+m.amount,fc(d,m)}if(d.zoom||d.bearing){const m=r.pinchAround===void 0?r.around:r.pinchAround;d.around=m?this._map.unproject(m):this._map.getCenter()}return this.clear(),d.noMoveStart=!0,d}}function fc(u,t){(!u.duration||u.duration<t.duration)&&(u.duration=t.duration,u.easing=t.easing)}function pc(u,t,r){const{maxSpeed:c,linearity:d,deceleration:m}=r,g=s.ay(u*d/(t/1e3),-c,c),E=Math.abs(g)/(m*d);return{easing:r.easing,duration:1e3*E,amount:g*(E/2)}}class Wn extends s.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,c,d={}){const m=di(r.getCanvasContainer(),c),g=r.unproject(m);super(t,s.l({point:m,lngLat:g,originalEvent:c},d)),this._defaultPrevented=!1,this.target=r}}class mc extends s.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,c){const d=t==="touchend"?c.changedTouches:c.touches,m=jt(r.getCanvasContainer(),d),g=m.map(A=>r.unproject(A)),E=m.reduce((A,C,R,L)=>A.add(C.div(L.length)),new s.P(0,0));super(t,{points:m,point:E,lngLats:g,lngLat:r.unproject(E),originalEvent:c}),this._defaultPrevented=!1}}class Bp extends s.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r){super("wheel",{originalEvent:r}),this._defaultPrevented=!1}}class Np{constructor(t,r){this._map=t,this._clickTolerance=r.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new Bp(this._map,t))}mousedown(t,r){return this._mousedownPos=r,this._firePreventable(new Wn(t.type,this._map,t))}mouseup(t){this._map.fire(new Wn(t.type,this._map,t))}preclick(t){const r=s.l({},t);r.type="preclick",this._map.fire(new Wn(r.type,this._map,r))}click(t,r){this._mousedownPos&&this._mousedownPos.dist(r)>=this._clickTolerance||(this.preclick(t),this._map.fire(new Wn(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new Wn(t.type,this._map,t))}mouseover(t){this._map.fire(new Wn(t.type,this._map,t))}mouseout(t){this._map.fire(new Wn(t.type,this._map,t))}touchstart(t){return this._firePreventable(new mc(t.type,this._map,t))}touchmove(t){this._map.fire(new mc(t.type,this._map,t))}touchend(t){this._map.fire(new mc(t.type,this._map,t))}touchcancel(t){this._map.fire(new mc(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ng{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new Wn(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Wn("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new Wn(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class sg{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=r.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,r){this.isEnabled()&&t.shiftKey&&t.button===0&&(pt(),this._startPos=this._lastPos=r,this._active=!0)}mousemoveWindow(t,r){if(!this._active)return;const c=r,d=this._startPos,m=this._lastPos;if(!d||!m||m.equals(c)||!this._box&&c.dist(d)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=et("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const g=Math.min(d.x,c.x),E=Math.max(d.x,c.x),A=Math.min(d.y,c.y),C=Math.max(d.y,c.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${g}px,${A}px)`,this._box.style.width=E-g+"px",this._box.style.height=C-A+"px")})}mouseupWindow(t,r){if(!this._active)return;const c=this._startPos,d=r;if(c&&t.button===0){if(this.reset(),Pt(),c.x!==d.x||c.y!==d.y)return this._map.fire(new s.A("boxzoomend",{originalEvent:t})),{cameraAnimation:m=>m.fitScreenCoordinates(c,d,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),ui(),delete this._startPos,delete this._lastPos}_fireEvent(t,r){return this._map.fire(new s.A(t,{originalEvent:r}))}}function Tr(u,t){const r={};for(let c=0;c<u.length;c++)r[u[c].identifier]=t[c];return r}class Vp{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,r,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=function(d){const m=new s.P(0,0);for(const g of d)m._add(g);return m.div(d.length)}(r),this.touches=Tr(c,r)))}touchmove(t,r,c){if(this.aborted||!this.centroid)return;const d=Tr(c,r);for(const m in this.touches){const g=d[m];(!g||g.dist(this.touches[m])>30)&&(this.aborted=!0)}}touchend(t,r,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){const d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class Rd{constructor(t){this.singleTap=new Vp(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,r,c){this.singleTap.touchstart(t,r,c)}touchmove(t,r,c){this.singleTap.touchmove(t,r,c)}touchend(t,r,c){const d=this.singleTap.touchend(t,r,c);if(d){const m=t.timeStamp-this.lastTime<500,g=!this.lastTap||this.lastTap.dist(d)<30;if(m&&g||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class og{constructor(){this._zoomIn=new Rd({numTouches:1,numTaps:2}),this._zoomOut=new Rd({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,r,c){this._zoomIn.touchstart(t,r,c),this._zoomOut.touchstart(t,r,c)}touchmove(t,r,c){this._zoomIn.touchmove(t,r,c),this._zoomOut.touchmove(t,r,c)}touchend(t,r,c){const d=this._zoomIn.touchend(t,r,c),m=this._zoomOut.touchend(t,r,c);return d?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:g=>g.easeTo({duration:300,zoom:g.getZoom()+1,around:g.unproject(d)},{originalEvent:t})}):m?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:g=>g.easeTo({duration:300,zoom:g.getZoom()-1,around:g.unproject(m)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const _c={0:1,2:2},Dd={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class gc{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,r){return!1}_move(t,r){return{}}mousedown(t,r){if(this._lastPoint)return;const c=st(t);this._correctButton(t,c)&&(this._lastPoint=r,this._eventButton=c)}mousemoveWindow(t,r){const c=this._lastPoint;if(c){if(t.preventDefault(),this._eventButton!=null&&function(d,m){const g=_c[m];return d.buttons===void 0||(d.buttons&g)!==g}(t,this._eventButton))this.reset();else if(this._moved||!(r.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=r,this._move(c,r)}}mouseupWindow(t){this._lastPoint&&st(t)===this._eventButton&&(this._moved&&Pt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Bu extends gc{mousedown(t,r){super.mousedown(t,r),this._lastPoint&&(this._active=!0)}_correctButton(t,r){return r===0&&!t.ctrlKey}_move(t,r){return{around:r,panDelta:r.sub(t)}}}class Ks extends gc{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?Dd[t.pitchRotateKey]:void 0}_correctButton(t,r){return this._pitchRotateKey?r===0&&t[this._pitchRotateKey]:r===0&&t.ctrlKey||r===2}_move(t,r){const c=.8*(r.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class yc extends gc{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?Dd[t.pitchRotateKey]:void 0}_correctButton(t,r){return this._pitchRotateKey?r===0&&t[this._pitchRotateKey]:r===0&&t.ctrlKey||r===2}_move(t,r){const c=-.5*(r.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class jr{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=r.clickTolerance||1,this.reset(),s.aQ(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}touchstart(t,r,c){return this._calculateTransform(t,r,c)}touchmove(t,r,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(c.length===1&&!s.dC())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,r,c)}}touchend(t,r,c){this._calculateTransform(t,r,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,r,c){c.length>0&&(this._active=!0);const d=Tr(c,r),m=new s.P(0,0),g=new s.P(0,0);let E=0;for(const C in d){const R=d[C],L=this._touches[C];L&&(m._add(R),g._add(R.sub(L)),E++,d[C]=R)}if(this._touches=d,E<this._minTouches||!g.mag())return;const A=g.div(E);return this._sum._add(A),this._sum.mag()<this._clickTolerance?void 0:{around:m.div(E),panDelta:A}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=et("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Es{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,r,c){return{}}touchstart(t,r,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([r[0],r[1]]))}touchmove(t,r,c){const d=this._firstTwoTouches;if(!d)return;t.preventDefault();const[m,g]=d,E=dl(c,r,m),A=dl(c,r,g);if(!E||!A)return;const C=this._aroundCenter?null:E.add(A).div(2);return this._move([E,A],C,t)}touchend(t,r,c){if(!this._firstTwoTouches)return;const[d,m]=this._firstTwoTouches,g=dl(c,r,d),E=dl(c,r,m);g&&E||(this._active&&Pt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function dl(u,t,r){for(let c=0;c<u.length;c++)if(u[c].identifier===r)return t[c]}function vc(u,t){return Math.log(u/t)/Math.LN2}class Up extends Es{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,r){const c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(vc(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:vc(this._distance,c),pinchAround:r}}}function jp(u,t){return 180*u.angleWith(t)/Math.PI}class xc extends Es{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,r){const c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:jp(this._vector,c),pinchAround:r}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const r=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;const d=jp(t,c);return Math.abs(d)<r}}function zd(u){return Math.abs(u.y)>Math.abs(u.x)}class ag extends Es{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,zd(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,r,c){const d=this._lastPoints;if(!d)return;const m=t[0].sub(d[0]),g=t[1].sub(d[1]);return this._map._cooperativeGestures&&!s.dC()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(m,g,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(m.y+g.y)/2*-.5})}gestureBeginsVertically(t,r,c){if(this._valid!==void 0)return this._valid;const d=t.mag()>=2,m=r.mag()>=2;if(!d&&!m)return;if(!d||!m)return this._firstMove==null&&(this._firstMove=c),c-this._firstMove<100&&void 0;const g=t.y>0==r.y>0;return zd(t)&&zd(r)&&g}}const Ld={panStep:100,bearingStep:15,pitchStep:10};class Od{constructor(){const t=Ld;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let r=0,c=0,d=0,m=0,g=0;switch(t.keyCode){case 61:case 107:case 171:case 187:r=1;break;case 189:case 109:case 173:r=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),m=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),m=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),g=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),g=1);break;default:return}return this._rotationDisabled&&(c=0,d=0),{cameraAnimation:E=>{const A=E.getZoom();E.easeTo({duration:300,easeId:"keyboardHandler",easing:bc,zoom:r?Math.round(A)+r*(t.shiftKey?2:1):A,bearing:E.getBearing()+c*this._bearingStep,pitch:E.getPitch()+d*this._pitchStep,offset:[-m*this._panStep,-g*this._panStep],center:E.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function bc(u){return u*(2-u)}const _a=4.000244140625,xo=1/450;class Ns{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._handler=r,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=xo,s.aQ(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||s.dC()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let r=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const c=s.q.now(),d=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,r!==0&&r%_a==0?this._type="wheel":r!==0&&Math.abs(r)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=r,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*r)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,r+=this._lastValue)),t.shiftKey&&r&&(r/=4),this._type&&(this._lastWheelEvent=t,this._delta-=r,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const r=di(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:r,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const r=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const C=this._type==="wheel"&&Math.abs(this._delta)>_a?this._wheelZoomRate:this._defaultZoomRate;let R=2/(1+Math.exp(-Math.abs(this._delta*C)));this._delta<0&&R!==0&&(R=1/R);const L=r(),O=Math.pow(2,L),V=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):O;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(V*R))),this._type==="wheel"&&(this._startZoom=L,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const c=typeof this._targetZoom=="number"?this._targetZoom:r(),d=this._startZoom,m=this._easing;let g,E=!1;if(this._type==="wheel"&&d&&m){const C=Math.min((s.q.now()-this._lastWheelEventTime)/200,1),R=m(C);g=s.ah(d,c,R),C<1?this._frameId||(this._frameId=!0):E=!0}else g=c,E=!0;this._active=!0,E&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let A=g-r();return A*this._lastDelta<0&&(A=0),{noInertia:!0,needsRenderFrame:!E,zoomDelta:A,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let r=s.dD;if(this._prevEase){const c=this._prevEase,d=(s.q.now()-c.start)/c.duration,m=c.easing(d+.01)-c.easing(d),g=.27/Math.sqrt(m*m+1e-4)*.01,E=Math.sqrt(.0729-g*g);r=s.dB(g,E,.25,1)}return this._prevEase={start:s.q.now(),duration:t,easing:r},r}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=et("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class qo{constructor(t,r){this._clickZoom=t,this._tapZoom=r}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ga{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,r){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(r)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class $o{constructor(){this._tap=new Rd({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,r,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=r[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,r,c))}touchmove(t,r,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;const d=r[0],m=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:m/128}}}else this._tap.touchmove(t,r,c)}touchend(t,r,c){this._tapTime?this._swipePoint&&c.length===0&&this.reset():this._tap.touchend(t,r,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class lg{constructor(t,r,c){this._el=t,this._mousePan=r,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class cg{constructor(t,r,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=r,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class ug{constructor(t,r,c,d){this._el=t,this._touchZoom=r,this._touchRotate=c,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Nu=u=>u.zoom||u.drag||u.pitch||u.rotate;class Gp extends s.A{}class Fn{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,r){const c=s.ad.vec3.sub([],r,t);this.radius=s.ad.vec3.length(c[2]<0?s.ad.vec3.div([],c,this.constants):[c[0],c[1],0])}projectRay(t){s.ad.vec3.div(t,t,this.constants),s.ad.vec3.normalize(t,t),s.ad.vec3.mul(t,t,this.constants);const r=s.ad.vec3.scale([],t,this.radius);if(r[2]>0){const c=s.ad.vec3.scale([],[0,0,1],s.ad.vec3.dot(r,[0,0,1])),d=s.ad.vec3.scale([],s.ad.vec3.normalize([],[r[0],r[1],0]),this.radius),m=s.ad.vec3.add([],r,s.ad.vec3.scale([],s.ad.vec3.sub([],s.ad.vec3.add([],d,c),r),2));r[0]=m[0],r[1]=m[1]}return r}}function fl(u){return u.panDelta&&u.panDelta.mag()||u.zoomDelta||u.bearingDelta||u.pitchDelta}class qp{constructor(t,r){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Fp(t),this._bearingSnap=r.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Fn,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(r),s.aQ(["handleEvent","handleWindowEvent"],this);const c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(const[d,m,g]of this._listeners){const E=d===document?this.handleWindowEvent:this.handleEvent;d.addEventListener(m,E,g)}}destroy(){for(const[t,r,c]of this._listeners){const d=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(r,d,c)}}_addDefaultHandlers(t){const r=this._map,c=r.getCanvasContainer();this._add("mapEvent",new Np(r,t));const d=r.boxZoom=new sg(r,t);this._add("boxZoom",d);const m=new og,g=new ga;r.doubleClickZoom=new qo(g,m),this._add("tapZoom",m),this._add("clickZoom",g);const E=new $o;this._add("tapDragZoom",E);const A=r.touchPitch=new ag(r);this._add("touchPitch",A);const C=new Ks(t),R=new yc(t);r.dragRotate=new cg(t,C,R),this._add("mouseRotate",C,["mousePitch"]),this._add("mousePitch",R,["mouseRotate"]);const L=new Bu(t),O=new jr(r,t);r.dragPan=new lg(c,L,O),this._add("mousePan",L),this._add("touchPan",O,["touchZoom","touchRotate"]);const V=new xc,H=new Up;r.touchZoomRotate=new ug(c,H,V,E),this._add("touchRotate",V,["touchPan","touchZoom"]),this._add("touchZoom",H,["touchPan","touchRotate"]),this._add("blockableMapEvent",new ng(r));const G=r.scrollZoom=new Ns(r,this);this._add("scrollZoom",G,["mousePan"]);const W=r.keyboard=new Od;this._add("keyboard",W);for(const K of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[K]&&r[K].enable(t[K])}_add(t,r,c){this._handlers.push({handlerName:t,handler:r,allowed:c}),this._handlersById[t]=r}stop(t){if(!this._updatingCamera){for(const{handler:r}of this._handlers)r.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Nu(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,r,c){for(const d in t)if(d!==c&&(!r||r.indexOf(d)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const r=[];for(const c of t)this._el.contains(c.target)&&r.push(c);return r}handleEvent(t,r){this._updatingCamera=!0;const c=t.type==="renderFrame",d=c?void 0:t,m={needsRenderFrame:!1},g={},E={},A=t.touches?this._getMapTouches(t.touches):void 0,C=A?jt(this._el,A):c?void 0:di(this._el,t);for(const{handlerName:O,handler:V,allowed:H}of this._handlers){if(!V.isEnabled())continue;let G;this._blockedByActive(E,H,O)?V.reset():V[r||t.type]&&(G=V[r||t.type](t,C,A),this.mergeHandlerResult(m,g,G,O,d),G&&G.needsRenderFrame&&this._triggerRenderFrame()),(G||V.isActive())&&(E[O]=V)}const R={};for(const O in this._previousActiveHandlers)E[O]||(R[O]=d);this._previousActiveHandlers=E,(Object.keys(R).length||fl(m))&&(this._changes.push([m,g,R]),this._triggerRenderFrame()),(Object.keys(E).length||fl(m))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:L}=m;L&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],L(this._map))}mergeHandlerResult(t,r,c,d,m){if(!c)return;s.l(t,c);const g={handlerName:d,originalEvent:c.originalEvent||m};c.zoomDelta!==void 0&&(r.zoom=g),c.panDelta!==void 0&&(r.drag=g),c.pitchDelta!==void 0&&(r.pitch=g),c.bearingDelta!==void 0&&(r.rotate=g)}_applyChanges(){const t={},r={},c={};for(const[d,m,g]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new s.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.aroundCoord!==void 0&&(t.aroundCoord=d.aroundCoord),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),s.l(r,m),s.l(c,g);this._updateMapTransform(t,r,c),this._changes=[]}_updateMapTransform(t,r,c){const d=this._map,m=d.transform,g=ie=>[ie.x,ie.y,ie.z];if((ie=>{const oe=this._eventsInProgress.drag;return oe&&!this._handlersById[oe.handlerName].isActive()})()&&!fl(t)){const ie=m.zoom;m.cameraElevationReference="sea",this._originalZoom!=null&&m._orthographicProjectionAtLowPitch&&m.projection.name!=="globe"&&m.pitch===0?(m.cameraElevationReference="ground",m.zoom=this._originalZoom):(m.recenterOnTerrain(),m.cameraElevationReference="ground"),ie!==m.zoom&&this._map._update(!0)}if(m._isCameraConstrained&&d._stop(!0),!fl(t))return void this._fireEvents(r,c,!0);let{panDelta:E,zoomDelta:A,bearingDelta:C,pitchDelta:R,around:L,aroundCoord:O,pinchAround:V}=t;m._isCameraConstrained&&(A>0&&(A=0),m._isCameraConstrained=!1),V!==void 0&&(L=V),(A||(ie=>r[ie]&&!this._eventsInProgress[ie])("drag"))&&L&&(this._dragOrigin=g(m.pointCoordinate3D(L)),this._originalZoom=m.zoom,this._trackingEllipsoid.setup(m._camera.position,this._dragOrigin)),m.cameraElevationReference="sea",d._stop(!0),L=L||d.transform.centerPoint,C&&(m.bearing+=C),R&&(m.pitch+=R),m._updateCameraState();const H=[0,0,0];if(E)if(m.projection.name==="mercator"){const ie=this._trackingEllipsoid.projectRay(m.screenPointToMercatorRay(L).dir),oe=this._trackingEllipsoid.projectRay(m.screenPointToMercatorRay(L.sub(E)).dir);H[0]=oe[0]-ie[0],H[1]=oe[1]-ie[1]}else{const ie=m.pointCoordinate(L);if(m.projection.name==="globe"){E=E.rotate(-m.angle);const oe=m._pixelsPerMercatorPixel/m.worldSize;H[0]=-E.x*s.dE(s.aT(ie.y))*oe,H[1]=-E.y*s.dE(m.center.lat)*oe}else{const oe=m.pointCoordinate(L.sub(E));ie&&oe&&(H[0]=oe.x-ie.x,H[1]=oe.y-ie.y)}}const G=m.zoom,W=[0,0,0];if(A){const ie=g(O||m.pointCoordinate3D(L)),oe={dir:s.ad.vec3.normalize([],s.ad.vec3.sub([],ie,m._camera.position))};if(oe.dir[2]<0){const se=m.zoomDeltaToMovement(ie,A);s.ad.vec3.scale(W,oe.dir,se)}}const K=s.ad.vec3.add(H,H,W);m._translateCameraConstrained(K),A&&Math.abs(m.zoom-G)>1e-4&&m.recenterOnTerrain(),m.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(r,c,!0)}_fireEvents(t,r,c){const d=Nu(this._eventsInProgress),m=Nu(t),g={};for(const R in t){const{originalEvent:L}=t[R];this._eventsInProgress[R]||(g[`${R}start`]=L),this._eventsInProgress[R]=t[R]}!d&&m&&this._fireEvent("movestart",m.originalEvent);for(const R in g)this._fireEvent(R,g[R]);m&&this._fireEvent("move",m.originalEvent);for(const R in t){const{originalEvent:L}=t[R];this._fireEvent(R,L)}const E={};let A;for(const R in this._eventsInProgress){const{handlerName:L,originalEvent:O}=this._eventsInProgress[R];this._handlersById[L].isActive()||(delete this._eventsInProgress[R],A=r[L]||O,E[`${R}end`]=A)}for(const R in E)this._fireEvent(R,E[R]);const C=Nu(this._eventsInProgress);if(c&&(d||m)&&!C){this._updatingCamera=!0;const R=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),L=O=>O!==0&&-this._bearingSnap<O&&O<this._bearingSnap;R?(L(R.bearing||this._map.getBearing())&&(R.bearing=0),this._map.easeTo(R,{originalEvent:A})):(this._map.fire(new s.A("moveend",{originalEvent:A})),L(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,r){this._map.fire(new s.A(t,r?{originalEvent:r}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new Gp("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const $p="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class pl extends s.E{constructor(t,r){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=r.bearingSnap,this._respectPrefersReducedMotion=r.respectPrefersReducedMotion!==!1,s.aQ(["_renderFrameCallback"],this)}getCenter(){return new s.bO(this.transform.center.lng,this.transform.center.lat)}setCenter(t,r){return this.jumpTo({center:t},r)}panBy(t,r,c){return t=s.P.convert(t).mult(-1),this.panTo(this.transform.center,s.l({offset:t},r),c)}panTo(t,r,c){return this.easeTo(s.l({center:t},r),c)}getZoom(){return this.transform.zoom}setZoom(t,r){return this.jumpTo({zoom:t},r),this}zoomTo(t,r,c){return this.easeTo(s.l({zoom:t},r),c)}zoomIn(t,r){return this.zoomTo(this.getZoom()+1,t,r),this}zoomOut(t,r){return this.zoomTo(this.getZoom()-1,t,r),this}getBearing(){return this.transform.bearing}setBearing(t,r){return this.jumpTo({bearing:t},r),this}getPadding(){return this.transform.padding}setPadding(t,r){return this.jumpTo({padding:t},r),this}rotateTo(t,r,c){return this.easeTo(s.l({bearing:t},r),c)}resetNorth(t,r){return this.rotateTo(0,s.l({duration:1e3},t),r),this}resetNorthPitch(t,r){return this.easeTo(s.l({bearing:0,pitch:0,duration:1e3},t),r),this}snapToNorth(t,r){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,r):this}getPitch(){return this.transform.pitch}setPitch(t,r){return this.jumpTo({pitch:t},r),this}cameraForBounds(t,r){t=s.aB.convert(t);const c=r&&r.bearing||0,d=r&&r.pitch||0,m=t.getNorthWest(),g=t.getSouthEast();return this._cameraForBounds(this.transform,m,g,c,d,r)}_extendPadding(t){const r={top:0,right:0,bottom:0,left:0};return t==null?s.l({},r,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:s.l({},r,t)}_extendCameraOptions(t){return(t=s.l({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,r){const c=r.max[0]-r.min[0],d=r.max[1]-r.min[1];return c/d>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):d/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,r,c,d,m,g){const E=t.clone(),A=this._extendCameraOptions(g);E.bearing=d,E.pitch=m;const C=s.bO.convert(r),R=s.bO.convert(c),L=.5*(C.lat+R.lat),O=.5*(C.lng+R.lng),V=s.dF(L,O),H=s.ad.vec3.normalize([],V),G=s.ad.vec3.normalize([],s.ad.vec3.cross([],H,[0,1,0])),W=s.ad.vec3.cross([],G,H),K=[G[0],G[1],G[2],0,W[0],W[1],W[2],0,H[0],H[1],H[2],0,0,0,0,1],ie=[V,s.dF(C.lat,C.lng),s.dF(R.lat,C.lng),s.dF(R.lat,R.lng),s.dF(C.lat,R.lng),s.dF(L,C.lng),s.dF(L,R.lng),s.dF(C.lat,O),s.dF(R.lat,O)];let oe=s.ce.fromPoints(ie.map(He=>[s.ad.vec3.dot(G,He),s.ad.vec3.dot(W,He),s.ad.vec3.dot(H,He)]));const se=s.ad.vec3.transformMat4([],oe.center,K);s.ad.vec3.squaredLength(se)===0&&s.ad.vec3.set(se,0,0,1),s.ad.vec3.normalize(se,se),s.ad.vec3.scale(se,se,s.az),E.center=s.dG(se);const fe=E.getWorldToCameraMatrix(),ce=s.ad.mat4.invert(new Float64Array(16),fe);oe=s.ce.applyTransform(oe,s.ad.mat4.multiply([],fe,K));const ue=this._extendAABB(oe,E,A,d);if(!ue)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");oe=ue,s.ad.vec3.transformMat4(se,se,fe);const he=.5*(oe.max[2]-oe.min[2]),_e=this._minimumAABBFrustumDistance(E,oe),xe=s.ad.vec3.scale([],[0,0,1],he),Ue=s.ad.vec3.add(xe,se,xe),Le=_e+(E.pitch===0?0:s.ad.vec3.distance(se,Ue)),Ye=E.globeCenterInViewSpace,Je=s.ad.vec3.sub([],se,[Ye[0],Ye[1],Ye[2]]);s.ad.vec3.normalize(Je,Je),s.ad.vec3.scale(Je,Je,Le);const at=s.ad.vec3.add([],se,Je);s.ad.vec3.transformMat4(at,at,ce);const De=s.dv/s.az,Ke=s.ad.vec3.length(at),Ie=s.bH(Math.max(Ke*De-s.dv,Number.EPSILON),0),Xe=Math.min(E.zoomFromMercatorZAdjusted(Ie),A.maxZoom);return Xe>.5*(s.c6+s.bY)?(E.setProjection({name:"mercator"}),E.zoom=Xe,this._cameraForBounds(E,r,c,d,m,g)):{center:E.center,zoom:Xe,bearing:d,pitch:m}}_extendAABB(t,r,c,d){const m=.5*((c.padding.left||0)+(c.padding.right||0)),g=.5*((c.padding.top||0)+(c.padding.bottom||0)),E=g,A=m,C=m,R=g,L=r.width-(A+C),O=r.height-(E+R),V=s.ad.vec3.sub([],t.max,t.min),H=Math.min(L/V[0],O/V[1]),G=Math.min(r.scaleZoom(r.scale*H),c.maxZoom);if(isNaN(G))return null;const W=r.scale/r.zoomScale(G),K=new s.ce([t.min[0]-A*W,t.min[1]-R*W,t.min[2]],[t.max[0]+C*W,t.max[1]+E*W,t.max[2]]),ie=(typeof c.offset.x=="number"&&typeof c.offset.y=="number"?new s.P(c.offset.x,c.offset.y):s.P.convert(c.offset)).rotate(-s.ak(d));return K.center[0]-=ie.x*W,K.center[1]+=ie.y*W,K}queryTerrainElevation(t,r){const c=this.transform.elevation;return c?(r=s.l({},{exaggerated:!0},r),c.getAtPoint(s.ac.fromLngLat(t),null,r.exaggerated)):null}_cameraForBounds(t,r,c,d,m,g){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,r,c,d,m,g);const E=t.clone(),A=this._extendCameraOptions(g);E.bearing=d,E.pitch=m;const C=s.bO.convert(r),R=s.bO.convert(c),L=new s.bO(C.lng,R.lat),O=new s.bO(R.lng,C.lat),V=E.project(C),H=E.project(R),G=this.queryTerrainElevation(C),W=this.queryTerrainElevation(R),K=this.queryTerrainElevation(L),ie=this.queryTerrainElevation(O),oe=[[V.x,V.y,Math.min(G||0,W||0,K||0,ie||0)],[H.x,H.y,Math.max(G||0,W||0,K||0,ie||0)]];let se=s.ce.fromPoints(oe);const fe=E.getWorldToCameraMatrix(),ce=s.ad.mat4.invert(new Float64Array(16),fe);se=s.ce.applyTransform(se,fe);const ue=this._extendAABB(se,E,A,d);if(!ue)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");se=ue;const he=.5*s.ad.vec3.sub([],se.max,se.min)[2],_e=this._minimumAABBFrustumDistance(E,se),xe=[0,0,1,0];s.ad.vec4.transformMat4(xe,xe,fe),s.ad.vec4.normalize(xe,xe);const Ue=s.ad.vec3.scale([],xe,_e+he),Le=s.ad.vec3.add([],se.center,Ue);s.ad.vec3.transformMat4(se.center,se.center,ce),s.ad.vec3.transformMat4(Le,Le,ce);const Ye=E.unproject(new s.P(se.center[0],se.center[1])),Je=s.dH(E.projection,Ye),at=Math.pow(2,Je),De=Math.min(E._zoomFromMercatorZ(Le[2]*E.pixelsPerMeter*at/E.worldSize),A.maxZoom);return E.mercatorFromTransition&&De<.5*(s.c6+s.bY)?(E.setProjection({name:"globe"}),E.zoom=De,this._cameraForBounds(E,r,c,d,m,g)):{center:Ye,zoom:De,bearing:d,pitch:m}}fitBounds(t,r,c){const d=this.cameraForBounds(t,r);return this._fitInternal(d,r,c)}fitScreenCoordinates(t,r,c,d,m){const g=s.P.convert(t),E=s.P.convert(r),A=new s.P(Math.min(g.x,E.x),Math.min(g.y,E.y)),C=new s.P(Math.max(g.x,E.x),Math.max(g.y,E.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(g,E))return this;const R=this.transform.pointLocation3D(A),L=this.transform.pointLocation3D(C),O=this.transform.pointLocation3D(new s.P(A.x,C.y)),V=this.transform.pointLocation3D(new s.P(C.x,A.y)),H=[Math.min(R.lng,L.lng,O.lng,V.lng),Math.min(R.lat,L.lat,O.lat,V.lat)],G=[Math.max(R.lng,L.lng,O.lng,V.lng),Math.max(R.lat,L.lat,O.lat,V.lat)],W=d&&d.pitch?d.pitch:this.getPitch(),K=this._cameraForBounds(this.transform,H,G,c,W,d);return this._fitInternal(K,d,m)}_fitInternal(t,r,c){return t?(r=s.l(t,r)).linear?this.easeTo(r,c):this.flyTo(r,c):this}jumpTo(t,r){this.stop();const c=t.preloadOnly?this.transform.clone():this.transform;let d=!1,m=!1,g=!1;"zoom"in t&&c.zoom!==+t.zoom&&(d=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=s.bO.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(m=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(g=!0,c.pitch=+t.pitch);const E=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!c.isPaddingEqual(E))if(t.retainPadding===!1){const A=c.clone();A.padding=E,c.setLocationAtPoint(c.center,A.centerPoint)}else c.padding=E;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new s.A("movestart",r)).fire(new s.A("move",r)),d&&this.fire(new s.A("zoomstart",r)).fire(new s.A("zoom",r)).fire(new s.A("zoomend",r)),m&&this.fire(new s.A("rotatestart",r)).fire(new s.A("rotate",r)).fire(new s.A("rotateend",r)),g&&this.fire(new s.A("pitchstart",r)).fire(new s.A("pitch",r)).fire(new s.A("pitchend",r)),this.fire(new s.A("moveend",r)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||s.w($p),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,r){const c=this.transform;if(!c.projection.supportsFreeCamera)return s.w($p),this;this.stop();const d=c.zoom,m=c.pitch,g=c.bearing;c.setFreeCameraOptions(t);const E=d!==c.zoom,A=m!==c.pitch,C=g!==c.bearing;return this.fire(new s.A("movestart",r)).fire(new s.A("move",r)),E&&this.fire(new s.A("zoomstart",r)).fire(new s.A("zoom",r)).fire(new s.A("zoomend",r)),C&&this.fire(new s.A("rotatestart",r)).fire(new s.A("rotate",r)).fire(new s.A("rotateend",r)),A&&this.fire(new s.A("pitchstart",r)).fire(new s.A("pitch",r)).fire(new s.A("pitchend",r)),this.fire(new s.A("moveend",r)),this}easeTo(t,r){this._stop(!1,t.easeId),((t=s.l({offset:[0,0],duration:500,easing:s.dD},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const c=this.transform,d=this.getZoom(),m=this.getBearing(),g=this.getPitch(),E=this.getPadding(),A="zoom"in t?+t.zoom:d,C="bearing"in t?this._normalizeBearing(t.bearing,m):m,R="pitch"in t?+t.pitch:g,L=this._extendPadding(t.padding),O=s.P.convert(t.offset);let V,H,G;if(c.projection.name==="globe"){const xe=s.ac.fromLngLat(c.center),Ue=O.rotate(-c.angle);xe.x+=Ue.x/c.worldSize,xe.y+=Ue.y/c.worldSize;const Le=xe.toLngLat(),Ye=s.bO.convert(t.center||Le);this._normalizeCenter(Ye),V=c.centerPoint.add(Ue),H=new s.P(xe.x,xe.y).mult(c.worldSize),G=new s.P(s.av(Ye.lng),s.aC(Ye.lat)).mult(c.worldSize).sub(H)}else{V=c.centerPoint.add(O);const xe=c.pointLocation(V),Ue=s.bO.convert(t.center||xe);this._normalizeCenter(Ue),H=c.project(xe),G=c.project(Ue).sub(H)}const W=c.zoomScale(A-d);let K,ie;t.around&&(K=s.bO.convert(t.around),ie=c.locationPoint(K));const oe=this._zooming||A!==d,se=this._rotating||m!==C,fe=this._pitching||R!==g,ce=!c.isPaddingEqual(L),ue=t.retainPadding===!1?c.clone():c,he=xe=>Ue=>{if(oe&&(xe.zoom=s.ah(d,A,Ue)),se&&(xe.bearing=s.ah(m,C,Ue)),fe&&(xe.pitch=s.ah(g,R,Ue)),ce&&(ue.interpolatePadding(E,L,Ue),V=ue.centerPoint.add(O)),K)xe.setLocationAtPoint(K,ie);else{const Le=xe.zoomScale(xe.zoom-d),Ye=A>d?Math.min(2,W):Math.max(.5,W),Je=Math.pow(Ye,1-Ue),at=xe.unproject(H.add(G.mult(Ue*Je)).mult(Le));xe.setLocationAtPoint(xe.renderWorldCopies?at.wrap():at,V)}return t.preloadOnly||this._fireMoveEvents(r),xe};if(t.preloadOnly){const xe=this._emulate(he,t.duration,c);return this._preloadTiles(xe),this}const _e={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=oe,this._rotating=se,this._pitching=fe,this._padding=ce,this._easeId=t.easeId,this._prepareEase(r,t.noMoveStart,_e),this._ease(he(c),xe=>{c.cameraElevationReference==="sea"&&c.recenterOnTerrain(),this._afterEase(r,xe)},t),this}_prepareEase(t,r,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),r||c.moving||this.fire(new s.A("movestart",t)),this._zooming&&!c.zooming&&this.fire(new s.A("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new s.A("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new s.A("pitchstart",t))}_fireMoveEvents(t){this.fire(new s.A("move",t)),this._zooming&&this.fire(new s.A("zoom",t)),this._rotating&&this.fire(new s.A("rotate",t)),this._pitching&&this.fire(new s.A("pitch",t))}_afterEase(t,r){if(this._easeId&&r&&this._easeId===r)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const c=this._zooming,d=this._rotating,m=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new s.A("zoomend",t)),d&&this.fire(new s.A("rotateend",t)),m&&this.fire(new s.A("pitchend",t)),this.fire(new s.A("moveend",t))}flyTo(t,r){if(this._prefersReducedMotion(t)){const He=s.aA(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(He,r)}this.stop(),t=s.l({offset:[0,0],speed:1.2,curve:1.42,easing:s.dD},t);const c=this.transform,d=this.getZoom(),m=this.getBearing(),g=this.getPitch(),E=this.getPadding(),A="zoom"in t?s.ay(+t.zoom,c.minZoom,c.maxZoom):d,C="bearing"in t?this._normalizeBearing(t.bearing,m):m,R="pitch"in t?+t.pitch:g,L=this._extendPadding(t.padding),O=c.zoomScale(A-d),V=s.P.convert(t.offset);let H=c.centerPoint.add(V);const G=c.pointLocation(H),W=s.bO.convert(t.center||G);this._normalizeCenter(W);const K=c.project(G),ie=c.project(W).sub(K);let oe=t.curve;const se=Math.max(c.width,c.height),fe=se/O,ce=ie.mag();if("minZoom"in t){const He=s.ay(Math.min(t.minZoom,d,A),c.minZoom,c.maxZoom),Qe=se/c.zoomScale(He-d);oe=Math.sqrt(Qe/ce*2)}const ue=oe*oe;function he(He){const Qe=(fe*fe-se*se+(He?-1:1)*ue*ue*ce*ce)/(2*(He?fe:se)*ue*ce);return Math.log(Math.sqrt(Qe*Qe+1)-Qe)}function _e(He){return(Math.exp(He)-Math.exp(-He))/2}function xe(He){return(Math.exp(He)+Math.exp(-He))/2}const Ue=he(0);let Le=function(He){return xe(Ue)/xe(Ue+oe*He)},Ye=function(He){return se*((xe(Ue)*(_e(Qe=Ue+oe*He)/xe(Qe))-_e(Ue))/ue)/ce;var Qe},Je=(he(1)-Ue)/oe;if(Math.abs(ce)<1e-6||!isFinite(Je)){if(Math.abs(se-fe)<1e-6)return this.easeTo(t,r);const He=fe<se?-1:1;Je=Math.abs(Math.log(fe/se))/oe,Ye=function(){return 0},Le=function(Qe){return Math.exp(He*oe*Qe)}}t.duration="duration"in t?+t.duration:1e3*Je/("screenSpeed"in t?+t.screenSpeed/oe:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const at=m!==C,De=R!==g,Ke=!c.isPaddingEqual(L),Ie=t.retainPadding===!1?c.clone():c,Xe=He=>Qe=>{const je=Qe*Je,it=1/Le(je);He.zoom=Qe===1?A:d+He.scaleZoom(it),at&&(He.bearing=s.ah(m,C,Qe)),De&&(He.pitch=s.ah(g,R,Qe)),Ke&&(Ie.interpolatePadding(E,L,Qe),H=Ie.centerPoint.add(V));const _t=Qe===1?W:He.unproject(K.add(ie.mult(Ye(je))).mult(it));return He.setLocationAtPoint(He.renderWorldCopies?_t.wrap():_t,H),He._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(r),He};if(t.preloadOnly){const He=this._emulate(Xe,t.duration,c);return this._preloadTiles(He),this}return this._zooming=!0,this._rotating=at,this._pitching=De,this._padding=Ke,this._prepareEase(r,!1),this._ease(Xe(c),()=>this._afterEase(r),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,r){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,r)}if(!t){const c=this.handlers;c&&c.stop(!1)}return this}_ease(t,r,c){c.animate===!1||c.duration===0?(t(1),r()):(this._easeStart=s.q.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=r,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((s.q.now()-this._easeStart)/this._easeOptions.duration,1),r=this._onEaseFrame;r&&r(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,r){t=s.bF(t,-180,180);const c=Math.abs(t-r);return Math.abs(t-360-r)<c&&(t-=360),Math.abs(t+360-r)<c&&(t+=360),t}_normalizeCenter(t){const r=this.transform;if(r.maxBounds||r.projection.name!=="globe"&&!r.renderWorldCopies)return;const c=t.lng-r.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&s.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,r,c){const d=Math.ceil(15*r/1e3),m=[],g=t(c.clone());for(let E=0;E<=d;E++){const A=g(E/d);m.push(A.clone())}return m}_preloadTiles(t,r){}}class Vu{constructor(t={}){this.options=t,s.aQ(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const r=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=et("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=et("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);const d=et("span","mapboxgl-ctrl-icon",this._compactButton);return d.setAttribute("aria-hidden","true"),d.setAttribute("title",c),this._innerContainer=et("div","mapboxgl-ctrl-attrib-inner",this._container),r&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),r===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const r=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||s.e.ACCESS_TOKEN}];if(t){const c=r.reduce((d,m,g)=>(m.value&&(d+=`${m.key}=${m.value}${g<r.length-1?"&":""}`),d),"?");t.href=`${s.e.FEEDBACK_URL}/${c}#${Pd(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}const r=this._map.style._mergedSourceCaches;for(const d in r){const m=r[d];if(m.used){const g=m.getSource();g.attribution&&t.indexOf(g.attribution)<0&&t.push(g.attribution)}}t.sort((d,m)=>d.length-m.length),t=t.filter((d,m)=>{for(let g=m+1;g<t.length;g++)if(t[g].indexOf(d)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class us{constructor(){s.aQ(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=et("div","mapboxgl-ctrl");const r=et("a","mapboxgl-ctrl-logo");return r.target="_blank",r.rel="noopener nofollow",r.href="https://www.mapbox.com/",r.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),r.setAttribute("rel","noopener nofollow"),this._container.appendChild(r),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const r in t){const c=t[r].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const r=t[0];this._map.getCanvasContainer().offsetWidth<250?r.classList.add("mapboxgl-compact"):r.classList.remove("mapboxgl-compact")}}}class hs{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const r=++this._id;return this._queue.push({callback:t,id:r,cancelled:!1}),r}remove(t){const r=this._currentlyRunning,c=r?this._queue.concat(r):this._queue;for(const d of c)if(d.id===t)return void(d.cancelled=!0)}run(t=0){const r=this._currentlyRunning=this._queue;this._queue=[];for(const c of r)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class ml{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const r=s.cC((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-r)+this._end*r}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,r,c){this._start=this.getValue(r),this._end=t,this._startTime=r,this._endTime=r+c}}const ya={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class va extends s.A{constructor(t,r,c,d){const{point:m,lngLat:g,originalEvent:E,target:A}=t;super(t.type,{point:m,lngLat:g,originalEvent:E,target:A}),this.preventDefault=()=>{t.preventDefault()},this.id=r,this.interaction=c,this.feature=d}}class kd{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,r){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const c=r.filter;let d=r.type;c&&this.filters.set(t,s.a_(c)),d==="mouseover"&&(d="mouseenter"),d==="mouseout"&&(d="mouseleave");const m=this.interactionsByType.get(d)||new Map;d==="mouseenter"||d==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,r)):m.size===0&&this.map.on(d,this.handleType),m.size===0&&this.interactionsByType.set(d,m),m.set(t,r),this.typeById.set(t,d)}get(t){const r=this.typeById.get(t);if(!r)return;const c=this.interactionsByType.get(r);return c?c.get(t):void 0}remove(t){const r=this.typeById.get(t);if(!r)return;this.typeById.delete(t),this.filters.delete(t);const c=this.interactionsByType.get(r);c&&(c.delete(t),r==="mouseenter"||r==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):c.size===0&&this.map.off(r,this.handleType))}queryTargets(t,r){const c=[];for(const[d,m]of r)m.target&&c.push({targetId:d,target:m.target,filter:this.filters.get(d)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const r=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());r.length&&(t.type="mouseenter",this.handleType(t,r));const c=new Map;for(const[d,{feature:m}]of this.prevHoveredFeatures)this.hoveredFeatures.has(d)||c.set(m.id,m);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){const r=Array.from(this.hoveredFeatures.values()).map(({feature:c})=>c);r.length&&(t.type="mouseleave",this.handleType(t,r)),this.hoveredFeatures.clear()}handleType(t,r){const c=Array.from(this.interactionsByType.get(t.type)).reverse(),d=!!r;r=r||this.queryTargets(t.point,c);const m=t.type==="mouseenter";let g=!1;const E=new Set;for(const A of r){for(const[C,R]of c){if(!R.target)continue;const L=A.variants?A.variants[C]:null;if(L){for(const O of L){if(za(O,A,E,C))continue;const V=new s.cx(A,O),H=Ul(O,A,C);d&&(V.state=this.map.getFeatureState(V));const G=m?this.prevHoveredFeatures.get(H):null,W=new va(t,C,R,V),K=G?G.stop:R.handler(W);if(m&&this.hoveredFeatures.set(H,{feature:A,stop:K}),K!==!1){g=!0;break}}if(g)break}}if(g)break}if(!g)for(const[A,C]of c){const{handler:R,target:L}=C;if(!L&&R(new va(t,A,C,null))!==!1)break}}}function Zi(u,t){if(Array.isArray(u)&&Array.isArray(t)){const r=new Set(u),c=new Set(t);return r.size===c.size&&u.every(d=>c.has(d))}return s.bn(u,t)}const Ho={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},hg={showCompass:!0,showZoom:!0,visualizePitch:!1};class dg{constructor(t,r,c=!1){this._clickTolerance=10,this.element=r,this.mouseRotate=new Ks({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new yc({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),s.aQ(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),r.addEventListener("mousedown",this.mousedown),r.addEventListener("touchstart",this.touchstart,{passive:!1}),r.addEventListener("touchmove",this.touchmove),r.addEventListener("touchend",this.touchend),r.addEventListener("touchcancel",this.reset)}down(t,r){this.mouseRotate.mousedown(t,r),this.mousePitch&&this.mousePitch.mousedown(t,r),pt()}move(t,r){const c=this.map,d=this.mouseRotate.mousemoveWindow(t,r),m=d&&d.bearingDelta;if(m&&c.setBearing(c.getBearing()+m),this.mousePitch){const g=this.mousePitch.mousemoveWindow(t,r),E=g&&g.pitchDelta;E&&c.setPitch(c.getPitch()+E)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart,{passive:!1}),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){ui(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(s.l({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),di(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,di(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=jt(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=jt(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Uu(u,t,r){if(u=new s.bO(u.lng,u.lat),t){const c=new s.bO(u.lng-360,u.lat),d=new s.bO(u.lng+360,u.lat),m=360*Math.ceil(Math.abs(u.lng-r.center.lng)/360),g=r.locationPoint3D(u).distSqr(t),E=t.x<0||t.y<0||t.x>r.width||t.y>r.height;r.locationPoint3D(c).distSqr(t)<g&&(E||Math.abs(c.lng-r.center.lng)<m)?u=c:r.locationPoint3D(d).distSqr(t)<g&&(E||Math.abs(d.lng-r.center.lng)<m)&&(u=d)}for(;Math.abs(u.lng-r.center.lng)>180;){const c=r.locationPoint3D(u);if(c.x>=0&&c.y>=0&&c.x<=r.width&&c.y<=r.height)break;u.lng>r.center.lng?u.lng-=360:u.lng+=360}return u}const Ys={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},Xn={anchor:"center",color:"#3FB1CE",scale:1,draggable:!1,clickTolerance:0,rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class bn extends s.E{constructor(t,r){super(),(t instanceof HTMLElement||r)&&(t=s.l({element:t},r)),s.aQ(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),t=s.l({},Xn,t),this._anchor=t.anchor,this._color=t.color,this._scale=t.scale,this._draggable=t.draggable,this._clickTolerance=t.clickTolerance,this._rotation=t.rotation,this._rotationAlignment=t.rotationAlignment,this._pitchAlignment=t.pitchAlignment,this._occludedOpacity=t.occludedOpacity,this._altitude=t.altitude,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=s.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=s.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",m=>{m.preventDefault()}),this._element.addEventListener("mousedown",m=>{m.preventDefault()});const c=this._element.classList;for(const m in Ys)c.remove(`mapboxgl-marker-anchor-${m}`);c.add(`mapboxgl-marker-anchor-${this._anchor}`);const d=t&&t.className?t.className.trim().split(/\s+/):[];c.add(...d),this._popup=null}_createDefaultMarker(){const t=et("div"),r=ft("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){const c=ft("radialGradient",{id:"shadowGradient"},ft("defs",{},r));ft("stop",{offset:"10%","stop-opacity":.4},c),ft("stop",{offset:"100%","stop-opacity":.05},c),ft("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},r)}return ft("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},r),ft("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},r),ft("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},r),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=s.bO.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||Xn.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const d=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const r=t.code,c=t.charCode||t.keyCode;r!=="Space"&&r!=="Enter"&&c!==32&&c!==13||this.togglePopup()}_onMapClick(t){const r=t.originalEvent.target,c=this._element;this._popup&&(r===c||c.contains(r))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,r=this._pos;if(!t||!r)return!1;const c=t.unproject(r,this._altitude),d=t.getFreeCameraOptions();if(!d.position)return!1;const m=d.position.toLngLat();return m.distanceTo(c)<.9*m.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const r=this._pos;if(!r||r.x<0||r.x>t.transform.width||r.y<0||r.y>t.transform.height)return void this._clearFadeTimer();const c=t.unproject(r,this._altitude);let d;t._showingGlobe()&&s.dK(t.transform,this._lngLat)?d=0:(d=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(d*=this._occludedOpacity)),this._element.style.opacity=`${d}`,this._element.style.pointerEvents=d>0?"auto":"none",this._popup&&this._popup._setOpacity(d),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const r=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${Ys[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${r.x}px,${r.y}px)
        `}_calculateXYTransform(){const t=this._pos,r=this._map,c=this.getPitchAlignment();if(!r||!t||c!=="map")return"";if(!r._showingGlobe()){const A=r.getPitch();return A?`rotateX(${A}deg)`:""}const d=s.c4(s.dL(r.transform,this._lngLat)),m=t.sub(s.dM(r.transform)),g=Math.abs(m.x)+Math.abs(m.y);if(g===0)return"";const E=d/g;return`rotateX(${-m.y*E}deg) rotateY(${m.x*E}deg)`}_calculateZTransform(){const t=this._pos,r=this._map;if(!r||!t)return"";let c=0;const d=this.getRotationAlignment();if(d==="map")if(r._showingGlobe()){const m=r.project(new s.bO(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),g=r.project(new s.bO(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(m);c=s.c4(Math.atan2(g.y,g.x))-90}else c=-r.getBearing();else if(d==="horizon"){const m=s.ae(4,6,r.getZoom()),g=s.dM(r.transform);g.y+=m*r.transform.height;const E=t.sub(g),A=s.c4(Math.atan2(E.y,E.x));c=(A>90?A-270:A+90)*(1-m)}return c+=this._rotation,c?`rotateZ(${c}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);const r=this._map;r&&(r.transform.renderWorldCopies&&(this._lngLat=Uu(this._lngLat,this._pos,r.transform)),this._pos=r.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),r._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(r._showingGlobe()||r.getTerrain()||r.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=s.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const r=this._map;if(!r)return;const c=this._pointerdownPos,d=this._positionDelta;if(c&&d){if(!this._isDragging){const m=this._clickTolerance||r._clickTolerance;if(t.point.dist(c)<m)return;this._isDragging=!0}this._pos=t.point.sub(d),this._lngLat=r.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.A("dragstart"))),this.fire(new s.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new s.A("dragend")),this._state="inactive"}_addDragHandler(t){const r=this._map,c=this._pos;r&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",r.on("mousemove",this._onMove),r.on("touchmove",this._onMove),r.once("mouseup",this._onUp),r.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const r=this._map;return r&&(t?(r.on("mousedown",this._addDragHandler),r.on("touchstart",this._addDragHandler)):(r.off("mousedown",this._addDragHandler),r.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||Xn.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||Xn.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||Xn.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||Xn.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Kn={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},fn={maxWidth:100,unit:"metric"},Fd={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},jn={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},Hp=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Zo(u=new s.P(0,0),t="bottom"){if(typeof u=="number"){const r=Math.round(Math.sqrt(.5*Math.pow(u,2)));switch(t){case"top":return new s.P(0,u);case"top-left":return new s.P(r,r);case"top-right":return new s.P(-r,r);case"bottom":return new s.P(0,-u);case"bottom-left":return new s.P(r,-r);case"bottom-right":return new s.P(-r,-r);case"left":return new s.P(u,0);case"right":return new s.P(-u,0)}return new s.P(0,0)}return u instanceof s.P||Array.isArray(u)?s.P.convert(u):s.P.convert(u[t]||[0,0])}return{version:Q,supported:Ze.supported,setRTLTextPlugin:s.dN,getRTLTextPluginStatus:s.dO,Map:class extends pl{constructor(u){ae.mark(de.create);const t=u;if((u=s.l({},Ho,u)).minZoom!=null&&u.maxZoom!=null&&u.minZoom>u.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(u.minPitch!=null&&u.maxPitch!=null&&u.minPitch>u.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(u.minPitch!=null&&u.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(u.maxPitch!=null&&u.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(u.antialias&&s.dI(window)&&(u.antialias=!1,s.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new tu(u.minZoom,u.maxZoom,u.minPitch,u.maxPitch,u.renderWorldCopies,null,null),u),this._repaint=!!u.repaint,this._interactive=u.interactive,this._minTileCacheSize=u.minTileCacheSize,this._maxTileCacheSize=u.maxTileCacheSize,this._failIfMajorPerformanceCaveat=u.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=u.preserveDrawingBuffer,this._antialias=u.antialias,this._trackResize=u.trackResize,this._bearingSnap=u.bearingSnap,this._refreshExpiredTiles=u.refreshExpiredTiles,this._fadeDuration=u.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=u.crossSourceCollisions,this._collectResourceTiming=u.collectResourceTiming,this._language=this._parseLanguage(u.language),this._worldview=u.worldview,this._renderTaskQueue=new hs,this._domRenderTaskQueue=new hs,this._controls=[],this._markers=[],this._popups=[],this._mapId=s.aW(),this._locale=s.l({},ya,u.locale),this._clickTolerance=u.clickTolerance,this._cooperativeGestures=u.cooperativeGestures,this._performanceMetricsCollection=u.performanceMetricsCollection,this._tessellationStep=u.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=u.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new ml(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=u.scaleFactor,this._requestManager=new Fr(u.transformRequest,u.accessToken,u.testMode),this._silenceAuthErrors=!!u.testMode,this._contextCreateOptions=u.contextCreateOptions?Object.assign({},u.contextCreateOptions):{},typeof u.container=="string"){const r=document.getElementById(u.container);if(!r)throw new Error(`Container '${u.container.toString()}' not found.`);this._container=r}else{if(!(u.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=u.container}if(this._container.childNodes.length>0&&s.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),u.maxBounds&&this.setMaxBounds(u.maxBounds),this._spriteFormat=u.spriteFormat,s.aQ(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Sd),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new qp(this,u),this._localFontFamily=u.localFontFamily,this._localIdeographFontFamily=u.localIdeographFontFamily,(u.style||!u.testMode)&&this.setStyle(u.style||s.e.DEFAULT_STYLE,{config:u.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),u.projection&&this.setProjection(u.projection),this.indoor=new sp(this),u.hash&&(this._hash=new Cd(typeof u.hash=="string"&&u.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:u.center,zoom:u.zoom,bearing:u.bearing,pitch:u.pitch});const r=u.bounds;r&&(this.resize(),this.fitBounds(r,s.l({},u.fitBoundsOptions,{duration:0})))}this.resize(),u.attributionControl&&this.addControl(new Vu({customAttribution:u.customAttribution})),this._logoControl=new us,this.addControl(this._logoControl,u.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",r=>{this._update(r.dataType==="style"),this.fire(new s.A(`${r.dataType}data`,r))}),this.on("dataloading",r=>{this.fire(new s.A(`${r.dataType}dataloading`,r))}),this._interactions=new kd(this)}_getMapId(){return this._mapId}addControl(u,t){if(t===void 0&&(t=u.getDefaultPosition?u.getDefaultPosition():"top-right"),!u||!u.onAdd)return this.fire(new s.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const r=u.onAdd(this);this._controls.push(u);const c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(r,c.firstChild):c.appendChild(r),this}removeControl(u){if(!u||!u.onRemove)return this.fire(new s.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(u);return t>-1&&this._controls.splice(t,1),u.onRemove(this),this}hasControl(u){return this._controls.indexOf(u)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(u){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new s.A("movestart",u)).fire(new s.A("move",u)),this.fire(new s.A("resize",u)),t&&this.fire(new s.A("moveend",u)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(u){return this.transform.setMaxBounds(s.aB.convert(u)),this._update()}setMinZoom(u){if((u=u??-2)>=-2&&u<=this.transform.maxZoom)return this.transform.minZoom=u,this._update(),this.getZoom()<u?this.setZoom(u):this.fire(new s.A("zoomstart")).fire(new s.A("zoom")).fire(new s.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(u){if((u=u??22)>=this.transform.minZoom)return this.transform.maxZoom=u,this._update(),this.getZoom()>u?this.setZoom(u):this.fire(new s.A("zoomstart")).fire(new s.A("zoom")).fire(new s.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(u){if((u=u??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(u>=0&&u<=this.transform.maxPitch)return this.transform.minPitch=u,this._update(),this.getPitch()<u?this.setPitch(u):this.fire(new s.A("pitchstart")).fire(new s.A("pitch")).fire(new s.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(u){if((u=u??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(u>=this.transform.minPitch)return this.transform.maxPitch=u,this._update(),this.getPitch()>u?this.setPitch(u):this.fire(new s.A("pitchstart")).fire(new s.A("pitch")).fire(new s.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(u){return this._scaleFactor=u,this.painter.scaleFactor=u,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(u){return this.transform.renderWorldCopies=u,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(u){return u==="auto"?navigator.language:Array.isArray(u)?u.length===0?void 0:u.map(t=>t==="auto"?navigator.language:t):u}setLanguage(u){const t=this._parseLanguage(u);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const r of this._controls)r._setLanguage&&r._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(u){return this.style&&u!==this._worldview?(this._worldview=u,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(u){return this._lazyInitEmptyStyle(),u?typeof u=="string"&&(u={name:u}):u=null,this._useExplicitProjection=!!u,this._prioritizeAndUpdateProjection(u,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const u=this.transform,t=u.projection.name;let r;t==="globe"&&u.zoom>=s.bY?(u.setMercatorFromTransition(),r=!0):t==="mercator"&&u.zoom<s.bY&&(u.setProjection({name:"globe"}),r=!0),r&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(u,t){return this._updateProjection(u||t||{name:"mercator"})}_updateProjection(u){let t;return t=u.name==="globe"&&this.transform.zoom>=s.bY?this.transform.setMercatorFromTransition():this.transform.setProjection(u),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(u,t){return this.transform.locationPoint3D(s.bO.convert(u),t)}unproject(u,t){return this.transform.pointLocation3D(s.P.convert(u),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(u,t,r){const c=d=>{let m=[];if(Array.isArray(t)){const g=t.filter(E=>this.getLayer(E));m=g.length?this.queryRenderedFeatures(d,{layers:g}):[]}else m=this.queryRenderedFeatures(d,{target:t});return m};if(u==="mouseenter"||u==="mouseover"){let d=!1;return{listener:r,targets:t,delegates:{mousemove:g=>{const E=c(g.point);E.length?d||(d=!0,r.call(this,new Wn(u,this,g.originalEvent,{features:E}))):d=!1},mouseout:()=>{d=!1}}}}if(u==="mouseleave"||u==="mouseout"){let d=!1;return{listener:r,targets:t,delegates:{mousemove:E=>{c(E.point).length?d=!0:d&&(d=!1,r.call(this,new Wn(u,this,E.originalEvent)))},mouseout:E=>{d&&(d=!1,r.call(this,new Wn(u,this,E.originalEvent)))}}}}{const d=m=>{const g=c(m.point);g.length&&(m.features=g,r.call(this,m),delete m.features)};return{listener:r,targets:t,delegates:{[u]:d}}}}on(u,t,r){if(typeof t=="function"||r===void 0)return super.on(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(u,t,r);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[u]=this._delegatedListeners[u]||[],this._delegatedListeners[u].push(c);for(const d in c.delegates)this.on(d,c.delegates[d]);return this}once(u,t,r){if(typeof t=="function"||r===void 0)return super.once(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(u,t,r);for(const d in c.delegates)this.once(d,c.delegates[d]);return this}off(u,t,r){if(typeof t=="function"||r===void 0)return super.off(u,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._delegatedListeners?this._delegatedListeners[u]:void 0;return c&&(d=>{for(let m=0;m<d.length;m++){const g=d[m];if(g.listener===r&&Zi(g.targets,t)){for(const E in g.delegates)this.off(E,g.delegates[E]);return d.splice(m,1),this}}})(c),this}queryRenderedFeatures(u,t){if(!this.style)return[];if(u===void 0||u instanceof s.P||Array.isArray(u)||t!==void 0||(t=u,u=void 0),u=u||[[0,0],[this.transform.width,this.transform.height]],!t){const m=this.style.queryRenderedFeatures(u,void 0,this.transform),g=this.style.queryRenderedFeatureset(u,void 0,this.transform);return m.concat(g)}let r=!0;if(t.target&&(r=this._isTargetValid(t.target),r&&!t.layers))return this.style.queryRenderedFeatureset(u,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(const m of t.layers)if(!this._isValidId(m)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(u,t,this.transform)}let d=[];return c&&(d=d.concat(this.style.queryRenderedFeatures(u,t,this.transform))),r&&(d=d.concat(this.style.queryRenderedFeatureset(u,t,this.transform))),d}querySourceFeatures(u,t){return!u||typeof u=="string"&&!this._isValidId(u)?[]:this.style.querySourceFeatures(u,t)}isPointOnSurface(u){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&s.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(s.P.convert(u))}addInteraction(u,t){return this._interactions.add(u,t),this}removeInteraction(u){return this._interactions.remove(u),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(u){return this._cooperativeGestures=u,this}setStyle(u,t){return t=s.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&u&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(u,(r,c)=>{r?(s.w(`Unable to perform style diff: ${String(r.message||r.error||r)}. Rebuilding the style from scratch.`),this._updateStyle(u,t)):c&&this._update(!0)},()=>{this._postStyleLoadEvent()}),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(u,t))}_getUIString(u){const t=this._locale[u];if(t==null)throw new Error(`Missing UI string '${u}'`);return t}_updateStyle(u,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),u){const r=s.l({},t);t&&t.config&&(r.initialConfig=t.config,delete r.config),this.style=new Fs(this,r).load(u),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Fs(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(s.w("There is no style added to the map."),!1)}_isValidId(u){return u==null?(this.fire(new s.z(new Error("IDs can't be empty."))),!1):!s.cs(u)||(this.fire(new s.z(new Error(`IDs can't contain special symbols: "${u}".`))),!1)}_isTargetValid(u){return"featuresetId"in u?this._isValidId("importId"in u?u.importId:u.featuresetId):"layerId"in u&&this._isValidId(u.layerId)}_areTargetsValid(u){if(Array.isArray(u)){for(const t of u)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(u)}addSource(u,t){return this._isValidId(u)?(this._lazyInitEmptyStyle(),this.style.addSource(u,t),this._update(!0)):this}isSourceLoaded(u){return!!this._isValidId(u)&&!!this.style&&this.style._isSourceCacheLoaded(u)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(u,t,r){this._lazyInitEmptyStyle(),this.style.addSourceType(u,t,r)}removeSource(u){return this._isValidId(u)?(this.style.removeSource(u),this._updateTerrain(),this._update(!0)):this}getSource(u){return this._isValidId(u)?this.style.getOwnSource(u):null}addImage(u,t,{pixelRatio:r=1,sdf:c=!1,stretchX:d,stretchY:m,content:g}={}){this._lazyInitEmptyStyle();const E=s.I.from(u);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:A,height:C,data:R}=s.q.getImageData(t);this.style.addImage(E,{data:new s.r({width:A,height:C},R),pixelRatio:r,stretchX:d,stretchY:m,content:g,sdf:c,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new s.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:A,height:C}=t,R=t;this.style.addImage(E,{data:new s.r({width:A,height:C},new Uint8Array(R.data)),pixelRatio:r,stretchX:d,stretchY:m,content:g,sdf:c,usvg:!1,version:0,userImage:R}),R.onAdd&&R.onAdd(this,u)}}updateImage(u,t){this._lazyInitEmptyStyle();const r=s.I.from(u),c=this.style.getImage(r);if(!c)return void this.fire(new s.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const d=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?s.q.getImageData(t):t,{width:m,height:g,data:E}=d;if(m===void 0||g===void 0)return void this.fire(new s.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(m!==(c.usvg?c.icon.usvg_tree.width:c.data.width)||g!==(c.usvg?c.icon.usvg_tree.height:c.data.height))return void this.fire(new s.z(new Error(`The width and height of the updated image (${m}, ${g})
                must be that same as the previous version of the image
                (${c.data.width}, ${c.data.height})`)));const A=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let C=!1;c.usvg?(c.data=new s.r({width:m,height:g},new Uint8Array(E)),c.usvg=!1,c.icon=void 0,C=!0):c.data.replace(E,A),this.style.updateImage(r,c,C)}hasImage(u){return u?!!this.style&&!!this.style.getImage(s.I.from(u)):(this.fire(new s.z(new Error("Missing required image id"))),!1)}removeImage(u){this.style.removeImage(s.I.from(u))}loadImage(u,t){s.o(this._requestManager.transformRequest(u,s.R.Image),(r,c)=>{t(r,c instanceof HTMLImageElement?s.q.getImageData(c):c)})}listImages(){return this.style.listImages().map(u=>u.name)}addModel(u,t){this._lazyInitEmptyStyle(),this.style.addModel(u,t)}hasModel(u){return u?this.style.hasModel(u):(this.fire(new s.z(new Error("Missing required model id"))),!1)}removeModel(u){this.style.removeModel(u)}listModels(){return this.style.listModels()}addLayer(u,t){return this._isValidId(u.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(u,t),this._update(!0)):this}getSlot(u){const t=this.getLayer(u);return t&&t.slot||null}setSlot(u,t){return this.style.setSlot(u,t),this.style.mergeLayers(),this._update(!0)}addImport(u,t){return this.style.addImport(u,t),this}updateImport(u,t){return typeof t!="string"&&t.id!==u?(this.removeImport(u),this.addImport(t)):(this.style.updateImport(u,t),this._update(!0))}removeImport(u){return this.style.removeImport(u),this}moveImport(u,t){return this.style.moveImport(u,t),this._update(!0)}moveLayer(u,t){return this._isValidId(u)?(this.style.moveLayer(u,t),this._update(!0)):this}removeLayer(u){return this._isValidId(u)?(this.style.removeLayer(u),this._update(!0)):this}getLayer(u){if(!this._isValidId(u))return null;const t=this.style.getOwnLayer(u);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(u,t,r){return this._isValidId(u)?(this.style.setLayerZoomRange(u,t,r),this._update(!0)):this}setFilter(u,t,r={}){return this._isValidId(u)?(this.style.setFilter(u,t,r),this._update(!0)):this}getFilter(u){return this._isValidId(u)?this.style.getFilter(u):null}setPaintProperty(u,t,r,c={}){return this._isValidId(u)?(this.style.setPaintProperty(u,t,r,c),this._update(!0)):this}getPaintProperty(u,t){return this._isValidId(u)?this.style.getPaintProperty(u,t):null}setLayoutProperty(u,t,r,c={}){return this._isValidId(u)?(this.style.setLayoutProperty(u,t,r,c),this._update(!0)):this}getLayoutProperty(u,t){return this._isValidId(u)?this.style.getLayoutProperty(u,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(u){return this.style.setGlyphsUrl(u),this._update(!0)}getSchema(u){return this.style.getSchema(u)}setSchema(u,t){return this.style.setSchema(u,t),this._update(!0)}getConfig(u){return this.style.getConfig(u)}setConfig(u,t){return this.style.setConfig(u,t),this._update(!0)}getConfigProperty(u,t){return this.style.getConfigProperty(u,t)}setConfigProperty(u,t,r){return this.style.setConfigProperty(u,t,r),this._update(!0)}getFeaturesetDescriptors(u){return this.style.getFeaturesetDescriptors(u)}setLights(u){if(this._lazyInitEmptyStyle(),u&&u.length===1&&u[0].type==="flat"){const t=u[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(u),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const u=this.style.getLights()||[];return u.length===0&&u.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),u}setLight(u,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:u}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(u){return this._lazyInitEmptyStyle(),!u&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(u),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(u){return this._lazyInitEmptyStyle(),this.style.setFog(u),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(u){return this._lazyInitEmptyStyle(),this.style.setSnow(u),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(u){return this._lazyInitEmptyStyle(),this.style.setRain(u),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(u){return this._lazyInitEmptyStyle(),this.style.setColorTheme(u),this._update(!0)}setImportColorTheme(u,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(u,t),this._update(!0)}setCamera(u){return this.style.setCamera(u),this._triggerCameraUpdate(u)}_triggerCameraUpdate(u){return this._update(this.transform.setOrthographicProjectionAtLowPitch(u["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(u){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(s.bO.convert(u),this.transform):0}setFeatureState(u,t){return u.source&&!this._isValidId(u.source)?this:(this.style.setFeatureState(u,t),this._update())}removeFeatureState(u,t){return u.source&&!this._isValidId(u.source)?this:(this.style.removeFeatureState(u,t),this._update())}getFeatureState(u){return u.source&&!this._isValidId(u.source)?null:this.style.getFeatureState(u)}_updateContainerDimensions(){if(!this._container)return;const u=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let r,c,d,m=this._container;for(;m&&(!c||!d);){const g=window.getComputedStyle(m).transform;g&&g!=="none"&&(r=g.match(/matrix.*\((.+)\)/)[1].split(", "),r[0]&&r[0]!=="0"&&r[0]!=="1"&&(c=r[0]),r[3]&&r[3]!=="0"&&r[3]!=="1"&&(d=r[3])),m=m.parentElement}this._containerWidth=c?Math.abs(u/c):u,this._containerHeight=d?Math.abs(t/d):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&s.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const u=this._container;u.classList.add("mapboxgl-map"),(this._missingCSSCanary=et("div","mapboxgl-canary",u)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=et("div","mapboxgl-canvas-container",u);this._canvas=et("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const r=this._controlContainer=et("div","mapboxgl-control-container",u),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(d=>{c[d]=et("div",`mapboxgl-ctrl-${d}`,r)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(u,t){const r=s.q.devicePixelRatio||1;this._canvas.width=r*Math.ceil(u),this._canvas.height=r*Math.ceil(t),this._canvas.style.width=`${u}px`,this._canvas.style.height=`${t}px`}_addMarker(u){this._markers.push(u)}_removeMarker(u){const t=this._markers.indexOf(u);t!==-1&&this._markers.splice(t,1)}_addPopup(u){this._popups.push(u)}_removePopup(u){const t=this._popups.indexOf(u);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const u=s.l({},Ze.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",u);t?(ze(t,!0),this.painter=new ku(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",r=>{r.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),s.m.testSupport(t)):this.fire(new s.z(new Error("Failed to initialize WebGL")))}_contextLost(u){u.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new s.A("webglcontextlost",{originalEvent:u}))}_contextRestored(u){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style.reloadModels(),this.style.clearSources(),this._update(),this.fire(new s.A("webglcontextrestored",{originalEvent:u}))}_onMapScroll(u){if(u.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(u){return this.style?(this._styleDirty=this._styleDirty||u,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(u){return this._update(),this._renderTaskQueue.add(u)}_cancelRenderFrame(u){this._renderTaskQueue.remove(u)}_requestDomTask(u){!this.loaded()||this.loaded()&&!this.isMoving()?u():this._domRenderTaskQueue.add(u)}_render(u){let t;this.fire(new s.A("renderstart")),++this._frameId;const r=this.painter.context.extTimerQuery,c=s.q.now(),d=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=d.createQuery(),d.beginQuery(r.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(u),this._domRenderTaskQueue.run(u),this._removed)return;this._updateProjectionTransition();const m=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const C=this.transform.zoom,R=this.transform.pitch,L=s.q.now(),O=new s.aa(C,{now:L,fadeDuration:m,pitch:R,transition:this.style.transition});this.style.update(O)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let g=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),g=this._updateAverageElevation(c),this.style.updateSources(this.transform),this.isMoving()||this._forceMarkerAndPopupUpdate()):g=this._updateAverageElevation(c);const E=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,m,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),E&&(this._placementDirty=E.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:m,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new s.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,ae.mark(de.load),this.fire(new s.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const C=s.q.now()-c;d.endQuery(r.TIME_ELAPSED_EXT),setTimeout(()=>{const R=d.getQueryParameter(t,d.QUERY_RESULT)/1e6;d.deleteQuery(t),this.fire(new s.A("gpu-timing-frame",{cpuTime:C,gpuTime:R}))},50)}if(this.listens("gpu-timing-layer")){const C=this.painter.collectGpuTimers();setTimeout(()=>{const R=this.painter.queryGpuTimers(C);this.fire(new s.A("gpu-timing-layer",{layerTimes:R}))},50)}if(this.listens("gpu-timing-deferred-render")){const C=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const R=this.painter.queryGpuTimeDeferredRender(C);this.fire(new s.A("gpu-timing-deferred-render",{gpuTime:R}))},50)}const A=this._sourcesDirty||this._styleDirty||this._placementDirty||g;if(A||this._repaint)this.triggerRepaint();else{const C=this.idle();if(C&&(g=this._updateAverageElevation(c,!0)),g)this.triggerRepaint();else if(this._triggerFrame(!1),C&&(this.fire(new s.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const R=this._calculateSpeedIndex();this.fire(new s.A("speedindexcompleted",{speedIndex:R})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||A||(this._fullyLoaded=!0,ae.mark(de.fullLoad),this._performanceMetricsCollection&&Qt(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(u){for(const t of this._markers)u&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!u||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(u,t=!1){const r=d=>(this.transform.averageElevation=d,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&r(0);const c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||u-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(u)){const d=this.transform.averageElevation;let m=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(m)?m=0:this._averageElevationLastSampledAt=u;const g=Math.abs(d-m);if(g>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(m),r(m);this._averageElevation.easeTo(m,u,300)}else if(g>1e-4)return this._averageElevation.jumpTo(m),r(m)}return!!this._averageElevation.isEasing(u)&&r(this._averageElevation.getValue(u))}_authenticate(){J(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,u=>{if(u&&(u.message===Ci||u.status===401)){const t=this.painter.context.gl;ze(t,!1),this._logoControl instanceof us&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new s.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),qr(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&fr(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const u=this._isDragging();this.painter.updateTerrain(this.style,u)}_calculateSpeedIndex(){const u=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const r=this.painter.context.gl,c=r.createFramebuffer();function d(m){r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,m,0);const g=new Uint8Array(r.drawingBufferWidth*r.drawingBufferHeight*4);return r.readPixels(0,0,r.drawingBufferWidth,r.drawingBufferHeight,r.RGBA,r.UNSIGNED_BYTE,g),g}return r.bindFramebuffer(r.FRAMEBUFFER,c),this._canvasPixelComparison(d(u),t.canvasCopies.map(d),t.timeStamps)}_canvasPixelComparison(u,t,r){let c=r[1]-r[0];const d=u.length/4;for(let m=0;m<t.length;m++){const g=t[m];let E=0;for(let A=0;A<g.length;A+=4)g[A]===u[A]&&g[A+1]===u[A+1]&&g[A+2]===u[A+2]&&g[A+3]===u[A+3]&&(E+=1);c+=(r[m+2]-r[m+1])*(1-E/d)}return c}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const u=this.painter.context.gl.getExtension("WEBGL_lose_context");u&&u.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),pr.delete(this.painter.context.gl),Kt.remove(),Zt.remove(),this._removed=!0,this.fire(new s.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(u){this._renderNextFrame=this._renderNextFrame||u,this.style&&!this._frame&&(this._frame=s.q.frame(t=>{const r=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,r&&this._render(t)}))}_preloadTiles(u){const t=this.style?this.style.getSourceCaches():[];return s.bl(t,(r,c)=>r._preloadTiles(u,c),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(u){this._trackResize&&this.resize({originalEvent:u})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(u){this._showTileBoundaries!==u&&(this._showTileBoundaries=u,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(u){this._showParseStatus!==u&&(this._showParseStatus=u,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(u){this._showTerrainWireframe!==u&&(this._showTerrainWireframe=u,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(u){this._showLayers2DWireframe!==u&&(this._showLayers2DWireframe=u,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(u){this._showLayers3DWireframe!==u&&(this._showLayers3DWireframe=u,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(u){this._speedIndexTiming!==u&&(this._speedIndexTiming=u,this._update())}get showPadding(){return!!this._showPadding}set showPadding(u){this._showPadding!==u&&(this._showPadding=u,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(u){this._showCollisionBoxes!==u&&(this._showCollisionBoxes=u,this._tp.refreshUI(),u?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(u){this._showOverdrawInspector!==u&&(this._showOverdrawInspector=u,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(u){this._repaint!==u&&(this._repaint=u,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(u){this._vertices=u,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(u){this._showTileAABBs!==u&&(this._showTileAABBs=u,this._tp.refreshUI(),u&&this._update())}_setCacheLimits(u,t){s.dJ(u,t)}get version(){return Q}},NavigationControl:class{constructor(u={}){this.options=s.l({},hg,u),this._container=et("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(s.aQ(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),et("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),et("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(s.aQ(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const r=this._map;r&&(this.options.visualizePitch?r.resetNorthPitch({},{originalEvent:t}):r.resetNorth({},{originalEvent:t}))}),this._compassIcon=et("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const u=this._map;if(!u)return;const t=u.getZoom(),r=t===u.getMaxZoom(),c=t===u.getMinZoom();this._zoomInButton.disabled=r,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",r.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){const u=this._map;if(!u)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(u.transform.pitch*(Math.PI/180)),.5)}) rotateX(${u.transform.pitch}deg) rotateZ(${u.transform.angle*(180/Math.PI)}deg)`:`rotate(${u.transform.angle*(180/Math.PI)}deg)`;u._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(u){return this._map=u,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),u.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&u.on("pitch",this._rotateCompassArrow),u.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new dg(u,this._compass,this.options.visualizePitch)),this._container}onRemove(){const u=this._map;u&&(this._container.remove(),this.options.showZoom&&u.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&u.off("pitch",this._rotateCompassArrow),u.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(u,t){const r=et("button",u,this._container);return r.type="button",r.addEventListener("click",t),r}_setButtonTitle(u,t){if(!this._map)return;const r=this._map._getUIString(`NavigationControl.${t}`);u.setAttribute("aria-label",r),u.firstElementChild&&u.firstElementChild.setAttribute("title",r)}},GeolocateControl:class extends s.E{constructor(u={}){super();const t=navigator.geolocation;this.options=s.l({geolocation:t},Kn,u),s.aQ(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Fu(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(u){return this._map=u,this._container=et("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(u){const t=(r=!!this.options.geolocation)=>{this._supportsGeolocation=r,u(r)};this._supportsGeolocation!==void 0?u(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(r=>t(r.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(u){const t=this._map.getMaxBounds(),r=u.coords;return!!t&&(r.longitude<t.getWest()||r.longitude>t.getEast()||r.latitude<t.getSouth()||r.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(u){if(this._map){if(this._isOutOfMapMaxBounds(u))return this._setErrorState(),this.fire(new s.A("outofmaxbounds",u)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=u,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(u),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(u),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.A("geolocate",u)),this._finish()}}_updateCamera(u){const t=new s.bO(u.coords.longitude,u.coords.latitude),r=u.coords.accuracy,c=this._map.getBearing(),d=s.l({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(r),d,{geolocateSource:!0})}_updateMarker(u){if(u){const t=new s.bO(u.coords.longitude,u.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=u.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const u=this._map.transform,t=s.bH(1,u._center.lat)*u.worldSize,r=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${r}px`,this._circleElement.style.height=`${r}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(u){if(this._map){if(this.options.trackUserLocation)if(u.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(u.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.A("error",u)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(u){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=et("button","mapboxgl-ctrl-geolocate",this._container),et("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",u===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=et("div","mapboxgl-user-location"),this._dotElement.appendChild(et("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(et("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new bn({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=et("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new bn({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new s.A("trackuserlocationend")))})}}_onDeviceOrientation(u){this._userLocationDotMarker&&(u.webkitCompassHeading?this._heading=u.webkitCompassHeading:u.absolute===!0&&(this._heading=-1*u.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new s.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let u;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(u={maximumAge:6e5,timeout:0},this._noTimeout=!0):(u=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,u),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const u=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&u()}).catch(console.error):u()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Vu,ScaleControl:class{constructor(u={}){this.options=s.l({},fn,u),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),s.aQ(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const u=this.options.maxWidth||100,t=this._map,r=t._containerHeight/2,c=t._containerWidth/2-u/2,d=t.unproject([c,r]),m=t.unproject([c+u,r]),g=d.distanceTo(m);if(this.options.unit==="imperial"){const E=3.2808*g;E>5280?this._setScale(u,E/5280,"mile"):this._setScale(u,E,"foot")}else this.options.unit==="nautical"?this._setScale(u,g/1852,"nautical-mile"):g>=1e3?this._setScale(u,g/1e3,"kilometer"):this._setScale(u,g,"meter")}_setScale(u,t,r){this._map._requestDomTask(()=>{const c=function(m){const g=Math.pow(10,`${Math.floor(m)}`.length-1);let E=m/g;return E=E>=10?10:E>=5?5:E>=3?3:E>=2?2:E>=1?1:function(A){const C=Math.pow(10,Math.ceil(-Math.log(A)/Math.LN10));return Math.round(A*C)/C}(E),g*E}(t),d=c/t;this._container.innerHTML=this._isNumberFormatSupported&&r!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:r}).format(c):`${c}&nbsp;${Fd[r]}`,this._container.style.width=u*d+"px"})}onAdd(u){return this._map=u,this._language=u.getLanguage(),this._container=et("div","mapboxgl-ctrl mapboxgl-ctrl-scale",u.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(u){this._language=u,this._update()}setUnit(u){this.options.unit=u,this._update()}},FullscreenControl:class{constructor(u={}){this._fullscreen=!1,u&&u.container&&(u.container instanceof HTMLElement?this._container=u.container:s.w("Full screen control 'container' must be a DOM element.")),s.aQ(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(u){return this._map=u,this._container||(this._container=this._map.getContainer()),this._controlContainer=et("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",s.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const u=this._fullscreenButton=et("button","mapboxgl-ctrl-fullscreen",this._controlContainer);et("span","mapboxgl-ctrl-icon",u).setAttribute("aria-hidden","true"),u.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const u=this._getTitle();this._fullscreenButton.setAttribute("aria-label",u),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",u)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends s.E{constructor(u){super(),this.options=s.l(Object.create(jn),u),this._altitude=this.options.altitude,s.aQ(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(u&&u.className?u.className.trim().split(/\s+/):[])}addTo(u){return this._map&&this.remove(),this._map=u,this.options.closeOnClick&&u.on("preclick",this._onClose),this.options.closeOnMove&&u.on("move",this._onClose),u.on("remove",this.remove),this._update(),u._addPopup(this),this._focusFirstElement(),this._trackPointer?(u.on("mousemove",this._onMouseEvent),u.on("mouseup",this._onMouseEvent),u._canvasContainer.classList.add("mapboxgl-track-pointer")):u.on("move",this._update),this.fire(new s.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const u=this._map;return u&&(u.off("move",this._update),u.off("move",this._onClose),u.off("preclick",this._onClose),u.off("click",this._onClose),u.off("remove",this.remove),u.off("mousemove",this._onMouseEvent),u.off("mouseup",this._onMouseEvent),u.off("drag",this._onMouseEvent),u._canvasContainer&&u._canvasContainer.classList.remove("mapboxgl-track-pointer"),u._removePopup(this),this._map=void 0),this.fire(new s.A("close")),this}getLngLat(){return this._lngLat}setLngLat(u){this._lngLat=s.bO.convert(u),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(u){return this._altitude=u,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const u=this._map;return u&&(u.off("move",this._update),u.on("mousemove",this._onMouseEvent),u.on("drag",this._onMouseEvent),u._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(u){return this.setDOMContent(document.createTextNode(u))}setHTML(u){const t=document.createDocumentFragment(),r=document.createElement("body");let c;for(r.innerHTML=u;c=r.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(u){return this.options.maxWidth=u,this._update(),this}setDOMContent(u){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=et("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(u),this.options.closeButton){const r=this._closeButton=et("button","mapboxgl-popup-close-button",t);r.type="button",r.setAttribute("aria-label","Close popup"),r.innerHTML='<span aria-hidden="true">&#215;</span>',r.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(u){return this._classList.add(u),this._updateClassList(),this}removeClassName(u){return this._classList.delete(u),this._updateClassList(),this}setOffset(u){return this.options.offset=u,this._update(),this}toggleClassName(u){let t;return this._classList.delete(u)?t=!1:(this._classList.add(u),t=!0),this._updateClassList(),t}_onMouseEvent(u){this._update(u.point)}_getAnchor(u){if(this.options.anchor)return this.options.anchor;const t=this._map,r=this._container,c=this._pos;if(!t||!r||!c)return"bottom";const d=r.offsetWidth,m=r.offsetHeight,g=c.x<d/2,E=c.x>t.transform.width-d/2;if(c.y+u<m)return g?"top-left":E?"top-right":"top";if(c.y>t.transform.height-m){if(g)return"bottom-left";if(E)return"bottom-right"}return g?"left":E?"right":"bottom"}_updateClassList(){const u=this._container;if(!u)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),u.className=t.join(" ")}_update(u){const t=this._map,r=this._content;if(!t||!this._lngLat&&!this._trackPointer||!r)return;let c=this._container;if(c||(c=this._container=et("div","mapboxgl-popup",t.getContainer()),this._tip=et("div","mapboxgl-popup-tip",c),c.appendChild(r)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Uu(this._lngLat,this._pos,t.transform)),!this._trackPointer||u){const d=this._pos=this._trackPointer&&u instanceof s.P?u:t.project(this._lngLat,this._altitude),m=Zo(this.options.offset),g=this._anchor=this._getAnchor(m.y),E=Zo(this.options.offset,g),A=d.add(E).round();t._requestDomTask(()=>{this._container&&g&&(this._container.style.transform=`${Ys[g]} translate(${A.x}px,${A.y}px)`)})}if(!this._marker&&t._showingGlobe()){const d=s.dK(t.transform,this._lngLat)?0:1;this._setOpacity(d)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const u=this._container.querySelector(Hp);u&&u.focus()}_onClose(){this.remove()}_setOpacity(u){this._container&&(this._container.style.opacity=`${u}`),this._content&&(this._content.style.pointerEvents=u?"auto":"none")}},Marker:bn,Style:Fs,LngLat:s.bO,LngLatBounds:s.aB,Point:s.P,MercatorCoordinate:s.ac,FreeCameraOptions:zh,Evented:s.E,config:s.e,prewarm:s.dP,clearPrewarmedResources:s.dQ,get accessToken(){return s.e.ACCESS_TOKEN},set accessToken(u){s.e.ACCESS_TOKEN=u},get baseApiUrl(){return s.e.API_URL},set baseApiUrl(u){s.e.API_URL=u},get workerCount(){return s.dR.workerCount},set workerCount(u){s.dR.workerCount=u},get maxParallelImageRequests(){return s.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(u){s.e.MAX_PARALLEL_IMAGE_REQUESTS=u},clearStorage(u){s.dS(u)},get workerUrl(){return s.dT.workerUrl},set workerUrl(u){s.dT.workerUrl=u},get workerClass(){return s.dT.workerClass},set workerClass(u){s.dT.workerClass=u},get workerParams(){return s.dT.workerParams},set workerParams(u){s.dT.workerParams=u},get dracoUrl(){return s.dU()},set dracoUrl(u){s.dV(u)},get meshoptUrl(){return s.dW()},set meshoptUrl(u){s.dX(u)},setNow:s.q.setNow,restoreNow:s.q.restoreNow}});var $=k;return $})}(Xm)),Xm.exports}var G3=j3();const Qn=V3(G3),q3={class:"form-wrapper"},$3={class:"form-section"},H3={class:"form-group"},Z3={class:"form-group"},W3={class:"form-group"},X3={class:"location-section"},K3={class:"form-group"},Y3={class:"input-with-action"},J3={class:"form-group"},Q3={class:"map-container"},eR={key:0,class:"map-hint"},tR={key:0,class:"points-section"},iR={class:"points-list"},rR={class:"point-info"},nR={class:"point-type"},sR={class:"point-desc"},oR=["onClick"],aR={key:0,class:"modal-overlay"},lR={class:"point-modal"},cR={class:"form-group"},uR={class:"form-group"},hR={__name:"MapForm",setup(f){Qn.accessToken=" accessToken ";const v=Oi(""),I=Oi(""),P=Oi(null),k=Oi(null),j=Oi(null),$=Oi(null),s=Oi(""),Q=Oi(""),de=Oi(null),ae=Oi([]),Te=Oi(!1),Ne=Oi(null),Re=Oi(""),Ze=Oi(""),et=Oi(!1),ft=Oi(null),vt=Oi(null);let gt,Vt=[],pt=null;function ui(Ti){const Bt=Ti.target.files[0];Bt&&(de.value=Bt)}function zi(Ti,Bt,gi,Zt=null){const qr=document.createElement("div");qr.className="custom-marker";const yn={:"",:"",:""," ":""," ":"",Start:"",End:"","Current Location":""};qr.innerHTML=yn[gi]||"";const fr=new Qn.Marker(qr).setLngLat([Ti,Bt]).addTo(gt);Zt&&(fr.getElement().dataset.pointId=Zt,fr.getElement().addEventListener("click",()=>st(Zt))),Vt.push(fr)}function Pt(){Vt.forEach(Ti=>Ti.remove()),Vt=[]}function di(){P.value=null,k.value=null,j.value=null,$.value=null,s.value="",Q.value="",v.value="",I.value="",de.value=null,ae.value=[],et.value=!1,Pt(),gt.getSource("route")&&(gt.removeLayer("route"),gt.removeSource("route"))}function jt(Ti){const{lng:Bt,lat:gi}=Ti.lngLat;P.value?j.value?et.value&&(Ne.value={lng:Bt,lat:gi},Te.value=!0):(j.value=gi,$.value=Bt,zi(Bt,gi,"End"),Ci([k.value,P.value],[Bt,gi])):(P.value=gi,k.value=Bt,zi(Bt,gi,"Start"))}function st(Ti){const Bt=ae.value.find(gi=>gi.id===Ti);Bt&&(pt&&pt.remove(),pt=new Qn.Popup({offset:25}).setLngLat([Bt.longitude,Bt.latitude]).setHTML(`
      <div class="point-popup">
        <h4>${Bt.name}</h4>
        <p>${Bt.description||" "}</p>
      </div>
    `).addTo(gt))}async function zt(){if(!Ne.value||!Re.value){alert("  ");return}const Ti={name:Re.value,description:Ze.value,latitude:parseFloat(Ne.value.lat.toFixed(6)),longitude:parseFloat(Ne.value.lng.toFixed(6))};ae.value.push(Ti),zi(Ne.value.lng,Ne.value.lat,Re.value),ji()}function ji(){Te.value=!1,Re.value="",Ze.value="",Ne.value=null}async function Ci(Ti,Bt){var mt;const gi=`https://api.mapbox.com/directions/v5/mapbox/driving/${Ti.join(",")};${Bt.join(",")}?geometries=geojson&access_token=${Qn.accessToken}`,yn=(mt=(await(await fetch(gi)).json()).routes[0])==null?void 0:mt.geometry;gt.getSource("route")&&(gt.removeLayer("route"),gt.removeSource("route")),gt.addSource("route",{type:"geojson",data:{type:"Feature",geometry:yn}}),gt.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}),et.value=!0;const fr=new Qn.LngLatBounds;yn.coordinates.forEach(Qt=>fr.extend(Qt)),gt.fitBounds(fr,{padding:50,maxZoom:14})}async function Fr(Ti){var Zt,qr;return(qr=(Zt=(await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(Ti)}.json?`+new URLSearchParams({access_token:Qn.accessToken,proximity:"74.5698,42.8746",country:"KG"}))).json()).features[0])==null?void 0:Zt.geometry)==null?void 0:qr.coordinates}async function oi(){if(s.value&&Q.value){const Ti=await Fr(s.value),Bt=await Fr(Q.value);Ti&&Bt&&(k.value=Ti[0],P.value=Ti[1],$.value=Bt[0],j.value=Bt[1],Pt(),zi(Ti[0],Ti[1],"Start"),zi(Bt[0],Bt[1],"End"),await Ci(Ti,Bt))}}dh([s,Q],()=>{oi()});async function Yi(){if(!navigator.geolocation){alert("  .");return}navigator.geolocation.getCurrentPosition(async Ti=>{var fr;const{latitude:Bt,longitude:gi}=Ti.coords;P.value=Bt,k.value=gi;const yn=((fr=(await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${gi},${Bt}.json?access_token=${Qn.accessToken}`)).json()).features[0])==null?void 0:fr.place_name)||" ";s.value=yn,zi(gi,Bt,"Current Location"),gt.setCenter([gi,Bt])},Ti=>{alert("   : "+Ti.message)})}async function bi(){const Ti=localStorage.getItem("token");if(!Ti)return;const Bt=JSON.parse(atob(Ti.split(".")[1])),gi=Bt.sub||Bt.username;try{const Zt=await Wr.get(`/${gi}`,{headers:{Authorization:`Bearer ${Ti}`}});ft.value=Zt.data.id}catch(Zt){console.error("   :",Zt),alert("    ")}}async function nr(){var gi,Zt;if(!v.value||!P.value||!j.value){alert("   ");return}const Ti=localStorage.getItem("token");if(!Ti){alert("  !");return}const Bt=new FormData;Bt.append("name",v.value),Bt.append("description",I.value),Bt.append("startLat",P.value),Bt.append("startLng",k.value),Bt.append("endLat",j.value),Bt.append("endLng",$.value),Bt.append("startLocation",s.value),Bt.append("endLocation",Q.value),Bt.append("userId",ft.value),Bt.append("points",JSON.stringify(ae.value)),de.value&&Bt.append("finishImage",de.value);try{await Wr.post("/save-route",Bt,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${Ti}`}}),alert(" !"),di()}catch(qr){alert(": "+(((Zt=(gi=qr.response)==null?void 0:gi.data)==null?void 0:Zt.message)||qr.message))}}function hi(){gt=new Qn.Map({container:vt.value,style:"mapbox://styles/mapbox/streets-v11",center:[74.5698,42.8746],zoom:10}),gt.on("click",jt)}return xh(()=>{hi(),bi()}),(Ti,Bt)=>(ki(),Vi("div",q3,[Bt[16]||(Bt[16]=Pe("h2",null," ",-1)),Pe("form",{onSubmit:_h(nr,["prevent"]),class:"route-form"},[Pe("div",$3,[Pe("div",H3,[Bt[6]||(Bt[6]=Pe("label",null,"  *",-1)),Dn(Pe("input",{type:"text","onUpdate:modelValue":Bt[0]||(Bt[0]=gi=>v.value=gi),placeholder:" ",required:""},null,512),[[Bn,v.value]])]),Pe("div",Z3,[Bt[7]||(Bt[7]=Pe("label",null," ",-1)),Dn(Pe("textarea",{"onUpdate:modelValue":Bt[1]||(Bt[1]=gi=>I.value=gi),placeholder:" "},null,512),[[Bn,I.value]])]),Pe("div",W3,[Bt[8]||(Bt[8]=Pe("label",null," ",-1)),Pe("input",{type:"file",onChange:ui,accept:"image/*"},null,32)])]),Pe("div",X3,[Pe("div",K3,[Bt[9]||(Bt[9]=Pe("label",null,"  *",-1)),Pe("div",Y3,[Dn(Pe("input",{type:"text","onUpdate:modelValue":Bt[2]||(Bt[2]=gi=>s.value=gi),placeholder:"  ",required:""},null,512),[[Bn,s.value]]),Pe("button",{type:"button",onClick:Yi,class:"geo-btn"},"")])]),Pe("div",J3,[Bt[10]||(Bt[10]=Pe("label",null,"  *",-1)),Dn(Pe("input",{type:"text","onUpdate:modelValue":Bt[3]||(Bt[3]=gi=>Q.value=gi),placeholder:"  ",required:""},null,512),[[Bn,Q.value]])])]),Pe("div",Q3,[Pe("div",{ref_key:"mapContainer",ref:vt,class:"map"},null,512),et.value?(ki(),Vi("div",eR,"    ,     ")):Cs("",!0)]),ae.value.length>0?(ki(),Vi("div",tR,[Pe("h3",null,"  ("+xr(ae.value.length)+")",1),Pe("div",iR,[(ki(!0),Vi(Is,null,kf(ae.value,(gi,Zt)=>(ki(),Vi("div",{key:gi.id,class:"point-item"},[Pe("div",rR,[Pe("span",nR,xr(gi.name),1),Pe("span",sR,xr(gi.description||" "),1)]),Pe("button",{onClick:qr=>{ae.value.splice(Zt,1),Pt(),Ti.renderMarkers()},class:"delete-btn"},"  ",8,oR)]))),128))])])):Cs("",!0),Pe("div",{class:"form-actions"},[Pe("button",{type:"button",onClick:di,class:"secondary-btn"},"  "),Bt[11]||(Bt[11]=Pe("button",{type:"submit",class:"primary-btn"},"   ",-1))])],32),Te.value?(ki(),Vi("div",aR,[Pe("div",lR,[Bt[15]||(Bt[15]=Pe("h3",null,"  ",-1)),Pe("div",cR,[Bt[13]||(Bt[13]=Pe("label",null,"  *",-1)),Dn(Pe("select",{"onUpdate:modelValue":Bt[4]||(Bt[4]=gi=>Re.value=gi),required:""},Bt[12]||(Bt[12]=[Pe("option",{value:""}," ",-1),Pe("option",null,"",-1),Pe("option",null,"",-1),Pe("option",null,"",-1),Pe("option",null," ",-1),Pe("option",null," ",-1)]),512),[[UI,Re.value]])]),Pe("div",uR,[Bt[14]||(Bt[14]=Pe("label",null,"",-1)),Dn(Pe("textarea",{"onUpdate:modelValue":Bt[5]||(Bt[5]=gi=>Ze.value=gi),placeholder:" "},null,512),[[Bn,Ze.value]])]),Pe("div",{class:"modal-actions"},[Pe("button",{onClick:ji,class:"secondary-btn"},""),Pe("button",{onClick:zt,class:"primary-btn"}," ")])])])):Cs("",!0)]))}},dR=na(hR,[["__scopeId","data-v-c8262aed"]]),fR={class:"container"},pR={key:0,class:"route-card"},mR={class:"route-header"},_R={class:"start"},gR={class:"end"},yR={class:"description"},vR={class:"stats"},xR={class:"stat-box"},bR={class:"stat-box"},wR={key:0,class:"points-section"},TR={class:"points-grid"},SR={class:"icon"},ER={class:"info"},MR={class:"comments-section"},AR={key:0,class:"comment-form"},IR={key:1,class:"not-auth"},CR={key:2,class:"comment-list"},PR={class:"comment-content"},RR={class:"comment-meta"},DR={class:"username"},zR={class:"timestamp"},LR={key:3},OR={key:1,class:"loading"},kR={__name:"FindRoutes",setup(f){const v=Oi(null),I=L3().params.routeId,P=Oi(null);let k=null;const j=Oi(null),$=Oi(null),s=Oi(null),Q=Oi(null),de=Oi(null),ae=Oi(null),Te=Oi(null),Ne=new Date().toISOString().split(".")[0]+"Z",Re=Oi(!1);async function Ze(){try{const jt=await Wr.get(`/get-comment/${I}`);Q.value=jt.data;const st=localStorage.getItem("token"),zt={};for(const ji of Q.value){const Ci=ji.userId;if(!zt[Ci])try{const Fr=await Wr.get(`/user/${Ci}`);zt[Ci]=Fr.data}catch(Fr){console.warn(`    ${Ci}:`,Fr)}}Te.value=zt}catch(jt){console.error("   :",jt)}}async function et(){const jt=localStorage.getItem("token");if(!jt){Re.value=!1;return}const st=JSON.parse(atob(jt.split(".")[1])),zt=st.sub||st.username;try{const ji=await Wr.get(`/${zt}`,{headers:{Authorization:`Bearer ${jt}`}});ae.value=ji.data.id,Te.value=ji.data,Re.value=!0}catch(ji){Re.value=!1,console.error("   :",ji),alert("    ")}}async function ft(){if(de.value)try{const jt=new FormData;jt.append("routeId",I),jt.append("userId",ae.value),jt.append("comment",de.value),jt.append("createAt",Ne),await Wr.post("/create-comment",jt),de.value="",await Ze()}catch(jt){console.error("   :",jt)}}async function vt(){try{const jt=await Wr.get(`/route/details/${I}`);v.value=jt.data;const st=await Wr.get(`/point/${I}`);s.value=st.data.filter(zt=>zt.longitude&&zt.latitude).map(zt=>({...zt,longitude:zt.latitude,latitude:zt.longitude})),v.value.start_lat&&v.value.start_lng&&v.value.end_lat&&v.value.end_lng&&(await $f(),gt([v.value.start_lng,v.value.start_lat],[v.value.end_lng,v.value.end_lat]))}catch(jt){console.error("    :",jt)}}function gt(jt,st){Qn.accessToken="pk.eyJ1Ijoia25vdmlrb3YiLCJhIjoiY205NzNmcmpzMDNkdzJyc2FkeXBqYm1yNCJ9.gVSV8RGo5Dz0V0kZQBw5PQ",P.value&&(P.value.style.height="400px",P.value.style.width="100%",k&&(k.remove(),k=null),k=new Qn.Map({container:P.value,style:"mapbox://styles/mapbox/streets-v11",center:di(jt,st),zoom:10}),k.on("load",()=>{new Qn.Marker({color:"#3FB1CE"}).setLngLat(jt).addTo(k),new Qn.Marker({color:"#E74C3C"}).setLngLat(st).addTo(k),pt(),ui(jt,st)}))}function Vt(jt,st,zt){const ji=document.createElement("div");ji.className="custom-marker",ji.style.fontSize="20px",ji.style.textAlign="center";const Ci={:"",:"",:""," ":""," ":"",Start:"",End:"",default:""};ji.innerHTML=Ci[zt]||Ci.default,new Qn.Marker({element:ji,anchor:"bottom"}).setLngLat([jt,st]).addTo(k)}function pt(){if(!s.value||!k)return;const jt=new Qn.LngLatBounds;s.value.forEach(st=>{jt.extend([st.longitude,st.latitude]),Vt(st.longitude,st.latitude,st.name||st.type)}),k.fitBounds(jt,{padding:50,maxZoom:12})}async function ui(jt,st){const zt=`https://api.mapbox.com/directions/v5/mapbox/driving/${jt.join(",")};${st.join(",")}?geometries=geojson&access_token=${Qn.accessToken}`;try{const Ci=await(await fetch(zt)).json(),Fr=Ci.routes[0].geometry,oi=Ci.routes[0].distance,Yi=Ci.routes[0].duration;j.value=(oi/1e3).toFixed(2),$.value=Math.round(Yi/60),k.getSource("route")&&(k.removeLayer("route"),k.removeSource("route")),k.addSource("route",{type:"geojson",data:{type:"Feature",geometry:Fr}}),k.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#00c9ff","line-width":4}});const bi=new Qn.LngLatBounds;Fr.coordinates.forEach(nr=>bi.extend(nr)),k.fitBounds(bi,{padding:50,maxZoom:12})}catch(ji){console.error("   :",ji)}}function zi(jt){const st={:"",:"",:""," ":""," ":"",Start:"",End:"",default:""};return st[jt]||st.default}function Pt(jt){if(jt==null)return"";const st=Math.floor(jt/60),zt=jt%60;return`${st>0?`${st}  `:""}${zt} `}function di(jt,st){return[(jt[0]+st[0])/2,(jt[1]+st[1])/2]}return xh(()=>{vt(),et(),Ze()}),(jt,st)=>{var ji;const zt=Ol("router-link");return ki(),Vi("div",fR,[v.value?(ki(),Vi("div",pR,[Pe("div",mR,[Pe("h2",null,[Pe("span",_R," "+xr(v.value.startLocation),1),st[1]||(st[1]=Pe("span",{class:"arrow"},"",-1)),Pe("span",gR," "+xr(v.value.endLocation),1)]),Pe("p",yR,xr(v.value.description),1)]),Pe("div",vR,[Pe("div",xR,[st[2]||(st[2]=Pe("span",{class:"stat-icon"},"",-1)),st[3]||(st[3]=Pe("span",{class:"stat-label"},"",-1)),Pe("strong",null,xr(j.value)+" ",1)]),Pe("div",bR,[st[4]||(st[4]=Pe("span",{class:"stat-icon"},"",-1)),st[5]||(st[5]=Pe("span",{class:"stat-label"},"",-1)),Pe("strong",null,xr(Pt($.value)),1)])]),Pe("div",{class:"map",ref_key:"mapContainer",ref:P},null,512),s.value&&s.value.length?(ki(),Vi("div",wR,[st[6]||(st[6]=Pe("h3",null,"  ",-1)),Pe("div",TR,[(ki(!0),Vi(Is,null,kf(s.value,Ci=>(ki(),Vi("div",{key:Ci.id,class:vh(["point-card",Ci.type])},[Pe("div",SR,xr(zi(Ci.name||Ci.type)),1),Pe("div",ER,[Pe("h4",null,xr(Ci.name||Ci.type),1),Pe("p",null,xr(Ci.description||" "),1)])],2))),128))])])):Cs("",!0),Pe("div",MR,[Pe("h3",null," "+xr(((ji=Q.value)==null?void 0:ji.length)||0)+" ",1),Re.value?(ki(),Vi("div",AR,[Dn(Pe("textarea",{"onUpdate:modelValue":st[0]||(st[0]=Ci=>de.value=Ci),placeholder:" ...",rows:"3"},null,512),[[Bn,de.value]]),Pe("button",{onClick:ft},"")])):(ki(),Vi("div",IR,[st[8]||(st[8]=Pe("p",null,"      .",-1)),en(zt,{to:"/login",class:"login-btn"},{default:Ia(()=>st[7]||(st[7]=[ra("")])),_:1})])),Q.value&&Q.value.length?(ki(),Vi("div",CR,[(ki(!0),Vi(Is,null,kf(Q.value,(Ci,Fr)=>{var oi;return ki(),Vi("div",{class:"comment-item",key:Fr},[st[9]||(st[9]=Pe("div",{class:"comment-avatar"},"",-1)),Pe("div",PR,[Pe("div",RR,[Pe("span",DR," #"+xr(((oi=Te.value[Ci.userId])==null?void 0:oi.username)||""),1),Pe("span",zR,xr(new Date(Ci.createAt).toLocaleString()),1)]),Pe("p",null,xr(Ci.comment),1)])])}),128))])):(ki(),Vi("div",LR,st[10]||(st[10]=[Pe("p",null,"  .  !",-1)])))])])):(ki(),Vi("div",OR,st[11]||(st[11]=[Pe("div",{class:"spinner"},null,-1),Pe("p",null," ...",-1)])))])}}},FR=na(kR,[["__scopeId","data-v-1f842507"]]),BR={name:"RoutesPage",data(){return{routes:[],loading:!0,user_id:null,userData:null,userFavorites:[]}},computed:{isAuthenticated(){return!!localStorage.getItem("token")}},methods:{async fetchUserId(){const f=localStorage.getItem("token");if(!f){console.warn("     ");return}const v=JSON.parse(atob(f.split(".")[1])),I=v.sub||v.username;try{const P=await Wr.get(`/${I}`,{headers:{Authorization:`Bearer ${f}`}});return this.user_id=P.data.id,this.userData=P.data,this.user_id}catch(P){console.error("   :",P),alert("    ")}},async fetchFavorites(){if(!this.user_id){console.error("user_id is not set or empty");return}try{const f=await Wr.get(`/list?userId=${this.user_id}`);this.userFavorites=f.data,this.routes.forEach(v=>{v.favorite=this.userFavorites.includes(v.id)})}catch(f){console.error("    :",f)}},async toggleFavorite(f){console.log("Toggle favorite for route:",f.id,"Current favorite status:",f.favorite);const v=f.favorite;try{v?(console.log("Removing from favorites"),await Wr.delete("/delete",{params:{routeId:f.id,userId:this.user_id}}),this.userFavorites=this.userFavorites.filter(I=>I!==f.id)):(console.log("Adding to favorites"),await Wr.post("/add",{routeId:f.id,userId:this.user_id},{headers:{"Content-Type":"application/json"}}),this.userFavorites.push(f.id)),f.favorite=!v}catch(I){console.error("   :",I)}},async fetchAllRoutes(){try{this.loading=!0,this.user_id||(await this.fetchUserId(),await this.fetchFavorites());const v=(await Wr.get("/all-route")).data||[],I=await Promise.all(v.map(async P=>{const k=[P.start_lng,P.start_lat],j=[P.end_lng,P.end_lat];let $=null,s=null;if((k==null?void 0:k.length)===2&&(j==null?void 0:j.length)===2)try{const{distanceKm:de,durationMin:ae}=await this.getRouteMetrics(k,j);$=de,s=ae}catch(de){console.warn("     Mapbox:",de)}let Q=null;if(P.id)try{const de=await Wr.get(`/route/${P.id}/image`,{responseType:"arraybuffer"}),ae=btoa(new Uint8Array(de.data).reduce((Re,Ze)=>Re+String.fromCharCode(Ze),""));let Te="jpeg";const Ne=new Uint8Array(de.data);Ne[0]===137&&Ne[1]===80&&(Te="png"),Q=`data:image/${Te};base64,${ae}`}catch(de){console.error(`     ${P.id}:`,de)}return{...P,distance:$,duration:s,image:Q,favorite:this.userFavorites.includes(P.id)}}));this.routes=I,await this.fetchFavorites()}catch(f){console.error("   :",f)}finally{this.loading=!1}},async getRouteMetrics(f,v){var ae;const[I,P]=f,[k,j]=v,de=(ae=(await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${I},${P};${k},${j}?geometries=geojson&access_token=pk.eyJ1Ijoia25vdmlrb3YiLCJhIjoiY205NzNmcmpzMDNkdzJyc2FkeXBqYm1yNCJ9.gVSV8RGo5Dz0V0kZQBw5PQ`)).json()).routes)==null?void 0:ae[0];return{distanceKm:de?(de.distance/1e3).toFixed(1):null,durationMin:de?Math.round(de.duration/60):null}},formatDuration(f){if(f==null)return"";const v=Math.floor(f/60),I=f%60;return`${v>0?`${v}  `:""}${I} `},formatDate(f){return f?new Date(f).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric"}).replace(" .",""):""},goToRouteDetails(f){this.$router.push({name:"RouteDetails",params:{routeId:f}})}},mounted(){this.fetchAllRoutes();try{this.fetchAllRoutes()}catch(f){console.error(" :",f),this.loading=!1}}},NR={class:"routes-page"},VR={key:0,class:"loading-state"},UR={key:1,class:"empty-state"},jR={key:2,class:"routes-grid"},GR=["onClick"],qR={class:"card-left"},$R={class:"card-header"},HR={class:"route-name"},ZR=["onClick"],WR={xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},XR=["d"],KR={class:"date-badge"},YR={class:"route-path"},JR={class:"location"},QR={class:"location"},eD={class:"route-stats"},tD={class:"stat"},iD={class:"stat"},rD=["onClick"],nD={key:0,class:"card-right"},sD={class:"route-image-container"},oD=["src"];function aD(f,v,I,P,k,j){return ki(),Vi("div",NR,[v[8]||(v[8]=Pe("div",{class:"routes-header"},[Pe("h1",{class:"routes-title"},"")],-1)),k.loading?(ki(),Vi("div",VR,v[0]||(v[0]=[Pe("div",{class:"loading-spinner"},null,-1),Pe("p",null,"  ...",-1)]))):k.routes.length===0?(ki(),Vi("div",UR,v[1]||(v[1]=[Pe("div",{class:"empty-illustration"},[Pe("svg",{xmlns:"http://www.w3.org/2000/svg",width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},[Pe("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),Pe("circle",{cx:"12",cy:"10",r:"3"})])],-1),Pe("h3",null,"  ",-1),Pe("p",null,"   ,    ",-1)]))):(ki(),Vi("div",jR,[(ki(!0),Vi(Is,null,kf(k.routes,$=>(ki(),Vi("div",{key:$.id,class:"route-card",onClick:s=>j.goToRouteDetails($.id)},[Pe("div",qR,[Pe("div",$R,[Pe("div",HR,[Pe("h3",null,xr($.name||" "),1),j.isAuthenticated?(ki(),Vi("span",{key:0,class:vh(["favorite-icon",{active:$.favorite}]),onClick:_h(s=>j.toggleFavorite($),["stop"])},[(ki(),Vi("svg",WR,[Pe("path",{d:($.favorite,"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z")},null,8,XR)]))],10,ZR)):Cs("",!0)]),Pe("span",KR,xr(j.formatDate($.createdAt)),1)]),Pe("div",YR,[Pe("div",JR,[v[2]||(v[2]=Pe("div",{class:"location-marker start"},null,-1)),Pe("span",null,xr($.startLocation||" "),1)]),v[4]||(v[4]=Pe("div",{class:"path-line"},[Pe("div",{class:"path-dots"})],-1)),Pe("div",QR,[v[3]||(v[3]=Pe("div",{class:"location-marker end"},null,-1)),Pe("span",null,xr($.endLocation||" "),1)])]),Pe("div",eD,[Pe("div",tD,[v[5]||(v[5]=Pe("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[Pe("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"})],-1)),Pe("span",null,xr($.distance?`${$.distance} `:""),1)]),Pe("div",iD,[v[6]||(v[6]=Pe("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[Pe("circle",{cx:"12",cy:"12",r:"10"}),Pe("polyline",{points:"12 6 12 12 16 14"})],-1)),Pe("span",null,xr(j.formatDuration($.duration)),1)])]),Pe("button",{class:"details-button",onClick:_h(s=>j.goToRouteDetails($.id),["stop"])},v[7]||(v[7]=[ra("  "),Pe("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[Pe("path",{d:"M5 12h14M12 5l7 7-7 7"})],-1)]),8,rD)]),$.image?(ki(),Vi("div",nD,[Pe("div",sD,[Pe("img",{src:$.image,alt:"Route image",class:"route-image"},null,8,oD)])])):Cs("",!0)],8,GR))),128))]))])}const lD=na(BR,[["render",aD],["__scopeId","data-v-8e695981"]]),cD={async login(f,v){try{const P=(await Wr.post("/login",{username:f,password:v})).data.token,j=this.decodeToken(P).exp*1e3;if(Date.now()>j){console.error(" . ,  ."),this.logout();return}return localStorage.setItem("token",P),localStorage.setItem("username",f),Xf().setUsername(f),P}catch(I){throw console.error("Login failed",I),I}},decodeToken(f){const I=f.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),P=decodeURIComponent(atob(I).split("").map(function(k){return"%"+("00"+k.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(P)},logout(){localStorage.removeItem("token"),localStorage.removeItem("username")}},uD={class:"auth-container"},hD={class:"auth-card"},dD={class:"input-group"},fD={class:"input-group"},pD={class:"auth-footer"},mD={__name:"Login",setup(f){const v=Oi(""),I=Oi(""),P=Lv(),k=Xf(),j=async()=>{var $;try{const s=await cD.login(v.value,I.value);if(console.log(s),s){const Q=JSON.parse(atob(s.split(".")[1])),de=Q.sub||Q.username;k.setUsername(de),await k.fetchRole(),await P.push("/")}}catch(s){alert("  : "+((($=s.response)==null?void 0:$.data)||s.message))}};return($,s)=>{const Q=Ol("router-link");return ki(),Vi("div",uD,[Pe("div",hD,[s[7]||(s[7]=Pe("div",{class:"auth-header"},[Pe("h2",null,"  "),Pe("p",null,"    ")],-1)),Pe("form",{onSubmit:_h(j,["prevent"]),class:"auth-form"},[Pe("div",dD,[s[2]||(s[2]=Pe("label",{for:"name"}," ",-1)),Dn(Pe("input",{"onUpdate:modelValue":s[0]||(s[0]=de=>v.value=de),type:"text",id:"username",placeholder:"  ",required:""},null,512),[[Bn,v.value]])]),Pe("div",fD,[s[3]||(s[3]=Pe("label",{for:"password"},"",-1)),Dn(Pe("input",{"onUpdate:modelValue":s[1]||(s[1]=de=>I.value=de),type:"password",id:"password",placeholder:"",required:""},null,512),[[Bn,I.value]])]),s[4]||(s[4]=Pe("button",{type:"submit",class:"auth-submit"},[Pe("span",null,""),Pe("span",{class:"arrow"},"")],-1))],32),Pe("div",pD,[Pe("p",null,[s[6]||(s[6]=ra("  ? ")),en(Q,{to:"/register"},{default:Ia(()=>s[5]||(s[5]=[ra("")])),_:1})])])]),s[8]||(s[8]=Pe("div",{class:"auth-decoration"},[Pe("div",{class:"decoration-circle"}),Pe("div",{class:"decoration-circle"})],-1))])}}},_D=na(mD,[["__scopeId","data-v-a8ce347c"]]),gD={class:"auth-container"},yD={class:"auth-card"},vD={key:0,class:"error-message",style:{"margin-top":"1rem"}},xD={class:"input-group"},bD={key:0,class:"error-message"},wD={class:"input-group"},TD={key:0,class:"error-message"},SD={class:"input-group"},ED={key:0,class:"error-message"},MD={class:"input-group"},AD={key:0,class:"error-message"},ID={class:"input-group"},CD={key:0,class:"error-message"},PD={class:"input-group"},RD={class:"auth-footer"},DD={__name:"Register",setup(f){const v=Oi(""),I=Oi(""),P=Oi(""),k=Oi(""),j=Oi(""),$=Oi(""),s=Oi({}),Q=Oi(!1),de=Lv(),ae=async()=>{var Re,Ze;if(s.value={},j.value.length<8){s.value.password="    8 ";return}if(j.value!==$.value){s.value.confirmPassword="  ";return}if(Q.value){s.value.username="     ";return}const Ne={login:v.value,code:j.value,mail:k.value,name:I.value,surname:P.value};try{const et=await Wr.post("/save-user",Ne);alert("  !"),et.status===201&&await de.push("/login")}catch(et){const ft=(Re=et.response)==null?void 0:Re.data;((Ze=et.response)==null?void 0:Ze.status)===400&&(ft!=null&&ft.errors)?ft.errors.forEach(vt=>{var pt;const gt=(pt=vt.field)==null?void 0:pt.toLowerCase(),Vt=vt.defaultMessage||"";gt!=null&&gt.includes("login")?s.value.username=Vt:gt!=null&&gt.includes("code")?s.value.password=Vt:gt!=null&&gt.includes("mail")?s.value.email=Vt:gt==="name"?s.value.firstName=Vt:gt==="surname"?s.value.lastName=Vt:s.value.general=Vt}):typeof ft=="string"?s.value.general=ft:s.value.general="    "}},Te=async()=>{if(v.value.trim()!=="")try{const Ne=await Wr.get(`/check/${v.value}`);Ne.status===200&&Ne.data===!0?(s.value.username="   ",Q.value=!0):(s.value.username="",Q.value=!1)}catch{s.value.username="",Q.value=!1}};return(Ne,Re)=>{const Ze=Ol("router-link");return ki(),Vi("div",gD,[Pe("div",yD,[Re[15]||(Re[15]=Pe("div",{class:"auth-header"},[Pe("h2",null," "),Pe("p",null,"   ")],-1)),s.value.general?(ki(),Vi("p",vD,xr(s.value.general),1)):Cs("",!0),Pe("form",{onSubmit:_h(ae,["prevent"]),class:"auth-form"},[Pe("div",xD,[Re[6]||(Re[6]=Pe("label",{for:"username"}," ",-1)),Dn(Pe("input",{"onUpdate:modelValue":Re[0]||(Re[0]=et=>v.value=et),type:"text",id:"username",placeholder:"  ",required:"",class:vh({"input-error":s.value.username}),onBlur:Te},null,34),[[Bn,v.value]]),s.value.username?(ki(),Vi("div",bD,xr(s.value.username),1)):Cs("",!0)]),Pe("div",wD,[Re[7]||(Re[7]=Pe("label",{for:"name"},"",-1)),Dn(Pe("input",{"onUpdate:modelValue":Re[1]||(Re[1]=et=>I.value=et),type:"text",id:"firstname",placeholder:" ",required:""},null,512),[[Bn,I.value]]),s.value.firstName?(ki(),Vi("div",TD,xr(s.value.firstName),1)):Cs("",!0)]),Pe("div",SD,[Re[8]||(Re[8]=Pe("label",{for:"name"},"",-1)),Dn(Pe("input",{"onUpdate:modelValue":Re[2]||(Re[2]=et=>P.value=et),type:"text",id:"lastName",placeholder:" ",required:""},null,512),[[Bn,P.value]]),s.value.lastName?(ki(),Vi("div",ED,xr(s.value.lastName),1)):Cs("",!0)]),Pe("div",MD,[Re[9]||(Re[9]=Pe("label",{for:"email"},"Email",-1)),Dn(Pe("input",{"onUpdate:modelValue":Re[3]||(Re[3]=et=>k.value=et),type:"email",id:"email",placeholder:"example@mail.com",required:""},null,512),[[Bn,k.value]]),s.value.email?(ki(),Vi("div",AD,xr(s.value.email),1)):Cs("",!0)]),Pe("div",ID,[Re[10]||(Re[10]=Pe("label",{for:"password"},"",-1)),Dn(Pe("input",{"onUpdate:modelValue":Re[4]||(Re[4]=et=>j.value=et),type:"password",id:"password",placeholder:"",required:"",minlength:"8"},null,512),[[Bn,j.value]]),s.value.password?(ki(),Vi("div",CD,xr(s.value.password),1)):Cs("",!0)]),Pe("div",PD,[Re[11]||(Re[11]=Pe("label",{for:"confirmPassword"}," ",-1)),Dn(Pe("input",{"onUpdate:modelValue":Re[5]||(Re[5]=et=>$.value=et),type:"password",id:"confirmPassword",placeholder:"",required:""},null,512),[[Bn,$.value]])]),Re[12]||(Re[12]=Pe("button",{type:"submit",class:"auth-submit"},[Pe("span",null,""),Pe("span",{class:"arrow"},"")],-1))],32),Pe("div",RD,[Pe("p",null,[Re[14]||(Re[14]=ra("  ? ")),en(Ze,{to:"/login"},{default:Ia(()=>Re[13]||(Re[13]=[ra("")])),_:1})])])]),Re[16]||(Re[16]=Pe("div",{class:"auth-decoration"},[Pe("div",{class:"decoration-circle"}),Pe("div",{class:"decoration-circle"}),Pe("div",{class:"decoration-circle"})],-1))])}}},zD=na(DD,[["__scopeId","data-v-d33bcec3"]]),LD={class:"routes-page"},OD={key:0,class:"loading-state"},kD={key:1,class:"empty-state"},FD={key:2,class:"routes-grid"},BD=["onClick"],ND={class:"card-left"},VD={class:"card-header"},UD={class:"route-name"},jD={class:"date-badge"},GD={class:"route-path"},qD={class:"location"},$D={class:"location"},HD={class:"route-stats"},ZD={class:"stat"},WD={class:"stat"},XD=["onClick"],KD={key:0,class:"card-right"},YD={class:"route-image-container"},JD=["src"],QD={__name:"FavoriteRoutes",setup(f){const v=Oi([]),I=Oi(!0),P=Oi(null),k=Lv(),j=Ps(()=>!!localStorage.getItem("token"));function $(Ne){if(Ne==null)return"";const Re=Math.floor(Ne/60),Ze=Ne%60;return`${Re>0?`${Re}  `:""}${Ze} `}function s(Ne){return Ne?new Date(Ne).toLocaleDateString("ru-RU",{day:"numeric",month:"short",year:"numeric"}).replace(" .",""):""}function Q(Ne){k.push({name:"RouteDetails",params:{routeId:Ne}})}async function de(){const Ne=localStorage.getItem("token");if(!Ne)return null;try{const Re=JSON.parse(atob(Ne.split(".")[1])),Ze=Re.sub||Re.username;return(await Wr.get(`/${Ze}`,{headers:{Authorization:`Bearer ${Ne}`}})).data.id}catch(Re){return console.error("  userId:",Re),null}}const ae=async(Ne,Re)=>{var Vt;const[Ze,et]=Ne,[ft,vt]=Re,gt="pk.eyJ1Ijoia25vdmlrb3YiLCJhIjoiY205NzNmcmpzMDNkdzJyc2FkeXBqYm1yNCJ9.gVSV8RGo5Dz0V0kZQBw5PQ";try{const zi=(Vt=(await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${Ze},${et};${ft},${vt}?geometries=geojson&access_token=${gt}`)).json()).routes)==null?void 0:Vt[0];return{distanceKm:zi?(zi.distance/1e3).toFixed(1):null,durationMin:zi?Math.round(zi.duration/60):null}}catch(pt){return console.error("    :",pt),{distanceKm:null,durationMin:null}}};async function Te(){try{if(I.value=!0,P.value=await de(),!P.value)return;const Re=(await Wr.get("/list",{params:{userId:P.value}})).data;if(!Re||Re.length===0){v.value=[];return}const Ze=new URLSearchParams;Re.forEach(gt=>Ze.append("routeIds",gt));const ft=(await Wr.get(`/routes-by-ids?${Ze.toString()}`)).data||[],vt=await Promise.all(ft.map(async gt=>{const Vt=[gt.start_lng,gt.start_lat],pt=[gt.end_lng,gt.end_lat];let ui=null,zi=null;if((Vt==null?void 0:Vt.length)===2&&(pt==null?void 0:pt.length)===2)try{const{distanceKm:di,durationMin:jt}=await ae(Vt,pt);ui=di,zi=jt}catch(di){console.warn("     Mapbox:",di)}let Pt=null;try{const di=await Wr.get(`/route/${gt.id}/image`,{responseType:"arraybuffer"}),jt=btoa(new Uint8Array(di.data).reduce((ji,Ci)=>ji+String.fromCharCode(Ci),""));let st="jpeg";const zt=new Uint8Array(di.data);zt[0]===137&&zt[1]===80&&(st="png"),Pt=`data:image/${st};base64,${jt}`}catch(di){console.error(`     ${gt.id}:`,di)}return{...gt,favorite:!0,image:Pt,distance:ui,duration:zi}}));v.value=vt}catch(Ne){console.error("    :",Ne)}finally{I.value=!1}}return xh(()=>{j.value?Te():I.value=!1}),(Ne,Re)=>(ki(),Vi("div",LD,[Re[8]||(Re[8]=Pe("div",{class:"routes-header"},[Pe("h1",{class:"routes-title"}," ")],-1)),I.value?(ki(),Vi("div",OD,Re[0]||(Re[0]=[Pe("div",{class:"loading-spinner"},null,-1),Pe("p",null,"   ...",-1)]))):v.value.length===0?(ki(),Vi("div",kD,Re[1]||(Re[1]=[Pe("div",{class:"empty-illustration"},"",-1),Pe("h3",null,"  ",-1),Pe("p",null,"   ,    ",-1)]))):(ki(),Vi("div",FD,[(ki(!0),Vi(Is,null,kf(v.value,Ze=>(ki(),Vi("div",{key:Ze.id,class:"route-card",onClick:et=>Q(Ze.id)},[Pe("div",ND,[Pe("div",VD,[Pe("div",UD,[Pe("h3",null,xr(Ze.name||" "),1)]),Pe("span",jD,xr(s(Ze.createdAt)),1)]),Pe("div",GD,[Pe("div",qD,[Re[2]||(Re[2]=Pe("div",{class:"location-marker start"},null,-1)),Pe("span",null,xr(Ze.startLocation||" "),1)]),Re[4]||(Re[4]=Pe("div",{class:"path-line"},[Pe("div",{class:"path-dots"})],-1)),Pe("div",$D,[Re[3]||(Re[3]=Pe("div",{class:"location-marker end"},null,-1)),Pe("span",null,xr(Ze.endLocation||" "),1)])]),Pe("div",HD,[Pe("div",ZD,[Re[5]||(Re[5]=Pe("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[Pe("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"})],-1)),Pe("span",null,xr(Ze.distance?`${Ze.distance} `:""),1)]),Pe("div",WD,[Re[6]||(Re[6]=Pe("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[Pe("circle",{cx:"12",cy:"12",r:"10"}),Pe("polyline",{points:"12 6 12 12 16 14"})],-1)),Pe("span",null,xr($(Ze.duration)),1)])]),Pe("button",{class:"details-button",onClick:_h(et=>Q(Ze.id),["stop"])},Re[7]||(Re[7]=[ra("  "),Pe("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[Pe("path",{d:"M5 12h14M12 5l7 7-7 7"})],-1)]),8,XD)]),Ze.image?(ki(),Vi("div",KD,[Pe("div",YD,[Pe("img",{src:Ze.image,alt:"Route image",class:"route-image"},null,8,JD)])])):Cs("",!0)],8,BD))),128))]))]))}},ez=na(QD,[["__scopeId","data-v-c01c9e9a"]]),tz=[{path:"/",name:"MainView",component:N3},{path:"/map-form",name:"MapForm",component:dR},{path:"/route/:routeId",name:"RouteDetails",component:FR},{path:"/routes",name:"ViewRoutes",component:lD},{path:"/login",name:"Login",component:_D},{path:"/register",name:"Register",component:zD},{path:"/favorite",component:ez}],ph=D3({history:a3(),routes:tz}),iz={class:"app-header"},rz={class:"auth-buttons"},nz={key:0},sz={key:1,class:"user-info"},oz={class:"user-controls"},az={class:"nav-link"},lz={class:"text"},cz={__name:"Header",setup(f){const v=Xf(),I=()=>{v.logout(),ph.push("/login")};return xh(()=>{v.loadUsernameFromToken()}),(P,k)=>{const j=Ol("router-link");return ki(),Vi("header",iz,[en(j,{to:"/","active-class":"active"},{default:Ia(()=>k[0]||(k[0]=[Pe("h1",{class:"logo"},"RouteMate",-1)])),_:1}),Pe("div",rz,[Aa(v).username?(ki(),Vi("li",sz,[Pe("div",oz,[Pe("div",az,[k[2]||(k[2]=Pe("span",{class:"icon"},"",-1)),Pe("span",lz,xr(Aa(v).username),1)]),Pe("button",{onClick:I,class:"logout-btn"},"")])])):(ki(),Vi("li",nz,[en(j,{to:"/login",class:"nav-link","active-class":"active"},{default:Ia(()=>k[1]||(k[1]=[Pe("span",{class:"icon"},"",-1),Pe("span",{class:"text"},"",-1)])),_:1})]))])])}}},uz=na(cz,[["__scopeId","data-v-ca16d959"]]),hz={class:"sidebar"},dz={class:"navigation"},fz={key:0},pz={class:"route-search"},mz={class:"input-group"},_z={class:"input-wrapper"},gz={class:"input-wrapper"},yz={__name:"Sidebar",setup(f){const v=Oi(""),I=Oi(""),P=Oi(null),k=Xf();xh(async()=>{k.loadUsernameFromToken(),await k.fetchRole()});const j=()=>{k.isAuthenticated?ph.push("/favorite"):ph.push("/login")},$=async()=>{if(v.value&&I.value)try{const s=localStorage.getItem("token"),Q={params:{startLocation:v.value,endLocation:I.value}};s&&(Q.headers={Authorization:`Bearer ${s}`});const de=await Wr.get("/route/search",Q),ae=Array.isArray(de.data)?de.data[0]:de.data;ae!=null&&ae.id?(P.value=ae,v.value="",I.value="",await ph.push({name:"RouteDetails",params:{routeId:ae.id}})):alert("    ID .")}catch(s){console.error(s),alert("   .  .")}else alert(",   .")};return(s,Q)=>{const de=Ol("router-link");return ki(),Vi("aside",hz,[Pe("nav",dz,[Pe("ul",null,[Pe("li",null,[en(de,{to:"/",class:"nav-link","active-class":"active"},{default:Ia(()=>Q[2]||(Q[2]=[Pe("span",{class:"icon"},"",-1),Pe("span",{class:"text"},"",-1)])),_:1})]),Pe("li",null,[en(de,{to:"/routes",class:"nav-link","active-class":"active"},{default:Ia(()=>Q[3]||(Q[3]=[Pe("span",{class:"icon"},"",-1),Pe("span",{class:"text"},"",-1)])),_:1})]),Pe("li",null,[Pe("a",{href:"#",class:"nav-link",onClick:j},Q[4]||(Q[4]=[Pe("span",{class:"icon"},"",-1),Pe("span",{class:"text"}," ",-1)]))]),Aa(k).isAdmin?(ki(),Vi("li",fz,[en(de,{to:"/map-form",class:"nav-link","active-class":"active"},{default:Ia(()=>Q[5]||(Q[5]=[Pe("span",{class:"icon"},"",-1),Pe("span",{class:"text"}," ",-1)])),_:1})])):Cs("",!0)])]),Pe("div",pz,[Q[9]||(Q[9]=Pe("h3",{class:"search-title"},[Pe("span",{class:"search-icon"},""),ra("   ")],-1)),Pe("div",mz,[Pe("div",_z,[Dn(Pe("input",{"onUpdate:modelValue":Q[0]||(Q[0]=ae=>v.value=ae),type:"text",placeholder:"",class:"input"},null,512),[[Bn,v.value]]),Q[6]||(Q[6]=Pe("span",{class:"input-icon"},"",-1))]),Pe("div",gz,[Dn(Pe("input",{"onUpdate:modelValue":Q[1]||(Q[1]=ae=>I.value=ae),type:"text",placeholder:"",class:"input"},null,512),[[Bn,I.value]]),Q[7]||(Q[7]=Pe("span",{class:"input-icon"},"",-1))]),Pe("button",{onClick:$,class:"btn-search"},Q[8]||(Q[8]=[Pe("span",null," ",-1),Pe("span",{class:"arrow"},"",-1)]))])])])}}},vz=na(yz,[["__scopeId","data-v-eaad799e"]]),xz={name:"App",components:{Header:uz,Sidebar:vz}},bz={id:"app",class:"app-container"},wz={class:"main-content"},Tz={class:"map-and-routes"};function Sz(f,v,I,P,k,j){const $=Ol("Header"),s=Ol("Sidebar"),Q=Ol("router-view");return ki(),Vi("div",bz,[en($),Pe("div",wz,[en(s),Pe("div",Tz,[en(Q)])])])}const Ez=na(xz,[["render",Sz]]),Ov=HI(Ez);Ov.use(O2());Ov.use(ph);Ov.mount("#app");
